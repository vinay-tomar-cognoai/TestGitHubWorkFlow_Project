{% extends 'EasyAssistApp/console.html' %} {% block content %} {% load static %}
{% load easyassist_custom_filters %}

<style type="text/css">
/* body {margin: 0; height: 100%; overflow: hidden} */
.easychat-bot-message-div {
    margin-top: 0em;
    width: 100%;
    display: inline-block;
}

.message-time-user {
    font-size: 11px;
    float: right;
    text-align: right;
    margin-left: 20px;
    color: white;
    padding: 0.5em 0em 0em 0.5em;
}
/* thead {
    display:block;
}
tbody {
    height:20em;
    overflow-y:scroll;
    display:block;
} */

.message-time-bot {
    font-size: 11px;
    text-align: right;
    width: 100%;
    float: right;
    padding: 0.5em 0em 0em 0.5em;
}

.easychat-bot-message {
    box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.2);
    float: left;
    width: fit-content;
    height: auto;
    font-size: 14px;
    color: #262626;
    border-radius: 0px 10px 10px 10px;
    background-color: #ffffff;
    padding-bottom: 10px;
    word-wrap: break-word;
    display: inline-block;
}

@media screen and (min-width: 425px) {
    .easychat-bot-message {
        width: fit-content;
        max-width: 80%;
    }
}

.easychat-bot-message-line {
    line-height: 20px;
    padding: 0.8em 0.5em 0.8em 0.5em;
}

.easychat-user-message-div {
    margin: 0em 0em 0em 0em;
    width: 100%;
    display: inline-block;
}

.easychat-user-message {
    box-shadow: -1px 1px 5px rgba(0, 0, 0, 0.2);
    float: right;
    height: auto;
    max-width: 80%;
    font-size: 14px;
    color: white;
    border-radius: 10px 0px 10px 10px;
    word-wrap: break-word;
    display: inline-block;
    margin-right: 0.3em;
}

.easychat-user-message-line {
    line-height: 16px;
    padding: 0.8em 0.7em 0.8em 0.8em !important;
}

.easychat-livechat-customer-attachment {
    width: auto;
    max-width: 80%;
    float: left;
    background-color: #ffffff;
    margin: 1em 0px 3px 0px;
    padding: 4px 4px 1px 4px;
    border-radius: 0em 1em 1em 1em;
    box-shadow: 1px 1px 6px rgba(0, 0, 0, 0.2);
}

.easychat-livechat-message {
    height: fit-content;
    padding: 6px;
    word-wrap: break-word;
}

#modal-mis-filter label {
    font-size: 13px;
}

#tbody-captured-screenshot-details a {
    {% if access_token_obj.cobrowsing_console_theme_color != None %}
        color: var(--color_rgb) !important;
    {% else %}
        color: #0254D7 !important;
    {% endif %}
}

</style>
<!-- Begin Page Content -->
<div class="container-fluid">
    <!-- Page Heading -->
    <!-- DataTales Example -->
    <div class="row rectangle-btn-parent" style="margin: 0px 0px 10px 0px;">
        {% if access_token_obj.allow_video_meeting_only == False %}
        <div class="col-md pd-l ">
            <a class="rectangle-btn" href="/easy-assist/sales-ai/support-history/"> Attended Leads </a>
        </div>
        {% endif %}

        {% if access_token_obj.allow_video_meeting_only == False %}
        <div class="col-md pd-l">
            <a class="rectangle-btn " href="/easy-assist/sales-ai/unattended-leads/"> Unattended Leads </a>
        </div>
        {% endif %}

        {% if access_token_obj.allow_video_meeting_only == False and access_token_obj.show_verification_code_modal == True %}
        <div class="col-md pd-l">
            <a class="rectangle-btn " href="/easy-assist/sales-ai/declined-leads/"> Declined Leads </a>
        </div>
        {% endif %}

        {% if access_token_obj.enable_followup_leads_tab == True %}
        {% if access_token_obj.allow_video_meeting_only == False %}
        {% if cobrowse_agent.role == "agent" and cobrowse_agent.assign_followup_leads or cobrowse_agent.role != "agent" %}
        <div class="col-md pd-l">
            <a class="rectangle-btn " href="/easy-assist/sales-ai/followup-leads/"> Follow-up Leads </a>
        </div>
        {% endif %}
        {% endif %}
        {% endif %}

        {% if access_token_obj.allow_video_meeting_only == False %}
        <div class="col-md pd-l">
            <a class="rectangle-btn " href="/easy-assist/sales-ai/manually-converted-leads/">Manually Converted Leads</a>
        </div>
        {% endif %}

        {% if access_token_obj.allow_video_meeting_only == False %}
        {% if access_token_obj.allow_screen_recording == True %}
        <div class="col-md pd-l">
            <a class="rectangle-btn " href="/easy-assist/sales-ai/screen-recording-audit-trail/"> Screen Recording </a>
        </div>
        {% endif %}
        {% endif %}
    </div>

    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <div class="row align-items-center">
                <div class="col-sm-4">
                    <h6 class="m-0 font-weight-bold text-primary heading-text-primary align-middle">Attended Leads
                        <span data-toggle="tooltip" data-placement="top" title="" data-original-title="Sessions attended by the Agents."><i class="fas fa-info-circle"></i></span>
                    </h6>
                </div>
                {% if is_support_history_empty == False %}
                <div class="col-sm-8 d-flex justify-content-end card-header-left-div">
                    <div class="form-group has-search d-flex mb-0 mr-2">
                        <span class="fa fa-search form-control-feedback"></span>
                        <input type="text" id="custom-agent-table-search" class="custom-table-search form-control" placeholder="Search" aria-controls="support-history-table">
                    </div>
                    {% if cobrowse_agent.role == "admin" or cobrowse_agent.role == "supervisor" or cobrowse_agent.role == "admin_ally" %}
                        {% if cobrowse_io_objs %}
                         <button class="btn btn-info btn-width-100" style="width: 120px;" data-toggle="modal" data-target="#modal-mis-filter">Export</button>
                         {% endif %}
                    {% endif %}
                    <button class="btn btn-white-border btn-width-100" data-toggle="modal" data-target="#apply_filter_modal">Filter</button>
                </div>
                {% endif %}
            </div>
            <h6 class="m-0 font-weight-bold text-primary"></h6>
        </div>
        <div class="card-body">
            <div class="row filter-result-div" id="applied-filter-div" style="display: none;">
                <div class="filter-items-container" id="applied-filter-result-container">
                </div>
                <div class="filtered-result-text-heading">
                    Filtered Results
                </div>
            </div>

            {% if is_filter_applied %}
            <div class="table-responsive support-history-table-admin">
                <table class="table table-bordered" style="width: 100%;" id="support-history-table">
                    <thead>
                        <tr>
                            <th scope="col">Customer Details</th>
                            <th scope="col">Request Date & Time</th>
                            <th scope="col">Start Date & Time</th>
                            {% if cobrowse_agent.role != "agent" %}
                            <th scope="col">Agent</th>
                            {% endif %}
                            {% if cobrowse_agent.role == "admin_ally" %}  
                            <th scope="col">Supervisors</th>   
                            {% endif %}
                            <th scope="col">Time Duration</th>
                            <th scope="col">Status</th>
                            <th scope="col">Session Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cobrowse_io_obj in cobrowse_io_objs %}
                        <tr>
                            {% if cobrowse_io_obj.is_lead %}
                            <td>{{ cobrowse_io_obj.get_sync_data|safe }}</td>
                            {% else %}
                            <td>Name: {{ cobrowse_io_obj.full_name }}
                                <br> Mobile Number: {{ cobrowse_io_obj.mobile_number|mask_data }}
                                <br> Initiated:             
                                {% if cobrowse_io_obj.lead_initiated_by == 'floating_button' %}
                                    Floating Button
                                {% elif cobrowse_io_obj.lead_initiated_by == 'greeting_bubble' %}
                                    Greeting Bubble
                                {% elif cobrowse_io_obj.lead_initiated_by == 'icon' %}
                                    Icon
                                {% elif cobrowse_io_obj.lead_initiated_by == 'exit_intent' %}
                                    Exit Intent
                                {% elif cobrowse_io_obj.lead_initiated_by == 'inactivity_popup' %}
                                    Inactivity Pop-up
                                {% else %}
                                - 
                                {% endif %}
                            </td>
                            {% endif %}
                            <td>{{ cobrowse_io_obj.request_datetime | date:"d-M-Y, h:i A" }}</td>
                            <td>{{ cobrowse_io_obj.cobrowsing_start_datetime | date:"d-M-Y, h:i A" }}</td>
                            {% if cobrowse_agent.role != "agent" %} {% if cobrowse_io_obj.agent %}
                            <td>{{ cobrowse_io_obj.agent.user.username }}</td>
                            {% else %}
                            <td>No agent</td>
                            {% endif %} {% endif %}
                            {% if cobrowse_agent.role == "admin_ally" %}
                            <td>
                            <div data-toggle="tooltip" title="{{ cobrowse_io_obj.agent.get_supervisors }}" data-placement="bottom" class="easyassist-supervisor-list-ellips">
                                        {% if cobrowse_io_obj.agent.get_supervisors %}
                                            {{ cobrowse_io_obj.agent.get_supervisors}}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </div>
                            </td>
                            {% endif %}
                            <td>{{ cobrowse_io_obj.total_time_spent }}</td>
                            <td>
                                {% if cobrowse_io_obj.is_archived and cobrowse_io_obj.is_helpful %}
                                <p style="color: green;">Converted</p>
                                {% else %}
                                <p>Not Converted</p>
                                {% endif %}
                            </td>
                            <td>
                                <button type="button" onclick="show_right_sidenav('{{ cobrowse_io_obj.pk }}')" class="right-sidenav-session-btn btn btn-info btn-icon-split request-cobrowsing-btn-md">
                                    <span class="icon text-white-50">
                                        <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9 0C4.02991 0 0 4.02991 0 9C0 13.9701 4.02991 18 9 18C13.9701 18 18 13.9701 18 9C18 4.02991 13.9701 0 9 0ZM9.64286 13.3393C9.64286 13.4277 9.57054 13.5 9.48214 13.5H8.51786C8.42946 13.5 8.35714 13.4277 8.35714 13.3393V7.875C8.35714 7.78661 8.42946 7.71429 8.51786 7.71429H9.48214C9.57054 7.71429 9.64286 7.78661 9.64286 7.875V13.3393ZM9 6.42857C8.74766 6.42342 8.5074 6.31956 8.33076 6.13929C8.15413 5.95901 8.0552 5.71667 8.0552 5.46429C8.0552 5.2119 8.15413 4.96956 8.33076 4.78929C8.5074 4.60901 8.74766 4.50515 9 4.5C9.25234 4.50515 9.4926 4.60901 9.66924 4.78929C9.84587 4.96956 9.9448 5.2119 9.9448 5.46429C9.9448 5.71667 9.84587 5.95901 9.66924 6.13929C9.4926 6.31956 9.25234 6.42342 9 6.42857Z" fill="rgba(255,255,255,.5)"></path>
                                        </svg>
                                    </span>
                                    <span class="text">Session Details</span>
                                </button>
                                <button type="button" onclick="show_right_sidenav('{{ cobrowse_io_obj.pk }}')" class="right-sidenav-session-btn btn btn-info request-cobrowsing-btn">
                                    <div class="sessiondetail-icon">
                                        <svg style="margin-top: 12px;" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M9 0C4.02991 0 0 4.02991 0 9C0 13.9701 4.02991 18 9 18C13.9701 18 18 13.9701 18 9C18 4.02991 13.9701 0 9 0ZM9.64286 13.3393C9.64286 13.4277 9.57054 13.5 9.48214 13.5H8.51786C8.42946 13.5 8.35714 13.4277 8.35714 13.3393V7.875C8.35714 7.78661 8.42946 7.71429 8.51786 7.71429H9.48214C9.57054 7.71429 9.64286 7.78661 9.64286 7.875V13.3393ZM9 6.42857C8.74766 6.42342 8.5074 6.31956 8.33076 6.13929C8.15413 5.95901 8.0552 5.71667 8.0552 5.46429C8.0552 5.2119 8.15413 4.96956 8.33076 4.78929C8.5074 4.60901 8.74766 4.50515 9 4.5C9.25234 4.50515 9.4926 4.60901 9.66924 4.78929C9.84587 4.96956 9.9448 5.2119 9.9448 5.46429C9.9448 5.71667 9.84587 5.95901 9.66924 6.13929C9.4926 6.31956 9.25234 6.42342 9 6.42857Z" fill="white"></path>
                                        </svg>
                                    </div>
                                    <span class="text">Session Details</span>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% if total_cobrowse_objs > 0 %}
            <div class="row mt-3">
                <div class="col-md-6 col-sm-12 show-pagination-entry-container" filter_default_text="Showing {{start_point}} to {{end_point}} of {{total_cobrowse_objs}} entries" start_point="{{start_point}}" end_point="{{end_point}}">
                    Showing {{start_point}} to {{end_point}} of {{total_cobrowse_objs}} entries
                </div>
                <div class="col-md-6 col-sm-12">
                    <div class="d-flex justify-content-end">
                        <nav aria-label="Page navigation example">
                          <ul class="pagination">

                            {% if cobrowse_io_objs.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" onclick="load_more_page('{{ cobrowse_io_objs.previous_page_number }}');" href="javascript:void(0)" aria-label="Previous">
                                        <span aria-hidden="true">Previous</span>
                                        <span class="sr-only">Previous</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="disabled page-item"><span>
                                    <a class="page-link" href="javascript:void(0)" aria-label="Previous">
                                        <span aria-hidden="true">Previous</span>
                                        <span class="sr-only">Previous</span>
                                    </a>
                                </li>
                            {% endif %}

                            {% if cobrowse_io_objs.number|add:'-4' > 1 %}
                                <li class="page-item">
                                    <a class="page-link" onclick="load_more_page('{{ cobrowse_io_objs.number|add:'-5' }}');" href="javascript:void(0)">&hellip;</a>
                                </li>
                            {% endif %}

                            {% for i in cobrowse_io_objs.paginator.page_range %}
                                {% if cobrowse_io_objs.number == i %}
                                    <li class="active purple darken-3 page-item">
                                        <a onclick="load_more_page('{{ i }}');" href="javascript:void(0)" class="page-link">{{ i }}</a>
                                    </li>
                                {% elif i > cobrowse_io_objs.number|add:'-5' and i < cobrowse_io_objs.number|add:'5' %}
                                    <li class="page-item">
                                        <a href="javascript:void(0)" onclick="load_more_page('{{ i }}');" class="page-link">{{ i }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if cobrowse_io_objs.paginator.num_pages > cobrowse_io_objs.number|add:'4' %}
                                <li class="page-item">
                                    <a href="javascript:void(0)" onclick="load_more_page('{{ cobrowse_io_objs.number|add:'5' }}');" class="page-link">&hellip;</a>
                                </li>
                            {% endif %}

                            {% if cobrowse_io_objs.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="javascript:void(0)" onclick="load_more_page('{{ cobrowse_io_objs.next_page_number }}');" aria-label="Next">
                                        <span aria-hidden="true">Next</span>
                                        <span class="sr-only">Next</span>
                                    </a>
                                </li>
                            {% else %}
                                <li class="disabled page-item">
                                    <a class="page-link" href="javascript:void(0)" aria-label="Next">
                                        <span aria-hidden="true">Next</span>
                                        <span class="sr-only">Next</span>
                                    </a>
                                </li>
                            {% endif %}
                          </ul>
                        </nav>
                    </div>
                </div>
            </div>
            {% endif %}
            {% else %}
            <p><b>Please apply filter to see the support history details.</b></p>
            {% endif %}
        </div>
    </div>
</div>

{% for cobrowse_io_obj in cobrowse_io_objs %}
<!-- Product Infomation Start -->
<div class="navbar-nav bg-gradient-light sidebar sidebar-dark accordion product-session-details" id="accordionSidebar-{{ cobrowse_io_obj.pk }}" style="overflow-y: scroll;max-height: 100vh;">
    <a class="sidebar-brand" href="javascript:void(0)">
        <div class="text-dark mx-3">Session Details<i class="fas fa-window-close text-dark" style="float:right;" onclick="hide_right_sidenav(this)"></i></div>
    </a>
    <div style="padding:0.5em 1em 1em 1em;">
        <strong>Session ID :</strong>
        <br>
        <a href="/easy-assist/sales-ai/support-history/?session_id={{ cobrowse_io_obj.session_id }}">
            <p>{{ cobrowse_io_obj.session_id }} </p>
        </a>

        <hr>

        <div><strong>Customer Details</strong>
        </div>
        <br>
        {% if cobrowse_io_obj.is_lead %}
        <p>{{ cobrowse_io_obj.get_sync_data_formatted|safe }}</p>
        {% else %}
        <p><b>Name:</b> {{ cobrowse_io_obj.full_name }}</p>
        <p><b>Mobile Number:</b> {{ cobrowse_io_obj.mobile_number|mask_data }}</p>
        {% endif %}

        {% if access_token_obj.enable_location %}
            {% if cobrowse_io_obj.longitude == None or cobrowse_io_obj.latitude == None %}
                <p> <b> Location Details: </b> No details</p>
            {% else %}
            <p>
                <b> Location Details: </b>
                <a class="btn btn-info" href="#" data-toggle="modal" data-target="#client_location_details" onclick="show_client_location_details('{{ cobrowse_io_obj.full_name }}', '{{ cobrowse_io_obj.longitude }}', '{{ cobrowse_io_obj.latitude }}');hide_right_sidenav_by_id('{{ cobrowse_io_obj.pk }}')">Location Details
                </a>
            </p>
            {% endif %}
        {% endif %}

        <p><b>Request Date & Time:</b> {{ cobrowse_io_obj.request_datetime | date:"d-M-Y, h:i A" }}</p>
        {% if not cobrowse_io_obj.is_lead %}
            <p><b>Wait Time:</b> {{ cobrowse_io_obj.customer_wait_time }}</p>
        {% endif %}
        <p><b>Session Initiated By:</b> 
            {% if cobrowse_io_obj.lead_initiated_by == 'floating_button' %}
                Floating Button
            {% elif cobrowse_io_obj.lead_initiated_by == 'greeting_bubble' %}
                Greeting Bubble
            {% elif cobrowse_io_obj.lead_initiated_by == 'icon' %}
                Icon
            {% elif cobrowse_io_obj.lead_initiated_by == 'exit_intent' %}
                Exit Intent
            {% elif cobrowse_io_obj.lead_initiated_by == 'inactivity_popup' %}
                Inactivity Pop-up
            {% else %}
                - 
            {% endif %}
        </p>
        {% if cobrowse_io_obj.last_agent_update_datetime != None and cobrowse_io_obj.last_agent_update_datetime != "" %}
            <p><b>Session End Date & Time: </b> {{ cobrowse_io_obj.last_agent_update_datetime | date:"d-M-Y, h:i A" }}</p>
        {% else %}
            <p><b>Session End Date & Time: </b>-</p>
        {% endif %}

        <p> <b>Session Started By: </b> {{ cobrowse_io_obj.get_session_started_by }} </p>
        
        {% if cobrowse_io_obj.session_archived_cause != None %}

            {% if cobrowse_io_obj.session_archived_cause == "AGENT_ENDED" %}
                <p> <b>Session Ended By: </b> Agent </p>
            {% elif cobrowse_io_obj.session_archived_cause == "CLIENT_ENDED" %}
                <p> <b>Session Ended By: </b> Customer </p>
            {% elif cobrowse_io_obj.session_archived_cause == "AGENT_INACTIVITY" %}
                <p> <b>Session Ended By: </b> Agent </p>
            {% elif cobrowse_io_obj.session_archived_cause == "CLIENT_INACTIVITY" %}
                <p> <b>Session Ended By: </b> Customer </p>
            {% endif %}

        {% endif %}

        {% if cobrowse_io_obj.role != "agent" %}
            {% if cobrowse_io_obj.agent_rating != None %}
            <p><b>NPS: </b>{{ cobrowse_io_obj.agent_rating }}</p>
            {% else %}
            <p><b>NPS: </b>Not provided</p>
            {% endif %}
        {% endif %}

        <hr>

        <div>
            <strong>Product Details</strong>
        </div>
        <br>
        <p><b>Session Start:</b> <u><a href="{{ cobrowse_io_obj.product_url }}" target="_blank">{{ cobrowse_io_obj.product_name }}</a></u> </p>
        <p><b>Description:</b> {{ cobrowse_io_obj.product_description|slice:":100" }}</p>
        {% if not cobrowse_io_obj.is_reverse_cobrowsing %}
            <p><b>Session End:</b> <u><a href="{{ cobrowse_io_obj.drop_off_url }}" target="_blank">{{ cobrowse_io_obj.drop_off_name }}</a></u> </p>
        {% else %}
        <p><b>Session End:</b> - </p>
        {% endif %}
        <p><b>Total Time Spent: </b> {{ cobrowse_io_obj.total_time_spent }}</p>

        {% if cobrowse_io_obj.is_archived and cobrowse_io_obj.is_helpful %}
        <p> <b>Lead Status: </b> Converted</p>
        {% else %}
        <p> <b>Lead Status:</b> Not Converted</p>
        {% endif %}

        <p> <b>Lead Type: </b>{{ cobrowse_io_obj.get_lead_type }}</p>
        <hr>

        <div>
            <strong>Agent Details</strong>
        </div>
        <br>
        {% if cobrowse_io_obj.main_primary_agent %}
            <p><b>Primary Agent: </b>{{ cobrowse_io_obj.main_primary_agent.user.username }}</p>
        {% else %}
            <p><b>Primary Agent: </b>{{ cobrowse_io_obj.agent.user.username }}</p>
        {% endif %}
        
        {% if access_token_obj.enable_request_in_queue %}
            <p><b>Self assign time: </b> {{ cobrowse_io_obj.get_self_assign_time }} </p>
        {% endif %}
        
        {% if access_token_obj.enable_auto_assign_unattended_lead %}
            <p><b>Auto-assigned Agent: </b>{{ cobrowse_io_obj.get_auto_assigned_agents }}</p>
        {% endif %}

        {% if access_token_obj.enable_invite_agent_in_cobrowsing %}
            {% if cobrowse_io_obj.get_cobrowse_support_agent_details %}
                <p><b>Agents Invited: </b>
                {% if cobrowse_io_obj.get_cobrowse_support_agent_details.support_agents_invited.all %}
                    {% for agent in cobrowse_io_obj.get_cobrowse_support_agent_details.support_agents_invited.all %}
                        {% if not forloop.last %}
                            {{ agent }},
                        {% else %}
                            {{ agent }}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    -
                {% endif %}
                </p>
                <p><b>Invited Agent Connected: </b>
                {% if cobrowse_io_obj.get_cobrowse_support_agent_details.support_agents_joined.all %}
                    {% for agent in cobrowse_io_obj.get_cobrowse_support_agent_details.support_agents_joined.all %}
                        {% if not forloop.last %}
                            {{ agent }},
                        {% else %}
                            {{ agent }}
                        {% endif %}
                    {% endfor %}
                {% else %}
                    -
                {% endif %}
                </p>
            {% else %}
                <p><b>Agents Invited: </b>-</p>
                <p><b>Invited Agent Connected: </b>-</p>
            {% endif %}
        {% endif %}
            
        {% if access_token_obj.enable_auto_assign_unattended_lead %}
            <p><b>Assigned Agents: </b>
                {% if cobrowse_io_obj.get_unattended_lead_transfer_audit_trail %}
                    {{ cobrowse_io_obj.get_unattended_lead_transfer_audit_trail | length }} &nbsp;
                    <button class="btn btn-info" data-toggle="modal" onclick="open_agent_audit_trail_modal({{cobrowse_io_obj.get_unattended_lead_transfer_audit_trail | safe}}); hide_right_sidenav_by_id('{{ cobrowse_io_obj.pk }}');">View Details</button>
                {% else %}
                    -
                {% endif %}
            </p>
        {% endif %}

        {% if access_token_obj.enable_invite_agent_in_cobrowsing and access_token_obj.enable_session_transfer_in_cobrowsing %}
            {% if cobrowse_io_obj.get_cobrowse_transferred_agent_list %}
                <p><b>Transferred Agents:</b> {{ cobrowse_io_obj.get_cobrowse_transferred_agent_list }}
                </p>
                <p><b>Transferred Agents Connected: </b> {{ cobrowse_io_obj.get_cobrowse_transferred_agent_connected_list }}
                </p>
                <p><b>Transferred Agents Not Connected: </b>{{ cobrowse_io_obj.get_cobrowse_transferred_agent_rejected_list }}</p>
            {% else %}
                <p><b>Transferred Agents: </b>-</p>
                <p><b>Transferred Agents Connected: </b>-</p>
                <p><b>Transferred Agents Not Connected: </b>-</p>
            {% endif %}
        {% endif %}
        
        <hr>

        {% if cobrowse_io_obj.get_cobrowse_video_audit_trail_obj %}
        <div>
            <strong>Voice Call Audit Trail</strong>
        </div>
        <br>
        <p><b>Start Time:</b> {{ cobrowse_io_obj.get_cobrowse_video_audit_trail_obj.agent_joined | date:"d-M-Y, h:i A" }}</p>
        <p><b>End Time:</b> {{ cobrowse_io_obj.get_cobrowse_video_audit_trail_obj.meeting_ended | date:"d-M-Y, h:i A" }}</p>
        <p><b>Total Time Spent (in HH:MM:SS): </b> {{ cobrowse_io_obj.get_cobrowse_video_audit_trail_obj.get_meeting_duration }}</p>
        <p><b>Initiated by: </b> {{ cobrowse_io_obj.get_cobrowse_video_audit_trail_obj.get_meeting_initiated_by }}</p>
        <hr>
        {% endif %}

        <div>
            <strong>Edit Access Audit Trail</strong>
        </div>
        <div style="overflow: auto;max-height: 150px;">
        {% for request_access_audit_trail_obj in cobrowse_io_obj.get_request_access_audit_trail_objs %}
            <b>
                {{request_access_audit_trail_obj.datetime}}
            </b>
            <br>
            {% if request_access_audit_trail_obj.cobrowse_io.is_reverse_cobrowsing == False %}
            {% if request_access_audit_trail_obj.description == "agent_requested_edit_access" %}
                {{request_access_audit_trail_obj.sender}} requested edit access
            {% elif request_access_audit_trail_obj.description == "client_provided_edit_access" %}
                Customer provided edit access to {{request_access_audit_trail_obj.sender}}
            {% elif request_access_audit_trail_obj.description == "client_denied_edit_access" %}
                Customer denided edit access of {{request_access_audit_trail_obj.sender}}
            {% elif request_access_audit_trail_obj.description == "client_revoked_edit_access" %}
                Customer revoked edit access from {{request_access_audit_trail_obj.sender}}
            {% elif request_access_audit_trail_obj.description == "agent_revoked_edit_access" %}
                {{request_access_audit_trail_obj.sender}} revoked edit access
            {% endif %}

            {% else %}
            {% if request_access_audit_trail_obj.description == "agent_requested_edit_access" %}
                Customer requested edit access
            {% elif request_access_audit_trail_obj.description == "client_provided_edit_access" %}
                Agent {{request_access_audit_trail_obj.cobrowse_io.agent}} provided edit access to Customer
            {% elif request_access_audit_trail_obj.description == "client_denied_edit_access" %}
                Agent {{request_access_audit_trail_obj.cobrowse_io.agent}} denided edit access of Customer
            {% elif request_access_audit_trail_obj.description == "client_revoked_edit_access" %}
                Agent {{request_access_audit_trail_obj.cobrowse_io.agent}} revoked edit access from Customer
            {% elif request_access_audit_trail_obj.description == "agent_revoked_edit_access" %}
                Customer revoked edit access
            {% endif %}
            {% endif %}
            <br>
        {% endfor %}
        </div>
        <br>

        {% if cobrowse_io_obj.get_cobrowsing_session_meta_data|length %}
        <p><b>Screenshot:</b> 
            <button class="btn btn-info" data-toggle="modal" data-target="#see_captured_screenshot" onclick="show_captured_screenshot_details('{{ cobrowse_io_obj.pk }}'); hide_right_sidenav_by_id('{{ cobrowse_io_obj.pk }}')">Screenshot
            </button>
        </p>
        {% else %}
        <p><b>Screenshot:</b> No screenshot captured</p>
        {% endif %}
        
        {% if cobrowse_io_obj.get_cobrowsing_chat_history|length %}
        <p><b>Chat History:</b> 
            <button class="btn btn-info" data-toggle="modal" data-target="#agent_chat_history" onclick="show_agents_chat_history_for_session('{{ cobrowse_io_obj.pk }}');hide_right_sidenav_by_id('{{ cobrowse_io_obj.pk }}')">Chat history
            </button>
        </p>
        {% else %}
        <p><b>Chat History:</b> No chat found</p>
        {% endif %}

        {% if cobrowse_io_obj.get_cobrowsing_session_closing_comments|length %}
        <p><b>Agent Remarks:</b> 
            <button class="btn btn-info" data-toggle="modal" data-target="#see_agent_comments" onclick="show_agents_comment_for_session('{{ cobrowse_io_obj.pk }}'); hide_right_sidenav_by_id('{{ cobrowse_io_obj.pk }}')">Agent Remarks
            </button>
        </p>
        {% else %}
        <p><b>Agent Remarks:</b> No remarks</p>
        {% endif %}

        {% if cobrowse_io_obj.client_comments %}
        <p><b>Customer Remarks:</b> 
            <button class="btn btn-info" data-toggle="modal" data-target="#cobrowsing_customer_comments-{{ cobrowse_io_obj.pk }}" onclick="show_customer_comment_for_session('{{ cobrowse_io_obj.pk }}'); hide_right_sidenav_by_id('{{ cobrowse_io_obj.pk }}')">Customer Remarks
            </button>
        </p>
        {% else %}
        <p><b>Customer Remarks: </b>No Remarks</p>
        {% endif %}


        {% if cobrowse_io_obj.get_basic_activity_audit_trail_objs|length %}
        <p><b>Session Audit Trail: </b> 
            <button class="btn btn-info" data-toggle="modal" data-target="#see_system_audit_trail_modal_id" onclick="hide_right_sidenav_by_id('{{ cobrowse_io_obj.pk }}'); show_system_audit_trail_details('{{ cobrowse_io_obj.pk }}');">Session Audit Trail
            </button>
        </p>
        {% else %}
        <p><b>Session Audit Trail: </b>No audit trail</p>
        {% endif %}
    </div>
</div>
<!-- Product Information End -->
{% endfor %}

<!-- ********************************* Export data -->
<div class="modal fade custom-modal-export-data" id="modal-mis-filter" tabindex="-1" role="dialog" aria-labelledby="client_location_details_label" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="export_mis_lable">Export Support History</h5>
                <span style="cursor: pointer;" data-dismiss="modal">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M18 6L6 18" stroke="#25282B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                      <path d="M6 6L18 18" stroke="#25282B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                    </svg>                  
                </span>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <h6 class="modal-input-heading">Select date range</h6>
                        <select id="select-date-range" class="form-control custom-select-dropdown-arrow-icon" onchange="check_select_date_range(this)">
                            <option value="0" selected="selected">Choose date range</option>
                            <option value="1">Last day</option>
                            <option value="2">Last 7 days</option>
                            <option value="3">Last 1 month</option>
                            <option value="4">Custom Range</option>
                        </select>
                    </div>
                    <div class="col-sm-6 mt-4" id="from-date-div" style="display: none;">
                        <h6 >From Date <span class="text-danger">*</span></h6>
                        <input id="startdate" placeholder="From Date" class="filter-parameter form-control datepicker" autocomplete="off" data-date-format="dd-mm-yyyy">
                    </div>
                    <div class="col-sm-6 mt-4" id="to-date-div" style="display: none;">
                        <h6 class="modal-input-heading">To Date <span class="text-danger">*</span></h6>
                        <input id="enddate" placeholder="To Date" class="filter-parameter form-control datepicker" autocomplete="off" data-date-format="dd-mm-yyyy">
                    </div>
                    <div class="col-sm-12" id="email-id-div" style="display:none; padding-top: 25px;">
                        <h6 class="modal-input-heading">Email ID <span class="text-danger">*</span></h6>
                        <textarea class="form-control mb-2" id="filter-data-email" style="height:10em;">{{ request.user.email }}</textarea>
                        <span><b>Note: You will receive the attended leads data dump on the above email ID within 24 hours.</b></span>
                    </div>

                    <div class="col-sm-12 px-4 pt-4 d-flex align-items-center checkbox-div">
                      <div class="d-flex mr-4">
                        <label class="cam p-0 mb-0">
                          <input type="checkbox" id="support_history" checked/>
                          <span class="checkmark"></span>
                        </label>
                        <p class="checkbox-title mb-0 ml-4">Support History</p>
                      </div>
                      
                      <div class="d-flex">
                        <label class="cam p-0 mb-0">
                          <input type="checkbox" id="chat_history"/>
                          <span class="checkmark"></span>
                        </label>
                        <p class="checkbox-title mb-0 ml-4">Chat History</p>
                      </div>
                      
                    </div>

                    <div class="col-sm-12 mt-3" id="general-error-message">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary cancel-export-button" type="button" data-dismiss="modal">Cancel</button>
              <button class="btn btn-success export-data-button" onclick="export_support_history()">Export</button>            </div>
        </div>
    </div>
</div>


<div class="modal fade client-location-details" id="client-location-details" tabindex="-1" role="dialog" aria-labelledby="client_location_details_label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="client_location_details_label">Customer's Location Details</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="table-responsive">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="see_agent_comments" tabindex="-1" role="dialog" aria-labelledby="see_agent_comments_modal_label" aria-hidden="true">
    <div class="modal-dialog" role="document">

        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="see_agent_comments_modal_label">Agent Remarks</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-borderless" id="agent-comments-table">
                                <thead>
                                    <tr>
                                        <th scope="col">Agent</th>
                                        <th scope="col">Date & Time</th>
                                        <th scope="col">Remarks</th>

                                        {% if access_token_obj.enable_predefined_remarks %}
                                        {% if access_token_obj.enable_predefined_subremarks %}
                                        <th scope="col">Subremarks</th>
                                        {% endif %}
                                        {% endif %}

                                        {% if access_token_obj.enable_predefined_remarks %}
                                        <th scope="col">Comments</th>
                                        {% endif %}
                                    </tr>
                                </thead>
                                <tbody id="tbody-agent-comments-details"></tbody>
                            </table>
                        </div>
                        <p style="text-align: center;" id="no-comments-empty-message">No agent comments</p>
                    </div>
                    <div class="col-sm-12 load_more_btn_container mb-0" style="display: none;text-align: right;">
                        <button class="btn btn-primary">Load More</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>

{% for cobrowse_io_obj in cobrowse_io_objs %}
{% if cobrowse_io_obj.client_comments %}
<div class="modal fade" id="cobrowsing_customer_comments-{{ cobrowse_io_obj.pk }}" tabindex="-1" role="dialog" aria-labelledby="customer_comments_modal_label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Customer Remarks</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-borderless" id="agent-comments-table">
                                <thead>
                                    <tr>
                                        <th scope="col">Customer</th>
                                        <th scope="col">Date & Time</th>
                                        <th scope="col">Remarks</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-agent-comments-details">
                                    {% if cobrowse_io_obj.is_lead %}
                                        <td>{{ cobrowse_io_obj.get_sync_data_formatted|safe }}</td>
                                    {% else %}
                                        <td>{{ cobrowse_io_obj.full_name }}</td>
                                    {% endif %}
                                    {% if cobrowse_io_obj.client_session_end_time %}
                                        <td>{{cobrowse_io_obj.client_session_end_time | date:"d-M-Y, h:i A" }}</td>
                                    {% else %}
                                        <td>-</td>
                                    {% endif %}
                                    <td>{{cobrowse_io_obj.client_comments}}</td>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<div class="modal fade" id="agent_chat_history" tabindex="-1" role="dialog" aria-labelledby="agent_chat_history_modal_label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="agent_chat_history_modal_label">Chat history</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12" id="session-chat-history-container" style="max-height: 400px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="see_captured_screenshot" tabindex="-1" role="dialog" aria-labelledby="see_captured_screenshot_modal_label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="see_captured_screenshot_modal_label">Captured screenshot details</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-borderless">
                                <thead>
                                    <tr>
                                        <th scope="col">Screenshot</th>
                                        <th scope="col">Time</th>
                                        <th scope="col">Download</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody-captured-screenshot-details"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-sm-12 load_more_btn_container mb-0" style="display: none;text-align: right;">
                        <button class="btn btn-primary">Load More</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="see_system_audit_trail_modal_id" tabindex="-1" role="dialog" aria-labelledby="see_system_audit_trail_modal_label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="see_system_audit_trail_modal_label">Session Audit Trail</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="table-responsive" style="max-height: 400px;">
                            <table class="table table-borderless">
                                <thead>
                                    <tr>
                                        <th scope="col" style="min-width: 12em;">Date & Time</th>
                                        <th scope="col" style="min-width: 12em;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tbody_see_system_audit_trail"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="col-sm-12 load_more_btn_container mb-0" style="display: none;text-align: right;">
                        <button class="btn btn-primary">Load More</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="apply_filter_modal" tabindex="-1" role="dialog" aria-labelledby="apply_filter_modal_modal_label" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="apply_filter_modal_modal_label">Apply Custom Filter</h5>
            </div>
            <div class="modal-body">
                <div class="row filter-header-row">
                    <div class="col-md-4 col-sm-12 filter-mb-sm-4">
                        <select class="form-control" onchange="show_filter_options(this)" id="selected-filter-parameter" style="width: 100%!important;">
                            <option value="None">Select Filter</option>
                            <option value="title">Title</option>
                            {% if cobrowse_agent.role != "agent" %}
                            <option value="agent">Agent</option>
                            {% endif %}
                            {% if cobrowse_agent.role == "admin_ally" %}
                            <option value="supervisor">Supervisor</option>
                            {% endif %}
                            <option value="startdate">Start Date</option>
                            <option value="enddate">End Date</option>
                            <option value="status">Status</option>
                            <option value="lead-type">Lead-Type</option>
                        </select>
                    </div>
                    <div class="col-md-5 col-sm-12 filter-mb-sm-4 easyassist-multiselect-dropdown-container" id="selected-filter-container">
                        <select class="form-control" style="display:none;" id="selected-title-filter">
                            {% for page_title in title_list %}
                            <option value="{{ page_title }}">{{ page_title }}</option>
                            {% endfor %}
                        </select>
                        <select class="form-control" style="display:none;" id="selected-agent-filter" multiple>
                            {% for agent in agents %}
                            <option value="{{ agent.user.username }}">{{ agent.user.username }}</option>
                            {% endfor %}
                        </select>
                        {% if cobrowse_agent.role == "admin_ally" %}
                        <select class="form-control" style="display:none;" id="selected-supervisor-filter" multiple>
                            {% for supervisor in supervisors %}
                            <option value="{{ supervisor.user.username }}">{{ supervisor.user.username }}</option>
                            {% endfor %}
                        </select>
                        {% endif %}
                        <input id="filter-start-date" placeholder="Start Date" style="display:none;" class="filter-parameter form-control datepicker" autocomplete="off" data-date-format="dd-mm-yyyy">
                        <input id="filter-end-date" placeholder="End Date" style="display:none;" class="filter-parameter form-control datepicker" autocomplete="off" data-date-format="dd-mm-yyyy">
                        <select class="form-control" style="display:none;" id="selected-status-filter">
                            <option value="all">All</option>
                            <option value="converted">Converted</option>
                            <option value="notconverted">Not Converted</option>
                        </select>
                        <select class="form-control" style="display:none;" id="selected-lead-type-filter">
                            <option value="all">All</option>
                            <option value="inbound">Inbound</option>
                            <option value="outbound">Outbound</option>
                            <option value="reverse">Reverse</option>
                            <option value="drop-link">Drop Link</option>
                            <option value="modified-inbound">Modified Inbound</option>
                            <!-- <option value="outbound-proxy">Outbound Proxy</option> -->
                        </select>
                    </div>
                    <div class="col-md-3 col-sm-12" style="align-items: center; display: flex;">
                        <button class="btn btn-success btn-icon-split" type="button" id="add-filter-btn" onclick="add_new_filter_parameter(this)" style="width: 100%;justify-content: start;" disabled>
                            <span class="icon text-white-50">
                                <svg width="19" height="14" viewBox="0 0 19 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6.03809 11.0455L1.53383 6.69202L0 8.16406L6.03809 14L19 1.47204L17.477 0L6.03809 11.0455Z" fill="white"/>
                                </svg>
                            </span>
                            <span class="text" style="width: 100%;">Add</span>
                        </button>
                    </div>
                </div>
                <div class="row" id="tbody-filter-parameters">

                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                <button id="reset_filter" class="btn btn-white-border" style="display: none;" disabled onclick="reset_support_history_filter(this)">Reset</button>
                <button id="apply_filter_confirm" class="btn btn-primary" disabled onclick="apply_support_history_filter(this)">Submit</button>
            </div>
        </div>
    </div>
</div>

<!-- Agent auto assign audit trail modal -->
<div class="modal fade auto-assign-transfer-audit-trail" id="auto_assign_audit_trail" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
       <div class="modal-content" style="margin: auto !important;">
          <div class="modal-header">
             <h5 class="modal-title" id="auto_assign_audit_trail_modal_label">Auto Assign Audit Trail
             </h5>
             <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                   <path d="M3.34525 3L20.655 21" stroke="#2D2D2D" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
                   <path d="M20.6548 3L3.34502 21" stroke="#2D2D2D" stroke-width="2.25" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
             </button>
          </div>
          <div class="modal-body">
             <div class="table-responsive" id="auto_assign_transfer_audit_trail_table_div">
                <table id="auto_assign_transfer_audit_trail_table" class="table table-bordered" style="width: 100%;">
                   <thead>
                      <tr>
                         <th scope="col">SL No.</th>
                         <th scope="col">Date Time</th>
                         <th scope="col">Auto Assigned Agent</th>
                      </tr>
                   </thead>
                   <tbody>
                   </tbody>
                </table>
             </div>
          </div>
       </div>
    </div>
 </div>

<!-- /.container-fluid -->
<script type="text/javascript">
window.is_filter_applied = false;
window.custom_title_filter_dropdown = null;
window.custom_session_filter_dropdown = null;
window.custom_lead_type_filter_dropdown = null;
window.custom_filter_option_dropdown = null;
window.applied_filter_key_value_map = {};

function right_sidenav_close_event(event){
    var parent_element = $(event.target).closest("#report_problem_icon,#report_problem_modal");
    if(parent_element.length) {
        return;
    }

    let bt_session=event.target.closest('.right-sidenav-session-btn');
    if(!bt_session){
        let container=$('.product-session-details:visible');
        if(container && container[0]!=event.target.closest('.product-session-details')){
            $('.product-session-details:visible').find('.sidebar-brand i').trigger('click');
        }
    }
}

function hide_right_sidenav(element) {
    element.parentElement.parentElement.parentElement.style.display = "none";
    document.removeEventListener('click',right_sidenav_close_event);
    document.removeEventListener('keydown', function (event) {
            var key = event.key || event.keyCode;
            if (key === 'Escape' || key === 'Esc' || key === 27) {
                $('.product-session-details:visible').find('.sidebar-brand i').trigger('click');
            }
    });
}

function show_right_sidenav(element_id) {
    var right_sidenav = document.getElementsByClassName("product-session-details");
    for (var index = 0; index < right_sidenav.length; index++) {
        right_sidenav[index].style.display = "none";
    }
    document.getElementById("accordionSidebar-" + element_id).style.display = "block";
    document.addEventListener('click',right_sidenav_close_event);
    document.addEventListener('keydown', function (event) {
            var key = event.key || event.keyCode;

            if (key === 'Escape' || key === 'Esc' || key === 27) {
                $('.product-session-details:visible').find('.sidebar-brand i').trigger('click');
            }
    });
}

function hide_right_sidenav_by_id(element_id){
    document.getElementById("accordionSidebar-" + element_id).style.display = "none";
}

function show_filter_options(element) {
    custom_title_filter_dropdown.hide_custom_dropdown();
    $("#selected-agent-filter").next().hide();
    if(document.querySelector("#selected-supervisor-filter")){
        $("#selected-supervisor-filter").next().hide();
    }
    custom_session_filter_dropdown.hide_custom_dropdown();
    custom_lead_type_filter_dropdown.hide_custom_dropdown();
    document.getElementById("filter-start-date").style.display = "none";
    document.getElementById("filter-end-date").style.display = "none";

    if (element.value == "None") {
        document.getElementById("add-filter-btn").disabled = true;
    } else {

        document.getElementById("selected-filter-container").style.display = "block";

        filter_parameters = document.getElementsByClassName("filter-parameter");
        for (var index = 0; index < filter_parameters.length; index++) {
            filter_parameters[index].style.display = "none";
        }
        if (element.value == "title") {
            custom_title_filter_dropdown.show_custom_dropdown();
        } else if (element.value == "agent") {
            $("#selected-agent-filter").next().show();
        } else if (element.value == "supervisor") {
            $("#selected-supervisor-filter").next().show();
        } else if (element.value == "startdate") {
            document.getElementById("filter-start-date").style.display = "block";
        } else if (element.value == "enddate") {
            document.getElementById("filter-end-date").style.display = "block";
        } else if (element.value == "status") {
            custom_session_filter_dropdown.show_custom_dropdown();
        } else if (element.value == "lead-type") {
            custom_lead_type_filter_dropdown.show_custom_dropdown();
        } else {
            show_easyassist_toast("Please select valid filter");
        }
        
        document.getElementById("reset_filter").removeAttribute("disabled");
        document.getElementById("reset_filter").style.display = "block";
        document.getElementById("add-filter-btn").disabled = false;
    }
}

function add_new_filter_parameter() {
    var filter_key = null;
    var filter_value = null;
    element = document.getElementById("selected-filter-parameter");
    if (element.value == "None") {
        show_easyassist_toast("Please select valid filter parameter");
    } else {
        var value = "None";
        var key = element.value;
        if (element.value == "title") {
            value = custom_title_filter_dropdown.get_value();
            if (value.length == 0) {
                show_easyassist_toast(NO_TITLE_SELECTED_TOAST);
                return;
            }
            filter_key = "Title";
            filter_value = value;
        } else if (element.value == "agent") {
            value = $("#selected-agent-filter").val();
            if (value.length == 0) {
                show_easyassist_toast(NO_AGENT_SELECTED_TOAST);
                return;
            }
            filter_key = "Agent"
            filter_value = value;
        } else if (element.value == "supervisor") {
            value = $("#selected-supervisor-filter").val();
            if (value.length == 0) {
                show_easyassist_toast(NO_SUPERVISOR_SELECTED_TOAST);
                return;
            }
            filter_key = "Supervisor"
            filter_value = value;
        } else if (element.value == "startdate") {
            value = document.getElementById("filter-start-date").value;

            if (value == "") {
                show_easyassist_toast(EMPTY_START_DATE_ERROR_TOAST);
                return;
            }

            var formatted_start_date = get_iso_formatted_date(value);
            if (applied_filter_key_value_map['enddate'] != null) {
                var formatted_end_date = get_iso_formatted_date(applied_filter_key_value_map['enddate'][0]);
                if (formatted_end_date < formatted_start_date) {
                    show_easyassist_toast(INVALID_START_DATE_ERROR_TOAST);
                    return;
                }
            }

            var today = get_today_date();
            if (formatted_start_date > today || formatted_start_date.length > 10) {
                show_easyassist_toast("Please select valid date");
                return;
            }

            filter_key = "Start Date"
            filter_value = [value];
        } else if (element.value == "enddate") {
            value = document.getElementById("filter-end-date").value;
            if (value == "") {
                show_easyassist_toast(EMPTY_END_DATE_ERROR_TOAST);
                return;
            }

            var formatted_end_date = get_iso_formatted_date(value);
            if (applied_filter_key_value_map['startdate'] != null) {
                var formatted_start_date = get_iso_formatted_date(applied_filter_key_value_map['startdate'][0]);
                if (formatted_start_date > formatted_end_date) {
                    show_easyassist_toast(INVALID_START_DATE_ERROR_TOAST);
                    return;
                }
            }

            var today = get_today_date();
            if (formatted_end_date > today || formatted_end_date.length > 10) {
                show_easyassist_toast("Please select valid date");
                return;
            }
            
            filter_key = "End Date";
            filter_value = [value];
        } else if (element.value == "status") {
            value = document.getElementById("selected-status-filter").value;

            filter_key = "Status"
            if (value == "converted") {
                filter_value = "Converted";
            } else if (value == "notconverted") {
                filter_value = "Not Converted";
            } else {
                filter_value = "All";
            }
            filter_value = [filter_value];
        } else if (element.value == "lead-type") {
            value = document.getElementById("selected-lead-type-filter").value;

            filter_key = "Lead-Type"
            if (value == "inbound") {
                filter_value = "Inbound";
            } else if (value == "outbound") {
                filter_value = "Outbound";
            } else if (value == "reverse") {
                filter_value = "Reverse";
            } else if (value == "drop-link") {
                filter_value = "Drop Link";
            } else if (value == "modified-inbound") {
                filter_value = "Modified Inbound";
            } else if (value == "outbound-proxy") {
                filter_value = "Outbound Proxy";
            } else {
                filter_value = "All";
            }
            filter_value = [filter_value];
        } else {
            show_easyassist_toast("Please select valid filter parameter");
        }

        if(check_filter_already_applied(applied_filter_key_value_map[key], filter_value)) {
            show_easyassist_toast(filter_key + " filter already applied");
            return;
        }

        if (applied_filter_key_value_map[key] != null) {
            applied_filter_key_value_map[key] = filter_value;
            update_applied_filter_by_key(key, filter_value);
            return;
        }
        applied_filter_key_value_map[key] = filter_value;

        var filter_chip_html = "";
        filter_chip_html = generate_filter_chips(filter_key, filter_value);
        
        var html_filter = [
            '<div class="col-md-12 filter-parameter-column" filter-key="' + key + '" filter-data=\'' + JSON.stringify(filter_value) + '\' style="padding: 1em;border-bottom: 1px solid #E6E6E6;">',
                '<div class="row filter-custom-row">',
                    '<div class="col-md-2 filter-mb-sm-2 filter-flex-column">',
                        '<span class="filter-text">' + filter_key + '</span>',
                        '<button type="button" class="btn remove-filter-row-btn filter-show-on-mobile" onclick="remove_selected_filter_parameter(this)">',
                            '<svg width="16" height="18" viewBox="0 0 16 18" fill="none" xmlns="http://www.w3.org/2000/svg">',
                                '<path d="M8 0C9.49884 0 10.7237 1.20574 10.8064 2.72496L10.8108 2.88889H15.3514C15.7096 2.88889 16 3.18737 16 3.55556C16 3.89306 15.756 4.17199 15.4394 4.21614L15.3514 4.22222H14.6629L13.5558 15.7948C13.441 16.994 12.4959 17.92 11.3406 17.9951L11.1888 18H4.81118C3.63878 18 2.64965 17.124 2.46385 15.9497L2.44423 15.7948L1.33622 4.22222H0.648649C0.320263 4.22222 0.0488727 3.97142 0.00592144 3.64602L0 3.55556C0 3.21805 0.244025 2.93912 0.560631 2.89497L0.648649 2.88889H5.18919C5.18919 1.2934 6.44763 0 8 0ZM13.3596 4.22222H2.63957L3.73529 15.6643C3.7861 16.1952 4.19488 16.6083 4.70127 16.661L4.81118 16.6667H11.1888C11.7078 16.6667 12.1478 16.289 12.2484 15.7762L12.2647 15.6643L13.3596 4.22222ZM9.51351 6.66667C9.8419 6.66667 10.1133 6.91747 10.1562 7.24287L10.1622 7.33333V13.5556C10.1622 13.9237 9.87175 14.2222 9.51351 14.2222C9.18513 14.2222 8.91374 13.9714 8.87079 13.646L8.86487 13.5556V7.33333C8.86487 6.96514 9.15528 6.66667 9.51351 6.66667ZM6.48649 6.66667C6.81487 6.66667 7.08626 6.91747 7.12921 7.24287L7.13514 7.33333V13.5556C7.13514 13.9237 6.84473 14.2222 6.48649 14.2222C6.1581 14.2222 5.88671 13.9714 5.84376 13.646L5.83784 13.5556V7.33333C5.83784 6.96514 6.12825 6.66667 6.48649 6.66667ZM8 1.33333C7.2059 1.33333 6.55464 1.96188 6.4915 2.76131L6.48649 2.88889H9.51351C9.51351 2.02978 8.83589 1.33333 8 1.33333Z" fill="#757575"/>',
                            '</svg>',
                        '</button>',
                    '</div>',
                    '<div class="col-md-8 filter-chip-column">',
                        filter_chip_html,
                    '</div>',
                    '<div class="col-md-2 filter-hide-on-mobile">',
                        '<button type="button" class="btn remove-filter-row-btn" onclick="remove_selected_filter_parameter(this)">',
                            '<svg width="16" height="18" viewBox="0 0 16 18" fill="none" xmlns="http://www.w3.org/2000/svg">',
                                '<path d="M8 0C9.49884 0 10.7237 1.20574 10.8064 2.72496L10.8108 2.88889H15.3514C15.7096 2.88889 16 3.18737 16 3.55556C16 3.89306 15.756 4.17199 15.4394 4.21614L15.3514 4.22222H14.6629L13.5558 15.7948C13.441 16.994 12.4959 17.92 11.3406 17.9951L11.1888 18H4.81118C3.63878 18 2.64965 17.124 2.46385 15.9497L2.44423 15.7948L1.33622 4.22222H0.648649C0.320263 4.22222 0.0488727 3.97142 0.00592144 3.64602L0 3.55556C0 3.21805 0.244025 2.93912 0.560631 2.89497L0.648649 2.88889H5.18919C5.18919 1.2934 6.44763 0 8 0ZM13.3596 4.22222H2.63957L3.73529 15.6643C3.7861 16.1952 4.19488 16.6083 4.70127 16.661L4.81118 16.6667H11.1888C11.7078 16.6667 12.1478 16.289 12.2484 15.7762L12.2647 15.6643L13.3596 4.22222ZM9.51351 6.66667C9.8419 6.66667 10.1133 6.91747 10.1562 7.24287L10.1622 7.33333V13.5556C10.1622 13.9237 9.87175 14.2222 9.51351 14.2222C9.18513 14.2222 8.91374 13.9714 8.87079 13.646L8.86487 13.5556V7.33333C8.86487 6.96514 9.15528 6.66667 9.51351 6.66667ZM6.48649 6.66667C6.81487 6.66667 7.08626 6.91747 7.12921 7.24287L7.13514 7.33333V13.5556C7.13514 13.9237 6.84473 14.2222 6.48649 14.2222C6.1581 14.2222 5.88671 13.9714 5.84376 13.646L5.83784 13.5556V7.33333C5.83784 6.96514 6.12825 6.66667 6.48649 6.66667ZM8 1.33333C7.2059 1.33333 6.55464 1.96188 6.4915 2.76131L6.48649 2.88889H9.51351C9.51351 2.02978 8.83589 1.33333 8 1.33333Z" fill="#EE2525"/>',
                            '</svg>',
                        '</button>',
                    '</div>',
                '</div>',
            '</div>',
        ].join('');

        document.getElementById("tbody-filter-parameters").innerHTML += html_filter;
        document.getElementById("apply_filter_confirm").removeAttribute("disabled");
        document.getElementById("reset_filter").removeAttribute("disabled");
        document.getElementById("reset_filter").style.display = "block";
        scrollToBottom();
    }
}


function remove_selected_filter_parameter(element){
    remove_element = $(element).closest('.filter-parameter-column')[0];
    var filter_element = $(remove_element).attr("filter-key");
    applied_filter_key_value_map[filter_element] = null;

    remove_element.parentElement.removeChild(remove_element);
    if(document.getElementsByClassName("tr-filter-parameters").length <= 0){
        document.getElementById("apply_filter_confirm").setAttribute("disabled", "disabled");
        if(!is_filter_applied) {
            document.getElementById("reset_filter").setAttribute("disabled", "disabled");
        }
    }
}

function apply_support_history_filter(element) {
    selected_filter_parameters = document.getElementsByClassName("filter-parameter-column");
    var key_value = '';
    
    for(var idx = 0; idx < selected_filter_parameters.length; idx ++) {
	    var filter_key = selected_filter_parameters[idx].getAttribute('filter-key');
	    var filter_data = selected_filter_parameters[idx].getAttribute('filter-data');

	    filter_data = JSON.parse(filter_data);

	    for(var index = 0; index < filter_data.length; index ++) {
	    	key_value += filter_key + "=" + filter_data[index] + "&";
	    }
    }

    window.location = window.location.protocol + "//" + window.location.host + window.location.pathname + "?" + key_value;
}

function reset_support_history_filter() {
    document.getElementById("tbody-filter-parameters").innerHTML = "";
    document.getElementById("reset_filter").setAttribute("disabled", "disabled");
    document.getElementById("apply_filter_confirm").setAttribute("disabled", "disabled");
    
    custom_title_filter_dropdown.update_value("None");
    $("#selected-agent-filter").val("").multiselect('refresh');
    if(document.querySelector("#selected-supervisor-filter")){
        $("#selected-supervisor-filter").val("").multiselect('refresh');
    }
    
    custom_filter_option_dropdown.update_value("None");
    custom_lead_type_filter_dropdown.update_value("all");
    custom_session_filter_dropdown.update_value("all");

    $('#filter-start-date').val("").datepicker("update");
    $('#filter-end-date').val("").datepicker("update");
    
    initialize_custom_filter_map();
}


function show_client_location_details(client_name, longitude, latitude) {
    let promises = getCurrentLocation(latitude, longitude);

    Promise.all([promises])
    .then(function(results) {
        var html = "";
        if(results.length) {
            for(var idx = 0; idx < results.length; idx ++) {
                html += "<tr>";
                html += "<td>" + client_name + "</td>";
                html += "<td>" + results[idx] + "</td>";
                html += "</tr>";
            }
        } else {
            html += "<tr>";
            html += "<td>" + client_name + "</td>";
            html += "<td>Location not shared</td>";
            html += "</tr>";
        }
        html = "<table class=\"table table-bordered\" width=\"100%\" cellspacing=\"0\">\
                <thead>\
                    <tr>\
                       <th>Name</th>\
                        <th>Location</th>\
                    </tr>\
                </thead>\
                <tbody>" + html + "</tbody>\
             </table>";
        $('#client-location-details .table-responsive').html(html);
        update_table_attribute();
        $('#client-location-details').modal('show');
    });
}

function getCurrentLocation(latitude, longitude) {
    if(latitude == "None" || longitude == "None") {
        return new Promise(function(resolve, reject) {
            resolve("Location not shared");
        });
    }
    var geocoder = new google.maps.Geocoder();
    var latlng = new google.maps.LatLng(latitude, longitude);
    return new Promise(function(resolve, reject) {
        geocoder.geocode({'latLng': latlng}, function(results, status) {
            if(status == google.maps.GeocoderStatus.OK) {
                if(results[2]) {
                    var address = results[2].formatted_address;
                    resolve(address);
                } else {
                    resolve("Location not shared");
                }
            } else {
                resolve("Location not shared");
            }
        });
    });
}

function check_select_date_range(element){
    general_error_message = document.getElementById("general-error-message");
    general_error_message.innerHTML = "";

    if(element.value == "0") {
        general_error_message.innerHTML = "Please select valid date range filter";
    } else {
        general_error_message.innerHTML = "";
    }

    if(element.value=="4"){
        document.getElementById("from-date-div").style.display="block";
        document.getElementById("to-date-div").style.display="block";
        document.getElementById("email-id-div").style.display="block";
    }else{
        document.getElementById("from-date-div").style.display="none";
        document.getElementById("to-date-div").style.display="none";
        document.getElementById("email-id-div").style.display="none";
    }
}


function load_map_script() {

    var params = JSON.stringify({});

    var xhttp = new XMLHttpRequest();
    xhttp.open("POST", "/easy-assist/map-script/", true);
    xhttp.setRequestHeader('Content-Type', 'application/json');
    xhttp.setRequestHeader('X-CSRFToken', get_csrfmiddlewaretoken());
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
            response = JSON.parse(this.responseText);
            response = easyassist_custom_decrypt(response.Response);
            response = JSON.parse(response);
            if (response["status"] == 200) {
                var src = response['src'];
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script.defer = true;
                script.src = src
                document.body.appendChild(script);          
            }
        }
    }
    xhttp.send(params);
}

$(document).ready(function() {
    initialize_custom_filter_map();
    initialize_custom_dropdown();
    initialize_custom_tabs();
    load_map_script();
    update_applied_filter();

    {% if cobrowse_io_objs|length %}
        let support_table = $("#support-history-table").DataTable({
        "ordering": false,
        "bPaginate": false,
        "bInfo": false,
        });
    {% else %}
        $("#support-history-table").DataTable({
        "ordering": false,
        "bPaginate": false,
        "bInfo": false,
        "searching": false,
        });
    {% endif %}

    $("#custom-agent-table-search").keyup(function() {
            support_table.search($(this).val()).draw() ;
        })

    $('#selected-agent-filter').multiselect({
        nonSelectedText: 'Select Agent',
        enableFiltering: true,
        enableCaseInsensitiveFiltering: true,
        includeSelectAllOption: true
    });
    $("#selected-agent-filter").next().hide();
    if(document.querySelector("#selected-supervisor-filter")){
        $('#selected-supervisor-filter').multiselect({
            nonSelectedText: 'Select Supervisor',
            enableFiltering: true,
            enableCaseInsensitiveFiltering: true,
            includeSelectAllOption: true
        });
        $("#selected-supervisor-filter").next().hide();
    }
    $("#auto_assign_audit_trail").on('hide.bs.modal', function(){
        $("#auto_assign_audit_trail .modal-body").scrollTop(0);
    });
});

function initialize_custom_dropdown() {
    var console_theme_color = getComputedStyle(document.body).getPropertyValue('--color_rgb');
    $("#selected-agent-filter")[0].selectedIndex = -1;
    if(document.querySelector("#selected-supervisor-filter")){
        $("#selected-supervisor-filter")[0].selectedIndex = -1;
    }
    $("#selected-title-filter")[0].selectedIndex = -1;

    custom_filter_option_dropdown = new EasyassistCustomSelect("#selected-filter-parameter", "Select One", console_theme_color);
    custom_session_filter_dropdown = new EasyassistCustomSelect("#selected-status-filter", "Select One", console_theme_color);
    custom_title_filter_dropdown = new EasyassistCustomSelectMultiple("#selected-title-filter", "Select Title", console_theme_color);
    custom_lead_type_filter_dropdown = new EasyassistCustomSelect("#selected-lead-type-filter", "Select One", console_theme_color);
}

function initialize_custom_filter_map() {
    applied_filter_key_value_map = {
        'title': null,
        'agent': null,
        'startdate': null,
        'enddate': null,
        'status': null,
        'lead-type': null,
    }
}

function show_customer_comment_for_session(session_id) {
    $('#cobrowsing_customer_comments-' + session_id).show();
}
</script>
{% endblock %}
