(function ($) {
    $(function () {
        $('.sidenav').sidenav();
        $('.dropdown-trigger').dropdown();
        $('.tooltipped').tooltip();
        $('.collapsible').collapsible();
        $('.modal').modal();
        $('.tooltipped').tooltip({
            position: "top"
        });
        $('.tabs').tabs();
        $('select:not([data-select="false"])').select2({
            width: "100%"
        });
        $('#select-sticky-intent-list').select2({
            placeholder: "Select from dropdown",
            allowClear: true,
            width: "100%",
            dropdownParent: $("#modal-select-sticky-intent"),
        })

        $('#filter-stop-words').select2({
            width: "100%",
            dropdownParent: $("#modal-configure-stop-words"),
        })

        $("#multiple-select-intent-choice-list, \
         #multiple-select-initial-message-list, #multiple-select-failure-message-list,\
         #multiple-select-google-initial-message-list, #multiple-select-google-failure-message-list,\
         #multiple-select-alexa-initial-message-list, #multiple-select-alexa-failure-message-list,\
         #multiple-select-whatsapp-initial-message-list, #multiple-select-whatsapp-failure-message-list,\
         #multiple-select-facebook-initial-message-list, #multiple-select-facebook-failure-message-list,#multiple-select-sticky-intent-list,#multiple-select-child-choices,#multiple-select-tree-child-choices").select2({
            width: "40%",

        });


        $("#multiple-select-intent-choice-list, \
         #multiple-select-initial-message-list, #multiple-select-failure-message-list,\
         #multiple-select-google-initial-message-list, #multiple-select-google-failure-message-list,\
         #multiple-select-alexa-initial-message-list, #multiple-select-alexa-failure-message-list,\
         #multiple-select-whatsapp-initial-message-list, #multiple-select-whatsapp-failure-message-list,\
         #multiple-select-facebook-initial-message-list, #multiple-select-facebook-failure-message-list,#multiple-select-sticky-intent-list,#multiple-select-child-choices,#multiple-select-tree-child-choices,#bot-popup-multiple-select-message-list").on("select2:select", function (evt) {
            var element = evt.params.data.element;
            var $element = $(element);

            $element.detach();
            $(this).append($element);
            $(this).trigger("change");
        });

        $('.easychat-theme-slider').slider({
            interval: 1000000000
        });
        // $('.easychat-theme-slider').slider('pause');

        // $("#multiple-select-initial-message-list").on("select2:select", function(evt) {
        //     var element = evt.params.data.element;
        //     var $element = $(element);

        //     $element.detach();
        //     $(this).append($element);
        //     $(this).trigger("change");
        // });
        // $("#multiple-select-failure-message-list").on("select2:select", function(evt) {
        //     var element = evt.params.data.element;
        //     var $element = $(element);

        //     $element.detach();
        //     $(this).append($element);
        //     $(this).trigger("change");
        // });

        $(document).on("keyup", '.show-char-count', function (e) {
            set_character_count(e.target);
        });

        $(document).on("keyup", '#new_bot_name', function (e) {
            set_character_count(e.target);
        });

        setTimeout(() => {
            try {
                if (NEED_TO_BUILD == 'True') {
                    document.getElementById('easychat-build-bot-toast-div').style.display = 'flex';
                    document.getElementById("easychat-content-wrapper").style.maxHeight = '85vh';

                    var side_nav = document.getElementById('main-console-sidenav');
                    if (side_nav) {
                        side_nav.style.marginTop = '6.5%';
                    }
                }
            } catch (err) {
                console.log(err);
            }
        }, 1000);

    }); // end of document ready
})(jQuery); // end of jQuery name space

window.addEventListener('load', (event) => {
    if (navigator.userAgent.indexOf("OP/") > -1 || navigator.userAgent.indexOf("UCBrowser/") > -1 || navigator.userAgent.indexOf("MSIE") > -1 || navigator.userAgent.indexOf("Trident/") > -1) {
        alert("Please switch to Google Chrome for better experience. If you are using Chrome make sure it is updated with the latest version. Thank you!")
        window.location = "/"
    }
});

var SESSION_TIME = 600000; // 10 minutes
var session_timer = "";
var training_data_count = 0;
var faq_response_sentence_count = 0;
var tree_response_sentence_count = 0;
var intent_response_sentence_count = 0;
var intent_image_url_count = 0;
var global_select_tree_id = -1;
var global_select_intent_id = -1;
var global_select_faq_id = -1;
var global_select_parent_id = -1;
var global_select_tree_name = "";
var selected_bot_id_modify_intent = 0;
var last_selected_bot_for_self_learning = null;
var autosave_session_timer = null;
var user_last_activity_time_obj = new Date()
var api_url_count = 0;
var intent_data = "";
var bot_response_data = "";
var default_order_of_response = [];
var table_res = ''
var welcome_banner_edit_element;
var automated_test_progress, automated_testing_started;
var DATA_MASK_TOGGLE_API = '/chat/bot/data-mask-toggle/'
var CHECK_DATA_TOGGLE_OTP_API = '/chat/bot/check-data-toggle-otp/'
var check_theme_change = false
var check_font_change = false
var bot_theme_color = "2D4CB8"
//hamburger initializers
var current_hamburger_type = "Link"
var current_hamburger_editable_id
var current_editable_index
//Quick Menu Initializers
var current_quick_type = "Link"
var current_quick_editable_id
var current_quick_editable_index
var current_quick_img_src
var current_quick_img_src_edit
var intents_deleted_count;
var character_limit_small_text = 100;
var character_limit_large_text = 500;
var resend_otp_time_limit = 30000; // timelimit for resend otp in miliseconds
var resend_verification_otp_time_limit = 60000; // timelimit for resend otp in miliseconds
var system_commands = window.SYSTEM_COMMANDS ? window.SYSTEM_COMMANDS : ['subprocess.call', 'subprocess.check_output', 'import threading', 'threading.Thread', 'ssh'];
var highlighted_lines = {};
var processor_errors = {};
var tms_cat_limit = 25;
var already_key_pressed = 0;
var unique_word_mappers_list = [];
var check_word_mappers_list = false;
var remove_element_from_list = true;
var selected_widget = ""
var selected_language = "en";
var is_flow_termination_bot_response_required = false;
var channel_selected = "";
var prev_theme_selected = "";
var current_data_model_encrypted_values = [];
var build_bot_timer = null;
var verify_otp_token = ""
var login_username = ""
var LIST_OF_PHONETIC_TYPING_SUPPORTED_LANGUAGES = [
    "urdu-ur",
    "amharic-am",
    "arabic-ar",
    "bengali-bn",
    "chinese-zh",
    "greek-el",
    "gujarati-gu",
    "hindi-hi",
    "kannada-kn",
    "malayalam-ml",
    "marathi-mr",
    "nepali-ne",
    "oriya-or",
    "persian-fa",
    "punjabi-pa",
    "russian-ru",
    "sanskrit-sa",
    "sinhalese-si",
    "serbian-sr",
    "tamil-ta",
    "telugu-te",
    "tigrinya-ti",
]
var api_integrated_fields = []
const state = {
    form: {},
    option_map: {},
}
function un_entity(str) {
    return $("<textarea></textarea>").html(str).text();
}

function set_selected_language_based_on_url_param() {
    var url_parameters = get_url_vars()
    if (url_parameters["selected_language"] != undefined || url_parameters["selected_language"] != null) {

        selected_language = url_parameters["selected_language"]
    }
}


function get_url_vars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
        vars[key] = value;
    });
    return vars;
}

if (window.location.href.indexOf("/chat/intent/") != -1) {
    renderBasicIntentInformation();
}

if (window.location.href.indexOf("/chat/easychat-api-analytics/") != -1) {

    $(document).ready(function () {
        $('#api-analytics-table').DataTable({
            "bPaginate": false,
            "ordering": false
        });
    });
    $('#select-api-name').select2({
        dropdownParent: $('#apply-filter-api-analytics'),
    });
    try {
        value = document.getElementById("modal-api-analytics").value;
        if (value == "custom_timestamp") {
            timestamp_date = document.getElementById("modal-api-analytics-custom-timestamp-date").value;
            document.getElementById("modal-api-analytics-custom-timestamp-date").style.display = "block";
            document.getElementById("modal-api-analytics-custom-timestamp-time").style.display = "block";
        }
    } catch { }
}

$(document).ready(function () {
    initialize_bot_response_in_edit_intent()
    initialize_bot_response_in_edit_tree()
});



if (window.location.href.indexOf("/chat/easychat-api-statistics/") != -1) {

    $(document).ready(function () {
        $('#api-statistics-table').DataTable({
            "bPaginate": false,
            "ordering": false
        });
    });
    $('#select-api-name-statistics').select2({
        dropdownParent: $('#apply-filter-api-statistics'),
    });
}

if (window.location.href.indexOf("/chat/login/") != -1) {
    set_cookie("is_online", "0", "/");
} else {
    set_cookie("is_online", "1", "/");
}

function show_modification_logs_modal(pk) {

    $("#audit-details-" + pk).show();
}

function hide_modification_logs_modal(pk) {

    $("#audit-details-" + pk).hide();
}

function show_api_request_modal(bot_pk) {

    $("#API-Request-" + bot_pk).show();
}

function show_api_response_modal(bot_pk) {

    $("#API-Response-" + bot_pk).show();
}

function hide_api_request_modal(bot_pk) {

    $("#API-Request-" + bot_pk).hide();
}

function hide_api_response_modal(bot_pk) {

    $("#API-Response-" + bot_pk).hide();
}

document.body.addEventListener('keypress', function (e) {
    if ((e.target.id == "username") || (e.target.id == "password") || (e.target.id == "captcha")) {
        if (e.keyCode == 13) {
            document.getElementById("#login_btn") !== null ? $("#login_btn").click(): $("#verify_btn").click();; 
        }
    }
    if ((e.target.id == "reset-password-username")) {
        if (e.keyCode == 13) {
            $("#reset-password-check-user").click();
        }
    }
    if (event.target.classList.contains('forgot-pass-otp-input')) {
        if (e.keyCode == 13) {
            $(".verify-code-btn")[0].click();
        }
    }
    if ((e.target.id == "new-password") || (e.target.id == "retype-password")) {
        if (e.keyCode == 13) {
            $("#save-password").click();
        }
    }
});

if (window.location.pathname == "/chat/create-intent/") {
    loadIntentEditForm();
    loadTemplateSentences();
    $("input[id=intent_name]").focus();
    $('.collapsible').collapsible();
}

function is_it_redirection_url(url) {
    var file_ext_list = ['txt', 'pdf', 'ai', 'bmp', 'gif', 'ico', 'jpeg', 'jpg', 'png', 'PNG', 'ps', 'psd', 'svg', 'tif', 'tiff', 'php', 'py']
    file_ext = url.split('.').pop()
    if (file_ext in file_ext_list) {
        return false
    } else {
        return true
    }
}

var intent_card_list = [];

function store_this_data_locally(image_url) {

    if (image_url == "") {

        return image_url;
    }
    var parser = document.createElement('a');
    parser.href = image_url;
    if (parser.host == window.location.host) {

        return image_url;
    }

    if (is_it_redirection_url(image_url)) {

        return image_url
    }

    var json_string = JSON.stringify({
        image_url: image_url,
    })
    json_string = EncryptVariable(json_string);
    json_string = encodeURIComponent(json_string);

    var xhttp = new XMLHttpRequest();
    var params = 'json_string=' + json_string
    xhttp.open("POST", "/chat/save-image-locally/", false);
    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            response = JSON.parse(this.responseText);
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {

                image_url = window.location.origin + response["src"];
                console.log(image_url)
            } else {

                console.log(response["message"])
            }
        }
    }
    xhttp.send(params);
    return image_url;
}

function initialize_bot_response_in_edit_intent() {
    if ($('.response-text-area').length) {
        $(".response-text-area").trumbowyg({
            tagsToKeep: [],
            allowTagsFromPaste: {
                allowedTags: ['h4', 'p', 'br']
            },
            minimalLinks: true,
            btns: [
                // ['viewHTML'],
                ['strong', 'em'],
                ['link'],
                ['unorderedList', 'orderedList'],
                ['underline'],
                ['emoji'],
            ],
        }).on('tbwinit', function () {
            myResponseInitInstance()
        });
    }

    if ($('.response-text-area-speech').length) {
        $(".response-text-area-speech").trumbowyg({
            btns: false
        }).on('tbwinit', function () {
            mySpeechResponseInitInstance()
        });
    }

}

function initialize_bot_response_in_edit_tree() {
    if ($('.response-tree-text-area').length) {
        $(".response-tree-text-area").trumbowyg({
            tagsToKeep: [],
            allowTagsFromPaste: {
                allowedTags: ['h4', 'p', 'br']
            },
            minimalLinks: true,
            btns: [
                // ['viewHTML'],
                ['strong', 'em'],
                ['link'],
                ['unorderedList', 'orderedList'],
                ['underline'],
                ['emoji'],
            ],
        }).on('tbwinit', function () {
            myResponseInitInstance()
        });
    }

    if ($('.response-tree-text-area').length) {
        $(".response-tree-text-area-speech").trumbowyg({
            btns: false
        }).on('tbwinit', function () {
            mySpeechResponseInitInstance()
        });
    }

}


if (window.location.pathname.indexOf("/chat/edit-intent/") != -1) {

    $(document).ready(function () {
        create_language_custom_dropdowns_for_intent()
    });
    open_close_language_dropdown_event()
    select_option_for_form_widgets()
    add_language_dropdown_search_event()
    language_dropdown_close_onclicking_outside_event()
    add_language_selction_event_for_edit_intent()
    $(document).on("click", "#ignore-bot-response-changes-in-non-primary-language", function (e) {
        ignore_bot_response_changes_in_non_primary_languages();
    });
    $(document).on("click", "#auto-fix-bot-response-changes-in-non-primary-language", function (e) {
        auto_fix_bot_response_changes_in_non_primary_languages();
    });

}

if (window.location.pathname.indexOf("/chat/edit-tree/") != -1) {

    open_close_language_dropdown_event()
    select_option_for_form_widgets()
    add_language_dropdown_search_event()
    language_dropdown_close_onclicking_outside_event()
    add_language_selction_event_for_edit_intent()
    $(document).on("click", "#ignore-bot-response-changes-in-non-primary-language", function (e) {
        ignore_bot_response_changes_in_non_primary_languages();
    });
    $(document).on("click", "#auto-fix-bot-response-changes-in-non-primary-language", function (e) {
        auto_fix_bot_response_changes_in_non_primary_languages();
    });

}

if (window.location.pathname.indexOf("/chat/intent/") != -1) {
    easychat_bot_id = get_url_vars()["bot_pk"]
    // set_cookie("easychat_bot_id", easychat_bot_id)
    document.cookie = "easychat_bot_id" + "=" + easychat_bot_id + ";path=/chat/edit-intent/";
}

function isValidURL(url_str) {
    return /^(?:(?:(?:https?|ftp):)?\/\/)(?:(?:[^\]\[?\/<~#`!@$^&*()+=}|:";',>{ ]|%[0-9A-Fa-f]{2})+(?::(?:[^\]\[?\/<~#`!@$^&*()+=}|:";',>{ ]|%[0-9A-Fa-f]{2})*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z0-9\u00a1-\uffff][a-z0-9\u00a1-\uffff_-]{0,62})?[a-z0-9\u00a1-\uffff]\.)+(?:[a-z\u00a1-\uffff]{2,}\.?)|(?:(?:[a-z0-9\u00a1-\uffff][a-z0-9\u00a1-\uffff_-]{0,62})?[a-z0-9\u00a1-\uffff])|(?:(?:[a-z0-9\u00a1-\uffff][a-z0-9\u00a1-\uffff_-]{0,62}\.)))(?::\d{2,5})?(?:[/?#]\S*)?$/i.test(url_str);
}

function get_easychat_access_token() {
    return document.querySelector("input[name=\"easychataccesstoken\"]").value;
}

function set_cookie(cookiename, cookievalue, path = "") {
    if (path == "") {
        document.cookie = cookiename + "=" + cookievalue;
    } else {
        document.cookie = cookiename + "=" + cookievalue + ";path=" + path;
    }
}

function get_cookie(cookiename) {
    var cookie_name = cookiename + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var cookie_array = decodedCookie.split(';');
    for (var i = 0; i < cookie_array.length; i++) {
        var c = cookie_array[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(cookie_name) == 0) {
            return c.substring(cookie_name.length, c.length);
        }
    }
    return "";
}

function get_csrf_token() {
    return $('input[name="csrfmiddlewaretoken"]').val();
}


/////////////////////////////// Encryption And Decription //////////////////////////

function CustomEncrypt(msgString, key) {
    // msgString is expected to be Utf8 encoded
    var iv = EasyChatCryptoJS.lib.WordArray.random(16);
    var encrypted = EasyChatCryptoJS.AES.encrypt(msgString, EasyChatCryptoJS.enc.Utf8.parse(key), {
        iv: iv
    });
    var return_value = key;
    return_value += "." + encrypted.toString();
    return_value += "." + EasyChatCryptoJS.enc.Base64.stringify(iv);
    return return_value;
}

function generateRandomString(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
}


function EncryptVariable(data) {

    utf_data = EasyChatCryptoJS.enc.Utf8.parse(data);
    encoded_data = utf_data;
    // encoded_data = EasyChatCryptoJS.enc.Base64.stringify(utf_data);
    random_key = generateRandomString(16);
    // console.log(random_key)
    encrypted_data = CustomEncrypt(encoded_data, random_key);

    return encrypted_data;
}


function custom_decrypt(msg_string) {

    var payload = msg_string.split(".");
    var key = payload[0];
    var decrypted_data = payload[1];
    var decrypted = EasyChatCryptoJS.AES.decrypt(decrypted_data, EasyChatCryptoJS.enc.Utf8.parse(key), {
        iv: EasyChatCryptoJS.enc.Base64.parse(payload[2])
    });
    return decrypted.toString(EasyChatCryptoJS.enc.Utf8);
}

////////////////////////////////////////////////////////////////////////////////////

// Custom user session

/*
    get_delayed_date_object
    delay current date by delay_period
    var date_obj = new Date();                                      -> current date
    date_obj.setMinutes( date_obj.getMinutes() + delay_period );    -> delay by delay_period
*/

function get_delayed_date_object(delay_period) {
    var date_obj = new Date();
    date_obj.setMinutes(date_obj.getMinutes() + delay_period);
    return date_obj
}

/*
    send_session_timeout_request
    is_online_from_this_time                -> delayed by 3 minuits date object
    user_last_activity_time_obj -> user's last activity time
    if(user_last_activity_time_obj > is_online_from_this_time) -> is user active from last 3 minutes
*/

function send_session_timeout_request() {

    if (get_cookie("is_online") == "0") {
        return;
    }

    var is_online_from_this_time = get_delayed_date_object(-3);

    if (user_last_activity_time_obj > is_online_from_this_time) {
        var csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
        $.ajax({
            url: "/chat/set-session-time-limit/",
            type: "POST",
            headers: {
                'X-CSRFToken': csrf_token
            },
            data: {},
            success: function (response) {
                set_cookie("is_online", "1", "/");
            },
            error: function (xhr, textstatus, errorthrown) {
                set_cookie("is_online", "0", "/");
            }
        });
    }
}

function resetTimer(e) {
    var delay_by_nine_minutes = get_delayed_date_object(-18);
    if (user_last_activity_time_obj < delay_by_nine_minutes) { // if user is active in last minute ( after inactive for 9 minuits )
        user_last_activity_time_obj = new Date()
        send_session_timeout_request();
    }
    user_last_activity_time_obj = new Date()
}

window.onload = function () {

    try {
        load_easychat_bot();
    } catch { }
    resetTimer();
    window.onmousemove = resetTimer;
    window.onmousedown = resetTimer;
    window.onclick = resetTimer;
    window.onkeypress = resetTimer;
    window.addEventListener('scroll', resetTimer, true);

    document.addEventListener("visibilitychange", function () {
        if (document.hidden == false) {
            resetTimer();
        }
    }, false);

    setInterval(send_session_timeout_request, 3 * 60 * 1000);
    send_session_timeout_request();
}


function loadIntentEditForm() {

    $(document).ready(function () {
        $('.modal').modal();
    });

    $(document).ready(function () {
        //$('select').formSelect();
        $('select').select2({
            width: "100%"
        });

        $(".create-form-select-field").select2({
            width: "95%",
            placeholder: "Select from drop down",
            allowClear: true,
            dropdownParent: $("#modal-create-form"),
        })

        $(".file-type-select-field").select2({
            width: "95%",
            placeholder: "Select file type",
            allowClear: true,
            dropdownParent: $("#modal-create-form"),
        })
    });

    $(document).on("click", "#edit-intent-card", function (e) {

        intent_card_list.push({
            title: intent_card_title,
            content: intent_card_content,
            link: intent_card_link,
            img_url: intent_card_img_url
        });

        addIntentResponseCardIntoCollection(intent_card_title, intent_card_content, intent_card_link, intent_card_img_url)
    });


    $(document).on("click", "#add-intent-card", function (e) {

        intent_card_title = $("#intent_card_title").val().trim();
        intent_card_content = $("#intent_card_content").val().trim();
        intent_card_link = $("#intent_card_link").val().trim();
        intent_card_img_url = $("#intent_card_img_url").val().trim();

        var format = /[`#%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;

        if (format.test(intent_card_title.trim())) {

            M.toast({
                "html": "Please provide valid intent card title"
            });
            return;
        }

        intent_card_title = stripHTML(intent_card_title.trim())
        intent_card_title = strip_unwanted_characters(intent_card_title)

        intent_card_content = stripHTML(intent_card_content.trim())
        intent_card_content = strip_unwanted_security_characters(intent_card_content)

        if (intent_card_title == "") {
            M.toast({
                "html": "Please provide valid intent card title."
            });
            return;
        }

        if (intent_card_content.trim() == "") {
            M.toast({
                "html": "Please provide valid intent card content."
            });
            return;
        }

        if (intent_card_link.trim() == "" || intent_card_img_url.trim() == "") {
            M.toast({
                "html": "Card Image or Card Link is empty."
            });
            return;
        }

        if (isValidURL(intent_card_link) == false) {
            M.toast({
                "html": "Please provide valid redirect card url"
            });
            return;
        }

        if (isValidURL(intent_card_img_url) == false) {
            M.toast({
                "html": "Please provide valid image card url"
            });
            return;
        }

        if (global_last_edit_card_id != null) {
            if (!adding_new_card) {
                e.preventDefault();
                element = "#" + global_last_edit_card_id;
                $(element).remove();
            }
            global_last_edit_card_id = null;
        }

        intent_card_list.push({
            title: intent_card_title,
            content: intent_card_content,
            link: intent_card_link,
            img_url: intent_card_img_url
        });

        addIntentResponseCardIntoCollection(intent_card_title, intent_card_content, intent_card_link, intent_card_img_url)
    });

    var upload_file_limit_size = 5120000
    $(document).on("click", "#upload-intent-image", function (e) {
        e.preventDefault();
        var input_upload_image = ($("#input_upload_image_intent"))[0].files[0]

        if (input_upload_image == null || input_upload_image == undefined) {
            M.toast({
                "html": "Please choose a file."
            }, 2000);

            setTimeout(function () {
                $('#modal-upload-image').modal('open');
            }, 200);
            return;
        }
        if (input_upload_image.name.match(/\.(jpeg|jpg|gif|png)$/) == null) {
            M.toast({
                "html": "File format is not supported"
            }, 2000);
            setTimeout(function () {
                $('#modal-upload-image').modal('open');
            }, 200);
            return false;
        }

        if (input_upload_image.size > upload_file_limit_size) {
            M.toast({
                "html": "Size limit exceed(should be less than 5 MB)."
            }, 2000);

            setTimeout(function () {
                $('#modal-upload-image').modal('open');
            }, 200);
            return;
        }

        if (check_malicious_file(input_upload_image.name) == true) {
            setTimeout(function () {
                $('#modal-upload-image').modal('open');
            }, 200);
            return false;
        }

        var reader = new FileReader();
        reader.readAsDataURL(input_upload_image);
        reader.onload = function () {

            base64_str = reader.result.split(",")[1];

            uploaded_file = [];
            uploaded_file.push({
                "filename": input_upload_image.name,
                "base64_file": base64_str,
            });

            upload_intent_image();
        };

        reader.onerror = function (error) {
            console.log('Error: ', error);
        };
    });

    async function upload_intent_image() {
        var response = await upload_image();

        if (response && response.status == 200) {
            src = window.location.origin + response["src"]
            addIntentResponseImageIntoCollection(src);
            document.getElementById('input_upload_image_intent2').value = "";
        }
    }

    $(document).on("click", "#upload-intent-file-card", function (e) {
        e.preventDefault();
        var input_upload_file = ($("#input_upload_file_intent_card"))[0].files[0]

        if (input_upload_file == null || input_upload_file == undefined) {
            M.toast({
                "html": "Please choose a file."
            }, 2000);

            setTimeout(function () {
                $("#modal-intent-card").modal("open")
            }, 200);
            return false;
        }

        if (check_malicious_file(input_upload_file.name) == true) {
            setTimeout(function () {
                $("#modal-intent-card").modal("open")
            }, 200);
            return false;
        }

        var reader = new FileReader();
        reader.readAsDataURL(input_upload_file);
        reader.onload = function () {

            base64_str = reader.result.split(",")[1];

            uploaded_file = [];
            uploaded_file.push({
                "filename": input_upload_file.name,
                "base64_file": base64_str,
            });

            upload_intent_file_card();
        };

        reader.onerror = function (error) {
            console.log('Error: ', error);
        };

    });

    async function upload_intent_file_card() {
        let response = await upload_file_card();

        if (response && response.status == 200) {
            src = window.location.origin + response["src"];
            $("#intent_card_link").val(src);
            document.getElementById('input_upload_file_intent_card2').value = "";
            M.toast({
                "html": "File Uploaded Successfully."
            }, 2000);
        }

        $("#modal-intent-card").modal("open");
    }

    $(document).on("click", "#upload-intent-image-card", function (e) {
        e.preventDefault();
        var input_upload_image = ($("#input_upload_image_intent_card"))[0].files[0]

        if (input_upload_image == null || input_upload_image == undefined) {
            M.toast({
                "html": "Please choose a file."
            }, 2000);

            setTimeout(function () {
                $("#modal-intent-card").modal("open");
            }, 200);
            return false;
        }
        if (input_upload_image.name.match(/\.(jpeg|jpg|gif|png)$/) == null) {
            M.toast({
                "html": "File format is not supported"
            }, 2000);
            setTimeout(function () {
                $('#modal-upload-card').modal('open');
            }, 200);
            return false;
        }

        if (check_malicious_file(input_upload_image.name) == true) {
            setTimeout(function () {
                $("#modal-intent-card").modal("open");
            }, 200);
            return false;
        }

        var reader = new FileReader();
        reader.readAsDataURL(input_upload_image);
        reader.onload = function () {

            base64_str = reader.result.split(",")[1];

            uploaded_file = [];
            uploaded_file.push({
                "filename": input_upload_image.name,
                "base64_file": base64_str,
            });

            upload_intent_image_card();
        };

        reader.onerror = function (error) {
            console.log('Error: ', error);
        };

    });

    async function upload_intent_image_card() {
        var response = await upload_image();

        if (response && response.status == 200) {
            src = window.location.origin + response["src"];
            $("#intent_card_img_url").val(src);
            document.getElementById('input_upload_image_intent_card2').value = "";
            M.toast({
                "html": "Image Uploaded Successfully."
            }, 2000);
        }

        $("#modal-intent-card").modal("open");
    }

    // detect enter keypress
    $("#add_enter_intent_training_data").keypress(function (e) {
        var keycode = (e.keyCode ? e.keyCode : e.which);
        if (keycode == '13') {
            value = $("#add_enter_intent_training_data").val();
            addIntentTrainingDataIntoCollection(value);
            $("#add_enter_intent_training_data").val("");
        }
    });

    // detect enter keypress
    $("#add_enter_intent_image_url_data").keypress(function (e) {
        var keycode = (e.keyCode ? e.keyCode : e.which);
        if (keycode == '13') {
            value = $("#add_enter_intent_image_url_data").val();
            if (!isExternal(value)) {
                showToast("Only external urls allowed.", 2000);
                return;
            }
            addIntentResponseImageIntoCollection(value);
            $("#add_enter_intent_image_url_data").val("");
        }
    });

    $("#add_enter_intent_video_url_data").keypress(function (e) {
        var keycode = (e.keyCode ? e.keyCode : e.which);
        if (keycode == '13') {
            value = $("#add_enter_intent_video_url_data").val();
            if (!isExternal(value)) {
                showToast("Only external urls allowed.", 2000);
                return;
            }
            addIntentResponseVideoIntoCollection(value);
            $("#add_enter_intent_video_url_data").val("");
        }
    });
}

function isExternal(url) {
    var domain = (new URL(url));
    domain = domain.hostname;

    if (domain === 'localhost' || domain === '[::1]' || domain.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/)) {
        return false;
    }
    else {
        return true;
    }
}

function addIntentTrainingDataIntoCollection(sentence) {
    if (sentence.trim() == "") {
        return;
    }
    if (!sanitize_special_characters_from_text(sentence, 'Training questions cannot contain special characters')) {
        return
    }
    var id = "trainingdata_" + training_data_count.toString();
    var str_id = "trainingdatastr_" + training_data_count.toString();

    var html = `<li class="collection-item" id="` + id + `">
      <div class="row">
        <input id="` + str_id + `" onblur="sanitize_special_characters(this, 'Training questions cannot contain special characters')" type="text" data-length="100" value="` + sentence + `" style="width: 80%">
        <label for="` + str_id + `"></label>
        <div class="secondary-content">
        <a href="" class="delete-button-training-data" id="` + id + `">
          <i class="inline-icon material-icons red-text text-darken-3">delete</i>
        </a>
        </div>
      </div>
    </li>`;



    var training_sentences = $('#intent-training-collection li input[type=text]')

    training_sentences_list = []

    training_sentences.each(function () {
        training_sentences_list.push($(this).attr('value'));
    });
    if (training_sentences_list.includes(sentence.trim()) == false) {

        $(html).appendTo($("#intent-training-collection"));
        training_data_count += 1;
    } else {

        M.toast({
            "html": "This training sentence already exists"
        }, 2000);
    }
}

var intent_response_sentence_count = 0;

function addIntentResponseTextSentencesIntoCollection(text, speech) {
    var id = "intent_response_" + intent_response_sentence_count.toString();
    var str_id = "intent_response_" + intent_response_sentence_count.toString();

    var html = `
    <li class="collection-item" id="` + id + `">
      <div class="row">
        <input placeholder="text-response" id="text_` + str_id + `" type="text" data-length="100" value="` + text + `" style="width: 80%" required>
        <input placeholder="speech-response" id="speech_` + str_id + `" type="text" data-length="100" value="` + speech + `" style="width: 80%" required>
        <label for="` + str_id + `"></label>
        <div class="secondary-content">
        <a href="" class="delete-button-intent-response-data" id="` + id + `">
          <i class="inline-icon material-icons red-text text-darken-3">delete</i>
        </a>
        </div>
      </div>
    </li>`;

    $(html).appendTo($("#intent-response-collection"));
    intent_response_sentence_count += 1;
}

var intent_card_count = 0;

function addIntentResponseCardIntoCollection(title, content, link, img_url) {

    if (link != null && link != undefined && link.startsWith("/files/")) {
        link = window.location.protocol + "//" + window.location.host + link;
    }

    if (img_url != null && img_url != undefined && img_url.startsWith("/files/")) {
        img_url = window.location.protocol + "//" + window.location.host + img_url;
    }

    var id = "intent_card_" + intent_card_count.toString();
    var str_id = "intent_card_" + intent_card_count.toString();
    let selected_language = get_selected_language_from_url();
    var html = `
    <li class="collection-item" id="` + id + `">
      <div class="row">
      <div class="col s5">
        <div class="card">
        <div class="card-image waves-effect waves-block waves-light">`

    if (img_url) {
        html += `<img class="activator responsive-img" src="` + img_url + `" id="img_url_` + str_id + `">`
    }
    html += `
          <span class="card-title" id="title_` + str_id + `" style="display:none;">` + title + `</span>
        </div>
        <div class="card-content">
          <span class="card-title activator grey-text text-darken-4" style="word-break: break-word;">` + title + `<i class="material-icons right">more_vert</i></span>
          <p><a href="` + link + `" id="link_` + str_id + `" target="_blank">Please click here</a></p>
        </div>
        <div class="card-reveal">
          <span class="card-title grey-text text-darken-4">` + title + `<i class="material-icons right">close</i></span>
          <p id="content_` + str_id + `">` + content + `</p>
        </div>
        </div>
      </div>
      <div class="secondary-content row">
        <a href="" class="edit-button-intent-card-detail col" id="` + id + `">
            <i class="inline-icon material-icons green-text text-darken-2">edit</i>
        </a>`
    if (selected_language == "en") {

        html += `<a href="" class="delete-button-intent-card-detail col" id="` + id + `">
            <i class="inline-icon material-icons red-text text-darken-3">delete</i>
        </a>`
    }
    html += `</div>
      </div>
    </li>`;

    $(html).appendTo($("#intent-card-collection"));
    intent_card_count += 1;
}

function addIntentResponseImageIntoCollection(url) {

    if (url.startsWith("/files/")) {
        url = window.location.protocol + "//" + window.location.host + url;
    }

    if (isValidURL(url) == false) {
        M.toast({
            "html": "Please provide valid image url"
        }, 2000);
        return;
    }

    var id = "intent_image_url_" + intent_image_url_count.toString();
    var str_id = "intent_image_url_" + intent_image_url_count.toString();

    var html = `
    <li class="collection-item" id="` + id + `">
      <div class="row">
        <div style="display:none;">
        <input placeholder="Image url" id="imageurl_` + str_id + `" type="text" data-length="100" value="` + url + `" style="width: 80%" required>
        <label for="` + str_id + `"></label>
        </div>
        <img class="responsive-img" src="` + url + `">
        <div class="secondary-content">
        <a href="" class="delete-button-intent-image-url" id="` + id + `">
          <i class="inline-icon material-icons red-text text-darken-3">delete</i>
        </a>
        </div>
      </div>
    </li>`;

    $(html).appendTo($("#intent-image-url-collection"));
    intent_image_url_count += 1;
    // M.toast({"html":"Image Uploaded Successfully."}, 2000);
}

var intent_video_url_count = 0;

function getEmbedVideoURL(url) {
    var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
    var match = url.match(regExp);

    if (match && match[2].length == 11) {
        return "https://www.youtube.com/embed/" + match[2];
    } else {
        return url;
    }
}

function addIntentResponseVideoIntoCollection(url) {

    if (isValidURL(url) == false) {
        M.toast({
            "html": "Please provide valid video url"
        }, 2000);
        return;
    }

    var embed_url = getEmbedVideoURL(url);

    var id = "intent_video_url_" + intent_video_url_count.toString();
    var str_id = "intent_video_url_" + intent_video_url_count.toString();

    var html = `
    <li class="collection-item" id="` + id + `">
      <div class="row">
        <div style="display:none;">
        <input placeholder="Video url" id="videourl_` + str_id + `" type="text" data-length="100" value="` + embed_url + `" style="width: 80%" required>
        <label for="` + str_id + `"></label>
        </div>`;

    if (embed_url.indexOf("embed") == -1) {
        html += `
        <video width="320" height="240" controls>
          <source src="` + embed_url + `" type="video/mp4">
        </video>`;
    } else {
        html += `
        <div class="video-container">
          <iframe src="` + embed_url + `" frameborder="0" allowfullscreen></iframe>
        </div>`;
    }

    html += `<br>

        <div class="secondary-content">
        <a href="" class="delete-button-intent-video-url" id="` + id + `">
          <i class="inline-icon material-icons red-text text-darken-3">delete</i>
        </a>
        </div>
      </div>
    </li>`;

    $(html).appendTo($("#intent-video-url-collection"));
    intent_video_url_count += 1;
}

// Remove element with element id with click
$(document).on("click", ".delete-button-training-data", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();
});

// $(document).on("click", ".widget-delete-icon", function(e) {
//     e.preventDefault();
//     element = "#" + this.id;
//     $(element).remove();
// });

$(document).on("click", ".delete-button-checkbox-widget-data", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();
});

$(document).on("click", ".delete-button-dropdown-widget-data", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();
});

$(document).on("click", ".delete-button-intent-image-url", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();
});

$(document).on("click", ".delete-button-intent-video-url", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();
});

$(document).on("click", ".delete-button-intent-card-detail", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();
});

var global_last_edit_card_id = null;

$(document).on("click", ".edit-button-intent-card-detail", function (e) {
    e.preventDefault();
    adding_new_card = false;
    element = "#" + this.id;
    global_last_edit_card_id = this.id;
    token_id = this.id;
    card_img_url = $("#img_url_" + token_id).attr("src");
    card_title = document.getElementById("title_" + token_id).innerText;
    card_content = $("#content_" + token_id).html();
    card_url = $("#link_" + token_id).attr("href");
    $("#modal-intent-card").modal("open");
    $("#intent_card_title").val(card_title)
    $("#intent_card_content").val(card_content)
    $("#intent_card_link").val(card_url)
    $("#intent_card_img_url").val(card_img_url)
});

$(document).on("click", ".edit-button-tree-intent-card-detail", function (e) {
    e.preventDefault();
    adding_new_tree_card = false;
    element = "#" + this.id;
    global_last_edit_card_id = this.id;
    token_id = this.id;
    card_img_url = $("#img_url_" + token_id).attr("src");
    card_title = document.getElementById("title_" + token_id).innerText;
    card_content = $("#content_" + token_id).html();
    card_url = $("#link_" + token_id).attr("href");
    $("#modal-tree-card").modal("open");
    $("#tree_card_title").val(card_title)
    $("#tree_card_content").val(card_content)
    $("#tree_card_link").val(card_url)
    $("#tree_card_img_url").val(card_img_url)
});

var adding_new_card = false;
$(document).on("click", ".add-button-intent-card-detail", function (e) {
    adding_new_card = true;
    $("#intent_card_title").val("")
    $("#intent_card_content").val("")
    $("#intent_card_link").val("")
    $("#intent_card_img_url").val("")
    $("#input_upload_file_intent_card2").val("")
    $("#input_upload_image_intent_card2").val("")
    $("#input_upload_file_intent_card").val("")
    $("#input_upload_image_intent_card").val("")
})

let adding_new_tree_card = false;
$(document).on("click", ".add-button-tree-card-detail", function (e) {
    adding_new_tree_card = true;
    $("#tree_card_title").val("")
    $("#tree_card_content").val("")
    $("#tree_card_link").val("")
    $("#tree_card_img_url").val("")
    $("#input_upload_file_tree_card2").val("")
    $("#input_upload_image_tree_card2").val("")
    $("#input_upload_file_tree_card").val("")
    $("#input_upload_image_tree_card").val("")
})

$(document).on("change", "#checkbox-intent-attachment", function (e) {

    var checked_val = document.getElementById("checkbox-intent-attachment").checked
    if (checked_val) {
        document.getElementById("easychat-attachment-dropdown").style.display = "table-row";
        document.getElementById("easychat-save-attachment-server").style.display = "table-row";

    } else {
        document.getElementById("easychat-attachment-dropdown").style.display = "none";
        document.getElementById("easychat-save-attachment-server").style.display = "none";
    }
});

$(document).on("change", "#checkbox-intent-video-recorder", function (e) {

    var checked_val = document.getElementById("checkbox-intent-video-recorder").checked
    if (checked_val) {
        document.getElementById("easychat-save-video-attachment-server").style.display = "table-row";

    } else {
        document.getElementById("easychat-save-video-attachment-server").style.display = "none";

    }
});

$(document).on("change", "#checkbox-intent-time-picker", function (e) {

    var checked_val = document.getElementById("checkbox-intent-time-picker").checked
    if (checked_val) {
        document.getElementById("intent-single-time-picker").style.display = "block";
        document.getElementById("intent-multi-time-picker").style.display = "block";

    } else {
        document.getElementById("intent-single-time-picker").style.display = "none";
        document.getElementById("intent-multi-time-picker").style.display = "none";

    }
});
try {
    document.querySelector(".single-date").disabled = true;
    document.querySelector(".custom-date").disabled = true;
    document.querySelector(".single-time").disabled = true;
    document.querySelector(".custom-time").disabled = true;
} catch (err) { }

$(document).on("change", "#checkbox-intent-single-time-picker", function (e) {

    var checked_val = document.getElementById("checkbox-intent-single-time-picker").checked
    if (checked_val) {
        document.getElementById("checkbox-intent-multi-time-picker").checked = false;
        document.getElementById("checkbox-intent-multi-time-picker").disabled = true;
    } else {
        document.getElementById("checkbox-intent-multi-time-picker").disabled = false;
    }
});

$(document).on("change", "#checkbox-intent-multi-time-picker", function (e) {

    var checked_val = document.getElementById("checkbox-intent-multi-time-picker").checked
    if (checked_val) {
        document.getElementById("checkbox-intent-single-time-picker").checked = false;
        document.getElementById("checkbox-intent-single-time-picker").disabled = true;
    } else {
        document.getElementById("checkbox-intent-single-time-picker").disabled = false;

    }
});

$(document).on("change", "#checkbox-intent-date-picker", function (e) {

    var checked_val = document.getElementById("checkbox-intent-date-picker").checked
    if (checked_val) {
        document.getElementById("intent-single-date-picker").style.display = "block";
        document.getElementById("intent-multi-date-picker").style.display = "block";
    } else {
        document.getElementById("intent-single-date-picker").style.display = "none";
        document.getElementById("intent-multi-date-picker").style.display = "none";
    }
});

$(document).on("change", "#checkbox-intent-single-date-picker", function (e) {

    var checked_val = document.getElementById("checkbox-intent-single-date-picker").checked
    if (checked_val) {
        document.getElementById("checkbox-intent-multi-date-picker").checked = false;
        document.getElementById("checkbox-intent-multi-date-picker").disabled = true;
    } else {
        document.getElementById("checkbox-intent-multi-date-picker").disabled = false;
    }
});

$(document).on("change", "#checkbox-intent-multi-date-picker", function (e) {

    var checked_val = document.getElementById("checkbox-intent-multi-date-picker").checked
    if (checked_val) {
        document.getElementById("checkbox-intent-single-date-picker").checked = false;
        document.getElementById("checkbox-intent-single-date-picker").disabled = true;
    } else {
        document.getElementById("checkbox-intent-single-date-picker").disabled = false;
    }
});


$(document).on("change", "#checkbox-intent-range-slider", function (e) {

    var checked_val = document.getElementById("checkbox-intent-range-slider").checked
    if (checked_val) {
        document.getElementById("intent-min-range-slider").style.display = "block";
        document.getElementById("intent-max-range-slider").style.display = "block";
    } else {
        document.getElementById("intent-min-range-slider").style.display = "none";
        document.getElementById("intent-max-range-slider").style.display = "none";
    }
});

$(document).on("change", "#checkbox-intent-radio-button", function (e) {

    var checked_val = document.getElementById("checkbox-intent-radio-button").checked
    if (checked_val) {
        document.getElementById("intent-radio-button-choices").style.display = "block";
    } else {
        document.getElementById("intent-radio-button-choices").style.display = "none";
    }
});

$(document).on("change", "#checkbox-intent-check-box", function (e) {

    var checked_val = document.getElementById("checkbox-intent-check-box").checked
    if (checked_val) {
        document.getElementById("intent-check-box-choices").style.display = "block";
    } else {
        document.getElementById("intent-check-box-choices").style.display = "none";
    }
});

$(document).on("change", "#checkbox-intent-drop-down", function (e) {

    var checked_val = document.getElementById("checkbox-intent-drop-down").checked
    if (checked_val) {
        document.getElementById("intent-drop-down-choices").style.display = "block";

    } else {
        document.getElementById("intent-drop-down-choices").style.display = "none";
    }
});

$(document).on("change", "#checkbox-intent-create-form", function (e) {

    var checked_val = document.getElementById("checkbox-intent-create-form").checked
    if (checked_val) {
        document.getElementById("intent-create-form-fields").style.display = "block";
    } else {
        document.getElementById("intent-create-form-fields").style.display = "none";
    }
});


function handleCheck() {

    if (document.getElementById("enabledatepicker_switch1").checked === true) {
        document.querySelector(".single-date").disabled = false;
        document.querySelector(".custom-date").disabled = false;
    }
    else {
        document.querySelector(".single-date").disabled = true;
        document.querySelector(".custom-date").disabled = true;
        document.getElementById('single-date-picker-radio').checked = false
        document.getElementById('custom-date-picker-radio').checked = false
    }

    if (document.getElementById("enabletimepicker_switch2").checked === true) {
        document.querySelector(".single-time").disabled = false;
        document.querySelector(".custom-time").disabled = false;
    }
    else {
        document.querySelector(".single-time").disabled = true;
        document.querySelector(".custom-time").disabled = true;
        document.getElementById('single-time-picker-radio').checked = false
        document.getElementById('custom-time-picker-radio').checked = false
    }
}

function check_for_short_name(){
    let selected_channels_list = $("#multiple-select-intent-channel-list").val();
    if(selected_channels_list.includes("GoogleBusinessMessages")){
        document.getElementById('short_name_field').style.display = 'block'
    }
    else{
        document.getElementById('short_name_field').style.display = 'none'
    }
}

$(document).on("click", ".save-add-other-intent", function (e) {
    save_intent(true, e);
});


$(document).on("click", "#save-intent, #save-intent-bottom", function (e) {
    save_intent(false, e);
});

$(document).on("click", ".delete-button-dropdown-tms-category", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();
});

var radio_choice_data_count = 0;

function get_radio_button_list() {
    radio_choices_list = []
    var inputs = document.getElementsByTagName("input");
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf('radio_button_data_str') == 0) {
            data_id = "#" + inputs[i].id;
            radio_choices = $(data_id).val();
            if (radio_choices != "") {
                radio_choices_list.push(radio_choices);
            }
        }
    }
    return radio_choices_list
}


function form_get_radio_button_list(field_id) {
    radio_choices_list = []
    var searchable_elem = 'sortable-radio-widget-edit-div-' + field_id
    var inputs = document.getElementById(searchable_elem).getElementsByTagName('input')
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf('form_radio_button_data_str') == 0) {
            data_id = "#" + inputs[i].id;
            radio_choices = $(data_id).val();
            if (radio_choices != "") {
                radio_choices_list.push(radio_choices);
            }
        }
    }

    return radio_choices_list
}


function radio_input_focusout(id, form = "", field_id = "") {
    var value = document.getElementById(form + "radio_button_data_str_" + id).value

    var format = /[`#$%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;
    if (format.test(value.trim())) {
        M.toast({
            'html': "Invalid choice name(Only A-Z, a-z, 0-9, ?, !, @, & are allowed)"
        }, 2000);
        document.getElementById(form + "radio_button_data_str_" + id).value = ""
        var ele = document.getElementById(form + "radio_button_data_" + id);

        $(ele).remove();
        if (form == "")
            remove_header("radio_button_data_str_" + id)
        return;

    }
    format = /[a-zA-Z0-9]/;
    if (!format.test(value.trim())) {
        M.toast({
            'html': "Invalid choice name(Choice name must contain at least one alphanumeric character)"
        }, 2000);
        document.getElementById(form + "radio_button_data_str_" + id).value = ""
        var ele = document.getElementById(form + "radio_button_data_" + id);
        $(ele).remove();
        if (form == "")
            remove_header("radio_button_data_str_" + id)
        return;
    }
    var radio_list = get_radio_button_list()
    if (form != "")
        radio_list = form_get_radio_button_list(field_id)
    var radio_list_duplicate_values = duplicates_exists(radio_list)
    if (radio_list_duplicate_values == true) {
        M.toast({
            'html': "Duplicate choices found!"
        }, 2000);
        document.getElementById(form + "radio_button_data_str_" + id).value = ""
        var ele = document.getElementById(form + "radio_button_data_" + id);
        $(ele).remove();
        if (form == "")
            remove_header("radio_button_data_str_" + id)
        return;
    }

}

function delete_elem(elem) {
    elem.remove()
    remove_header(elem.id)
}


function remove_header(id) {
    if (!id.toString().trim().includes("form")) {

        if (id.toString().trim().includes('radio')) {
            if (get_radio_button_list().length == 0) {
                document.getElementById('radio-heading').style.display = "none"
            }
        } else if (id.toString().trim().includes('check')) {
            if (get_check_box_list().length == 0) {
                document.getElementById('checkbox-heading').style.display = "none"
            }
        } else if (id.toString().trim().includes('drop')) {
            if (get_drop_down_list().length == 0) {
                document.getElementById('dropdown-heading').style.display = "none"
            }
        }
    }
}

function add_radio_button_choices_collection(sentence, form = "", field_id = "") {
    if (sentence.trim() == "") {
        return;
    }
    var id = form + "radio_button_data_" + radio_choice_data_count.toString();
    var str_id = form + "radio_button_data_str_" + radio_choice_data_count.toString();

    var html = `<div class="response-widget-dragable-output-item" id="` + id + `">
                                                    <div class="dragable-item-icon tooltip-custom">
                                                        <svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M16.9998 6.5C16.9998 7.6 16.0998 8.5 14.9998 8.5C13.8998 8.5 12.9998 7.6 12.9998 6.5C12.9998 5.4 13.8998 4.5 14.9998 4.5C16.0998 4.5 16.9998 5.4 16.9998 6.5ZM8.9998 4.5C7.8998 4.5 6.9998 5.4 6.9998 6.5C6.9998 7.6 7.8998 8.5 8.9998 8.5C10.0998 8.5 10.9998 7.6 10.9998 6.5C10.9998 5.4 10.0998 4.5 8.9998 4.5ZM6.99976 12.5C6.99976 11.4 7.89976 10.5 8.99976 10.5C10.0998 10.5 10.9998 11.4 10.9998 12.5C10.9998 13.6 10.0998 14.5 8.99976 14.5C7.89976 14.5 6.99976 13.6 6.99976 12.5ZM8.99976 20.5C10.0998 20.5 10.9998 19.6 10.9998 18.5C10.9998 17.4 10.0998 16.5 8.99976 16.5C7.89976 16.5 6.99976 17.4 6.99976 18.5C6.99976 19.6 7.89976 20.5 8.99976 20.5ZM14.9998 10.5C13.8998 10.5 12.9998 11.4 12.9998 12.5C12.9998 13.6 13.8998 14.5 14.9998 14.5C16.0998 14.5 16.9998 13.6 16.9998 12.5C16.9998 11.4 16.0998 10.5 14.9998 10.5ZM12.9998 18.5C12.9998 17.4 13.8998 16.5 14.9998 16.5C16.0998 16.5 16.9998 17.4 16.9998 18.5C16.9998 19.6 16.0998 20.5 14.9998 20.5C13.8998 20.5 12.9998 19.6 12.9998 18.5Z" fill="#DADADA"/>
                                                            </svg>
                                                        <div class="tooltiptext-custom tooltip-bottom-custom">Drag to move</div>


                                                    </div>
                                                    <div class="widget-indigator-icon" >
                                                        <svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M5 12C5 8.136 8.136 5 12 5C15.864 5 19 8.136 19 12C19 15.864 15.864 19 12 19C8.136 19 5 15.864 5 12ZM6.39959 12C6.39959 15.094 8.90559 17.6 11.9996 17.6C15.0936 17.6 17.5996 15.094 17.5996 12C17.5996 8.90597 15.0936 6.39997 11.9996 6.39997C8.90559 6.39997 6.39959 8.90597 6.39959 12Z" fill="#C4C4C4"/>
                                                            </svg>

                                                    </div>
                                                  
                                                    <input class="edit_radio_button_choices" id="` + str_id + `" type="text" maxlength="` + character_limit_small_text + `"  onfocus="edit_radio_button_choices_focus(this)"  onfocusout="edit_radio_button_choices_focusout(this,'` + radio_choice_data_count + `','` + field_id + `')" value="` + sentence + `">
                                                    
                                                    <div class="widget-delete-icon" onclick="delete_elem(` + id + `)">
                                                        <svg width="12" height="13" viewBox="0 0 12 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M9.15011 3.35534C9.05669 3.26172 8.92987 3.2091 8.79761 3.2091C8.66535 3.2091 8.53852 3.26172 8.44511 3.35534L6.00011 5.79534L3.55511 3.35034C3.46169 3.25672 3.33487 3.2041 3.20261 3.2041C3.07035 3.2041 2.94352 3.25672 2.85011 3.35034C2.65511 3.54534 2.65511 3.86034 2.85011 4.05534L5.29511 6.50034L2.85011 8.94534C2.65511 9.14034 2.65511 9.45534 2.85011 9.65034C3.04511 9.84534 3.36011 9.84534 3.55511 9.65034L6.00011 7.20534L8.44511 9.65034C8.64011 9.84534 8.95511 9.84534 9.15011 9.65034C9.34511 9.45534 9.34511 9.14034 9.15011 8.94534L6.70511 6.50034L9.15011 4.05534C9.34011 3.86534 9.34011 3.54534 9.15011 3.35534Z" fill="#2D2D2D"/>
                                                            </svg>

                                                    </div>

                                                </div>`

    if (form == "") {
        $(html).appendTo($("#sortable-radio-widget-edit-div"));
        document.getElementById('radio-heading').style.display = "block"
        document.getElementById("new_bot_error_div_div-radio-button-widget").innerHTML = ""
    } else {

        $(html).appendTo($("#sortable-radio-widget-edit-div-" + field_id));
        $("#sortable-radio-widget-edit-div-" + field_id).sortable({
            containment: "parent"
        });
        document.getElementById("new_bot_error_div_widgets_" + field_id).innerHTML = ""
    }
    radio_choice_data_count += 1;

}

//radio button sortables
function edit_radio_button_choices_focus(elem) {
    $(elem).parent().addClass('edit-radio-widget-focus');
    $(elem).parent().children('.widget-delete-icon').css("display", "none");

}

function edit_radio_button_choices_focusout(elem, id, field_id = "") {
    $(elem).parent().removeClass('edit-radio-widget-focus');
    $(elem).parent().children('.widget-delete-icon').css("display", "block");
    if (elem.id.toString().includes("form"))
        radio_input_focusout(id, "form_", field_id)
    else
        radio_input_focusout(id)
};

if (window.location.pathname != '/chat/login/') {
    $(function () {
        try {
            $("#sortable-radio-widget-edit-div").sortable({
                containment: "parent",
            });
            $("#sortable-checkbox-widget-edit-div").sortable({
                containment: "parent",
            });
            $("#sortable-dropdown-widget-edit-div").sortable({
                containment: "parent",
            })
        } catch (err) {
            console.log(err)
        }
        // $("#sortable-widget-edit-div").disableSelection();

    });
}
// end radio btn sortables

var check_box_data_count = 0;


function get_check_box_list() {
    check_choices_list = []
    var inputs = document.getElementsByTagName("input");

    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf('check_box_data_str') == 0) {
            data_id = "#" + inputs[i].id;
            check_box_choices = $(data_id).val();
            if (check_box_choices != "") {
                check_choices_list.push(check_box_choices);
            }
        }
    }

    return check_choices_list
}

function form_get_check_box_list(field_id) {
    radio_choices_list = []
    var searchable_elem = 'sortable-checkbox-widget-edit-div-' + field_id
    var inputs = document.getElementById(searchable_elem).getElementsByTagName('input')
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf('form_check_box_data_str_') == 0) {
            data_id = "#" + inputs[i].id;
            radio_choices = $(data_id).val();
            if (radio_choices != "") {
                radio_choices_list.push(radio_choices);
            }
        }
    }

    return radio_choices_list
}

function checkbox_input_focusout(id, form = "", field_id = "") {
    var value = document.getElementById(form + "check_box_data_str_" + id).value

    var format = /[`#$%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;
    if (format.test(value.trim())) {
        M.toast({
            'html': "Invalid choice name(Only A-Z, a-z, 0-9, ?, !, @, & are allowed)"
        }, 2000);
        document.getElementById(form + "check_box_data_str_" + id).value = ""
        var ele = document.getElementById(form + "check_box_data_" + id);

        $(ele).remove();
        if (form == "")
            remove_header("check_box_data_str_" + id)
        return;

    }
    format = /[a-zA-Z0-9]/;
    if (!format.test(value.trim())) {
        M.toast({
            'html': "Invalid choice name(Choice name must contain at least one alphanumeric character)"
        }, 2000);
        document.getElementById(form + "check_box_data_str_" + id).value = ""
        var ele = document.getElementById(form + "check_box_data_" + id);
        $(ele).remove();
        if (form == "")
            remove_header("check_box_data_str_" + id)
        return;
    }

    var checkbox_list = get_check_box_list()
    if (form != "")
        checkbox_list = form_get_check_box_list(field_id)
    var checkbox_list_duplicate_values = duplicates_exists(checkbox_list)
    if (checkbox_list_duplicate_values == true) {
        M.toast({
            'html': "Duplicate choices found!"
        }, 2000);

        document.getElementById(form + "check_box_data_str_" + id).value = ""
        var ele = document.getElementById(form + "check_box_data_" + id);
        $(ele).remove();
        if (form == "")
            remove_header("check_box_data_str_" + id)
        return;
    }

}

function add_check_box_choices_collection(sentence, form = "", field_id = "") {
    if (sentence.trim() == "") {
        return;
    }
    var id = form + "check_box_data_" + check_box_data_count.toString();
    var str_id = form + "check_box_data_str_" + check_box_data_count.toString();

    var html = `  <div class="response-widget-dragable-output-item" id="` + id + `">
                                                    <div class="dragable-item-icon tooltip-custom">
                                                        <svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M16.9998 6.5C16.9998 7.6 16.0998 8.5 14.9998 8.5C13.8998 8.5 12.9998 7.6 12.9998 6.5C12.9998 5.4 13.8998 4.5 14.9998 4.5C16.0998 4.5 16.9998 5.4 16.9998 6.5ZM8.9998 4.5C7.8998 4.5 6.9998 5.4 6.9998 6.5C6.9998 7.6 7.8998 8.5 8.9998 8.5C10.0998 8.5 10.9998 7.6 10.9998 6.5C10.9998 5.4 10.0998 4.5 8.9998 4.5ZM6.99976 12.5C6.99976 11.4 7.89976 10.5 8.99976 10.5C10.0998 10.5 10.9998 11.4 10.9998 12.5C10.9998 13.6 10.0998 14.5 8.99976 14.5C7.89976 14.5 6.99976 13.6 6.99976 12.5ZM8.99976 20.5C10.0998 20.5 10.9998 19.6 10.9998 18.5C10.9998 17.4 10.0998 16.5 8.99976 16.5C7.89976 16.5 6.99976 17.4 6.99976 18.5C6.99976 19.6 7.89976 20.5 8.99976 20.5ZM14.9998 10.5C13.8998 10.5 12.9998 11.4 12.9998 12.5C12.9998 13.6 13.8998 14.5 14.9998 14.5C16.0998 14.5 16.9998 13.6 16.9998 12.5C16.9998 11.4 16.0998 10.5 14.9998 10.5ZM12.9998 18.5C12.9998 17.4 13.8998 16.5 14.9998 16.5C16.0998 16.5 16.9998 17.4 16.9998 18.5C16.9998 19.6 16.0998 20.5 14.9998 20.5C13.8998 20.5 12.9998 19.6 12.9998 18.5Z" fill="#DADADA"/>
                                                            </svg>
                                                        <div class="tooltiptext-custom tooltip-bottom-custom">Drag to move</div>


                                                    </div>
                                                    <div class="widget-indigator-icon" style="height: 20px;">
                                                        <svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M4.25 2.75H14.75C15.575 2.75 16.25 3.425 16.25 4.25V14.75C16.25 15.575 15.575 16.25 14.75 16.25H4.25C3.425 16.25 2.75 15.575 2.75 14.75V4.25C2.75 3.425 3.425 2.75 4.25 2.75ZM5 14.75H14C14.4125 14.75 14.75 14.4125 14.75 14V5C14.75 4.5875 14.4125 4.25 14 4.25H5C4.5875 4.25 4.25 4.5875 4.25 5V14C4.25 14.4125 4.5875 14.75 5 14.75Z" fill="#C4C4C4"/>
                                                            </svg>


                                                    </div>
                                                    <input type="text" maxlength="`+ character_limit_small_text + `" class="edit_radio_button_choices" id="` + str_id + `" onfocus="edit_checkbox_choices_focus(this)"  onfocusout="edit_checkbox_choices_focusout(this,'` + check_box_data_count + `','` + field_id + `')" value="` + sentence + `">
                                                    <div class="widget-delete-icon" onclick="delete_elem(` + id + `)">
                                                        <svg width="12" height="13" viewBox="0 0 12 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M9.15011 3.35534C9.05669 3.26172 8.92987 3.2091 8.79761 3.2091C8.66535 3.2091 8.53852 3.26172 8.44511 3.35534L6.00011 5.79534L3.55511 3.35034C3.46169 3.25672 3.33487 3.2041 3.20261 3.2041C3.07035 3.2041 2.94352 3.25672 2.85011 3.35034C2.65511 3.54534 2.65511 3.86034 2.85011 4.05534L5.29511 6.50034L2.85011 8.94534C2.65511 9.14034 2.65511 9.45534 2.85011 9.65034C3.04511 9.84534 3.36011 9.84534 3.55511 9.65034L6.00011 7.20534L8.44511 9.65034C8.64011 9.84534 8.95511 9.84534 9.15011 9.65034C9.34511 9.45534 9.34511 9.14034 9.15011 8.94534L6.70511 6.50034L9.15011 4.05534C9.34011 3.86534 9.34011 3.54534 9.15011 3.35534Z" fill="#2D2D2D"/>
                                                            </svg>

                                                    </div>

                                                </div>`

    if (form == "") {
        $(html).appendTo($("#sortable-checkbox-widget-edit-div"));
        document.getElementById('checkbox-heading').style.display = "block"
        document.getElementById("new_bot_error_div_div-check-box-widget").innerHTML = ""
    } else {

        $(html).appendTo($("#sortable-checkbox-widget-edit-div-" + field_id));
        $("#sortable-checkbox-widget-edit-div-" + field_id).sortable({
            containment: "parent"
        });
        document.getElementById("new_bot_error_div_widgets_" + field_id).innerHTML = ""
    }

    check_box_data_count += 1;
}

//checkbox sortables
function edit_checkbox_choices_focus(elem) {
    $(elem).parent().addClass('edit-radio-widget-focus');
    $(elem).parent().children('.widget-delete-icon').css("display", "none");

}

function edit_checkbox_choices_focusout(elem, id, field_id = "") {
    $(elem).parent().removeClass('edit-radio-widget-focus');
    $(elem).parent().children('.widget-delete-icon').css("display", "block");
    if (elem.id.toString().includes("form"))
        checkbox_input_focusout(id, "form_", field_id)
    else
        checkbox_input_focusout(id)
};

//checkbox sortables end
var tms_cat_drop_down_count = 0

function get_tms_cat_drop_down_list() {
    drop_down_choices_list = []
    var inputs = document.getElementsByTagName("input");
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf('tms_drop_down_data_str') == 0) {
            data_id = "#" + inputs[i].id;
            drop_down_choices = $(data_id).val();
            if (drop_down_choices != "") {
                drop_down_choices_list.push(drop_down_choices.trim().toLowerCase());
            }
        }
    }
    return drop_down_choices_list
}

function add_tms_drop_down_cat_collection(sentence) {
    if (sentence.trim() == "") {
        return;
    }
    var id = "tms_drop_down_data_" + tms_cat_drop_down_count.toString();
    var str_id = "tms_drop_down_data_str_" + tms_cat_drop_down_count.toString();

    var html = `<li class="collection-item" id="` + id + `">
      <div class="row">
        <input id="` + str_id + `" type="text" maxlength="` + tms_cat_limit + `" onkeypress="return (event.charCode >= 65 && event.charCode <= 90) || (event.charCode >= 97 && event.charCode <= 122) || (event.charCode >= 48 && event.charCode <= 57) || (event.charCode == 32)" data-length="100"\
         value="` + sentence + `" style="width: 80%">
        <label for="` + str_id + `"></label>
        <div class="secondary-content">
        <a href="" class="delete-button-dropdown-tms-category" id="` + id + `">
          <i class="inline-icon material-icons red-text text-darken-3">delete</i>
        </a>
        </div>
      </div>
    </li>`;

    $(html).appendTo($("#tms-drop-down-cat-collection"));
    tms_cat_drop_down_count += 1;
}

var drop_down_data_count = 0;

function get_drop_down_list() {
    drop_down_choices_list = []
    var inputs = document.getElementsByTagName("input");
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf('drop_down_data_str') == 0) {
            data_id = "#" + inputs[i].id;
            drop_down_choices = $(data_id).val();
            if (drop_down_choices != "") {
                drop_down_choices_list.push(drop_down_choices.trim().toLowerCase());
            }
        }
    }
    return drop_down_choices_list
}

function form_get_dropdown_list(field_id) {
    drop_down_choices_list = []
    var searchable_elem = 'sortable-dropdown-widget-edit-div-' + field_id
    var inputs = document.getElementById(searchable_elem).getElementsByTagName('input')
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf('form_drop_down_data_str') == 0) {
            data_id = "#" + inputs[i].id;
            drop_down_choices = $(data_id).val();
            if (drop_down_choices != "") {
                drop_down_choices_list.push(drop_down_choices);
            }
        }
    }

    return drop_down_choices_list
}

function drop_down_input_focusout(id, form = "", field_id = "") {

    var value = document.getElementById(form + "drop_down_data_str_" + id).value

    var format = /[`#$%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;
    if (format.test(value.trim())) {
        M.toast({
            'html': "Invalid choice name(Only A-Z, a-z, 0-9, ?, !, @, & are allowed)"
        }, 2000);
        document.getElementById(form + "drop_down_data_str_" + id).value = ""
        var ele = document.getElementById(form + "drop_down_data_" + id);
        $(ele).remove();
        if (form == "")
            remove_header("drop_down_data_str_" + id)
        return;

    }
    format = /[a-zA-Z0-9]/;
    if (!format.test(value.trim())) {
        M.toast({
            'html': "Invalid choice name(Choice name must contain at least one alphanumeric character)"
        }, 2000);
        document.getElementById(form + "drop_down_data_str_" + id).value = ""
        var ele = document.getElementById(form + "drop_down_data_" + id);
        $(ele).remove();
        if (form == "")
            remove_header("drop_down_data_str_" + id)
        return;
    }

    var drop_down_list = get_drop_down_list()
    if (form != "")
        drop_down_list = form_get_dropdown_list(field_id)
    var drop_down_list_duplicate_values = duplicates_exists(drop_down_list)
    if (drop_down_list_duplicate_values == true) {
        M.toast({
            'html': "Duplicate choices found!"
        }, 2000);

        document.getElementById(form + "drop_down_data_str_" + id).value = "";
        var ele = document.getElementById(form + "drop_down_data_" + id);
        $(ele).remove();
        if (form == "")
            remove_header("drop_down_data_str_" + id)
        return;
    }

}


function form_add_dropdown_chip(sentence, form, field_id) {
    if (sentence.trim() == "") {
        return;
    }
    var id = form + "drop_down_data_" + drop_down_data_count.toString();
    var str_id = form + "drop_down_data_str_" + drop_down_data_count.toString();

    var html = `  <div class="form-widget-dropdown-chip-item" id="` + id + `">
                                                                <div class="dragable-item-icon tooltip-custom">
                                                                    <svg width="14" height="15" viewBox="0 0 14 15" fill="#d9d9d9" xmlns="http://www.w3.org/2000/svg">
                                                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M9.91683 4.00016C9.91683 4.64183 9.39183 5.16683 8.75016 5.16683C8.1085 5.16683 7.5835 4.64183 7.5835 4.00016C7.5835 3.3585 8.1085 2.8335 8.75016 2.8335C9.39183 2.8335 9.91683 3.3585 9.91683 4.00016ZM5.2502 2.8335C4.60854 2.8335 4.08354 3.3585 4.08354 4.00017C4.08354 4.64183 4.60854 5.16683 5.2502 5.16683C5.89187 5.16683 6.41687 4.64183 6.41687 4.00017C6.41687 3.3585 5.89187 2.8335 5.2502 2.8335ZM4.0835 7.50016C4.0835 6.8585 4.6085 6.3335 5.25016 6.3335C5.89183 6.3335 6.41683 6.8585 6.41683 7.50016C6.41683 8.14183 5.89183 8.66683 5.25016 8.66683C4.6085 8.66683 4.0835 8.14183 4.0835 7.50016ZM5.25016 12.1668C5.89183 12.1668 6.41683 11.6418 6.41683 11.0002C6.41683 10.3585 5.89183 9.8335 5.25016 9.8335C4.6085 9.8335 4.0835 10.3585 4.0835 11.0002C4.0835 11.6418 4.6085 12.1668 5.25016 12.1668ZM8.75016 6.3335C8.1085 6.3335 7.5835 6.8585 7.5835 7.50016C7.5835 8.14183 8.1085 8.66683 8.75016 8.66683C9.39183 8.66683 9.91683 8.14183 9.91683 7.50016C9.91683 6.8585 9.39183 6.3335 8.75016 6.3335ZM7.5835 11.0002C7.5835 10.3585 8.1085 9.8335 8.75016 9.8335C9.39183 9.8335 9.91683 10.3585 9.91683 11.0002C9.91683 11.6418 9.39183 12.1668 8.75016 12.1668C8.1085 12.1668 7.5835 11.6418 7.5835 11.0002Z" />
                                                                        </svg>

                                                                    <div class="tooltiptext-custom tooltip-bottom-custom" style="left: -23px;">Drag to move</div>


                                                                </div>
                                                                <input type="text" maxlength="`+ character_limit_small_text + `" class="edit-form-widget-dropdown-choices" id="` + str_id + `"  onfocus = "edit_dropdown_chip_focus(this)" onfocusout="edit_dropdown_choices_focusout(this,'` + drop_down_data_count + `','` + field_id + `')" value="` + sentence + `">
                                                                <div class="widget-delete-icon" onclick="delete_elem(` + id + `)">
                                                                    <svg width="12" height="13" viewBox="0 0 12 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                            <path d="M9.15035 3.35486C9.05694 3.26123 8.93011 3.20861 8.79785 3.20861C8.66559 3.20861 8.53877 3.26123 8.44535 3.35486L6.00035 5.79486L3.55535 3.34986C3.46194 3.25623 3.33511 3.20361 3.20285 3.20361C3.07059 3.20361 2.94377 3.25623 2.85035 3.34986C2.65535 3.54486 2.65535 3.85986 2.85035 4.05486L5.29535 6.49986L2.85035 8.94486C2.65535 9.13986 2.65535 9.45486 2.85035 9.64986C3.04535 9.84486 3.36035 9.84486 3.55535 9.64986L6.00035 7.20486L8.44535 9.64986C8.64035 9.84486 8.95535 9.84486 9.15035 9.64986C9.34535 9.45486 9.34535 9.13986 9.15035 8.94486L6.70535 6.49986L9.15035 4.05486C9.34035 3.86486 9.34035 3.54486 9.15035 3.35486Z" fill="white"/>
                                                                            </svg>


                                                                </div>
                                                            </div>`



    $(html).appendTo($("#sortable-dropdown-widget-edit-div-" + field_id));
    $("#sortable-dropdown-widget-edit-div-" + field_id).sortable({
        containment: "parent"
    });


    $.fn.textWidth = function (text, font) {

        if (!$.fn.textWidth.fakeEl) $.fn.textWidth.fakeEl = $('<span>').hide().appendTo(document.body);

        $.fn.textWidth.fakeEl.text(text || this.val() || this.text() || this.attr('placeholder')).css('font', font || this.css('font'));

        return $.fn.textWidth.fakeEl.width();
    };

    $('#' + str_id).on('input', function () {
        var inputWidth = $(this).textWidth();

        $(this).attr('style', 'width: ' + inputWidth * 1.1 + 'px !important');


    }).trigger('input');


    function inputWidth(elem, minW, maxW) {
        elem = $(this);

    }

    var targetElem = $('#' + str_id);

    inputWidth(targetElem);

    document.getElementById("new_bot_error_div_widgets_" + field_id).innerHTML = ""


    drop_down_data_count += 1;
}

//dropdown chips 
function edit_dropdown_chip_focus(elem) {
    $(elem).parent().css("background", "#ffffff");
    $(elem).parent().css('border', '1px solid #729CDF');
    // $(this).css('color', "#2d2d2d !important");
    $(elem).parent().children('.widget-delete-icon').css("display", "none");
    // $(this).parent().children('.dragable-item-icon').css("display", "none");


}


function add_drop_down_choices_collection(sentence) {
    if (sentence.trim() == "") {
        return;
    }
    var id = "drop_down_data_" + drop_down_data_count.toString();
    var str_id = "drop_down_data_str_" + drop_down_data_count.toString();

    var html = `<div class="response-widget-dragable-output-item" id="` + id + `">
                                                    <div class="dragable-item-icon tooltip-custom">
                                                        <svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M16.9998 6.5C16.9998 7.6 16.0998 8.5 14.9998 8.5C13.8998 8.5 12.9998 7.6 12.9998 6.5C12.9998 5.4 13.8998 4.5 14.9998 4.5C16.0998 4.5 16.9998 5.4 16.9998 6.5ZM8.9998 4.5C7.8998 4.5 6.9998 5.4 6.9998 6.5C6.9998 7.6 7.8998 8.5 8.9998 8.5C10.0998 8.5 10.9998 7.6 10.9998 6.5C10.9998 5.4 10.0998 4.5 8.9998 4.5ZM6.99976 12.5C6.99976 11.4 7.89976 10.5 8.99976 10.5C10.0998 10.5 10.9998 11.4 10.9998 12.5C10.9998 13.6 10.0998 14.5 8.99976 14.5C7.89976 14.5 6.99976 13.6 6.99976 12.5ZM8.99976 20.5C10.0998 20.5 10.9998 19.6 10.9998 18.5C10.9998 17.4 10.0998 16.5 8.99976 16.5C7.89976 16.5 6.99976 17.4 6.99976 18.5C6.99976 19.6 7.89976 20.5 8.99976 20.5ZM14.9998 10.5C13.8998 10.5 12.9998 11.4 12.9998 12.5C12.9998 13.6 13.8998 14.5 14.9998 14.5C16.0998 14.5 16.9998 13.6 16.9998 12.5C16.9998 11.4 16.0998 10.5 14.9998 10.5ZM12.9998 18.5C12.9998 17.4 13.8998 16.5 14.9998 16.5C16.0998 16.5 16.9998 17.4 16.9998 18.5C16.9998 19.6 16.0998 20.5 14.9998 20.5C13.8998 20.5 12.9998 19.6 12.9998 18.5Z" fill="#DADADA"/>
                                                            </svg>
                                                        <div class="tooltiptext-custom tooltip-bottom-custom">Drag to move</div>


                                                    </div>

                                                    <input type="text" maxlength="`+ character_limit_small_text + `" class="edit_radio_button_choices" id="` + str_id + `" onfocus="edit_dropdown_choices_focus(this)"  onfocusout="edit_dropdown_choices_focusout(this,'` + drop_down_data_count + `')" value="` + sentence + `">
                                                    <div class="widget-delete-icon" onclick="delete_elem(` + id + `)">
                                                        <svg width="12" height="13" viewBox="0 0 12 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <path d="M9.15011 3.35534C9.05669 3.26172 8.92987 3.2091 8.79761 3.2091C8.66535 3.2091 8.53852 3.26172 8.44511 3.35534L6.00011 5.79534L3.55511 3.35034C3.46169 3.25672 3.33487 3.2041 3.20261 3.2041C3.07035 3.2041 2.94352 3.25672 2.85011 3.35034C2.65511 3.54534 2.65511 3.86034 2.85011 4.05534L5.29511 6.50034L2.85011 8.94534C2.65511 9.14034 2.65511 9.45534 2.85011 9.65034C3.04511 9.84534 3.36011 9.84534 3.55511 9.65034L6.00011 7.20534L8.44511 9.65034C8.64011 9.84534 8.95511 9.84534 9.15011 9.65034C9.34511 9.45534 9.34511 9.14034 9.15011 8.94534L6.70511 6.50034L9.15011 4.05534C9.34011 3.86534 9.34011 3.54534 9.15011 3.35534Z" fill="#2D2D2D"/>
                                                            </svg>

                                                    </div>

                                                </div>`

    $(html).appendTo($("#sortable-dropdown-widget-edit-div"));
    document.getElementById('dropdown-heading').style.display = "block"
    document.getElementById("new_bot_error_div_div-drop-down-widget").innerHTML = ""
    drop_down_data_count += 1;
}

//dropdown sortables

function edit_dropdown_choices_focus(elem) {
    $(elem).parent().addClass('edit-radio-widget-focus');
    $(elem).parent().children('.widget-delete-icon').css("display", "none");

}

function edit_dropdown_choices_focusout(elem, id, field_id = "") {
    $(elem).parent().removeClass('edit-radio-widget-focus');
    $(elem).parent().children('.widget-delete-icon').css("display", "block");
    if (elem.id.toString().includes("form")) {

        $(elem).parent().css("background", "#0254D7");
        $(elem).parent().css('border', 'none');
        // $(this).css('color', '#ffffff');
        $(elem).parent().children('.widget-delete-icon').css("display", "block");
        // $(this).parent().children('.dragable-item-icon').css("display", "block");



        drop_down_input_focusout(id, "form_", field_id)
    } else
        drop_down_input_focusout(id)
};

//end dropdown sortables


if ((window.location.href.indexOf("intent_pk=") != -1 || window.location.href.indexOf("chat/create-intent") != -1) && window.location.href.indexOf("chat/flow-analytics") == -1) {
    if (document.getElementById('add_radio_button_choices')) {
        document.getElementById("add_radio_button_choices")
        .addEventListener("keyup", function (event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                value = document.getElementById("add_radio_button_choices").value;
                var format = /[`#$%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;
                if (format.test(value.trim())) {
                    document.getElementById("new_bot_error_div_div-radio-button-widget").innerHTML = "Invalid choice name(Only A-Z, a-z, 0-9, ?, !, @, & are allowed)"
                    return;
                }
                format = /[a-zA-Z0-9]/;
                if (!format.test(value.trim())) {
                    document.getElementById("new_bot_error_div_div-radio-button-widget").innerHTML = "Invalid choice name(Choice name must contain at least one alphanumeric character)"
                    return;
                }
                var radio_button_list = get_radio_button_list()
                var check_duplicates_list = check_duplicates_for_value(value, radio_button_list)
                if (check_duplicates_list) {
                    document.getElementById("new_bot_error_div_div-radio-button-widget").innerHTML = "Choice already exists(All choices must be different)"
                } else {
                    add_radio_button_choices_collection(value.trim());
                }
                document.getElementById("add_radio_button_choices").value = "";
            }
        });
    }

    if (document.getElementById('add_check_box_choices')) {
        document.getElementById("add_check_box_choices")
        .addEventListener("keyup", function (event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                value = document.getElementById("add_check_box_choices").value;
                var format = /[`#$%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;
                if (format.test(value.trim())) {
                    document.getElementById("new_bot_error_div_div-check-box-widget").innerHTML = "Invalid choice name(Only A-Z, a-z, 0-9, ?, !, @, & are allowed)"
                    return;
                }
                format = /[a-zA-Z0-9]/;
                if (!format.test(value.trim())) {
                    document.getElementById("new_bot_error_div_div-check-box-widget").innerHTML = "Invalid choice name(Choice name must contain at least one alphanumeric character)"
                    return;
                }
                var check_box_list = get_check_box_list()
                var check_duplicates_list = check_duplicates_for_value(value, check_box_list)
                if (check_duplicates_list) {
                    document.getElementById("new_bot_error_div_div-check-box-widget").innerHTML = "Choice already exists(All choices must be different)"
                } else {
                    add_check_box_choices_collection(value.trim());
                }
                document.getElementById("add_check_box_choices").value = "";
            }
        });
    }


    if (document.getElementById('add_drop_down_choices')) {
        document.getElementById("add_drop_down_choices")
        .addEventListener("keyup", function (event) {
            event.preventDefault();
            if (event.keyCode === 13) {
                value = document.getElementById("add_drop_down_choices").value;
                value = value.trim()
                var format = /[`#$%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;
                if (format.test(value.trim())) {
                    document.getElementById("new_bot_error_div_div-drop-down-widget").innerHTML = "Invalid choice name(Only A-Z, a-z, 0-9, ?, !, @, & are allowed)"
                    return;
                }
                format = /[a-zA-Z0-9]/;
                if (!format.test(value.trim())) {
                    document.getElementById("new_bot_error_div_div-drop-down-widget").innerHTML = "Invalid choice name(Choice name must contain at least one alphanumeric character)"
                    return;
                }
                var drop_down_list = get_drop_down_list()
                var check_duplicates_list = check_duplicates_for_value(value, drop_down_list)
                if (check_duplicates_list) {
                    document.getElementById("new_bot_error_div_div-drop-down-widget").innerHTML = "Choice already exists(All choices must be different)"

                } else {
                    add_drop_down_choices_collection(value.trim());
                }
                document.getElementById("add_drop_down_choices").value = "";
            }
        });
    }

}

function un_entity(str) {
    str = $("<textarea></textarea>").html(str).text();
    str = str.replace(/<([a-z][a-z0-9]*)[^>]*?(\/?)>/sg, "<$1$2>");
    return str;
}

function save_intent(add_other_intent = false, e) {
    value = $("#add_enter_intent_training_data").val();
    if (value != "") {
        addIntentTrainingDataIntoCollection(value);
        $("#add_enter_intent_training_data").val("");
    }
    e.preventDefault();
    intent_pk = null

    if (window.location.href.indexOf("intent_pk=") != -1) {

        var url_parameters = get_url_vars();
        intent_pk = url_parameters["intent_pk"];
    }

    intent_name = $('#intent_name').val().trim();

    if (intent_name == "") {
        M.toast({
            "html": "Intent name cannot be empty."
        }, 2000);
        return;
    }

    // To check only emoji is present or not 
    var emoji_regex = /^(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|[\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|[\ud83c[\ude32-\ude3a]|[\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])+$/;
    raw_intent = intent_name.split(" ").join("")
    const emoji_test_reg = emoji_regex.test(raw_intent);

    if (emoji_test_reg) {
        M.toast({
            "html": "Intent name cannot have only Emoji."
        }, 2000);
        return;
    }

    multilingual_intent_elm = document.getElementById("multilingual_intent_name")
    multilingual_intent_name = ""
    if (multilingual_intent_elm != null && multilingual_intent_elm != undefined) {
        multilingual_intent_name = multilingual_intent_elm.value
    }
    selected_bot_pk_list = [$("#multiple-select-bot-choice-pk-list").val()];

    if (selected_bot_pk_list.length == 0) {
        M.toast({
            "html": "Select atleast one bot in which intent will be supported"
        }, 2000);
        return;
    }

    training_data_list = []
    var inputs = document.getElementsByTagName("input");
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf('trainingdatastr_') == 0) {
            data_id = "#" + inputs[i].id;
            training_data = $(data_id).val();
            if (training_data != "") {
                training_data_list.push(training_data);
            }
        }
    }

    if (training_data_list.length == 0) {
        M.toast({
            "html": "At least one training sentence is required."
        }, 2000);
        return;
    }

    let response_present = ['text'];

    recommended_intent_list = $("#multiple-select-intent-choice-list").val();
    var child_choices = $("#multiple-select-child-choices").val();

    if (recommended_intent_list.length > 0) {
        response_present.push('quick_recommendations');
    }

    intent_bot_response_text_text = $("#intent_bot_response_text_text").trumbowyg('html');
    intent_bot_response_text_speech = $("#intent_bot_response_text_speech").trumbowyg('html');
    intent_bot_response_reprompt = $("#intent_bot_response_reprompt").trumbowyg('html');
    intent_bot_response_ssml = $("#intent_bot_response_ssml").val();

    intent_bot_response_text_text = intent_bot_response_text_text.replace(new RegExp('\r?<br />', 'g'), '<br>');

    if (validate_ck_editor_response(intent_bot_response_text_text) != "" && validate_ck_editor_response(intent_bot_response_text_speech) == "") {
        intent_bot_response_text_speech = intent_bot_response_text_text
    }

    if (validate_ck_editor_response(intent_bot_response_text_text) == "") {
        M.toast({
            "html": "At least one text/speech response required."
        }, 2000);
        return;
    }
    var is_feedback_required = false;
    feedback_element = document.getElementById('checkbox-intent-feedback');
    if (feedback_element != null && feedback_element != undefined) {
        is_feedback_required = document.getElementById('checkbox-intent-feedback').checked;
    }
    if(is_feedback_required){
        response_present.push("intent_level_feedback");
    }
    var is_attachment_required = false
    if (selected_widget == "div-file-attach-widget")
        is_attachment_required = true
    var is_save_attachment_required = document.getElementById('checkbox-intent-save-attachment').checked;
    var choosen_file_type = document.getElementById('choosen_file_type').value;

    var is_go_back_enabled = false;
    if (document.getElementById('checkbox-tree-go-back-enabled')) {
        is_go_back_enabled = document.getElementById('checkbox-tree-go-back-enabled').checked;
    }

    is_faq_intent = document.getElementById('checkbox_faq_intent').checked;
    is_part_of_suggestion_list = document.getElementById('checkbox-intent-part-of-suggestionList').checked;
    is_small_talk = document.getElementById('checkbox-small-talk-enabled').checked;

    if (is_attachment_required && choosen_file_type == "") {

        M.toast({
            "html": "Please select file type."
        }, 2000);
        return;
    }

    if (is_attachment_required) {
        response_present.push('file_attach');
    }

    var is_livechat_enabled = false;
    element_livechat_enabled = document.getElementById('checkbox-intent-livechat-enabled');

    if (element_livechat_enabled != undefined && element_livechat_enabled != null) {
        is_livechat_enabled = element_livechat_enabled.checked;
    }

    var is_authentication_required = false;
    element_checkbox_authentication = document.getElementById('checkbox-intent-authentication');
    if (element_checkbox_authentication != null && element_checkbox_authentication != undefined) {
        is_authentication_required = element_checkbox_authentication.checked;
    }

    var is_child_intent_visible = "None";
    element_child_intent_visible = document.getElementById("checkbox-intent-child-tree-options-visible");
    if (element_child_intent_visible != null && element_child_intent_visible != undefined) {
        is_child_intent_visible = element_child_intent_visible.checked;
    }

    var authentication_id = "None";
    try {
        authentication_id = $("#select-user-authentication").val();
        if (is_authentication_required) {
            if (authentication_id == null || authentication_id == undefined) {
                M.toast({
                    "html": "Please select authentication type."
                });
                return;
            }
        } else {
            authentication_id = "None";
        }
    } catch (err) {
        console.log(err);
    }

    selected_channels_list = $("#multiple-select-intent-channel-list").val();
    var intent_response_list = [{
        "text_response": intent_bot_response_text_text,
        "speech_response": intent_bot_response_text_speech,
        "hinglish_response": "",
        "reprompt_response": intent_bot_response_reprompt,
        "ssml_response": intent_bot_response_ssml,
    }];

    image_list = []
    var inputs = document.getElementsByTagName("input");
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf("imageurl_intent_image_url_") == 0) {
            data_id = inputs[i].id;
            token_id = data_id.split("_")[4];
            image_url = $("#imageurl_intent_image_url_" + token_id).val();
            image_url = store_this_data_locally(image_url)
            image_list.push(image_url);
        }
    }

    if (image_list.length > 0) {
        response_present.push('image');
    }

    video_list = []
    var inputs = document.getElementsByTagName("input");
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf("videourl_intent_video_url_") == 0) {
            data_id = inputs[i].id;
            token_id = data_id.split("_")[4];
            video_url = $("#videourl_intent_video_url_" + token_id).val();
            video_list.push(video_url);
        }
    }

    if (video_list.length > 0) {
        response_present.push('video');
    }

    card_list = []
    var spans = document.getElementsByTagName("span");
    for (var i = 0; i < spans.length; i++) {
        if (spans[i].id.indexOf("title_intent_card_") == 0) {
            data_id = spans[i].id;
            token_id = data_id.split("_")[3];
            check_img = document.getElementById("img_url_intent_card_" + token_id);
            card_img_url = '';
            if (check_img) {
                card_img_url = $("#img_url_intent_card_" + token_id).attr("src");
            }
            card_title = document.getElementById("title_intent_card_" + token_id).innerText;
            card_content = $("#content_intent_card_" + token_id).html();
            card_url = $("#link_intent_card_" + token_id).attr("href");
            card_list.push({
                "title": card_title,
                "content": card_content,
                "link": store_this_data_locally(card_url),
                "img_url": store_this_data_locally(card_img_url)
            });
        }
    }

    if (card_list.length > 0) {
        response_present.push('link_cards');
    }

    recommended_intent_list = $("#multiple-select-intent-choice-list").val();

    if (intent_response_list.length == 0) {
        M.toast({
            'html': 'Text response cannot be empty.'
        }, 2000);
        return;
    }

    category_obj_pk = document.getElementById("select-intent-category").value

    if (category_obj_pk == "" || category_obj_pk == null) {
        alert("Please select suitable category for Intent");
        return;
    }

    validator_id = $("#select-user-validator").val();

    rows = document.getElementById('hidden-numbers-rows').innerHTML;
    if (document.getElementById('number-of-rows-table').value != "") {
        rows = document.getElementById('number-of-rows-table').value
    }
    table_input_list_of_list = ""
    if (rows != 0) {
        table_input_list_of_list = check_table_filled()
        if (table_input_list_of_list == false) {
            alert("Table cannot have empty cells");
            return;
        } else {
            response_present.push('table');
        }
    }

    function check_table_filled() {
        rows = document.getElementById('hidden-numbers-rows').innerHTML;
        columns = document.getElementById('hidden-numbers-columns').innerHTML;
        if (document.getElementById('number-of-rows-table').value != "") {
            rows = document.getElementById('number-of-rows-table').value
        }
        if (document.getElementById('number-of-columns-table').value != "") {
            columns = document.getElementById('number-of-columns-table').value
        }
        table_input_list_of_list = []
        for (i = 0; i < rows; i++) {
            row_list = []
            for (j = 0; j < columns; j++) {
                cell_value = document.getElementById('cell-id-' + i.toString() + j.toString()).innerHTML;
                if (cell_value != "") {
                    if (un_entity(cell_value).trim() == "<br>" || un_entity(cell_value).trim() == "")
                        return false
                    else
                        row_list.push(un_entity(cell_value));
                } else {
                    return false
                };

            };
            table_input_list_of_list.push(row_list)
        };
        return table_input_list_of_list
    };
    var explanation = "";

    try {
        explanation = document.getElementById("explanation").value;
    } catch { }

    /* Widgets 
        1. Date Picker
        2. Time Picker
        3. Range Slider
        4. Radio Button
    */

    //Date Picker
    var is_date_picker_allowed = false
    if (selected_widget == "div-date-picker-widget")
        is_date_picker_allowed = true
    var is_single_date_picker_allowed = document.getElementById('checkbox-intent-single-date-picker').checked;
    var is_multi_date_picker_allowed = document.getElementById('checkbox-intent-multi-date-picker').checked;

    if (is_date_picker_allowed) {
        if (is_single_date_picker_allowed == false && is_multi_date_picker_allowed == false) {
            M.toast({
                'html': 'Please select atleast one option.'
            }, 2000);
            return;
        } else {
            response_present.push('date_picker');
        }
    }

    //Time Picker
    var is_time_picker_allowed = false
    if (selected_widget == "div-time-picker-widget")
        is_time_picker_allowed = true
    var is_single_time_picker_allowed = document.getElementById('checkbox-intent-single-time-picker').checked;
    var is_multi_time_picker_allowed = document.getElementById('checkbox-intent-multi-time-picker').checked;
    if (is_time_picker_allowed) {
        if (is_single_time_picker_allowed == false && is_multi_time_picker_allowed == false) {
            M.toast({
                'html': 'Please select atleast one option.'
            }, 2000);
            return;
        } else {
            response_present.push('time_picker');
        }
    }

    // Range Slider
    var is_range_slider_required = false;
    var minimum_range = ""
    var maximum_range = ""
    var range_slider_type = ""
    if (selected_widget == "div-range-slider-widget") {
        is_range_slider_required = true;
        if (document.getElementById('single-range-slider').checked)
            range_slider_type = "single-range-slider";
        else if (document.getElementById('multi-range-slider').checked)
            range_slider_type = "multi-range-slider";
        minimum_range = document.getElementById("range-slider-min-range").value;
        maximum_range = document.getElementById("range-slider-max-range").value;
        minimum_range = parseInt(minimum_range)
        document.getElementById("range-slider-min-range").value = minimum_range
        maximum_range = parseInt(maximum_range)
        document.getElementById("range-slider-max-range").value = maximum_range
        if (range_slider_type == "" || range_slider_type == null || range_slider_type == undefined) {
            M.toast({
                'html': 'Please select a range slider option.'
            }, 2000);
            return;
        }

        if (/^\d+$/.test(minimum_range) == false || /^\d+$/.test(maximum_range) == false) {
            M.toast({
                'html': 'Please enter a valid range.'
            }, 2000);
            return;
        }
        if (minimum_range >= maximum_range) {
            M.toast({
                'html': 'Minimum range should be less than maximum.'
            }, 2000);
            return;
        }

        if (minimum_range >= 9999999999 || maximum_range >= 9999999999) {
            M.toast({
                'html': 'Range values should be less than 10 digits'
            }, 2000);
            return;
        }

        response_present.push('range_slider');
    }

    //Radio Button

    var is_radio_button_allowed = false
    radio_choices_list = []
    if (selected_widget == "div-radio-button-widget") {
        is_radio_button_allowed = true
        var inputs = document.getElementsByTagName("input");
        for (var i = 0; i < inputs.length; i++) {
            if (inputs[i].id.indexOf('radio_button_data_str') == 0) {
                data_id = "#" + inputs[i].id;
                radio_choices = $(data_id).val();
                if (radio_choices != "") {
                    radio_choices_list.push(radio_choices);
                }
            }
        }
        if (radio_choices_list.length == 0) {
            M.toast({
                "html": "At least one choice is required."
            }, 2000);
            return;
        }

        response_present.push('radio_button');

    }

    var post_processor_variable = "";
    try {
        post_processor_variable = document.getElementById('post_processor_variable').value
    } catch { }

    //Checkbox
    var is_check_box_allowed = false
    checkbox_choices_list = []
    if (selected_widget == "div-check-box-widget") {
        is_check_box_allowed = true
        var inputs = document.getElementsByTagName("input");
        for (var i = 0; i < inputs.length; i++) {
            if (inputs[i].id.indexOf('check_box_data_str') == 0) {
                data_id = "#" + inputs[i].id;
                checkbox_choices = $(data_id).val();
                if (checkbox_choices != "") {
                    checkbox_choices_list.push(checkbox_choices);
                }
            }
        }

        if (checkbox_choices_list.length == 0) {
            M.toast({
                "html": "At least one choice is required."
            }, 2000);
            return;
        }
        response_present.push('checkbox');
    }

    //Phone Widget

    var is_phone_widget_enabled = false
    var country_code = "in"
    if (selected_widget == "div-phone-number-widget") {
        is_phone_widget_enabled = true
        var country_code = $("#phone").intlTelInput("getSelectedCountryData")

        country_code = country_code.iso2
        response_present.push('phone_number');

    }


    //Form
    var is_create_form_allowed = false
    if (selected_widget == 'div-create-form-widget')
        is_create_form_allowed = true
    var form_name = ""
    form_fields_list = [];
    if (is_create_form_allowed) {
        form_name = document.getElementById('form_name').value;
        form_name = strip_unwanted_characters(stripHTML(form_name));
        form_name = form_name.trim();
        if (form_name == '') {
            M.toast({
                "html": "Please enter a valid form name"
            }, 2000);
            return;
        }

        let fields_present = document.getElementsByClassName('create-form-field');
        if (fields_present.length == 0) {
            M.toast({
                "html": "Please add atleast one form section"
            }, 2000);
            return;
        }
        for (let i = 0; i < fields_present.length; ++i) {
            let field_id = fields_present[i].id;
            let field_div = document.getElementById(field_id);
            let field_id_num = field_id.split('-')[1]

            let label_name, input_type, placeholder_or_options_elem1, placeholder_or_options_elem2, validator, attachment_type, optional, range_type, calendar_type, dependent;
            placeholder_or_options_elem2 = ""

            label_name = document.getElementById('input_name_' + field_id_num + '_1').value;
            label_name = strip_unwanted_characters(stripHTML(label_name));

            input_type = document.getElementById('input_type_' + field_id_num).value
            // input_type = input_name_mapping(input_type)

            placeholder_or_options_elem1 = document.getElementById('input_selected_type_' + field_id_num + '_3').value;
            validator = document.getElementById('validator_' + field_id_num).value;

            // validator = validator_mapping(validator);

            attachment_type = document.getElementById('file_attach_type_' + field_id_num).value;

            range_type = document.getElementById('range_selector_' + field_id_num).value;

            calendar_type = document.getElementById('calendar_selector_type_' + field_id_num).value;

            optional = document.getElementById('optional-toggle-field-' + field_id_num).checked;

            dependent = document.getElementById('dependent-field-' + field_id_num);

            country_code = $("#phone_number_selector_type_" + field_id_num).intlTelInput("getSelectedCountryData").iso2

            if (dependent) {
                dependent = dependent.checked;
            } else {
                dependent = false;
            }
            let dependent_on = ''
            let dependent_on_label_name = ''
            if (dependent) {
                dependent_on = document.getElementById('dependent_field_dropdown_' + field_id_num).value;
                dependent_on_label_name = document.getElementById('input_name_' + dependent_on + '_1').value
            }

            if (dependent_on == 'Select Dependency') {
                M.toast({
                    "html": "Please select a valid dependency"
                }, 2000);
                return;
            }

            let dependent_fields = document.querySelectorAll('.dependent-dropdown');
            let dependent_ids = []
            for (let j = 0; j < dependent_fields.length; j++) {
                if (dependent_fields[j].value == field_id_num) {
                    dependent_ids.push(dependent_fields[j].id.split('_')[3])
                }
            }
            
            dependent_ids = dependent_ids.join('$$$')

            label_name = label_name.trim();
            if (label_name == "") {
                M.toast({
                    "html": "Please enter a valid label name"
                }, 2000);
                return;
            }

            if (input_type == "") {
                M.toast({
                    "html": "Please enter an input type"
                }, 2000);
                return;
            }

            let placeholder_or_options = placeholder_or_options_elem1;

            if (input_type == 'file_attach') {
                placeholder_or_options = attachment_type
            } else {
                // placeholder_or_options = stripHTML(placeholder_or_options);
                // placeholder_or_options = placeholder_or_options.trim();

                // var values = placeholder_or_options.toLowerCase().split('$$$');
                // var values_set = new Set(values);
                // if (values_set.size != values.length) {
                //     M.toast({
                //         "html": "Please enter unique values for choices in form widget."
                //     }, 2000);
                //     return;
                // }
                if (input_type == "radio") {

                    placeholder_or_options = form_get_radio_button_list(field_id.split("-")[1])
                    placeholder_or_options = placeholder_or_options.join('$$$')

                } else if (input_type == "checkbox") {
                    placeholder_or_options = form_get_check_box_list(field_id.split("-")[1])
                    placeholder_or_options = placeholder_or_options.join('$$$')

                } else if (input_type == "dropdown_list") {
                    placeholder_or_options = form_get_dropdown_list(field_id.split("-")[1])
                    placeholder_or_options = placeholder_or_options.join('$$$')
                } else if (input_type == "range") {
                    var form_range_slider_min_value = document.getElementById("form-range-slider-min-range-" + field_id.split("-")[1]).value;
                    var form_range_slider_max_value = document.getElementById("form-range-slider-max-range-" + field_id.split("-")[1]).value;
                    placeholder_or_options = form_range_slider_min_value + "-" + form_range_slider_max_value;
                }
            }

            if (input_type == "text_field" || input_type == "phone_number") {
                if (placeholder_or_options == "") {
                    M.toast({
                        "html": "Please enter placeholder value"
                    }, 2000);
                    return;
                }
            } else if (!api_integrated_fields.includes(field_id_num) && input_type == "dropdown_list" && placeholder_or_options == "") {
                M.toast({
                    "html": "Please enter at least one and valid dropdown option"
                }, 2000);
                return;
            } else if (!api_integrated_fields.includes(field_id_num) && input_type == "checkbox" && placeholder_or_options == "") {
                M.toast({
                    "html": "Please enter at least one and valid checkbox option"
                }, 2000);
                return;
            } else if (!api_integrated_fields.includes(field_id_num) && input_type == "radio" && placeholder_or_options == "") {
                M.toast({
                    "html": "Please enter at least one and valid radio button option"
                }, 2000);
                return;
            } else if (input_type == "range") {
                if (placeholder_or_options.split('-')[0] == "" || placeholder_or_options.split('-')[1] == "") {
                    M.toast({
                        "html": "Please enter a range"
                    }, 2000);
                    return;
                } else if (placeholder_or_options.split('-').length != 2 || (isNaN(placeholder_or_options.split('-')[0]) || isNaN(placeholder_or_options.split('-')[1]))) {
                    M.toast({
                        "html": "Please enter a valid range"
                    }, 2000);
                    return;
                } else if (parseInt(placeholder_or_options.split('-')[0]) >= parseInt(placeholder_or_options.split('-')[1])) {
                    M.toast({
                        'html': 'Minimum range should be less than maximum.'
                    }, 2000);
                    return;
                }
            } else if (input_type == "file_attach" && (placeholder_or_options == undefined || placeholder_or_options == "")) {
                M.toast({
                    "html": "Please select file type"
                }, 2000);
                return;
            }

            form_fields_list.push({
                label_name: label_name,
                input_type: input_type,
                validator: validator,
                placeholder_or_options: placeholder_or_options,
                optional: optional.toString(),
                range_type: range_type,
                calendar_type: calendar_type,
                field_id_num: field_id_num,
                is_dependent: dependent.toString(),
                dependent_on: dependent_on.toString(),
                dependent_on_label_name: dependent_on_label_name,
                dependent_field_ids: dependent_ids,
                country_code: country_code,
            })
        }

        response_present.push('form');

    }

    //Calender
    var is_calender_picker_allowed = false
    if (selected_widget == "div-calender-picker-widget")
        is_calender_picker_allowed = true
    var is_single_calender_date_picker_allowed = document.getElementById('single-date-picker-radio').checked;
    var is_multi_calender_date_picker_allowed = document.getElementById('custom-date-picker-radio').checked;
    var is_single_calender_time_picker_allowed = document.getElementById('single-time-picker-radio').checked;
    var is_multi_calender_time_picker_allowed = document.getElementById('custom-time-picker-radio').checked;


    var is_calender_date_picker_enabled = document.getElementById('enabledatepicker_switch1').checked
    var is_calender_time_picker_enabled = document.getElementById('enabletimepicker_switch2').checked

    if (is_calender_picker_allowed) {

        if (is_calender_date_picker_enabled) {
            if ((is_single_calender_date_picker_allowed == false && is_multi_calender_date_picker_allowed == false)) {
                M.toast({
                    'html': 'Please select atleast one option in date picker.'
                }, 2000);
                return;
            }
        }

        if (is_calender_time_picker_enabled) {
            if ((is_single_calender_time_picker_allowed == false && is_multi_calender_time_picker_allowed == false)) {
                M.toast({
                    'html': 'Please select atleast one option in time picker.'
                }, 2000);
                return;
            }
        }

        response_present.push('calendar_picker');
    }

    var is_automate_recursion_enabled = false;
    element_checkbox_automate_recursion = document.getElementById("checkbox-automate-recursion");
    if (element_checkbox_automate_recursion != null && element_checkbox_automate_recursion != undefined) {
        is_automate_recursion_enabled = element_checkbox_automate_recursion.checked;
    }

    //Dropdown
    var is_drop_down_allowed = false
    dropdown_choices_list = []
    if (selected_widget == "div-drop-down-widget") {
        is_drop_down_allowed = true
        var inputs = document.getElementsByTagName("input");
        for (var i = 0; i < inputs.length; i++) {
            if (inputs[i].id.indexOf('drop_down_data_str') == 0) {
                data_id = "#" + inputs[i].id;
                dropdown_choices = $(data_id).val();
                if (dropdown_choices != "") {
                    dropdown_choices_list.push(dropdown_choices);
                }
            }
        }
        if (dropdown_choices_list.length == 0) {
            M.toast({
                "html": "At least one choice is required."
            }, 2000);
            return;
        }
        response_present.push('drop_down');
    }
    // Video Recorder
    var is_video_recorder_allowed = false
    if (selected_widget == "div-video-recorder-widget")
        is_video_recorder_allowed = true
    if (is_video_recorder_allowed) {
        response_present.push('video_record')
    }
    var is_save_video_attachment_required = document.getElementById('checkbox-intent-save-video-attachment').checked;

    var is_recommendation_menu = document.getElementById('checkbox-intent-recommendation-menu').checked;
    let is_catalogue_added = document.getElementById('add_catalogue_checkbox').checked;
    let selected_catalogue_sections = []
    $("#select-sections-container span").each((indx, ele) => {
        let section_id = ele.id.split("_")
        section_id = section_id[section_id.length - 1]
        selected_catalogue_sections.push(section_id)
    })
    if (is_catalogue_added && (!selected_catalogue_sections || !selected_catalogue_sections.length)) {
        M.toast({
            "html": "Please select atleast one section for WhatsApp Catalogue"
        }, 2000);
        return;
    }

    let is_catalogue_purchased = document.getElementById("is_item_purchased").checked;

    try {
        var is_category_intent_allowed = document.getElementById("checkbox-cateogry-intent").checked;
        var flow_analytics_variable = document.getElementById('flow_analytics_variable').value
    } catch (err) { }
    //Order of Response
    var order_of_response_result = check_order_of_response(response_present);

    var is_last_tree = false
    try {
        is_last_tree = document.getElementById("checkbox-last-tree").checked
    } catch (err) { }

    var is_exit_tree = false
    try {
        is_exit_tree = document.getElementById("checkbox-exit-tree").checked
    } catch (err) { }

    var is_transfer_tree = false
    try {
        is_transfer_tree = document.getElementById("checkbox-transfer-tree").checked
    } catch (err) {}

    var necessary_keywords = "None";
    if (document.getElementById("easychat_necessary_keywords")) {
        necessary_keywords = document.getElementById("easychat_necessary_keywords").value.trim();
        if (necessary_keywords != "" && !(/^[a-zA-Z ,]+$/.test(necessary_keywords))) {
            M.toast({
                "html": "Necessary keyword should not contain digits and special characters other than comma."
            }, 2000);
            return;
        }
    }

    var restricted_keywords = "None";
    if (document.getElementById("easychat_restricted_keywords")) {
        restricted_keywords = document.getElementById("easychat_restricted_keywords").value.trim();
        if (restricted_keywords != "" && !(/^[a-zA-Z ,]+$/.test(restricted_keywords))) {
            M.toast({
                "html": "Restricted keyword should not contain digits and special characters other than comma."
            }, 2000);
            return;
        }
    }

    var intent_threshold = "None";
    if (document.getElementById("easychat-intent-threshold")) {
        intent_threshold = document.getElementById("easychat-intent-threshold").value;
    }

    var whatsapp_list_message_header = document.getElementById("whatsapp-list-message-header").value;
    if (whatsapp_list_message_header == "" && selected_channels_list.includes("WhatsApp")) {
        M.toast({
            'html': 'Please enter whatsapp list message header.'
        }, 2000);
        return;
    } else if (whatsapp_list_message_header.length > 20) {
        M.toast({
            'html': 'Whatsapp list message header cannot be greater than 20 characters. Please enter a valid list message header.'
        }, 2000);
        return;
    }
    let intent_short_name = $('#enter_intent_short_name').val().trim();
    if(selected_channels_list.includes("GoogleBusinessMessages")){
        if(intent_short_name.length > 25){
            M.toast({
                "html": "Intent short name cannot more than 25 characters."
            }, 2000);
            return
        }
    }

    if (is_enable_intent_icon) {

        var intent_icon_active_elements = document.getElementsByClassName("easychat-active-intent-icon");

        if (intent_icon_active_elements.length < 1) {
            M.toast({
                'html': 'Please select atleast one intent icon.'
            }, 2000);
            return;
        } else if (intent_icon_active_elements > 1) {
            M.toast({
                'html': 'Please select only one intent icon.'
            }, 2000);
            return;
        } else {
            var intent_icon_unique_id = intent_icon_active_elements[0].getAttribute("icon_unique_id");
        }
    } else {
        var intent_icon_unique_id = "";
    }

    var allow_barge = document.getElementById("checkbox-allow-barge").checked;
    var disposition_code = document.getElementById("disposition_code").value;

    var enable_whatsapp_menu_format = false;
    if (document.getElementById("whatsapp_menu_collapsible") && document.getElementById("whatsapp_menu_collapsible").style.display != 'none') {
        enable_whatsapp_menu_format = document.getElementById("enable_whatsapp_menu_format").checked;
        if (enable_whatsapp_menu_format) {
            var whatsapp_menu_section_cards = document.getElementsByClassName("easychat-whatsapp-menu-item-wrapper");
            if (!whatsapp_menu_section_cards.length) {
                M.toast({
                    "html": "Please add at least one section in menu format"
                }, 2000);
                return;
            }

            var total_options_selected = document.querySelectorAll(".child-tree").length + document.querySelectorAll(".main-intent").length;
            if (total_options_selected < 4) {
                M.toast({
                    "html": "Total quick recommendations and child intents selected in whatsapp chatbot menu should be greater than 3."
                }, 2000);
                return;
            } else if (total_options_selected > 10) {
                M.toast({
                    "html": "Total quick recommendations and child intents selected in whatsapp chatbot menu should be less than 11."
                }, 2000);
                return;
            }
        }
    }

    if (disposition_code.length > 25) {
        M.toast({
            "html": "Disposition code cannot be more than 25 characters."
        }, 2000);
        return;
    }

    var whatsapp_short_name = "";
    if (document.getElementById("whatsapp-short-name-input")) {
        whatsapp_short_name = document.getElementById("whatsapp-short-name-input").value;
        if (whatsapp_short_name.length == 0 && enable_whatsapp_menu_format) {
            M.toast({
                "html": "Whatsapp button title cannot be empty."
            }, 2000);
            return;
        }
    }
    
    var whatsapp_description = "";
    if (document.getElementById("whatsapp-description-input")) {
        whatsapp_description = document.getElementById("whatsapp-description-input").value;
        if (whatsapp_description.length == 0 && enable_whatsapp_menu_format) {
            M.toast({
                "html": "Whatsapp description cannot be empty."
            }, 2000);
            return;
        }
    }

    disable_save_intent_buttons();

    json_string = JSON.stringify({
        intent_pk: intent_pk,
        intent_name: intent_name,
        intent_short_name:intent_short_name,
        multilingual_name: multilingual_intent_name,
        training_data: training_data_list,
        is_feedback_required: is_feedback_required,
        is_attachment_required: is_attachment_required,
        choosen_file_type: choosen_file_type,
        is_part_of_suggestion_list: is_part_of_suggestion_list,
        is_livechat_enabled: is_livechat_enabled,
        is_authentication_required: is_authentication_required,
        is_small_talk: is_small_talk,
        channel_list: selected_channels_list,
        is_child_intent_visible: is_child_intent_visible,
        selected_bot_pk_list: selected_bot_pk_list,
        response_sentence_list: intent_response_list,
        image_list: image_list,
        video_list: video_list,
        recommended_intent_list: recommended_intent_list,
        child_choices: child_choices,
        card_list: card_list,
        authentication_id: authentication_id,
        validator_id: validator_id,
        table_input_list_of_list: table_input_list_of_list,
        category_obj_pk: category_obj_pk,
        is_automate_recursion_enabled: is_automate_recursion_enabled,
        is_save_attachment_required: is_save_attachment_required,
        is_date_picker_allowed: is_date_picker_allowed,
        is_time_picker_allowed: is_time_picker_allowed,
        is_single_date_picker_allowed: is_single_date_picker_allowed,
        is_multi_date_picker_allowed: is_multi_date_picker_allowed,
        is_single_time_picker_allowed: is_single_time_picker_allowed,
        is_multi_time_picker_allowed: is_multi_time_picker_allowed,
        is_calender_picker_allowed: is_calender_picker_allowed,
        is_single_calender_date_picker_allowed: is_single_calender_date_picker_allowed,
        is_multi_calender_date_picker_allowed: is_multi_calender_date_picker_allowed,
        is_single_calender_time_picker_allowed: is_single_calender_time_picker_allowed,
        is_multi_calender_time_picker_allowed: is_multi_calender_time_picker_allowed,
        is_range_slider_required: is_range_slider_required,
        range_slider_type: range_slider_type,
        minimum_range: minimum_range,
        maximum_range: maximum_range,
        is_radio_button_allowed: is_radio_button_allowed,
        radio_button_choices: radio_choices_list,
        explanation: explanation,
        post_processor_variable: post_processor_variable,
        is_check_box_allowed: is_check_box_allowed,
        checkbox_choices_list: checkbox_choices_list,
        is_drop_down_allowed: is_drop_down_allowed,
        dropdown_choices_list: dropdown_choices_list,
        is_video_recorder_allowed: is_video_recorder_allowed,
        is_save_video_attachment_required: is_save_video_attachment_required,
        is_phone_widget_enabled: is_phone_widget_enabled,
        country_code: country_code,
        is_create_form_allowed: is_create_form_allowed,
        form_name: form_name,
        form_fields_list: form_fields_list,
        is_go_back_enabled: is_go_back_enabled,
        is_recommendation_menu: is_recommendation_menu,
        is_catalogue_added: is_catalogue_added,
        selected_catalogue_sections: selected_catalogue_sections,
        is_catalogue_purchased: is_catalogue_purchased,
        flow_analytics_variable: flow_analytics_variable,
        is_category_intent_allowed: is_category_intent_allowed,
        is_custom_order_selected: order_of_response_result.is_custom_order_selected,
        order_of_response: order_of_response_result.final_order_of_response,
        is_last_tree: is_last_tree,
        is_exit_tree: is_exit_tree,
        is_transfer_tree: is_transfer_tree,
        necessary_keywords: necessary_keywords,
        restricted_keywords: restricted_keywords,
        intent_threshold: intent_threshold,
        whatsapp_list_message_header: whatsapp_list_message_header,
        intent_icon_unique_id: intent_icon_unique_id,
        allow_barge: allow_barge,
        is_faq_intent: is_faq_intent,
        disposition_code: disposition_code,
        enable_whatsapp_menu_format: enable_whatsapp_menu_format,
        whatsapp_short_name: whatsapp_short_name,
        whatsapp_description: whatsapp_description,
    });
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: '/chat/save-intent/',
        type: "POST",
        headers: {
            'X-CSRFToken': get_csrf_token(),
        },
        data: {
            json_string: json_string
        },
        dataType: "json",
        async: false,
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response['status'] == 200) {

                M.toast({
                    'html': "Intent saved successfully!"
                }, 1000);
                setTimeout(function (e) {
                    global_select_intent_id = response["intent_pk"];
                    if (add_other_intent) {

                        window.location = '/chat/create-intent/?bot_pk=' + selected_bot_pk_list[0];
                    } else {
                        window.location = '/chat/edit-intent/?intent_pk=' + global_select_intent_id;
                    }
                }, 1000);
            } else if (response['status'] == 401) {
                M.toast({
                    'html': "Kindly select all the children in child order"
                }, 4000);
                enable_save_intent_buttons();
            } else {
                if (response['status'] == 301) {

                    M.toast({
                        'html': "Intent Name Already Exists"
                    }, 2000);
                } else if (response['status'] == 302) {
                    M.toast({
                        'html': response["status_message"]
                    }, 2000);
                } else if (response['status'] == 303) {
                    M.toast({
                        'html': response["status_message"]
                    }, 2000);
                } else {
                    M.toast({
                        'html': "Unable to save the Intent!"
                    }, 2000);
                }
                enable_save_intent_buttons();
            }
        }
    });
}

function disable_save_intent_buttons() {
    document.getElementById('save-intent').style.pointerEvents = "none";
    document.getElementById('save-intent').style.opacity = "0.5";
    document.getElementById('save-intent-bottom').style.pointerEvents = "none";
    document.getElementById('save-intent-bottom').style.opacity = "0.5";
    document.getElementById('save_add_other_intent').style.pointerEvents = "none";
    document.getElementById('save_add_other_intent').style.opacity = "0.5";
    document.getElementById('save_add_other_intent_bottom').style.pointerEvents = "none";
    document.getElementById('save_add_other_intent_bottom').style.opacity = "0.5";
}

function enable_save_intent_buttons() {
    document.getElementById('save-intent').style.pointerEvents = "auto";
    document.getElementById('save-intent').style.opacity = "1";
    document.getElementById('save-intent-bottom').style.pointerEvents = "auto";
    document.getElementById('save-intent-bottom').style.opacity = "1";
    document.getElementById('save_add_other_intent').style.pointerEvents = "auto";
    document.getElementById('save_add_other_intent').style.opacity = "1";
    document.getElementById('save_add_other_intent_bottom').style.pointerEvents = "auto";
    document.getElementById('save_add_other_intent_bottom').style.opacity = "1";
}


function input_name_mapping(str) {
    if (str == "Text Field")
        return "text_field"
    else if (str == "Dropdown list")
        return "dropdown_list"
    else if (str == "Checkbox")
        return "checkbox"
    else if (str == "Radio Button")
        return "radio"
    else if (str == "Range Slider")
        return "range"
    else if (str == "File Attach")
        return "file_attach"
    else if (str == "Date Picker")
        return "date_picker"
    else if (str == "Time Picker")
        return "time_picker"
    else if (str == "Phone Number")
        return "phone_number"
}

function reverse_input_name_mapping(str) {

    if (str == "text_field")
        return "Text Field"
    else if (str == "dropdown_list")
        return "Dropdown list"
    else if (str == "checkbox")
        return "Checkbox"
    else if (str == "radio")
        return "Radio Button"
    else if (str == "range")
        return "Range Slider"
    else if (str == "file_attach")
        return "File Attach"
    else if (str == "date_picker")
        return "Date Picker"
    else if (str == "time_picker")
        return "Time Picker"
    else if (str == "phone_number")
        return "Phone Number"
}

function validator_mapping(str) {
    if (str == "Choose Validator")
        return "choose_validator"
    else if (str == "6 Digit OTP Validator")
        return "6digitotp_validator"
    else if (str == "4 Digit OTP Validator")
        return "4digitotp_validator"
    else if (str == "Email Validator")
        return "email_validator"
    else if (str == "PAN Validator")
        return "pan_validator"
    else if (str == "Name Validator")
        return "name_validator"
    else if (str == "Mobile Validator")
        return "mobile_validator"
}

function reverse_validator_mapping(str) {
    if (str == "choose_validator")
        return "Choose Validator"
    else if (str == "6digitotp_validator")
        return "6 Digit OTP Validator"
    else if (str == "4digitotp_validator")
        return "4 Digit OTP Validator"
    else if (str == "email_validator")
        return "Email Validator"
    else if (str == "pan_validator")
        return "PAN Validator"
    else if (str == "name_validator")
        return "Name Validator"
    else if (str == "mobile_validator")
        return "Mobile Validator"
}

function check_order_of_response(response_present) {
    var is_custom_order_selected = document.getElementById('custom-order').checked;
    let final_order_of_response = []
    if (!is_custom_order_selected) {
        final_order_of_response = default_order_of_response;
    } else {
        var response_order_elements = document.getElementsByClassName('easychat-intent-response-item');
        var order_of_response = [];
        
        for (el of response_order_elements) {
            order_of_response.push(el.getAttribute("item-name"));
        }
        for (el of order_of_response) {
            if (response_present.includes(el)) {
                final_order_of_response.push(el);
            }
        }
        for (el of response_present) {
            if (!order_of_response.includes(el)) {
                final_order_of_response.push(el);
            }
        }
    }
    return {
        is_custom_order_selected: is_custom_order_selected,
        final_order_of_response: final_order_of_response
    };
}

function render_faq_results() {
    document.getElementById("error_messages").innerHTML = ""
    var selected_bot_pk = get_url_vars()["bot_pk"];
    $.ajax({
        url: "/chat/get-faq-excel-result/",
        type: "GET",
        data: {
            "selected_bot_pk": selected_bot_pk
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response['status'] == 200) {

                document.getElementById("redirect-to-channel").style.display = "block";
            } else if (response["status"] == 305) {

                document.getElementById("error_messages").innerHTML = response["status_message"];
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });

}

function getIntentDetails(bot_filter_list, channel_filter_list) {
    var json_string = JSON.stringify({
        bot_filter_list: bot_filter_list,
        channel_filter_list: channel_filter_list
    });
    json_string = EncryptVariable(json_string);
    $("#manage-intent-preloader").show();
    var json_response = "";
    var response = $.ajax({
        url: '/chat/fetch-all-intents/',
        type: "POST",
        async: false,
        data: {
            data: json_string
        },
        success: function (response) {
            $("#manage-intent-preloader").hide();
            return response;
        }
    }).responseJSON;
    response = custom_decrypt(response)
    response = JSON.parse(response);
    return response;
};

$(document).on("change", "#multiple-select-intent-filter-bot-list", function (e) {
    value = document.getElementById("multiple-select-intent-filter-bot-list").value;
    if (value != "None") {
        let selected_language = get_url_vars()['selected_language']
        if (selected_language == "" || selected_language == undefined || selected_language == null) {
            selected_language = "en";
        }

        window.location = "/chat/intent/?bot_pk=" + value + "&selected_language=" + selected_language;
    }
});

// Render Intent into SideNav
function renderBasicIntentInformation() {
    $("#modify-intent-select-all-checkbox").change(function (e) {
        var status = document.getElementById("modify-intent-select-all-checkbox").checked;
        var inputs = document.getElementsByTagName("input");
        for (var i = 0; i < inputs.length; i++) {
            if (inputs[i].id.indexOf('modify-intent-checkbox-') == 0) {
                data_id = inputs[i].id;
                document.getElementById(data_id).checked = status;
            }
        }
    });

    $(document).on("click", "#modify-intent-delete-selected", function (e) {
        var html = getHTMLOfDeleteIntentModal("modify-intent-delete-selected-modal");
        document.getElementById('div-intent-list-modal-container').innerHTML = html
        $(".modal").modal();
        $("#delete-intent-modal").modal();
        $("#delete-intent-modal").modal('open');
    });

    $(".modify-intent-checkbox").change(function (e) {
        var inputs = document.getElementsByTagName("input");
        var all_selected = 1;
        var delete_intent = false;
        for (var i = 0; i < inputs.length; i++) {
            if (inputs[i].id.indexOf('modify-intent-checkbox-') == 0) {
                data_id = inputs[i].id;
                if (document.getElementById(data_id).checked) {
                    $("#modify-intent-delete-selected").show();
                    delete_intent = true
                } else {
                    all_selected = 0;
                }
            }
        }
        if (all_selected == 1) {
            document.getElementById("modify-intent-select-all-checkbox").checked = true
            return;
        } else if (all_selected == 0) {
            document.getElementById("modify-intent-select-all-checkbox").checked = false
        }

        if (delete_intent == true) {
            return;
        }
        $("#modify-intent-delete-selected").hide();
    });

    // $(document).ready(function() {
    //     $('#intent_info_table').DataTable({
    //         dom: 'Bfrtip',
    //         "pageLength": 200,
    //         "paging": false,
    //         "ordering": false,
    //     });
    // });
}

function do_not_delete_form_assist_tag() {
    $("#delete-tag-modal").modal("close");
}


function delete_form_assist_tag(form_assist_id, bot_id) {
    var json_string = JSON.stringify({
        form_assist_id: form_assist_id,
        bot_id: bot_id
    })
    json_string = EncryptVariable(json_string)

    $.ajax({
        url: '/chat/delete-tag/',
        type: "POST",
        data: {
            json_string: json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Tag deleted successfully"
                }, 2000);
                setTimeout(location.reload(), 2000);
            }
        },
        error: function (error) {

        }
    });
}

function delete_category(category_id, bot_id) {
    var json_string = JSON.stringify({
        category_id: category_id,
        bot_id: bot_id
    })
    json_string = EncryptVariable(json_string)

    $.ajax({
        url: '/chat/delete-category/',
        type: "POST",
        headers: {
            'X-CSRFToken': get_csrf_token(),
        },
        data: {
            json_string: json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Category removed successfully!"
                }, 2000);
                setTimeout(location.reload(), 2000);
            }
        },
        error: function (error) {

        }
    });
}

function save_form_assist_tag(bot_id) {

    var form_assist_tag_id = document.getElementById("form-assist-tag-id").value;
    var form_assist_intent = $("#form-assist-intent").val();
    var form_assist_popup_timer = document.getElementById("form-assist-popup-timer").value;

    if (form_assist_tag_id == "") {
        M.toast({
            "html": "Kindly enter valid tag id"
        }, 2000);
        return;
    } else if (form_assist_intent == "") {
        M.toast({
            "html": "Kindly enter valid intent "
        }, 2000);
        return;
    } else if (form_assist_popup_timer == "") {
        M.toast({
            "html": "Kindly enter valid popup timer "
        }, 2000);
        return;
    }

    if (!(/^\d+$/.test(form_assist_popup_timer))) {
        M.toast({
            "html": "Form assist popup timer should contain only numbers"
        }, 2000);
        return;
    }

    if (parseInt(form_assist_popup_timer) < 0 || parseInt(form_assist_popup_timer) > 300) {
        form_assist_popup_timer = 10;
    }

    document.getElementById('form-assist-tag-save-btn').style.pointerEvents = "none";
    document.getElementById('form-assist-tag-save-btn').style.opacity = "0.5";

    json_string = JSON.stringify({
        bot_id: bot_id,
        form_assist_id: "",
        form_assist_tag_id: form_assist_tag_id,
        form_assist_intent: form_assist_intent,
        form_assist_popup_timer: form_assist_popup_timer
    });

    json_string = EncryptVariable(json_string)

    $.ajax({
        url: '/chat/save-tag/',
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "New Tag Saved Successfully!"
                }, 2000);
                $("#add-new-tag-modal").modal("close");
                setTimeout(location.reload(), 2000);
            } else if (response["status"] == 301) {
                M.toast({
                    "html": "Already Exist!"
                }, 2000);
                $("#add-new-tag-modal").modal("close");
                setTimeout(location.reload(), 2000);
            } else if (response["status"] == 300) {
                M.toast({
                    "html": response["message"]
                }, 2000);
                document.getElementById('form-assist-tag-save-btn').style.pointerEvents = "auto";
                document.getElementById('form-assist-tag-save-btn').style.opacity = "1";
            }
        },
        error: function (error) {
            console.log("Error in Save new Tag");
            document.getElementById('form-assist-tag-save-btn').style.pointerEvents = "auto";
            document.getElementById('form-assist-tag-save-btn').style.opacity = "1";
        }


    });
}


function edit_save_form_assist_tag(bot_id, form_assist_id) {

    var form_assist_tag_id = document.getElementById("form-assist-tag-id-" + form_assist_id).value;
    var form_assist_intent = $("#form-assist-intent-" + form_assist_id).val();
    var form_assist_popup_timer = document.getElementById("form-assist-popup-timer-" + form_assist_id).value;

    if (form_assist_tag_id == "") {
        M.toast({
            "html": "Kindly enter valid tag id"
        }, 2000);
        return;
    } else if (form_assist_intent == "") {
        M.toast({
            "html": "Kindly enter valid Bot Response"
        }, 2000);
        return;
    } else if (form_assist_popup_timer == "") {
        M.toast({
            "html": "Kindly enter valid popup timer "
        }, 2000);
        return;
    }

    if (!(/^\d+$/.test(form_assist_popup_timer))) {
        M.toast({
            "html": "Form assist popup timer should contain only numbers"
        }, 2000);
        return;
    }

    if (parseInt(form_assist_popup_timer) < 0 || parseInt(form_assist_popup_timer) > 300) {
        form_assist_popup_timer = 10;
    }

    json_string = JSON.stringify({
        bot_id: bot_id,
        form_assist_id: form_assist_id,
        form_assist_tag_id: form_assist_tag_id,
        form_assist_intent: form_assist_intent,
        form_assist_popup_timer: form_assist_popup_timer
    });
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: '/chat/edit-tag/',
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Tag Edited Successfully!"
                }, 2000);
                $("#edit-new-tag-modal-" + form_assist_id).modal("close");
                setTimeout(location.reload(), 2000);
            } else if (response["status"] == 301) {
                M.toast({
                    "html": "Already Exists!"
                }, 2000);
                $("#edit-new-tag-modal-" + form_assist_id).modal("close");
                setTimeout(location.reload(), 2000);
            } else if (response["status"] == 300) {
                M.toast({
                    "html": response["message"]
                }, 2000);
            }
        },
        error: function (error) {
            console.log("Error in Save new Tag");
        }


    });
}


function save_category(bot_id, category_id, edit_mode = false) {
    if (edit_mode) {
        var category_name = document.getElementById("category-id-" + category_id).value.trim();
    } else {
        var category_name = document.getElementById("category-id").value.trim();
    }
    if (category_name.trim() == "") {
        M.toast({
            "html": "Kindly enter valid category name"
        }, 2000);
        return;
    }

    if (category_name.length > character_limit_small_text) {
        M.toast({
            "html": "Exceeding character limit of " + character_limit_small_text + " characters"
        }, 2000);
        return;
    }

    let check_emoji_only_string = remove_special_and_emoji_chars(category_name)
    
    if (check_emoji_only_string == '') {
        M.toast({
            "html": "Bot name should have atleast one alphanumeric character."
        }, 2000);
        return;
    }

    json_string = JSON.stringify({
        bot_id: bot_id,
        category_id: category_id,
        category_name: category_name.trim(),
    });

    json_string = EncryptVariable(json_string)

    $.ajax({
        url: '/chat/save-category/',
        type: "POST",
        headers: {
            'X-CSRFToken': get_csrf_token(),
        },
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                let category_saved_toast_text = "New category Saved Successfully!"
                if (edit_mode) {
                    category_saved_toast_text = "Category edited successfully!"
                }
                M.toast({
                    "html": category_saved_toast_text
                }, 2000);
                $("#add-new-category-modal").modal("close");
                setTimeout(location.reload(), 2000);
            } else if (response["status"] == 301) {
                M.toast({
                    "html": "Category Already Exist!"
                }, 2000);
            } else if (response["status"] == 500) {
                M.toast({
                    "html": "Internal Server Error!"
                }, 2000);
            } else {
                M.toast({
                    "html": response.message
                }, 2000);
            }
        },
        error: function (error) { }


    });
}

$(document).on("change", "#select-intent-filter-form-assist-bot-list", function (e) {
    renderBasicFormAssistInformation();
});

function renderBasicFormAssistInformation() {

    var form_assist_bot_id = $("#select-intent-filter-form-assist-bot-list").val();

    if (form_assist_bot_id != "") {
        window.location = "/chat/form-assist/?bot_id=" + form_assist_bot_id;
    } else {
        window.location = "/chat/categories/";
    }

}

$(document).on("change", "#select-intent-filter-category-bot-list", function (e) {
    renderBasicCategoryInformation();
});

function renderBasicCategoryInformation() {

    var category_bot_id = $("#select-intent-filter-category-bot-list").val();

    if (category_bot_id != "")
        window.location = "/chat/categories/?bot_id=" + category_bot_id;

}
$(document).on("change", "#select-lead-generation-bot", function (e) {
    renderBasicLeadGenerationInformation();
});

function renderBasicLeadGenerationInformation() {

    var lead_generation_bot_id = $("#select-lead-generation-bot").val();

    if (lead_generation_bot_id != "")
        window.location = "/chat/lead-generation/?bot_id=" + lead_generation_bot_id;

}

function searchInfo(table_id, number_of_columns) {

    var input, filter, table, tr, td, i;
    input = document.getElementById("global_search");
    filter = input.value.toUpperCase();
    table = document.getElementById(table_id);
    tr = table.getElementsByTagName("tr");
    no_data_shown = true
    for (var i = 1; i < tr.length; i++) {

        var display_status = false;
        for (var j = 0; j < number_of_columns; j++) {
            th = tr[i].getElementsByTagName("td")[j];
            if (th) {
                if (th.innerHTML.toUpperCase().indexOf(filter) > -1) {
                    display_status = true;
                    break;
                }
            }
        }

        if (display_status) {
            tr[i].style.display = "";
            no_data_shown = false
        } else {
            tr[i].style.display = "none";
        }
    }
    if (document.getElementById("pagination_message_history") != null) {
        if (no_data_shown == true) {
            document.getElementById("pagination_message_history").style.display = "none";
        } else {
            document.getElementById("pagination_message_history").style.display = "";
        }
    }
}


function duplicates_exists(arr) {
    let sorted_arr = arr.slice().sort();
    let results = [];
    for (let i = 0; i < sorted_arr.length - 1; i++) {
        if (sorted_arr[i + 1].toString().toLowerCase().replace(/\s/g, '').trim() == sorted_arr[i].toString().toLowerCase().replace(/\s/g, '').trim()) {
            return true;
        }
    }
    return false;
}

function check_duplicates_for_value(value, arr) {
    for (let i = 0; i < arr.length; i++) {
        if (arr[i].toString().toLowerCase().replace(/\s/g, '').trim() == value.toLowerCase().replace(/\s/g, '').trim()) {
            return true;
        }
    }
    return false;
}

async function select_widget(id, check_validations = false) {
    //new code
    if (check_validations) {
        if (id == "div-file-attach-widget") {

            var file_attachment_allowed = document.getElementById("checkbox-intent-attachment").checked
            var choosen_file_type = document.getElementById('choosen_file_type').value;

            if (file_attachment_allowed == false) {
                M.toast({
                    "html": "Please check the attachment required field."
                }, 2000);
                return;

            }

            if (choosen_file_type == "") {

                M.toast({
                    "html": "Please select file type."
                }, 2000);
                return;
            }

            $('#modal-file-attachment').modal('close');

        } else if (id == "div-calender-picker-widget") {
            var is_single_calender_date_picker_allowed = document.getElementById('single-date-picker-radio').checked;
            var is_multi_calender_date_picker_allowed = document.getElementById('custom-date-picker-radio').checked;
            var is_single_calender_time_picker_allowed = document.getElementById('single-time-picker-radio').checked;
            var is_multi_calender_time_picker_allowed = document.getElementById('custom-time-picker-radio').checked;


            var is_calender_date_picker_enabled = document.getElementById('enabledatepicker_switch1').checked
            var is_calender_time_picker_enabled = document.getElementById('enabletimepicker_switch2').checked
            if (is_calender_date_picker_enabled == false && is_calender_time_picker_enabled == false) {
                {
                    M.toast({
                        'html': 'Please select atleast one picker.'
                    }, 2000);
                    return;
                }
            }

            if (is_calender_date_picker_enabled) {
                if ((is_single_calender_date_picker_allowed == false && is_multi_calender_date_picker_allowed == false)) {
                    M.toast({
                        'html': 'Please select atleast one option in date picker.'
                    }, 2000);
                    return;
                }
            }

            if (is_calender_time_picker_enabled) {
                if ((is_single_calender_time_picker_allowed == false && is_multi_calender_time_picker_allowed == false)) {
                    M.toast({
                        'html': 'Please select atleast one option in time picker.'
                    }, 2000);
                    return;
                }
            }

            $('#modal-calender-picker').modal('close');

        } else if (id == "div-radio-button-widget") {
            var radio_choices_list = []
            var inputs = document.getElementsByTagName("input");
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].id.indexOf('radio_button_data_str') == 0) {
                    data_id = "#" + inputs[i].id;
                    radio_choices = $(data_id).val();
                    if (radio_choices != "") {
                        radio_choices_list.push(radio_choices);
                    }
                }
            }
            if (radio_choices_list.length == 0) {
                M.toast({
                    "html": "At least one choice is required."
                }, 2000);
                return;
            }

            $('#modal-radio-button').modal('close');

        } else if (id == "div-check-box-widget") {
            var checkbox_choices_list = []
            var inputs = document.getElementsByTagName("input");
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].id.indexOf('check_box_data_str') == 0) {
                    data_id = "#" + inputs[i].id;
                    checkbox_choices = $(data_id).val();
                    if (checkbox_choices != "") {
                        checkbox_choices_list.push(checkbox_choices);
                    }
                }
            }

            if (checkbox_choices_list.length == 0) {
                M.toast({
                    "html": "At least one choice is required."
                }, 2000);
                return;
            }
            $('#modal-check-box').modal('close');
        }
        else if (id == "div-drop-down-widget") {
            var dropdown_choices_list = []
            var inputs = document.getElementsByTagName("input");
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].id.indexOf('drop_down_data_str') == 0) {
                    data_id = "#" + inputs[i].id;
                    dropdown_choices = $(data_id).val();
                    if (dropdown_choices != "") {
                        dropdown_choices_list.push(dropdown_choices);
                    }
                }
            }
            if (dropdown_choices_list.length == 0) {
                M.toast({
                    "html": "At least one choice is required."
                }, 2000);
                return;
            }

            $('#modal-drop-down').modal('close');
        }
        else if (id == "div-range-slider-widget") {
            var maximum_range = ""
            var minimum_range = ""
            var range_slider_type = ""
            if (document.getElementById('single-range-slider').checked)
                range_slider_type = "single-range-slider";
            else if (document.getElementById('multi-range-slider').checked)
                range_slider_type = "multi-range-slider";
            minimum_range = document.getElementById("range-slider-min-range").value;
            maximum_range = document.getElementById("range-slider-max-range").value;
            minimum_range = parseInt(minimum_range)
            document.getElementById("range-slider-min-range").value = minimum_range
            maximum_range = parseInt(maximum_range)
            document.getElementById("range-slider-max-range").value = maximum_range
            if (range_slider_type == "" || range_slider_type == null || range_slider_type == undefined) {
                M.toast({
                    'html': 'Please select a range slider option.'
                }, 2000);
                return;
            }

            if (/^\d+$/.test(minimum_range) == false || /^\d+$/.test(maximum_range) == false) {
                M.toast({
                    'html': 'Please enter a valid range.'
                }, 2000);
                return;
            }
            if (minimum_range >= maximum_range) {
                M.toast({
                    'html': 'Minimum range should be less than maximum.'
                }, 2000);
                return;
            }

            if (minimum_range >= 9999999999 || maximum_range >= 9999999999) {
                M.toast({
                    'html': 'Range values should be less than 10 digits'
                }, 2000);
                return;
            }
            $('#modal-range-slider').modal('close');
        }
        else if (id == "div-video-recorder-widget") {
            var video_recorder_allowed = document.getElementById("checkbox-intent-video-recorder").checked

            if (video_recorder_allowed == false) {
                M.toast({
                    'html': 'Please check the video recorder'
                }, 2000);
                return;
            }
            $('#modal-video-recorder').modal('close');
        }
        else if (id == "div-phone-number-widget") {
            var country_code_switch = document.getElementById("enablecountrycode_switch").checked
            if (!country_code_switch) {
                M.toast({
                    'html': 'Please enable the country code'
                }, 2000);
                return;
            } 

            $('#modal-phone-num').modal('close');

        } 
        else if (id == "div-create-form-widget") {
            var form_name = ""
            var form_fields_list = [];
            form_name = document.getElementById('form_name').value;
            form_name = strip_unwanted_characters(stripHTML(form_name));
            form_name = form_name.trim();
            if (form_name == '') {
                M.toast({
                    "html": "Please enter a valid form name"
                }, 2000);
                return;
            }

            let fields_present = document.getElementsByClassName('create-form-field');
            if (fields_present.length == 0) {
                M.toast({
                    "html": "Please add atleast one form section"
                }, 2000);
                return;
            }
            await update_form_widget_api_integration_status();
            for (let i = 0; i < fields_present.length; ++i) {
                let field_id = fields_present[i].id;
                let field_div = document.getElementById(field_id);
                let field_id_num = field_id.split('-')[1]

                let label_name, input_type, placeholder_or_options_elem1, placeholder_or_options_elem2, validator, attachment_type, optional, range_type, calendar_type, dependent, dependent_on;
                placeholder_or_options_elem2 = ""

                label_name = document.getElementById('input_name_' + field_id_num + '_1').value;
                label_name = strip_unwanted_characters(stripHTML(label_name));

                input_type = document.getElementById('input_type_' + field_id_num).value
                // input_type = input_name_mapping(input_type)

                placeholder_or_options_elem1 = document.getElementById('input_selected_type_' + field_id_num + '_3').value;
                validator = document.getElementById('validator_' + field_id_num).value;

                // validator = validator_mapping(validator);

                attachment_type = document.getElementById('file_attach_type_' + field_id_num).value;

                range_type = document.getElementById('range_selector_' + field_id_num).value;

                calendar_type = document.getElementById('calendar_selector_type_' + field_id_num).value;

                optional = document.getElementById('optional-toggle-field-' + field_id_num).checked;

                dependent = document.getElementById('dependent-field-' + field_id_num);

                country_code = $("#phone_number_selector_type_" + field_id_num).intlTelInput("getSelectedCountryData").iso2

                if (dependent) {
                    dependent = dependent.checked;
                }

                if (dependent) {
                    dependent_on = document.getElementById('dependent_field_dropdown_' + field_id_num).value;
                }

                if (dependent_on == 'Select Dependency') {
                    M.toast({
                        "html": "Please select a valid dependency"
                    }, 2000);
                    return;
                }

                // let text_elem = placeholder_or_options_elem1;
                // let select_elem = placeholder_or_options_elem2;
                // if (text_elem.tagName == 'SELECT') {
                //     text_elem = placeholder_or_options_elem2;
                //     select_elem = placeholder_or_options_elem1;
                // }

                label_name = label_name.trim();
                if (label_name == "") {
                    M.toast({
                        "html": "Please enter a valid label name"
                    }, 2000);
                    return;
                }

                if (check_if_label_name_exists(field_id_num)) {
                    M.toast({
                        "html": "Duplicate label names are not allowed."
                    }, 2000);
                    return;
                }

                if (input_type == "") {
                    M.toast({
                        "html": "Please enter an input type"
                    }, 2000);
                    return;
                }

                if (dependent && !api_integrated_fields.includes(field_id_num)) {
                    M.toast({
                        "html": "Please integrate API for dependent fields."
                    }, 2000);
                    return;
                }

                let placeholder_or_options = placeholder_or_options_elem1;

                if (input_type == 'file_attach') {
                    placeholder_or_options = attachment_type
                } else {

                    if (input_type == "radio") {

                        placeholder_or_options = form_get_radio_button_list(field_id.split("-")[1])
                        placeholder_or_options = placeholder_or_options.join('$$$')

                    } else if (input_type == "checkbox") {
                        placeholder_or_options = form_get_check_box_list(field_id.split("-")[1])
                        placeholder_or_options = placeholder_or_options.join('$$$')

                    } else if (input_type == "dropdown_list") {
                        placeholder_or_options = form_get_dropdown_list(field_id.split("-")[1])
                        placeholder_or_options = placeholder_or_options.join('$$$')
                    } else if (input_type == "range") {
                        var form_range_slider_min_value = document.getElementById("form-range-slider-min-range-" + field_id.split("-")[1]).value;
                        var form_range_slider_max_value = document.getElementById("form-range-slider-max-range-" + field_id.split("-")[1]).value;
                        placeholder_or_options = form_range_slider_min_value + "-" + form_range_slider_max_value;
                    }
                }

                if (input_type == "text_field" || input_type == "phone_number") {
                    if (placeholder_or_options == "") {
                        M.toast({
                            "html": "Please enter placeholder value"
                        }, 2000);
                        return;
                    }
                } else if (!api_integrated_fields.includes(field_id_num) && input_type == "dropdown_list" && placeholder_or_options == "") {
                    M.toast({
                        "html": "Please enter at least one and valid dropdown option"
                    }, 2000);
                    return;
                } else if (!api_integrated_fields.includes(field_id_num) && input_type == "checkbox" && placeholder_or_options == "") {
                    M.toast({
                        "html": "Please enter at least one and valid checkbox option"
                    }, 2000);
                    return;
                } else if (!api_integrated_fields.includes(field_id_num) && input_type == "radio" && placeholder_or_options == "") {
                    M.toast({
                        "html": "Please enter at least one and valid radio button option"
                    }, 2000);
                    return;
                } else if (input_type == "range") {
                    if (placeholder_or_options.split('-')[0] == "" || placeholder_or_options.split('-')[1] == "") {
                        M.toast({
                            "html": "Please enter a range"
                        }, 2000);
                        return;
                    } else if (placeholder_or_options.split('-').length != 2 || (isNaN(placeholder_or_options.split('-')[0]) || isNaN(placeholder_or_options.split('-')[1]))) {
                        M.toast({
                            "html": "Please enter a valid range"
                        }, 2000);
                        return;
                    } else if (parseInt(placeholder_or_options.split('-')[0]) >= parseInt(placeholder_or_options.split('-')[1])) {
                        M.toast({
                            'html': 'Minimum range should be less than maximum.'
                        }, 2000);
                        return;
                    }
                } else if (input_type == "file_attach" && (placeholder_or_options == undefined || placeholder_or_options == "")) {
                    M.toast({
                        "html": "Please select file type"
                    }, 2000);
                    return;
                }

            }
            $('#modal-create-form').modal('close');
        }

    }

    if (selected_widget != "") {
        $('#' + selected_widget).removeClass("widgetCardSelected")
        $('#' + selected_widget + " .widgetCardPlus").css('visibility', 'hidden')
    }

    selected_widget = id;
    // Deselects and Disables FAQ Intent checkbox if any widget is selected
    if (selected_widget != '') {
        $('#checkbox_faq_intent').prop('checked', false);
        $("#checkbox_faq_intent").attr("disabled", "disabled");
    }
    if (document.getElementById("new_bot_error_div_" + id))
        document.getElementById("new_bot_error_div_" + id).innerHTML = ""

    $('#' + selected_widget).addClass("widgetCardSelected")
    $('#' + selected_widget + " .widgetCardPlus").css('visibility', 'visible')


}

function check_range_slider_validations() {
    var minimum_range = "";
    var maximum_range = "";
    var range_slider_type = "";
    minimum_range = document.getElementById("range-slider-min-range").value;
    maximum_range = document.getElementById("range-slider-max-range").value;
    minimum_range = parseInt(minimum_range)
    maximum_range = parseInt(maximum_range)
    if (document.getElementById('single-range-slider').checked)
        range_slider_type = "single-range-slider";
    else if (document.getElementById('multi-range-slider').checked)
        range_slider_type = "multi-range-slider";
    if (range_slider_type == "" || range_slider_type == null || range_slider_type == undefined) {
        cancel_widget_modal('div-range-slider-widget');
        M.toast({
            'html': 'Please select a range slider option.'
        }, 2000);
        return;
    }

    if (/^\d+$/.test(minimum_range) == false || /^\d+$/.test(maximum_range) == false) {
        cancel_widget_modal('div-range-slider-widget');
        M.toast({
            'html': 'Please enter a valid range.'
        }, 2000);
        return;
    }
    if (minimum_range >= maximum_range) {
        cancel_widget_modal('div-range-slider-widget');
        M.toast({
            'html': 'Minimum range should be less than maximum.'
        }, 2000);
        return;
    }

    if (minimum_range >= 9999999999 || maximum_range >= 9999999999) {
        cancel_widget_modal('div-range-slider-widget');
        M.toast({
            'html': 'Range values should be less than 10 digits'
        }, 2000);
        return;
    }
    $('#modal-range-slider').modal('close');
    select_widget('div-range-slider-widget');
}

function cancel_widget_modal(id) {
    if (document.getElementById("new_bot_error_div_" + id))
        document.getElementById("new_bot_error_div_" + id).innerHTML = ""
    if (selected_widget == id) {
        $('#' + selected_widget).removeClass("widgetCardSelected")
        $('#' + selected_widget + " .widgetCardPlus").css('visibility', 'hidden')
        selected_widget = ""
        if(!is_child_present && !is_quick_recommendation_present) {
            // Enables FAQ Intent checkbox if no widgets are selected and Intent does not have any children
            $("#checkbox_faq_intent").removeAttr("disabled", "disabled"); 
        }
    }


    if (id == 'div-date-picker-widget') {
        document.getElementById("checkbox-intent-date-picker").checked = false;
        document.getElementById("intent-single-date-picker").style.display = "none";
        document.getElementById("intent-multi-date-picker").style.display = "none";
        document.getElementById("checkbox-intent-multi-date-picker").checked = false;
        document.getElementById("checkbox-intent-multi-date-picker").disabled = false;
        document.getElementById("checkbox-intent-single-date-picker").disabled = false;
        document.getElementById("checkbox-intent-single-date-picker").checked = false;
    } else if (id == 'div-time-picker-widget') {
        document.getElementById("checkbox-intent-time-picker").checked = false;
        document.getElementById("intent-single-time-picker").style.display = "none";
        document.getElementById("intent-multi-time-picker").style.display = "none";
        document.getElementById("checkbox-intent-multi-time-picker").disabled = false;
        document.getElementById("checkbox-intent-multi-time-picker").checked = false;
        document.getElementById("checkbox-intent-single-time-picker").disabled = false;
        document.getElementById("checkbox-intent-single-time-picker").checked = false;
    } else if (id == 'div-calender-picker-widget') {

        document.getElementById("enabledatepicker_switch1").checked = false
        document.getElementById("enabletimepicker_switch2").checked = false

        document.querySelector(".single-date").disabled = true;
        document.querySelector(".custom-date").disabled = true;
        document.getElementById('single-date-picker-radio').checked = false
        document.getElementById('custom-date-picker-radio').checked = false

        document.querySelector(".single-time").disabled = true;
        document.querySelector(".custom-time").disabled = true;
        document.getElementById('single-time-picker-radio').checked = false
        document.getElementById('custom-time-picker-radio').checked = false
    } else if (id == 'div-radio-button-widget') {
        document.getElementById("sortable-radio-widget-edit-div").innerHTML = ""
        remove_header('div-radio-button-widget')
    } else if (id == 'div-check-box-widget') {
        document.getElementById("sortable-checkbox-widget-edit-div").innerHTML = ""
        remove_header('div-check-box-widget')
    } else if (id == 'div-drop-down-widget') {
        document.getElementById("sortable-dropdown-widget-edit-div").innerHTML = ""
        remove_header('div-drop-down-widget')
    } else if (id == 'div-video-recorder-widget') {
        document.getElementById("checkbox-intent-video-recorder").checked = false;
        document.getElementById("easychat-save-video-attachment-server").style.display = "none";
        document.getElementById("checkbox-intent-save-video-attachment").checked = false;
    } else if (id == 'div-range-slider-widget') {


    } else if (id == 'div-file-attach-widget') {
        document.getElementById("checkbox-intent-attachment").checked = false;
        document.getElementById("checkbox-intent-save-attachment").checked = false;
        document.getElementById('choosen_file_type').value = ""
        document.getElementById("easychat-attachment-dropdown").style.display = "none";
        document.getElementById("easychat-save-attachment-server").style.display = "none";
    } else if (id == 'div-phone-number-widget') {
        document.getElementById("enablecountrycode_switch").checked = false;
        $('.modal-country-code-wrapper').hide();
    }  
    else if (id == 'div-create-form-widget') {
        $('#create-form-fields').html('')
        $('#form_name').val('')
        $('#sync_preview_modal').html('');
        reset_api_integration('', true)
    }
}

function check_range_slider_div() {
    var single_range_slider = document.getElementById("single-range-slider");
    var multi_range_slider = document.getElementById("multi-range-slider");
    if (single_range_slider.checked || multi_range_slider.checked)
        document.getElementById('range-slider-min-max-value-input-div').style.display = "flex";
    else
        document.getElementById('range-slider-min-max-value-input-div').style.display = "none";
}

if (window.location.pathname == '/chat/edit-intent/') {

    if (window.location.href.indexOf("intent_pk=") != -1) {
        let is_custom_order_selected = document.getElementById('custom-order').checked;
        $('#easychat_order_of_responses').sortable({
            containment: "parent",
        });
        if (is_custom_order_selected) {
            let elem = document.getElementById('easychat_order_of_responses');
            elem.classList.remove('response-order-disabled');
        } else {
            $('#easychat_order_of_responses').sortable('disable');
        }

        var url_parameters = get_url_vars()
        // active_url = window.location.href.replace("#", "");
        // active_url = active_url.replace("!", "");
        // intent_pk = active_url.substring(active_url.indexOf("intent_pk=") + "intent_pk=".length, );
        intent_pk = url_parameters["intent_pk"];
        if (url_parameters["selected_language"] != undefined) {

            selected_language = url_parameters["selected_language"]
        }
        global_select_intent_id = intent_pk;
        loadTemplateSentences();
        renderIntentInformationByID(intent_pk);
        renderTreeStructureByIntentID(intent_pk);
        var checked_val = document.getElementById("checkbox-intent-attachment").checked
        if (checked_val) {
            document.getElementById("easychat-attachment-dropdown").style.display = "table-row";
            document.getElementById("easychat-save-attachment-server").style.display = "table-row";
            select_widget('div-file-attach-widget')
        } else {
            document.getElementById("easychat-attachment-dropdown").style.display = "none";
            document.getElementById("easychat-save-attachment-server").style.display = "none";
        }
        $(document).ready(generate_table);

        var video_attachment_val = document.getElementById("checkbox-intent-video-recorder").checked
        if (video_attachment_val) {
            document.getElementById("easychat-save-video-attachment-server").style.display = "table-row";
            select_widget('div-video-recorder-widget')
        } else {
            document.getElementById("easychat-save-video-attachment-server").style.display = "none";
        }

        var date_checked_val = document.getElementById("checkbox-intent-date-picker").checked
        if (date_checked_val) {
            document.getElementById("intent-single-date-picker").style.display = "block";
            document.getElementById("intent-multi-date-picker").style.display = "block";
            select_widget('div-date-picker-widget')
        } else {
            document.getElementById("intent-single-date-picker").style.display = "none";
            document.getElementById("intent-multi-date-picker").style.display = "none";
        }

        var time_checked_val = document.getElementById("checkbox-intent-time-picker").checked
        if (time_checked_val) {
            document.getElementById("intent-single-time-picker").style.display = "block";
            document.getElementById("intent-multi-time-picker").style.display = "block";
            select_widget('div-time-picker-widget')
        } else {
            document.getElementById("intent-single-time-picker").style.display = "none";
            document.getElementById("intent-multi-time-picker").style.display = "none";
        }

        var calender_checked_val = window.is_calender_picker_allowed
        if (calender_checked_val == "True") {
            calendar_initializations()
            select_widget('div-calender-picker-widget')
        }

        var range_checked_val = window.is_range_slider_required;
        if (range_checked_val == 'True') {
            select_widget('div-range-slider-widget')
            document.getElementById('range-slider-min-max-value-input-div').style.display = "flex";
        } else {
            document.getElementById('range-slider-min-max-value-input-div').style.display = "none";
        }

        var radio_button_val = window.is_radio_btn_allowed

        if (radio_button_val == 'True') {
            select_widget('div-radio-button-widget')
            var values = window.radio_button_choices_values.split("_")
            if (values != []) {
                for (var i = 0; i < values.length; i++) {
                    value = values[i];
                    add_radio_button_choices_collection(value)
                }
            }
        }

        var check_box_val = window.is_check_box_allowed
        if (check_box_val == 'True') {
            select_widget('div-check-box-widget')
            var values = window.check_box_choices_values.split("_")
            if (values != []) {
                for (var i = 0; i < values.length; i++) {
                    value = values[i];
                    add_check_box_choices_collection(value)
                }
            }
        }

        var drop_down_val = window.is_drop_down_allowed
        if (drop_down_val == 'True') {
            select_widget('div-drop-down-widget')
            var values = window.drop_down_choices_values.split("_")
            if (values != []) {
                for (var i = 0; i < values.length; i++) {
                    value = values[i];
                    add_drop_down_choices_collection(value)
                }
            }
        }

        var is_phone_widget_enabled = window.is_phone_widget_enabled
        if (is_phone_widget_enabled == 'True') {
            select_widget('div-phone-number-widget')
            
        }

        var create_form_val = window.is_create_form_allowed;
        if (create_form_val == 'True') {
            let tmp = document.createElement("DIV");
            tmp.innerHTML = window.initial_form_fields;
            var json_string = tmp.textContent || tmp.innerText || ""
            json_string = json_string.replaceAll(`'`, `"`)
            add_initial_form_sections(JSON.parse(json_string))
            tmp.remove()
            document.getElementById('intent-create-form-fields').style.display = "block";
            select_widget('div-create-form-widget')
        } else {

            add_section_in_create_form_modal()

        }

        load_order_of_responses();
    }

    url_string = window.location.href
    url = new URL(url_string);
    sentence_value = url.searchParams.get("val");
    if (sentence_value != null) {
        sentence_list = sentence_value.split(',')

        for (var i = 0; i < sentence_list.length; i++) {
            value = sentence_list[i]
            addIntentTrainingDataIntoCollection(value);
            $("#add_enter_intent_training_data").val("");
        }
        // $("#intent_name").val(sentence_list[0])
        $("#training_sentence_li").addClass('active')
    }
}

function calendar_initializations() {

    if (window.is_single_calender_date_picker_allowed == 'True') {

        document.getElementById("enabledatepicker_switch1").checked = true

        document.querySelector(".single-date").disabled = false;
        document.querySelector(".custom-date").disabled = false;
        document.getElementById('single-date-picker-radio').checked = true
        document.getElementById('custom-date-picker-radio').checked = false
    }

    if (window.is_multi_calender_date_picker_allowed == "True") {
        document.getElementById("enabledatepicker_switch1").checked = true

        document.querySelector(".single-date").disabled = false;
        document.querySelector(".custom-date").disabled = false;
        document.getElementById('single-date-picker-radio').checked = false
        document.getElementById('custom-date-picker-radio').checked = true
    }

    if (window.is_single_calender_time_picker_allowed == "True") {
        document.getElementById("enabletimepicker_switch2").checked = true

        document.querySelector(".single-time").disabled = false;
        document.querySelector(".custom-time").disabled = false;
        document.getElementById('single-time-picker-radio').checked = true
        document.getElementById('custom-time-picker-radio').checked = false
    }

    if (window.is_multi_calender_time_picker_allowed == "True") {
        document.getElementById("enabletimepicker_switch2").checked = true

        document.querySelector(".single-time").disabled = false;
        document.querySelector(".custom-time").disabled = false;
        document.getElementById('single-time-picker-radio').checked = false
        document.getElementById('custom-time-picker-radio').checked = true
    }
}

if (window.location.pathname == '/chat/edit-intent-multilingual/') {

    if (window.location.href.indexOf("intent_pk=") != -1) {

        var url_parameters = get_url_vars()
        intent_pk = url_parameters["intent_pk"];
        set_selected_language_based_on_url_param()

        renderIntentInformationByID(intent_pk);
        renderTreeStructureByIntentID(intent_pk);
    }
    let url_selected_language = get_url_vars()['selected_language']
    try {
        if (url_selected_language !== SELECTED_LANGUAGE) {
            window.location = set_url_parameter("selected_language", SELECTED_LANGUAGE)
        }
    } catch (err) {
        console.log(err)
    }

    $(document).ready(function () {
        create_language_custom_dropdowns_for_intent()
        generate_table()
    });
    open_close_language_dropdown_event()
    add_language_dropdown_search_event()
    language_dropdown_close_onclicking_outside_event()
    add_language_selction_event_for_edit_intent()
}

$(document).on('click', '.delete_intent', function () {

    intent_pk_list = []

    if (this.id == "modify-intent-delete-selected-modal") {

        var inputs = document.getElementsByTagName("input");
        for (var i = 0; i < inputs.length; i++) {
            if (inputs[i].id.indexOf('modify-intent-checkbox-') == 0) {
                data_id = inputs[i].id;
                if (document.getElementById(data_id).checked) {
                    intent_pk_list.push(data_id.split("-")[3]);
                    selected_bot_id_modify_intent = data_id.split("-")[4]
                }
            }
        }
        data = window.location.href.split("=")
        // bot_pk = data[1].replace("#", "")
        // bot_pk = bot_pk.replace("!", "")
        // bot_pk = bot_pk.split("&")
        // bot_pk = bot_pk[0]
        let url_parameters = get_url_vars()
        bot_pk = url_parameters['bot_pk']
        var additional_data, intent_type = "";
        try {
            // additional_data = data[2];
            // additional_data = additional_data.split('&');
            // intent_type = additional_data[0];
            intent_type = url_parameters['intent_type']
        } catch (err) {
            intent_type = "";
        }
        var category = "";


        try {
            category = url_parameters['category']
        } catch (err) {
            category = "";
        }
    } else {
        intent_pk = this.id.split("_")[1];
        intent_pk_list.push(intent_pk);
        bot_pk = $("#multiple-select-bot-choice-pk-list").val();
    }
    json_string = JSON.stringify({
        intent_pk_list: intent_pk_list,
        bot_pk: bot_pk,
    });
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: '/chat/delete-intent/',
        type: "POST",
        headers: {
            'X-CSRFToken': get_csrf_token(),
        },
        data: {
            json_string: json_string
        },
        success: function (data) {
            data = custom_decrypt(data)
            data = JSON.parse(data);
            if (data['status'] == 200) {
                if (intents_deleted_count > 1) {
                    M.toast({
                        'html': "Intents deleted successfully!"
                    }, 2000);
                } else {
                    M.toast({
                        'html': "Intent deleted successfully!"
                    }, 2000);
                }

                if (bot_pk != undefined) {
                    setTimeout(function () {
                        let location = '/chat/intent/?bot_pk=' + bot_pk + "&selected_language=en";
                        if (intent_type != undefined && intent_type != "") {
                            location += '&intent_type=' + intent_type;
                        }
                        if (category != undefined && category != "") {
                            location += '&category=' + category;
                        }
                        window.location = location;
                    }, 2000);
                } else {
                    setTimeout(function () {
                        window.location = window.location.href;
                    }, 2000);
                }
            } else {
                M.toast({
                    'html': "Unable to delete the Intent!"
                }, 2000);
            }
        }
    });
});

function capitalize_words(words) {
    var final_capitalized_words = [];
    words = words.split("_");

    for (var i = 0; i < words.length; i++) {
        final_capitalized_words.push(words[i][0].toUpperCase() + words[i].substring(1));
    }

    return final_capitalized_words.join(" ");
}

function load_order_of_responses() {
    let response_pk = intent_data['answer_pk']

    if (response_pk != null) {
        sentence_list = bot_response_data["response_list"]
        image_list = bot_response_data["image_list"]
        video_list = bot_response_data["video_list"]
        card_list = bot_response_data["card_list"]
    }
    let order_div = document.getElementById('easychat_order_of_responses');
    let drag_img = '<span class="easychat-drag-response"><img src="/static/EasyChatApp/img/dragger.svg"></span>';
    let response_item;

    let is_custom_order_selected = document.getElementById('custom-order').checked;
    if (order_of_response.length == 0 || !is_custom_order_selected) {
        order_of_response = default_order_of_response

        if (order_of_response.length == 0) {
            order_of_response = ['text', 'image', 'table', 'video', 'link_cards', 'intent_level_feedback', 'quick_recommendations', 'drop_down', 'date_picker', 'checkbox', 'radio_button', 'range_slider', 'form', 'time_picker', 'calendar_picker', 'file_attach', 'video_record', 'phone_number'];
        }
    }

    order_div.innerHTML = '';
    for (element of order_of_response) {
        response_item = '<div class="easychat-intent-response-item" item-name="' + element + '">' + capitalize_words(element) + drag_img + '</div>';

        if (element == "image" && image_list.length == 0) {
            response_item = ''
        } else if (element == "link_cards" && card_list.length == 0) {
            response_item = ''
        } else if (element == "table") {
            try {
                if (table_res == "") {
                    if (document.getElementById('table_list_of_list'))
                        table_matrix = document.getElementById('table_list_of_list').innerHTML;
                    else
                        table_matrix = document.getElementById('tree_table_list_of_list').innerHTML;
                    table_matrix = JSON.parse(table_matrix)["items"];
                    table_res = table_matrix
                }
            } catch (err) {
                table_res = null
            }
            if (table_res == undefined || table_res == null || table_res == '') {
                response_item = ''
            }
        } else if (element == "video" && video_list.length == 0) {
            response_item = ''
        } else if (element == "quick_recommendations") {
            let recommended_intent_list = document.getElementById('multiple-select-intent-choice-list').value;
            if (recommended_intent_list.length == 0) {
                response_item = ''
            }
        } else if (element == "checkbox") {
            let is_check_box_allowed = window.is_check_box_allowed
            if (is_check_box_allowed != 'True') {
                response_item = ''
            }
        } else if (element == "radio_button") {
            let is_radio_button_allowed = window.is_radio_btn_allowed
            radio_choices_list = []
            if (is_radio_button_allowed != "True") {
                response_item = ''
            }
        } else if (element == "drop_down") {
            var is_drop_down_allowed = window.is_drop_down_allowed
            if (is_drop_down_allowed != "True") {
                response_item = ''
            }
        } else if (element == "video_record") {
            let is_video_recorder_allowed = document.getElementById('checkbox-intent-video-recorder').checked;
            if (!is_video_recorder_allowed) {
                response_item = ''
            }
        } else if (element == "date_picker") {
            let is_single_date_picker_allowed = document.getElementById('checkbox-intent-single-date-picker').checked;
            let is_multi_date_picker_allowed = document.getElementById('checkbox-intent-multi-date-picker').checked;
            if (!is_single_date_picker_allowed && !is_multi_date_picker_allowed) {
                response_item = ''
            }
        } else if (element == "time_picker") {
            let is_single_time_picker_allowed = document.getElementById('checkbox-intent-single-time-picker').checked;
            let is_multi_time_picker_allowed = document.getElementById('checkbox-intent-multi-time-picker').checked;
            if (!is_single_time_picker_allowed && !is_multi_time_picker_allowed) {
                response_item = ''
            }
        } else if (element == "range_slider") {
            let is_range_slider_required = window.is_range_slider_required;
            if (is_range_slider_required != "True") {
                response_item = ''
            }
        } else if (element == "form") {
            let is_create_form = window.is_create_form_allowed
            if (is_create_form != "True") {
                response_item = '';
            }
        } else if (element == "file_attach") {
            let is_attachment_required = document.getElementById('checkbox-intent-attachment').checked;
            if (!is_attachment_required) {
                response_item = ''
            }
        } else if (element == "calendar_picker") {
            let is_calender_picker_allowed = window.is_calender_picker_allowed;
            if (is_calender_picker_allowed != "True") {
                response_item = ''
            }
        } else if (element == "phone_number") {
            let is_phone_widget_enabled = window.is_phone_widget_enabled;
            if (is_phone_widget_enabled != "True") {
                response_item = ''
            }
        } else if (element == "intent_level_feedback") {
            let is_intent_level_feedback_required = window.is_intent_level_feedback_required;
            if (is_intent_level_feedback_required != "True") {
                response_item = ''
            }
        }

        if (response_item != '') {
            $(order_div).append(response_item);
        }
    }
}

function switch_default_custom(el) {
    let elem = document.getElementById('easychat_order_of_responses');
    if (el.value == "Default") {
        elem.classList.add('response-order-disabled');
        $('#easychat_order_of_responses').sortable('disable');
    } else {
        elem.classList.remove('response-order-disabled');
        $('#easychat_order_of_responses').sortable('enable');
    }
    load_order_of_responses();
}


function check_enter_pressed(event, elem) {
    if (event.keyCode === 13) {
        var input_type = document.getElementById('input_type_' + elem[0].id.split('_')[3]).value;
        input_type = reverse_input_name_mapping(input_type)
        if (input_type == "Radio Button") {
            value = document.getElementById(elem[0].id).value;
            var format = /[`#$%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;
            if (format.test(value.trim())) {
                document.getElementById("new_bot_error_div_widgets_" + elem[0].id.split('_')[3]).innerHTML = "Invalid choice name(Only A-Z, a-z, 0-9, ?, !, @, & are allowed)"
                return;
            }
            format = /[a-zA-Z0-9]/;
            if (!format.test(value.trim())) {
                document.getElementById("new_bot_error_div_widgets_" + elem[0].id.split('_')[3]).innerHTML = "Invalid choice name(Choice name must contain at least one alphanumeric character)"
                return;
            }
            var radio_button_list = form_get_radio_button_list(elem[0].id.split('_')[3])
            var check_duplicates_list = check_duplicates_for_value(value, radio_button_list)
            if (check_duplicates_list) {
                document.getElementById("new_bot_error_div_widgets_" + elem[0].id.split('_')[3]).innerHTML = "Choice already exists(All choices must be different)"
            } else {
                add_radio_button_choices_collection(value.trim(), "form_", elem[0].id.split('_')[3] + "");
            }
            document.getElementById(elem[0].id).value = "";
        } else if (input_type == "Checkbox") {
            value = document.getElementById(elem[0].id).value;
            var format = /[`#$%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;
            if (format.test(value.trim())) {
                document.getElementById("new_bot_error_div_widgets_" + elem[0].id.split('_')[3]).innerHTML = "Invalid choice name(Only A-Z, a-z, 0-9, ?, !, @, & are allowed)"
                return;
            }
            format = /[a-zA-Z0-9]/;
            if (!format.test(value.trim())) {
                document.getElementById("new_bot_error_div_widgets_" + elem[0].id.split('_')[3]).innerHTML = "Invalid choice name(Choice name must contain at least one alphanumeric character)"
                return;
            }
            var checkbox_list = form_get_check_box_list(elem[0].id.split('_')[3])
            var check_duplicates_list = check_duplicates_for_value(value, checkbox_list)
            if (check_duplicates_list) {
                document.getElementById("new_bot_error_div_widgets_" + elem[0].id.split('_')[3]).innerHTML = "Choice already exists(All choices must be different)"
            } else {
                add_check_box_choices_collection(value.trim(), "form_", elem[0].id.split('_')[3] + "");
            }
            document.getElementById(elem[0].id).value = "";
        } else if (input_type == "Dropdown list") {
            value = document.getElementById(elem[0].id).value;
            var format = /[`#$%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;
            if (format.test(value.trim())) {
                document.getElementById("new_bot_error_div_widgets_" + elem[0].id.split('_')[3]).innerHTML = "Invalid choice name(Only A-Z, a-z, 0-9, ?, !, @, & are allowed)"
                return;
            }
            format = /[a-zA-Z0-9]/;
            if (!format.test(value.trim())) {
                document.getElementById("new_bot_error_div_widgets_" + elem[0].id.split('_')[3]).innerHTML = "Invalid choice name(Choice name must contain at least one alphanumeric character)"
                return;
            }
            var dropdown_list = form_get_dropdown_list(elem[0].id.split('_')[3])
            var check_duplicates_list = check_duplicates_for_value(value, dropdown_list)
            if (check_duplicates_list) {
                document.getElementById("new_bot_error_div_widgets_" + elem[0].id.split('_')[3]).innerHTML = "Choice already exists(All choices must be different)"
            } else {
                form_add_dropdown_chip(value.trim(), "form_", elem[0].id.split('_')[3] + "");
            }
            document.getElementById(elem[0].id).value = "";
        }
    }
}

function add_initial_form_sections(form_fields_list) {
    $(document).ready(function () {
        $('.easychat-form-widget-dropdown-wrapper').select2({
            dropdownParent: $('#modal-create-form')
        });
    });

    var last_form_field_id
    document.getElementById('form_name').value = window.form_name
    let intent_pk = get_url_vars()["intent_pk"];

    for (var i = 0; i < form_fields_list.length; i++) {
        last_form_field_id = i

        var label_name = form_fields_list[i]["label_name"]
        var placeholder_or_options = form_fields_list[i]["placeholder_or_options"]
        var country_code = form_fields_list[i]["country_code"]

        var input_type = form_fields_list[i]["input_type"]

        var optional = form_fields_list[i]["optional"]
        if (optional == 'true')
            optional = true
        else
            optional = false

        var dependent = form_fields_list[i]["is_dependent"]

        var dependent_on;

        if (dependent == "true") {
            dependent_on = form_fields_list[i]["dependent_on"]
            dependent = true
        } else {
            dependent = false
        }

        var range_type = form_fields_list[i]["range_type"]

        var calendar_type = form_fields_list[i]["calendar_type"]

        var validator = form_fields_list[i]["validator"]

        let id;
        if (form_fields_list[i]["field_id_num"]) {
            id = form_fields_list[i]["field_id_num"]
        } else {
            id = generate_random_string(5)
        }

        let is_dependent_field_required = true;

        if (input_type == 'date_picker' || input_type == 'file_attach' || input_type == 'time_picker') {
            is_dependent_field_required = false;
        }

        let new_form_field = '<div class="create-form-field" id="field-' + id + '">\
                                <div class="open-form-field" id="opened_form_div_'+ id + '">\
                                                        <div style="float: right;">\
                                                            <a class="easychat-form-widget-individual-form-save-btn" id="minimize_btn_'+ id + '" onclick="minimize_form_field_div(this)">\
                                                                <svg width="18" height="19" viewBox="0 0 18 19" fill="none" xmlns="http://www.w3.org/2000/svg">\
                                                                    <path d="M9.0001 6.03638C9.30569 6.036 9.59664 6.16726 9.7986 6.3966L14.3296 11.546C14.5393 11.7735 14.6094 12.0969 14.5126 12.3908C14.4158 12.6848 14.1674 12.9032 13.8635 12.9617C13.5596 13.0202 13.2479 12.9094 13.0489 12.6724L9.08693 8.16956C9.065 8.14455 9.03336 8.1302 9.0001 8.1302C8.96684 8.1302 8.9352 8.14455 8.91328 8.16956L4.95127 12.6733C4.75234 12.9104 4.44061 13.0211 4.1367 12.9626C3.83279 12.9042 3.58439 12.6857 3.48762 12.3917C3.39084 12.0978 3.46088 11.7745 3.67062 11.5469L8.20022 6.39845C8.40252 6.16855 8.69387 6.03667 9.0001 6.03638Z" fill="#7B7A7B"/>\
                                                                    <mask id="mask0_76_322" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="3" y="6" width="12" height="7">\
                                                                    <path d="M9.0001 6.03638C9.30569 6.036 9.59664 6.16726 9.7986 6.3966L14.3296 11.546C14.5393 11.7735 14.6094 12.0969 14.5126 12.3908C14.4158 12.6848 14.1674 12.9032 13.8635 12.9617C13.5596 13.0202 13.2479 12.9094 13.0489 12.6724L9.08693 8.16956C9.065 8.14455 9.03336 8.1302 9.0001 8.1302C8.96684 8.1302 8.9352 8.14455 8.91328 8.16956L4.95127 12.6733C4.75234 12.9104 4.44061 13.0211 4.1367 12.9626C3.83279 12.9042 3.58439 12.6857 3.48762 12.3917C3.39084 12.0978 3.46088 11.7745 3.67062 11.5469L8.20022 6.39845C8.40252 6.16855 8.69387 6.03667 9.0001 6.03638Z" fill="white"/>\
                                                                    </mask>\
                                                                    <g mask="url(#mask0_76_322)">\
                                                                    </g>\
                                                                    </svg>\
                                                            </a>\
                                                            <div class="create-form-div-remove" id="remove-create-form-div-'+ id + '" onclick="remove_create_form_div(this)"> <svg width="11" height="10" viewBox="0 0 11 10" fill="none" xmlns="http://www.w3.org/2000/svg">\
                                                                <path d="M11 1.23576L9.64067 0L5.5 3.76424L1.35933 0L0 1.23576L4.14067 5L0 8.76424L1.35933 10L5.5 6.23576L9.64067 10L11 8.76424L6.85933 5L11 1.23576Z" fill="#757575"></path> </svg>\
                                                            </div>\
                                                        </div>\
                                                        <div class="input-field-custom">\
                                                            <label for="label_name_' + id + '_1" id="label_name_' + id + '_1">Label Name<span style="color: red;">*</span></label>\
                                                            <input class="label-name" id="input_name_' + id + '_1" onblur="form_label_field_changed(this)" type="text" maxlength="' + character_limit_small_text + '" placeholder="Eg: Account details" value="' + label_name + '" >\
                                                            <div class="form-widget-label-name-error-message" id="label_name_error_msg_' + id + '" style="display: none;">\
                                                                Label name already exists. Please try another.\
                                                            </div>\
                                                        </div>\
                                                        <div class="input-field-custom">\
                                                            <label for="label_name_' + id + '_2">Input type<span style="color: red;">*</span></label>\
                                                            <select class="easychat-form-widget-dropdown-wrapper" id=input_type_' + id + '>\
                                                                    <option value="text_field">Text Field</option>\
                                                                    <option value="dropdown_list">Dropdown list</option>\
                                                                    <option value="checkbox">Checkbox</option>\
                                                                    <option value="radio">Radio Button</option>\
                                                                    <option value="range">Range Slider</option>\
                                                                    <option value="file_attach">File Attach</option>\
                                                                    <option value="date_picker">Date Picker</option>\
                                                                    <option value="time_picker">Time Picker</option>\
                                                                    <option value="phone_number">Phone Number</option>\
                                                            </select>\
                                                            <div class="col s12" id="validator_dropdown_' + id + '" style=" padding: 0px !important; margin-top: 16px; ">\
                                                                <select class="easychat-form-widget-dropdown-wrapper" id="validator_' + id + '">\
                                                                        <option value="choose_validator">Choose Validator</option>\
                                                                        <option value="6digitotp_validator">6 Digit OTP Validator</option>\
                                                                        <option value="4digitotp_validator">4 Digit OTP Validator</option>\
                                                                        <option value="email_validator">Email Validator</option>\
                                                                        <option value="pan_validator">PAN Validator</option>\
                                                                        <option value="name_validator">Name Validator</option>\
                                                                        <option value="mobile_validator">Mobile Validator</option>\
                                                                </select>\
                                                            </div>\
                                                            <div class="col s12" id="file_attach_' + id + '"  style="display: none;padding: 0px !important; margin-top: 16px; ">\
                                                                <select class="easychat-form-widget-dropdown-wrapper" id="file_attach_type_' + id + '">\
                                                                    <option value="image(ex. .jpeg, .png, .jpg)">image(ex. .jpeg, .png, .jpg)</span>\
                                                                    <option value="video file(ex. .mp4)">video file(ex. .mp4)</span>\
                                                                    <option value="word processor(i.e. .doc,.pdf)">word processor(i.e. .doc,.pdf)</span>\
                                                                    <option value="compressed file(ex. .zip)">compressed file(ex. .zip)</span>\
                                                                </select>\
                                                            </div>\
                                                            <div class="col s12" id="range_type_' + id + '" style="display: none; padding: 0px !important; margin-top: 16px; ">\
                                                                <select class="easychat-form-widget-dropdown-wrapper" id="range_selector_' + id + '">\
                                                                    <option value="Single Range Selector">Single Range Selector</span>\
                                                                    <option value="Dual Range Selector">Dual Range Selector</span>\
                                                                </select>\
                                                            </div>\
                                                            <div class="col s12" id="calendar_type_' + id + '" style="display: none; padding: 0px !important; margin-top: 16px; ">\
                                                            <select class="easychat-form-widget-dropdown-wrapper" id="calendar_selector_type_' + id + '">\
                                                                <option value="Single Type">Single Type</span>\
                                                                <option value="Custom Type">Custom Type</span>\
                                                            </select>\
                                                            </div>\
                                                            \
\
                                                            <div class="col s12" id="phone_number_type_' + id + '" style="display: none; padding: 0px !important; margin-top: 16px; ">\
                                                            <label for="label_name_dP2mz_2">Default Country Code\
                                                                <span style="color: red;">*</span>\
                                                            </label>\
                                                            <input type="tel" placeholder="" style="visibility:hidden !important;" id="phone_number_selector_type_' + id + '" >\
                                                            </div>\
\
\
                                                            <div class=" col s12 response-widget-dragable-output-div sortable-radio-widget-edit-div" style="display: none;" id="sortable-radio-widget-edit-div-' + id + '">\
                                                            </div>\
                                                            <div class=" col s12 response-widget-dragable-output-div sortable-checkbox-widget-edit-div" style="display: none;" id="sortable-checkbox-widget-edit-div-' + id + '">\
                                                            </div>\
                                                            <div class="form-widget-dropdown-area sortable-radio-widget-edit-div" style="display: none;" id="sortable-dropdown-widget-edit-div-' + id + '">\
                                                            </div>\
                                                            <div class="form-widget-range-slidervalue-holder-contaainer" id="form-widget-range-slider-min-max-container' + id + '" style="display: none;">\
                                                            <div class="range-slider-min-max-value-div">\
                                                            <div class="form-widget-slider-heading-div">\
                                                            Enter Value\
                                                            </div>\
                                                            <div class="form-widget-slider-min-max-value-area">\
                                                            <div class="range-slider-min-value-input">\
                                                            <input type="number" id="form-range-slider-min-range-' + id + '" placeholder="Enter Value" autocomplete="off">\
                                                            <p>Min range</p>\
                                                            </div>\
                                                            <svg style="margin: 27px 10px 0px 10px;" width="9" height="1" viewBox="0 0 9 1" fill="none" xmlns="http://www.w3.org/2000/svg">\
                                                            <path d="M0 0.5H9" stroke="#8F8F8F"/>\
                                                            </svg>\
                                                            <div class="range-slider-max-value-input">\
                                                            <input type="number" id="form-range-slider-max-range-' + id + '" placeholder="Enter Value" autocomplete="off">\
                                                            <p>Max range</p>\
                                                            </div>\
                                                            </div>\
                                                            </div>\
                                                            </div>\
                                                        </div>\
                                                        <div class="input-field-custom">\
                                            <p style="color: red; display: inline-block" id="new_bot_error_div_widgets_' + id + '"></p>\
                                                            <input class = "input_selected_type_3" onblur="form_placeholder_field_changed(this)" id="input_selected_type_' + id + '_3" maxlength="' + character_limit_small_text + '" type="text" placeholder="Placeholder text" style="margin-top:12px !important">\
                                                        </div>'+ get_dependent_field_div(id, is_dependent_field_required) + '\
                                                        <div class="form-field-footer">\
                                                            <div style="display: flex; align-items: center; column-gap: 10px;">\
                                                                <a id="reset_values_'+ id + '" class="form-widget-individual-reset-btn" onclick="reset_api_integration(`' + id + '`, false, true)">Reset</a>\
                                                                <div class="optional-btn" style="font-weight: 300; font-size: 14px"> <span>Optional</span> <input type="checkbox" id="optional-toggle-field-'+ id + '"><label style="margin-left: 5px; height: 13px;" for="optional-toggle-field-' + id + '">Toggle</label> </div>\
                                                            </div>\
                                                            <div>\
                                                                <div class="form-widget-individual-api-integration-text" id="api_integration_status_' + id + '" style="display: none;">API Integration - <span style="color: green;">Active</span> </div>\
                                                            </div>\
                                                            <div>\
                                                            <a href="/chat/field-processor/?processor=field&bot_pk=' + SELECTED_BOT_PK + '&field_id=' + id + '" class="form-widget-individual-integrate-api-btn" target="_blank" id="api_integration_link_' + id + '">Integrate API</a>\
                                                            </div>\
                                                        </div></div>\
                                                        <div class="create-form-field-data-saved-div" id="saved_data_div_'+ id + '" style="display: none;">\
                                                            <div class="drag-icon ui-sortable-handle">\
                                                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">\
                                                                <path d="M6.5 6C7.32843 6 8 5.32843 8 4.5C8 3.67157 7.32843 3 6.5 3C5.67157 3 5 3.67157 5 4.5C5 5.32843 5.67157 6 6.5 6Z" fill="#7B7A7B"/>\
                                                                <path d="M6.5 11C7.32843 11 8 10.3284 8 9.5C8 8.67157 7.32843 8 6.5 8C5.67157 8 5 8.67157 5 9.5C5 10.3284 5.67157 11 6.5 11Z" fill="#7B7A7B"/>\
                                                                <path d="M8 14.5C8 15.3284 7.32843 16 6.5 16C5.67157 16 5 15.3284 5 14.5C5 13.6716 5.67157 13 6.5 13C7.32843 13 8 13.6716 8 14.5Z" fill="#7B7A7B"/>\
                                                                <path d="M13.5 6C14.3284 6 15 5.32843 15 4.5C15 3.67157 14.3284 3 13.5 3C12.6716 3 12 3.67157 12 4.5C12 5.32843 12.6716 6 13.5 6Z" fill="#7B7A7B"/>\
                                                                <path d="M15 9.5C15 10.3284 14.3284 11 13.5 11C12.6716 11 12 10.3284 12 9.5C12 8.67157 12.6716 8 13.5 8C14.3284 8 15 8.67157 15 9.5Z" fill="#7B7A7B"/>\
                                                                <path d="M13.5 16C14.3284 16 15 15.3284 15 14.5C15 13.6716 14.3284 13 13.5 13C12.6716 13 12 13.6716 12 14.5C12 15.3284 12.6716 16 13.5 16Z" fill="#7B7A7B"/>\
                                                                </svg>\
                                                            </div>\
                                                            <div class="create-form-field-data-div-wrapper">\
                                                                <div class="create-form-field-data-saved-div-label-name" id="saved_full_name_'+ id + '">Full Name</div>\
                                                                <div class="create-form-field-data-saved-div-input-type" id="saved_input_type_'+ id + '">Input Type - <span>Text Field</span></div>\
                                                                <div class="create-form-field-data-saved-div-validator" id="saved_validator_'+ id + '"><span>Name</span> Validator</div>\
                                                                <div class="create-form-field-data-saved-div-api-status" id="saved_api_status_'+ id + '">API Integration - <span style="color:green">Active</span></div>\
                                                                <div class="create-form-field-data-saved-div-dependent-value" id="saved_dependency_'+ id + '">\
                                                                    <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">\
                                                                        <path d="M9.75 4.5H10.2662C12.3292 4.5 14 6.17984 14 8.25C14 10.2534 12.4353 11.8912 10.4706 11.9948L10.2729 12L9.75667 12.0046C9.34247 12.0082 9.00371 11.6755 8.99997 11.2613C8.99665 10.8816 9.276 10.5653 9.64162 10.5124L9.74333 10.5046L10.2662 10.5C11.499 10.5 12.5 9.49355 12.5 8.25C12.5 7.05827 11.5807 6.08428 10.419 6.00519L10.2662 6H9.75C9.33579 6 8.99997 5.66421 8.99997 5.25C8.99997 4.8703 9.28215 4.55651 9.64823 4.50685L9.75 4.5H10.2662H9.75ZM5.7523 4.5H6.25C6.66421 4.5 7 4.83579 7 5.25C7 5.6297 6.71785 5.94349 6.35177 5.99315L6.25 6H5.7523C4.50839 6 3.5 7.00839 3.5 8.2523C3.5 9.44437 4.42611 10.4201 5.59809 10.4994L5.7523 10.5046H6.25C6.66421 10.5046 7 10.8404 7 11.2546C7 11.6343 6.71785 11.9481 6.35177 11.9977L6.25 12.0046H5.7523C3.67996 12.0046 2 10.3246 2 8.2523C2 6.24681 3.57332 4.60879 5.55302 4.5052L5.7523 4.5H6.25H5.7523ZM5.75 7.5H10.25C10.6642 7.5 11 7.83579 11 8.25C11 8.6297 10.7178 8.94349 10.3518 8.99315L10.25 9H5.75C5.33579 9 5 8.66421 5 8.25C5 7.8703 5.28215 7.55651 5.64823 7.50685L5.75 7.5H10.25H5.75Z" fill="#2741FA"/>\
                                                                        </svg><span id="saved_dependency_name_'+ id + '">Full Name\
                                                                    </span>\
                                                                </div>\
                                                            </div>\
                                                            <a id="maximize_btn_'+ id + '" class="create-form-field-data-div-wrapper-edit-icon" onclick="maximize_form_field_div(this)">\
                                                                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">\
                                                                <path d="M8.50525 5.60684L4.04384 10.0693C3.80447 10.3087 3.50454 10.4785 3.17613 10.5606L1.4645 10.9885C1.19091 11.0569 0.943097 10.8091 1.01149 10.5355L1.4394 8.82387C1.52151 8.49546 1.69132 8.19553 1.93069 7.95616L6.3921 3.49369L8.50525 5.60684ZM9.56235 2.43765C10.1459 3.02118 10.1459 3.96727 9.56235 4.5508L9.03354 5.07856L6.92039 2.96541L7.4492 2.43765C8.03273 1.85412 8.97882 1.85412 9.56235 2.43765Z" fill="#7B7A7B"/>\
                                                                </svg>\
                                                            </a>\
                                                        </div>\
                                                    </div>'

        $('#create-form-fields').append(new_form_field);

        document.getElementById("input_type_" + id).value = input_type

        input_type = reverse_input_name_mapping(input_type)

        document.getElementById("optional-toggle-field-" + id).checked = optional
        let dependent_field_div = document.getElementById("dependent-field-" + id)
        if (dependent_field_div) {
            dependent_field_div.checked = dependent
        }
        if (dependent) {
            document.getElementById('dependent_dropdown_div_' + id).style.display = 'block';
            $('#dependent_field_dropdown_' + id).append('<option value="' + dependent_on + '" selected>' + form_fields_list[i]["dependent_on_label_name"] + '</option>');
        }

        if (input_type == "Text Field") {
            document.getElementById("validator_" + id).style.display = "block"
            document.getElementById('input_selected_type_' + id + '_3').value = placeholder_or_options
            document.getElementById("validator_" + id).value = validator
            document.getElementById('input_selected_type_' + id + '_3').placeholder = "Placeholder text"

        } else {
            //not input
            document.getElementById('validator_dropdown_' + id).style.display = 'none';

            if (input_type == "Radio Button") {
                var choices = placeholder_or_options.split('$$$')
                choices.forEach(choice => add_radio_button_choices_collection(choice, "form_", id + ""));
                document.getElementById('input_selected_type_' + id + '_3').style.display = "inline-block"
                document.getElementById("sortable-radio-widget-edit-div-" + id).style.display = "block"
                document.getElementById('input_selected_type_' + id + '_3').value = "";
                document.getElementById('input_selected_type_' + id + '_3').placeholder = "Enter any value or text and hit \"Enter\""

            } else {


                if (input_type == "Checkbox") {

                    document.getElementById("sortable-checkbox-widget-edit-div-" + id).style.display = "block"
                    var choices = placeholder_or_options.split('$$$')
                    choices.forEach(choice => add_check_box_choices_collection(choice, "form_", id + ""));
                    document.getElementById('input_selected_type_' + id + '_3').style.display = "inline-block"
                    document.getElementById('input_selected_type_' + id + '_3').value = "";
                    document.getElementById('input_selected_type_' + id + '_3').placeholder = "Enter any value or text and hit \"Enter\""



                } else {
                    if (input_type == "Dropdown list") {
                        document.getElementById("sortable-dropdown-widget-edit-div-" + id).style.display = "block"
                        var choices = placeholder_or_options.split('$$$')
                        choices.forEach(choice => form_add_dropdown_chip(choice, "form_", id + ""));
                        document.getElementById('input_selected_type_' + id + '_3').style.display = "inline-block"
                        document.getElementById('input_selected_type_' + id + '_3').value = "";
                        document.getElementById('input_selected_type_' + id + '_3').placeholder = "Enter any value or text and hit \"Enter\""
                    } else {

                        if (input_type == "File Attach") {
                            document.getElementById('input_selected_type_' + id + '_3').style.display = "block"
                            document.getElementById('input_selected_type_' + id + '_3').style.visibility = "hidden"
                            document.getElementById('file_attach_' + id).style.display = "block"
                            if (document.getElementById('api_integration_link_' + id)) {
                                document.getElementById('api_integration_link_' + id).style.display = "none"
                            }

                        } else {

                            if (input_type == "Range Slider") {
                                document.getElementById('input_selected_type_' + id + '_3').style.display = "none";
                                document.getElementById('form-widget-range-slider-min-max-container' + id).style.display = "block";
                                document.getElementById('range_type_' + id).style.display = "block"
                                var form_range_slider_min_value = placeholder_or_options.split('-')[0]
                                var form_range_slider_max_value = placeholder_or_options.split('-')[1]
                                document.getElementById('range_selector_' + id).value = range_type
                                document.getElementById('form-range-slider-min-range-' + id).value = form_range_slider_min_value;
                                document.getElementById('form-range-slider-max-range-' + id).value = form_range_slider_max_value;
                            } else {
                                if (input_type == "Date Picker" || input_type == "Time Picker") {
                                    document.getElementById('input_selected_type_' + id + '_3').style.display = "block";
                                    document.getElementById('input_selected_type_' + id + '_3').style.visibility = "hidden";
                                    document.getElementById('calendar_type_' + id).style.display = "block"
                                    document.getElementById('calendar_selector_type_' + id).value = calendar_type;
                                    if (document.getElementById('api_integration_link_' + id)) {
                                        document.getElementById('api_integration_link_' + id).style.display = "none"
                                    }
                                } else {
                                    if (input_type == "Phone Number") {
                                        document.getElementById('input_selected_type_' + id + '_3').value = placeholder_or_options
                                        document.getElementById('input_selected_type_' + id + '_3').style.display = "block"  
                                        document.getElementById('phone_number_type_' + id).style.display = "block"
                                        document.getElementById('input_selected_type_' + id + '_3').placeholder = "Placeholder text"
                      
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }

        if (input_type == "Phone Number") {
            initialize_phone_number_selector_console("phone_number_selector_type_" + id, country_code, id)    
        } else {
            initialize_phone_number_selector_console("phone_number_selector_type_" + id, "in", id)    
        }
        // create_custom_dropdowns_form_widgets("field-" + id, id, input_type, validator, placeholder_or_options,range_type,calendar_type)
        // create_custom_dropdowns("field-"+last_form_field_id, last_form_field_id, input_type, validator)
        $('#input_selected_type_' + id + '_3').keyup(function (event) {
            check_enter_pressed(event, $(this))
        });
        $('#input_name_' + id + '_1').focusout(function () {
            check_if_label_name_exists(id)
        });
        var className = "field-" + last_form_field_id

        last_form_field_id++;
        $('.easychat-form-widget-dropdown-wrapper').select2().on('select2:open', function (e) {
            $('.select2-search__field').attr('placeholder', 'Search here');
        });
        $('#input_type_' + id).select2().on('select2:close', function (e) {
            add_input_type_field(id);
        });
        $("#dependent-field-" + id).on("change", function (event) {
            if (this.checked) {
                $("#dependent_dropdown_div_" + id).show();

            } else {
                $("#dependent_dropdown_div_" + id).hide();
            }
        });
        $('#dependent_field_dropdown_' + id).select2().on('select2:open', function (e) {
            let fields = document.querySelectorAll(".label-name");
            $('#dependent_field_dropdown_' + id).children().remove();
            $('#dependent_field_dropdown_' + id).append('<option value="Select Dependency">Select Dependency</option>');
            for (let i = 0; i < fields.length; i++) {
                let label_name = fields[i].value;
                let label_id = fields[i].id.split('_')[2]
                let label_input_type = $('#input_type_' + label_id).val()
                if (label_input_type == 'file_attach' || label_input_type == 'date_picker' || label_input_type == 'time_picker') continue;
                if (label_id == id) break;
                $('#dependent_field_dropdown_' + id).append('<option value="' + label_id + '">' + label_name + '</option>');
            }
        });
    }
    update_form_widget_api_integration_status(true);
}


function sanitize_special_characters(elem, toast_msg) {

    var format = /[`@#$%^*()_+\-=\[\]{};':"\\|,<>\/~]/;

    if (format.test(elem.value)) {

        M.toast({
            "html": toast_msg
        });
        elem.value = ""
        return;
    }
}

function sanitize_special_characters_from_text(text, toast_msg) {

    var format = /[`@#$%^*()_+\-=\[\]{};':"\\|,<>\/~]/;

    if (format.test(text)) {

        M.toast({
            "html": toast_msg
        });
        return false;
    }
    else {
        return true
    }
}

function form_label_field_changed(elem) {

    var format = /[`@#$%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;

    if (format.test(elem.value)) {

        M.toast({
            "html": "Form label can't contain special characters"
        });
        elem.value = ""
        return;
    }
}

function form_placeholder_field_changed(elem) {

    var format = /[`@#$%^*_+=\[\]{};':"\\|,.<>\/~]/;

    if (format.test(elem.value)) {

        M.toast({
            "html": "Form placeholder can contain only alphabets, numerics, (, ) and -"
        });
        elem.value = ""
        return;
    }
}

function initialize_phone_number_selector_console(id, country_code, form_field_id) {
    $("#" + id).intlTelInput({
        initialCountry: country_code,
    
        allowExtensions: true,
        formatOnDisplay: true,
        autoFormat: true,
        autoHideDialCode: true,
        autoPlaceholder: true,
        // defaultCountry: "auto",
        ipinfoToken: "yolo",
        nationalMode: false,
        numberType: "MOBILE",
        //onlyCountries: ['us', 'gb', 'ch', 'ca', 'do'],
        preferredCountries: ['in', 'ae', 'qa', 'om', 'bh', 'kw', 'ma'],
        preventInvalidNumbers: true,
        separateDialCode: true,
    });

    if ($("#searchinput_country_" + form_field_id).length == 0){ 
        if (id.indexOf("telephone") != -1) {
            $("#telephone-preview-wrapper-" + form_field_id + " .country-list").prepend("<input autocomplete='off' id='searchinput_country_" + form_field_id + "' style='width: 100% !important; border-bottom: none !important; box-shadow: none !important;' placeholder='Search..'  type='text' class='search_phone_number_widget_class' onkeydown='filterFunction(event, this, \"telephone-preview-wrapper-" + form_field_id + " \")' data-search />");
            $("#telephone-preview-wrapper-" + form_field_id + ".country-list").append("<div class='country-no-result-found' id='country_no_result_found_modal_" + form_field_id + "\'>No Result Found</div>");
            
            $("#searchinput_country_" + form_field_id).click(function(event) {
                event.stopPropagation();
                $("#telephone-preview-wrapper-" + form_field_id + " .country-list").addClass("show");
            });
        } else {
            $("#phone_number_type_" + form_field_id + " .country-list").prepend("<input autocomplete='off' id='searchinput_country_" + form_field_id + "' style='width: 100% !important; border-bottom: none !important; box-shadow: none !important;' placeholder='Search..'  type='text' class='search_phone_number_widget_class' onkeydown='filterFunction(event, this, \"phone_number_type_" + form_field_id + " \")' data-search />");
            $("#phone_number_type_" + form_field_id + " .country-list").append("<div class='country-no-result-found' id='country_no_result_found_modal_" + form_field_id + "\'>No Result Found</div>");
            
            $("#searchinput_country_" + form_field_id).click(function(event) {
                event.stopPropagation();
                $("#phone_number_type_" + form_field_id + " .country-list").addClass("show");
            });
        }

        
      }

}

function filterFunction(event, ele, wrapper_id) {
    var input, filter, ul, a, i;
    input = ele;
    a = document.querySelectorAll("#" + wrapper_id + " .country");
    event.stopPropagation();
    setTimeout(function() {
        filter = input.value.toUpperCase().trim();
        var no_results_found = true
        for (i = 0; i < a.length; i++) {
            var txtValue = a[i].textContent || a[i].innerText;
            if (txtValue.toUpperCase().startsWith(filter)) {
                a[i].style.display = "";
                no_results_found = false
            } else {
                a[i].style.display = "none";
            }
        }
        if (filter != "") {
            $("#" + wrapper_id + " li.country.preferred, #" + wrapper_id + " li.divider").hide();
        } else {
            $("#" + wrapper_id + " li.country.preferred, #" + wrapper_id + " li.divider").show();
        }
        if (no_results_found) {
            document.querySelector("#" + wrapper_id + " .country-no-result-found").style.display = "block";
        } else {
            document.querySelector("#" + wrapper_id + " .country-no-result-found").style.display = "none";
        }
    }, 100)

}


function add_section_in_create_form_modal() {
    $(document).ready(function () {
        $('.easychat-form-widget-dropdown-wrapper').select2({
            dropdownParent: $('#modal-create-form')
        });
    });

    let last_form_field_id = document.getElementsByClassName('create-form-field').length;
    let intent_pk = get_url_vars()["intent_pk"];

    if (last_form_field_id >= 1) {
        last_form_field_id = parseInt(last_form_field_id);
    } else {
        last_form_field_id = '0'
    }
    window.last_form_field_id = last_form_field_id
    let id = generate_random_string(5);

    let new_form_field = '<div class="create-form-field" id="field-' + id + '">\
                                <div class="open-form-field" id="opened_form_div_'+ id + '">\
                                                        <div style="float: right;">\
                                                                <a class="easychat-form-widget-individual-form-save-btn"  id="minimize_btn_'+ id + '" onclick="minimize_form_field_div(this)">\
                                                                    <svg width="18" height="19" viewBox="0 0 18 19" fill="none" xmlns="http://www.w3.org/2000/svg">\
                                                                        <path d="M9.0001 6.03638C9.30569 6.036 9.59664 6.16726 9.7986 6.3966L14.3296 11.546C14.5393 11.7735 14.6094 12.0969 14.5126 12.3908C14.4158 12.6848 14.1674 12.9032 13.8635 12.9617C13.5596 13.0202 13.2479 12.9094 13.0489 12.6724L9.08693 8.16956C9.065 8.14455 9.03336 8.1302 9.0001 8.1302C8.96684 8.1302 8.9352 8.14455 8.91328 8.16956L4.95127 12.6733C4.75234 12.9104 4.44061 13.0211 4.1367 12.9626C3.83279 12.9042 3.58439 12.6857 3.48762 12.3917C3.39084 12.0978 3.46088 11.7745 3.67062 11.5469L8.20022 6.39845C8.40252 6.16855 8.69387 6.03667 9.0001 6.03638Z" fill="#7B7A7B"/>\
                                                                        <mask id="mask0_76_322" style="mask-type:alpha" maskUnits="userSpaceOnUse" x="3" y="6" width="12" height="7">\
                                                                        <path d="M9.0001 6.03638C9.30569 6.036 9.59664 6.16726 9.7986 6.3966L14.3296 11.546C14.5393 11.7735 14.6094 12.0969 14.5126 12.3908C14.4158 12.6848 14.1674 12.9032 13.8635 12.9617C13.5596 13.0202 13.2479 12.9094 13.0489 12.6724L9.08693 8.16956C9.065 8.14455 9.03336 8.1302 9.0001 8.1302C8.96684 8.1302 8.9352 8.14455 8.91328 8.16956L4.95127 12.6733C4.75234 12.9104 4.44061 13.0211 4.1367 12.9626C3.83279 12.9042 3.58439 12.6857 3.48762 12.3917C3.39084 12.0978 3.46088 11.7745 3.67062 11.5469L8.20022 6.39845C8.40252 6.16855 8.69387 6.03667 9.0001 6.03638Z" fill="white"/>\
                                                                        </mask>\
                                                                        <g mask="url(#mask0_76_322)">\
                                                                        </g>\
                                                                    </svg>\
                                                                </a>\
                                                            <div class="create-form-div-remove" id="remove-create-form-div-' + id + '" onclick="remove_create_form_div(this)"> <svg width="11" height="10" viewBox="0 0 11 10" fill="none" xmlns="http://www.w3.org/2000/svg">\
                                                                <path d="M11 1.23576L9.64067 0L5.5 3.76424L1.35933 0L0 1.23576L4.14067 5L0 8.76424L1.35933 10L5.5 6.23576L9.64067 10L11 8.76424L6.85933 5L11 1.23576Z" fill="#757575"></path> </svg>\
                                                            </div>\
                                                        </div>\
                                                        <div class="input-field-custom">\
                                                            <label for="label_name_' + id + '_1" id="label_name_' + id + '_1">Label Name<span style="color: red;">*</span></label>\
                                                            <input class="label-name" onblur="form_label_field_changed(this)" id="input_name_' + id + '_1" type="text" maxlength="' + character_limit_small_text + '" placeholder="Eg: Account details">\
                                                            <div class="form-widget-label-name-error-message" id="label_name_error_msg_' + id + '" style="display: none;">\
                                                                Label name already exists. Please try another.\
                                                            </div>\
                                                        </div>\
                                                        <div class="input-field-custom">\
                                                            <label for="label_name_' + id + '_2">Input type<span style="color: red;">*</span></label>\
                                                            <select class="easychat-form-widget-dropdown-wrapper" id=input_type_' + id + '>\
                                                                    <option value="text_field">Text Field</option>\
                                                                    <option value="dropdown_list">Dropdown list</option>\
                                                                    <option value="checkbox">Checkbox</option>\
                                                                    <option value="radio">Radio Button</option>\
                                                                    <option value="range">Range Slider</option>\
                                                                    <option value="file_attach">File Attach</option>\
                                                                    <option value="date_picker">Date Picker</option>\
                                                                    <option value="time_picker">Time Picker</option>\
                                                                    <option value="phone_number">Phone Number</option>\
                                                            </select>\
                                                            <div class="col s12" id="validator_dropdown_' + id + '" style=" padding: 0px !important; margin-top: 16px; ">\
                                                                <select class="easychat-form-widget-dropdown-wrapper" id="validator_' + id + '">\
                                                                        <option value="choose_validator">Choose Validator</option>\
                                                                        <option value="6digitotp_validator">6 Digit OTP Validator</option>\
                                                                        <option value="4digitotp_validator">4 Digit OTP Validator</option>\
                                                                        <option value="email_validator">Email Validator</option>\
                                                                        <option value="pan_validator">PAN Validator</option>\
                                                                        <option value="name_validator">Name Validator</option>\
                                                                        <option value="mobile_validator">Mobile Validator</option>\
                                                                </select>\
                                                            </div>\
                                                            <div class="col s12" id="file_attach_' + id + '"  style="display: none;padding: 0px !important; margin-top: 16px; ">\
                                                                <select class="easychat-form-widget-dropdown-wrapper" id="file_attach_type_' + id + '">\
                                                                    <option value="image(ex. .jpeg, .png, .jpg)">image(ex. .jpeg, .png, .jpg)</span>\
                                                                    <option value="video file(ex. .mp4)">video file(ex. .mp4)</span>\
                                                                    <option value="word processor(i.e. .doc,.pdf)">word processor(i.e. .doc,.pdf)</span>\
                                                                    <option value="compressed file(ex. .zip)">compressed file(ex. .zip)</span>\
                                                                </select>\
                                                            </div>\
                                                            <div class="col s12" id="range_type_' + id + '" style="display: none; padding: 0px !important; margin-top: 16px; ">\
                                                                <select class="easychat-form-widget-dropdown-wrapper" id="range_selector_' + id + '">\
                                                                    <option value="Single Range Selector">Single Range Selector</span>\
                                                                    <option value="Dual Range Selector">Dual Range Selector</span>\
                                                                </select>\
                                                            </div>\
                                                            <div class="col s12" id="calendar_type_' + id + '" style="display: none; padding: 0px !important; margin-top: 16px; ">\
                                                            <select class="easychat-form-widget-dropdown-wrapper" id="calendar_selector_type_' + id + '">\
                                                                <option value="Single Type">Single Type</span>\
                                                                <option value="Custom Type">Custom Type</span>\
                                                            </select>\
                                                            </div>\
\
\
                                                            <div class="col s12" id="phone_number_type_' + id + '" style="display: none; padding: 0px !important; margin-top: 16px; ">\
                                                            <label for="label_name_' + id + '_3">Default Country Code\
                                                                <span style="color: red;">*</span>\
                                                            </label>\
                                                            <input type="tel" placeholder="" style="visibility:hidden !important;" id="phone_number_selector_type_' + id + '" >\
                                                            </div>\
\
\
                                                            <div class=" col s12 response-widget-dragable-output-div sortable-radio-widget-edit-div" style="display: none;" id="sortable-radio-widget-edit-div-' + id + '">\
                                                            </div>\
                                                            <div class=" col s12 response-widget-dragable-output-div sortable-checkbox-widget-edit-div" style="display: none;" id="sortable-checkbox-widget-edit-div-' + id + '">\
                                                            </div>\
                                                            <div class="form-widget-dropdown-area sortable-radio-widget-edit-div" style="display: none;" id="sortable-dropdown-widget-edit-div-' + id + '">\
                                                            </div>\
                                                            <div class="form-widget-range-slidervalue-holder-contaainer" id="form-widget-range-slider-min-max-container' + id + '" style="display: none;">\
                                                            <div class="range-slider-min-max-value-div">\
                                                            <div class="form-widget-slider-heading-div">\
                                                            Enter Value\
                                                            </div>\
                                                            <div class="form-widget-slider-min-max-value-area">\
                                                            <div class="range-slider-min-value-input">\
                                                            <input type="number" id="form-range-slider-min-range-' + id + '" placeholder="Enter Value" autocomplete="off">\
                                                            <p>Min range</p>\
                                                            </div>\
                                                            <svg style="margin: 27px 10px 0px 10px;" width="9" height="1" viewBox="0 0 9 1" fill="none" xmlns="http://www.w3.org/2000/svg">\
                                                            <path d="M0 0.5H9" stroke="#8F8F8F"/>\
                                                            </svg>\
                                                            <div class="range-slider-max-value-input">\
                                                            <input type="number" id="form-range-slider-max-range-' + id + '" placeholder="Enter Value" autocomplete="off">\
                                                            <p>Max range</p>\
                                                            </div>\
                                                            </div>\
                                                            </div>\
                                                            </div>\
                                                        </div>\
                                                        <div class="input-field-custom">\
                                            <p style="color: red;" id="new_bot_error_div_widgets_' + id + '"></p>\
                                                            <input class = "input_selected_type_3" onblur="form_placeholder_field_changed(this)" id="input_selected_type_' + id + '_3" maxlength="' + character_limit_small_text + '" type="text" placeholder="Placeholder text" style="margin-top:12px !important">\
                                                        </div>'+ get_dependent_field_div(id, true) + '\
                                                        <div class="form-field-footer">\
                                                            <div style="display: flex; align-items: center; column-gap: 10px;">\
                                                                <a id="reset_values_'+ id + '" class="form-widget-individual-reset-btn" onclick="reset_api_integration(`' + id + '`, false, true)">Reset</a>\
                                                                <div class="optional-btn" style="font-weight: 300; font-size: 14px"> <span>Optional</span> <input type="checkbox" id="optional-toggle-field-'+ id + '"><label style="margin-left: 5px; height: 13px;" for="optional-toggle-field-' + id + '">Toggle</label> </div>\
                                                            </div>\
                                                            <div>\
                                                                <div class="form-widget-individual-api-integration-text" id="api_integration_status_' + id + '" style="display: none;">API Integration - <span style="color: green;">Active</span> </div>\
                                                            </div>\
                                                            <div>\
                                                            <a href="/chat/field-processor/?processor=field&bot_pk=' + SELECTED_BOT_PK + '&field_id=' + id + '" class="form-widget-individual-integrate-api-btn" target="_blank" id="api_integration_link_' + id + '">Integrate API</a>\
                                                            </div>\
                                                        </div>\
                                                    </div></div>\
                                                    <div class="create-form-field-data-saved-div" id="saved_data_div_'+ id + '" style="display: none;">\
                                                            <div class="drag-icon ui-sortable-handle">\
                                                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">\
                                                                <path d="M6.5 6C7.32843 6 8 5.32843 8 4.5C8 3.67157 7.32843 3 6.5 3C5.67157 3 5 3.67157 5 4.5C5 5.32843 5.67157 6 6.5 6Z" fill="#7B7A7B"/>\
                                                                <path d="M6.5 11C7.32843 11 8 10.3284 8 9.5C8 8.67157 7.32843 8 6.5 8C5.67157 8 5 8.67157 5 9.5C5 10.3284 5.67157 11 6.5 11Z" fill="#7B7A7B"/>\
                                                                <path d="M8 14.5C8 15.3284 7.32843 16 6.5 16C5.67157 16 5 15.3284 5 14.5C5 13.6716 5.67157 13 6.5 13C7.32843 13 8 13.6716 8 14.5Z" fill="#7B7A7B"/>\
                                                                <path d="M13.5 6C14.3284 6 15 5.32843 15 4.5C15 3.67157 14.3284 3 13.5 3C12.6716 3 12 3.67157 12 4.5C12 5.32843 12.6716 6 13.5 6Z" fill="#7B7A7B"/>\
                                                                <path d="M15 9.5C15 10.3284 14.3284 11 13.5 11C12.6716 11 12 10.3284 12 9.5C12 8.67157 12.6716 8 13.5 8C14.3284 8 15 8.67157 15 9.5Z" fill="#7B7A7B"/>\
                                                                <path d="M13.5 16C14.3284 16 15 15.3284 15 14.5C15 13.6716 14.3284 13 13.5 13C12.6716 13 12 13.6716 12 14.5C12 15.3284 12.6716 16 13.5 16Z" fill="#7B7A7B"/>\
                                                                </svg>\
                                                            </div>\
                                                            <div class="create-form-field-data-div-wrapper">\
                                                                <div class="create-form-field-data-saved-div-label-name" id="saved_full_name_'+ id + '">Full Name</div>\
                                                                <div class="create-form-field-data-saved-div-input-type" id="saved_input_type_'+ id + '">Input Type - <span>Text Field</span></div>\
                                                                <div class="create-form-field-data-saved-div-validator" id="saved_validator_'+ id + '"><span>Name</span> Validator</div>\
                                                                <div class="create-form-field-data-saved-div-api-status" id="saved_api_status_'+ id + '">API Integration - <span style="color:green">Active</span></div>\
                                                                <div class="create-form-field-data-saved-div-dependent-value" id="saved_dependency_'+ id + '">\
                                                                    <svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">\
                                                                        <path d="M9.75 4.5H10.2662C12.3292 4.5 14 6.17984 14 8.25C14 10.2534 12.4353 11.8912 10.4706 11.9948L10.2729 12L9.75667 12.0046C9.34247 12.0082 9.00371 11.6755 8.99997 11.2613C8.99665 10.8816 9.276 10.5653 9.64162 10.5124L9.74333 10.5046L10.2662 10.5C11.499 10.5 12.5 9.49355 12.5 8.25C12.5 7.05827 11.5807 6.08428 10.419 6.00519L10.2662 6H9.75C9.33579 6 8.99997 5.66421 8.99997 5.25C8.99997 4.8703 9.28215 4.55651 9.64823 4.50685L9.75 4.5H10.2662H9.75ZM5.7523 4.5H6.25C6.66421 4.5 7 4.83579 7 5.25C7 5.6297 6.71785 5.94349 6.35177 5.99315L6.25 6H5.7523C4.50839 6 3.5 7.00839 3.5 8.2523C3.5 9.44437 4.42611 10.4201 5.59809 10.4994L5.7523 10.5046H6.25C6.66421 10.5046 7 10.8404 7 11.2546C7 11.6343 6.71785 11.9481 6.35177 11.9977L6.25 12.0046H5.7523C3.67996 12.0046 2 10.3246 2 8.2523C2 6.24681 3.57332 4.60879 5.55302 4.5052L5.7523 4.5H6.25H5.7523ZM5.75 7.5H10.25C10.6642 7.5 11 7.83579 11 8.25C11 8.6297 10.7178 8.94349 10.3518 8.99315L10.25 9H5.75C5.33579 9 5 8.66421 5 8.25C5 7.8703 5.28215 7.55651 5.64823 7.50685L5.75 7.5H10.25H5.75Z" fill="#2741FA"/>\
                                                                        </svg><span id="saved_dependency_name_'+ id + '">Full Name\
                                                                    </span>\
                                                                </div>\
                                                            </div>\
                                                            <a id="maximize_btn_'+ id + '" class="create-form-field-data-div-wrapper-edit-icon" onclick="maximize_form_field_div(this)">\
                                                                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">\
                                                                <path d="M8.50525 5.60684L4.04384 10.0693C3.80447 10.3087 3.50454 10.4785 3.17613 10.5606L1.4645 10.9885C1.19091 11.0569 0.943097 10.8091 1.01149 10.5355L1.4394 8.82387C1.52151 8.49546 1.69132 8.19553 1.93069 7.95616L6.3921 3.49369L8.50525 5.60684ZM9.56235 2.43765C10.1459 3.02118 10.1459 3.96727 9.56235 4.5508L9.03354 5.07856L6.92039 2.96541L7.4492 2.43765C8.03273 1.85412 8.97882 1.85412 9.56235 2.43765Z" fill="#7B7A7B"/>\
                                                                </svg>\
                                                            </a>\
                                                        </div>\
                                                    </div>'

    $('#create-form-fields').append(new_form_field);
    create_custom_dropdowns_form_widgets("field-" + id, id, "", "", "", "")
    // create_custom_dropdowns("field-"+last_form_field_id, last_form_field_id, "", "")
    initialize_phone_number_selector_console("phone_number_selector_type_" + id, "in", id)

    $('#input_selected_type_' + id + '_3').keyup(function (event) {
        check_enter_pressed(event, $(this))
    });
    $('#input_name_' + id + '_1').focusout(function () {
        check_if_label_name_exists(id)
    });
    var form_div_id = "field-" + last_form_field_id
    // document.getElementById(form_div_id).scrollIntoView()
    $('.form-widget-scrollable-section-console').animate({ scrollTop: 9999 }, 400);
    $('.easychat-form-widget-dropdown-wrapper').select2().on('select2:open', function (e) {
        $('.select2-search__field').attr('placeholder', 'Search here');
    });
    $('#input_type_' + id).select2().on('select2:close', function (e) {
        add_input_type_field(id);
    });
    $("#dependent-field-" + id).on("change", function (event) {
        if (this.checked) {
            $("#dependent_dropdown_div_" + id).show();

        } else {
            $("#dependent_dropdown_div_" + id).hide();
        }
    });
    $('#dependent_field_dropdown_' + id).select2().on('select2:open', function (e) {
        let fields = document.querySelectorAll(".label-name");
        $('#dependent_field_dropdown_' + id).children().remove();
        $('#dependent_field_dropdown_' + id).append('<option value="Select Dependency">Select Dependency</option>');
        for (let i = 0; i < fields.length; i++) {
            let label_name = fields[i].value;
            let label_id = fields[i].id.split('_')[2]
            let label_input_type = $('#input_type_' + label_id).val()
            if (label_input_type == 'file_attach' || label_input_type == 'date_picker' || label_input_type == 'time_picker') continue;
            if (label_id == id) break;
            $('#dependent_field_dropdown_' + id).append('<option value="' + label_id + '">' + label_name + '</option>');
        }
    });
}

if (window.location.pathname != '/chat/login/') {
    $(function () {
        $("#create-form-fields").sortable({

            handle: ".drag-icon"
        });
        $("#create-form-fields").disableSelection();
    })

}

function select_create_form_input_type(el) {
    let id = el.id
    id = id.split('_')[2];

    let elem_id = el.value == 'file_attach' ? 'dropdown_selected_type_' : 'input_selected_type_';

    let elem = document.getElementById('input_selected_type_' + id + '_3');
    let file_attach_elem = document.getElementById('dropdown_selected_type_' + id + '_3');

    elem.parentElement.style.display = 'block';
    file_attach_elem.parentElement.style.display = 'none';

    elem.value = "";
    file_attach_elem.value = "";
    if (el.value == "text_field") {
        elem.placeholder = "Placeholder text"
    } else if (el.value == "dropdown_list") {
        elem.placeholder = "Use $$$ to separate drop down option(e.g. Option 1$$$Option 2)";
    } else if (el.value == "checkbox") {
        elem.placeholder = "Use $$$ to separate checkbox option(e.g. Option 1$$$Option 2)";
    } else if (el.value == "radio") {
        elem.placeholder = "Use $$$ to separate radio button option(e.g. Option 1$$$Option 2)";
    } else if (el.value == "range") {
        elem.placeholder = "Use - to separate range(e.g. 0-100)";
    } else if (el.value == "file_attach") {
        elem.parentElement.style.display = 'none';
        file_attach_elem.parentElement.style.display = 'block';
        $(file_attach_elem).select2({
            width: "95%",
            placeholder: "Select file type",
            allowClear: true,
            dropdownParent: $("#modal-create-form"),
        })
    }
}

function remove_create_form_div(elem) {
    let id = elem.id.split('-');
    let div_id = 'field-' + id[id.length - 1];

    let el = document.getElementById(div_id);

    id = id[id.length - 1]

    // console.log("Original id"+id)

    let dependent_fields = document.querySelectorAll('.dependent-dropdown');

    for (let j = 0; j < dependent_fields.length; j++) {
        if (dependent_fields[j].value == id) {
            $(dependent_fields[j]).children().remove();
            $(dependent_fields[j]).append('<option value="Select Dependency">Select Dependency</option>');
        }
    }
    el.remove();
}

// Fetch Intent information with pk
function getIntentInformationByID(intent_pk) {
    var json_string = JSON.stringify({
        intent_pk: intent_pk,
        bot_id: SELECTED_BOT_OBJ_ID,
    })

    json_string = EncryptVariable(json_string)
    var response = $.ajax({
        url: '/chat/fetch-intent-information/',
        type: "POST",
        async: false,
        data: {
            json_string: json_string
        },
        success: function (data) {
            return data;
        }
    }).responseJSON;

    response = custom_decrypt(response)
    response = JSON.parse(response);

    return response;
}

function renderTreeStructureByIntentID(intent_pk) {
    set_selected_language_based_on_url_param()

    response = fetchIntentTreeStructureByIntentID(intent_pk, selected_language);

    renderTreeStructure(response, intent_pk);
}

function fetchIntentTreeStructureByIntentID(intent_pk, selected_language) {

    var json_string = JSON.stringify({
        intent_pk: intent_pk,
        selected_language: selected_language,
    })

    json_string = EncryptVariable(json_string)

    var response = $.ajax({
        url: '/chat/fetch-intent-tree-structure/',
        type: "POST",
        async: false,
        data: {
            json_string: json_string,
        },
        success: function (response) {

            return response;
        },
        error: function (error) {
            console.log("Error in fetchIntentTreeStructureByIntentID");
        }
    }).responseJSON;
    response = custom_decrypt(response)
    response = JSON.parse(response);

    return response;
}

function isDictEmpty(dict) {
    for (var key in dict) {
        return false;
    }
    return true;
}

function renderRecursiveTreeStructure(subtree, intent_pk, parent_pk) {
    var tree_name = subtree["tree_name"]
    tree_name = tree_name.replace(/<\/?("[^"]*"|'[^']*'|[^>])*(>|$)/g, "");
    var tree_pk = subtree["tree_pk"]
    var tree_resp = subtree["tree_resp"]
    var is_repeat = subtree["is_repeat"]

    tree_resp = tree_resp.replace(/<\/?("[^"]*"|'[^']*'|[^>])*(>|$)/g, "");
    tree_resp = tree_resp.length > 55 ? tree_resp.slice(0, 50) + "..." : tree_resp

    var key = intent_pk + "_" + parent_pk + "_" + tree_pk
    if (!is_repeat) {
        html = `
        <ul>
          <li>
          <span id="` + key + `" class="collapsible_custom">
            <a href="/chat/edit-tree/?intent_pk=` + intent_pk + `&parent_pk=` + parent_pk + `&tree_pk=` + tree_pk + `&selected_language=` + selected_language + `" class="black-text tooltip">
            <div id="` + key + `_tree_name_container" value="` + tree_name + `">
              &nbsp;&nbsp;
              ` + tree_name + `
            </div>
            <span>` + tree_resp + `</span>
            </a>
          </span>
      `;
    } else {
        html = `
        <ul>
          <li>
          <span id="` + key + `" class="collapsible_custom repeat_tree">
            <a href="/chat/edit-tree/?intent_pk=` + intent_pk + `&parent_pk=` + parent_pk + `&tree_pk=` + tree_pk + `&selected_language=` + selected_language + `" class="black-text tooltip">
            <div id="` + key + `_tree_name_container" value="` + tree_name + `">
              &nbsp;&nbsp;
               ` + tree_name + `
            </div>
            <span>` + tree_resp + `</span>
            </a>
          </span>
      `;
    }

    if (!isDictEmpty(subtree["subtree"])) {
        for (var key in subtree["subtree"]) {
            html += renderRecursiveTreeStructure(subtree["subtree"][key], intent_pk, tree_pk);
        }
    }

    html += `</li></ul>`;

    return html;

}

function renderTreeStructure(response, intent_pk) {
    tree_html = renderRecursiveTreeStructure(response["1"], intent_pk, -1);
    $("#jstree-data").html(tree_html);
    $('#jstree-data').jstree({
        "core": {
            "themes": {
                "icons": false,
            },
        }
    });

    $("#jstree-data").on("activate_node.jstree", function (e, data) {
        var href = data.node.text.match(/href="([^"]*)/)[1];
        href = href.replace(/amp;/gi, '');
        window.location.href = href;
    });

    $("#jstree-data").jstree("open_all");
}

function getHTMLOfDeleteIntentModal(button_id) {
    var counter = 0;
    var inputs = document.getElementsByTagName("input");
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf('modify-intent-checkbox-') == 0) {
            data_id = inputs[i].id;
            if (document.getElementById(data_id).checked) {
                counter++;
                if (counter > 1)
                    break;

            }
        }
    }

    var popup_text = '';
    var html = `
  <!-- Modal Structure -->
    <div id="delete-intent-modal" class="modal">
    <div class="modal-content">
      <h4>Delete Intent</h4>`

    intents_deleted_count = counter;

    if (counter > 1) {
        popup_text = `<p>Are you sure, you want to delete selected intents?</p>`
    } else {
        popup_text = `<p>Are you sure, you want to delete intent?</p>`
    }

    html = html + popup_text + `</div>
    <div class="modal-footer">
      <a href="#!" class="modal-close btn transparent-btn black-text">Cancel</a>
      <a id="` + button_id + `" class="modal-close waves-effect waves-green btn delete_intent red darken-3 white-text" style="margin-left:1%">Delete</a>
    </div>
    </div>`;

    return html;
}

function getTreeRenameModal() {
    var modal = `
  <!-- Modal Structure -->
  <div id="rename-tree-modal" class="modal">
    <div class="modal-content">
    <h4>Rename Intent</h4>
    <div class="input-field col s6">
      <input id="modal_tree_name" type="text" class="validate" autofocus>
      <label for="modal_tree_name"></label>
    </div>
    </div>
    <div class="modal-footer">
    <a href="javascript:void(0)" class="modal-close btn transparent-btn black-text">Cancel</a>
    <a id="agree-rename-tree" class="modal-close waves-effect waves-green btn green lighten-2 black-text" style="margin-left:1%">Save</a>
    </div>
  </div>`;

    return modal;
}

function getTreeDeleteModal() {
    var modal = `
  <!-- Modal Structure -->
  <div id="delete-tree-modal" class="modal">
    <div class="modal-content">
    <h4>Delete Intent</h4>
    <p>Are you sure, you want to delete this Intent?</p>
    <ol id="delete-tree-modal-info">
    </ol>
    </div>
    <div class="modal-footer">
    <a href="javascript:void(0)" class="modal-close btn transparent-btn black-text">Cancel</a>
    <a id="agree-delete-tree" class="modal-close waves-effect waves-green btn red darken-3 white-text" style="margin-left:1%">Delete</a>
    </div>
  </div>`;

    return modal;
}

function getTreeDeleteOnlyNodeModal() {
    var modal = `
  <!-- Modal Structure -->
  <div id="delete-node-modal" class="modal">
    <div class="modal-content">
    <h4>Delete only Selected node</h4>
    <p>Are you sure, you want to delete this node?</p>
    <ol id="delete-node-modal-info">
    </ol>
    </div>
    <div class="modal-footer">
    <a href="javascript:void(0)" class="modal-close btn transparent-btn black-text">Cancel</a>
    <a id="agree-delete-node" class="modal-close waves-effect waves-green btn red darken-3 white-text" style="margin-left:1%">Delete</a>
    </div>
  </div>`;

    return modal;
}

function getTreeCreateModal() {
    var modal = `
  <!-- Modal Structure -->
  <div id="create-tree-modal" class="modal">
    <div class="modal-content">
    <h4>Create Child Intent</h4>
    <div class="input-field col s6">
      <input id="child_tree_name" type="text" class="validate">
      <label for="child_tree_name">Child Intent Name</label>
    </div>
    </div>
    <div class="modal-footer">
    <a href="javascript:void(0)" class="modal-close btn transparent-btn black-text">Cancel</a>
    <a id="agree-create-tree" class="modal-close waves-effect waves-green btn green lighten-2 black-text" style="margin-left:1%">Save</a>
    </div>
  </div>`;

    return modal;
}

function getTreeInsertModal() {
    var modal = `
  <!-- Modal Structure -->
  <div id="insert-tree-modal" class="modal">
    <div class="modal-content" >
    <h4>Insert Child Intent</h4>
    <p>Are you sure, you want to Insert child in between selected node and its childs?</p>
    <ol id="insert-tree-modal-info">
    </ol>
    <div class="input-field col s6">
      <input id="insert_child_tree_name" type="text" class="validate">
      <label for="insert_child_tree_name">Child Intent Name</label>
    </div>
    </div>
    <div class="modal-footer">
    <a href="javascript:void(0)" class="modal-close btn transparent-btn black-text">Cancel</a>
    <a id="agree-insert-tree" class="modal-close waves-effect waves-green btn green lighten-2 black-text" style="margin-left:1%">Save</a>
    </div>
  </div>`;

    return modal;
}

function getChoiceAddModal() {
    var modal = `
   <!-- Modal Structure -->
  <div id="tree-choice-modal" class="modal">
    <div class="modal-content">
    <h4>Add New Choice</h4>
    <div>
      <div class="input-field">
      <input id="tree_choice_display_value" type="text" class="validate">
      <label for="tree_choice_display_value">Choice Display</label>
      </div>
      <div class="input-field">
      <input id="tree_choice_value_value" type="text" class="validate">
      <label for="tree_choice_value_value">Choice Value</label>
      </div>
      <br>
    </div>
    </div>
    <div class="modal-footer">
    <a href="#!" class="modal-close btn transparent-btn black-text">Cancel</a>
    <a id="save-new-choice" class="modal-close waves-effect waves-green btn green lighten-2 black-text" style="margin-left:1%">Save</a>
    </div>
  </div>`;

    return modal;
}

function switch_to_new_ui() {
    document.cookie = "edit_intent_ui=new;path=/";
    window.location.href = window.location.href.replace("edit-intent-multilingual", "edit-intent").replace("edit-tree-multilingual", "edit-intent").replace("edit-tree", "edit-intent")
}

function renderRequiredModalsIntoHTML(intent_pk) {
    var modal_id = "deleteintent_" + intent_pk.toString();

    var html_modal = getHTMLOfDeleteIntentModal(modal_id);
    html_modal += getTreeRenameModal();
    html_modal += getTreeDeleteModal();
    html_modal += getTreeCreateModal();
    html_modal += getTreeInsertModal();
    html_modal += getTreeDeleteOnlyNodeModal();
    html_modal += getChoiceAddModal();

    $("#edit-intent-modal-container").append(html_modal);
    $("#edit-tree-modal-container").append(html_modal);

    html = `
  <a onclick="switch_to_new_ui()" class="waves-effect btn easychat-button"><svg style="position: relative; top: 4px;" width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
  <g clip-path="url(#clip0_2275_224954)">
  <path d="M12.275 13.5V15.75C12.275 16.0749 12.4041 16.3865 12.6338 16.6162C12.8635 16.8459 13.1751 16.975 13.5 16.975H15.75C16.0749 16.975 16.3865 16.8459 16.6162 16.6162C16.8459 16.3865 16.975 16.0749 16.975 15.75V13.5C16.975 13.1751 16.8459 12.8635 16.6162 12.6338C16.3865 12.4041 16.0749 12.275 15.75 12.275H15.2875V10.6875C15.2875 10.3626 15.1584 10.051 14.9287 9.82129C14.699 9.59156 14.3874 9.4625 14.0625 9.4625H9.6625V7.975H11.25C11.5749 7.975 11.8865 7.84594 12.1162 7.61621C12.3459 7.38647 12.475 7.07489 12.475 6.75V2.25C12.475 1.92511 12.3459 1.61353 12.1162 1.38379C11.8865 1.15406 11.5749 1.025 11.25 1.025L6.75 1.025C6.42511 1.025 6.11353 1.15406 5.88379 1.38379C5.65406 1.61353 5.525 1.92511 5.525 2.25V6.75C5.525 7.07489 5.65406 7.38647 5.88379 7.61621C6.11353 7.84594 6.42511 7.975 6.75 7.975H8.3375V9.4625H3.9375C3.61261 9.4625 3.30103 9.59156 3.07129 9.82129C2.84156 10.051 2.7125 10.3626 2.7125 10.6875V12.275L2.25 12.275C1.92511 12.275 1.61353 12.4041 1.38379 12.6338C1.15406 12.8635 1.025 13.1751 1.025 13.5L1.025 15.75C1.025 16.0749 1.15406 16.3865 1.38379 16.6162C1.61353 16.8459 1.92511 16.975 2.25 16.975H4.5C4.82489 16.975 5.13647 16.8459 5.36621 16.6162C5.59594 16.3865 5.725 16.0749 5.725 15.75L5.725 13.5C5.725 13.1751 5.59594 12.8635 5.36621 12.6338C5.13647 12.4041 4.82489 12.275 4.5 12.275H4.0375V10.7875H8.3375V12.275H7.875C7.55011 12.275 7.23853 12.4041 7.00879 12.6338C6.77906 12.8635 6.65 13.1751 6.65 13.5L6.65 15.75C6.65 16.0749 6.77906 16.3865 7.00879 16.6162C7.23853 16.8459 7.55011 16.975 7.875 16.975H10.125C10.4499 16.975 10.7615 16.8459 10.9912 16.6162C11.2209 16.3865 11.35 16.0749 11.35 15.75V13.5C11.35 13.1751 11.2209 12.8635 10.9912 12.6338C10.7615 12.4041 10.4499 12.275 10.125 12.275H9.6625V10.7875H13.9625V12.275H13.5C13.1751 12.275 12.8635 12.4041 12.6338 12.6338C12.4041 12.8635 12.275 13.1751 12.275 13.5ZM6.85 6.65V2.35L11.15 2.35V6.65L6.85 6.65ZM4.4 13.6L4.4 15.65L2.35 15.65L2.35 13.6L4.4 13.6ZM10.025 13.6V15.65H7.975L7.975 13.6H10.025ZM15.65 13.6V15.65H13.6V13.6H15.65Z" fill="white" stroke="white" stroke-width="0.2"/>
  </g>
  <defs>
  <clipPath id="clip0_2275_224954">
  <rect width="18" height="18" fill="white" transform="translate(18) rotate(90)"/>
  </clipPath>
  </defs>
  </svg>
   Switch to new view</a>
  <a id="delete-intent" href="#delete-intent-modal" class="btn red darken-3 modal-trigger"><i class="inline-icon material-icons">delete_forever</i> Delete</a>
  `;

    faq_html = `
  <a id="delete-faq" href="#delete-faq-modal" class="btn red darken-3 modal-trigger"><i class="inline-icon material-icons">delete_forever</i> Delete</a>
  `;

    $("#action-intent").append(html);
    $("#action-faq").append(faq_html);
}


function myResponseInitInstance() {
    //intent
    var text_response_final = ''
    if (typeof text_response !== 'undefined')
        text_response_final = text_response

    var reprompt_response_final = ''
    if (typeof reprompt_response !== 'undefined')
        reprompt_response_final = reprompt_response

    if ($("#intent_bot_response_text_text").length) {
        $("#intent_bot_response_text_text").trumbowyg('html', text_response_final)
    }
    if ($("#intent_bot_response_reprompt").length) {
        $("#intent_bot_response_reprompt").trumbowyg('html', reprompt_response_final)
    }

    // tree
    if ($("#tree_bot_response_text_text").length) {
        $("#tree_bot_response_text_text").trumbowyg('html', text_response_final)
    }

    if ($("#tree_bot_response_reprompt").length) {
        $("#tree_bot_response_reprompt").trumbowyg('html', reprompt_response_final)
    }
}

function mySpeechResponseInitInstance() {
    var speech_response_final = ''
    if (typeof speech_response !== 'undefined')
        speech_response_final = speech_response
    let ssml_response_final = ''
    if (typeof ssml_response !== 'undefined')
        ssml_response_final = ssml_response

    //intent
    if ($("#intent_bot_response_text_speech").length) {
        $("#intent_bot_response_text_speech").trumbowyg('html', speech_response_final)
    }
    if ($("#intent_bot_response_ssml").length) {
        $("#intent_bot_response_ssml").val(ssml_response_final)
    }
    //tree
    if ($("#tree_bot_response_text_speech").length) {
        $("#tree_bot_response_text_speech").trumbowyg('html', speech_response_final)
    }
    if ($("#tree_bot_response_ssml").length) {
        $("#tree_bot_response_ssml").val(ssml_response_final)
    }
}

function renderIntentInformationByID(intent_pk) {
    training_data_count = 0;
    intent_data = getIntentInformationByID(intent_pk);
    response_pk = intent_data['answer_pk'];
    training_data = intent_data['training_data'];
    order_of_response = intent_data['order_of_response'];
    default_order_of_response = intent_data['default_order_of_response'];
    loadIntentEditForm();
    $("#intent-test-action").show();
    if (selected_language == "en") {

        renderRequiredModalsIntoHTML(intent_pk);
    }
    copy_tree_id = get_cookie("copy_tree_id")
    if (copy_tree_id != "") {
        $("#paste-tree-node").removeClass("disbled-paste-btn")
    }
    loadIntentTrainingDataIntoCollectionBody(training_data);

    sentence_list = []
    image_list = []
    video_list = []
    card_list = []

    if (response_pk != null) {
        // Bot response parameters
        bot_response_data = fetchBotResponseDetailsByID(response_pk);
        sentence_list = bot_response_data["response_list"]
        image_list = bot_response_data["image_list"]
        video_list = bot_response_data["video_list"]
        card_list = bot_response_data["card_list"]
    }

    if (sentence_list.length > 0) {

        text_response = sentence_list[0]["text_response"]
        speech_response = sentence_list[0]["speech_response"]
        hinglish_response = "";

        if ("hinglish_response" in sentence_list[0]) {
            hinglish_response = sentence_list[0]["hinglish_response"]
        }
        reprompt_response = ""
        if ("text_reprompt_response" in sentence_list[0]) {
            reprompt_response = sentence_list[0]["text_reprompt_response"]
        }
        ssml_response = ""
        if("ssml_response" in sentence_list[0]) {
            ssml_response = sentence_list[0]["ssml_response"]
        }

        // addIntentResponseTextSentencesIntoCollection(text_response, speech_response)
    }

    for (var i = 0; i < image_list.length; i++) {
        image_url = image_list[i]
        addIntentResponseImageIntoCollection(image_url)
    }

    for (var i = 0; i < video_list.length; i++) {
        video_url = video_list[i]
        addIntentResponseVideoIntoCollection(video_url)
    }

    for (var i = 0; i < card_list.length; i++) {
        card_title = card_list[i]["title"];
        card_content = card_list[i]["content"];
        card_img_url = card_list[i]["img_url"];
        card_link = card_list[i]["link"];
        addIntentResponseCardIntoCollection(card_title, card_content, card_link, card_img_url);
    }
    if(!card_list.length && selected_language != "en") {
        $("#intent_cards_btn").hide();
    } else {
        $("#intent_cards_btn").show();
    }

    add_catalogue_sections_data_and_listeners(intent_data);
}

function loadIntentTrainingDataIntoCollectionBody(training_data_list) {
    try {
        for (i = 0; i < training_data_list.length; i++) {
            addIntentTrainingDataIntoCollection(training_data_list[i]);
        }
    } catch (err) { }
}

function fetchBotResponseDetailsByID(response_pk) {
    var json_string = JSON.stringify({
        response_pk: response_pk,
        selected_language: selected_language
    })

    json_string = EncryptVariable(json_string);

    var response = $.ajax({
        url: '/chat/fetch-botresponse-information/',
        type: "POST",
        async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {
            return response;
        }
    }).responseJSON;
    response = custom_decrypt(response)
    response = JSON.parse(response);
    return response;
}

/////////////////////////////////////////////////////// Developer Authentication JS Start

function validate_email(email) {

    var regex = /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/;
    var ctrl = email;

    if (ctrl != "" && regex.test(ctrl)) {
        return true;
    } else {
        return false;
    }
}


function login_function(logout_other) {

    username = document.getElementById("username");
    password = document.getElementById("password_form");
    easychat_access_token = get_easychat_access_token();

    if (username.value == "") {
        alert("Please enter valid username");
        return;
    }
    if (password.value == "") {
        alert("Please enter valid password");
        return;
    }
    captcha = document.getElementById("captcha").value;
    if (captcha == "") {
        alert("Please enter valid captcha");
        return;
    }
    tempusername = stripHTML(username.value);
    encrypted_username = EncryptVariable(username.value)
    encrypted_password = EncryptVariable(password.value)
    encrypted_easychat_access_token = EncryptVariable(easychat_access_token)
    logout_other = EncryptVariable(logout_other)
    var temppassword = "";
    for (var i = 0; i < encrypted_password.length; i++) {
        temppassword += "*";
    }
    encrypted_captcha = EncryptVariable(captcha)
    captcha_image = document.getElementById("captcha_image").src;
    encrypted_captcha_image = EncryptVariable(captcha_image)

    request_params = {
        username: encrypted_username,
        password: encrypted_password,
        captcha: encrypted_captcha,
        captcha_image: encrypted_captcha_image,
        easychat_access_token: encrypted_easychat_access_token,
        logout_other: logout_other,
    }

    json_string = JSON.stringify(request_params);
    encrypted_data = EncryptVariable(json_string);
    encrypted_data = {
        "Request": encrypted_data
    };

    login_btn = document.getElementById('login_btn');
    login_btn.disabled = true;

    csrf_token = get_csrf_token();
    var response = $.ajax({
        url: '/chat/authentication/',
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: encrypted_data,
        success: function (response) {
            try {
                document.getElementsByClassName('gy-center')[0].style["-webkit-filter"] = "";
            } catch (err) { }
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                set_cookie("is_online", "1", "/");
                setTimeout(function () {
                    window.location = "/chat/home/";
                }, 2000);

                M.toast({
                    "html": "Welcome, " + response["username"]
                }, 2000);
            } else if (response["status"] == 300) {
                login_btn.disabled = false;
                $("#session-options").modal("open");
                try {
                    document.getElementsByClassName('gy-center')[0].style = "-webkit-filter:blur(8px)";
                } catch (err) { }
            } else if (response["status"] == 302) {
                login_btn.disabled = false;

                username.value = "";
                password.value = "";
                document.getElementById("captcha").value = "";
                username.focus()
                M.toast({
                    "html": "You have entered invalid captcha. Try again."
                }, 2000);
                refreshCaptchaImage()
            } else if (response["status"] == 301) {
                login_btn.disabled = false;

                username.value = "";
                password.value = "";
                document.getElementById("captcha").value = "";
                M.toast({
                    "html": "You have entered incorrect password more than 5 times. Kindly contact administrator."
                });
                refreshCaptchaImage()
            } else if (response["status"] == 303) {
                login_btn.disabled = false;

                username.value = "";
                password.value = "";
                document.getElementById("captcha").value = "";
                M.toast({
                    "html": response["message"]
                });
                setTimeout(function () {
                    window.location.reload()
                }, 4000)
                refreshCaptchaImage()
            } else if (response["status"] == 401) {
                login_btn.disabled = false;

                M.toast({
                    "html": response["message"]
                }, 2000);
                setTimeout(function () {
                    $("#forgot-pass-btn").click()
                }, 2000);
            } else {
                login_btn.disabled = false;

                username.value = "";
                password.value = "";
                document.getElementById("captcha").value = "";
                username.focus()
                M.toast({
                    "html": "Please check your username or password"
                }, 2000);
                setTimeout(function () {
                    window.location.reload()
                }, 4000)

                refreshCaptchaImage()
            }
        },
        error: function (error) {
            try {
                document.getElementsByClassName('gy-center')[0].style["-webkit-filter"] = "";
            } catch (err) {
                console.log(err)
            }
        }
    }).responseJSON;

    return response;
}

function is_empty(){
    let username=document.getElementById("username").value;
    let password=document.getElementById("password_form").value;
    let captcha=document.getElementById("captcha").value;

    if (username !=""&& password !=""&& captcha !="")
    {
        document.getElementById("login_btn") !== null? document.getElementById("login_btn").removeAttribute("disabled"): document.getElementById("verify_btn").removeAttribute("disabled");
    }else{
        document.getElementById("login_btn") !== null? document.getElementById("login_btn").setAttribute("disabled", true): document.getElementById("verify_btn").setAttribute("disabled", true);
    }
}
function is_empty_otp(){
    verify_inputs = document.getElementsByClassName("forgot-pass-otp-input")
    let verification_code = ""
    for (let i = 0; i < verify_inputs.length; i++) {
        verification_code += verify_inputs[i].value
    }
    if (verification_code.length == 6) {
        document.getElementById("verify-login-otp-button").removeAttribute("disabled");
        document.getElementById("verify-login-otp-button").disabled = false;
    }else{
        document.getElementById("verify-login-otp-button").setAttribute("disabled", true);
        document.getElementById("verify-login-otp-button").disabled = true;
    }
}

function verify_login_otp_function(logout_other){
    let username = login_username;
    verify_inputs = document.getElementsByClassName("forgot-pass-otp-input")
    let incorrect_otp_error = document.getElementById('verify-incorrect-otp-error')
    incorrect_otp_error.style.display = 'none'
    for(let i = 0; i < verify_inputs.length; i++){
        verify_inputs[i].classList.remove('forgot-pass-otp-input-error')
        verify_inputs[i].classList.add('forgot-pass-otp-input-success')
    }
    tempusername = stripHTML(username).trim();
    if (tempusername == "") {
        showToast("Invalid Username")
        return;
    }
    if (validate_email(tempusername) == false) {
        showToast("Username should be a valid Email Id")
        return;
    }
    let verification_code = ""
    for (let i = 0; i < verify_inputs.length; i++) {
        verification_code += verify_inputs[i].value
    }
    
    if (verification_code.length != 6) {
    incorrect_otp_error.style.display = 'block'
        for(let i = 0; i < verify_inputs.length; i++){
            verify_inputs[i].classList.remove('forgot-pass-otp-input-success')
            verify_inputs[i].classList.add('forgot-pass-otp-input-error')
        }
        return
    }
    easychat_access_token = get_easychat_access_token();

    var json_string = JSON.stringify({
        'user_name': tempusername,
        'otp_access_token': verify_otp_token,
        'otp': verification_code,
        'easychat_access_token': easychat_access_token,
        'logout_other': logout_other,
    })

    encrypted_json_string = EncryptVariable(json_string)

    csrf_token = get_csrf_token();
    var response = $.ajax({
        url: '/chat/authentication/',
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: encrypted_json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);

            if (response["status"] == 200) {
                set_cookie("is_online", "1", "/");
                setTimeout(function () {
                    window.location = "/chat/home/";
                }, 2000);

                M.toast({
                    "html": "Welcome, " + response["username"]
                }, 2000);

            } else if (response["status"] == 300){
                $("#session-options").modal("open");
                try {
                    document.getElementsByClassName('gy-center')[0].style = "-webkit-filter:blur(8px)";
                } catch (err) { }
            } else if (response["status"] == 301) {
                showToast(response["status_message"], 2000)
                
            }else if (response["status"] == 302) {
                incorrect_otp_error.style.display = 'block'
                for(let i = 0; i < verify_inputs.length; i++){
                    verify_inputs[i].classList.remove('forgot-pass-otp-input-success')
                    verify_inputs[i].classList.add('forgot-pass-otp-input-error')
                }
            } else {
                showToast("Internal Error occoured. Please try after some time", 2000)
                verify_otp_token = ""
                if(document.getElementById("right-side-div-wrapper")){
                    document.getElementById("right-side-div-wrapper").style.display = "none"
                    document.getElementById("login-main-div").style.display = "block"
                }else{
                    document.getElementById("otp").style.display = "none"
                    document.getElementById("mobile-login-block").style.display = "block"
                }
                document.getElementById("username").value = ""
                login_username = ""
                document.getElementById("captcha").value = "";
                refreshCaptchaImage()
            }

        }
    }).responseJSON;

    response = custom_decrypt(response);
    response = JSON.parse(response);
    return response;
}

function disable_verify_otp_for_one_minute(){
    document.getElementById("resend_verify_login_otp").disabled = true
    document.getElementById("resend_verify_login_otp").style.cursor = "not-allowed"
    document.getElementById("resend_verify_login_otp").style.opacity = "0.25"
    if(document.getElementById("verify-timer")){
        document.getElementById("verify-timer").innerHTML = "00:60"
        let counter = 1
        let timer = setInterval(function(){
            let temp = (resend_verification_otp_time_limit/1000 - counter);
            if(temp === 0) clearInterval(timer)
            temp.toString().length === 2 ? document.getElementById("verify-timer").innerHTML =  "00:" + temp: document.getElementById("verify-timer").innerHTML = "00:0" + temp;
            counter++
        }, 1000)
    }
    setTimeout(function () {
        document.getElementById("resend_verify_login_otp").disabled = false
        document.getElementById("resend_verify_login_otp").style.cursor = "pointer"
        document.getElementById("resend_verify_login_otp").style.opacity = "1"
    }, resend_verification_otp_time_limit)
}

function verified_login_function(logout_other) {

    username = document.getElementById("username");
    password = document.getElementById("password_form");

    if (username.value == "") {
        alert("Please enter valid username");
        return;
    }
    if (password.value == "") {
        alert("Please enter valid password");
        return;
    }
    captcha = document.getElementById("captcha").value;
    if (captcha == "") {
        alert("Please enter valid captcha");
        return;
    }
    tempusername = stripHTML(username.value);
    encrypted_username = EncryptVariable(username.value)
    encrypted_password = EncryptVariable(password.value)
    logout_other = EncryptVariable(logout_other)
    var temppassword = "";
    for (var i = 0; i < encrypted_password.length; i++) {
        temppassword += "*";
    }
    encrypted_captcha = EncryptVariable(captcha)
    captcha_image = document.getElementById("captcha_image").src;
    encrypted_captcha_image = EncryptVariable(captcha_image)

    request_params = {
        username: encrypted_username,
        password: encrypted_password,
        captcha: encrypted_captcha,
        captcha_image: encrypted_captcha_image,
        logout_other: logout_other,
    }

    json_string = JSON.stringify(request_params);
    encrypted_data = EncryptVariable(json_string);
    encrypted_data = {
        "Request": encrypted_data
    };

    verify_btn = document.getElementById('verify_btn');
    verify_btn.disabled = true;
    verify_btn.setAttribute("disabled", '')

    csrf_token = get_csrf_token();
    var response = $.ajax({
        url: '/chat/otp-authentication/',
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: encrypted_data,
        success: function (response) {
            try {
                document.getElementsByClassName('gy-center')[0].style["-webkit-filter"] = "";
            } catch (err) { }
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                verify_otp_token = response["otp_access_token"]
                verify_inputs = document.getElementsByClassName("forgot-pass-otp-input")
                let incorrect_otp_error = document.getElementById('verify-incorrect-otp-error')
                incorrect_otp_error.style.display = 'none'
                for(let i = 0; i < verify_inputs.length; i++){
                    verify_inputs[i].classList.remove('forgot-pass-otp-input-error')
                    verify_inputs[i].classList.add('forgot-pass-otp-input-success')
                    verify_inputs[i].value = ''
                }
                if( document.getElementById("login-main-div") ){
                    document.getElementById("login-main-div").style.display = "none"
                    document.getElementById("right-side-div-wrapper").style.display = "block"
                }else{
                    document.getElementById("mobile-login-block").style.display = "none"
                    document.getElementById("otp").style.display = "block"
                }
                login_username = username.value
                document.getElementById("otp-multifactor-username").innerHTML = login_username
                document.getElementById("verify-login-otp-button").disabled = true;
                document.getElementById("verify-login-otp-button").setAttribute("disabled", true);
                username.value = "";
                password.value = "";
                document.getElementById("captcha").value = "";
                refreshCaptchaImage()
                disable_verify_otp_for_one_minute()
                document.getElementById('verify_btn').disabled = false
            } else if (response["status"] == 300) {
                verify_btn.disabled = false;
                $("#session-options").modal("open");
                try {
                    document.getElementsByClassName('gy-center')[0].style = "-webkit-filter:blur(8px)";
                } catch (err) { }
            } else if (response["status"] == 302) {
                verify_btn.disabled = false;

                username.value = "";
                password.value = "";
                document.getElementById("captcha").value = "";
                username.focus()
                M.toast({
                    "html": "You have entered invalid captcha. Try again."
                }, 2000);
                refreshCaptchaImage()
            } else if (response["status"] == 301) {
                verify_btn.disabled = false;

                username.value = "";
                password.value = "";
                document.getElementById("captcha").value = "";
                M.toast({
                    "html": "You have entered incorrect password more than 5 times. Kindly contact administrator."
                });
                refreshCaptchaImage()
            } else if (response["status"] == 303) {
                verify_btn.disabled = false;

                username.value = "";
                password.value = "";
                document.getElementById("captcha").value = "";
                M.toast({
                    "html": response["message"]
                });
                setTimeout(function () {
                    window.location.reload()
                }, 4000)
                refreshCaptchaImage()
            } else if (response["status"] == 304) {
                verify_btn.disabled = false;
                document.getElementById("captcha").value = "";
                M.toast({
                    "html": response["message"]
                });
                refreshCaptchaImage()
            } else if (response["status"] == 401) {
                verify_btn.disabled = false;

                M.toast({
                    "html": response["message"]
                }, 2000);
                setTimeout(function () {
                    $("#forgot-pass-btn").click()
                }, 2000);
            } else {
                verify_btn.disabled = false;

                username.value = "";
                password.value = "";
                document.getElementById("captcha").value = "";
                username.focus()
                M.toast({
                    "html": "Please check your username or password"
                }, 2000);
                setTimeout(function () {
                    window.location.reload()
                }, 4000)

                refreshCaptchaImage()
            }
        },
        error: function (error) {
            try {
                document.getElementsByClassName('gy-center')[0].style["-webkit-filter"] = "";
            } catch (err) {
                console.log(err)
            }
        }
    }).responseJSON;

    response = custom_decrypt(response);
    response = JSON.parse(response);
    return response;
}

function edit_verified_username(){
    document.getElementById('verify_btn').disabled = false
    document.getElementById('verify_btn').setAttribute("disabled", true)
    if(document.getElementById("right-side-div-wrapper")){
        verify_inputs = document.getElementsByClassName("forgot-pass-otp-input")
        let incorrect_otp_error = document.getElementById('verify-incorrect-otp-error')
        incorrect_otp_error.style.display = 'none'
        for(let i = 0; i < verify_inputs.length; i++){
            verify_inputs[i].classList.remove('forgot-pass-otp-input-error')
            verify_inputs[i].classList.add('forgot-pass-otp-input-success')
        }
        document.getElementById("right-side-div-wrapper").style.display = "none"
        document.getElementById("login-main-div").style.display = "block"
    }else{
        document.getElementById("mobile-login-block").style.display = "block"
        document.getElementById("otp").style.display = "none"
    }
    document.getElementById("username").value = login_username
    verify_otp_token = ""
    login_username = ""
    refreshCaptchaImage()
}

function cancel_login_otp_process(){
    document.getElementById('verify_btn').disabled = false
    document.getElementById('verify_btn').setAttribute("disabled", true)
    if(document.getElementById("right-side-div-wrapper")){
        verify_inputs = document.getElementsByClassName("forgot-pass-otp-input")
        let incorrect_otp_error = document.getElementById('verify-incorrect-otp-error')
        incorrect_otp_error.style.display = 'none'
        for(let i = 0; i < verify_inputs.length; i++){
            verify_inputs[i].classList.remove('forgot-pass-otp-input-error')
            verify_inputs[i].classList.add('forgot-pass-otp-input-success')
        }
        document.getElementById("right-side-div-wrapper").style.display = "none"
        document.getElementById("login-main-div").style.display = "block"
    }else{
        document.getElementById("mobile-login-block").style.display = "block"
        document.getElementById("otp").style.display = "none"
    }
    document.getElementById("username").value = ""
    document.getElementById("captcha").value = "";
    verify_otp_token = ""
    login_username = ""
    refreshCaptchaImage()
}

function sign_up_function() {

    first_name = document.getElementById("first_name").value;
    last_name = document.getElementById("last_name").value;
    email_id = document.getElementById("email_id").value;
    var text_format = /^[a-zA-Z]+$/;
    document.getElementById('firstname_error_text').style.display = 'none';
    document.getElementById('lastname_error_text').style.display = 'none';
    document.getElementById('email_error_text').style.display = 'none';

    if (first_name.value == "" || text_format.test(first_name) == false) {
        document.getElementById('firstname_error_text').style.display = 'block';
        return;
    }
    if (last_name.value == "" || text_format.test(last_name) == false) {
        document.getElementById('lastname_error_text').style.display = 'block';
        return;
    }
    if (validate_email(email_id) == false) {
        document.getElementById('email_error_text').style.display = 'block';
        return;
    }

    var json_string = JSON.stringify({
        'first_name': first_name,
        'last_name': last_name,
        'email_id': email_id,
    })
    encrypted_json_string = EncryptVariable(json_string)
    csrf_token = get_csrf_token();
    var response = $.ajax({
        url: '/chat/signup/',
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: encrypted_json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                window.location = "/chat/redirect-login/?token=" + response["token"]
            } else if (response["status"] == 300) {
                M.toast({
                    "html": "This account already exists"
                }, 2000);
            } else if (response["status"] == 305) {
                M.toast({
                    "html": "You have crossed the maximum limit of 5 attempts. Please try again later."
                }, 2000);
            } else if (response["status"] == 302) {
                M.toast({
                    "html": response["status_message"]
                }, 2000);
            }
            else {
                M.toast({
                    "html": "We are facing some technical issues, please try later."
                }, 2000);
            }

        },
        error: function (error) {
            console.log(error)
            M.toast({
                'html': 'Unable to connect to server. Please try again later.'
            }, 2000);
        }
    }).responseJSON;

    return response;
}

function resend_sign_up_function(access_token) {

    token = access_token

    var json_string = JSON.stringify({
        'access_token': token,
    })
    encrypted_json_string = EncryptVariable(json_string)
    csrf_token = get_csrf_token();
    var response = $.ajax({
        url: '/chat/resend-link/',
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: encrypted_json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                window.location = "/chat/redirect-login/?token=" + response["token"]
            } else if (response["status"] == 300) {
                M.toast({
                    "html": "Account has already been created."
                }, 2000);
            } else {
                M.toast({
                    "html": "We are facing some technical issues, please try later."
                }, 2000);
            }

        },
        error: function (error) {
            console.log(error)
            M.toast({
                'html': 'Unable to connect to server. Please try again later.'
            }, 2000);
        }
    }).responseJSON;

    return response;
}

function confirm_password_function() {

    url_params = get_url_vars()
    access_token = unescape(url_params["token"])

    password_new = document.getElementById("password").value
    confirm_password = document.getElementById("confirm_password").value

    document.getElementById('password_does_not_match').style.display = "none";

    if (password_new == "" || confirm_password == "") {
        M.toast({
            "html": "Please fill all the fields."
        }, 2000);
        return;
    }

    if (password_new != confirm_password) {
        document.getElementById('password_does_not_match').style.display = "block";
        return;
    }

    password_regex = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[a-zA-Z]).{8,32}$/

    if (password_regex.test(password_new) == false) {

        one_upercase_and_lowercase_regex = /(?=.*[a-z])(?=.*[A-Z])/
        if (one_upercase_and_lowercase_regex.test(password_new) == false) {

            document.getElementById("password-one-lower-one-upper-error-text").style.display = "block";
        } else {

            document.getElementById("password-one-lower-one-upper-error-text").style.display = "none";
        }
        atleast_one_no_regex = /(?=.*\d)/
        if (atleast_one_no_regex.test(password_new) == false) {

            document.getElementById("password-one-number-error-text").style.display = "block";
        } else {

            document.getElementById("password-one-number-error-text").style.display = "none";
        }
        special_char_regex = /(?=.*[@$!%*?&])/
        if (special_char_regex.test(password_new) == false) {

            document.getElementById("password-one-special-char-match-error-text").style.display = "block";
        } else {

            document.getElementById("password-one-special-char-match-error-text").style.display = "none";
        }
        if (password_new.length < 8 || password_new.length > 32) {

            document.getElementById("password-length-error-text").style.display = "block";
        } else {

            document.getElementById("password-length-error-text").style.display = "none";
        }
        return;
    }

    document.getElementById("password-one-lower-one-upper-error-text").style.display = "none";
    document.getElementById("password-one-number-error-text").style.display = "none";
    document.getElementById("password-one-special-char-match-error-text").style.display = "none";
    document.getElementById("password-length-error-text").style.display = "none";

    var json_string = JSON.stringify({
        'access_token': access_token,
        'password_new': password_new
    })
    encrypted_json_string = EncryptVariable(json_string)
    csrf_token = get_csrf_token();
    var response = $.ajax({
        url: '/chat/password-setup/',
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: encrypted_json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                document.getElementById('create_pass_success_div').style.display = "block";
                document.getElementById('create_pass_div').style.display = "none";
            } else {
                M.toast({
                    "html": "We are facing some technical issues, please try later."
                }, 2000);
            }

        }
    }).responseJSON;

    return response;
}



$(document).on("click", "#login_btn", function () {
    login_function(false);
});
$(document).on("click", "#verify_btn", function () {
    verified_login_function(false);
});
$(document).on("click", "#verify-login-otp-button", function () {
    verify_login_otp_function(false);
});
$(document).on("click", "#signup_btn", function () {
    sign_up_function();
});


$(document).on("click", "#confirm_password_btn", function () {
    confirm_password_function();
});

$(document).on("click", "#multifactor-login-session", function () {
    verify_login_otp_function(true);
});
$(document).on("click", "#multifactor-login-session-close", function () {
    try {
        document.getElementsByClassName('gy-center')[0].style["-webkit-filter"] = "";
    } catch (err) { }
});
$(document).on("click", "#login-session", function () {
    login_function(true);
    document.getElementById("username").value = "";
    document.getElementById("password_form").value = "";
    document.getElementById("captcha").value = "";
});
$(document).on("click", "#login-session-close", function () {
    try {
        document.getElementsByClassName('gy-center')[0].style["-webkit-filter"] = "";
    } catch (err) { }
    document.getElementById("username").value = "";
    document.getElementById("password_form").value = "";
    document.getElementById("captcha").value = "";
    refreshCaptchaImage();
});

$(document).on("click", "#forgot-pass-btn, #forgot-pass-link", function (e) {
    document.getElementById("forgot-pass-back-username-error-text").style.display = "none";
    document.getElementById("forgot-pass-back-error-text").style.display = "none";
    document.getElementById("forgot-password-catcha").value = "";
    $(".login-block").hide()
    $("#forgot-password-div").show()
    document.getElementById("reset-password-username").value = "";
    var verify_inputs = document.getElementsByClassName("forgot-pass-otp-input")
    for (var i = 0; i < verify_inputs.length; i++) {
        verify_inputs[i].value = "";
    }

    refresh_forgot_password_captcha_image();
    try {
        document.getElementsByClassName("forgot-pass-step-1")[0].style.display = "block";
    } catch (err) {
        console.log(err)
    }
});

$('#reset-password-username').on('keypress', function (e) {
    if (event.key === " ")
        return false;
});
$('#new-password').on('keypress', function (e) {
    if (event.key === " ")
        return false;
});
$('#retype-password').on('keypress', function (e) {
    if (event.key === " ")
        return false;
});
$(".forgot-pass-otp-input").keydown(function (e) {
    var key = e.keyCode || e.charCode;
    if (key == 8 || key == 46) {
        e.preventDefault();
        e.stopPropagation();
    }
})
$('.forgot-pass-otp-input').on('keypress', function (e) {
    keys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9']
    if(keys.indexOf(event.key) > -1) {
        already_key_pressed++;
    }
    if(already_key_pressed > 1) {
        return false;
    }
    if (keys.indexOf(this.value) != -1) {
        if(keys.indexOf(event.key) != -1){
            $(this).val(event.key)
        }
    }
    return keys.indexOf(event.key) > -1
});
$('.forgot-pass-otp-input').on('keyup', function (e) {
    keys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9']
    let verify_inputs = document.getElementsByClassName("forgot-pass-otp-input")
    let incorrect_forgot_otp_error = document.getElementById('forgot-incorrect-otp-error')
    let incorrect_verify_otp_error = document.getElementById('verify-incorrect-otp-error')
    if (keys.indexOf(this.value) != -1) {
        if(keys.indexOf(event.key) != -1){
            incorrect_forgot_otp_error.style.display = 'none'
            incorrect_verify_otp_error.style.display = 'none'
            for(let i = 0; i < verify_inputs.length; i++){
                verify_inputs[i].classList.remove('forgot-pass-otp-input-error')
                verify_inputs[i].classList.add('forgot-pass-otp-input-success')
            }
            $(this).next().focus();
            already_key_pressed = 0;
        }
    }
    var pressed_key = event.keyCode || event.charCode;
    if (pressed_key == 8 || pressed_key == 46) {
        incorrect_forgot_otp_error.style.display = 'none'
        incorrect_verify_otp_error.style.display = 'none'
        for(let i = 0; i < verify_inputs.length; i++){
            verify_inputs[i].classList.remove('forgot-pass-otp-input-error')
            verify_inputs[i].classList.add('forgot-pass-otp-input-success')
        }
        if(this.value == ''){
            $(this).prev().focus();
            $(this).prev().val('');
        }else{
            $(this).val('');
            $(this).focus();
        }
        already_key_pressed = 0;
    }
});

$("#resend_forgot_password_otp").on('click', function (e) {

    resend_mail_for_otp();


});

$("#resend_verify_login_otp").on('click', function (e) {
    resend_verify_mail_for_otp();
    disable_verify_otp_for_one_minute();
});
$("#verify_login_cancel").on('click', function (e) {
    cancel_login_otp_process();
});

$("#verify-reset-password-otp-button").on('click', function (e) {

    verify_forgot_password_otp();

});


$("#reset-pass-btn").on('click', function (e) {

    save_reseted_password_for_forgot_password();

});

function save_reseted_password_for_forgot_password() {

    let access_token = get_url_vars()['token']

    password_new = document.getElementById("new_password").value
    confirm_password = document.getElementById("confirm_new_password").value

    password_regex = /^(?=.*\d)(?=.*[a-z])(?=.*[A-Z])(?=.*[a-zA-Z]).{8,32}$/

    if (password_regex.test(password_new) == false) {

        one_upercase_and_lowercase_regex = /(?=.*[a-z])(?=.*[A-Z])/
        if (one_upercase_and_lowercase_regex.test(password_new) == false) {

            document.getElementById("password-one-lower-one-upper-error-text").style.display = "block";
        } else {

            document.getElementById("password-one-lower-one-upper-error-text").style.display = "none";
        }
        atleast_one_no_regex = /(?=.*\d)/
        if (atleast_one_no_regex.test(password_new) == false) {

            document.getElementById("password-one-number-error-text").style.display = "block";
        } else {

            document.getElementById("password-one-number-error-text").style.display = "none";
        }
        special_char_regex = /(?=.*[@$!%*?&])/
        if (special_char_regex.test(password_new) == false) {

            document.getElementById("password-one-special-char-match-error-text").style.display = "block";
        } else {

            document.getElementById("password-one-special-char-match-error-text").style.display = "none";
        }

        if (password_new.length < 8 || password_new.length > 32) {

            document.getElementById("password-length-error-text").style.display = "block";
        } else {

            document.getElementById("password-length-error-text").style.display = "none";
        }
        return;
    }

    document.getElementById("password-one-lower-one-upper-error-text").style.display = "none";
    document.getElementById("password-one-number-error-text").style.display = "none";
    document.getElementById("password-one-special-char-match-error-text").style.display = "none";
    document.getElementById("password-length-error-text").style.display = "none";

    if (password_new == "" || confirm_password == "") {
        showToast("passwords can not be empty")
        return;
    }

    if (password_new != confirm_password) {
        document.getElementById("password-match-error-text").style.display = "block"
        return;
    }
    document.getElementById("password-match-error-text").style.display = "none"
    var json_string = JSON.stringify({
        'access_token': access_token,
        'password_new': password_new
    })

    encrypted_json_string = EncryptVariable(json_string)
    csrf_token = get_csrf_token();
    var response = $.ajax({
        url: '/chat/save-reseted-password-for-forgot-password/',
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: encrypted_json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                $("#reset-password-div").hide()
                $("#reset-password-succesfull-div").show()
            } else {
                showToast(response["message"])
            }

        }
    }).responseJSON;

    return response;


}



function disable_resend_otp_button_for_thirty_seconds() {

    document.getElementById("resend_forgot_password_otp").disabled = true
    document.getElementById("resend_forgot_password_otp").style.cursor = "not-allowed"
    document.getElementById("resend_forgot_password_otp").style.opacity = "0.25"
    document.getElementById("resend_forgot_password_otp").classList.add("disabled-link")
    setTimeout(function () {
        document.getElementById("resend_forgot_password_otp").disabled = false
        document.getElementById("resend_forgot_password_otp").style.cursor = "pointer"
    document.getElementById("resend_forgot_password_otp").style.opacity = "1"
    document.getElementById("resend_forgot_password_otp").classList.remove("disabled-link")
    }, resend_otp_time_limit)

}

function verify_forgot_password_otp() {
    username = document.getElementById("reset-password-username");
    verify_inputs = document.getElementsByClassName("forgot-pass-otp-input")
    let incorrect_otp_error = document.getElementById('forgot-incorrect-otp-error')
    incorrect_otp_error.style.display = 'none'
    for(let i = 0; i < verify_inputs.length; i++){
        verify_inputs[i].classList.remove('forgot-pass-otp-input-error')
        verify_inputs[i].classList.add('forgot-pass-otp-input-success')
    }
    tempusername = stripHTML(username.value).trim();
    if (tempusername == "") {
        showToast("Invalid Username")
        return;
    }
    if (validate_email(tempusername) == false) {
        showToast("Username should be a valid Email Id")
        return;
    }
    var verification_code = ""
    for (var i = 0; i < verify_inputs.length; i++) {
        verification_code += verify_inputs[i].value
    }

    if (verification_code.length != 6) {
        document.getElementById("forgot-password-invalid-otp-error").style.display = "block";
        return
    }

    document.getElementById("forgot-password-invalid-otp-error").style.display = "none";

    var json_string = JSON.stringify({
        'user_name': tempusername,
        'otp_access_token': verify_otp_token,
        'otp': verification_code,
    })

    encrypted_json_string = EncryptVariable(json_string)

    csrf_token = get_csrf_token();
    var response = $.ajax({
        url: '/chat/forgot-password-verify-otp/',
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: encrypted_json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                $("#forgot-pass-otp").modal("close")
                $("#forgot-pass-otp-sucess").modal('open')
                $("#forgot-pass-otp-div").hide()
                $("#reset-password-sucess-div").show()

            } else if (response["status"] == 301) {
                showToast(response["status_message"], 2000)
                $("#forgot-pass-otp").modal("close")
            }else if(response["status"] == 400){
                for(let i = 0; i < verify_inputs.length; i++){
                    verify_inputs[i].classList.remove('forgot-pass-otp-input-success')
                    verify_inputs[i].classList.add('forgot-pass-otp-input-error')
                }
                incorrect_otp_error.style.display = 'block'
            } else {
                document.getElementById("forgot-password-invalid-otp-error").style.display = "block";
            }

        }
    }).responseJSON;

    response = custom_decrypt(response);
    response = JSON.parse(response);
    return response;
}



function resend_mail_for_otp() {
    username = document.getElementById("reset-password-username");
    tempusername = stripHTML(username.value).trim();
    if (tempusername == "") {
        document.getElementById("forgot-pass-back-username-error-text").style.display = "block";
        return;
    }
    if (validate_email(tempusername) == false) {
        document.getElementById("forgot-pass-back-username-error-text").style.display = "block";
        return;
    }
    document.getElementById("forgot-pass-back-username-error-text").style.display = "none";

    var json_string = JSON.stringify({
        'user_name': tempusername,
        'otp_access_token': verify_otp_token,
    })

    encrypted_json_string = EncryptVariable(json_string)

    csrf_token = get_csrf_token();
    var response = $.ajax({
        url: '/chat/forgot-password-resend-otp/',
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: encrypted_json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);

            if (response["status"] == 200) {
                showToast("OTP Resent Succesfully", 2000)
                disable_resend_otp_button_for_thirty_seconds();
            } else if (response["status"] == 301) {
                disable_resend_otp_button_for_thirty_seconds();
            } else {
                showToast("Thier was some error in Resending The OTP , Please Refresh and Try Again.", 2000)
                disable_resend_otp_button_for_thirty_seconds();
            }

        }
    }).responseJSON;

    response = custom_decrypt(response);
    response = JSON.parse(response);
    return response;

}

function resend_verify_mail_for_otp() {
    username = login_username
    tempusername = stripHTML(username).trim();
    if (tempusername == "") {
        document.getElementById("forgot-pass-back-username-error-text").style.display = "block";
        return;
    }
    if (validate_email(tempusername) == false) {
        document.getElementById("forgot-pass-back-username-error-text").style.display = "block";
        return;
    }

    var json_string = JSON.stringify({
        'user_name': tempusername,
        'otp_access_token': verify_otp_token,
    })

    encrypted_json_string = EncryptVariable(json_string)

    csrf_token = get_csrf_token();
    var response = $.ajax({
        url: '/chat/resend-multifactor-login-otp/',
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: encrypted_json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);

            if (response["status"] == 200) {
                showToast("OTP Resent Succesfully", 2000)
                disable_verify_otp_for_one_minute();
            } else if (response["status"] == 301) {
                showToast(response["status_message"], 2000)
                disable_verify_otp_for_one_minute();
            } else {
                showToast("Thier was some error in Resending The OTP , Please Refresh and Try Again.", 2000)
                disable_verify_otp_for_one_minute();
            }

        }
    }).responseJSON;

    response = custom_decrypt(response);
    response = JSON.parse(response);
    return response;

}

$(document).on("click", "#forgot-password-edit-username-button", function (e) {

    $("#forgot-pass-otp-div").hide()
    $("#forgot-password-div").show()

});

$(document).on("click", "#forgot-password-modal-get-otp-button", function (e) {

    verify_inputs = document.getElementsByClassName("forgot-pass-otp-input")
    let incorrect_otp_error = document.getElementById('forgot-incorrect-otp-error')
    for(let i = 0; i < verify_inputs.length; i++){
        verify_inputs[i].classList.remove('forgot-pass-otp-input-error')
        verify_inputs[i].classList.add('forgot-pass-otp-input-success')
    }
    username = document.getElementById("reset-password-username");
    tempusername = stripHTML(username.value).trim();
    if (tempusername == "") {
        document.getElementById("forgot-pass-back-username-error-text").style.display = "block";
        return;
    }
    if (validate_email(tempusername) == false) {
        document.getElementById("forgot-pass-back-username-error-text").style.display = "block";
        return;
    }
    document.getElementById("forgot-pass-back-username-error-text").style.display = "none";
    captcha = document.getElementById("forgot-password-catcha").value;
    if (captcha == "") {
        document.getElementById("forgot-pass-back-error-text").style.display = "block"
        refresh_forgot_password_captcha_image()
        return;
    }
    document.getElementById("forgot-pass-back-error-text").style.display = "none"
    captcha_image = document.getElementById("forgot_password_captcha_image").src.split("/");
    captcha_image = captcha_image[captcha_image.length - 1];


    var json_string = JSON.stringify({
        'user_name': tempusername,
        'captcha': captcha,
        'captcha_image': captcha_image
    })

    encrypted_json_string = EncryptVariable(json_string)

    csrf_token = get_csrf_token();
    var response = $.ajax({
        url: '/chat/check-user-exists/',
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: encrypted_json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);

            if (response["status"] == 200) {

                refresh_forgot_password_captcha_image()
                document.getElementById("forgot-password-catcha").value = "";
                $("#otp-modal-username").html(tempusername)
                $("#forgot-pass-back").modal('close')
                $("#forgot-pass-otp").modal('open')
                $("#forgot-pass-otp-div").show()
                $("#forgot-password-div").hide()
                incorrect_otp_error.style.display = "none"
                disable_resend_otp_button_for_thirty_seconds();
                verify_otp_token = response["otp_access_token"]

            } else if (response["status"] == 303) {
                refresh_forgot_password_captcha_image()
                document.getElementById("forgot-password-catcha").value = "";
                $("#otp-modal-username").html(tempusername)
                $("#forgot-pass-back").modal('close')
                $("#forgot-pass-otp").modal('open')
                $("#forgot-pass-otp-div").show()
                $("#forgot-password-div").hide()
                incorrect_otp_error.style.display = "none"
                disable_resend_otp_button_for_thirty_seconds();
                verify_otp_token = response["otp_access_token"]
            } else if (response["status"] == 304) {
                document.getElementById("forgot-password-catcha").value = "";
                document.getElementById("forgot-pass-back-error-text").style.display = "block"
                refresh_forgot_password_captcha_image();
                document.getElementById("forgot-password-catcha").value = "";
            } else if (response["status"] == 305) {
                document.getElementById("error-user-exists").innerText = "Note that you have exceed the number of reset password attempts, please try again after 24 hour.";
                document.getElementById("error-user-exists").style.display = "block";
                refresh_forgot_password_captcha_image();
                document.getElementById("forgot-password-catcha").value = "";
            }
        }
    }).responseJSON;

    response = custom_decrypt(response);
    response = JSON.parse(response);
    return response;
});

$(document).on("click", ".verify-code-btn", function (e) {

    username = document.getElementById("reset-password-username");

    verify_inputs = document.getElementsByClassName("forgot-pass-otp-input")
    var verification_code = ""
    for (var i = 0; i < verify_inputs.length; i++) {
        verification_code += verify_inputs[i].value
    }
    if (verification_code.length != 4) {
        alert("Please provide valid verification code")
        return
    }
    tempusername = stripHTML(username.value);
    var json_string = JSON.stringify({
        'user_name': tempusername,
        'verification_code': verification_code
    })
    document.getElementsByClassName("verify-code-btn")[0].style.display = "none";
    document.getElementById("easychat-reset-pass-loader-2").style.display = "block";
    encrypted_json_string = EncryptVariable(json_string)

    csrf_token = get_csrf_token();
    var response = $.ajax({
        url: '/chat/verify-reset-pass-code/',
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: encrypted_json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            document.getElementsByClassName("verify-code-btn")[0].style.display = "block";
            document.getElementById("easychat-reset-pass-loader-2").style.display = "none";
            if (response["status"] == 200) {
                document.getElementsByClassName("forgot-pass-step-2")[0].style.display = "none";
                document.getElementsByClassName("forgot-pass-step-3")[0].style.display = "block";
            } else if (response["status"] == 302) {
                document.getElementById("error-verify-code").innerText = "Wrong code!! Please try again." + response["attempts_remaining"] + " retry remaining";
                document.getElementById("error-verify-code").style.display = "block";
            } else if (response["status"] == 303) {
                document.getElementById("error-verify-code").innerText = "No retry remaining! Please try after some time";
                document.getElementById("error-verify-code").style.display = "block";
            }
        }
    }).responseJSON;

    return response;
});

$(document).on("click", "#save-password", function (e) {

    new_password = document.getElementById("new-password").value;
    retype_password = document.getElementById("retype-password").value;

    if (new_password.trim() == "") {
        alert("Password cannot be blank.")
        return
    }
    if (new_password != retype_password) {
        alert("Passwords are not matching. please check.")
        return
    }

    verify_inputs = document.getElementsByClassName("forgot-pass-otp-input")
    var verification_code = ""
    for (var i = 0; i < verify_inputs.length; i++) {
        verification_code += verify_inputs[i].value
    }

    username = document.getElementById("reset-password-username");
    tempusername = stripHTML(username.value);

    var json_string = JSON.stringify({
        'user_name': tempusername,
        'verification_code': verification_code,
        'new_password': new_password,
    })
    document.getElementById("save-password").style.display = "none";
    document.getElementById("easychat-reset-pass-loader-3").style.display = "block";
    encrypted_json_string = EncryptVariable(json_string)

    csrf_token = get_csrf_token();
    var response = $.ajax({
        url: '/chat/reset-pass/',
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: encrypted_json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            document.getElementById("save-password").style.display = "block";
            document.getElementById("easychat-reset-pass-loader-3").style.display = "none";
            if (response["status"] == 200) {
                M.toast({
                    'html': 'Password changed. Please sign in with new password.'
                }, 2000);
                document.getElementsByClassName("forgot-pass-step-3")[0].style.display = "none";
                document.getElementsByClassName("forgot-pass-back")[0].style.display = "none";
            } else if (response["status"] == 401) {
                M.toast({
                    'html': response["message"]
                }, 2000);
            } else {
                M.toast({
                    'html': 'Error: Unable to change password'
                }, 2000);

            }
        }
    }).responseJSON;

    return response;
});


function refreshCaptchaImage() {
    captcha_image = document.getElementById("captcha_image").src;
    encrypted_captcha_image = EncryptVariable(captcha_image)
    $.ajax({
        url: '/chat/get-captcha-image/',
        type: 'POST',
        async: false,
        data: {
            captcha_image: encrypted_captcha_image,
        },
        success: function (response) {

            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response['status'] == 200) {
                host_name = window.location.host;
                host_name = host_name.toString();
                new_captcha_image = response["captcha_image"];
                old_captch_image = document.getElementById("captcha_image");
                old_captch_image.src = new_captcha_image;
            } else {
                M.toast({
                    'html': 'Unable to connect to server. Please try again later.'
                }, 2000);
            }
        },
        error: function (error) {
            M.toast({
                'html': 'Unable to connect to server. Please try again later.'
            }, 2000);
        }
    });
}


function refresh_forgot_password_captcha_image() {
    captcha_image = document.getElementById("forgot_password_captcha_image").src;
    encrypted_captcha_image = EncryptVariable(captcha_image)
    $.ajax({
        url: '/chat/get-captcha-image/',
        type: 'POST',
        async: false,
        data: {
            captcha_image: encrypted_captcha_image,
        },
        success: function (response) {

            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response['status'] == 200) {
                host_name = window.location.host;
                host_name = host_name.toString();
                new_captcha_image = response["captcha_image"];
                old_captch_image = document.getElementById("forgot_password_captcha_image");
                old_captch_image.src = new_captcha_image;
            } else {
                M.toast({
                    'html': 'Unable to connect to server. Please try again later.'
                }, 2000);
            }
        },
        error: function (error) {
            M.toast({
                'html': 'Unable to connect to server. Please try again later.'
            }, 2000);
        }
    });
}


/////////////////////////////////////////////////////// Developer Authentication JS End

function renameTree(new_name, tree_pk, parent_pk) {
    var json_string = JSON.stringify({
        tree_name: new_name,
        tree_pk: tree_pk,
        parent_pk: parent_pk
    })

    json_string = EncryptVariable(json_string);

    $.ajax({
        url: '/chat/rename-tree/',
        type: 'POST',
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response['status'] == 200) {
                M.toast({
                    'html': 'Tree renamed successfully!'
                }, 2000);
            } else {
                M.toast({
                    'html': 'Unable to connect to server. Please try again later.'
                }, 2000);
            }
        },
        error: function (error) {
            M.toast({
                'html': 'Unable to connect to server. Please try again later.'
            }, 2000);
        }
    });
}

function deleteTree(tree_pk, intent_pk, parent_pk) {
    var json_string = JSON.stringify({
        tree_pk: tree_pk,
        intent_pk: intent_pk,
        parent_pk: parent_pk
    })

    json_string = EncryptVariable(json_string)

    var response = $.ajax({
        url: '/chat/delete-tree/',
        type: 'POST',
        async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {
            return response;
        },
        error: function (error) {
            M.toast({
                'html': 'Unable to connect to server. Please try again later.'
            }, 2000);
            return error;
        }
    }).responseJSON;

    response = custom_decrypt(response)
    response = JSON.parse(response);
    return response;
}

function deleteTreeNode(tree_pk, intent_pk, parent_pk) {
    var json_string = JSON.stringify({
        tree_pk: tree_pk,
        intent_pk: intent_pk,
        parent_pk: parent_pk
    })

    json_string = EncryptVariable(json_string)

    var response = $.ajax({
        url: '/chat/delete-tree-node/',
        type: 'POST',
        async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {
            return response;
        },
        error: function (error) {
            M.toast({
                'html': 'Unable to connect to server. Please try again later.'
            }, 2000);
            return error;
        }
    }).responseJSON;

    response = custom_decrypt(response)
    response = JSON.parse(response);
    return response;
}

function pasteTreeNode(tree_pk, intent_pk, parent_pk, copy_tree_id) {
    var json_string = JSON.stringify({
        tree_pk: tree_pk,
        intent_pk: intent_pk,
        parent_pk: parent_pk,
        copy_tree_id: copy_tree_id
    })

    json_string = EncryptVariable(json_string)

    var response = $.ajax({
        url: '/chat/paste-tree-node/',
        type: 'POST',
        async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {
            return response;
        },
        error: function (error) {
            M.toast({
                'html': 'Unable to connect to server. Please try again later.'
            }, 2000);
            return error;
        }
    }).responseJSON;

    response = custom_decrypt(response)
    response = JSON.parse(response);
    return response;
}

function createChildTree(tree_pk, tree_name) {
    tree_name = stripHTML(tree_name)
    tree_name = tree_name.trim()
    if (tree_name == "") {
        $("#child_tree_name").val("")
        M.toast({
            'html': 'Child Tree name cannot be empty!'
        }, 2000);
        return false;
    }

    var json_string = JSON.stringify({
        tree_pk: tree_pk,
        tree_name: tree_name
    })

    json_string = EncryptVariable(json_string)

    $.ajax({
        url: '/chat/create-tree/',
        type: 'POST',
        async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response['status'] == 200) {
                M.toast({
                    'html': 'Child Tree Created successfully!'
                }, 2000);
                setTimeout(function () {
                    window.location = "/chat/edit-tree/?intent_pk=" + global_select_intent_id + "&parent_pk=" + tree_pk + "&tree_pk=" + response["child_tree_pk"] + "&selected_language=en";
                }, 2000);
            } else {
                M.toast({
                    'html': 'Unable to connect to server. Please try again later.'
                }, 2000);
            }
        },
        error: function (error) {
            M.toast({
                'html': 'Unable to connect to server. Please try again later.'
            }, 2000);
        }
    });
}

function insertChildTree(tree_pk, tree_name) {
    var json_string = JSON.stringify({
        tree_pk: tree_pk,
        tree_name: tree_name
    })

    json_string = EncryptVariable(json_string)

    $.ajax({
        url: '/chat/insert-tree/',
        type: 'POST',
        async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response['status'] == 200) {
                M.toast({
                    'html': 'Child Tree Inserted successfully!'
                }, 2000);
                setTimeout(function () {
                    window.location = "/chat/edit-tree/?intent_pk=" + global_select_intent_id + "&parent_pk=" + tree_pk + "&tree_pk=" + response["child_tree_pk"];
                }, 2000);
            } else {
                M.toast({
                    'html': 'Unable to connect to server. Please try again later.'
                }, 2000);
            }
        },
        error: function (error) {
            M.toast({
                'html': 'Unable to connect to server. Please try again later.'
            }, 2000);
        }
    });
}

window.addEventListener('scroll', function(e){
    $("#menu-div").hide();
}, true);
 

$(document).on("click", function (e) {
    $("#menu-div").hide();
    $("#api-menu-div").hide();
});

$(document).on("click", "#agree-create-tree", function (e) {
    if (global_select_tree_id != -1) {
        createChildTree(global_select_tree_id, $("#child_tree_name").val());
    }
});

$(document).on("click", "#agree-insert-tree", function (e) {
    if (global_select_tree_id != -1) {
        insertChildTree(global_select_tree_id, $("#insert_child_tree_name").val());
    }
});

$(document).on("click", "#agree-rename-tree", function (e) {
    if (global_select_tree_id != -1) {
        renameTree($("#modal_tree_name").val(), global_select_tree_id, global_select_parent_id);
    }

    e.preventDefault();
    if (global_select_intent_id != -1) {
        renderTreeStructureByIntentID(global_select_intent_id);
        window.location = '/chat/edit-intent/?intent_pk=' + global_select_intent_id;
    }
});

$(document).on("click", "#agree-delete-tree", function (e) {
    if (global_select_tree_id != -1 && global_select_intent_id != -1) {
        response = deleteTree(global_select_tree_id, global_select_intent_id, global_select_parent_id);
        if (response['status'] == 200) {
            if (response["is_root"] == true) {
                M.toast({
                    'html': 'You cannot perform this action'
                }, 2000);
                // setTimeout(function() {
                //     window.location = '/chat/intent/';
                // }, 2000);
            } else {
                M.toast({
                    'html': 'Tree deleted successfully!'
                }, 2000);
                renderTreeStructureByIntentID(global_select_intent_id);
                setTimeout(function () {
                    window.location = '/chat/edit-intent/?intent_pk=' + global_select_intent_id;
                }, 2000);
            }
        } else {
            M.toast({
                'html': 'Unable to connect to server. Please try again later.'
            }, 2000);
            setTimeout(function () {
                window.location.reload();
            }, 2000);
        }
    }
});

$(document).on("click", "#create-tree-node", function (e) {
    $("#create-tree-modal").modal("open");
});

$(document).on("click", "#delete-tree-flow", function (e) {
    $("#delete-tree-modal-info").html("<li>Performing above task will delete selected Intent( " + global_select_tree_name + " )</li><li>All child intents of \"" + global_select_tree_name + "\" will be deleted.</li>")
    $("#delete-tree-modal").modal("open");
});

$(document).on("click", "#delete-tree-node", function (e) {
    $("#delete-node-modal-info").html("<li>Performing above task will delete selected Intent( " + global_select_tree_name + " )</li><li>All child intents of \"" + global_select_tree_name + "\"will be retained and will be connected to " + global_select_tree_name + "'s parent node.</li>");
    $("#delete-node-modal").modal("open");
});

$(document).on("click", "#insert-tree-node", function (e) {
    $("#insert-tree-modal-info").html("<li>Performing above task will create new node between \"" + global_select_tree_name + "\"and its childs</li>");
    $("#insert-tree-modal").modal("open");
});

$(document).on("click", "#copy-tree-node", function (e) {
    if (global_select_tree_id != -1 && global_select_intent_id != -1) {
        set_cookie("copy_tree_id", global_select_tree_id, "/chat/")
        M.toast({
            'html': 'Tree copied',
            'displayLength': 500
        });
        $("#paste-tree-node").removeClass("disbled-paste-btn")
    }
});

$(document).on("click", "#paste-tree-node", function (e) {
    if (global_select_tree_id != -1 && global_select_intent_id != -1 && get_cookie("copy_tree_id") != "") {
        copy_tree_id = get_cookie("copy_tree_id")
        response = pasteTreeNode(global_select_tree_id, global_select_intent_id, global_select_parent_id, copy_tree_id);
        // set_cookie("copy_tree_id", "", "/chat/")
        if (response['status'] == 200) {
            M.toast({
                'html': 'Tree pasted',
                'displayLength': 500
            });
            setTimeout(function () {
                window.location = '/chat/edit-intent/?intent_pk=' + global_select_intent_id;
            }, 1000);
        } else {
            M.toast({
                'html': 'Unable to connect to server. Please try again later.'
            }, 2000);
            // setTimeout(function(){window.location = '/chat/intent/';}, 2000);
        }
    }
});

$(document).on("click", "#agree-delete-node", function (e) {
    if (global_select_tree_id != -1 && global_select_intent_id != -1) {
        response = deleteTreeNode(global_select_tree_id, global_select_intent_id, global_select_parent_id);
        if (response['status'] == 200) {
            if (response["is_root_childs_present"] == true) {
                M.toast({
                    'html': 'Yoc cannot perform this action!'
                }, 2000);
            } else {
                M.toast({
                    'html': 'Tree Node deleted successfully!'
                }, 2000);

                copy_tree_id = get_cookie('copy_tree_id');

                if (copy_tree_id && copy_tree_id == global_select_tree_id) {
                    set_cookie('copy_tree_id', '', '/chat/');
                }

                renderTreeStructureByIntentID(global_select_intent_id);
                setTimeout(function () {
                    window.location = '/chat/edit-intent/?intent_pk=' + global_select_intent_id;
                }, 2000);
            }
        } else {
            M.toast({
                'html': 'Unable to connect to server. Please try again later.'
            }, 2000);

            setTimeout(function () {
                window.location = '/chat/intent/';
            }, 2000);
        }
    }
});

function fetchTreeInformationByID(tree_pk) {
    var json_string = JSON.stringify({
        tree_pk: tree_pk,
        bot_id: SELECTED_BOT_OBJ_ID,
    })

    json_string = EncryptVariable(json_string);

    var response = $.ajax({
        url: '/chat/fetch-tree-information/',
        type: 'POST',
        async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {

            return response;
        },
        error: function (error) {
            return {
                "status": 500
            };
        }
    }).responseJSON;

    response = custom_decrypt(response)
    response = JSON.parse(response);

    return response;
}


function loadTreeEditForm() {

    $(document).ready(function () {
        $('.modal').modal();
    });

    $(document).on("click", "#add-tree-card", function (e) {

        tree_card_title = $("#tree_card_title").val();
        tree_card_content = $("#tree_card_content").val();
        tree_card_link = $("#tree_card_link").val().trim();
        tree_card_img_url = $("#tree_card_img_url").val().trim();

        var format = /[`#%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;

        if (format.test(tree_card_title.trim())) {

            M.toast({
                "html": "Please provide valid intent card title"
            });
            return;
        }

        tree_card_title = stripHTML(tree_card_title.trim())
        tree_card_title = strip_unwanted_characters(tree_card_title)

        tree_card_content = stripHTML(tree_card_content.trim())
        tree_card_content = strip_unwanted_security_characters(tree_card_content)

        if (tree_card_title == "") {
            M.toast({
                "html": "Please provide valid tree card title."
            });
            return;
        }

        if (tree_card_content.trim() == "") {
            M.toast({
                "html": "Please provide valid tree card content."
            });
            return;
        }

        if (tree_card_link.trim() == "" || tree_card_img_url.trim() == "") {
            M.toast({
                "html": "Card Image or Card Link is empty."
            });
            return;
        }

        if (isValidURL(tree_card_link) == false) {
            M.toast({
                "html": "Please provide valid redirect card url"
            });
            return;
        }

        if (isValidURL(tree_card_img_url) == false) {
            M.toast({
                "html": "Please provide valid image card url"
            });
            return;
        }

        if (global_last_edit_card_id != null) {
            if (!adding_new_tree_card) {
                e.preventDefault();
                element = "#" + global_last_edit_card_id;
                $(element).remove();
            }
            global_last_edit_card_id = null;
        }

        addTreeResponseCardIntoCollection(tree_card_title, tree_card_content, tree_card_link, tree_card_img_url)
    });

    $(document).on("click", "#upload-tree-image", function (e) {
        e.preventDefault();
        var input_upload_image = ($("#input_upload_image_tree"))[0].files[0]

        if (input_upload_image == null || input_upload_image == undefined) {
            M.toast({
                "html": "Please select a file."
            }, 2000);

            setTimeout(function () {
                $('#modal-upload-image-tree').modal('open');
            }, 200);
            return false;
        }

        if (check_malicious_file(input_upload_image.name) == true) {
            setTimeout(function () {
                $('#modal-upload-image-tree').modal('open');
            }, 200);
            return false;
        }

        var reader = new FileReader();
        reader.readAsDataURL(input_upload_image);
        reader.onload = function () {

            base64_str = reader.result.split(",")[1];

            uploaded_file = [];
            uploaded_file.push({
                "filename": input_upload_image.name,
                "base64_file": base64_str,
            });

            upload_tree_image();
        };

        reader.onerror = function (error) {
            console.log('Error: ', error);
        };
    });

    async function upload_tree_image() {
        var response = await upload_image();

        if (response && response.status == 200) {
            addTreeResponseImageIntoCollection(window.location.origin + response["src"]);
            M.toast({
                "html": "Image Uploaded Successfully."
            }, 2000)
        }
    }

    $(document).on("click", "#upload-tree-image-card", function (e) {
        e.preventDefault();
        var input_upload_image = ($("#input_upload_image_tree_card"))[0].files[0]

        if (input_upload_image == null || input_upload_image == undefined) {
            M.toast({
                "html": "Please select a file."
            }, 2000);

            setTimeout(function () {
                $('#modal-tree-card').modal('open');
            }, 200);
            return false;
        }

        if (check_malicious_file(input_upload_image.name) == true) {
            setTimeout(function () {
                $("#modal-tree-card").modal("open");
            }, 200);
            return false;
        }

        var reader = new FileReader();
        reader.readAsDataURL(input_upload_image);
        reader.onload = function () {

            base64_str = reader.result.split(",")[1];

            uploaded_file = [];
            uploaded_file.push({
                "filename": input_upload_image.name,
                "base64_file": base64_str,
            });

            upload_tree_image_card();
        };

        reader.onerror = function (error) {
            console.log('Error: ', error);
        };

    });

    async function upload_tree_image_card() {
        var response = await upload_image();

        if (response && response.status == 200) {
            src = window.location.origin + response["src"];
            $("#tree_card_img_url").val(src);
            document.getElementById('input_upload_image_tree_card2').value = "";
            M.toast({
                "html": "Image Uploaded Successfully."
            }, 2000);
        }

        $("#modal-tree-card").modal("open");
    }

    $(document).on("click", "#upload-tree-file-card", function (e) {
        e.preventDefault();
        var input_upload_file = ($("#input_upload_file_tree_card"))[0].files[0]

        if (input_upload_file == null || input_upload_file == undefined) {
            M.toast({
                "html": "Please select a file."
            }, 2000);

            setTimeout(function () {
                $('#modal-tree-card').modal('open');
            }, 200);
            return false;
        }

        if (check_malicious_file(input_upload_file.name) == true) {
            setTimeout(function () {
                $("#modal-tree-card").modal("open");
            }, 200);
            return false;
        }

        var reader = new FileReader();
        reader.readAsDataURL(input_upload_file);
        reader.onload = function () {

            base64_str = reader.result.split(",")[1];

            uploaded_file = [];
            uploaded_file.push({
                "filename": input_upload_file.name,
                "base64_file": base64_str,
            });

            upload_tree_file_card();
        };

        reader.onerror = function (error) {
            console.log('Error: ', error);
        };

    });

    async function upload_tree_file_card() {
        let response = await upload_file_card();

        if (response && response.status == 200) {
            src = window.location.origin + response["src"];
            document.getElementById('input_upload_file_tree_card2').value = "";
            $("#tree_card_link").val(src);
            M.toast({
                "html": "File Uploaded Successfully."
            }, 2000);
        }

        $("#modal-tree-card").modal("open");
    }
    
    $("#add_enter_tree_image_url_data").keypress(function (e) {
        var keycode = (e.keyCode ? e.keyCode : e.which);
        if (keycode == '13') {
            value = $("#add_enter_tree_image_url_data").val();
            addTreeResponseImageIntoCollection(value, "");
            $("#add_enter_tree_image_url_data").val("");
        }
    });

    $("#add_enter_tree_video_url_data").keypress(function (e) {
        var keycode = (e.keyCode ? e.keyCode : e.which);
        if (keycode == '13') {
            value = $("#add_enter_tree_video_url_data").val();
            addTreeResponseVideoIntoCollection(value, "");
            $("#add_enter_tree_video_url_data").val("");
        }
    });

}

var tree_image_url_count = 0;

function addTreeResponseImageIntoCollection(url) {

    if (url.startsWith("/files/")) {
        url = window.location.protocol + "//" + window.location.host + url;
    }

    if (isValidURL(url) == false) {
        M.toast({
            "html": "Please provide valid image url"
        }, 2000);
        return;
    }

    var id = "tree_image_url_" + tree_image_url_count.toString();
    var str_id = "tree_image_url_" + tree_image_url_count.toString();

    var html = `
    <li class="collection-item" id="` + id + `">
      <div class="row">
        <div style="display:none;">
        <input placeholder="Image url" id="imageurl_` + str_id + `" type="text" data-length="100" value="` + url + `" style="width: 80%" required>
        <label for="` + str_id + `"></label>
        </div>
        <img class="responsive-img" src="` + url + `">
        <div class="secondary-content">
        <a href="" class="delete-button-tree-image-url" id="` + id + `">
          <i class="inline-icon material-icons red-text text-darken-3">delete</i>
        </a>
        </div>
      </div>
    </li>`;

    $(html).appendTo($("#tree-image-url-collection"));
    tree_image_url_count += 1;
}

var tree_video_url_count = 0;

function addTreeResponseVideoIntoCollection(url) {

    if (isValidURL(url) == false) {
        M.toast({
            "html": "Please provide valid video url"
        }, 2000);
        return;
    }

    var embed_url = getEmbedVideoURL(url);

    var id = "tree_video_url_" + tree_video_url_count.toString();
    var str_id = "tree_video_url_" + tree_video_url_count.toString();

    var html = `
    <li class="collection-item" id="` + id + `">
      <div class="row">
        <div style="display:none;">
        <input placeholder="Video url" id="videourl_` + str_id + `" type="text" data-length="100" value="` + embed_url + `" style="width: 80%" required>
        <label for="` + str_id + `"></label>
        </div>`;

    if (embed_url == url) {
        html += `
        <video width="320" height="240" controls>
          <source src="` + embed_url + `" type="video/mp4">
        </video>`;
    } else {
        html += `
        <div class="video-container">
          <iframe src="` + embed_url + `" frameborder="0" allowfullscreen></iframe>
        </div>`;
    }

    html += `<br>
        <div class="secondary-content">
        <a href="" class="delete-button-tree-video-url" id="` + id + `">
          <i class="inline-icon material-icons red-text text-darken-3">delete</i>
        </a>
        </div>
      </div>
    </li>`;

    $(html).appendTo($("#tree-video-url-collection"));
    tree_video_url_count += 1;
}

var tree_card_count = 0;
function get_selected_language_from_url() {
    let selected_language = get_url_vars()["selected_language"]
    if (!selected_language) {
        selected_language = "en";
    }
    return selected_language
}
function addTreeResponseCardIntoCollection(title, content, link, img_url) {

    if (link != null && link != undefined && link.startsWith("/files/")) {
        link = window.location.protocol + "//" + window.location.host + link;
    }

    if (img_url != null && img_url != undefined && img_url.startsWith("/files/")) {
        img_url = window.location.protocol + "//" + window.location.host + img_url;
    }

    var id = "tree_card_" + tree_card_count.toString();
    var str_id = "tree_card_" + tree_card_count.toString();
    let selected_language = get_selected_language_from_url();
    var html = `
    <li class="collection-item" id="` + id + `">
    <div class="row">
      <div class="col s5">
        <div class="card">
        <div class="card-image waves-effect waves-block waves-light">`
    if (img_url) {
        html += `<img class="activator responsive-img" src="` + img_url + `" id="img_url_` + str_id + `">`
    }
    html += `
          <span class="card-title" id="title_` + str_id + `" style="display:none;">` + title + `</span>
        </div>
        <div class="card-content">
          <span class="card-title activator grey-text text-darken-4" style="word-break:break-word;">` + title + `<i class="material-icons right">more_vert</i></span>
          <p><a href="` + link + `" id="link_` + str_id + `" target="_blank">Please click here</a></p>
        </div>
        <div class="card-reveal">
          <span class="card-title grey-text text-darken-4">` + title + `<i class="material-icons right">close</i></span>
          <p id="content_` + str_id + `">` + content + `</p>
        </div>
        </div>
      </div>
      <div class="secondary-content row">
        <a href="" class="edit-button-tree-intent-card-detail col" id="` + id + `">
            <i class="inline-icon material-icons green-text text-darken-2">edit</i>
        </a>`
    if (selected_language == "en") {

        html += `<a href="" class="delete-button-intent-card-detail col" id="` + id + `">
            <i class="inline-icon material-icons red-text text-darken-3">delete</i>
        </a>`
    }
    html += `</div>
        </div>
    </li>`;
    $(html).appendTo($("#tree-card-collection"));
    tree_card_count += 1;
}

// Remove element with element id with click
$(document).on("click", ".delete-button-tree-card-detail", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();
});


// // Remove element with element id with click
// $(document).on("click", ".delete-button-tree-response-data", function(e){
//   e.preventDefault();
//   element = "#"+this.id;
//   $(element).remove();
// });

$(document).on("click", ".delete-button-tree-image-url", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();
});

$(document).on("click", ".delete-button-tree-video-url", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();
});

// Remove element with element id with click
$(document).on("click", ".delete-button-tree-data", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();
});


function addTreeResponseSentencesIntoCollection(text, speech) {
    id = "tree_response_" + tree_response_sentence_count.toString();
    str_id = "tree_response_" + tree_response_sentence_count.toString();

    html = `
    <li class="collection-item" id="` + id + `">
      <div class="row">
        <input placeholder="text-response" id="text_` + str_id + `" type="text" data-length="100" value="` + text + `" style="width: 80%" required>
        <input placeholder="speech-response" id="speech_` + str_id + `" type="text" data-length="100" value="` + speech + `" style="width: 80%" required>
        <label for="` + str_id + `"></label>
        <div class="secondary-content">
        <a class="delete-button-tree-data" id="` + id + `">
          <i class="inline-icon material-icons red-text text-darken-3">delete</i>
        </a>
        </div>
      </div>
    </li>`;

    $(html).appendTo($("#tree-response-collection"));
    tree_response_sentence_count += 1;
}

$(document).on("click", "#add-tree-response-sentences", function (e) {
    addTreeResponseSentencesIntoCollection("", "");
});

$(document).on("change", "#checkbox-child-intent-attachment", function (e) {
    if (document.getElementById('checkbox-child-intent-attachment').checked) {

        $("#choosen_file_type_child_div").show()
    } else {

        $("#choosen_file_type_child_div").hide()
    }
});

$(document).on("click", "#save-tree, #save-tree-buttom", function (e) {
    value = $("#add_enter_tree_response_data").val();
    if (value != "") {
        addTreeResponseSentencesIntoCollection(value, "");
        $("#add_enter_tree_response_data").val("");
    }

    active_url = window.location.href.replace("#", "");
    active_url = active_url.replace("!", "");
    // intent_pk = active_url.substring(active_url.indexOf("intent_pk=") + "intent_pk=".length, active_url.indexOf('&parent_pk'));
    // parent_pk = active_url.substring(active_url.indexOf("parent_pk=") + "parent_pk=".length, active_url.indexOf('&tree_pk'));
    // tree_pk = active_url.substring(active_url.indexOf("tree_pk=") + "tree_pk=".length, );
    var url_parameters = get_url_vars()

    intent_pk = url_parameters["intent_pk"];
    parent_pk = url_parameters["parent_pk"];
    tree_pk = url_parameters["tree_pk"];

    global_select_tree_id = tree_pk;
    global_select_intent_id = intent_pk;
    global_select_parent_id = parent_pk;

    tree_name = $("#tree_name").val();
    tree_name = stripHTML(tree_name);
    tree_name = tree_name.trim();
    multilingual_tree_name = "";
    multilingual_tree_elm = document.getElementById("multilingual_tree_name")
    multilingual_tree_name = ""
    if (multilingual_tree_elm != null && multilingual_tree_elm != undefined) {
        multilingual_tree_name = multilingual_tree_elm.value
    }

    accept_keywords = $("#tree_keyword").val();
    post_processor_function = $("#tree_post_processor_function").val();
    post_processor_name = $("#tree_post_processor_name").val();
    choice_list = $("#tree-response-choice-list").val();
    validator_id = $("#select-user-validator").val();
    if (tree_name == "") {
        tree_name = $("#tree_name").val("");
        M.toast({
            "html": "Child Intent Name cannot be empty."
        }, 2000);
        return;
    }

    // tree_bot_response_text_text = $("#tree_bot_response_text_text").val();
    // tree_bot_response_text_speech = $("#tree_bot_response_text_speech").val();
    // tree_bot_response_text_hinglish = $("#tree_bot_response_text_hinglish").val();
    // tree_bot_response_reprompt = $("#tree_bot_response_reprompt").val();

    tree_bot_response_text_text = $("#tree_bot_response_text_text").trumbowyg('html')
    tree_bot_response_text_speech = $("#tree_bot_response_text_speech").trumbowyg('html')
    tree_bot_response_reprompt = $("#tree_bot_response_reprompt").trumbowyg('html')
    tree_bot_response_ssml = $('#tree_bot_response_ssml').val().trim()

    if (tree_bot_response_text_text.trim() != "" && tree_bot_response_text_speech.trim() == "") {
        tree_bot_response_text_speech = tree_bot_response_text_text
    }

    if (tree_bot_response_text_text == "") {
        M.toast({
            "html": "At least one text response required."
        }, 2000);
        return;
    }

    let response_present = ['text'];

    recommended_intent_list = $("#multiple-select-intent-choice-list").val();
    var child_choices = $("#multiple-select-tree-child-choices").val();

    var is_tree_go_back_checked = false;
    if (document.getElementById('checkbox-tree-go-back-enabled')) {
        is_tree_go_back_checked = document.getElementById('checkbox-tree-go-back-enabled').checked;
    }

    if (recommended_intent_list.length > 0 || is_tree_go_back_checked == true) {
        response_present.push('quick_recommendations');
    }

    tree_response_list = [{
        "text_response": tree_bot_response_text_text,
        "speech_response": tree_bot_response_text_speech,
        "hinglish_response": "",
        "reprompt_response": tree_bot_response_reprompt,
        "ssml_response": tree_bot_response_ssml,
    }]

    if (tree_response_list.length == 0) {
        M.toast({
            'html': 'Text response cannot be empty.'
        }, 2000);
        return;
    }

    image_list = []
    var inputs = document.getElementsByTagName("input");
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf("imageurl_tree_image_url_") == 0) {
            data_id = inputs[i].id;
            token_id = data_id.split("_")[4];
            image_url = $("#imageurl_tree_image_url_" + token_id).val();
            image_list.push(image_url);
        }
    }

    if (image_list.length > 0) {
        response_present.push('image');
    }

    video_list = []
    var inputs = document.getElementsByTagName("input");
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf("videourl_tree_video_url_") == 0) {
            data_id = inputs[i].id;
            token_id = data_id.split("_")[4];
            video_url = $("#videourl_tree_video_url_" + token_id).val();
            video_list.push(video_url);
        }
    }

    if (video_list.length > 0) {
        response_present.push('video');
    }

    card_list = []
    var spans = document.getElementsByTagName("span");
    for (var i = 0; i < spans.length; i++) {
        if (spans[i].id.indexOf("title_tree_card_") == 0) {
            data_id = spans[i].id;
            token_id = data_id.split("_")[3];
            check_img = $("img_url_tree_card_" + token_id);
            card_img_url = '';
            if (check_img) {
                card_img_url = $("#img_url_tree_card_" + token_id).attr("src");
            }
            card_title = document.getElementById("title_tree_card_" + token_id).innerText;
            card_content = $("#content_tree_card_" + token_id).html();
            card_url = $("#link_tree_card_" + token_id).attr("href");
            card_list.push({
                "title": card_title,
                "content": card_content,
                "link": card_url,
                "img_url": card_img_url
            });
        }
    }

    if (card_list.length > 0) {
        response_present.push('link_cards');
    }

    recommended_intent_list = $("#multiple-select-intent-choice-list").val();


    var is_attachment_required = false
    if (selected_widget == 'div-file-attach-widget')
        is_attachment_required = true
    var is_save_attachment_required = document.getElementById('checkbox-intent-save-attachment').checked;
    var choosen_file_type = document.getElementById('choosen_file_type').value;

    if (is_attachment_required && choosen_file_type == "") {

        M.toast({
            "html": "Please select file type."
        }, 2000);
        return;
    }

    if (is_attachment_required) {
        response_present.push('file_attach');
    }

    rows = document.getElementById('tree-hidden-numbers-rows').innerHTML;
    if (document.getElementById('tree-number-of-rows-table').value != "") {
        rows = document.getElementById('tree-number-of-rows-table').value
    }

    table_input_list_of_list = ""
    if (rows != 0) {
        table_input_list_of_list = check_table_filled()
        if (table_input_list_of_list == false) {
            alert("Table cannot have empty cells");
            return;
        } else {
            response_present.push('table');
        }
    }

    function check_table_filled() {
        rows = document.getElementById('tree-hidden-numbers-rows').innerHTML;
        columns = document.getElementById('tree-hidden-numbers-columns').innerHTML;
        if (document.getElementById('tree-number-of-rows-table').value != "") {
            rows = document.getElementById('tree-number-of-rows-table').value
        }
        if (document.getElementById('tree-number-of-columns-table').value != "") {
            columns = document.getElementById('tree-number-of-columns-table').value
        }
        table_input_list_of_list = []
        for (i = 0; i < rows; i++) {
            row_list = []
            for (j = 0; j < columns; j++) {
                cell_value = document.getElementById('cell-id-' + i.toString() + j.toString()).innerHTML;
                if (cell_value != "") {
                    if (un_entity(cell_value).trim() == "<br>" || un_entity(cell_value).trim() == "")
                        return false
                    else
                        row_list.push(un_entity(cell_value));
                } else {
                    return false
                };

            };
            table_input_list_of_list.push(row_list)
        };
        return table_input_list_of_list
    };

    var is_child_tree_visible = "None";
    element_checkbox_child_tree_visible = document.getElementById("checkbox-child-tree-options-visible");
    if (element_checkbox_child_tree_visible != null && element_checkbox_child_tree_visible != undefined) {
        is_child_tree_visible = element_checkbox_child_tree_visible.checked;
    }
    var is_automate_recursion_enabled = false;
    element_checkbox_automate_recursion = document.getElementById("checkbox-automate-recursion");
    if (element_checkbox_automate_recursion != null && element_checkbox_automate_recursion != undefined) {
        is_automate_recursion_enabled = element_checkbox_automate_recursion.checked;
    }
    /* Widgets 
        1. Date Picker
        2. Time Picker
        3. Range Slider
        4. Radio Button
        5. Checkbox
        6. Drop Down
        7. Video Recorder
        8. Form
    */

    //Date Picker
    var is_date_picker_allowed = false
    if (selected_widget == "div-date-picker-widget")
        is_date_picker_allowed = true
    var is_single_date_picker_allowed = document.getElementById('checkbox-intent-single-date-picker').checked;
    var is_multi_date_picker_allowed = document.getElementById('checkbox-intent-multi-date-picker').checked;

    if (is_date_picker_allowed) {
        if (is_single_date_picker_allowed == false && is_multi_date_picker_allowed == false) {
            M.toast({
                'html': 'Please select atleast one option.'
            }, 2000);
            return;
        } else {
            response_present.push('date_picker');
        }
    }

    //Time Picker
    var is_time_picker_allowed = false
    if (selected_widget == "div-time-picker-widget")
        is_time_picker_allowed = true
    var is_single_time_picker_allowed = document.getElementById('checkbox-intent-single-time-picker').checked;
    var is_multi_time_picker_allowed = document.getElementById('checkbox-intent-multi-time-picker').checked;
    if (is_time_picker_allowed) {
        if (is_single_time_picker_allowed == false && is_multi_time_picker_allowed == false) {
            M.toast({
                'html': 'Please select atleast one option.'
            }, 2000);
            return;
        } else {
            response_present.push('time_picker');
        }
    }

    // Range Slider
    var is_range_slider_required = false;
    var minimum_range = ""
    var maximum_range = ""
    var range_slider_type = ""
    if (selected_widget == "div-range-slider-widget") {
        is_range_slider_required = true;
        if (document.getElementById('single-range-slider').checked)
            range_slider_type = "single-range-slider";
        else if (document.getElementById('multi-range-slider').checked)
            range_slider_type = "multi-range-slider";
        minimum_range = document.getElementById("range-slider-min-range").value;
        maximum_range = document.getElementById("range-slider-max-range").value;
        if (range_slider_type == "" || range_slider_type == null || range_slider_type == undefined) {
            M.toast({
                'html': 'Please select a range slider option.'
            }, 2000);
            return;
        }
        if (/^\d+$/.test(minimum_range) == false || /^\d+$/.test(maximum_range) == false) {
            M.toast({
                'html': 'Please enter a valid range.'
            }, 2000);
            return;
        }
        if (parseInt(minimum_range) >= parseInt(maximum_range)) {
            M.toast({
                'html': 'Minimum range should be less than maximum.'
            }, 2000);
            return;
        }
        if (parseInt(minimum_range) >= 9999999999 || parseInt(maximum_range) >= 9999999999) {
            M.toast({
                'html': 'Range values should be less than 10 digits'
            }, 2000);
            return;
        }

        response_present.push('range_slider');
    }

    //Radio Button

    var is_radio_button_allowed = false
    radio_choices_list = []
    if (selected_widget == "div-radio-button-widget") {
        is_radio_button_allowed = true
        var inputs = document.getElementsByTagName("input");
        for (var i = 0; i < inputs.length; i++) {
            if (inputs[i].id.indexOf('radio_button_data_str') == 0) {
                data_id = "#" + inputs[i].id;
                radio_choices = $(data_id).val();
                if (radio_choices != "") {
                    radio_choices_list.push(radio_choices);
                }
            }
        }
        if (radio_choices_list.length == 0) {
            M.toast({
                "html": "At least one choice is required."
            }, 2000);
            return;
        }

        response_present.push('radio_button');

    }

    var explanation = "";

    try {
        explanation = document.getElementById("explanation").value;
    } catch { }

    var post_processor_variable = "";
    try {
        post_processor_variable = document.getElementById('post_processor_variable').value
    } catch { }

    //Checkbox
    var is_check_box_allowed = false
    checkbox_choices_list = []
    if (selected_widget == "div-check-box-widget") {
        is_check_box_allowed = true
        var inputs = document.getElementsByTagName("input");
        for (var i = 0; i < inputs.length; i++) {
            if (inputs[i].id.indexOf('check_box_data_str') == 0) {
                data_id = "#" + inputs[i].id;
                checkbox_choices = $(data_id).val();
                if (checkbox_choices != "") {
                    checkbox_choices_list.push(checkbox_choices);
                }
            }
        }
        if (checkbox_choices_list.length == 0) {
            M.toast({
                "html": "At least one choice is required."
            }, 2000);
            return;
        }
        response_present.push('checkbox');
    }
    //Dropdown
    var is_drop_down_allowed = false
    dropdown_choices_list = []
    if (selected_widget == "div-drop-down-widget") {
        is_drop_down_allowed = true
        var inputs = document.getElementsByTagName("input");
        for (var i = 0; i < inputs.length; i++) {
            if (inputs[i].id.indexOf('drop_down_data_str') == 0) {
                data_id = "#" + inputs[i].id;
                dropdown_choices = $(data_id).val();
                if (dropdown_choices != "") {
                    dropdown_choices_list.push(dropdown_choices);
                }
            }
        }
        if (dropdown_choices_list.length == 0) {
            M.toast({
                "html": "At least one choice is required."
            }, 2000);
            return;
        }
        response_present.push('drop_down');
    }


    // Video Recorder
    var is_video_recorder_allowed = false
    if (selected_widget == "div-video-recorder-widget")
        is_video_recorder_allowed = true
    if (is_video_recorder_allowed) {
        response_present.push('video_record')
    }
    var is_save_video_attachment_required = document.getElementById('checkbox-intent-save-video-attachment').checked;

    var is_go_back_enabled = false;
    if (document.getElementById('checkbox-tree-go-back-enabled')) {
        is_go_back_enabled = document.getElementById('checkbox-tree-go-back-enabled').checked;
    }

    var is_confirmation_and_reset_enabled = document.getElementById('checkbox-confirmation-and-reset-enabled').checked;
    var is_recommendation_menu = document.getElementById('checkbox-intent-recommendation-menu').checked;
    let is_catalogue_added = document.getElementById('add_catalogue_checkbox').checked;
    let selected_catalogue_sections = []
    $("#select-sections-container span").each((indx, ele) => {
        let section_id = ele.id.split("_")
        section_id = section_id[section_id.length - 1]
        selected_catalogue_sections.push(section_id)
    })
    if (is_catalogue_added && (!selected_catalogue_sections || !selected_catalogue_sections.length)) {
        M.toast({
            "html": "Please select atleast one section for WhatsApp Catalogue"
        }, 2000);
        return;
    }
    let is_catalogue_purchased = document.getElementById("is_item_purchased").checked;
    try {
        var category_response_allowed = document.getElementById("checkbox-cateogry-tree").checked;
        var flow_analytics_variable = document.getElementById('flow_analytics_variable').value
    } catch (err) { }

    //Phone Widget

    var is_phone_widget_enabled = false
    var country_code = "in"
    if (selected_widget == "div-phone-number-widget") {
        is_phone_widget_enabled = true
        var country_code = $("#phone").intlTelInput("getSelectedCountryData")

        country_code = country_code.iso2
        response_present.push('phone_number');      

    }

    //Form
    var is_create_form_allowed = false
    if (selected_widget == 'div-create-form-widget')
        is_create_form_allowed = true
    var form_name = ""
    form_fields_list = [];
    if (is_create_form_allowed) {
        form_name = document.getElementById('form_name').value;
        form_name = strip_unwanted_characters(stripHTML(form_name));
        form_name = form_name.trim();
        if (form_name == '') {
            M.toast({
                "html": "Please enter a valid form name"
            }, 2000);
            return;
        }

        let fields_present = document.getElementsByClassName('create-form-field');
        if (fields_present.length == 0) {
            M.toast({
                "html": "Please add atleast one form section"
            }, 2000);
            return;
        }
        for (let i = 0; i < fields_present.length; ++i) {
            let field_id = fields_present[i].id;
            let field_div = document.getElementById(field_id);
            let field_id_num = field_id.split('-')[1]
            let label_name, input_type, placeholder_or_options_elem1, placeholder_or_options_elem2, validator, attachment_type, range_type, dependent, dependent_on, dependent_on_label_name;
            placeholder_or_options_elem2 = ""

            label_name = document.getElementById('input_name_' + field_id_num + '_1').value;
            label_name = strip_unwanted_characters(stripHTML(label_name));

            input_type = document.getElementById('input_type_' + field_id_num).value
            // input_type = input_name_mapping(input_type)

            placeholder_or_options_elem1 = document.getElementById('input_selected_type_' + field_id_num + '_3').value;
            validator = document.getElementById('validator_' + field_id_num).value;

            // validator = validator_mapping(validator);

            attachment_type = document.getElementById('file_attach_type_' + field_id_num).value;

            range_type = document.getElementById('range_selector_' + field_id_num).value;

            calendar_type = document.getElementById('calendar_selector_type_' + field_id_num).value;

            optional = document.getElementById('optional-toggle-field-' + field_id_num).checked;

            dependent = document.getElementById('dependent-field-' + field_id_num);
            
            country_code = $("#phone_number_selector_type_" + field_id_num).intlTelInput("getSelectedCountryData").iso2

            if (dependent) {
                dependent = dependent.checked;
            } else {
                dependent = false;
            }
            dependent_on = ''
            dependent_on_label_name = ''
            if (dependent) {
                dependent_on = document.getElementById('dependent_field_dropdown_' + field_id_num).value;
                dependent_on_label_name = document.getElementById('input_name_' + dependent_on + '_1').value
            }

            if (dependent_on == 'Select Dependency') {
                M.toast({
                    "html": "Please select a valid dependency"
                }, 2000);
                return;
            }

            let dependent_fields = document.querySelectorAll('.dependent-dropdown');
            let dependent_ids = []
            for (let j = 0; j < dependent_fields.length; j++) {
                if (dependent_fields[j].value == field_id_num) {
                    dependent_ids.push(dependent_fields[j].id.split('_')[3])
                }
            }
            dependent_ids = dependent_ids.join('$$$')

            label_name = label_name.trim();
            if (label_name == "") {
                M.toast({
                    "html": "Please enter a valid label name"
                }, 2000);
                return;
            }

            if (input_type == "") {
                M.toast({
                    "html": "Please enter an input type"
                }, 2000);
                return;
            }

            let placeholder_or_options = placeholder_or_options_elem1;

            if (input_type == 'file_attach') {
                placeholder_or_options = attachment_type;
            } else {
                // placeholder_or_options = stripHTML(placeholder_or_options);
                // placeholder_or_options = placeholder_or_options.trim();

                // var values = placeholder_or_options.toLowerCase().split('$$$');
                // var values_set = new Set(values);
                // if (values_set.size != values.length) {
                //     M.toast({
                //         "html": "Please enter unique values for choices in form widget."
                //     }, 2000);
                //     return;
                // }
                if (input_type == "radio") {

                    placeholder_or_options = form_get_radio_button_list(field_id.split("-")[1])
                    placeholder_or_options = placeholder_or_options.join('$$$')

                } else if (input_type == "checkbox") {
                    placeholder_or_options = form_get_check_box_list(field_id.split("-")[1])
                    placeholder_or_options = placeholder_or_options.join('$$$')

                } else if (input_type == "dropdown_list") {
                    placeholder_or_options = form_get_dropdown_list(field_id.split("-")[1])
                    placeholder_or_options = placeholder_or_options.join('$$$')
                } else if (input_type == "range") {
                    var form_range_slider_min_value = document.getElementById("form-range-slider-min-range-" + field_id.split("-")[1]).value;
                    var form_range_slider_max_value = document.getElementById("form-range-slider-max-range-" + field_id.split("-")[1]).value;
                    placeholder_or_options = form_range_slider_min_value + "-" + form_range_slider_max_value;
                }
            }

            if (input_type == "text_field" || input_type == "phone_number") {
                if (placeholder_or_options == "") {
                    M.toast({
                        "html": "Please enter placeholder value"
                    }, 2000);
                    return;
                }
            } else if (!api_integrated_fields.includes(field_id_num) && input_type == "dropdown_list" && placeholder_or_options == "") {
                M.toast({
                    "html": "Please enter at least one and valid dropdown option"
                }, 2000);
                return;
            } else if (!api_integrated_fields.includes(field_id_num) && input_type == "checkbox" && placeholder_or_options == "") {
                M.toast({
                    "html": "Please enter at least one and valid checkbox option"
                }, 2000);
                return;
            } else if (!api_integrated_fields.includes(field_id_num) && input_type == "radio" && placeholder_or_options == "") {
                M.toast({
                    "html": "Please enter at least one and valid radio button option"
                }, 2000);
                return;
            } else if (input_type == "range") {
                if (placeholder_or_options.split('-')[0] == "" || placeholder_or_options.split('-')[1] == "") {
                    M.toast({
                        "html": "Please enter a range"
                    }, 2000);
                    return;
                } else if (placeholder_or_options.split('-').length != 2 || (isNaN(placeholder_or_options.split('-')[0]) || isNaN(placeholder_or_options.split('-')[1]))) {
                    M.toast({
                        "html": "Please enter a valid range"
                    }, 2000);
                    return;
                } else if (parseInt(placeholder_or_options.split('-')[0]) >= parseInt(placeholder_or_options.split('-')[1])) {
                    M.toast({
                        'html': 'Minimum range should be less than maximum.'
                    }, 2000);
                    return;
                }
            } else if (input_type == "file_attach" && (placeholder_or_options == undefined || placeholder_or_options == "")) {
                M.toast({
                    "html": "Please select file type"
                }, 2000);
                return;
            }

            form_fields_list.push({
                label_name: label_name,
                input_type: input_type,
                validator: validator,
                placeholder_or_options: placeholder_or_options,
                optional: optional.toString(),
                range_type: range_type,
                calendar_type: calendar_type,
                field_id_num: field_id_num,
                is_dependent: dependent.toString(),
                dependent_on: dependent_on.toString(),
                dependent_on_label_name: dependent_on_label_name,
                dependent_field_ids: dependent_ids,
                country_code: country_code,

            })
        }

        response_present.push('form');

    }


    //Calender
    //Calender
    var is_calender_picker_allowed = false
    if (selected_widget == "div-calender-picker-widget")
        is_calender_picker_allowed = true
    var is_single_calender_date_picker_allowed = document.getElementById('single-date-picker-radio').checked;
    var is_multi_calender_date_picker_allowed = document.getElementById('custom-date-picker-radio').checked;
    var is_single_calender_time_picker_allowed = document.getElementById('single-time-picker-radio').checked;
    var is_multi_calender_time_picker_allowed = document.getElementById('custom-time-picker-radio').checked;

    var is_calender_date_picker_enabled = document.getElementById('enabledatepicker_switch1').checked
    var is_calender_time_picker_enabled = document.getElementById('enabletimepicker_switch2').checked

    if (is_calender_picker_allowed) {

        if (is_calender_date_picker_enabled) {
            if ((is_single_calender_date_picker_allowed == false && is_multi_calender_date_picker_allowed == false)) {
                M.toast({
                    'html': 'Please select atleast one option in date picker.'
                }, 2000);
                return;
            }
        }

        if (is_calender_time_picker_enabled) {
            if ((is_single_calender_time_picker_allowed == false && is_multi_calender_time_picker_allowed == false)) {
                M.toast({
                    'html': 'Please select atleast one option in time picker.'
                }, 2000);
                return;
            }
        }

        response_present.push('calendar_picker');
    }

    //Order of Response
    var order_of_response_result = check_order_of_response(response_present);

    var is_last_tree = false
    try {
        is_last_tree = document.getElementById("checkbox-last-tree").checked
    } catch (err) { }

    var is_exit_tree = false
    try {
        is_exit_tree = document.getElementById("checkbox-exit-tree").checked
    } catch (err) { }

    var is_transfer_tree = false
    try {
        is_transfer_tree = document.getElementById("checkbox-transfer-tree").checked
    } catch (err) {}

    var whatsapp_list_message_header = document.getElementById("whatsapp-list-message-header").value;
    if (whatsapp_list_message_header == "" && is_whatsapp_channel_selected) {
        M.toast({
            'html': 'Please enter whatsapp list message header.'
        }, 2000);
        return;
    } else if (whatsapp_list_message_header.length > 20) {
        M.toast({
            'html': 'Whatsapp list message header cannot be greater than 20 characters. Please enter a valid list message header.'
        }, 2000);
        return;
    }

    var allow_barge = document.getElementById("checkbox-allow-barge").checked;
    var disposition_code = document.getElementById("disposition_code").value.trim();

    if (disposition_code.length > 25) {
        M.toast({
            "html": "Disposition code cannot be more than 25 characters."
        }, 2000);
        return;
    }

    tree_short_name = document.getElementById("tree_short_name").value
    tree_short_name = tree_short_name.trim()
    if(tree_short_name.length > 25){
        M.toast({
            "html": "Tree short name cannot be more than 25 characters."
        }, 2000);
        return;
    }

    var whatsapp_short_name = null;
    if (document.getElementById("whatsapp-short-name-input")) {
        whatsapp_short_name = document.getElementById("whatsapp-short-name-input").value;

        if (!whatsapp_short_name) {
            M.toast({
                "html": "Whatsapp button title connot be empty."
            }, 2000);
            return;
        }
    }

    var whatsapp_description = null;
    if (document.getElementById("whatsapp-description-input")) {
        whatsapp_description = document.getElementById("whatsapp-description-input").value;

        if (!whatsapp_description) {
            M.toast({
                "html": "Whatsapp description connot be empty."
            }, 2000);
            return;
        }
    }

    var enable_whatsapp_menu_format = false;
    if (document.getElementById("enable_whatsapp_menu_format")) {
        enable_whatsapp_menu_format = document.getElementById("enable_whatsapp_menu_format").checked;

        if (enable_whatsapp_menu_format) {
            var whatsapp_menu_section_cards = document.getElementsByClassName("easychat-whatsapp-menu-item-wrapper");
            if (!whatsapp_menu_section_cards.length) {
                M.toast({
                    "html": "Please add at least one section in menu format"
                }, 2000);
                return;
            }

            var total_options_selected = document.querySelectorAll(".child-tree").length + document.querySelectorAll(".main-intent").length;
            if (total_options_selected < 4) {
                M.toast({
                    "html": "Total quick recommendations and child intents selected in whatsapp chatbot menu should be greater than 3."
                }, 2000);
                return;
            } else if (total_options_selected > 10) {
                M.toast({
                    "html": "Total quick recommendations and child intents selected in whatsapp chatbot menu should be less than 11."
                }, 2000);
                return;
            }
        }
    }

    disable_save_tree_buttons();

    json_string = JSON.stringify({
        intent_pk: intent_pk,
        tree_pk: tree_pk,
        parent_pk: parent_pk,
        tree_name: tree_name,
        tree_short_name: tree_short_name,
        multilingual_name: multilingual_tree_name,
        accept_keywords: accept_keywords,
        is_attachment_required: is_attachment_required,
        choosen_file_type: choosen_file_type,
        post_processor_name: post_processor_name,
        post_processor_function: post_processor_function,
        response_choice_list: choice_list,
        is_child_tree_visible: is_child_tree_visible,
        response_sentence_list: tree_response_list,
        response_image_list: image_list,
        response_video_list: video_list,
        recommended_intent_list: recommended_intent_list,
        card_list: card_list,
        validator_id: validator_id,
        table_input_list_of_list: table_input_list_of_list,
        is_automate_recursion_enabled: is_automate_recursion_enabled,
        explanation: explanation,
        is_date_picker_allowed: is_date_picker_allowed,
        is_time_picker_allowed: is_time_picker_allowed,
        is_single_date_picker_allowed: is_single_date_picker_allowed,
        is_multi_date_picker_allowed: is_multi_date_picker_allowed,
        is_single_time_picker_allowed: is_single_time_picker_allowed,
        is_multi_time_picker_allowed: is_multi_time_picker_allowed,
        is_calender_picker_allowed: is_calender_picker_allowed,
        is_single_calender_date_picker_allowed: is_single_calender_date_picker_allowed,
        is_multi_calender_date_picker_allowed: is_multi_calender_date_picker_allowed,
        is_single_calender_time_picker_allowed: is_single_calender_time_picker_allowed,
        is_multi_calender_time_picker_allowed: is_multi_calender_time_picker_allowed,
        is_range_slider_required: is_range_slider_required,
        range_slider_type: range_slider_type,
        minimum_range: minimum_range,
        maximum_range: maximum_range,
        is_radio_button_allowed: is_radio_button_allowed,
        radio_button_choices: radio_choices_list,
        post_processor_variable: post_processor_variable,
        is_save_attachment_required: is_save_attachment_required,
        is_check_box_allowed: is_check_box_allowed,
        checkbox_choices_list: checkbox_choices_list,
        is_drop_down_allowed: is_drop_down_allowed,
        dropdown_choices_list: dropdown_choices_list,
        is_video_recorder_allowed: is_video_recorder_allowed,
        is_save_video_attachment_required: is_save_video_attachment_required,
        is_phone_widget_enabled: is_phone_widget_enabled,
        country_code: country_code,
        is_create_form_allowed: is_create_form_allowed,
        form_name: form_name,
        form_fields_list: form_fields_list,
        is_go_back_enabled: is_go_back_enabled,
        is_confirmation_and_reset_enabled: is_confirmation_and_reset_enabled,
        is_recommendation_menu: is_recommendation_menu,
        is_catalogue_added: is_catalogue_added,
        selected_catalogue_sections: selected_catalogue_sections,
        is_catalogue_purchased: is_catalogue_purchased,
        child_choices: child_choices,
        flow_analytics_variable: flow_analytics_variable,
        category_response_allowed: category_response_allowed,
        is_custom_order_selected: order_of_response_result.is_custom_order_selected,
        order_of_response: order_of_response_result.final_order_of_response,
        is_last_tree: is_last_tree,
        is_exit_tree: is_exit_tree,
        is_transfer_tree: is_transfer_tree,
        whatsapp_list_message_header: whatsapp_list_message_header,
        allow_barge: allow_barge,
        disposition_code: disposition_code,
        whatsapp_short_name: whatsapp_short_name,
        whatsapp_description: whatsapp_description,
        enable_whatsapp_menu_format: enable_whatsapp_menu_format,
    });

    json_string = EncryptVariable(json_string);

    var response = $.ajax({
        url: '/chat/save-tree/',
        type: 'POST',
        async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {

            response = custom_decrypt(response)
            response = JSON.parse(response);
            console.log(response)
            if (response["status"] == 200) {
                M.toast({
                    'html': 'Tree saved successfully!'
                }, 2000);
                setTimeout(function (e) {
                    window.location.reload();
                }, 2000);
            } else if (response["status"] == 300) {
                M.toast({
                    'html': response['status_message']
                }, 2000);
                enable_save_tree_buttons()
                return
            } else if (response["status"] == 401) {
                M.toast({
                    'html': "Kindly select all the children in child order"
                }, 2000);
                enable_save_tree_buttons()
            } else {
                M.toast({
                    'html': 'Internal Server Error'
                }, 2000);
                enable_save_tree_buttons()
            }
        },
        error: function (error) {
            M.toast({
                'html': 'Unable to connect to server. Please try again later'
            }, 2000);
        }
    }).responseJSON;


});

function disable_save_tree_buttons() {
    document.getElementById('save-tree').style.opacity = '0.5'
    document.getElementById('save-tree').style.pointerEvents = 'none'
    document.getElementById('save-tree-buttom').style.opacity = '0.5'
    document.getElementById('save-tree-buttom').style.pointerEvents = 'none'
}

function enable_save_tree_buttons() {
    document.getElementById('save-tree').style.opacity = '1'
    document.getElementById('save-tree').style.pointerEvents = 'auto'
    document.getElementById('save-tree-buttom').style.opacity = '1'
    document.getElementById('save-tree-buttom').style.pointerEvents = 'auto'
}

function fetch_all_choice_list() {

    var response = $.ajax({
        url: '/chat/fetch-choices/',
        type: 'GET',
        async: false,
        data: {

        },
        success: function (response) {

            return response;
        },
        error: function (error) {
            return {
                "status": 500
            };
        }
    }).responseJSON;
    response = custom_decrypt(response)
    response = JSON.parse(response);

    return response;
}

function add_new_choice(display, value) {
    var json_string = JSON.stringify({
        display: display,
        value: value
    })

    json_string = EncryptVariable(json_string);

    var response = $.ajax({
        url: '/chat/add-new-choice/',
        type: 'POST',
        async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {
            return response;
        },
        error: function (error) {
            return {
                "status": 500
            };
        }
    }).responseJSON;
    response = custom_decrypt(response)
    response = JSON.parse(response);

    return response;
}

$(document).on("click", "#save-new-choice", function (e) {
    display = $("#tree_choice_display_value").val();
    value = $("#tree_choice_value_value").val();
    add_new_choice(display, value);
    location.reload(true);
});


function renderTreeInformation(tree_pk) {

    tree_information = fetchTreeInformationByID(tree_pk);
    order_of_response = tree_information['order_of_response'];
    default_order_of_response = tree_information['default_order_of_response'];
    // console.log(tree_information)
    modes = JSON.parse(tree_information["modes"]);
    if ('is_attachment_required' in modes && modes["is_attachment_required"] == "true") {
        $("#choosen_file_type_child_div").show()
    } else {
        $("#choosen_file_type_child_div").hide()
    }
    response_pk = tree_information["response_pk"];
    master_choice_list = fetch_all_choice_list()["choice_list"];
    loadTreeEditForm();

    sentence_list = []
    choice_list = []
    image_list = []
    video_list = []
    card_list = []

    if (response_pk != null) {
        // Bot response parameters
        response_information = fetchBotResponseDetailsByID(response_pk);
        sentence_list = response_information["response_list"]
        choice_list = response_information["choice_list"]
        image_list = response_information["image_list"]
        video_list = response_information["video_list"]
        card_list = response_information["card_list"]
    }

    //tree_name = tree_information["tree_name"];
    //accept_keywords = tree_information["accept_keywords"];

    post_processor_name = tree_information["post_processor_name"];
    post_processor_function = tree_information["post_processor_function"];

    choice_display_list = []
    for (i = 0; i < choice_list.length; i++) {
        choice_display_list.push(choice_list[i]["display"].toLowerCase());
    }

    master_display_list = []
    for (i = 0; i < master_choice_list.length; i++) {
        master_display_list.push(master_choice_list[i]["display"].toLowerCase());
    }

    if (sentence_list.length > 0) {
        text_response = sentence_list[0]["text_response"];
        speech_response = sentence_list[0]["speech_response"];
        hinglish_response = ""

        if ("hinglish_response" in sentence_list[0]) {
            hinglish_response = sentence_list[0]["hinglish_response"];
        }

        reprompt_response = ""
        if ("text_reprompt_response" in sentence_list[0]) {
            reprompt_response = sentence_list[0]["text_reprompt_response"]
        }

        ssml_response = ""
        if("ssml_response" in sentence_list[0]) {
            ssml_response = sentence_list[0]["ssml_response"]
        }

        $("#tree_bot_response_text_text").val(text_response);
        $("#tree_bot_response_text_speech").val(speech_response);
        $("#tree_bot_response_text_hinglish").val(hinglish_response);
        $("#tree_bot_response_reprompt").val(reprompt_response);
        // addTreeResponseSentencesIntoCollection(text_response, speech_response)
    }

    for (var i = 0; i < image_list.length; i++) {
        image_url = image_list[i]
        addTreeResponseImageIntoCollection(image_url)
    }

    for (var i = 0; i < video_list.length; i++) {
        video_url = video_list[i]
        addTreeResponseVideoIntoCollection(video_url)
    }

    for (var i = 0; i < card_list.length; i++) {
        card_title = card_list[i]["title"];
        card_content = card_list[i]["content"];
        card_img_url = card_list[i]["img_url"];
        card_link = card_list[i]["link"];
        addTreeResponseCardIntoCollection(card_title, card_content, card_link, card_img_url);
    }
    if(!card_list.length && selected_language != "en") {
        $("#tree_cards_btn").hide();
    } else {
        $("#tree_cards_btn").show();
    }

    choice_html = `
        <div class="col s6">
            <div class="input-field">
                <select multiple id="tree-response-choice-list">
                    <option value="" disabled>Choose your option</option>`

    for (i = 0; i < master_display_list.length; i++) {
        if (choice_display_list.indexOf(master_display_list[i]) >= 0) {
            choice_html += `<option value="` + master_choice_list[i]["value"] + `" selected>` + master_choice_list[i]["display"] + `</option>`;
        } else {
            choice_html += `<option value="` + master_choice_list[i]["value"] + `">` + master_choice_list[i]["display"] + `</option>`;
        }
    }

    choice_html += `</select>
              <label>Choices</label>
          </div>
      </div>`

    //$("#tree_name").val(tree_name);
    //$("#tree_keyword").val(accept_keywords);
    $("#tree_post_processor_function").val(post_processor_function);
    $("#tree_post_processor_name").val(post_processor_name);
    $("#tree_response_choice_list").html(choice_html);
    // $("#tree_keyword_chip_list").html(chip_html);
    add_catalogue_sections_data_and_listeners(tree_information, true);
}

if (window.location.pathname == '/chat/edit-tree/') {
    if (window.location.href.indexOf("tree_pk=") != -1) {
        let is_custom_order_selected = document.getElementById('custom-order').checked;
        $('#easychat_order_of_responses').sortable({
            containment: "parent",
        });
        if (is_custom_order_selected) {
            let elem = document.getElementById('easychat_order_of_responses');
            elem.classList.remove('response-order-disabled');
        } else {
            $('#easychat_order_of_responses').sortable('disable');
        }

        // active_url = window.location.href.replace("#", "");
        // active_url = active_url.replace("!", "");
        // intent_pk = active_url.substring(active_url.indexOf("intent_pk=") + "intent_pk=".length, active_url.indexOf('&parent_pk'));
        // parent_pk = active_url.substring(active_url.indexOf("parent_pk=") + "parent_pk=".length, active_url.indexOf('&tree_pk'));
        var url_parameters = get_url_vars()

        intent_pk = url_parameters["intent_pk"];
        parent_pk = url_parameters["parent_pk"];
        tree_pk = url_parameters["tree_pk"];
        if (parent_pk == -1) {
            window.location = '/chat/edit-intent/?intent_pk=' + intent_pk + "&selected_language=en";
        }
        // tree_pk = active_url.substring(active_url.indexOf("tree_pk=") + "tree_pk=".length, );

        global_select_tree_id = tree_pk;
        global_select_intent_id = intent_pk;
        global_select_parent_id = parent_pk;
        renderTreeStructureByIntentID(intent_pk);
        renderTreeInformation(tree_pk);
        renderRequiredModalsIntoHTML(intent_pk);
        copy_tree_id = get_cookie("copy_tree_id")
        if (copy_tree_id != "") {
            $("#paste-tree-node").removeClass("disbled-paste-btn")
        }
        $(document).ready(function () {
            tree_generate_table();

            $(".create-form-select-field").select2({
                width: "95%",
                placeholder: "Select from drop down",
                allowClear: true,
                dropdownParent: $("#modal-create-form"),
            })

            $(".file-type-select-field").select2({
                width: "95%",
                placeholder: "Select file type",
                allowClear: true,
                dropdownParent: $("#modal-create-form"),
            })
        });

        var checked_val = document.getElementById("checkbox-intent-attachment").checked
        if (checked_val) {
            document.getElementById("easychat-attachment-dropdown").style.display = "table-row";
            document.getElementById("easychat-save-attachment-server").style.display = "table-row";
            select_widget('div-file-attach-widget')
        } else {
            document.getElementById("easychat-attachment-dropdown").style.display = "none";
            document.getElementById("easychat-save-attachment-server").style.display = "none";
        }

        var video_attachment_val = document.getElementById("checkbox-intent-video-recorder").checked
        if (video_attachment_val) {
            document.getElementById("easychat-save-video-attachment-server").style.display = "table-row";
            select_widget('div-video-recorder-widget')
        } else {
            document.getElementById("easychat-save-video-attachment-server").style.display = "none";
        }


        var date_checked_val = document.getElementById("checkbox-intent-date-picker").checked
        if (date_checked_val) {
            document.getElementById("intent-single-date-picker").style.display = "block";
            document.getElementById("intent-multi-date-picker").style.display = "block";
            select_widget('div-date-picker-widget')
        } else {
            document.getElementById("intent-single-date-picker").style.display = "none";
            document.getElementById("intent-multi-date-picker").style.display = "none";
        }

        var time_checked_val = document.getElementById("checkbox-intent-time-picker").checked
        if (time_checked_val) {
            document.getElementById("intent-single-time-picker").style.display = "block";
            document.getElementById("intent-multi-time-picker").style.display = "block";
            select_widget('div-time-picker-widget')
        } else {
            document.getElementById("intent-single-time-picker").style.display = "none";
            document.getElementById("intent-multi-time-picker").style.display = "none";
        }
        var calender_checked_val = window.is_calender_picker_allowed
        if (calender_checked_val == "True") {
            calendar_initializations()
            select_widget('div-calender-picker-widget')
        }

        var range_checked_val = window.is_range_slider_required;
        if (range_checked_val == 'True') {
            select_widget('div-range-slider-widget')
            document.getElementById('range-slider-min-max-value-input-div').style.display = "flex";
        } else {
            document.getElementById('range-slider-min-max-value-input-div').style.display = "none";
        }

        var radio_button_val = window.is_radio_btn_allowed
        if (radio_button_val == "True") {
            select_widget('div-radio-button-widget')
            var values = window.radio_button_choices_values.split("_")
            if (values != []) {
                for (var i = 0; i < values.length; i++) {
                    value = values[i];
                    add_radio_button_choices_collection(value)
                }
            }
        }
        var check_box_val = window.is_check_box_allowed
        if (check_box_val == "True") {
            select_widget('div-check-box-widget')
            var values = window.check_box_choices_values.split("_")
            if (values != []) {
                for (var i = 0; i < values.length; i++) {
                    value = values[i];
                    add_check_box_choices_collection(value)
                }
            }
        }

        var drop_down_val = window.is_drop_down_allowed
        if (drop_down_val == "True") {
            select_widget('div-drop-down-widget')
            var values = window.drop_down_choices_values.split("_")
            if (values != []) {
                for (var i = 0; i < values.length; i++) {
                    value = values[i];
                    add_drop_down_choices_collection(value)
                }
            }
        }

        var is_phone_widget_enabled = window.is_phone_widget_enabled
        if (is_phone_widget_enabled == 'True') {
            select_widget('div-phone-number-widget')
            
        }

        var create_form_val = window.is_create_form_allowed;
        if (create_form_val == 'True') {
            select_widget('div-create-form-widget')
            let tmp = document.createElement("DIV");
            tmp.innerHTML = window.initial_form_fields;
            var json_string = tmp.textContent || tmp.innerText || ""
            json_string = json_string.replaceAll(`'`, `"`)
            add_initial_form_sections(JSON.parse(json_string))
            tmp.remove()
            document.getElementById('intent-create-form-fields').style.display = "block";
        } else {

            add_section_in_create_form_modal()

        }

        load_order_of_responses();
    }
}


if (window.location.pathname == "/chat/settings/") {

    response = $.ajax({
        url: "/chat/get-config-params/",
        type: "POST",
        async: false,
        data: {},
        success: function (response) {

            return response;
        },
        error: function (xhr, textstatus, errorthrown) {
            // console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
        }
    }).responseJSON;
    response = custom_decrypt(response)
    response = JSON.parse(response);

    is_feedback_required = response['is_feedback_required'];
    allow_bot_switch = response['allow_bot_switch'];
    document.getElementById("is-feedback-required-checkbox").checked = is_feedback_required;
    document.getElementById("is-bot-switch-checkbox").checked = allow_bot_switch;

    $("#save-settings").click(function (e) {
        is_feedback_required = document.getElementById("is-feedback-required-checkbox").checked;
        allow_bot_switch = document.getElementById("is-bot-switch-checkbox").checked;
        var json_string = JSON.stringify({
            is_feedback_required: is_feedback_required,
            allow_bot_switch: allow_bot_switch
        })

        json_string = EncryptVariable(json_string);

        $.ajax({
            url: "/chat/set-config-params/",
            type: "POST",
            data: {
                json_string: json_string
            },
            success: function (response) {
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Details updated successfully."
                    }, 2000);
                } else {
                    M.toast({
                        "html": "Unable to update the details. Please try again later."
                    }, 2000);
                }
            }
        });
    });
}

if (window.location.pathname.indexOf("/chat/create-intent/") != -1) {
    var url_string = window.location.href
    var url = new URL(url_string);
    var c = url.searchParams.get("val");
    if (c != null) {
        sentence_list = c.split(',')

        for (var i = 0; i < sentence_list.length; i++) {
            value = sentence_list[i]
            addIntentTrainingDataIntoCollection(value);
            $("#add_enter_intent_training_data").val("");
        }
        $("#intent_name").val(sentence_list[0])
        $("#training_sentence_li").addClass('active')
    }


    get_url_bot_pk = url.searchParams.get("bot_pk");
    if (get_url_bot_pk != null) {

        $("#multiple-select-bot-choice-pk-list").val(get_url_bot_pk)
    }

    open_close_language_dropdown_event()
    select_option_for_form_widgets()
    add_language_dropdown_search_event()
    language_dropdown_close_onclicking_outside_event()

    add_section_in_create_form_modal()
}

function create_intent_modal_close(no_of_groups) {

    var checkboxes = document.getElementsByClassName("modify-intent-checkbox")

    for (var count = 0; count < checkboxes.length; count++) {
        checkboxes[count].checked = false
    }

    $("#modal" + no_of_groups).modal('close')

}

function create_intent_sentence_btn(no_of_groups, elem) {
    modal_id = $(elem).parent().parent().attr("id")
    // console.log($(this).parent().parent().attr("id"))
    var selected = [];
    $('#' + modal_id + ' #checkboxes-' + no_of_groups + ' input:checked').each(function () {
        selected.push($(this).attr('name'));
    });

    if (selected.length == 0) {
        M.toast({
            "html": "Please select atleast one training sentence."
        }, 2000);
        return;
    }

    if (last_selected_bot_for_self_learning != null) {
        window.open("/chat/create-intent/?val=" + selected + "&bot_pk=" + last_selected_bot_for_self_learning, '_blank');
    } else {
        window.open("/chat/create-intent/?val=" + selected, '_blank');
    }

    create_intent_modal_close(no_of_groups)

}

function add_training_modal_close(no_of_groups) {
    var checkboxes = document.getElementsByClassName("modify-intent-checkbox")

    for (var count = 0; count < checkboxes.length; count++) {
        checkboxes[count].checked = false
    }

    $("#modal_add_to_intent" + no_of_groups).modal('close')

    $('#modal_add_to_intent' + no_of_groups + ' .easychat-dropdown-select-custom .easychat-console-language-option').closest('.list').find('.easychat-lang-selected').removeClass('easychat-lang-selected');
    $("#easychat-dropdown-select-custom-0" + "-" + no_of_groups + " ul li:eq('0')").addClass('easychat-lang-selected');
    $("#modal_add_to_intent" + no_of_groups + ' #current-0' + '-' + no_of_groups).html("choose from dropdown");

}

function add_training_sentence_self_learning(no_of_groups) {
    selected_intent = $("#modal_add_to_intent" + no_of_groups + " .easychat-lang-selected");
    selected_intent = selected_intent[0].dataset.value
    selected_bot_id = get_url_vars()["bot_pk"];
    if (selected_intent == null || selected_intent == undefined || selected_intent == "" || selected_intent == "choose from dropdown") {
        M.toast({
            "html": "Please select Intent."
        }, 2000);
        return;
    }
    var selected = [];
    $('#modal_add_to_intent' + no_of_groups + ' #checkboxes-' + no_of_groups + ' input:checked').each(function () {
        selected.push($(this).attr('name'));
    });

    if (selected.length == 0) {
        M.toast({
            "html": "Please select atleast one training sentence."
        }, 2000);
        return;
    }

    var json_string = JSON.stringify({
        training_questions: selected,
        intent_pk: selected_intent,
        bot_id: selected_bot_id
    })

    json_string = EncryptVariable(json_string);

    response = $.ajax({
        url: "/chat/add-training-questions/",
        type: "POST",
        // async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response.status == 200) {
                if (selected.length < 2) {
                    M.toast({
                        "html": "Training sentence added successfully"
                    }, 2000);
                } else {
                    M.toast({
                        "html": "Training sentences added successfully"
                    }, 2000);

                }

                if (document.getElementById('easychat-build-bot-toast-div').style.display != 'flex') {
                    document.getElementById('easychat-build-bot-toast-div').style.display = 'flex';
                    document.getElementById("easychat-content-wrapper").style.maxHeight = '85vh';

                    var side_nav = document.getElementById('main-console-sidenav');
                    if (side_nav) {
                        side_nav.style.marginTop = '6.5%';
                    }
                }

                add_training_modal_close(no_of_groups)

            } else if (response.status == 300) {
                M.toast({
                    "html": "Training sentence already exists"
                }, 3000);

            } else if (response.status == 500) {
                M.toast({
                    "html": "Can't add training sentence"
                }, 3000);
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            // console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
            $("#preloader_self_learning_div").hide()
            return {
                "status": 500
            };
        }
    }).responseJSON;

}

$(document).on("click", ".create_intent_from_cluster_btn", function (e) {

    button_id = this.id
    sentence_list_id = button_id.split('___')[1]
    sentence_list = $('#sentences_list_' + sentence_list_id).html()
});

$(document).on("change", "#cluster_start_date, #cluster_end_date, #selected-bot-id", function (e) {
    M.toast({
        "html": "Getting maximum number of classes allowed for the given date range."
    }, 2000);
    $("#preloader_self_learning_div").show()
    startdate = $('#cluster_start_date').val();
    enddate = $('#cluster_end_date').val();
    number_of_clusters = $('#number_of_clusters').val();
    document.getElementById("number_of_clusters").disabled = true;
    selected_bot_id = get_url_vars()["bot_pk"];

    if (selected_bot_id == null || selected_bot_id == undefined || selected_bot_id == "") {
        M.toast({
            "html": "Please select atleast one bot."
        }, 2000);
        return;
    }

    var json_string = JSON.stringify({
        start_date: startdate,
        end_date: enddate,
        number_of_clusters: number_of_clusters,
        bot_id: selected_bot_id
    })

    json_string = EncryptVariable(json_string);

    response = $.ajax({
        url: "/chat/get-cluster-details/",
        type: "POST",
        // async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {
            M.Toast.dismissAll();
            $("#preloader_self_learning_div").hide()
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response.status == 200) {
                document.getElementById("maximum_classes").innerHTML = response["maximum_clusters"];
                document.getElementById("number_of_clusters").disabled = false;
            } else if (response.status == 101) {
                M.toast({
                    "html": response.message
                }, 3000);
                document.getElementById("number_of_clusters").disabled = false;
            } else {
                document.getElementById("maximum_classes").innerHTML = response["maximum_clusters"];
                document.getElementById("number_of_clusters").disabled = false;
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            // console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
            $("#preloader_self_learning_div").hide()
            return {
                "status": 500
            };
        }
    }).responseJSON;
});

$(document).on("click", "#generate_cluster_btn", function (e) {
    startdate = $('#cluster_start_date').val();
    enddate = $('#cluster_end_date').val();

    excel_from_date = startdate.split('-')[2] + "-" + startdate.split('-')[1] + "-" + startdate.split('-')[0]
    excel_to_date = enddate.split('-')[2] + "-" + enddate.split('-')[1] + "-" + enddate.split('-')[0]
    $('#cluster-download-as-excel').attr("href", "/files/SelfLearning-Clusters_from_" + excel_from_date + "_to_" + excel_to_date + ".xlsx")
    number_of_clusters = $('#number_of_clusters').val();
    selected_bot_id = get_url_vars()["bot_pk"];
    maximum_number_of_clusters_allowed = $('#maximum_classes').text();

    if (number_of_clusters == '' || number_of_clusters == null || number_of_clusters == undefined || number_of_clusters <= 0) {
        M.toast({
            "html": "Please enter valid number of clusters."
        }, 2000);
        return;
    }

    if (parseInt(number_of_clusters) > parseInt(maximum_number_of_clusters_allowed)) {
        M.toast({
            "html": "Max classes allowed is " + maximum_number_of_clusters_allowed
        }, 2000);
        return;
    }

    if (selected_bot_id == null || selected_bot_id == undefined || selected_bot_id == "") {
        M.toast({
            "html": "Please select atleast one bot."
        }, 2000);
        return;
    }

    if (startdate == "" || enddate == "" || startdate == null || enddate == null) {
        M.toast({
            "html": "Start date or end date cannot be empty."
        }, 2000);
        return;
    }

    var json_string = JSON.stringify({
        start_date: startdate,
        end_date: enddate,
        number_of_clusters: number_of_clusters,
        bot_id: selected_bot_id
    });
    $("#preloader_self_learning_div").show()

    last_selected_bot_for_self_learning = selected_bot_id;
    json_string = EncryptVariable(json_string);

    response = $.ajax({
        url: "/chat/get-cluster-details/",
        type: "POST",
        // async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {
            $("#preloader_self_learning_div").hide()
            response = custom_decrypt(response)
            response = JSON.parse(response);

            if (response.status == 200 && !isDictEmpty(response["cluster_dict"])) {
                document.getElementById("cluster-download-as-excel").style.display = "block";

                cluster_dict = response["cluster_dict"]

                intent_details_list = getIntentDetails([selected_bot_id], []);

                intent_name_list = intent_details_list["intent_name"];

                intent_pk_list = intent_details_list["intent_pk"];

                html_content = `<div class="row" style="padding:1em; data-select2-id="select2-data-56-xano""><div class="col s12"><div class="col s12" style="margin-bottom: 2.5rem;">
                                                <div class="self-learning-clustering-text-div">Clustering Result</div>
                                                <div class="self-learning-clustering-text-subheading">(Grouping a set of intents in such a way that intents in the same group are more similar to each other than to those in other groups. )
                                                </div>
                                            </div></div>`;

                var no_of_groups = 0;

                for (var key in cluster_dict) {
                    sentence_list = cluster_dict[key]
                    sentence_visible = "";
                    sentence_hidden = "";
                    sentence_visible_length = 0;
                    sentence_hidden_length = 0;
                    html_content += `<div class="col s12 m4">
                                                <div class="card small" style="height: 270px;">
                                                    <div class="card-content dont-break-out scroll-card self-learning-scrollcard-div" style="padding: 1.2rem 1.6rem 1rem !important;">
                                                    <span id="sentences_list_` + key + `"  style="display:none;">
                                                    ` + sentence_list + `
                                                    </span>
                                                        <span class="card-title">` + sentence_list[0] + `</span>`;
                    for (var i = 0; i < sentence_list.length; i++) {
                        if (i < 3) {
                            sentence_visible_length += 1
                            sentence_visible += "<p>" + sentence_list[i] + "</p>"
                        } else {
                            sentence_hidden += "<p>" + sentence_list[i] + "</p>"
                            sentence_hidden_length += 1
                        }
                    }

                    while (sentence_visible_length < 3) {
                        sentence_visible += "<br>"
                        sentence_visible_length += 1
                    }

                    html_content += `<p>` + sentence_visible + `</p>`

                    if (sentence_hidden_length > 1) {
                        html_content += ` <p><a href="#modal` + key + `" class="modal-trigger" id="see_intent_list___` + key + `"><b> and ` + sentence_hidden_length + ` more sentences</b></a></p>`
                    } else if (sentence_hidden_length == 1) {
                        html_content += ` <p><a href="#modal` + key + `" class="modal-trigger" id="see_intent_list___` + key + `"><b> and ` + sentence_hidden_length + ` more sentence</b></a></p>`
                    } else {
                        html_content += `<br>`
                    }


                    html_content += `</div>
                        <div class="card-action" style="padding: 16px 8px;">
                            <div class="self-learning-create-add-btns">
                                <a href="#modal` + key + `" class="btn easychat-button modal-trigger">Create New Intent</a>
                                <a href="#modal_add_to_intent` + key + `" class="btn easychat-button modal-trigger">Add to Existing Intent</a>
                            </div>
                        </div>
                    </div>
                </div>` ;



                    html_content += `  <div id="modal` + key + `" class="modal modal-fixed-footer self-learning-create-add-intent-modal" style="overflow-x: hidden; z-index: 1003; display: none; opacity: 0; top: 4%; transform: scaleX(0.8) scaleY(0.8);" tabindex="0">
                                                <div class="modal-content">
                                                    <h5>Select Training Questions for the intent</h5>
                                                    <div class="self-learning-modal-intent-list-div" id="checkboxes-`+ key + `">`
                    for (var i = 0; i < sentence_list.length; i++) {
                        html_content += `<p>
                                                        <label>
                                                          <input name="` + sentence_list[i] + `" class="modify-intent-checkbox filled-in" type="checkbox" />
                                                          <span class="self-learning-span">` + sentence_list[i] + `</span>
                                                        </label>
                                                        </p>`
                    }


                    html_content += `</div>
                                                </div>
                                                <div class="modal-footer">
                                                    <a href="javascript:void(0)" class="btn transparent-btn black-text" onclick="create_intent_modal_close(` + no_of_groups + `)">Cancel</a>
                                                    <a href="javascript:void(0)" class="btn green lighten-2 black-text" id="submit_training_sentences_btn" onclick="create_intent_sentence_btn(` + no_of_groups + `,this)" style="margin-left:1%">Create Intent</a>
                                                </div>
                                            </div>`


                    html_content += `<div id="modal_add_to_intent` + key + `" class="modal modal-fixed-footer self-learning-create-add-intent-modal" 
            style="overflow-x: hidden; z-index: 1003; display: none; opacity: 0; top: 4%; transform: scaleX(0.8) scaleY(0.8);" 
            tabindex="0" data-select2-id="select2-data-modal_add_to_intent` + key + `" >`

                    html_content += `<div class="modal-content" id="self-learning-intent-div-` + no_of_groups + `" style="overflow-y:scroll" 
           data-select2-id="select2-data-self-learning-intent-div-` + no_of_groups + `">
                                                    <h5>Select Training Questions to add in to existing intent</h5>`

                    html_content += `<div class="easychat-console-custom-dropdown easychat-self-learning-dropdown">
            <div class="easychat-console-select-drop" style="display: none;">
            <span data-value="choose from dropdown">choose from dropdown</span>`


                    for (var i = intent_name_list.length - 1; i >= 0; i--) {
                        html_content += `<span data-value="` + intent_pk_list[i] + `">` + intent_name_list[i] + `</span>`
                    }


                    html_content += `</div>
                            </div>`

                    html_content += `<div class="self-learning-modal-intent-list-div" id="checkboxes-` + key + `">`


                    for (var i = 0; i < sentence_list.length; i++) {

                        html_content += `<p>
                                <label>
                                    <input name="` + sentence_list[i] + `" class="modify-intent-checkbox filled-in" type="checkbox" >
                                    <span class="self-learning-span">` + sentence_list[i] + `</span>
                                </label>
                            </p>`
                    }

                    html_content += `</div>
                             </div>`

                    html_content += `<div class="modal-footer">
                                            <a href="javascript:void(0)" class="btn transparent-btn black-text" onclick="add_training_modal_close(` + no_of_groups + `)">Cancel</a>&nbsp;&nbsp;&nbsp;
                                            <a href="javascript:void(0)" class="btn green lighten-2 black-text" onclick="add_training_sentence_self_learning(` + no_of_groups + `)">Add to Intent</a>
                                        </div>
                                        </div>`
                    no_of_groups += 1;
                }


                html_content += `</div>`;

                $(document).ready(function () {
                    $('.modal').modal();
                    $('select').select2({
                        width: "100%"
                    });

                });

                var search_script = ''

                for (var i = 0; i < no_of_groups; i++) {
                    search_script += `<script>
                        $(document).ready(function() {
                            $('#select-add-to-intent-self-learning-` + i + `').select2({
                                width: "100%",
                                dropdownParent: $("#self-learning-intent-div-` + i + `"),
                            })
                            });</script>`
                }

                $("#div-self-learning-console").html(html_content + search_script);

                for (var count = 0; count < no_of_groups; count++) {
                    create_custom_dropdown_for_selflearning(count)
                    select_option_for_selflearning(count)
                }

                open_close_language_dropdown_event()
                add_language_dropdown_search_event()
                language_dropdown_close_onclicking_outside_event()
            } else if (response.status == 101) {
                M.toast({
                    "html": response.message
                }, 3000);
            } else {
                $("#div-self-learning-console").html("")
                $(".modal").modal();
                $("#modal-no-cluster-available").modal('open');
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            // console.log("Please report this error: "+errorthrown+xhr.status+xhr.responseText);
            $("#preloader_self_learning_div").hide()
            return {
                "status": 500
            };
        }
    }).responseJSON;
});

function renderWordMapper() {
    $.ajax({
        url: '/chat/get-word-mappers/',
        type: 'GET',
        data: {

        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);

            if (response["status"] != 200) {
                console.log("Report this error: word mapper is not rendering",)
                return;
            }

            word_mapper_list = response['word_mapper_list']

            var html_table = `

            <table id="word-mappers-info-table" class="striped highlight responsive-table white" style="margin-top:2%;">
                <thead>
                    <tr>
                        <th>Similar Word</th>
                        <th>Keyword</th>
                    </tr>
                </thead>
                <tbody>`;

            for (var i = 0; i < word_mapper_list.length; i++) {
                keyword = word_mapper_list[i]["keyword"];
                similar_words = word_mapper_list[i]["similar_words"];
                pk = word_mapper_list[i]["pk"];

                html_table += `<tr>
                        <td>` + similar_words + `</td>
                        <td>
                          <div class="row">
                              <div class="col s6">
                                ` + keyword + `&nbsp;&nbsp;
                              </div>
                              <div class="col s6">
                                <div class="right">
                                  <!-- <a class="btn-floating btn-medium waves-effect waves-light purple darken-3"><i class="material-icons">edit</i></a>&nbsp;&nbsp;&nbsp; -->
                                  <a href="#word_mapper_modal_` + i + `" class="modal-trigger btn-floating btn-medium waves-effect waves-light purple darken-3"><i class="material-icons">delete</i></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                </div>
                              </div>
                          </div>
                        </td>
                    </tr>

                    <!-- Modal Structure -->
                    <div id="word_mapper_modal_` + i + `" class="modal">
                      <div class="modal-content">
                        <h4>Are you sure?</h4>
                        <p>Selected word mapper will be deleted permanently?</p>
                      </div>
                      <div class="modal-footer">
                        <a href="/chat/delete-word-mapper/` + pk + `" class="modal-close waves-effect waves-green btn-flat red darken-3 white-text">Agree</a>
                      </div>
                    </div>`;
            }

            html_table += `</tbody>bot
            </table>`;

            $("#word-mappers-table-container").html(html_table);
        },
        error: function (e) {

        }
    })
}

function alphanumeric(inputtxt) {
    var letters = /^[0-9a-zA-Z &@-]+$/;
    if (inputtxt.match(letters)) {
        return true;
    } else {
        return false;
    }
}


function save_edit_word_mapper(word_mapper_pk) {
    var wordtomap_str = "";
    var wordintomap_str = $("#wordintomap-" + word_mapper_pk).val().trim();
    wordtomap_list = M.Chips.getInstance($('#wordtomap-' + word_mapper_pk)).chipsData;

    if (wordtomap_list.length == 0) {
        M.toast({
            "html": "Input single words cannot be empty."
        }, 2000);
        return;
    }

    for (var i = 0; i < wordtomap_list.length; i++) {
        if (wordtomap_list[i]["tag"].trim().length == 0) {
            M.toast({
                "html": "Word cannot be empty."
            }, 2000);
            return;
        }

        if (alphanumeric(wordtomap_list[i]["tag"]) == false) {
            M.toast({
                "html": "Kindly enter alphanumeric text only."
            }, 2000);
            return;
        }
        wordtomap_str += wordtomap_list[i]["tag"].trim() + ",";
    }

    if (wordintomap_str.trim().length == 0) {
        M.toast({
            "html": "Keyword cannot be empty."
        }, 2000);
        return;
    }

    if (alphanumeric(wordintomap_str) == false) {
        M.toast({
            "html": "Kindly enter alphanumeric text only."
        }, 2000);
        return;
    }

    // var selected_bot_id = $("#select-add-wordmapper-bot-"+word_mapper_pk).val();
    var selected_bot_id = get_url_vars()["bot_pk"];
    console.log(selected_bot_id);

    var json_string = JSON.stringify({
        word_mapper_pk: word_mapper_pk,
        values: wordtomap_str,
        keyword: wordintomap_str,
        selected_bot_id: selected_bot_id
    });

    json_string = EncryptVariable(json_string)
    document.getElementById("easychat_word_mapper_preloader").style.display = "block";
    $.ajax({
        url: "/chat/save-word-mappers/",
        type: "POST",
        headers: {
            'X-CSRFToken': get_csrf_token(),
        },
        data: {
            "data": json_string,
        },
        success: function (response) {
            document.getElementById("easychat_word_mapper_preloader").style.display = "none";
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Word Mapper saved successfully"
                }, 2000);
                $("#modal-add-word-mapper").modal("close");
                setTimeout(function (e) {
                    window.location = "/chat/word-mappers/?bot_pk=" + selected_bot_id;
                }, 2000);

            } else {
                M.toast({
                    "html": "Please enter valid data"
                }, 2000);
            }
        },
        error: function (e) {
            document.getElementById("easychat_word_mapper_preloader").style.display = "none";
        }
    });
}

function initialize_add_mapper_word_list() {
    unique_word_mappers_list = [];
    check_word_mappers_list = true;
    var word_map_list = M.Chips.getInstance($('#wordtomap')).chipsData;
    for (let i = 0; i < word_map_list.length; i++) {
        unique_word_mappers_list.push(word_map_list[i]["tag"].trim().toLowerCase())
    }
}

function initialize_edit_mapper_word_list(edit_word_mapper_pk) {
    unique_word_mappers_list = [];
    check_word_mappers_list = true;
    var word_map_list = M.Chips.getInstance($('#wordtomap-' + edit_word_mapper_pk)).chipsData;
    for (let i = 0; i < word_map_list.length; i++) {
        unique_word_mappers_list.push(word_map_list[i]["tag"].trim().toLowerCase())
    }
}

function add_word_mappers(e, data) {
    var added_word = data.childNodes[0].textContent;
    var need_to_delete = false;

    if (check_word_mappers_list) {
        if (unique_word_mappers_list.includes(added_word.trim().toLowerCase())) {
            M.toast({
                "html": "Words must be unique."
            }, 2000);
            need_to_delete = true;
            remove_element_from_list = false;
        } else {
            unique_word_mappers_list.push(added_word.trim().toLowerCase())
        }
    }

    if (alphanumeric(added_word) == false) {
        M.toast({
            "html": "Kindly enter alphanumeric text only."
        }, 2000);
        need_to_delete = true;
    } else if (added_word.trim().length == 0) {
        M.toast({
            "html": "Word cannot be empty."
        }, 2000);
        need_to_delete = true;
    } else if (added_word.trim().split(' ').length > 1) {
        M.toast({
            "html": "Please enter valid word."
        }, 2000);
        need_to_delete = true;
    }

    if (need_to_delete) {
        var added_el = e[0].M_Chips.chipsData
        var elem = e[0].M_Chips.el
        var instance = M.Chips.getInstance(elem);
        instance.deleteChip(added_el.length - 1);
    }
}

function delete_word_mappers(e, data) {
    var deleted_word = data.childNodes[0].textContent;
    if (remove_element_from_list) {
        const index = unique_word_mappers_list.indexOf(deleted_word.trim().toLowerCase());
        if (index > -1) {
            unique_word_mappers_list.splice(index, 1);
        }
    }
    remove_element_from_list = true;
}

if (window.location.pathname.indexOf("/chat/word-mappers/") != -1) {

    $(document).ready(function () {
        $('.modal').modal();
        $('.chips').chips();
        $('#wordtomap').chips({
            onChipAdd: function (e, data) {
                add_word_mappers(e, data)
            },
            onChipDelete: function (e, data) {
                delete_word_mappers(e, data)
            }
        });
        $('.word-mappers-similar-chips').chips({
            onChipAdd: function (e, data) {
                add_word_mappers(e, data)
            },
            onChipDelete: function (e, data) {
                delete_word_mappers(e, data)
            }
        });

        /*load existing word mapper chips starts*/
        similar_chips = document.getElementsByClassName("word-mappers-similar-chips");
        for (var chip_index = 0; chip_index < similar_chips.length; chip_index++) {
            chip_value_list = similar_chips[chip_index].getAttribute("value");
            chip_value_list = chip_value_list.split(",");
            for (var chip_value_index = 0; chip_value_index < chip_value_list.length; chip_value_index++) {
                var tag = chip_value_list[chip_value_index].trim();
                if (tag != "") {
                    M.Chips.getInstance(similar_chips[chip_index]).addChip({
                        'tag': tag
                    });
                }
            }
        }
        /*load existing word mapper chips ends*/
    });

    $(document).on("click", "#save-word-mapper", function (e) {

        var wordtomap_str = "";
        var wordintomap_str = $("#wordintomap").val().trim();
        wordtomap_list = M.Chips.getInstance($('#wordtomap')).chipsData;

        if (wordtomap_list.length == 0) {
            M.toast({
                "html": "Input single words cannot be empty."
            }, 2000);
            return;
        }

        for (var i = 0; i < wordtomap_list.length; i++) {
            if (wordtomap_list[i]["tag"].trim().length == 0) {
                M.toast({
                    "html": "Word cannot be empty."
                }, 2000);
                return;
            }
            if (alphanumeric(wordtomap_list[i]["tag"]) == false) {
                M.toast({
                    "html": "Kindly enter alphanumeric text only."
                }, 2000);
                return;
            }
            wordtomap_str += wordtomap_list[i]["tag"].trim() + ",";
        }

        if (wordintomap_str.trim().length == 0) {
            M.toast({
                "html": "Keyword cannot be empty."
            }, 2000);
            return;
        }

        if (alphanumeric(wordintomap_str) == false) {
            M.toast({
                "html": "Kindly enter alphanumeric text only."
            }, 2000);
            return;
        }

        var selected_bot_id = get_url_vars()["bot_pk"];
        console.log(selected_bot_id);

        var json_string = JSON.stringify({
            word_mapper_pk: null,
            values: wordtomap_str,
            keyword: wordintomap_str,
            selected_bot_id: selected_bot_id
        })
        json_string = EncryptVariable(json_string);
        document.getElementById("easychat_word_mapper_preloader").style.display = "block";
        $.ajax({
            url: "/chat/save-word-mappers/",
            type: "POST",
            headers: {
                'X-CSRFToken': get_csrf_token(),
            },
            data: {
                "data": json_string,
            },
            success: function (response) {
                document.getElementById("easychat_word_mapper_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Word Mapper Added successfully"
                    }, 2000);
                    $("#modal-add-word-mapper").modal("close");

                    setTimeout(function (e) {
                        window.location = "/chat/word-mappers/?bot_pk=" + selected_bot_id;
                    }, 2000);
                } else if (response["status"] == 101) {
                    M.toast({
                        "html": response["message"]
                    }, 2000);
                } else {
                    M.toast({
                        "html": "Please enter valid data"
                    }, 2000);
                }
            },
            error: function (e) {
                document.getElementById("easychat_word_mapper_preloader").style.display = "none";
            }
        });
    });
}

function download_word_mapper_template() {
    $.ajax({
        url: "/chat/download-word-mapper-template/",
        type: "POST",
        headers: {
            'X-CSRFToken': get_csrf_token(),
        },
        success: function (response) {
            response = custom_decrypt(response);
            response = JSON.parse(response);
            if ((response["status"] = 200)) {
                if (response["export_path"] == null) {
                    alert("Sorry, unable to process your request. Kindly try again later.");
                } else {
                    if (response["export_path_exist"]) {
                        window.open(response["export_path"], "_blank");
                    } else {
                        alert("Requested data doesn't exists. Kindly try again later.");
                    }
                }
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        },
    });
}

$(document).on("click", "#import-bot-word-mapper", function (e) {

    bot_id = get_url_vars()["bot_pk"];

    e.preventDefault();

    var input_file = ($("#input_import_word_mapper_file"))[0].files[0]

    if (input_file == null || input_file == undefined) {
        M.toast({
            "html": "Please select a file."
        }, 2000);
        return false;
    }

    if (check_malicious_file(input_file.name) == true) {
        return false;
    }

    var formData = new FormData();
    var csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
    formData.append("input_file", input_file);
    formData.append("data", JSON.stringify({
        "bot_id": bot_id
    }));

    $("#preloader-import-word-mapper").show();
    $.ajax({
        url: "/chat/upload-word-mappers/",
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token
        },
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Words Created Successfully."
                }, 2000);
                setTimeout(function () {
                    window.location.reload();
                }, 2000);
            } else if (response["status"] == 401) {
                var message = response.message;
                M.toast({
                    "html": message
                }, 5000);
                setTimeout(function () {
                    window.location.reload();
                }, 5000);
            } else if (response["status"] == 300) {
                M.toast({
                    "html": "Not supported file format"
                }, 2000);
            } else {
                M.toast({
                    "html": "Unable to import. Please upload valid excel file."
                }, 2000);
            }
            $('#input_import_word_mapper_file2').val("")
            $("#preloader-import-word-mapper").hide();
            $("#modal-import-word-mapper-excel").modal("close");
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
            $("#preloader-import-word-mapper").hide();
            $("#modal-import-word-mapper-excel").modal("close");
        }
    });
});

if (window.location.pathname.indexOf("/chat/channels/web") != -1) {

    function font_family_list(font, font_size) {
        $.ajax({
            url: "https://www.googleapis.com/webfonts/v1/webfonts?key=AIzaSyAxUTWdP9EaAtUAdWscKgu8KXLwzW4tXOI",
            type: "GET",
            success: function (response) {
                var html_string = '';
                font_item_list = [];
                font_item_list = response['items']
                for (var i = 0; i < font_item_list.length; i++) {
                    if (font_item_list[i]['family'] == font) {
                        html_string += '<option value=' + font_item_list[i]['family'].replace(' ', '+') + ' selected>' + font_item_list[i]['family'] + '</option>';
                    } else {
                        html_string += '<option value=' + font_item_list[i]['family'].replace(' ', '+') + '>' + font_item_list[i]['family'] + '</option>';
                    }
                }
                size_list = '<option value="" selected>Choose One</option>'
                for (var i = 1; i <= 40; i++) {
                    if (font_size == i) {
                        size_list += "<option value='" + i + "px' selected>" + i + "px </option>";
                    } else {
                        size_list += "<option value='" + i + "px'>" + i + "px </option>";
                    }
                }
                $('#modal-set-bot-font').modal("open");
                $("#bot-font-list").select2({
                    dropdownParent: $("#modal-set-bot-font"),
                    width: "100%",
                });
                $("#bot-font-size-list").select2({
                    dropdownParent: $("#modal-set-bot-font"),
                    width: "100%",
                });
                $("#bot-custom-font-size").select2({
                    dropdownParent: $("#modal-set-bot-font"),
                    width: "100%",
                });
                document.getElementById("bot-font-list").innerHTML = html_string;
                document.getElementById("bot-custom-font-size").innerHTML = size_list;

            },
            error: function () {

            },
        });
    }

    function set_test_font(font, font_size) {
        font_css_list = document.getElementsByClassName("bot-name");
        for (var i = 0; i < font_css_list.length; i++) {
            font_css_list[i].remove();
        }

        font_family = document.getElementById("bot-font-list").value;
        font_size_custom = document.getElementById("bot-font-size-list").value;
        if (font_size_custom == "custom") {
            document.getElementById("bot-custom-font-size-div").style.display = "block";
        } else {
            document.getElementById("bot-custom-font-size-div").style.display = "none";
            document.getElementById("bot-custom-font-size").value = "";
        }
        if (font_size_custom == "custom") {
            font_size_custom = document.getElementById("bot-custom-font-size").value;
        }
        if (font_size_custom == "") {
            font_size_custom = font_size;
        }
        if (font_family == '') {
            font_family = font;
        }
        document.getElementById("bot-font-test").style.fontFamily = font_family.replace('+', ' ');
        document.getElementById("bot-font-data").style.fontFamily = font_family.replace('+', ' ');
        document.getElementById("bot-font-test").style.fontSize = "14px";
        document.getElementById("bot-font-test").value = document.getElementById("bot-font-test").value;
        var x = document.createElement("LINK");
        x.setAttribute("rel", "stylesheet");
        x.setAttribute("href", "https://fonts.googleapis.com/css?family=" + font_family);
        x.setAttribute("class", "bot-font");
        document.head.appendChild(x);
    }

    function save_bot_font(font, font_size) {
        var location_href = window.location.href;
        var location_href = location_href.replace("#", "");
        var location_href = location_href.replace("!", "");
        var bot_id = get_url_vars()['id']
        font_family = document.getElementById("bot-font-list").value;
        font_size_custom = document.getElementById("bot-font-size-list").value;
        if (font_size_custom == "custom") {
            font_size_custom = document.getElementById("bot-custom-font-size").value;
        }
        if (font_size_custom == "") {
            font_size_custom = font_size;
        }
        if (font_family == '' || check_font_change) {
            font_family = font.replace('+', ' ');
        }
        font_family = font_family.replace('+', ' ');
        var json_string = JSON.stringify({
            bot_id: bot_id,
            font: font_family,
            font_size: "14px",
        })
        json_string = EncryptVariable(json_string)
        $.ajax({
            url: "/chat/bot/save-font/",
            type: "POST",
            headers: {
                'X-CSRFToken': get_csrf_token(),
            },
            data: {
                json_string: json_string
            },
            success: function (response) {
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    document.getElementById("bot-font-data").value = font_family;
                } else {
                    M.toast({
                        "html": "Internal Server Error"
                    }, 2000);
                }
            },
            error: function (error) {
                document.getElementById("easychat_web_channel_preloader").style.display = "none";
                console.log("Report this error: ", error)
            }
        });
        document.getElementById("bot-font-list").value;
        document.getElementById("bot-font-size-list").value;
        document.getElementById("bot-custom-font-size").value;
    }
    var location_href = window.location.href;
    var location_href = location_href.replace("#", "");
    var location_href = location_href.replace("!", "");
    var bot_id = get_url_vars()['id']
    var selected_language = get_url_vars()['selected_lang']
    var json_string = JSON.stringify({
        bot_id: bot_id,
        selected_language: selected_language,
    })
    json_string = EncryptVariable(json_string)
    document.getElementById("easychat_web_channel_preloader").style.display = "block";
    $.ajax({
        url: "/chat/channels/web/edit/",
        type: "POST",
        headers: {
            'X-CSRFToken': get_csrf_token(),
        },
        data: {
            json_string: json_string
        },
        success: function (response) {
            document.getElementById("easychat_web_channel_preloader").style.display = "none";
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                //$("#welcome-message").val(response["welcome_message"]);
                //$("#failure-message").val(response["failure_message"]);
                // document.getElementById("easychat_web_channel_preloader").style.display = "none";

                failure_recommendation_list = response["failure_recommendations"]["items"]
                initial_message_list = response["initial_message"]["items"];
                images = response["initial_message"]["images"];
                compressed_images = response["initial_message"]["compressed_images"];
                videos = response["initial_message"]["videos"];

                carousel_img_url_list = response["carousel_img_url_list"]["items"];
                compressed_img_url_list = response["carousel_img_url_list"]["compressed_items"];
                redirect_url_list = response["redirect_url_list"]["items"];
                welcome_banner_count = response["welcome_banner_count"];
                try {
                    selected_language = get_url_vars()['selected_lang']
                    if (selected_language == "en" || selected_language == null || selected_language == undefined) {
                        if (welcome_banner_count < 1) {
                            preview_banner_button = document.getElementById("preview-banner")
                            preview_banner_button.style.opacity = "0.5";
                            preview_banner_button.disabled = true;
                            preview_banner_button.style.cursor = "not-allowed";
                        }
                    }

                } catch (err) {
                    console.log(err)
                }

                for (var i = 0; i < carousel_img_url_list.length; i++) {
                    if (compressed_img_url_list) {
                        AddBannerRedirectionUrl(carousel_img_url_list[i], redirect_url_list[i], compressed_img_url_list[i]);
                    } else {
                        AddBannerRedirectionUrl(carousel_img_url_list[i], redirect_url_list[i]);
                    }
                }

                if (images != null && images != undefined && images.length > 0) {
                    document.getElementById("uploaded-bot-welcome-image").src = images[0];
                    if (compressed_images && compressed_images.length > 0) {
                        document.getElementById("uploaded-bot-welcome-image").dataset.compressed_src = compressed_images[0];
                    }

                    document.getElementById("uploaded-bot-welcome-image").style.display = "inline-block";
                    $("#remove-bot-welcome-image").show();
                }

                if (videos != null && videos != undefined && videos.length > 0) {
                    document.getElementById("upload-bot-welcome-video-url").value = videos[0];
                }
            } else {
                console.log("Internal server error.");
            }
        },
        error: function (error) {
            document.getElementById("easychat_web_channel_preloader").style.display = "none";
            console.log("Report this error: ", error)
        }
    });

    function handle_theme_selection(elem) {
        if (prev_theme_selected == "") {
            prev_theme_selected = THEME_SELECTED
        }
        if (elem.id == "theme_3") {
            $('#show_welcome_banner_checkbox').hide()
            $('#show_initial_questions_checkbox').hide()
            if (!check_is_welcome_banner_present()) {
                showToast("Welcome banner can not be empty for this theme");
                document.getElementById(prev_theme_selected).checked = true
                elem.checked = false
                return;
            }
        } else {
            $('#show_welcome_banner_checkbox').css('display', 'table-row');
            $('#show_initial_questions_checkbox').css('display', 'table-row');
        }
        prev_theme_selected = elem.id;
    }

    $(document).on("click", "#ignore-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "Web"
        ignore_changes_in_non_primary_languages(bot_id, channel_name)
    });
    $(document).on("click", "#auto-fix-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "Web"
        auto_fix_changes_in_non_primary_languages(bot_id, channel_name)
    });
    $(document).ready(function () {
        create_language_custom_dropdowns();
        disable_auto_pop_up_fileds();
        // will be using this in future
        // disable_web_landing_options();
    });
    add_channel_language_selction_event("web")
    add_language_dropdown_search_event()
    language_dropdown_close_onclicking_outside_event()
    language_search_dropdown_event()
    open_close_language_dropdown_event()

    $(document).on("click", "#save-web-channel-for-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let selected_language = get_url_vars()['selected_lang']
        let welcome_message = $("#welcome-message").trumbowyg('html')
        let failure_message = $("#failure-message").trumbowyg('html')
        let authentication_message = $("#authentication-message").trumbowyg('html')
        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);

        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }

        var is_auto_popup_enabled_desktop = document.getElementById("is-bot-auto-popup-allowed-desktop").checked;
        var is_auto_popup_enabled_mobile = document.getElementById("is-bot-auto-popup-allowed-mobile").checked;
        var auto_popup_timer = document.getElementById("bot_auto_popup_timer").value;
        var auto_popup_type = document.getElementById("bot-popup-options-values").value;
        var auto_popup_text = document.getElementById("bot_auto_popup_text").value;
        var auto_popup_initial_message_list = $("#bot-popup-multiple-select-message-list").val();
        var save_auto_pop_up_text = false

        if (is_auto_popup_enabled_desktop == true || is_auto_popup_enabled_mobile == true) {
            if (auto_popup_timer.trim() == "") {
                M.toast({
                    "html": "Auto popup timer cannot be empty."
                }, 2000);
                return;
            }
            if (auto_popup_type.trim() == "0") {
                M.toast({
                    "html": "Auto popup type cannot be empty."
                }, 2000);
                return;
            }

            if (auto_popup_type == 2) {
                save_auto_pop_up_text = true
                if (auto_popup_text.trim() == "") {
                    M.toast({
                        "html": "Auto popup text cannot be empty."
                    }, 2000);
                    return;
                }

            } else if (auto_popup_type == 3) {
                save_auto_pop_up_text = true
                if (auto_popup_initial_message_list.length == 0) {
                    M.toast({
                        "html": "Auto popup initial messages cannot be empty."
                    }, 2000);
                    return;
                }

                if (auto_popup_text.trim() == "") {
                    M.toast({
                        "html": "Auto popup text cannot be empty."
                    }, 2000);
                    return;
                }

            }

        }

        if (auto_popup_timer == '' || auto_popup_timer == null)
            auto_popup_timer = 5;
        channel_name = "Web"

        json_string = {
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            channel_name: channel_name,
            selected_language: selected_language,
            authentication_message: authentication_message,
            auto_popup_text: auto_popup_text,
            save_auto_pop_up_text: save_auto_pop_up_text,

        }
        json_string = JSON.stringify(json_string);
        json_string = EncryptVariable(json_string);
        document.getElementById("easychat_web_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/save-channel-language-tuned-objects/",
            type: "POST",
            data: {
                json_string: json_string
            },
            success: function (response) {
                document.getElementById("easychat_web_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = set_url_parameter("selected_lang", "en")
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                document.getElementById("easychat_web_channel_preloader").style.display = "none";
                console.log("Report this error: ", error);
            },
        });
    });

}


$('#is-bot-auto-popup-allowed-desktop, #is-bot-auto-popup-allowed-mobile').click(function () {
    var bot_auto_popup_allowed_desktop = document.getElementById("is-bot-auto-popup-allowed-desktop").checked;
    var bot_auto_popup_allowed_mobile = document.getElementById("is-bot-auto-popup-allowed-mobile").checked;
    if (bot_auto_popup_allowed_desktop == true || bot_auto_popup_allowed_mobile == true) {
        document.getElementById("bot-popup-time").style.display = "table-row";
        document.getElementById("bot-popup-options").style.display = "table-row";
        document.getElementById('bot-popup-inactivity').style.display = "table-row";
        if(document.getElementById('auto_popup_enable_custom_intents').checked == true && document.getElementById("bot-popup-options-values").value == "3"){
            $("#enable_custom_intents_web_auto_popup").show();
            $("#enable_custom_intents_web_auto_popup_list").show();
        }
        else{
            $("#enable_custom_intents_web_auto_popup").hide();
            $("#enable_custom_intents_web_auto_popup_list").hide();
        }

    }
    if (bot_auto_popup_allowed_desktop == false && bot_auto_popup_allowed_mobile == false) {
        document.getElementById("bot-popup-time").style.display = "none";
        document.getElementById("bot-popup-options").style.display = "none";
        document.getElementById('bot-popup-intents').style.display = "none";
        document.getElementById('bot-popup-text').style.display = "none";
        document.getElementById('bot-popup-options-values').value = "0";
        document.getElementById('bot-popup-options-values').value = "0";
        document.getElementById('bot-popup-inactivity').style.display = "none";
        $("#enable_custom_intents_web_auto_popup").hide();
        $("#enable_custom_intents_web_auto_popup_list").hide();
        document.getElementById('bot-popup-custom-intent').style.display = "none";
    }
});

function show_popup_options(select) {
    if (select.value == 2) {
        document.getElementById('bot-popup-text').style.display = "table-row";
        document.getElementById('bot-popup-intents').style.display = "none";
        $("#enable_custom_intents_web_auto_popup").hide();
        $("#enable_custom_intents_web_auto_popup_list").hide();
        document.getElementById('bot-popup-custom-intent').style.display = "none";

    } else if (select.value == 3) {
        document.getElementById('bot-popup-intents').style.display = "table-row";
        document.getElementById('bot-popup-text').style.display = "table-row";
        document.getElementById('bot-popup-custom-intent').style.display = "table-row";
        if(document.getElementById('auto_popup_enable_custom_intents').checked==true){
            $("#enable_custom_intents_web_auto_popup").show();
            $("#enable_custom_intents_web_auto_popup_list").show();
        }
        else{
            $("#enable_custom_intents_web_auto_popup").hide();
            $("#enable_custom_intents_web_auto_popup_list").hide();
        }
    } else {
        document.getElementById('bot-popup-intents').style.display = "none";
        document.getElementById('bot-popup-text').style.display = "none";
        $("#enable_custom_intents_web_auto_popup").hide();
        $("#enable_custom_intents_web_auto_popup_list").hide();
        document.getElementById('bot-popup-custom-intent').style.display = "none";
    }
}

function check_channel_messages_validation(welcome_message, failure_message, authentication_message) {
    var message = "No Error";
    if (welcome_message.trim() == "") {
        message = "Welcome message cannot be empty."
        return message;
    }

    if (welcome_message.trim().length > character_limit_large_text) {
        message = "Max limit of 500 characters for welcome message exceeded."
        return message;
    }

    if (failure_message.trim() == "") {
        message = "Failure message cannot be empty."
        return message;
    }

    if (failure_message.trim().length > character_limit_large_text) {
        message = "Max limit of 500 characters for failure message exceeded."
        return message;
    }

    if (authentication_message.trim() == "") {
        message = "Authentication message cannot be empty."
        return message;
    }

    if (authentication_message.trim().length > character_limit_large_text) {
        message = "Max limit of 500 characters for authentication message exceeded."
        return message;
    }
    return message;
}

function add_web_landing_url() {

    var bot_id = get_url_vars()['id']
    let selected_language = get_url_vars()['selected_lang']
    if (selected_language == undefined || selected_language == null) {
        selected_language = "en"
    }
    web_landing_url = document.getElementById("add_landing_url_data").value.trim();
    if (isValidURL(web_landing_url) == false) {
        M.toast({
            "html": "URL/Links added must consist of HTTP/HTTPS, Eg. https://www.google.com"
        }, 2000);
        return;
    }

    web_initial_intent = document.getElementById("select-web-landing-list").value;
    if (web_landing_url != "" && web_initial_intent == "") {
        M.toast({
            "html": "Please select an intent."
        }, 2000);
        return;
    }

    show_prompt_message_after_timer = false
    prompt_message = ""
    prompt_message_timer = ""
    if (document.getElementById("show_prompt_details").checked) {
        show_prompt_message_after_timer = true
        prompt_message = document.getElementById("prompt_message").value
        if (prompt_message == "") {
            M.toast({
                "html": "Please enter a prompt message"
            }, 2000);
            return;
        }
        prompt_message_timer = document.getElementById("prompt_message_timer").value
        if (prompt_message_timer == "") {
            M.toast({
                "html": "5 seconds is selected by default"
            }, 2000);
            prompt_message_timer = 5
        }

        document.getElementById("show_prompt_details").checked = false;
        document.getElementById("prompt_message_timer").value = ""
        document.getElementById("prompt_message").value = ""
    }

    document.getElementById("add_landing_url_data").value = "";
    $("#select-web-landing-list").select2().val("").trigger("change");

    json_string = JSON.stringify({
        bot_id: bot_id,
        web_landing_url: web_landing_url,
        web_initial_intent: web_initial_intent,
        show_prompt_message_after_timer: show_prompt_message_after_timer,
        prompt_message: prompt_message,
        prompt_message_timer: prompt_message_timer,
        selected_language: selected_language,
    });
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/channels/save-web-landing/",
        type: "POST",
        headers: {
            'X-CSRFToken': get_csrf_token(),
        },
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Changes saved. Please update js file again."
                })
                setTimeout(function () {
                    window.location.reload()
                }, 2000)

                // var id = response["id"]
                // var intent_name = response["intent_name"]
                // var table_html = '<tr id="web_landing_row_'+ id +'">\
                //                             <td>'
                //                                 + web_landing_url  +
                //                             '</td>\
                //                             <td>' 
                //                                 + intent_name +
                //                             '</td>'

                if (show_prompt_message_after_timer == true) {
                    table_html += '<td><label><input type="checkbox" id="show_prompt_checked" checked disabled="disabled"><span></span></label></td></tr>'
                } else {
                    table_html += '<td><label><input type="checkbox" id="show_prompt_checked"><span></span></label></td></tr>'
                }

                document.getElementById("table-web-landing-data").innerHTML += table_html
            } else if (response["status"] == 301) {
                M.toast({
                    "html": "This url already exists"
                })
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        },
    });
}

function edit_web_landing(id, old_url) {
    var web_url = document.getElementById("edit_web_url_" + id).value.trim();
    if (isValidURL(web_url) == false && web_url != "") {
        M.toast({
            "html": "Please enter a valid URL"
        }, 2000);
        return;
    }
    var intent_value = document.getElementById("edit_select_list_" + id).value;
    if (web_url != "" && intent_value == "") {
        M.toast({
            "html": "Please select one of the following intent."
        }, 2000);
        return;
    }
    var bot_id = get_url_vars()['id']
    let selected_language = get_url_vars()['selected_lang']
    if (selected_language == undefined || selected_language == null) {
        selected_language = "en"
    }
    show_prompt_message_after_timer = false
    prompt_message = ""
    prompt_message_timer = ""
    if (document.getElementById("edit_checkbox_" + id).checked) {
        show_prompt_message_after_timer = true
        prompt_message = (document.getElementById("prompt_message_" + id).value).trim()
        prompt_message = stripHTML(prompt_message)
        if (prompt_message == "") {
            document.getElementById("prompt_message_" + id).value = ""
            M.toast({
                "html": "Please enter a prompt message"
            }, 2000);
            return;
        }
        prompt_message_timer = document.getElementById("prompt_message_timer_" + id).value
        if (prompt_message_timer == "") {
            M.toast({
                "html": "5 seconds is selected by default"
            }, 2000);
            prompt_message_timer = 5
        }
    }
    json_string = JSON.stringify({
        bot_id: bot_id,
        web_url: web_url,
        intent_value: intent_value,
        id: id,
        old_url: old_url,
        show_prompt_message_after_timer: show_prompt_message_after_timer,
        prompt_message: prompt_message,
        prompt_message_timer: prompt_message_timer,
        selected_language: selected_language
    });
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/channels/edit-web-landing/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Details updated successfully."
                })
                window.location = window.location.href;
            } else if (response["status"] == 301) {
                M.toast({
                    "html": "Please update atleast one field."
                })
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        },
    });
}

function edit_web_landing_for_non_primary_language(id, old_url) {


    var bot_id = get_url_vars()['id']
    let selected_language = get_url_vars()['selected_lang']
    if (selected_language == undefined || selected_language == null) {
        selected_language = "en"
    }
    prompt_message = ""
    if (document.getElementById("edit_checkbox_" + id).checked) {
        show_prompt_message_after_timer = true
        prompt_message = (document.getElementById("prompt_message_" + id).value).trim()
        if (prompt_message == "") {
            document.getElementById("prompt_message_" + id).value = ""
            M.toast({
                "html": "Please enter a prompt message"
            }, 2000);
            return;
        }
    }
    json_string = JSON.stringify({
        bot_id: bot_id,
        id: id,
        old_url: old_url,
        prompt_message: prompt_message,
        selected_language: selected_language
    });
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/channels/edit-web-landing-for-non-primary-language/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Details updated successfully."
                })
                window.location = window.location.href;
            } else if (response["status"] == 301) {
                M.toast({
                    "html": "Please update atleast one field."
                })
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        },
    });
}

function delete_entry_web_landing(id) {
    var bot_id = get_url_vars()['id']
    json_string = JSON.stringify({
        bot_id: bot_id,
        id: id,
    });
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/channels/delete-web-landing/",
        type: "POST",
        headers: {
            'X-CSRFToken': get_csrf_token(),
        },
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Details updated successfully."
                })
                window.location = window.location.href;
            } else if (response["status"] == 301) {
                M.toast({
                    "html": "The URL is alredy exist in the list."
                })
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        },
    });
}

function generate_campaign_link() {
    intent_pk = null

    if (window.location.href.indexOf("intent_pk=") != -1) {
        active_url = window.location.href.replace("#", "");
        active_url = active_url.replace("!", "");
        intent_pk = active_url.substring(active_url.indexOf("intent_pk=") + "intent_pk=".length,);
        intent_pk = intent_pk.split("&")[0];
    }

    if (intent_pk == null || intent_pk == "") {
        return;
    }

    campaign_link = document.getElementById("campaign_url").value;
    campaign_link = stripHTML(campaign_link);
    campaign_link = campaign_link.trim()

    if (campaign_link == "" || !(isValidURL(campaign_link))) {
        M.toast({
            "html": "URL/Links added must consist of HTTP/HTTPS, Eg. https://www.google.com."
        })
        return;
    }
    if (campaign_link.length > 500) {
        M.toast({
            "html": "Campaign link should be less than 500 characters."
        })
        return;
    }

    json_string = JSON.stringify({
        intent_pk: intent_pk,
        campaign_link: campaign_link,
        bot_pk: BOT_ID
    });

    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/generate-campaign-link/",
        type: "POST",
        data: {
            json_string: json_string
        },
        headers: {
            "X-CSRFToken": get_csrf_token()
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Campaign link generated successfully."
                })

                window.location.href = window.location.href
            } else if (response["status"] == 300) {
                M.toast({
                    "html": response["message"]
                })
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        },
    });
}

function copy_text_to_clipboard(text) {
    navigator.clipboard.writeText(text).then(function () {
        M.toast({
            "html": "Copied Successfully."
        })
    }, function (err) {
        M.toast({
            "html": "Cannot copy. Please try again."
        })
    });
}

if (window.location.pathname.indexOf("/chat/channels/google-assistant") != -1) {
    var location_href = window.location.href;
    var location_href = location_href.replace("#", "");
    var location_href = location_href.replace("!", "");
    var bot_id = get_url_vars()['id'];
    var json_string = JSON.stringify({
        bot_id: bot_id
    })
    json_string = EncryptVariable(json_string);
    document.getElementById("easychat_google_assistant_channel_preloader").style.display = "block";
    $.ajax({
        url: "/chat/channels/google-assistant/edit/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            document.getElementById("easychat_google_assistant_channel_preloader").style.display = "none";
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {

                failure_recommendation_list = response["failure_recommendations"]["items"]
                initial_message_list = response["initial_message"]["items"];
                images = response["initial_message"]["images"];
                videos = response["initial_message"]["videos"];

                if (images != undefined && images != null && images.length > 0) {
                    document.getElementById("uploaded-bot-welcome-image").src = images[0];
                    document.getElementById("uploaded-bot-welcome-image").style.display = "inline-block";
                    $("#remove-bot-welcome-image").show();
                }

                if (videos != undefined && videos != null && videos.length > 0) {
                    document.getElementById("upload-bot-welcome-video-url").value = videos[0];
                }


            } else {
                console.log("Internal server error.");
            }
        },
        error: function (error) {
            document.getElementById("easychat_google_assistant_channel_preloader").style.display = "none";
            console.log("Report this error: ", error)
        }
    });

    add_channel_language_selction_event("google-assistant")
    add_language_dropdown_search_event()
    language_dropdown_close_onclicking_outside_event()
    language_search_dropdown_event()
    open_close_language_dropdown_event()
    $(document).ready(function () {
        create_language_custom_dropdowns();
    });
    $(document).on("click", "#ignore-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "GoogleHome"
        ignore_changes_in_non_primary_languages(bot_id, channel_name)
    });
    $(document).on("click", "#auto-fix-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "GoogleHome"
        auto_fix_changes_in_non_primary_languages(bot_id, channel_name)
    });

    $(document).on("click", "#save-google-channel", function (e) {
        var location_href = window.location.href;
        var location_href = location_href.replace("#", "");
        var location_href = location_href.replace("!", "");
        var bot_id = get_url_vars()['id'];
        // var welcome_message = $('#welcome-message').val();
        // var failure_message = $('#failure-message').val();
        // var authentication_message = $("#authentication-message").val();
        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var is_language_auto_detection_enabled = document.getElementById("is_language_auto_detection_enabled").checked
        var is_enable_choose_language_flow_enabled_for_welcome_response = document.getElementById("is_enable_choose_language_flow_enabled_for_welcome_response").checked

        selected_supported_languages = get_selected_languages_list()

        if ("en" in selected_supported_languages == false) {
            selected_supported_languages.push("en");
        }

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }

        initial_message_list = $("#multiple-select-google-initial-message-list").val();

        failure_recommendation_list = $("#multiple-select-google-failure-message-list").val();

        channel_name = "GoogleHome"
        is_project_details_added = add_google_alexa_project_id(channel_name, false)
        if (!is_project_details_added) {
            return;
        }
        json_string = JSON.stringify({
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            authentication_message: authentication_message,
            initial_message_list: initial_message_list,
            image_url: "",
            video_url: "",
            failure_recommendation_list: failure_recommendation_list,
            selected_supported_languages: selected_supported_languages,
            is_enable_choose_language_flow_enabled_for_welcome_response: is_enable_choose_language_flow_enabled_for_welcome_response,
            is_language_auto_detection_enabled: is_language_auto_detection_enabled,
        });
        json_string = EncryptVariable(json_string);
        document.getElementById("easychat_google_assistant_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/channels/google-assistant/save/",
            type: "POST",
            data: {
                json_string: json_string
            },
            headers: {
                "X-CSRFToken": get_csrf_token()
            },
            success: function (response) {
                document.getElementById("easychat_google_assistant_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else if (response["status"] == 402) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                    setTimeout(function() {
                        window.location.href = "/chat/home"
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                document.getElementById("easychat_google_assistant_channel_preloader").style.display = "none";
                console.log("Report this error: ", error);
            }
        });
    });

    $("#language-box-options-container .option .item-checkbox").change(function () {

        enable_disable_auto_language_detection_toogle();
        enable_disable_welcome_message_language_change_toogle(true)

    });

    $(document).on("click", "#save-google-channel-for-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let selected_language = get_url_vars()['selected_lang']

        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }
        channel_name = "GoogleHome"

        json_string = {
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            channel_name: channel_name,
            selected_language: selected_language,
            authentication_message: authentication_message,
            save_auto_pop_up_text: false,
        }
        json_string = JSON.stringify(json_string);
        json_string = EncryptVariable(json_string);
        document.getElementById("easychat_google_assistant_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/save-channel-language-tuned-objects/",
            type: "POST",
            data: {
                json_string: json_string
            },
            success: function (response) {
                document.getElementById("easychat_google_assistant_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                document.getElementById("easychat_web_channel_preloader").style.display = "none";
                console.log("Report this error: ", error);
            },
        });
    });
}
$(document).on("click", "#upload-gmb-display-image", function (e) {
    e.preventDefault();
    var input_upload_image = ($("#input_upload_gmb-display-image"))[0].files[0]

    if (input_upload_image == null || input_upload_image == undefined) {
        M.toast({
            "html": "Please select a file"
        }, 2000);

        setTimeout(function () {
            $('#modal-upload-gmb-display-image').modal('open');
        }, 200);
        return false;
    }

    if (input_upload_image.size > 51200) {
        M.toast({
            "html": "Size limit exceed(should be less than 50 KB)."
        }, 2000);

        setTimeout(function () {
            $('#modal-upload-gmb-display-image').modal('open');
        }, 200);

        return false;
    }

    if (check_malicious_file(input_upload_image.name) == true) {

        setTimeout(function () {
            $('#modal-upload-gmb-display-image').modal('open');
        }, 200);
        return false;
    }

    var reader = new FileReader();
    reader.readAsDataURL(input_upload_image);
    reader.onload = function () {

        base64_str = reader.result.split(",")[1];

        uploaded_file = [];
        uploaded_file.push({
            "filename": input_upload_image.name,
            "base64_file": base64_str,
        });

        upload_gmb_display_image();
    };

    reader.onerror = function (error) {
        console.log('Error: ', error);
    };
});

async function upload_gmb_display_image() {
    var response = await upload_image();

    if (response && response.status == 200) {
        src = window.location.protocol + "//" + window.location.host + response["src"];
        $("#gmb_display_picture_url").click()
        $("#gmb_display_picture_url").val(src);
        document.getElementById("gmb-display-image-preview").src = src;

        document.getElementById('input_upload_gmb-display-image2').value = "";
    }
}

function upload_gmb_credentials_file() {

    var input_uploaded_files = ($("#input-upload-gmb-credentials-file"))[0].files;
    bot_id = (get_url_vars()["id"])

    if (input_uploaded_files.length == 0) {
        M.toast({
            "html": "Please select a file to upload."
        }, 2000);
        return;
    }


    var formData = new FormData();
    formData.append("file", input_uploaded_files[0]);
    formData.append("bot_id", bot_id)

    $.ajax({
        url: "/chat/upload-gmb-credential-file/",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
            // $("#easychat-drive-files-preloader").hide();
            if (response["status"] == 200) {
                $("#modal-upload-gmb-credential-file").modal('close');
                M.toast({
                    "html": "File Uploaded Successfully!"
                }, 2000);
                document.getElementById('gmb_api_credential_file_path').value = response["filename"]
            } else if (response["status"] == 300) {
                M.toast({
                    "html": "Unable to upload files. File format not supported. Please do not use .(dot) in filename except for extension."
                }, 2000);
            } else {
                M.toast({
                    "html": "Unable to upload the files!"
                }, 2000);
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            M.toast({
                "html": "Unable to upload the files! Please check your internet"
            }, 2000);
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);

        }
    });

}
if (window.location.pathname.indexOf("/chat/channels/google-buisness-messages") != -1) {
    var location_href = window.location.href;
    var location_href = location_href.replace("#", "");
    var location_href = location_href.replace("!", "");
    var bot_id = get_url_vars()['id'];
    var json_string = JSON.stringify({
        bot_id: bot_id
    })
    json_string = EncryptVariable(json_string);
    document.getElementById("easychat_google_my_buisness_channel_preloader").style.display = "block";
    $.ajax({
        url: "/chat/channels/google-buisness-messages/edit/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            document.getElementById("easychat_google_my_buisness_channel_preloader").style.display = "none";
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {

                failure_recommendation_list = response["failure_recommendations"]["items"]
                initial_message_list = response["initial_message"]["items"];



            } else {
                M.toast({
                    "html": "internal server error"
                }, 2000);
            }
        },
        error: function (error) {
            document.getElementById("easychat_google_my_buisness_channel_preloader").style.display = "none";
            M.toast({
                "html": "Report this  error"
            }, 2000);
        }
    });

    add_channel_language_selction_event("google-buisness-messages")
    add_language_dropdown_search_event()
    language_dropdown_close_onclicking_outside_event()
    language_search_dropdown_event()
    open_close_language_dropdown_event()
    $(document).ready(function () {
        create_language_custom_dropdowns();
    });
    $(document).on("click", "#ignore-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "GoogleBusinessMessages"
        ignore_changes_in_non_primary_languages(bot_id, channel_name)
    });
    $(document).on("click", "#auto-fix-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "GoogleBusinessMessages"
        auto_fix_changes_in_non_primary_languages(bot_id, channel_name)
    });

    $(document).on("click", "#save-google-buisness-messages-channel", function (e) {
        var location_href = window.location.href;
        var location_href = location_href.replace("#", "");
        var location_href = location_href.replace("!", "");
        var bot_id = get_url_vars()['id'];

        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var is_language_auto_detection_enabled = document.getElementById("is_language_auto_detection_enabled").checked
        var is_enable_choose_language_flow_enabled_for_welcome_response = document.getElementById("is_enable_choose_language_flow_enabled_for_welcome_response").checked

        selected_supported_languages = get_selected_languages_list()

        if ("en" in selected_supported_languages == false) {
            selected_supported_languages.push("en");
        }
        var gmb_agent_id = document.getElementById("gmb-agent-id").value;
        var gmb_brand_id = document.getElementById("gmb-brand-id").value;
        var client_access_token = document.getElementById("gbm-client-access-token").value;

        var gmb_display_name = document.getElementById("gmb-bot-display-name").value;;
        var gmb_display_image_url = document.getElementById("gmb_display_picture_url").value.trim();;
        var gmb_credentials_file_name = document.getElementById("gmb_api_credential_file_path").value;;
        var gmb_privacy_policy_url = document.getElementById("gmb-client-privacy-policy-url").value.trim();;



        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }
        if (gmb_agent_id.trim() == "") {
            M.toast({
                "html": "GBM Agent Id cannot be empty."
            }, 2000);
            return;
        }
        if (gmb_brand_id.trim() == "") {
            M.toast({
                "html": "GBM  Brand Id cannot be empty."
            }, 2000);
            return;
        }
        if (gmb_display_name == "") {
            M.toast({
                "html": "GBM  Bot display name cannot be empty"
            }, 2000);
            return;
        }
        if (gmb_privacy_policy_url == "") {
            M.toast({
                "html": "Privacy policy url cannot be empty."
            }, 2000);
            return;
        }
        var pattern = /^((http|https|ftp):\/\/)/;
        if (!pattern.test(gmb_privacy_policy_url)) {
            M.toast({
                "html": "Please enter valid privacy policy url."
            }, 2000);
            return;
        }

        if (gmb_credentials_file_name == "") {
            M.toast({
                "html": "Please upload GBM  API credentials file."
            }, 2000);
            return;
        }

        if (gmb_display_image_url.trim() == "") {
            M.toast({
                "html": "Please Upload GBM  display image "
            }, 2000);
            return;
        }
        if (!checkImageURL(gmb_display_image_url)) {
            M.toast({
                "html": "Please provide valid GMB display image url"
            }, 2000);
            return;
        }

        if (isValidURL(gmb_display_image_url) == false) {
            M.toast({
                "html": "Please provide valid GBM display image url"
            }, 2000);
            return;
        }

        initial_message_list = $("#multiple-select-google-buisness-messages-initial-message-list").val();

        failure_recommendation_list = $("#multiple-select-google-buisness-messages-failure-message-list").val();



        json_string = JSON.stringify({
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            authentication_message: authentication_message,
            initial_message_list: initial_message_list,
            gmb_agent_id: gmb_agent_id,
            gmb_brand_id: gmb_brand_id,
            gmb_display_name: gmb_display_name,
            gmb_display_image_url: gmb_display_image_url,
            gmb_privacy_policy_url: gmb_privacy_policy_url,
            failure_recommendation_list: failure_recommendation_list,
            client_access_token: client_access_token,
            selected_supported_languages: selected_supported_languages,
            is_enable_choose_language_flow_enabled_for_welcome_response: is_enable_choose_language_flow_enabled_for_welcome_response,
            is_language_auto_detection_enabled: is_language_auto_detection_enabled,
        });
        json_string = EncryptVariable(json_string);

        document.getElementById("easychat_google_my_buisness_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/channels/google-buisness-messages/save/",
            type: "POST",
            data: {
                json_string: json_string
            },
            headers: {
                "X-CSRFToken": get_csrf_token()
            },
            success: function (response) {
                //change id here
                document.getElementById("easychat_google_my_buisness_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else if (response["status"] == 402) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                    setTimeout(function() {
                        window.location.href = "/chat/home"
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                document.getElementById("easychat_google_my_buisness_channel_preloader").style.display = "none";
                M.toast({
                    "html": "Report this  error"
                }, 2000);
            }
        });
    });

    $("#language-box-options-container .option .item-checkbox").change(function () {

        enable_disable_auto_language_detection_toogle();
        enable_disable_welcome_message_language_change_toogle()

    });

    $(document).on("click", "#save-google-buisness-messages-channel-for-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let selected_language = get_url_vars()['selected_lang']

        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }
        channel_name = "GoogleBusinessMessages"

        json_string = {
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            channel_name: channel_name,
            selected_language: selected_language,
            authentication_message: authentication_message,
            save_auto_pop_up_text: false,
        }
        json_string = JSON.stringify(json_string);
        json_string = EncryptVariable(json_string);
        document.getElementById("easychat_google_my_buisness_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/save-channel-language-tuned-objects/",
            type: "POST",
            data: {
                json_string: json_string
            },
            success: function (response) {
                document.getElementById("easychat_google_my_buisness_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                document.getElementById("easychat_web_channel_preloader").style.display = "none";
                console.log("Report this error: ", error);
            },
        });
    });
}

if (window.location.pathname.indexOf("/chat/channels/alexa") != -1) {
    var location_href = window.location.href;
    var location_href = location_href.replace("#", "");
    var location_href = location_href.replace("!", "");
    var bot_id = get_url_vars()['id'];
    var json_string = JSON.stringify({
        bot_id: bot_id
    })
    json_string = EncryptVariable(json_string);
    document.getElementById("easychat_alexa_channel_preloader").style.display = "block";
    $.ajax({
        url: "/chat/channels/alexa/edit/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            document.getElementById("easychat_alexa_channel_preloader").style.display = "none";
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {

                failure_recommendation_list = response["failure_recommendations"]["items"]
                initial_message_list = response["initial_message"]["items"];
                images = response["initial_message"]["images"];
                videos = response["initial_message"]["videos"];

                if (images != undefined && images != null && images.length > 0) {
                    document.getElementById("uploaded-bot-welcome-image").src = images[0];
                    document.getElementById("uploaded-bot-welcome-image").style.display = "inline-block";
                    $("#remove-bot-welcome-image").show();
                }

                if (videos != undefined && videos != null && videos.length > 0) {
                    document.getElementById("upload-bot-welcome-video-url").value = videos[0];
                }

            } else {
                console.log("Internal server error.");
            }
        },
        error: function (error) {
            document.getElementById("easychat_alexa_channel_preloader").style.display = "none";
            console.log("Report this error: ", error)
        }
    });


    add_channel_language_selction_event("alexa")
    add_language_dropdown_search_event()
    language_dropdown_close_onclicking_outside_event()
    language_search_dropdown_event()
    open_close_language_dropdown_event()
    $(document).ready(function () {
        create_language_custom_dropdowns();
    });
    $(document).on("click", "#ignore-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "Alexa"
        ignore_changes_in_non_primary_languages(bot_id, channel_name)
    });
    $(document).on("click", "#auto-fix-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "Alexa"
        auto_fix_changes_in_non_primary_languages(bot_id, channel_name)
    });

    $(document).on("click", "#save-alexa-channel", function (e) {
        var location_href = window.location.href;
        var location_href = location_href.replace("#", "");
        var location_href = location_href.replace("!", "");
        var bot_id = location_href.split("?")[1].split("=")[1];
        // var welcome_message = $('#welcome-message').val();
        // var failure_message = $('#failure-message').val();
        // var authentication_message = $("#authentication-message").val();
        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var is_language_auto_detection_enabled = document.getElementById("is_language_auto_detection_enabled").checked
        var is_enable_choose_language_flow_enabled_for_welcome_response = document.getElementById("is_enable_choose_language_flow_enabled_for_welcome_response").checked

        selected_supported_languages = get_selected_languages_list()

        if ("en" in selected_supported_languages == false) {
            selected_supported_languages.push("en");
        }

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }

        initial_message_list = $("#multiple-select-alexa-initial-message-list").val();

        failure_recommendation_list = $("#multiple-select-alexa-failure-message-list").val();

        is_project_details_added = add_alexa_project_id("Alexa", false)
        if (!is_project_details_added) {
            return;
        }
        json_string = JSON.stringify({
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            authentication_message: authentication_message,
            initial_message_list: initial_message_list,
            image_url: "",
            video_url: "",
            failure_recommendation_list: failure_recommendation_list,
            selected_supported_languages: selected_supported_languages,
            is_enable_choose_language_flow_enabled_for_welcome_response: is_enable_choose_language_flow_enabled_for_welcome_response,
            is_language_auto_detection_enabled: is_language_auto_detection_enabled,
        });
        json_string = EncryptVariable(json_string);
        document.getElementById("easychat_alexa_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/channels/alexa/save/",
            type: "POST",
            data: {
                json_string: json_string
            },
            headers: {
                "X-CSRFToken": get_csrf_token()
            },
            success: function (response) {
                document.getElementById("easychat_alexa_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else if (response["status"] == 402) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                    setTimeout(function() {
                        window.location.href = "/chat/home"
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                document.getElementById("easychat_alexa_channel_preloader").style.display = "none";
                console.log("Report this error: ", error);
            }
        });
    });

    $("#language-box-options-container .option .item-checkbox").change(function () {

        enable_disable_auto_language_detection_toogle();
        enable_disable_welcome_message_language_change_toogle(true)

    });

    $(document).on("click", "#save-alexa-channel-for-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let selected_language = get_url_vars()['selected_lang']

        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }
        channel_name = "Alexa"

        json_string = {
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            channel_name: channel_name,
            selected_language: selected_language,
            authentication_message: authentication_message,
            save_auto_pop_up_text: false,
        }
        json_string = JSON.stringify(json_string);
        json_string = EncryptVariable(json_string);
        document.getElementById("easychat_alexa_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/save-channel-language-tuned-objects/",
            type: "POST",
            data: {
                json_string: json_string
            },
            success: function (response) {
                document.getElementById("easychat_alexa_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                document.getElementById("easychat_web_channel_preloader").style.display = "none";
                console.log("Report this error: ", error);
            },
        });
    });
}

if (window.location.pathname.indexOf("/chat/channels/facebook") != -1) {
    var location_href = window.location.href;
    var location_href = location_href.replace("#", "");
    var location_href = location_href.replace("!", "");
    var bot_id = get_url_vars()['id'];
    var json_string = JSON.stringify({
        bot_id: bot_id
    })

    json_string = EncryptVariable(json_string);
    document.getElementById("easychat_facebook_channel_preloader").style.display = "block";
    $.ajax({
        url: "/chat/channels/facebook/edit/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            document.getElementById("easychat_facebook_channel_preloader").style.display = "none";
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {

                failure_recommendation_list = response["failure_recommendations"]["items"]
                initial_message_list = response["initial_message"]["items"];
                images = response["initial_message"]["images"];
                videos = response["initial_message"]["videos"];

                if (images != undefined && images != null && images.length > 0) {
                    document.getElementById("uploaded-bot-welcome-image").src = images[0];
                    document.getElementById("uploaded-bot-welcome-image").style.display = "inline-block";
                    $("#remove-bot-welcome-image").show();
                }

                if (videos != undefined && videos != null && videos.length > 0) {
                    document.getElementById("upload-bot-welcome-video-url").value = videos[0];
                }

            } else {
                console.log("Internal server error.");
            }
        },
        error: function (error) {
            document.getElementById("easychat_facebook_channel_preloader").style.display = "none";
            console.log("Report this error: ", error)
        }
    });

    add_channel_language_selction_event("facebook")
    add_language_dropdown_search_event()
    language_dropdown_close_onclicking_outside_event()
    language_search_dropdown_event()
    open_close_language_dropdown_event()
    $(document).ready(function () {
        create_language_custom_dropdowns();
    });
    $(document).on("click", "#ignore-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "Facebook"
        ignore_changes_in_non_primary_languages(bot_id, channel_name)
    });
    $(document).on("click", "#auto-fix-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "Facebook"
        auto_fix_changes_in_non_primary_languages(bot_id, channel_name)
    });

    $(document).on("click", "#save-facebook-channel", function (e) {
        var location_href = window.location.href;
        var location_href = location_href.replace("#", "");
        var location_href = location_href.replace("!", "");
        var bot_id = location_href.split("?")[1].split("=")[1];
        // var welcome_message = $('#welcome-message').val();
        // var failure_message = $('#failure-message').val();
        // var authentication_message = $("#authentication-message").val();
        var welcome_message = $("#welcome-message").trumbowyg('html')
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var is_language_auto_detection_enabled = document.getElementById("is_language_auto_detection_enabled").checked
        var is_enable_choose_language_flow_enabled_for_welcome_response = document.getElementById("is_enable_choose_language_flow_enabled_for_welcome_response").checked

        selected_supported_languages = get_selected_languages_list()

        if ("en" in selected_supported_languages == false) {
            selected_supported_languages.push("en");
        }

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }

        initial_message_list = $("#multiple-select-facebook-initial-message-list").val();

        failure_recommendation_list = $("#multiple-select-facebook-failure-message-list").val();

        verification_code = document.getElementById("facebook_verification_code").value;
        if (verification_code == '') {
            M.toast({
                "html": "Verification Code cannot be empty!"
            }, 2000);
            return;
        }

        page_access_token = document.getElementById("facebook_page_access_token").value;
        if (page_access_token == '') {
            M.toast({
                "html": "Page Access Token cannot be empty!"
            }, 2000);
            return;
        }

        image_id = document.getElementById("uploaded-bot-welcome-image");
        image_url = image_id.getAttribute("src");
        video_url = document.getElementById("upload-bot-welcome-video-url").value.trim();

        if (isValidURL(video_url) == false && video_url != "") {
            M.toast({
                "html": "Please enter valid video url"
            }, 2000);
            return;
        }

        json_string = JSON.stringify({
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            authentication_message: authentication_message,
            initial_message_list: initial_message_list,
            image_url: image_url,
            video_url: video_url,
            failure_recommendation_list: failure_recommendation_list,
            verification_code: verification_code,
            page_access_token: page_access_token,
            selected_supported_languages: selected_supported_languages,
            is_enable_choose_language_flow_enabled_for_welcome_response: is_enable_choose_language_flow_enabled_for_welcome_response,
            is_language_auto_detection_enabled: is_language_auto_detection_enabled,
        });
        json_string = EncryptVariable(json_string)
        document.getElementById("easychat_facebook_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/channels/facebook/save/",
            type: "POST",
            data: {
                json_string: json_string
            },
            headers: {
                "X-CSRFToken": get_csrf_token()
            },
            success: function (response) {
                document.getElementById("easychat_facebook_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else if (response["status"] == 402) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                    setTimeout(function() {
                        window.location.href = "/chat/home"
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                document.getElementById("easychat_facebook_channel_preloader").style.display = "none";
                console.log("Report this error: ", error);
            }
        });
    });

    $("#language-box-options-container .option .item-checkbox").change(function () {

        enable_disable_auto_language_detection_toogle();
        enable_disable_welcome_message_language_change_toogle()

    });

    $(document).on("click", "#save-facebook-channel-for-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let selected_language = get_url_vars()['selected_lang']

        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }
        channel_name = "Facebook"

        json_string = {
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            channel_name: channel_name,
            selected_language: selected_language,
            authentication_message: authentication_message,
            save_auto_pop_up_text: false,
        }
        json_string = JSON.stringify(json_string);
        json_string = EncryptVariable(json_string);
        document.getElementById("easychat_facebook_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/save-channel-language-tuned-objects/",
            type: "POST",
            data: {
                json_string: json_string
            },
            success: function (response) {
                document.getElementById("easychat_facebook_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                document.getElementById("easychat_web_channel_preloader").style.display = "none";
                console.log("Report this error: ", error);
            },
        });
    });
}

if (window.location.pathname.indexOf("/chat/channels/instagram") != -1) {
    add_channel_language_selction_event("instagram")
    add_language_dropdown_search_event()
    language_dropdown_close_onclicking_outside_event()
    language_search_dropdown_event()
    open_close_language_dropdown_event()
    $(document).ready(function () {
        create_language_custom_dropdowns();
    });
    $(document).on("click", "#ignore-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "Instagram"
        ignore_changes_in_non_primary_languages(bot_id, channel_name)
    });
    $(document).on("click", "#auto-fix-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "Instagram"
        auto_fix_changes_in_non_primary_languages(bot_id, channel_name)
    });
    $(document).on("click", "#save-instagram-channel", function (e) {
        var location_href = window.location.href;
        var location_href = location_href.replace("#", "");
        var location_href = location_href.replace("!", "");
        var bot_id = get_url_vars()['id'];

        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var is_language_auto_detection_enabled = document.getElementById("is_language_auto_detection_enabled").checked
        var is_enable_choose_language_flow_enabled_for_welcome_response = document.getElementById("is_enable_choose_language_flow_enabled_for_welcome_response").checked

        selected_supported_languages = get_selected_languages_list()

        if ("en" in selected_supported_languages == false) {
            selected_supported_languages.push("en");
        }

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }

        failure_recommendation_list = $("#multiple-select-instagram-failure-message-list").val();

        verification_code = document.getElementById("instagram_verification_code").value;
        if (verification_code == '') {
            M.toast({
                "html": "Verification Code cannot be empty!"
            }, 2000);
            return;
        }

        page_access_token = document.getElementById("instagram_page_access_token").value;
        if (page_access_token == '') {
            M.toast({
                "html": "Page Access Token cannot be empty!"
            }, 2000);
            return;
        }

        let image_id = document.getElementById("uploaded-bot-welcome-image");
        let image_url = image_id.getAttribute("src");
        let video_url = document.getElementById("upload-bot-welcome-video-url").value.trim();

        var selected_supported_languages = get_selected_languages_list()
        if (!selected_supported_languages.includes("en")) {
            selected_supported_languages.push("en");
        }

        if (isValidURL(video_url) == false && video_url != "") {
            M.toast({
                "html": "Please enter valid video url"
            }, 2000);
            return;
        }

        json_string = JSON.stringify({
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            authentication_message: authentication_message,
            image_url: image_url,
            video_url: video_url,
            failure_recommendation_list: failure_recommendation_list,
            selected_supported_languages: selected_supported_languages,
            verification_code: verification_code,
            page_access_token: page_access_token,
            selected_supported_languages: selected_supported_languages,
            is_enable_choose_language_flow_enabled_for_welcome_response: is_enable_choose_language_flow_enabled_for_welcome_response,
            is_language_auto_detection_enabled: is_language_auto_detection_enabled,
        });
        json_string = EncryptVariable(json_string)
        $.ajax({
            url: "/chat/channels/instagram/save/",
            type: "POST",
            data: {
                json_string: json_string
            },
            headers: {
                "X-CSRFToken": get_csrf_token()
            },
            success: function (response) {
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else if (response["status"] == 402) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                    setTimeout(function() {
                        window.location.href = "/chat/home"
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                console.log("Report this error: ", error);
            }
        });
    });

    $("#language-box-options-container .option .item-checkbox").change(function () {

        enable_disable_auto_language_detection_toogle();
        enable_disable_welcome_message_language_change_toogle()

    });

    $(document).on("click", "#save-instagram-channel-for-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let selected_language = get_url_vars()['selected_lang']

        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }
        channel_name = "Instagram"

        json_string = {
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            channel_name: channel_name,
            selected_language: selected_language,
            authentication_message: authentication_message,
            save_auto_pop_up_text: false,
        }
        json_string = JSON.stringify(json_string);
        json_string = EncryptVariable(json_string);
        document.getElementById("easychat_instagram_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/save-channel-language-tuned-objects/",
            type: "POST",
            data: {
                json_string: json_string
            },
            success: function (response) {
                document.getElementById("easychat_instagram_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                document.getElementById("easychat_web_channel_preloader").style.display = "none";
                console.log("Report this error: ", error);
            },
        });
    });
}

if (window.location.pathname.indexOf("/chat/channels/google-rcs") != -1) {
    add_channel_language_selction_event("telegram")
    add_language_dropdown_search_event()
    language_dropdown_close_onclicking_outside_event()
    language_search_dropdown_event()
    open_close_language_dropdown_event()
    $(document).ready(function () {
        create_language_custom_dropdowns();
    });
    $(document).on("click", "#ignore-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "Telegram"
        ignore_changes_in_non_primary_languages(bot_id, channel_name)
    });
    $(document).on("click", "#auto-fix-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "Telegram"
        auto_fix_changes_in_non_primary_languages(bot_id, channel_name)
    });

    $(document).on("click", "#save-google-rcs-channel", function (e) {
        var location_href = window.location.href;
        var location_href = location_href.replace("#", "");
        var location_href = location_href.replace("!", "");
        var bot_id = get_url_vars()['id'];

        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var is_language_auto_detection_enabled = document.getElementById("is_language_auto_detection_enabled").checked
        var is_enable_choose_language_flow_enabled_for_welcome_response = document.getElementById("is_enable_choose_language_flow_enabled_for_welcome_response").checked

        selected_supported_languages = get_selected_languages_list()

        if ("en" in selected_supported_languages == false) {
            selected_supported_languages.push("en");
        }
        var rcs_credentials_file_name = document.getElementById("rcs_api_credential_file_path").value;

        failure_recommendation_list = $("#multiple-select-google-rcs-failure-message-list").val();

        if (rcs_credentials_file_name == '') {
            M.toast({
                "html": "Please upload RCS Agent API credentials file."
            }, 2000);
            return;
        }

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }

        json_string = JSON.stringify({
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            authentication_message: authentication_message,
            failure_recommendation_list: failure_recommendation_list,
            selected_supported_languages: selected_supported_languages,
            is_enable_choose_language_flow_enabled_for_welcome_response: is_enable_choose_language_flow_enabled_for_welcome_response,
            is_language_auto_detection_enabled: is_language_auto_detection_enabled,
        });
        json_string = EncryptVariable(json_string)
        $.ajax({
            url: "/chat/channels/google_rcs/save/",
            type: "POST",
            data: {
                json_string: json_string
            },
            headers: {
                "X-CSRFToken": get_csrf_token()
            },
            success: function (response) {
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else if (response["status"] == 402) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                    setTimeout(function() {
                        window.location.href = "/chat/home"
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                console.log("Report this error: ", error);
            }
        });
    });

    $("#language-box-options-container .option .item-checkbox").change(function () {

        enable_disable_auto_language_detection_toogle();
        enable_disable_welcome_message_language_change_toogle()

    });

    $(document).on("click", "#save-google-rcs-channel-for-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let selected_language = get_url_vars()['selected_lang']

        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }
        channel_name = "GoogleRCS"

        json_string = {
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            channel_name: channel_name,
            selected_language: selected_language,
            authentication_message: authentication_message,
            save_auto_pop_up_text: false,
        }
        json_string = JSON.stringify(json_string);
        json_string = EncryptVariable(json_string);
        document.getElementById("easychat_google-rcs_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/save-channel-language-tuned-objects/",
            type: "POST",
            data: {
                json_string: json_string
            },
            success: function (response) {
                document.getElementById("easychat_google-rcs_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                document.getElementById("easychat_web_channel_preloader").style.display = "none";
                console.log("Report this error: ", error);
            },
        });
    });
}

// ******************** Failure Recommendations **********************

var channel_failure_rec_count = 0;

// detect enter keypress
$("#add_enter_channel_failure_recommendation").keypress(function (e) {
    var keycode = (e.keyCode ? e.keyCode : e.which);
    if (keycode == '13') {
        value = $("#add_enter_channel_failure_recommendation").val();
        addChannelFailureRecommendationsIntoCollection(value);
        $("#add_enter_channel_failure_recommendation").val("");
    }
});

function addChannelFailureRecommendationsIntoCollection(sentence) {

    var id = "channel_" + channel_failure_rec_count.toString();
    var str_id = "channelstr_" + channel_failure_rec_count.toString();

    var html = `<li class="collection-item" id="` + id + `">
      <div class="row">
        <input id="failure_rec_` + str_id + `" type="text" data-length="100" value="` + sentence + `" style="width: 80%">
        <label for="failure_rec_` + str_id + `"></label>
        <div class="secondary-content">
        <a href="" class="delete-button-channel-failure-rec" id="` + id + `">
          <i class="inline-icon material-icons red-text text-darken-3">delete</i>
        </a>
        </div>
      </div>
    </li>`;

    $(html).appendTo($("#channel-failure-recommendation-collection"));
    channel_failure_rec_count += 1;
}

// Remove element with element id with click
$(document).on("click", ".delete-button-channel-failure-rec", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();
});

// ******************************************************************

var channel_init_message_count = 0;

// detect enter keypress
$("#add_enter_channel_initial_message").keypress(function (e) {
    var keycode = (e.keyCode ? e.keyCode : e.which);
    if (keycode == '13') {
        value = $("#add_enter_channel_initial_message").val();
        addChannelInitialMessageIntoCollection(value);
        $("#add_enter_channel_initial_message").val("");
    }
});

function addChannelInitialMessageIntoCollection(sentence) {

    var id = "channel_" + channel_init_message_count.toString();
    var str_id = "channelstr_" + channel_init_message_count.toString();

    var html = `<li class="collection-item" id="` + id + `">
      <div class="row">
        <input id="initial_message_` + str_id + `" type="text" data-length="100" value="` + sentence + `" style="width: 80%">
        <label for="initial_message_` + str_id + `"></label>
        <div class="secondary-content">
        <a href="" class="delete-button-channel-initial-message" id="` + id + `">
          <i class="inline-icon material-icons red-text text-darken-3>delete</i>
        </a>
        </div>
      </div>
    </li>`;

    $(html).appendTo($("#channel-initial-message-collection"));
    channel_init_message_count += 1;
}

// Remove element with element id with click
$(document).on("click", ".delete-button-channel-initial-message", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();
});


$(document).on("click", "#agree-create-new-bot", function (e) {
    var bot_name = $("#new_bot_name").val();
    if (bot_name == "") {

        document.getElementById("new_bot_error_div").innerHTML = "Bot Name cannot be empty"
        return;
    }
    if (bot_name.trim() == "") {

        document.getElementById("new_bot_error_div").innerHTML = "Bot Name cannot be empty"
        return;
    }
    if (bot_name.length > 18) {
        M.toast({
            "html": "Max characters allowed - 18"
        }, 2000);
        return;
    }

    var format = /[`@#$%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;
    if (format.test(bot_name.trim())) {

        document.getElementById("new_bot_error_div").innerHTML = "Invalid Bot Name(Only alphabets, 0-9, ?, !, & are allowed)"
        return;
    }

    let check_special_character_string = bot_name.trim().replace(/[&\/\\#,+()$~%.'":*?<>{}!@ ]/g, '');

    let check_emoji_only_string = check_special_character_string.replace(/^(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|[\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|[\ud83c[\ude32-\ude3a]|[\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])+$/, '');
    if (check_emoji_only_string == '') {
        document.getElementById("new_bot_error_div").innerHTML = "Bot name should have atleast one alphanumeric character."
        return;
    }
    var json_string = JSON.stringify({
        bot_name: bot_name.trim()
    })

    json_string = EncryptVariable(json_string);
    M.toast({
        "html": "Creating bot please wait"
    }, 1000);

    document.getElementById("new_bot_error_div").innerHTML = "";
    document.getElementById("new_bot_name").value = "";
    $("#new-bot").modal("close");
    document.getElementById("preloader_create_new_bot_div").style.display = "block";
    $.ajax({
        url: "/chat/bot/create/",
        type: "POST",
        headers: {
            'X-CSRFToken': get_csrf_token(),
        },
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            document.getElementById("preloader_create_new_bot_div").style.display = "none";
            if (response["status"] == 200) {
                window.location.reload();
            } else if (response["status"] == 300) {
                M.toast({
                    "html": "You have reached the limit for number of bots that you can create."
                }, 2000);
            } else if (response["status"] == 302) {
                M.toast({
                    "html": "Please enter a valid bot name."
                }, 2000);
            }else if (response['status'] == 400) {
                setTimeout(function (e) {
                    M.toast({
                        "html": "Bot with same name already exists. Please choose different name"
                    }, 3000);
                }, 5000);
            } else if (response["status"] == 401) {
                M.toast({
                    "html": "You have permission to create only one bot."
                }, 2000);
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                });
            }
        },
        error: function (error) {
            document.getElementById("preloader_create_new_bot_div").style.display = "none";
            console.log("Report this error: ", error);
        }
    });

});

$(document).on("click", ".btn-delete-bot", function (e) {
    bot_id = this.id.split("-")[3];
    var json_string = JSON.stringify({
        bot_id: bot_id
    })
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/bot/delete/",
        type: "POST",
        headers: {
            "X-CSRFToken": get_csrf_token()
        },
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                if(get_all_bots_data.no_of_bots === 1){
                    window.location.reload();
                }else{
                    document.getElementById("deleted_bot_toast_container").style.display = "flex"
                    setTimeout(() => {
                        document.getElementById("deleted_bot_toast_container").style.display = "none"
                    }, 5000);
                    get_all_bots_list()
                }
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
            if (error.status == 403) {
                window.location.href = "/chat/login"
            }
        }
    });
});


function showChildBotSelection() {
    $("#div-child-bot-section").show();
}

function hideChildBotSelection() {
    $("#div-child-bot-section").hide();
}

// if(window.location.pathname.indexOf("/chat/bot/edit")!=-1)
// {
//   $(window).bind("load", function(e){

//     $('.chips').chips();

//     var bot_type = $("#input-bot-type").val();
//     if(bot_type=="Composite"){
//       showChildBotSelection();
//     }else{
//       hideChildBotSelection();
//     }

//     var trigger_keyword = $("#input-chips-trigger-keywords").val();
//     var stop_keyword = $("#input-chips-stop-keywords").val();

//     if(trigger_keyword!=""){
//       var trigger_keyword = JSON.parse(trigger_keyword);
//       $("#bot-trigger-keywords-chips").chips({data:trigger_keyword});
//     }

//     if(stop_keyword!=""){
//       var stop_keyword = JSON.parse(stop_keyword);
//       $("#bot-stop-keywords-chips").chips({data:stop_keyword});
//     }

//   });

// }

$(document).on("change", ".radio-button-bot-type", function (e) {
    var bot_type = this.id.split("-")[4];
    if (bot_type == "Composite") {
        showChildBotSelection();
    } else {
        hideChildBotSelection();
    }
    $("#input-bot-type").val(bot_type);
});

function save_bot_inactivity_settings() {
    $("#save-bot-general-settings-btn").click()
}

function save_bot_response_delay_settings() {
    $("#save-bot-general-settings-btn").click()
}

function validate_ck_editor_response(str) {

    str = str.replaceAll("&nbsp;", "");
    str = str.replaceAll("<p>", "");
    str = str.replaceAll("</p>", "");
    str = str.replaceAll("<br>", "");
    str = str.replaceAll("<br />", "");
    str = str.replaceAll("&bull;", "");

    str = str.trim();
    return str;
}
function auto_grow_textarea(element) {
    element.style.height = "8px";
    element.style.height = (element.scrollHeight) + "px";
}
function save_multilingual_bot_general_settings(element) {

    bot_id = window.location.pathname.split("/")[4];

    bot_inactivity_detection_enabled = false
    if (document.getElementById("checkbox-bot-inactivity-enabled") != null && document.getElementById("checkbox-bot-inactivity-enabled") != undefined) {
        bot_inactivity_detection_enabled = document.getElementById("checkbox-bot-inactivity-enabled").checked;
    }

    bot_inactivity_msg = ""

    if (bot_inactivity_detection_enabled) {
        bot_inactivity_msg = document.getElementById("bot-inactivity-msg").value.trim()
        if (bot_inactivity_msg.trim() == "") {
            M.toast({
                "html": "Bot inactivity message cannot be empty."
            }, 2000);
            return;
        }

    }

    flow_termination_bot_response = $("#flow_termination_bot_response").trumbowyg('html');

    flow_termination_confirmation_display_message = $("#flow_termination_confirmation_display_message").trumbowyg('html');

    flow_termination_confirmation_filtered_text = validate_ck_editor_response(flow_termination_confirmation_display_message)

    filtered_text = validate_ck_editor_response(flow_termination_bot_response);


    if (is_flow_termination_bot_response_required && filtered_text.length == 0) {
        M.toast({
            "html": "Flow termination bot response cannot be empty."
        }, 2000);
        return;
    }

    if (flow_termination_confirmation_filtered_text.length == 0) {

        M.toast({
            "html": "Flow termination confirmation display message cannot be empty."
        }, 2000);
        return;
    }

    //---- Emoji modal values ----
    angry_emoji_response = $("#angry-emoji-response").trumbowyg('html');
    happy_emoji_response = $("#happy-emoji-response").trumbowyg('html');
    neutral_emoji_response = $("#neutral-emoji-response").trumbowyg('html');
    sad_emoji_response = $("#sad-emoji-response").trumbowyg('html');

    if (!check_emoji_response()) {
        return;
    }

    //---- Emoji modal values end----

    profanity_response_text = $("#profanity-word-bot-response").trumbowyg('html');

    console.log(is_livechat_profanity_words_enabled)
    if (is_livechat_enabled && is_livechat_profanity_words_enabled.toLowerCase().trim() == "true") {
        if (!check_profanity_model_settings()) {
            return;
        }
    }

    bot_response_delay_allowed = document.getElementById("checkbox-bot-response-delay-enabled").checked;
    bot_response_delay_message = ""

    if (bot_response_delay_allowed) {

        bot_response_delay_message = document.getElementById("bot-response-delay-msg").value;

        if (bot_response_delay_message.trim() == "") {
            M.toast({
                "html": "Delay message cannot be empty"
            }, 2000);
            return;
        }


    }

    let selected_language = get_url_vars()['selected_language']
    if (selected_language == "" || selected_language == undefined || selected_language == null) {
        selected_language = "en";
    }

    json_string = JSON.stringify({
        "bot_id": bot_id,
        "selected_language": selected_language,
        "is_flow_termination_bot_response_required": is_flow_termination_bot_response_required,
        "flow_termination_bot_response": flow_termination_bot_response,
        "bot_inactivity_detection_enabled": bot_inactivity_detection_enabled,
        "bot_inactivity_msg": bot_inactivity_msg,
        "bot_response_delay_allowed": bot_response_delay_allowed,
        "bot_response_delay_message": bot_response_delay_message,
        "flow_termination_confirmation_display_message": flow_termination_confirmation_display_message,
        "angry_emoji_response": angry_emoji_response,
        "happy_emoji_response": happy_emoji_response,
        "neutral_emoji_response": neutral_emoji_response,
        "sad_emoji_response": sad_emoji_response,
        "is_suggest_livechat_for_profanity_words_enabled": is_livechat_profanity_words_enabled,
        "profanity_response_text": profanity_response_text
    });

    json_string = EncryptVariable(json_string);

    element.innerHTML = "saving...";
    $.ajax({
        url: "/chat/bot/save-mulitlingual-bot/",
        type: "POST",
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Changes saved successfully!"
                })
                setTimeout(function () {
                    window.location = set_url_parameter("selected_language", "en")
                }, 3000);
            } else if (response['status'] == 400) {
                setTimeout(function (e) {
                    M.toast({
                        "html": "Bot with same name already exists. Please choose different name"
                    }, 3000);
                }, 5000);
            } else if (response['status'] == 300) {
                setTimeout(function () {
                    M.toast({
                        "html": response["msg"]
                    })
                }, 1000);
            } else {
                M.toast({
                    "html": "Please check if inputs are valid."
                })
            }
            element.innerHTML = "<svg width='16'\
                            height='16' viewBox='0 0 16 16' fill='none'\
                            xmlns='http://www.w3.org/2000/svg'><path d='M9.33334 1.33325V4.50158C9.33334 4.58048 9.27851 4.64657 9.20488 4.66384L9.16667 4.66825H5.16667C5.08777 4.66825 5.02168 4.61342 5.0044 4.53979L5 4.50158V1.33325H9.33334ZM11.5058 9.36C11.5979 9.36 11.6725 9.43461 11.6725 9.52666L11.672 14.3333H4.33267L4.33334 9.52666C4.33334 9.43461 4.40796 9.36 4.5 9.36H11.5058ZM10.4244 1.33325C10.6082 1.33325 10.786 1.39401 10.9307 1.50469L14.4333 4.49992C14.5978 4.65714 14.6667 4.8785 14.6667 5.10606V12.8333C14.6667 13.6617 13.9951 14.3333 13.1667 14.3333H12.672L12.6725 9.52666C12.6725 8.88233 12.1502 8.36 11.5058 8.36H4.5C3.85567 8.36 3.33334 8.88233 3.33334 9.52666L3.33267 14.3333H2.83334C2.00491 14.3333 1.33334 13.6617 1.33334 12.8333V2.83325C1.33334 2.00482 2.00491 1.33325 2.83334 1.33325H4V4.50158C4 5.1137 4.47141 5.61571 5.07098 5.66438L5.16667 5.66825H9.16667C9.77879 5.66825 10.2808 5.19684 10.3295 4.59726L10.3333 4.50158V1.33325H10.4244Z'\
                                fill='#fff' />\
                        </svg>\
                        &nbsp;Save";;
        },
        error: function (error) {
            element.innerHTML = "<svg width='16'\
                            height='16' viewBox='0 0 16 16' fill='none'\
                            xmlns='http://www.w3.org/2000/svg'><path d='M9.33334 1.33325V4.50158C9.33334 4.58048 9.27851 4.64657 9.20488 4.66384L9.16667 4.66825H5.16667C5.08777 4.66825 5.02168 4.61342 5.0044 4.53979L5 4.50158V1.33325H9.33334ZM11.5058 9.36C11.5979 9.36 11.6725 9.43461 11.6725 9.52666L11.672 14.3333H4.33267L4.33334 9.52666C4.33334 9.43461 4.40796 9.36 4.5 9.36H11.5058ZM10.4244 1.33325C10.6082 1.33325 10.786 1.39401 10.9307 1.50469L14.4333 4.49992C14.5978 4.65714 14.6667 4.8785 14.6667 5.10606V12.8333C14.6667 13.6617 13.9951 14.3333 13.1667 14.3333H12.672L12.6725 9.52666C12.6725 8.88233 12.1502 8.36 11.5058 8.36H4.5C3.85567 8.36 3.33334 8.88233 3.33334 9.52666L3.33267 14.3333H2.83334C2.00491 14.3333 1.33334 13.6617 1.33334 12.8333V2.83325C1.33334 2.00482 2.00491 1.33325 2.83334 1.33325H4V4.50158C4 5.1137 4.47141 5.61571 5.07098 5.66438L5.16667 5.66825H9.16667C9.77879 5.66825 10.2808 5.19684 10.3295 4.59726L10.3333 4.50158V1.33325H10.4244Z'\
                                fill='#fff' />\
                        </svg>\
                        &nbsp;Save";;
            console.log("Report this error: ", error);
        }
    });
}

function save_bot_general_settings(element) {

    bot_id = window.location.pathname.split("/")[4];

    is_api_fail_email_notifiication_enabled = document.getElementById("checkbox-is-api-fail-email-notifiication-enabled").checked

    if (is_api_fail_email_notifiication_enabled) {
        if (check_api_config()) {
            return;
        }
    }

    is_bot_break_email_notification_enabled = document.getElementById("checkbox-is-email-bot-break-enable").checked

    if (is_bot_break_email_notification_enabled) {
        
        bot_break_api_config = get_bot_break_api_config()
        if (bot_break_api_config.is_invalid_bot_break_params) {
            return;
        }

    }

    bot_name = $("#bot_name_field").val();
    if (bot_name == "") {
        M.toast({
            "html": "Bot Name cannot be empty!"
        }, 2000);
        return;
    }
    if (bot_name.trim() == "") {
        M.toast({
            "html": "Bot Name cannot be empty!"
        }, 2000);
        return;
    }
    if (bot_name.length > 18) {
        M.toast({
            "html": "Max characters allowed - 18"
        }, 2000);
        return;
    }

    var format = /[`@#$%^*()_+\-=\[\]{};':"\\|,.<>\/~]/;
    if (format.test(bot_name.trim())) {
        M.toast({
            "html": "Invalid Bot Name(Only alphabets, 0-9, ?, !, & are allowed)"
        }, 2000);
        return;
    }

    let check_special_character_string = bot_name.trim().replace(/[&\/\\#,+()$~%.'":*?<>{}!@ ]/g, '');

    let check_emoji_only_string = check_special_character_string.replace(/^(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|[\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|[\ud83c[\ude32-\ude3a]|[\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])+$/, '');
    if (check_emoji_only_string == '') {
        M.toast({
            "html": "Bot name should have atleast one alphanumeric character."
        }, 2000);
        return;
    }
    go_live_date = $("#easychat-go-live-date").val();

    if (go_live_date == "") {

        M.toast({
            "html": "Go live date cannot be empty."
        }, 2000);
        return;
    }
    go_live_date_component = go_live_date.split('-');
    min_live_date_component = $("#easychat-go-live-date").attr("min").split("-");
    min_live_date = $("#easychat-go-live-date").attr("min");

    go_live_date_type_date = Date.parse(go_live_date);
    min_live_date_type_date = Date.parse(min_live_date);

    if (go_live_date_type_date < min_live_date_type_date) {
        alert("Go live date cannot be less then bot creation date");
        return;
    }

    mask_confidential_info = document.getElementById("checkbox-mask-confidential-info").checked;

    is_text_to_speech_required = document.getElementById("is-text-to-speech-required").checked;

    is_easyassist_enabled = false;
    if (document.getElementById("easychat-checkbox-easyassist-enable") != null && document.getElementById("easychat-checkbox-easyassist-enable") != undefined) {
        is_easyassist_enabled = document.getElementById("easychat-checkbox-easyassist-enable").checked;
    }
    is_synonyms_incuded_var_gen = false;
    if (document.getElementById("checkbox-synonyms-included-variation-generation") != null && document.getElementById("checkbox-synonyms-included-variation-generation") != undefined) {
        is_synonyms_incuded_var_gen = document.getElementById("checkbox-synonyms-included-variation-generation").checked;
    }
    is_email_notifiication_enabled = false;
    if (document.getElementById("checkbox-is-email-notifiication-enabled") != null && document.getElementById("checkbox-is-email-notifiication-enabled") != undefined) {
        is_email_notifiication_enabled = document.getElementById("checkbox-is-email-notifiication-enabled").checked;
    }

    var is_livechat_enabled = false;
    var livechat_provider = "cogno_livechat";
    if (document.getElementById("easychat-checkbox-livechat-enable") != null && document.getElementById("easychat-checkbox-livechat-enable") != undefined) {
        is_livechat_enabled = document.getElementById("easychat-checkbox-livechat-enable").checked;
        livechat_provider = document.getElementById("livechat-provider-select").value;
    }

    var emoji_livechat_checkbox_value_list = []

    if (is_livechat_enabled == false) {
        document.getElementById("angry-emoji-response-livechat").checked = true
        document.getElementById("happy-emoji-response-livechat").checked = false
        document.getElementById("neutral-emoji-response-livechat").checked = false
        document.getElementById("sad-emoji-response-livechat").checked = true
    }

    emoji_livechat_checkbox_value_list = set_livechat_checkbox_value_list()
    is_trigger_livechat_enabled = false;
    if (document.getElementById("autosuggest-livechat-complex-queries") != null && document.getElementById("autosuggest-livechat-complex-queries") != undefined) {
        is_trigger_livechat_enabled = document.getElementById("autosuggest-livechat-complex-queries").checked;
    }
    var autosuggest_livechat_word_limit = ""
    if (IS_LIVECHAT_MANAGER && IS_LIVECHAT_MANAGER.trim().toLowerCase() == "true") {
        autosuggest_livechat_word_limit = document.getElementById("autosuggest-livechat-word-limit").value;
        if (is_trigger_livechat_enabled && (autosuggest_livechat_word_limit == "" || parseInt(autosuggest_livechat_word_limit) < 0 || parseInt(autosuggest_livechat_word_limit) > 500)) {
            autosuggest_livechat_word_limit = 30;
        }
    }

    is_easysearch_enabled = false;
    if (document.getElementById("easychat-checkbox-easysearch-enable") != null && document.getElementById("easychat-checkbox-easysearch-enable") != undefined) {
        is_easysearch_enabled = document.getElementById("easychat-checkbox-easysearch-enable").checked;
    }
    is_pdfsearch_enabled = false;
    if (document.getElementById("easychat-checkbox-pdfsearch-enable") != null && document.getElementById("easychat-checkbox-pdfsearch-enable") != undefined) {
        is_pdfsearch_enabled = document.getElementById("easychat-checkbox-pdfsearch-enable").checked;
    }

    is_easytms_enabled = false;
    tms_drop_down_cat_list = [];
    if (document.getElementById("easychat-checkbox-easytms-enable") != null && document.getElementById("easychat-checkbox-easytms-enable") != undefined) {
        is_easytms_enabled = document.getElementById("easychat-checkbox-easytms-enable").checked;

        if (is_easytms_enabled) {
            var inputs = document.getElementsByTagName("input");
            if (check_for_duplicates_in_tms_cat("Duplicate entries found in TMS categories.")) {
                return;
            }
            for (var i = 0; i < inputs.length; i++) {
                if (inputs[i].id.indexOf('tms_drop_down_data_str') == 0) {
                    data_id = "#" + inputs[i].id;
                    dropdown_choices = $(data_id).val();
                    if (dropdown_choices != "") {
                        tms_drop_down_cat_list.push(dropdown_choices);
                    }
                }
            }
            if (tms_drop_down_cat_list.length == 0) {
                M.toast({
                    "html": "At least one choice in TMS Dropdown Category is required."
                }, 2000);
                return;
            }
        }
    }

    bot_inactivity_detection_enabled = false
    if (document.getElementById("checkbox-bot-inactivity-enabled") != null && document.getElementById("checkbox-bot-inactivity-enabled") != undefined) {
        bot_inactivity_detection_enabled = document.getElementById("checkbox-bot-inactivity-enabled").checked;
    }
    bot_inactivity_msg = document.getElementById("bot-inactivity-msg").value.trim()
    bot_inactivity_time = document.getElementById("bot-inactivity-time").value


    if (bot_inactivity_detection_enabled) {
        let isnum = /^\d+$/.test(bot_inactivity_time.trim());
        if (!isnum) {
            M.toast({
                "html": "Invalid time input."
            }, 2000);
            return;
        }

        if (bot_inactivity_time.trim() == "" || parseInt(bot_inactivity_time.trim()) < 1) {
            M.toast({
                "html": "Time value must be greater than or equal to 1."
            }, 2000);
            return;
        }

        if (bot_inactivity_msg.trim() == "") {
            M.toast({
                "html": "Bot inactivity message cannot be empty."
            }, 2000);
            return;
        }

    }

    $("#modal-bot-inactivity-config").modal("close")

    bot_userid_cookie_timeout = document.getElementById("easychat-userid-timeout").value
    if (bot_userid_cookie_timeout < 0 || bot_userid_cookie_timeout == "") {
        M.toast({
            "html": "Time interval for session expiration cannot be negative or blank."
        }, 2000);
        return;
    }
    if (!(/^\d+$/.test(bot_userid_cookie_timeout))) {
        M.toast({
            "html": "Time interval for session expiration value should contain only numbers."
        }, 2000);
        return;
    }
    bot_userid_cookie_timeout = Math.round(bot_userid_cookie_timeout)

    is_lead_generation_enabled = document.getElementById("checkbox-bot-lead-generation-enabled").checked;


    // is_nps_required = document.getElementById("checkbox-bot-nps-required").checked;
    is_feedback_required = document.getElementById("checkbox-bot-feedback-required").checked;

    is_analytics_monitoring_enabled = document.getElementById("checkbox-is-analytics-monitoring-enabled").checked;

    if (is_analytics_monitoring_enabled) {
        if (check_bot_usage_config()) {
            return;
        }
    }

    var is_bot_intent_threshold_enabled = document.getElementById("checkbox_bot_level_advance_nlp_cb").checked;

    var intent_score_threshold = "None";
    if (document.getElementById("checkbox_bot_level_advance_nlp_cb").checked) {
        intent_score_threshold = document.getElementById("easychat-bot-intent-threshold").value;
    }

    var is_intent_level_nlp_functionality_enabled = document.getElementById("easychat_intent_level_advance_nlp").checked;

    termination_keyword_list = []
    var termination_keyword = M.Chips.getInstance($('#flow_termination_keywords')).chipsData;
    for (var i = 0; i < termination_keyword.length; i++) {

        termination_keyword_list.push(termination_keyword[i]["tag"]);
    }

    flow_termination_bot_response = $("#flow_termination_bot_response").trumbowyg('html');

    flow_termination_confirmation_display_message = $("#flow_termination_confirmation_display_message").trumbowyg('html');

    flow_termination_confirmation_filtered_text = validate_ck_editor_response(flow_termination_confirmation_display_message)

    filtered_text = validate_ck_editor_response(flow_termination_bot_response);

    if (termination_keyword_list.length != 0 && filtered_text.length == 0) {
        M.toast({
            "html": "Flow termination bot response cannot be empty."
        }, 2000);
        return;
    }

    if (flow_termination_confirmation_filtered_text.length == 0) {

        M.toast({
            "html": "Flow termination confirmation display message cannot be empty."
        }, 2000);
        return;
    }

    //---- Emoji modal values ----
    angry_emoji_response = $("#angry-emoji-response").trumbowyg('html');
    happy_emoji_response = $("#happy-emoji-response").trumbowyg('html');
    neutral_emoji_response = $("#neutral-emoji-response").trumbowyg('html');
    sad_emoji_response = $("#sad-emoji-response").trumbowyg('html');

    if (!check_emoji_response()) {
        return;
    }
    //---- Emoji modal values end----

    is_suggest_livechat_for_profanity_words_enabled = false
    profanity_response_text = $("#profanity-word-bot-response").trumbowyg('html');
    add_livechat_as_quick_recommendation = false
    trigger_livechat_intent = true

    if (IS_LIVECHAT_MANAGER && IS_LIVECHAT_MANAGER.trim().toLowerCase() == "true") {
        is_suggest_livechat_for_profanity_words_enabled = document.getElementById("livechat-profanity-words-enable").checked

        add_livechat_as_quick_recommendation = document.getElementById("add_livechat_as_quick_recommendation_for_profan_words").checked

        trigger_livechat_intent = document.getElementById("trigger_livechat_for_profan_words").checked

        if (is_livechat_enabled && is_suggest_livechat_for_profanity_words_enabled) {
            if (!check_profanity_model_settings()) {
                return;
            }
        }
    }
    initial_intent_pk = $("#single-select-initial-intent").val();

    selected_channels_list_nps = $('#multi-select-channels').val();

    is_nps_required = document.getElementById("enable_csat_option_cb").checked

    whatsapp_nps_timer = document.getElementById("easychat-whatsapp-nps-timer").value;

    viber_nps_timer = document.getElementById("easychat-viber-nps-timer").value;

    csat_feedback_form_enabled = document.getElementById('checkbox-csat-feedback').checked;

    scale_rating = $("input:radio[name=group_scale]:checked").val()

    var create_csat_flow = false

    if (document.getElementById("whatsapp-nps-timer").style.display == 'none') {
        whatsapp_nps_timer = 2
    } else {

        if (!sanitize_input_numeric(whatsapp_nps_timer)) {
            showToast('Please enter a valid WhatsApp CSAT time.')
            return;
        }

        if (whatsapp_nps_timer <= 0) {
            showToast('WhatsApp CSAT time must be greater than or equal to 1.')
            return;
        }

    }

    if (document.getElementById("viber-nps-timer").style.display == 'none') {
        viber_nps_timer = 2
    } else {

        if (!sanitize_input_numeric(viber_nps_timer)) {
            showToast('Please enter a valid Viber CSAT time.')
            return;
        }

        if (viber_nps_timer <= 0) {
            showToast('Viber CSAT time must be greater than or equal to 1.')
            return;
        }

    }

    if (is_nps_required) {
        if (selected_channels_list_nps.length == 0) {
            M.toast({
                "html": "Please select atleast one channel for CSAT."
            }, 2000);
            return;
        }
        const WhatsappValue = selected_channels_list_nps.some(element => {
            return element.toLowerCase() === "WhatsApp".toLowerCase();
        });
        const ViberValue = selected_channels_list_nps.some(element => {
            return element.toLowerCase() === "Viber".toLowerCase();
        });
        selected_channels_list_nps
        if (WhatsappValue || ViberValue ) {
            create_csat_flow = true
        }
    } else {
        whatsapp_nps_timer = 0
        viber_nps_timer = 0
        selected_channels_list_nps = []
        csat_feedback_form_enabled = false
        scale_rating = "4_scale"
    }
    // selected_supported_languages = $("#select-language-supported").val();

    // if ("en" in selected_supported_languages == false) {
    //     selected_supported_languages.push("en");
    // }

    show_brand_name = document.getElementById("checkbox-show-brand-name").checked;

    custom_bot_js_required = document.getElementById("checkbox-custom-bot-js").checked;

    custom_bot_css_required = document.getElementById("checkbox-custom-bot-css").checked;

    bot_response_delay_allowed = document.getElementById("checkbox-bot-response-delay-enabled").checked;
    bot_response_delay_timer = document.getElementById("bot-response-delay-time").value;
    bot_response_delay_message = document.getElementById("bot-response-delay-msg").value;

    if (bot_response_delay_allowed) {

        if (bot_response_delay_message.trim() == "") {
            M.toast({
                "html": "Delay message cannot be empty"
            }, 2000);
            return;
        }

        let isnum = /^\d+$/.test(bot_response_delay_timer.trim());
        if (!isnum) {
            M.toast({
                "html": "Invalid delay time input."
            }, 2000);
            return;
        }

        if (bot_response_delay_timer.trim() == "" || parseInt(bot_response_delay_timer.trim()) < 1) {
            M.toast({
                "html": "Time value must be greater than or equal to 1."
            }, 2000);
            return;
        }

    }


    var response_order_elements = document.getElementsByClassName('easychat-intent-response-item');
    var default_order_of_response = [];
    for (res of response_order_elements) {
        default_order_of_response.push(res.firstChild.textContent);
    }
    max_file_size_allowed = document.getElementById("easychat-attachment-max-file-size").value;
    if (max_file_size_allowed < 5) {
        M.toast({
            "html": "Max File Size allowed cannot be less than 5MB"
        }, 2000);
        return;
    }
    if (!(/^\d+$/.test(max_file_size_allowed))) {
        M.toast({
            "html": "Max File Size allowed value should contain only numbers"
        }, 2000);
        return;
    }

    show_form = false
    show_form = document.getElementById("show_form").checked

    use_customer_details_processor = false
    use_customer_details_processor = document.getElementById("use_customer_details_processor").checked

    use_end_chat_processor = false
    use_end_chat_processor = document.getElementById("use_end_chat_processor").checked

    use_assign_agent_processor = false
    use_assign_agent_processor = document.getElementById("use_assign_agent_processor").checked

    // mask pii
    masking_enabled = document.getElementById('checkbox-masking-enabled').checked;
    masking_time_elem = document.getElementById('easychat-mask-pii-time');

    masking_time = MASKING_TIME
    if (masking_time_elem) {
        masking_time = masking_time_elem.value;
    }

    is_audio_notification_enabled = document.getElementById('is-audio-notification-enabled').checked;

    is_abort_flow_enabled = document.getElementById("enable_abort_flow_toggle").checked;

    is_advance_tree_level_nlp_enabled = document.getElementById("enable_advance_tree_level_nlp").checked;

    var enable_do_not_translate = document.getElementById("enable-do-not-translate").checked;

    var no_translate_keyword_elements = document.getElementById("keywords-container").children;
    var no_translate_keywords = [];
    for (var i=0; i<no_translate_keyword_elements.length; i++) {
        no_translate_keywords.push(no_translate_keyword_elements[i].getAttribute("value"));
    }

    var no_translate_regex_elements = document.getElementById("regex-container").children;
    var no_translate_regex = [];
    for (var i=0; i<no_translate_regex_elements.length; i++) {
        no_translate_regex.push(no_translate_regex_elements[i].getAttribute("value"));
    }

    json_string = JSON.stringify({
        "bot_id": bot_id,
        "bot_name": bot_name.trim(),
        "is_text_to_speech_required": is_text_to_speech_required,
        "is_easyassist_enabled": is_easyassist_enabled,
        "is_livechat_enabled": is_livechat_enabled,
        "is_easysearch_enabled": is_easysearch_enabled,
        "is_pdfsearch_enabled": is_pdfsearch_enabled,
        "is_lead_generation_enabled": is_lead_generation_enabled,
        "is_easytms_enabled": is_easytms_enabled,
        "tms_drop_down_cat_list": tms_drop_down_cat_list,
        "intent_score_threshold": intent_score_threshold,
        "termination_keyword_list": termination_keyword_list,
        "flow_termination_bot_response": flow_termination_bot_response,
        "is_synonyms_incuded_var_gen": is_synonyms_incuded_var_gen,
        "is_feedback_required": is_feedback_required,
        "is_email_notifiication_enabled": is_email_notifiication_enabled,
        // "is_nps_required": is_nps_required,
        "mask_confidential_info": mask_confidential_info,
        "bot_inactivity_detection_enabled": bot_inactivity_detection_enabled,
        "bot_inactivity_msg": bot_inactivity_msg,
        "bot_inactivity_time": bot_inactivity_time,
        "go_live_date": go_live_date,
        "is_api_fail_email_notifiication_enabled": is_api_fail_email_notifiication_enabled,
        "is_bot_break_email_notification_enabled": is_bot_break_email_notification_enabled,
        "bot_userid_cookie_timeout": bot_userid_cookie_timeout,
        "is_analytics_monitoring_enabled": is_analytics_monitoring_enabled,
        "initial_intent_pk": initial_intent_pk,
        "is_nps_required": is_nps_required,
        "selected_channels_list_nps": selected_channels_list_nps,
        "whatsapp_nps_timer": whatsapp_nps_timer,
        "viber_nps_timer": viber_nps_timer,
        // "selected_supported_languages": selected_supported_languages,
        "show_brand_name": show_brand_name,
        "custom_bot_js_required": custom_bot_js_required,
        "custom_bot_css_required": custom_bot_css_required,
        "bot_response_delay_allowed": bot_response_delay_allowed,
        "bot_response_delay_timer": bot_response_delay_timer,
        "bot_response_delay_message": bot_response_delay_message,
        "default_order_of_response": default_order_of_response,
        "max_file_size_allowed": max_file_size_allowed,
        "show_form": show_form,
        "use_customer_details_processor": use_customer_details_processor,
        "use_end_chat_processor": use_end_chat_processor,
        "use_assign_agent_processor": use_assign_agent_processor,
        "masking_enabled": masking_enabled,
        "masking_time": masking_time,
        "token": token,
        "csat_feedback_form_enabled": csat_feedback_form_enabled,
        "scale_rating": scale_rating,
        "create_csat_flow": create_csat_flow,
        "enable_audio_notification": is_audio_notification_enabled,
        "flow_termination_confirmation_display_message": flow_termination_confirmation_display_message,
        "is_trigger_livechat_enabled": is_trigger_livechat_enabled,
        "autosuggest_livechat_word_limit": autosuggest_livechat_word_limit,
        "is_bot_intent_threshold_enabled": is_bot_intent_threshold_enabled,
        "is_intent_level_nlp_functionality_enabled": is_intent_level_nlp_functionality_enabled,
        "angry_emoji_response": angry_emoji_response,
        "happy_emoji_response": happy_emoji_response,
        "neutral_emoji_response": neutral_emoji_response,
        "sad_emoji_response": sad_emoji_response,
        "emoji_livechat_checkbox_value_list": emoji_livechat_checkbox_value_list,
        "is_abort_flow_enabled": is_abort_flow_enabled,
        "is_suggest_livechat_for_profanity_words_enabled": is_suggest_livechat_for_profanity_words_enabled,
        "profanity_response_text": profanity_response_text,
        "add_livechat_as_quick_recommendation": add_livechat_as_quick_recommendation,
        "trigger_livechat_intent": trigger_livechat_intent,
        "is_advance_tree_level_nlp_enabled": is_advance_tree_level_nlp_enabled,
        "livechat_provider": livechat_provider,
        "enable_do_not_translate": enable_do_not_translate,
        "no_translate_keywords": no_translate_keywords,
        "no_translate_regex": no_translate_regex
    });

    json_string = EncryptVariable(json_string);

    element.innerHTML = "saving...";
    $.ajax({
        url: "/chat/bot/save/",
        type: "POST",
        headers: {
            'X-CSRFToken': get_csrf_token(),
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Changes saved successfully! Please make sure to update the Bot deployment script as well."
                })
                setTimeout(function () {
                    window.location.reload();
                }, 3000);
            } else if (response['status'] == 400) {
                setTimeout(function (e) {
                    M.toast({
                        "html": "Bot with same name already exists. Please choose different name"
                    }, 3000);
                }, 5000);
            } else if (response['status'] == 300) {
                setTimeout(function () {
                    M.toast({
                        "html": response["msg"]
                    })
                }, 1000);
            } else {
                M.toast({
                    "html": "Please check if inputs are valid."
                })
            }
            element.innerHTML = "<svg width='16'\
                            height='16' viewBox='0 0 16 16' fill='none'\
                            xmlns='http://www.w3.org/2000/svg'><path d='M9.33334 1.33325V4.50158C9.33334 4.58048 9.27851 4.64657 9.20488 4.66384L9.16667 4.66825H5.16667C5.08777 4.66825 5.02168 4.61342 5.0044 4.53979L5 4.50158V1.33325H9.33334ZM11.5058 9.36C11.5979 9.36 11.6725 9.43461 11.6725 9.52666L11.672 14.3333H4.33267L4.33334 9.52666C4.33334 9.43461 4.40796 9.36 4.5 9.36H11.5058ZM10.4244 1.33325C10.6082 1.33325 10.786 1.39401 10.9307 1.50469L14.4333 4.49992C14.5978 4.65714 14.6667 4.8785 14.6667 5.10606V12.8333C14.6667 13.6617 13.9951 14.3333 13.1667 14.3333H12.672L12.6725 9.52666C12.6725 8.88233 12.1502 8.36 11.5058 8.36H4.5C3.85567 8.36 3.33334 8.88233 3.33334 9.52666L3.33267 14.3333H2.83334C2.00491 14.3333 1.33334 13.6617 1.33334 12.8333V2.83325C1.33334 2.00482 2.00491 1.33325 2.83334 1.33325H4V4.50158C4 5.1137 4.47141 5.61571 5.07098 5.66438L5.16667 5.66825H9.16667C9.77879 5.66825 10.2808 5.19684 10.3295 4.59726L10.3333 4.50158V1.33325H10.4244Z'\
                                fill='#fff' />\
                        </svg>\
                        &nbsp;Save";;
        },
        error: function (error) {
            element.innerHTML = "<svg width='16'\
                            height='16' viewBox='0 0 16 16' fill='none'\
                            xmlns='http://www.w3.org/2000/svg'><path d='M9.33334 1.33325V4.50158C9.33334 4.58048 9.27851 4.64657 9.20488 4.66384L9.16667 4.66825H5.16667C5.08777 4.66825 5.02168 4.61342 5.0044 4.53979L5 4.50158V1.33325H9.33334ZM11.5058 9.36C11.5979 9.36 11.6725 9.43461 11.6725 9.52666L11.672 14.3333H4.33267L4.33334 9.52666C4.33334 9.43461 4.40796 9.36 4.5 9.36H11.5058ZM10.4244 1.33325C10.6082 1.33325 10.786 1.39401 10.9307 1.50469L14.4333 4.49992C14.5978 4.65714 14.6667 4.8785 14.6667 5.10606V12.8333C14.6667 13.6617 13.9951 14.3333 13.1667 14.3333H12.672L12.6725 9.52666C12.6725 8.88233 12.1502 8.36 11.5058 8.36H4.5C3.85567 8.36 3.33334 8.88233 3.33334 9.52666L3.33267 14.3333H2.83334C2.00491 14.3333 1.33334 13.6617 1.33334 12.8333V2.83325C1.33334 2.00482 2.00491 1.33325 2.83334 1.33325H4V4.50158C4 5.1137 4.47141 5.61571 5.07098 5.66438L5.16667 5.66825H9.16667C9.77879 5.66825 10.2808 5.19684 10.3295 4.59726L10.3333 4.50158V1.33325H10.4244Z'\
                                fill='#fff' />\
                        </svg>\
                        &nbsp;Save";;
            console.log("Report this error: ", error);
        }
    });
}

function send_test_email(element) {
    bot_id = window.location.pathname.split("/")[4];
    email_freq = document.getElementById("email-config-frequency").value;
    var json_string = JSON.stringify({
        bot_id: bot_id,
        email_freq: email_freq
    })
    json_string = EncryptVariable(json_string);
    element.innerHTML = "sending test mail...";
    $.ajax({
        url: "/chat/send-test-mail/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Mail is sent to your given email ids"
                })
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
            element.innerHTML = "send test mail";
            $("#modal-email-config").modal("close");
        },
        error: function (error) {
            element.innerHTML = "send test mail";
            console.log("Report this error: ", error);
        }
    });
};

function check_is_welcome_banner_present() {

    welcome_banner_list = document.getElementById("easychat-welcome-banner-draggable-item")
    if (welcome_banner_list.children.length > 0) {
        return true
    }

    return false

}

function update_bot_color_font() {
    theme_selected = [];
    theme_elemnts = $("input:radio[name=easychat-theme]:checked")
    for (var i = 0; i < theme_elemnts.length; i++) {
        theme_selected.push(theme_elemnts[i].value)

    }
    if (theme_selected.length == 0) {
        alert("Please select theme")
        return
    }
    var is_minimization_enabled = false;
    if (document.getElementById("is-minimization-enabled").checked) {
        is_minimization_enabled = true;
    }
    theme_selected = theme_selected[0]

    if (theme_selected == "theme_7") {
        bot_theme_color = "2D4CB8"
        save_bot_font('Roboto', '14px')
        check_font_change = true
    } else {
        bot_theme_color = $("#bot_theme_color").val()
    }
}

function save_theme_settings(element) {


    update_bot_color_font()
    check_theme_change = true
    $("#save-web-channel").click();
}


function hide_phonetic_typing_checkbox() {
    if (document.getElementById("enable-phonetic-typing")) {
        document.getElementById("enable-phonetic-typing").style.display = "none";
    }

    if (document.getElementById("language-disclaimer-text-row")) {
        document.getElementById("language-disclaimer-text-row").style.display = "none";
    }
}

function show_phonetic_typing_checkbox() {
    document.getElementById("enable-phonetic-typing").style.display = "grid";
    handle_phonetic_typing_checkbox(document.getElementById("is_web_bot_phonetic_typing_enabled"))
}

function handle_phonetic_typing_checkbox(element) {
    if (element.checked) {
        document.getElementById("language-disclaimer-text-row").style.display = "grid";

    }
    else
        document.getElementById("language-disclaimer-text-row").style.display = "none";
}

function check_phonetic_typing_toogle() {
    for (let i = 0; i < LIST_OF_PHONETIC_TYPING_SUPPORTED_LANGUAGES.length; i++) {
        if ($("#" + LIST_OF_PHONETIC_TYPING_SUPPORTED_LANGUAGES[i]).prop('checked')) {
            show_phonetic_typing_checkbox()
            return
        }
    }

    hide_phonetic_typing_checkbox()

}

function remove_selected_language(event, el, id) {
    event.stopPropagation();
    if (id.toLowerCase().trim() == "english-en") {
        showToast("Default language cannot be removed")
        return
    }

    el.parentElement.remove();
    document.getElementById(id).checked = false;
    check_phonetic_typing_toogle()
    update_language_chips()
    enable_disable_auto_language_detection_toogle()
    enable_disable_welcome_message_language_change_toogle()
}

function make_slected_language_span_chips(id, name_in_english) {
    var span = '<span class="tag"><span class="language-chip-display-name" >' + name_in_english + '</span>\
        <svg class="selected-language-cross-btn" onclick="remove_selected_language(event,this,`' + id + '`)"  width="12" height="12" viewBox="0 0 7 8" fill="none" xmlns="http://www.w3.org/2000/svg">\
            <path d="M6.65011 0.854978C6.55669 0.761352 6.42987 0.708735 6.29761 0.708735C6.16535 0.708735 6.03852 0.761352 5.94511 0.854978L3.50011 3.29498L1.05511 0.849978C0.961692 0.756352 0.834866 0.703735 0.702607 0.703735C0.570349 0.703735 0.443523 0.756352 0.350107 0.849978C0.155107 1.04498 0.155107 1.35998 0.350107 1.55498L2.79511 3.99998L0.350107 6.44498C0.155107 6.63998 0.155107 6.95498 0.350107 7.14998C0.545107 7.34498 0.860107 7.34498 1.05511 7.14998L3.50011 4.70498L5.94511 7.14998C6.14011 7.34498 6.45511 7.34498 6.65011 7.14998C6.84511 6.95498 6.84511 6.63998 6.65011 6.44498L4.20511 3.99998L6.65011 1.55498C6.84011 1.36498 6.84011 1.04498 6.65011 0.854978Z" fill="#2755CB"/>\
        </svg> </span>'
    const selected = document.querySelector("#selected-language-chips-wrapper .selected");
    selected.innerHTML += span;

}
let to_add_diffrentiator = true
// this variable designates wheter the diffrentiaor like +1,+2 in languages needs to be shown or not 
function update_language_chips() {

    const selected = document.querySelector("#selected-language-chips-wrapper .selected");
    let is_any_language_checked = false
    let count = 0;
    selected.innerHTML = ""
    var checked_list = get_checked_languages_list()
    for (let i = 0; i < checked_list.length; i++) {
        is_any_language_checked = true
        count++;
        if (count > 3 && to_add_diffrentiator)
            break;
        make_slected_language_span_chips(checked_list[i].id, checked_list[i].name)
    }
    if (count > 3 && to_add_diffrentiator) {
        var btn = document.createElement("BUTTON");
        btn.innerText = "+" + String(checked_list.length - 3);
        btn.id = "languages-extend-button"
        selected.appendChild(btn);
        add_language_extend_button_event_listner();
    }
    if (!is_any_language_checked)
        selected.innerHTML = "Select Language";
}
$('#selected-language-chips-wrapper').on('click', function () {

    const optionsContainer = document.querySelector("#language-box-options-container");
    const selected = document.querySelector(".selected");
    const searchBox = document.querySelector(".search-box input");
    const dropArrow = document.querySelector("#language-dropdown-arrow");
    optionsContainer.classList.toggle("active");
    is_language_dropddown_open = optionsContainer.classList.contains("active");
    to_add_diffrentiator = true
    if (is_language_dropddown_open) {
        selected.innerHTML = "Select Language";
        selected.style.border = "none";
        dropArrow.style.transform = "translateY(-50%) rotate(180deg)";
        searchBox.focus();
        document.getElementById("language-options-search-box").style.display = "block";
    } else {
        dropArrow.style.transform = "translateY(-50%) rotate(0deg)";
        update_language_chips()
        document.getElementById("language-options-search-box").style.display = "none";

    }
    searchBox.value = "";
    filterList("");

})
$('#language-options-search-box').on("keyup", function (e) {
    filterList(e.target.value);
});


function enable_disable_auto_language_detection_toogle() {
    let checked_list = get_checked_languages_list()

    if (checked_list.length <= 1) {
        document.getElementById("is_language_auto_detection_enabled").checked = false;
        document.getElementById("is_language_auto_detection_enabled").disabled = true;
        document.getElementById("bot_language_auto_detection_div").style.display = "none"
    } else {
        document.getElementById("is_language_auto_detection_enabled").disabled = false;
        document.getElementById("bot_language_auto_detection_div").style.display = "grid"
    }

}

function enable_disable_welcome_message_language_change_toogle(show_change_language_on_welcome_message=false) {
    let checked_list = get_checked_languages_list()

    if (checked_list.length <= 1) {
        document.getElementById("is_enable_choose_language_flow_enabled_for_welcome_response").checked = false;
        document.getElementById("is_enable_choose_language_flow_enabled_for_welcome_response").disabled = true;
        document.getElementById("enable_choose_language_welcome_response_toogle_div").style.display = "none"
    } else {
        document.getElementById("is_enable_choose_language_flow_enabled_for_welcome_response").disabled = false;
        document.getElementById("enable_choose_language_welcome_response_toogle_div").style.display = "grid"
    }

    if (!show_change_language_on_welcome_message) {
        document.getElementById("enable_choose_language_welcome_response_toogle_div").style.display = "none"
    }

}

function add_language_extend_button_event_listner() {
    $('#languages-extend-button').on("click", function (e) {
        e.stopPropagation();
        const selected = document.querySelector(".selected");
        var checked_list = get_checked_languages_list()
        selected.innerHTML = "";
        let flag = 1;
        for (let item of checked_list) {
            flag = 0;
            make_slected_language_span_chips(item.id, item.name);
        }
        if (flag == 1)
            selected.innerHTML = "Select Language";
        else to_add_diffrentiator = false;
    });
}

function filterList(searchTerm) {
    searchTerm = searchTerm.toLowerCase();
    optionsList = document.querySelectorAll(".option");
    let flag = 0;
    document.querySelector(".no-elem").style.display = "none";
    optionsList.forEach(option => {
        let label = option.firstElementChild.nextElementSibling.innerText.toLowerCase();
        if (label.indexOf(searchTerm) != -1) {
            flag = 1;
            option.style.display = "block";
        } else {
            option.style.display = "none";
        }
    })
    if (flag === 0)
        document.querySelector(".no-elem").style.display = "block";
}

function get_checked_languages_list() {
    selected_language_list = document.querySelectorAll(".item-checkbox");
    checked_language_list = []
    for (let i = 0; i < selected_language_list.length; i++) {
        if (selected_language_list[i].checked) {
            checked_language_list.push(selected_language_list[i])
        }
    }
    return checked_language_list
}


function get_selected_languages_list() {
    selected_language_list = document.querySelectorAll(".item-checkbox");
    suported_language_list = []
    for (let i = 0; i < selected_language_list.length; i++) {
        if (selected_language_list[i].checked) {
            suported_language_list.push(selected_language_list[i].value)
        }
    }
    return suported_language_list
}

/* Sticky intent menu functions starts here */

$('#easychat-sticky-intents-collapsible-header, #menu-format').on('click', function () {
    var menu_div = document.getElementById('channel-sticky-intents-menu');
    menu_div.style.visibility = 'hidden';
    setTimeout(function () {
        var elem = document.getElementById('easychat-sticky-intents-collapsible-body');
        if (elem.style.display == 'block') {
            var is_menu_display = document.getElementById('menu-format').checked;
            if (is_menu_display) {
                setTimeout(function () {
                    menu_div.style.visibility = 'visible';
                }, 100)
            }
        }
    }, 200)
})


function fit_text_in_sticky_intent_div(id) {
    var parent_elem = document.getElementById('menu-item_' + id);

    if (parent_elem == null || parent_elem == undefined) return true;

    var child_elem = parent_elem.children[2];

    if (child_elem == undefined) return true;

    var elem = child_elem.children[0]

    if (child_elem.scrollHeight > parent_elem.scrollHeight / 2) {
        var curr_font_size = parseInt(elem.style.fontSize.split('%')[0]);
        elem.style.fontSize = (curr_font_size - 5) + '%';
    }

    if (child_elem.scrollHeight > parent_elem.scrollHeight / 2) return false;

    return true;
}

//-------------hamburger functions-------------
if (window.location.pathname != '/chat/login/') {
    $(function () {
        $("#hamburger-menu-container").sortable();
        $("#hamburger-menu-container").disableSelection();

        //quick menu drag and drop
        $("#quick-menu-container").sortable();
        $("#quick-menu-container").disableSelection();
    });
}

if (window.location.pathname == '/chat/login/') {
    $(document).ready(function () {

        setTimeout(function () {

            $('#forgot-pass-otp').modal({
                dismissible: false
            });
            $('#forgot-pass-back').modal({
                dismissible: false
            });

        }, 1000)


    })
}

function hamburger_sticky_button_display_handler(elem) {
    if (elem.value == "Link") {
        document.getElementById('hamburger-sticky-intents').style.display = 'none';
        document.getElementById('hamburger-sticky-link').style.display = 'block';
        current_hamburger_type = "Link"
    } else {
        document.getElementById('hamburger-sticky-intents').style.display = 'block';
        document.getElementById('hamburger-sticky-link').style.display = 'none';
        current_hamburger_type = "Intent"
    }
}

//-------hamburger icon name-----

function set_hamburger_icon_val(element, id) {
    var class_name = document.getElementById(id).className.split(" ")
    document.getElementById("edit-hamburger-icon-name").value = class_name[1]
    current_hamburger_editable_id = id + ""
    current_editable_index = current_hamburger_editable_id.split("_")[current_hamburger_editable_id.split("_").length - 1]
}

function cancel_hamburger_icon_edit_window() {
    document.getElementById("edit-hamburger-icon-name").value = ""
}

function save_hamburger_icon_edit_window(element) {
    var icon_name = document.getElementById("edit-hamburger-icon-name").value

    if (icon_name == "") {
        M.toast({
            "html": "Select an icon"
        });
        return;
    }

    document.getElementById(current_hamburger_editable_id).className = "fa " + icon_name + " material-icons prefix"

    var splitted_input = document.getElementById("hamburger_hidden_input_" + current_editable_index).value.split("_")
    var merged_input = splitted_input[0] + "_" + splitted_input[1] + "_" + icon_name + "_" + splitted_input[3] + "_" + splitted_input[4] + "_" + splitted_input[5]

    document.getElementById("hamburger_hidden_input_" + current_editable_index).value = merged_input

}

//-------hamburger menu title-----

function set_hamburger_menu_title_val(element) {
    var menu_title = element.innerHTML.trim()
    if (menu_title != "Menu Title")
        document.getElementById("edit-hamburger-menu-title").value = menu_title
    current_hamburger_editable_id = element.id + ""
    current_editable_index = current_hamburger_editable_id.split("_")[current_hamburger_editable_id.split("_").length - 1]
}

function cancel_hamburger_menu_title_edit_window() {
    document.getElementById("edit-hamburger-menu-title").value = ""
}

function save_hamburger_menu_title_edit_window(element) {
    var menu_title = document.getElementById("edit-hamburger-menu-title").value

    if (menu_title == "") {
        M.toast({
            "html": "Please enter menu title"
        });
        return;
    }
    var elements = document.querySelectorAll('.hamburger-menu-item > input');
    for (element of elements) {
        let intent = element.value;
        intent = intent.split('_');
        const menu_title_current = intent[3];
        if (menu_title_current.trim() == menu_title.trim()) {
            M.toast({
                "html": "Item already exists in menu"
            });
            return;
        }
    }

    document.getElementById(current_hamburger_editable_id).innerHTML = menu_title


    var splitted_input = document.getElementById("hamburger_hidden_input_" + current_editable_index).value.split("_")
    var merged_input = splitted_input[0] + "_" + splitted_input[1] + "_" + splitted_input[2] + "_" + menu_title + "_" + splitted_input[4] + "_" + splitted_input[5]

    document.getElementById("hamburger_hidden_input_" + current_editable_index).value = merged_input

}

//----hamburger intent---------


function set_hamburger_intent_val(element, intent_pk_param, intent_name_param) {
    var doc = new DOMParser().parseFromString(element.innerHTML + "", "text/html")
    var intent_name = intent_name_param
    var intent_pk = intent_pk_param
    var val_tag = intent_name + "-" + intent_pk

    if (val_tag.trim() == "-") {
        $('#edit-hamburger-intent').val("Intent Name-1883");
        $('#edit-hamburger-intent').trigger('change');
    } else {
        $('#edit-hamburger-intent').val(val_tag);
        $('#edit-hamburger-intent').trigger('change');
    }

    current_hamburger_editable_id = element.querySelectorAll("input")[0].id + ""

    current_editable_index = current_hamburger_editable_id.split("_")[current_hamburger_editable_id.split("_").length - 1]
}

function cancel_hamburger_intent_edit_window() {

    $('#edit-hamburger-intent').val("Contact Customer Care-181");
    $('#edit-hamburger-intent').trigger('change');
}

function save_hamburger_intent_edit_window(element) {
    var intent = document.getElementById("edit-hamburger-intent").value
    var intent_name = intent.split("-")[0]
    var intent_pk = intent.split("-")[1]
    if (intent_name == "" || intent_name == "Intent Name") {
        M.toast({
            "html": "Please enter a valid intent"
        });
        return;
    }

    document.getElementById(current_hamburger_editable_id).checked = 'true'

    var splitted_input = document.getElementById("hamburger_hidden_input_" + current_editable_index).value.split("_")
    var merged_input = splitted_input[0] + "_" + intent_pk + "_" + splitted_input[2] + "_" + splitted_input[3] + "_" + intent_name + "_" + "nil"

    $('#hamburger_label_intent_' + current_editable_index).click(function () {
        set_hamburger_intent_val(document.getElementById('hamburger_label_intent_' + current_editable_index), intent_pk, intent_name)
    });
    document.getElementById("hamburger_hidden_input_" + current_editable_index).value = merged_input

}


//----hamburger link---------


function set_hamburger_link_val(element, link) {
    var doc = new DOMParser().parseFromString(element.innerHTML + "", "text/html")

    if (link == "nil")
        link = ""

    $('#edit-hamburger-link').val(link);

    current_hamburger_editable_id = element.querySelectorAll("input")[0].id + ""

    current_editable_index = current_hamburger_editable_id.split("_")[current_hamburger_editable_id.split("_").length - 1]
}

function cancel_hamburger_link_edit_window() {
    $('#edit-hamburger-link').val("");

}

function save_hamburger_link_edit_window(element) {
    var link = document.getElementById("edit-hamburger-link").value

    if (link == "") {
        M.toast({
            "html": "Please enter a valid link"
        });
        return;

    }

    var pattern = /^((http|https|ftp):\/\/)/;
    if (!pattern.test(link)) {

        M.toast({
            "html": "Please enter valid redirect url."
        }, 2000);
        return;
    }

    document.getElementById(current_hamburger_editable_id).checked = 'true'
    var splitted_input = document.getElementById("hamburger_hidden_input_" + current_editable_index).value.split("_")
    var merged_input = splitted_input[0] + "_" + "1883" + "_" + splitted_input[2] + "_" + splitted_input[3] + "_" + "Intent Name" + "_" + link

    $('#hamburger_label_link_' + current_editable_index).click(function () {
        set_hamburger_link_val(document.getElementById('hamburger_label_link_' + current_editable_index), link)
    });
    document.getElementById("hamburger_hidden_input_" + current_editable_index).value = merged_input

}

//------hamburger delete item------
function delete_hamburger_container(pk) {

    document.getElementById("hamburger-item_" + pk).style.display = "none"
    var temp_val = document.getElementById("hamburger_hidden_input_" + pk).value
    temp_val = temp_val + "_deleted"
    document.getElementById("hamburger_hidden_input_" + pk).value = temp_val


}

function add_hamburger_item() {
    let intent = "null"
    let link = "null"
    let intent_name = "null";
    let intent_pk = "null";
    let icon_name = document.getElementById('icon-name-ham').value;
    let menu_title = document.getElementById('menu-title-ham').value;

    if (icon_name == "") {
        M.toast({
            "html": "Select an icon"
        });
        return;
    }

    if (menu_title == "") {
        M.toast({
            "html": "Please add Menu Title"
        });
        return;
    }

    if (current_hamburger_type == "Intent") {
        intent = document.getElementById('intents-ham').value;
        if (intent == "") {
            var e = document.getElementById("intents-ham");
            intent = e.options[0].value;
            if (intent == "") {
                M.toast({
                    "html": "Please select a valid intent"
                });
                return;
            }
        }

        intent = intent.split('-');
        intent_name = intent[0];
        intent_pk = intent[1];
    } else {
        link = document.getElementById('link-ham').value;
        if (link == "") {
            M.toast({
                "html": "Enter a link"
            });
            return;
        }

        var pattern = /^((http|https|ftp):\/\/)/;
        if (!pattern.test(link)) {
            M.toast({
                "html": "Please enter valid redirect url."
            }, 2000);
            return;
        }


    }


    let last_hamburger = document.getElementsByClassName('hamburger-menu-container')[document.getElementsByClassName('hamburger-menu-container').length - 1];

    var elements = document.querySelectorAll('.hamburger-menu-item > input');
    var editable_index = 0;
    var upload_place = -1
    var flag = 0
    for (element of elements) {
        let intent = element.value;
        intent = intent.split('_');
        const menu_title_current = intent[3];

        if (menu_title_current == menu_title) {
            M.toast({
                "html": "Item already exists in menu"
            });
            return;
        } else {

            if (menu_title_current == "Menu Title") {
                flag = 1;
                upload_place = intent[0]
                break;
            }

            editable_index++;


        }
    }

    editable_index = editable_index + 1;
    if (upload_place != -1) {
        editable_index = upload_place
    }

    var last_hamburger_id;
    if (last_hamburger_id == undefined) {
        last_hamburger_id = 1;
    } else {
        last_hamburger_id = last_hamburger.id.split('_')[1];
        last_hamburger_id = parseInt(last_hamburger_id) + 1;
    }

    var html = '<div class="hamburger-menu-item ui-state-default" id="hamburger-item_' + editable_index +
        '" >\
                                            <div class="hamburger-category-icon">\
                                            <div  data-target="modal-upload-hamburger-category-tile-icon" \
                                            style="padding: 5px; cursor: pointer; position: relative;\
                                            height: 50px;\
                                            width: 50px;\
                                            overflow: visible;" \
                                            class="modal-trigger" onclick="set_hamburger_icon_val(this,\'hamburger-icon_' + editable_index + '\')">\
                                            <i  class="fa ' + icon_name + ' material-icons prefix" aria-hidden="true" style = "font-size: 0.5em; position: absolute;\
                                            top: 50%;\
                                            left: 50%;\
                                            transform: translate(-50%, -50%);" id="hamburger-icon_' + editable_index + '" ></i></div>\
                                            <a onclick="delete_hamburger_container(' + editable_index + ')"><i class="material-icons red-text text-darken-3 hamburger-delete-tile-btn" id="hamburger-delete_' + editable_index + '">delete</i></a>\
                                            </div>\
                                            <div class="hamburger-category-title">\
                                                <span data-target="modal-edit-hamburger-category-tile-title" class=" modal-trigger" id="hamburger-menu-title_' + editable_index + '" onclick="set_hamburger_menu_title_val(this)" >' +
        menu_title +
        '</span>\
                                            </div>'
    var radio_target = ""
    if (link + "" == "null") {
        radio_target = '<div class="hamburger-category-radio-btn">\
                                            <label data-target="modal-edit-hamburger-category-tile-intent" id="hamburger_label_intent_' + editable_index + '" class="modal-trigger" onclick="set_hamburger_intent_val(this,\'' + intent_pk + '\' ,\'' + intent_name + '\')" >\
                                                  <input class="with-gap" name="category-group1_' + editable_index + '" type="radio" id="hamburger-intent_' + editable_index + '" checked/>\
                                                  <span>Intent</span>\
                                              </label>\
                                                <label data-target="modal-edit-hamburger-category-tile-link" id="hamburger_label_link_' + editable_index + '"  class="modal-trigger" onclick="set_hamburger_link_val(this,\'\')">\
                                                  <input class="with-gap" name="category-group1_' + editable_index + '" type="radio" id="hamburger-link_' + editable_index + '" />\
                                                  <span>Link</span>\
                                              </label>\
                                          </div>\
                                          <input type="hidden" id = "hamburger_hidden_input_' + editable_index + '" value = "' + editable_index + '_' + intent_pk + '_' + icon_name + '_' + menu_title + '_' + intent_name + '_nil' + '">\
                                            </div>'
        html = html + radio_target
    } else {
        radio_target = '<div class="hamburger-category-radio-btn">\
                                            <label data-target="modal-edit-hamburger-category-tile-intent" id="hamburger_label_intent_' + editable_index + '"  class="modal-trigger" onclick="set_hamburger_intent_val(this,\'1883\',\'Intent Name\')">\
                                                  <input class="with-gap" name="category-group1_' + editable_index + '" type="radio" id="hamburger-intent_' + editable_index + '" />\
                                                  <span>Intent</span>\
                                              </label>\
                                                <label data-target="modal-edit-hamburger-category-tile-link" id="hamburger_label_link_' + editable_index + '"  class="modal-trigger" onclick="set_hamburger_link_val(this, \'' + link + '\')">\
                                                  <input class="with-gap" name="category-group1_' + editable_index + '" type="radio" id="hamburger-link_' + editable_index + '" checked/>\
                                                  <span>Link</span>\
                                              </label>\
                                          </div>\
                                          <input type="hidden" id = "hamburger_hidden_input_' + editable_index + '" value = "' + editable_index + '_' + 1883 + '_' + icon_name + '_' + menu_title + '_nil_' + link + '">\
                                            </div>'

        html = html + radio_target
    }

    if (flag == 0)
        $('#hamburger-menu-container').append(html);
    else {
        var doc = new DOMParser().parseFromString(html, "text/html")
        document.getElementById('hamburger-item_' + editable_index).innerHTML = doc.getElementById('hamburger-item_' + editable_index).innerHTML
    }

    document.getElementById('icon-name-ham').value = ""
    document.getElementById('menu-title-ham').value = ""
    document.getElementById('intents-ham').value = ""
    document.getElementById('link-ham').value = ""
    document.getElementById('link-format').checked = "true"
    document.getElementById('hamburger-sticky-intents').style.display = 'none';
    document.getElementById('hamburger-sticky-link').style.display = 'block';
    current_hamburger_type = "Link"

    var is_text_size_correct = false;
    while (!is_text_size_correct) {
        is_text_size_correct = fit_text_in_sticky_intent_div(last_hamburger_id);
    }

}

//---------Hamburger Functions End-----

//--------Quick Menu Functions---

function quick_sticky_button_display_handler(elem) {
    if (elem.value == "Link") {
        document.getElementById('quick-sticky-intents').style.display = 'none';
        document.getElementById('quick-sticky-link').style.display = 'block';
        current_quick_type = "Link"
    } else {
        document.getElementById('quick-sticky-intents').style.display = 'block';
        document.getElementById('quick-sticky-link').style.display = 'none';
        current_quick_type = "Intent"
    }
}

//-------Quick Icon name-----

function set_quick_icon_val(element, id) {
    var src_name = document.getElementById(id).src
    document.getElementById("input_edit_quick_menu_image2").value = src_name
    current_quick_editable_id = id + ""
    current_quick_editable_index = current_quick_editable_id.split("_")[current_quick_editable_id.split("_").length - 1]
}


//Quick Menu Image Upload
$(document).on("click", "#edit_quick_menu_image", function (e) {
    e.preventDefault();
    var input_upload_image = ($("#input_edit_quick_menu_image"))[0].files[0]

    if (input_upload_image == null || input_upload_image == undefined) {
        M.toast({
            "html": "Please select a file"
        }, 2000);

        setTimeout(function () {
            $('#modal-edit-quick-menu-image').modal('open');
        }, 200);
        return false;
    }
    if (input_upload_image.name.match(/\.(jpeg|jpg|gif|png)$/) == null) {
        M.toast({
            "html": "Please upload valid image"
        }, 2000);
        setTimeout(function () {
            $('#modal-edit-quick-menu-image').modal('open');
        }, 200);
        return false;
    }
    if (input_upload_image.size > upload_file_limit_size) {
        M.toast({
            "html": "Size limit exceed(should be less than 5 MB)."
        }, 2000);

        setTimeout(function () {
            $('#modal-edit-quick-menu-image').modal('open');
        }, 200);

        return false;
    }

    if (check_malicious_file(input_upload_image.name) == true) {

        setTimeout(function () {
            $('#modal-edit-quick-menu-image').modal('open');
        }, 200);
        return false;
    }

    var reader = new FileReader();
    reader.readAsDataURL(input_upload_image);
    reader.onload = function () {

        base64_str = reader.result.split(",")[1];

        uploaded_file = [];
        uploaded_file.push({
            "filename": input_upload_image.name,
            "base64_file": base64_str,
        });

        upload_edit_quick_menu_image();
    };

    reader.onerror = function (error) {
        console.log('Error: ', error);
    };
});

async function upload_edit_quick_menu_image() {
    var response = await upload_image();

    if (response && response.status == 200) {
        src = window.location.protocol + "//" + window.location.host + response["src"];
        document.getElementById('input_edit_quick_menu_image2').value = "";
        current_quick_img_src_edit = response["src"]
        $("#" + current_quick_editable_id).attr("src", response["src"]);

        var splitted_input = document.getElementById("quick_hidden_input_" + current_quick_editable_index).value.split(",")
        var merged_input = splitted_input[0] + "," + splitted_input[1] + "," + response["src"] + "," + splitted_input[3] + "," + splitted_input[4] + "," + splitted_input[5]

        document.getElementById("quick_hidden_input_" + current_quick_editable_index).value = merged_input
    }
}

//-------Quick Menu title-----©

function set_quick_menu_title_val(element) {
    var menu_title = element.innerHTML.trim()
    if (menu_title != "Menu Title")
        document.getElementById("edit-quick-menu-title").value = menu_title
    current_quick_editable_id = element.id + ""
    current_quick_editable_index = current_quick_editable_id.split("_")[current_quick_editable_id.split("_").length - 1]
}

function cancel_quick_menu_title_edit_window() {
    document.getElementById("edit-quick-menu-title").value = ""
}

function save_quick_menu_title_edit_window(element) {
    var menu_title = document.getElementById("edit-quick-menu-title").value

    if (menu_title == "") {
        M.toast({
            "html": "Please enter menu title"
        });
        return;
    }
    var elements = document.querySelectorAll('.quick-menu-item > input');
    for (element of elements) {
        let intent = element.value;
        intent = intent.split(',');
        const menu_title_current = intent[3];
        if (menu_title_current.trim() == menu_title.trim()) {
            M.toast({
                "html": "Item already exists in menu"
            });
            return;
        }
    }

    document.getElementById(current_quick_editable_id).innerHTML = menu_title


    var splitted_input = document.getElementById("quick_hidden_input_" + current_quick_editable_index).value.split(",")
    var merged_input = splitted_input[0] + "," + splitted_input[1] + "," + splitted_input[2] + "," + menu_title + "," + splitted_input[4] + "," + splitted_input[5]

    document.getElementById("quick_hidden_input_" + current_quick_editable_index).value = merged_input

}

//----Quick Menu intent---------


function set_quick_intent_val(element, intent_pk_param, intent_name_param) {
    var doc = new DOMParser().parseFromString(element.innerHTML + "", "text/html")
    var intent_name = intent_name_param
    var intent_pk = intent_pk_param
    var val_tag = intent_name + "-" + intent_pk
    if (val_tag.trim() == "-") {
        $('#edit-quick-intent').val("Intent Name-1883");
        $('#edit-quick-intent').trigger('change');
    } else if (val_tag == "nil-1883") {
        $('#edit-quick-intent').val("Intent Name-1883");
        $('#edit-quick-intent').trigger('change');
    } else {
        $('#edit-quick-intent').val(val_tag);
        $('#edit-quick-intent').trigger('change');
    }

    current_quick_editable_id = element.querySelectorAll("input")[0].id + ""
    current_quick_editable_index = current_quick_editable_id.split("_")[current_quick_editable_id.split("_").length - 1]
}

function cancel_quick_intent_edit_window() {

    $('#edit-quick-intent').val("Contact Customer Care-181");
    $('#edit-quick-intent').trigger('change');
}

function save_quick_intent_edit_window(element) {
    var intent = document.getElementById("edit-quick-intent").value
    var intent_name = intent.split("-")[0]
    var intent_pk = intent.split("-")[1]
    if (intent_name == "" || intent_name == "Intent Name") {
        M.toast({
            "html": "Please enter a valid intent"
        });
        return;
    }

    document.getElementById(current_quick_editable_id).checked = 'true'

    var splitted_input = document.getElementById("quick_hidden_input_" + current_quick_editable_index).value.split(",")
    var merged_input = splitted_input[0] + "," + intent_pk + "," + splitted_input[2] + "," + splitted_input[3] + "," + intent_name + "," + "nil"

    $('#quick_label_intent_' + current_quick_editable_index).click(function () {
        set_quick_intent_val(document.getElementById('quick_label_intent_' + current_quick_editable_index), intent_pk, intent_name)
    });
    document.getElementById("quick_hidden_input_" + current_quick_editable_index).value = merged_input

}


//----Quick Menu link---------


function set_quick_link_val(element, link) {
    var doc = new DOMParser().parseFromString(element.innerHTML + "", "text/html")

    if (link == "nil")
        link = ""

    $('#edit-quick-link').val(link);

    current_quick_editable_id = element.querySelectorAll("input")[0].id + ""
    current_quick_editable_index = current_quick_editable_id.split("_")[current_quick_editable_id.split("_").length - 1]
}

function cancel_quick_link_edit_window() {
    $('#edit-quick-link').val("");

}

function save_quick_link_edit_window(element) {
    var link = document.getElementById("edit-quick-link").value

    if (link == "") {
        M.toast({
            "html": "Please enter a valid link"
        });
        return;

    }

    var pattern = /^((http|https|ftp):\/\/)/;
    if (!pattern.test(link)) {
        M.toast({
            "html": "Please enter valid redirect url."
        }, 2000);
        return;
    }

    document.getElementById(current_quick_editable_id).checked = 'true'
    var splitted_input = document.getElementById("quick_hidden_input_" + current_quick_editable_index).value.split(",")
    var merged_input = splitted_input[0] + "," + "1883" + "," + splitted_input[2] + "," + splitted_input[3] + "," + "Intent Name" + "," + link

    $('#quick_label_link_' + current_quick_editable_index).click(function () {
        set_quick_link_val(document.getElementById('quick_label_link_' + current_quick_editable_index), link)
    });

    document.getElementById("quick_hidden_input_" + current_quick_editable_index).value = merged_input

}

//------Quick Menu delete item------
function delete_quick_container(pk) {

    document.getElementById("quick-item_" + pk).style.display = "none"
    var temp_val = document.getElementById("quick_hidden_input_" + pk).value
    temp_val = temp_val + ",deleted"
    document.getElementById("quick_hidden_input_" + pk).value = temp_val


}

function add_quick_menu_item() {
    let intent = "null"
    let link = "null"
    let intent_name = "null";
    let intent_pk = "null";
    let icon_name = document.getElementById('icon-name-quick').value;
    let menu_title = document.getElementById('menu-title-quick').value;

    if (icon_name == "") {
        M.toast({
            "html": "Select an icon"
        });
        return;
    }

    if (menu_title == "") {
        M.toast({
            "html": "Please add Menu Title"
        });
        return;
    }

    if (current_quick_type == "Intent") {
        intent = document.getElementById('intents-quick').value;
        if (intent == "") {
            var e = document.getElementById("intents-quick");
            intent = e.options[0].value;
            if (intent == "") {
                M.toast({
                    "html": "Please select a valid intent"
                });
                return;
            }
        }

        intent = intent.split('-');
        intent_name = intent[0];
        intent_pk = intent[1];
    } else {
        link = document.getElementById('link-quick').value;
        if (link == "") {
            M.toast({
                "html": "Enter a link"
            });
            return;
        }

        var pattern = /^((http|https|ftp):\/\/)/;
        if (!pattern.test(link)) {
            M.toast({
                "html": "Please enter valid redirect url."
            }, 2000);
            return;
        }
    }

    var elements = document.querySelectorAll('.quick-menu-item > input');
    var editable_index = 0;
    var upload_place = -1;
    var flag = 0
    for (element of elements) {
        let intent = element.value;
        intent = intent.split(',');
        const menu_title_current = intent[3];
        if (menu_title_current == menu_title) {
            M.toast({
                "html": "Item already exists in menu"
            });
            return;
        } else {

            if (menu_title_current == "Menu Title") {
                flag = 1;
                upload_place = intent[0]
                break;
            }

            editable_index++;


        }
    }
    editable_index = editable_index + 1;
    if (upload_place != -1) {
        editable_index = upload_place
    }

    var html = '<div class="quick-menu-item ui-state-default" id="quick-item_' + editable_index +
        '" >\
                                            <div class="hamburger-category-icon">\
                                            <div  data-target="modal-edit-quick-menu-image" \
                                            style="padding: 5px; cursor: pointer; position: relative;\
                                            height: 50px;\
                                            width: 50px;\
                                            overflow: visible;" \
                                            class="modal-trigger" onclick="set_quick_icon_val(this,\'quick-icon_' + editable_index + '\')">\
                                            <img id="quick-icon_' + editable_index + '" class="responsive-img material-icons prefix" style="width: 40px;height: 40px; position: absolute;\
                                                        top: 50%;\
                                                        left: 50%;\
                                                        transform: translate(-50%, -50%);" src = "' + current_quick_img_src + '"> \
                             </div>\
                                            <a onclick="delete_quick_container(' + editable_index + ')"><i class="material-icons red-text text-darken-3 hamburger-delete-tile-btn" id="quick-delete_' + editable_index + '">delete</i></a>\
                                            </div>\
                                            <div class="hamburger-category-title">\
                                                <span data-target="modal-edit-quick-category-tile-title" class=" modal-trigger" id="quick-menu-title_' + editable_index + '" onclick="set_quick_menu_title_val(this)" >' +
        menu_title +
        '</span>\
                                            </div>'
    var radio_target = ""
    if (link + "" == "null") {
        radio_target = '<div class="hamburger-category-radio-btn">\
                                            <label data-target="modal-edit-quick-category-tile-intent"id="quick_label_intent_' + editable_index + '" class="modal-trigger" onclick="set_quick_intent_val(this,\'' + intent_pk + '\' ,\'' + intent_name + '\')" >\
                                                  <input class="with-gap" name="category-group11_' + editable_index + '" type="radio" id="quick-intent_' + editable_index + '" checked/>\
                                                  <span>Intent</span>\
                                              </label>\
                                                <label data-target="modal-edit-quick-category-tile-link" id="quick_label_link_' + editable_index + '" class="modal-trigger" onclick="set_quick_link_val(this,\'\')">\
                                                  <input class="with-gap" name="category-group11_' + editable_index + '" type="radio" id="quick-link_' + editable_index + '" />\
                                                  <span>Link</span>\
                                              </label>\
                                          </div>\
                                          <input type="hidden" id = "quick_hidden_input_' + editable_index + '" value = "' + editable_index + ',' + intent_pk + ',' + current_quick_img_src + ',' + menu_title + ',' + intent_name + ',nil' + '">\
                                            </div>'
        html = html + radio_target
    } else {
        radio_target = '<div class="hamburger-category-radio-btn">\
                                            <label data-target="modal-edit-quick-category-tile-intent" id="quick_label_intent_' + editable_index + '" class="modal-trigger" onclick="set_quick_intent_val(this,\'1883\',\'Intent Name\')">\
                                                  <input class="with-gap" name="category-group11_' + editable_index + '" type="radio" id="quick-intent_' + editable_index + '" />\
                                                  <span>Intent</span>\
                                              </label>\
                                                <label data-target="modal-edit-quick-category-tile-link" id="quick_label_link_' + editable_index + '" class="modal-trigger" onclick="set_quick_link_val(this, \'' + link + '\')">\
                                                  <input class="with-gap" name="category-group11_' + editable_index + '" type="radio" id="quick-link_' + editable_index + '" checked/>\
                                                  <span>Link</span>\
                                              </label>\
                                          </div>\
                                          <input type="hidden" id = "quick_hidden_input_' + editable_index + '" value = "' + editable_index + ',' + 1883 + ',' + current_quick_img_src + ',' + menu_title + ',nil,' + link + '">\
                                            </div>'

        html = html + radio_target
    }
    if (flag == 0)
        $('#quick-menu-container').append(html);
    else {
        var doc = new DOMParser().parseFromString(html, "text/html")
        document.getElementById('quick-item_' + editable_index).innerHTML = doc.getElementById('quick-item_' + editable_index).innerHTML
    }

    document.getElementById('icon-name-quick').value = ""
    document.getElementById('menu-title-quick').value = ""
    document.getElementById('intents-quick').value = ""
    document.getElementById('link-quick').value = ""
    $("#quick_menu_preview_image").attr("src", "")
    current_quick_img_src = ""
    document.getElementById('quick-link-format').checked = "true"
    document.getElementById('quick-sticky-intents').style.display = 'none';
    document.getElementById('quick-sticky-link').style.display = 'block';
    current_quick_type = "Link"

}

//-------Quick Menu Funtion End----

function add_sticky_menu_intent() {
    let intent = document.getElementById('select-sticky-intent-list').value;
    const icon_name = document.getElementById('sticky-intent-icon-name').value;

    if (intent.trim() == "") {
        M.toast({
            "html": "Select an intent"
        });
        return;
    }

    if (icon_name.trim() == "") {
        M.toast({
            "html": "Select an icon"
        });
        return;
    }

    intent = intent.split('-');
    var length = intent.length
    const intent_name = intent.slice(0, length - 1).join('-');
    const intent_pk = intent[length - 1];

    var elements = document.querySelectorAll('.sticky-intent-menu-item-div > input');

    for (element of elements) {
        let intent = element.value;
        intent = intent.split('_');
        const el_intent_pk = intent[0];

        if (el_intent_pk == intent_pk) {
            M.toast({
                "html": "Sticky intent already exists in menu"
            });
            return;
        }
    }

    let last_sticky_intent = document.getElementsByClassName('sticky-intent-menu-item-div')[document.getElementsByClassName('sticky-intent-menu-item-div').length - 2];

    var last_sticky_intent_id;
    if (last_sticky_intent == undefined) {
        last_sticky_intent_id = 1;
    } else {
        last_sticky_intent_id = last_sticky_intent.id.split('_')[1];
        last_sticky_intent_id = parseInt(last_sticky_intent_id) + 1;
    }

    const html = '<div class="sticky-intent-menu-item-div" id="menu-item_' + last_sticky_intent_id + '" style="display: flex; flex-direction: column; align-items: center; justify-content: center;">\
                                <div class="sticky-intent-menu-delete-div" onclick="remove_sticky_menu_item(this)">\
                                    <img src="/static/EasyChatApp/img/close_btn_sticky.svg">\
                                </div>\
                            <div>\
                                <a href="#modal-select-sticky-intent" class="modal-trigger" onclick="edit_selected_sticky_intent(this)">\
                                    <i class="fa ' + icon_name + '" aria-hidden="true" style = "font-size: 1.5em"></i>\
                                </a>\
                            </div>\
                        <div style="text-align: center;" class="sticky-intent-menu-text-div"><p class="sticky-intent-menu-text" style="margin: 0; font-size: 100%">' + intent_name + '</p></div>\
                        <input type="hidden" value = "' + intent_pk + '_' + icon_name + '_' + intent_name + '"  ></div>'

    $('#channel-sticky-intents-menu-list').prepend(html);
}

function edit_sticky_menu_intent(elem) {
    let intent = document.getElementById('select-sticky-intent-list').value;
    const icon_name = document.getElementById('sticky-intent-icon-name').value;
    if (intent == "") {
        M.toast({
            "html": "Select an intent"
        });
        return;
    }

    if (icon_name == "") {
        M.toast({
            "html": "Select an icon"
        });
        return;
    }

    intent = intent.split('-');
    var length = intent.length
    const intent_name = intent.slice(0, length - 1).join('-');
    const intent_pk = intent[length - 1];

    let selected_intent_pk = elem.dataset.elementEdited;
    var elements = document.querySelectorAll('.sticky-intent-menu-item-div > input');
    let parentElem;
    for (element of elements) {
        let intent = element.value;
        intent = intent.split('_');
        const el_intent_pk = intent[0];

        if (intent_pk == el_intent_pk && intent_pk != selected_intent_pk) {
            M.toast({
                "html": "Sticky intent already exists in menu"
            });
            return;
        }

        if (selected_intent_pk == el_intent_pk) {
            parentElem = element.parentElement;
            break;
        }
    }

    const html = '<div class="sticky-intent-menu-delete-div" onclick="remove_sticky_menu_item(this)">\
                                    <img src="/static/EasyChatApp/img/close_btn_sticky.svg">\
                                </div>\
                            <div>\
                                <a href="#modal-select-sticky-intent" class="modal-trigger" onclick="edit_selected_sticky_intent(this)">\
                                    <i class="fa ' + icon_name + '" aria-hidden="true" style = "font-size: 1.5em"></i>\
                                </a>\
                            </div>\
                        <div style="text-align: center;" class="sticky-intent-menu-text-div"><p class="sticky-intent-menu-text" style="margin: 0; font-size:100%;">' + intent_name + '</p></div>\
                        <input type="hidden" value = "' + intent_pk + '_' + icon_name + '_' + intent_name + '"  >';

    parentElem.innerHTML = html;
}

function remove_sticky_menu_item(elem) {
    elem.parentElement.remove();
}

/* Sticky intent menu functions ends here */

function check_bot_usage_config() {
    active_hours_start = Math.round($("#active_hours_start").val())
    active_hours_end = Math.round($("#active_hours_end").val())

    if (active_hours_start == undefined || active_hours_start == "" || active_hours_start < 0 || active_hours_start > 24) {

        alert("Kindly enter a valid starting active hour")
        return true;
    }
    if (active_hours_end == undefined || active_hours_end == "" || active_hours_end < 0 || active_hours_end > 24) {

        alert("Kindly enter a valid Ending active hour")
        return true;
    }

    email_addr_list = []
    var email_addr_chip_elmts = M.Chips.getInstance($('#analytics-monitoring-email-address')).chipsData;
    for (var i = 0; i < email_addr_chip_elmts.length; i++) {

        email_addr_list.push(email_addr_chip_elmts[i]["tag"]);
    }
    if (!email_addr_list.length) {

        alert("Kindly enter an Email ID to proceed")
        return true;
    }
    for (var i = 0; i < email_addr_list.length; i++) {
        if (!validateEmailAddr(email_addr_list[i])) {
            alert("Please provide valid Email ID")
            return true;
        }
    }

    analytics_monitoring_msg_limit = $("#analytics-monitoring-message-limit").val()
    if (analytics_monitoring_msg_limit == undefined || analytics_monitoring_msg_limit == "" || analytics_monitoring_msg_limit <= 0) {

        alert("Kindly enter a valid expected no of messages")
        return true;
    }
    analytics_monitoring_consecutive_hrs = $("#analytics-monitoring-consecutive-hrs").val()
    if (analytics_monitoring_consecutive_hrs == undefined || analytics_monitoring_consecutive_hrs == "" || analytics_monitoring_consecutive_hrs <= 0) {

        alert("Kindly enter a valid no of consecutive hours")
        return true;
    }
    return false;
}

function check_api_config() {
    mail_sender_time_interval = $("#mail_sender_time_interval_input").val()
    if (mail_sender_time_interval == undefined || mail_sender_time_interval == "" || mail_sender_time_interval < 0) {

        alert("Kindly enter a valid time interval")
        return true;
    }

    email_addr_list = []
    var email_addr_chip_elmts = M.Chips.getInstance($('#api-fail-email-config-email-address')).chipsData;
    for (var i = 0; i < email_addr_chip_elmts.length; i++) {

        email_addr_list.push(email_addr_chip_elmts[i]["tag"]);
    }
    if (!email_addr_list.length) {

        alert("Kindly enter an Email ID to proceed")
        return true;
    }
    for (var i = 0; i < email_addr_list.length; i++) {
        if (!validateEmailAddr(email_addr_list[i])) {
            alert("Please provide valid Email ID")
            return true;
        }
    }
    return false
}

function insertAtCursor(myField, myValue) {
    //IE support
    if (document.selection) {
        myField.focus();
        sel = document.selection.createRange();
        sel.text = myValue;
    }
    //MOZILLA and others
    else if (myField.selectionStart || myField.selectionStart == '0') {
        var startPos = myField.selectionStart;
        var endPos = myField.selectionEnd;
        myField.value = myField.value.substring(0, startPos) +
            myValue +
            myField.value.substring(endPos, myField.value.length);
    } else {
        myField.value += myValue;
    }
}

// $(document).on("click", ".add-api-variable", function(e) {

//     if (window.location.href.indexOf("/edit-intent/") != -1 || window.location.href.indexOf("/create-intent/") != -1) {
//         $("#intent-bot-response-collapsible").collapsible("open");
//         var api_variable_name = this.id.split("-")[1];
//         // var v = CKEDITOR.instances['intent_bot_response_text_text'].getData();
//         var v = tinymce.get('intent_bot_response_text_text').getContent();
//         var cursorPos = CKEDITOR.instances['intent_bot_response_text_text'].getSelection().getRanges()[0].startOffset;

//         var textBefore = v.substring(0, cursorPos);
//         var textAfter = v.substring(cursorPos, v.length);
//         tinymce.get('intent_bot_response_text_text').setContent(textBefore + " {/" + api_variable_name + "/} " + textAfter)
//         // CKEDITOR.instances['intent_bot_response_text_text'].setData(textBefore + " {/" + api_variable_name + "/} " + textAfter);
//     } else if (window.location.href.indexOf("/edit-tree/") != -1) {
//         $("#tree-bot-response-collapsible").collapsible("open");
//         var api_variable_name = this.id.split("-")[1];
//         var v = $('#tree_bot_response_text_text').val();
//         var cursorPos = $('#tree_bot_response_text_text').prop('selectionStart');
//         var textBefore = v.substring(0, cursorPos);
//         var textAfter = v.substring(cursorPos, v.length);
//         $('#tree_bot_response_text_text').val(textBefore + " {/" + api_variable_name + "/} " + textAfter);
//     }
// });

// $(document).on("keyup", "#api_variable_search", function(e) {
//     var user_search_variable = $("#api_variable_search").val();
//     user_search_variable = user_search_variable.toUpperCase()
//     $('.add-api-variable').each(function(e) {
//         var api_variable_name = $("#" + this.id).html();
//         if (api_variable_name.toUpperCase().indexOf(user_search_variable) > -1) {
//             $("#" + this.id).show();
//         } else {
//             $("#" + this.id).hide();
//         }
//     });
// });

$(document).on("click", ".btn-share-api", function (e) {
    var api_alias_name = this.id.split("-")[3];
    var user_id_list = $("#multiple-select-user-list").val();

    json_string = JSON.stringify({
        "api_alias_name": api_alias_name,
        "user_id_list": user_id_list
    });
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/api/share/",
        type: "POST",
        headers: {
            "X-CSRFToken": get_csrf_token()
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "API shared successfully."
                }, 2000);
            } else {
                M.toast({
                    "html": "Unable to share bot. Please try again later."
                }, 2000);
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        }
    });
});


function format_time(seconds) {
    var minutes, hours, time = '';
    if (seconds > 60) {
        minutes = parseInt(seconds / 60);
        seconds = seconds - (minutes * 60);

        if (minutes > 60) {
            hours = parseInt(minutes / 60);
            minutes = minutes - (hours * 60);

            time = hours + ' hr ';
        }

        time += minutes + ' min ';
    }

    time += seconds + ' sec ';

    return time;
}

function renderTestSentences() {

    $.ajax({
        url: '/chat/get-test-sentences/',
        type: 'POST',
        data: {},
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] != 200) {
                console.log("Report this error: test sentences are not rendering",)
                return;
            }

            intent_list = response['intent_list']
            sentence_list = response['sentence_list']
            is_active_list = response['is_active_list']
            test_sentence_pk_list = response['test_sentence_pk_list']

            var html_table = `

      <table id="test-cases-info-table" class="striped highlight responsive-table white" style="margin-top:2%;">
        <thead>
          <tr>
            <th>Sentence</th>
            <th>Correct Intent</th>
            <th>Active</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody>`;

            for (var i = intent_list.length - 1; i >= 0; i--) {
                intent_name = intent_list[i]["name"];
                sentence = sentence_list[i]
                is_active =
                    `
                  <label>
                  <input type="checkbox" id='checkbox__` + test_sentence_pk_list[i] + `__` + sentence_list[i] + `'  checked='checked'  />
                  <span></span>
                  </label>
                `


                if (!is_active_list[i]) {
                    is_active =
                        `
                  <label>
                  <input type="checkbox" id='checkbox__` + test_sentence_pk_list[i] + `__` + sentence_list[i] + `'  />
                  <span></span>
                  </label>
                `
                }
                html_table += `<tr>
            <td>` + sentence + `</td>
            <td>` + intent_name + `</td>
            <td>` + is_active + `</td>
            <td>` + `

              <a href="#test_sentence_modal_` + i + `" class="modal-trigger btn-floating btn-medium waves-effect waves-light white"><i class="material-icons deep-purple-text">delete</i></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

            </td>
          </tr>
                    <!-- Modal Structure -->
          <div id="test_sentence_modal_` + i + `" class="modal">
            <div class="modal-content">
            <h4>Are you sure?</h4>
            <p>Selected Test Sentence will be deleted permanently?</p>
            </div>
            <div class="modal-footer">
            <a href="/chat/delete-test-sentence/` + test_sentence_pk_list[i] + `/` + sentence_list[i] + `" class="modal-close waves-effect waves-green btn-flat red darken-3 white-text">Agree</a>
            </div>
          </div>`
            }

            html_table += `</tbody>
      </table>`;

            $("#test-cases-table-container").html(html_table);
        },
        error: function (e) {

        }
    })

}

$(document).on("click", 'input[type="checkbox"]', function (e) {
    id = $(this).attr('id');
    if (id == undefined) {
        return;
    }
    if (id.split('__').length != 3) {
        return;
    }

    id_arr = id.split('__');
    test_sentence_pk = id_arr[1];
    sentence = id_arr[2]
    is_active = false

    if ($(this).prop("checked") == true) {
        is_active = true
    } else if ($(this).prop("checked") == false) { }
    var json_string = JSON.stringify({
        test_sentence_pk: test_sentence_pk,
        sentence: sentence,
        is_active: is_active,
    })
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/set-test-sentence-active/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                if (is_active) {
                    is_active = 'active';
                } else {
                    is_active = "not active"
                }
                M.toast({
                    "html": "Sentence is changed to " + is_active
                }, 2000);
            } else {
                M.toast({
                    "html": "Something went wrong. Please try again"
                }, 2000);
            }
        },
        error: function (e) { }
    });
});


if (window.location.pathname == "/chat/test-chatbot/") {

    renderTestSentences();
}

$(document).on("click", "#add_test_sentence", function (e) {
    e.preventDefault();
    var sentence = $("#sentence").val();
    var value = $("#selected_option option:selected").val()
    intent_pk = value.split('_')[1]
    if (sentence == "") {
        M.toast({
            'html': "Please enter the sentence"
        }, 2000);
        return
    }
    if (value == "") {
        M.toast({
            'html': "Please select the Intent"
        }, 2000);
        return
    }
    var json_string = JSON.stringify({
        sentence: sentence,
        intent_pk: intent_pk,
    })
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/add-test-sentence/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            // $('.indeterminate').hide();
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response['status'] == 200) {
                M.toast({
                    'html': "Sentence added"
                }, 2000);
                window.location.reload()
            } else if (response['status'] == 300) {
                M.toast({
                    'html': response["message"]
                }, 2000);
            } else {
                M.toast({
                    'html': "Something went wrong"
                }, 2000);
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });

});


function loadTemplateSentences() {
    template_sentences_list = [];

    $.ajax({
        url: "/chat/training-sentence-templates/",
        type: "POST",
        data: {},
        success: function (response) {
            // $('.indeterminate').hide();
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response['status'] == 200) {

                html = `<div class="input-field"  style="">
        <select id="selected_template_option" style="">
          <option value="" selected>Choose template</option>`;

                template_sentences_list = JSON.parse(response['sentence_list'])
                for (var i = 0; i < template_sentences_list.length; i++) {
                    html += `<option value="template_` + i + `">` + template_sentences_list[i][0][0] + `</option>`
                }

                html += `
        </select>
        </div>
      `
                $(html).appendTo($("#template_content"));
                //$('select').formSelect();
                $('#selected_template_option').on('change', function () {

                    var value = $("#selected_template_option option:selected").val()
                    if (value == "") {
                        $("#template-var-div").html("")
                        return
                    }
                    index = value.split('_')[1]
                    if (index == "") {
                        return
                    }
                    no_var_per_template = template_sentences_list[index][1]
                    temp_vars = ['X', 'Y', 'Z']
                    html = ""
                    for (var i = 0; i < no_var_per_template; i++) {
                        html +=
                            `<div class="input-field col s6">
            <input id="template_word_` + temp_vars[i] + `" type="text" class="validate">
            <label for="template_word">Enter the value of ` + temp_vars[i] + `</label>
          </div>`
                    }
                    $("#template-var-div").html(html)
                });
            } else if (response['status'] == 300) {
                M.toast({
                    'html': response["message"]
                }, 2000);
            } else {
                M.toast({
                    'html': "Something went wrong"
                }, 2000);
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });

}
$(document).on("click", "#add_training_sentences_btn", function (e) {
    e.preventDefault();
    var value = $("#selected_template_option option:selected").val()
    index = value.split('_')[1]
    if (index == "") {
        M.toast({
            'html': "Please select the Training Template"
        }, 2000);
        return
    }

    template_sentence_list = template_sentences_list[index][0]
    no_var_per_template = template_sentences_list[index][1]
    temp_vars = ['X', 'Y', 'Z']

    for (var i = 0; i < template_sentence_list.length; i++) {
        sentence_value = template_sentence_list[i]
        for (var j = 0; j < no_var_per_template; j++) {
            var word = $("#template_word_" + temp_vars[j]).val();
            if (word == "") {
                M.toast({
                    'html': "Please enter the word"
                }, 2000);
                return
            }
            sentence_value = sentence_value.replace(temp_vars[j], word)
        }
        addIntentTrainingDataIntoCollection(sentence_value);
        $("#add_enter_intent_training_data").val("");
    }
});

var upload_file_limit_size = 5120000
var uploaded_file = []
$(document).on("click", "#upload-bot-image", function (e) {
    e.preventDefault();
    var input_upload_image = ($("#input_upload_bot_image"))[0].files[0]

    if (input_upload_image == null || input_upload_image == undefined) {
        M.toast({
            "html": "Please select a file."
        }, 2000);

        setTimeout(function () {
            $('#modal-upload-bot-image').modal('open');
        }, 200);
        return false;
    }
    if (input_upload_image.size > upload_file_limit_size) {
        M.toast({
            "html": "Size limit exceed(should be less than 5 MB)."
        }, 2000);

        setTimeout(function () {
            $('#modal-upload-image').modal('open');
        }, 200);
        return;
    }

    if (check_malicious_file(input_upload_image.name) == true) {
        setTimeout(function () {
            $('#modal-upload-bot-image').modal('open');
        }, 200);
        return false;
    }

    var reader = new FileReader();
    reader.readAsDataURL(input_upload_image);
    reader.onload = function () {

        base64_str = reader.result.split(",")[1];

        uploaded_file = [];
        uploaded_file.push({
            "filename": input_upload_image.name,
            "base64_file": base64_str,
        });

        upload_bot_image();
    };

    reader.onerror = function (error) {
        console.log('Error: ', error);
    };
});

var upload_logo_file_limit_size = 200000
$(document).on("click", "#upload-bot-logo", function (e) {
    e.preventDefault();
    var input_upload_logo = ($("#input_upload_bot_logo"))[0].files[0]
    document.getElementById('upload-bot-logo').disabled = true;

    if (input_upload_logo == null || input_upload_logo == undefined) {
        M.toast({
            "html": "Please select a file."
        }, 2000);

        document.getElementById('bot-logo-file-size-warning').innerHTML = "Please select a file.";
        document.getElementById('upload-bot-logo').disabled = false;
        document.getElementById('input_upload_bot_logo2').value = "";
        document.getElementById('input_upload_bot_logo').value = "";
        return false;
    }
    if (input_upload_logo.size > upload_logo_file_limit_size) {
        M.toast({
            "html": "Your file size is greater than 200 KB. For best performance, please upload a logo having size < 200 KB."
        }, 2000);

        document.getElementById('bot-logo-file-size-warning').innerHTML = "Your file size is greater than 200 KB. For best performance, please upload a logo having size < 200 KB.";
        document.getElementById('upload-bot-logo').disabled = false;
        document.getElementById('input_upload_bot_logo2').value = "";
        document.getElementById('input_upload_bot_logo').value = "";
        return;
    }

    if (check_malicious_file(input_upload_logo.name) == true) {
        document.getElementById('bot-logo-file-size-warning').innerHTML = "Please select a valid file.";
        document.getElementById('upload-bot-logo').disabled = false;
        document.getElementById('input_upload_bot_logo2').value = "";
        document.getElementById('input_upload_bot_logo').value = "";
        return false;
    }

    var reader = new FileReader();
    reader.readAsDataURL(input_upload_logo);
    reader.onload = function () {

        base64_str = reader.result.split(",")[1];

        uploaded_file = [];
        uploaded_file.push({
            "filename": input_upload_logo.name,
            "base64_file": base64_str,
        });

        upload_bot_logo();
    };

    reader.onerror = function (error) {
        console.log('Error: ', error);
    };
});

async function upload_bot_image() {
    var response = await upload_image();

    if (response && response.status == 200) {
        src = window.location.origin + response.src
        var json_string = JSON.stringify({
            src: response.src,
            bot_id: window.location.href.split("=").pop(),
        })
        json_string = EncryptVariable(json_string);
        json_string = encodeURIComponent(json_string);
        var params = 'json_string=' + json_string
        $.ajax({
            url: "/chat/save-bot-image/",
            type: "POST",
            headers: {
                'X-CSRFToken': get_csrf_token()
            },
            data: params,
            success: function (response) {
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response.status == 200) {
                    document.getElementById('input_upload_bot_image2').value = "";
                    M.toast({
                        "html": "Image Uploaded Successfully."
                    }, 2000)
                    window.location.reload();
                } else if(response.status == 401) {
                    M.toast({
                        "html": response.message
                    }, 2000)
                }
                else {
                    M.toast({
                        "html": "File format is Invalid"
                    }, 2000)
                }
            },
            error: function (xhr, textstatus, errorthrown) { }
        });
    }
}

async function upload_bot_logo() {
    var response = await upload_image();

    if (response && response.status == 200) {
        src = window.location.origin + response.src
        var json_string = JSON.stringify({
            src: response.src,
            bot_id: window.location.href.split("=").pop(),
        })
        json_string = EncryptVariable(json_string);
        json_string = encodeURIComponent(json_string);
        var params = 'json_string=' + json_string

        $.ajax({
            url: "/chat/save-bot-logo/",
            type: "POST",
            data: params,
            success: function (response) {
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response.status == 200) {
                    document.getElementById('input_upload_bot_logo2').value = "";
                    M.toast({
                        "html": "Bot Logo Uploaded Successfully."
                    }, 2000)
                    document.getElementById('upload-bot-logo').disabled = false;
                    $('#modal-upload-bot-logo').modal('close');
                    window.location.reload();
                } else {
                    M.toast({
                        "html": "File format is Invalid"
                    }, 2000)
                    document.getElementById('bot-logo-file-size-warning').innerHTML = "File format is invalid.";
                    document.getElementById('upload-bot-logo').disabled = false;
                    document.getElementById('input_upload_bot_logo2').value = "";
                    document.getElementById('input_upload_bot_logo').value = "";
                }
            },
            error: function (xhr, textstatus, errorthrown) { }
        });
    }
}

function upload_file_card() {
    return new Promise(function (resolve, reject) {
        let csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
        let json_string = JSON.stringify(uploaded_file)
        json_string = EncryptVariable(json_string)

        encrypted_data = {
            "Request": json_string
        }

        var params = JSON.stringify(encrypted_data);

        $.ajax({
            url: "/chat/upload-file-card/",
            type: "POST",
            contentType: "application/json",
            headers: {
                'X-CSRFToken': csrf_token
            },
            data: params,
            processData: false,
            success: function (response) {
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response.status == 200) {
                    resolve(response);
                } else if (response.status == 300) {
                    M.toast({
                        "html": "File format is Invalid"
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Unable to upload your file. Please try again later."
                    }, 2000)
                }
            },
            error: function (xhr, textstatus, errorthrown) {
                console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
            }
        });
    })
}

function upload_image() {
    return new Promise(function (resolve, reject) {
        var csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
        var json_string = JSON.stringify(uploaded_file)
        json_string = EncryptVariable(json_string)

        encrypted_data = {
            "Request": json_string
        }

        var params = JSON.stringify(encrypted_data);

        $.ajax({
            url: "/chat/upload-image/",
            type: "POST",
            contentType: "application/json",
            headers: {
                'X-CSRFToken': csrf_token
            },
            data: params,
            processData: false,
            success: function (response) {
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response.status == 200) {
                    resolve(response);
                } else if (response.status == 300) {
                    M.toast({
                        "html": "File format is Invalid"
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Unable to upload your file. Please try again later."
                    }, 2000)
                }
            },
            error: function (xhr, textstatus, errorthrown) {
                console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
            }
        });
    })
}

$(document).on("click", "#upload-bot-message-image", function (e) {
    e.preventDefault();
    var input_upload_image = ($("#input_upload_bot_message_image"))[0].files[0]

    if (input_upload_image == null || input_upload_image == undefined) {
        M.toast({
            "html": "Please select a file."
        }, 2000)

        setTimeout(function () {
            $('#modal-upload-message-image').modal('open');
        }, 200);
        return false;
    }
    if (input_upload_image.size > upload_file_limit_size) {
        M.toast({
            "html": "Size limit exceed(should be less than 5 MB)."
        }, 2000);

        setTimeout(function () {
            $('#modal-upload-image').modal('open');
        }, 200);
        return;
    }

    if (check_malicious_file(input_upload_image.name) == true) {
        setTimeout(function () {
            $('#modal-upload-message-image').modal('open');
        }, 200);
        return false;
    }

    var reader = new FileReader();
    reader.readAsDataURL(input_upload_image);
    reader.onload = function () {

        base64_str = reader.result.split(",")[1];

        uploaded_file = [];
        uploaded_file.push({
            "filename": input_upload_image.name,
            "base64_file": base64_str,
        });

        upload_message_image();
    };

    reader.onerror = function (error) {
        console.log('Error: ', error);
    };
});

async function upload_message_image() {
    var response = await upload_image();

    if (response && response.status == 200) {
        src = window.location.origin + response.src;

        var json_string = JSON.stringify({
            src: response.src,
            bot_id: window.location.href.split("=").pop(),
        })
        json_string = EncryptVariable(json_string);
        json_string = encodeURIComponent(json_string);
        var params = 'json_string=' + json_string

        $.ajax({
            url: "/chat/save-bot-message-image/",
            type: "POST",
            data: params,
            success: function (response) {
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response.status == 200) {
                    document.getElementById('input_upload_bot_message_image2').value = "";
                    M.toast({
                        "html": "Image Uploaded Successfully."
                    }, 2000)
                    window.location.reload();
                } else {
                    M.toast({
                        "html": "File format is Invalid"
                    }, 2000)
                }
            },
            error: function (xhr, textstatus, errorthrown) { }
        });
    }
}


function showAnalyticsPreloader() {
    $("#div-analytics-preloader").show();
    $("#edit_bot_page").hide();
}

function hideAnalyticsPreloader() {
    $("#div-analytics-preloader").hide();
    $("#edit_bot_page").show();
}

$(document).on("click", "#move-to-prod-btn", function (e) {

    $("#move-to-prod-btn").attr("disabled", "disabled");
    // showAnalyticsPreloader();
    bot_id = window.location.pathname.split('/')[4];

    if (isNaN(bot_id)) {
        M.toast({
            "html": "Something went wrong. Please try again"
        });
        return;
    }
    var json_string = JSON.stringify({
        bot_id: bot_id
    })
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/move-bot-to-prod/",
        type: "POST",
        data: {
            json_string: json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Move to production has been started successfully. It may take a while"
                }, 2000);
            } else {
                M.toast({
                    "html": "Something went wrong"
                }, 2000);
            }
            // hideAnalyticsPreloader();
        },
        error: function (e) { }
    })

});

function see_deploy_links() {
    $("#domain_details").show();
    $("#deployment_url").hide();
    $("#stored_deploy_chatbot_link").show();
    $("#deploy_domain").hide();
    $("#create_deploy_links").show();
    $("#save_domain_details").hide();
}

function generate_deployment_url() {
    bot_id = get_url_vars()['id']
    server_url = window.location.origin;
    if (isNaN(bot_id)) {
        M.toast({
            "html": "Something went wrong. Please try again"
        });
        return;
    }
    var json_string = JSON.stringify({
        bot_id: bot_id,
        server_url: server_url
    })
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/deploy-chatbot/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {

                $("#file_path").val(`<script type="text/javascript" src="` + server_url + `/` + response['file_path'] + `"></script>`);
                $("#cjs_file_path").val(server_url + '/' + response['file_path'])
                $("#amp_file_path").val(`<a href="${server_url}/chat/index/?id=${response["bot_id"]}&name=uat&theme=null&easychat_window_location=&form_assist_id=&do_not_disturb=&is_lead_generation=false&lead_generation_intent_id=&page_category=&meta_data=&easychat_intent_name=&is_web_landing_allowed=false&campaign_link_query_id=INTENT_ID&selected_language=en&is_initial_trigger_intent=false&web_page_source=&query_question=INTENT_NAME&external_trigger_info=INTENT_INFO&is_voice_based_form_assist_enabled=false&is_amp_page_request=true&is_first_time_amp_user=true"><img id="allincall-popup" src="${server_url}/get-amp-bot-image/${response["bot_id"]}/" style="position: fixed; cursor: pointer; right: 20px; bottom: 0em; width: 8em; z-index: 2147483647;"></a>`)
            } else {
                M.toast({
                    "html": "Something went wrong"
                }, 2000);
            }
        },
        error: function (e) { }
    })
}

function create_new_deployment() {
    $("#stored_deploy_chatbot_link").hide()
    $("#deploy_domain").show()
    $("#create_deploy_links").hide()
    $("#save_domain_details").show()
}

function save_domain_details() {

    bot_id = get_url_vars()['id']
    if (isNaN(bot_id)) {
        M.toast({
            "html": "Something went wrong. Please try again"
        });
        return;
    }

    $("#domain_details").hide();

    var deployer_name = $("#deployer_name").val();

    domain_list = M.Chips.getInstance($('#domain_name')).chipsData;

    var whitelisted_domain = "";

    for (i = 0; i < domain_list.length; i++) {

        var provided_domain = domain_list[i]["tag"];
        try {
            provided_domain = new URL(provided_domain);
            provided_domain = provided_domain.host;
        } catch (err) { }

        whitelisted_domain += provided_domain + ",";
    }

    if (deployer_name == "" || deployer_name == "undefined" || domain_list == "" || domain_list == "undefined") {
        $("#domain_details").show();
        M.toast({
            "html": "Please enter valid name or domain list"
        }, 2000);
        return;
    }

    $("#preloader-deploy-bot").show();

    var json_string = JSON.stringify({
        customer_name: deployer_name,
        whitelisted_domain: whitelisted_domain,
        bot_id: bot_id
    })

    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/save-deployment-request/",
        type: "POST",
        data: {
            "json_string": json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                generate_deployment_url()
                M.toast({
                    "html": "Added successfully"
                })
                $("#preloader-deploy-bot").hide();

                $("#deployment_url").show();

            } else {
                M.toast({
                    "html": "Some internal error!"
                }, 2000);
            }
        },
        error: function (e) {
            $("#preloader-deploy-bot").hide();

        }
    });

    // console.log(deployer_name);
    // console.log(domain_list);
}


function copyToClipboard(element_id, element) {
    /* Get the text field */
    var copyText = document.getElementById(element_id);
    var mac = navigator.userAgent.match(/Mac|ipad|ipod|iphone/i)
    // handle iOS as a special case
    if (!navigator.clipboard) {
        if (mac && mac.toString().trim() == "Mac") {
            // save current contentEditable/readOnly status
            var editable = copyText.contentEditable;
            var readOnly = copyText.readOnly;

            // convert to editable with readonly to stop iOS keyboard opening
            copyText.contentEditable = true;
            copyText.readOnly = true;

            // create a selectable range
            var range = document.createRange();
            range.selectNodeContents(copyText);

            // select the range
            var selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            copyText.setSelectionRange(0, 999999);

            // restore contentEditable/readOnly to original state
            copyText.contentEditable = editable;
            copyText.readOnly = readOnly;
        } else {
            /* Select the text field */
            copyText.select();
        }
        /* Copy the text inside the text field */
        document.execCommand("copy");
    } else
        navigator.clipboard.writeText(copyText.value)

    element.style.setProperty('background-color', '#038456', 'important');
    element.style.setProperty('color', 'white', 'important');

    element.innerHTML = '<svg width="16" height="16" viewBox="0 0 20 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 10px;">\
                            <path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM15 5L21 11V21C21 22.1 20.1 23 19 23H7.99C6.89 23 6 22.1 6 21L6.01 7C6.01 5.9 6.9 5 8 5H15ZM14 12H19.5L14 6.5V12Z" fill="white"/>\
                            </svg>Copied to clipboard'


    M.toast({
        "html": "Script/Link is copied"
    }, 2000);
    /* Alert the copied text */
}

function add_all_to_recommended_intents() {
    $(".recommended_intents_choice:visible").each(function () {
        x = $("#multiple-select-intent-choice-list option[value=" + $(this).val() + "]")
        $("#multiple-select-intent-choice-list option[value=" + $(this).val() + "]").remove()
        x.appendTo($("#multiple-select-intent-choice-list"))
        $("#multiple-select-intent-choice-list").trigger('change')

        selected_option_list = $('#multiple-select-intent-choice-list').val();
        selected_option_list.push($(this).val())
        $('#multiple-select-intent-choice-list').val(selected_option_list).trigger('change')

        $(this).hide()
    })
    $("#add-all-to-recomdtns-btn").hide()
}

function recommended_intents_mouse_click(intent_elmt) {
    x = $("#multiple-select-intent-choice-list option[value=" + intent_elmt.value + "]")
    $("#multiple-select-intent-choice-list option[value=" + intent_elmt.value + "]").remove()
    x.appendTo($("#multiple-select-intent-choice-list"))
    $("#multiple-select-intent-choice-list").trigger('change')

    selected_option_list = $('#multiple-select-intent-choice-list').val();
    selected_option_list.push(intent_elmt.value)
    $('#multiple-select-intent-choice-list').val(selected_option_list).trigger('change');


    intent_elmt.style.display = "none";
}

$('#multiple-select-intent-choice-list').on('change', function () {
    selected_option_list = $('#multiple-select-intent-choice-list').val();
    if ($(".recommended_intents_choice:visible").length > 0) {
        $("#add-all-to-recomdtns-btn").show()
    } else {
        $("#add-all-to-recomdtns-btn").hide()
    }
    recommended_intents_choice = document.getElementsByClassName("recommended_intents_choice")
    for (var j = 0; j < recommended_intents_choice.length; j++) {
        value = recommended_intents_choice[j].value;
        var is_match = false;
        for (var i = 0; i < selected_option_list.length; i++) {
            selected_option_pk = selected_option_list[i];
            if (String(value) == String(selected_option_pk)) {
                is_match = true;
                break;
            }
        }

        if (!is_match) {
            recommended_intents_choice[j].style.display = "block";
        } else {
            recommended_intents_choice[j].style.display = "none";
        }
    }
    is_quick_recommendation_present = selected_option_list.length ? true : false;
    if(is_quick_recommendation_present || is_child_present || selected_widget != '') {
        $('#checkbox_faq_intent').prop('checked', false);
        $("#checkbox_faq_intent").attr("disabled", "disabled");
    } else {
        $("#checkbox_faq_intent").removeAttr("disabled", "disabled"); 
    }
});

var upload_file_limit_size = 5120000
$(document).on("click", "#upload-bot-welcome-image", function (e) {
    e.preventDefault();
    var input_upload_image = ($("#input_upload_image_bot_welcome_message"))[0].files[0]

    if (input_upload_image == null || input_upload_image == undefined) {
        M.toast({
            "html": "Please select a file."
        }, 2000);

        setTimeout(function () {
            $('#modal-upload-image').modal('open');
        }, 200);
        return false;
    }
    if (input_upload_image.name.match(/\.(jpeg|jpg|gif|png)$/) == null) {
        M.toast({
            "html": "File format is not supported"
        }, 2000);
        setTimeout(function () {
            $('#modal-upload-image').modal('open');
        }, 200);
        return false;
    }
    if (input_upload_image.size > upload_file_limit_size) {
        M.toast({
            "html": "Size limit exceed(should be less than 5 MB)."
        }, 2000);

        setTimeout(function () {
            $('#modal-upload-image').modal('open');
        }, 200);
        return;
    }

    if (check_malicious_file(input_upload_image.name) == true) {
        setTimeout(function () {
            $('#modal-upload-image').modal('open');
        }, 200);
        return false;
    }

    document.getElementById("uploaded-bot-welcome-image").style.display = "none";
    try {
        $("#remove-bot-welcome-image").hide()
    } catch {
        $("#remove-bot-welcome-image").attr("disabled", true);
    }

    var reader = new FileReader();
    reader.readAsDataURL(input_upload_image);
    reader.onload = function () {

        base64_str = reader.result.split(",")[1];

        uploaded_file = [];
        uploaded_file.push({
            "filename": input_upload_image.name,
            "base64_file": base64_str,
        });

        upload_welcome_image();
    };

    reader.onerror = function (error) {
        console.log('Error: ', error);
    };
});

async function upload_welcome_image() {
    var response = await upload_image();

    if (response && response.status == 200) {
        src = response.src;
        compressed_src = response["compressed_image_path"]
        document.getElementById("uploaded-bot-welcome-image").src = src;
        document.getElementById("uploaded-bot-welcome-image").dataset.compressed_src = compressed_src;
        document.getElementById("uploaded-bot-welcome-image").style.display = "inline-block";
        document.getElementById('input_upload_image_bot_welcome_message2').value = "";
        document.getElementById('input_upload_image_bot_welcome_message').value = "";
        try {
            $("#remove-bot-welcome-image").show()
        } catch {
            $("#remove-bot-welcome-image").attr("disabled", false);
        }
    }
}

$(document).on("click", "#remove-bot-welcome-image", function (e) {
    document.getElementById("uploaded-bot-welcome-image").src = "";
    document.getElementById("uploaded-bot-welcome-image").style.display = "none";
    try {
        $("#remove-bot-welcome-image").hide()
    } catch {
        $("#remove-bot-welcome-image").attr("disabled", true);
    }
});

function check_file_extention() {
    var fileElement = document.getElementById("input-upload-files");
    var fileExtension = "";
    if (fileElement.value.lastIndexOf(".") > 0) {
        fileExtension = fileElement.value.substring(fileElement.value.lastIndexOf(".") + 1, fileElement.value.length);
    }

    if (fileExtension.toLowerCase() == "gif") {
        return true;
    } else if (fileExtension.toLowerCase() == "jpg") {
        return true;
    } else if (fileExtension.toLowerCase() == "jpeg") {
        return true;
    } else if (fileExtension.toLowerCase() == "png") {
        return true;
    } else if (fileExtension.toLowerCase() == "pdf") {
        return true;
    } else if (fileExtension.toLowerCase() == "doc") {
        return true;
    } else if (fileExtension.toLowerCase() == "docx") {
        return true;
    } else if (fileExtension.toLowerCase() == "ppt") {
        return true;
    } else if (fileExtension.toLowerCase() == "pptx") {
        return true;
    } else {
        return false;
    }

}

function upload_selected_files_at_drive() {

    var input_uploaded_files = ($("#input-upload-files"))[0].files;

    if (input_uploaded_files.length == 0) {
        M.toast({
            "html": "Please select at least one file to upload."
        }, 2000);
        return;
    }

    if (input_uploaded_files.length > 10) {
        M.toast({
            "html": "At max 10 files are allowed at a time."
        }, 2000);
        return;
    }

    for (var idx = 0; idx < input_uploaded_files.length; idx++) {
        if (check_malicious_file(input_uploaded_files[idx].name)) {
            return;
        }
    }

    file_check = check_file_extention()
    if (file_check == false) {
        M.toast({
            "html": "You can only upload Images, PPTs, Docs, PDFs into EasyChat Drive."
        }, 2000);
        return;
    }

    var formData = new FormData();
    $.each(input_uploaded_files, function (i, file) {
        formData.append("file", file);
    });

    $("#easychat-drive-files-preloader").show();
    $.ajax({
        url: "/chat/upload-files-into-drive/",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
            $("#easychat-drive-files-preloader").hide();
            if (response["status"] == 200) {
                $("#modal-upload-files").modal('close');
                M.toast({
                    "html": "Files Uploaded Successfully!"
                }, 2000);

                setTimeout(function () {
                    window.location.reload();
                }, 1000);
            } else if (response["status"] == 300) {
                M.toast({
                    "html": "Unable to upload files. File format not supported. Please do not use .(dot) in filename except for extension."
                }, 2000);
            } else if (response["status"] == 302) {
                M.toast({
                    "html": response["message"]
                }, 2000);
            } else {
                M.toast({
                    "html": "Unable to upload the files!"
                }, 2000);
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            M.toast({
                "html": "Unable to upload the files! Please check your internet"
            }, 2000);
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
            $("#easychat-drive-files-preloader").hide();
        }
    });
}

function show_intent_upload_button() {
    is_checked = false;
    easychat_drive_file_checkboxes = document.getElementsByClassName("checkbox-easychat-drive-file");
    for (var i = 0; i < easychat_drive_file_checkboxes.length; i++) {
        id = easychat_drive_file_checkboxes[i].id;
        if (document.getElementById(id).checked) {
            is_checked = true;
            break;
        }
    }

    if (is_checked) {
        $("#btn-delete-file-from-drive").show();
        $("#btn-add-files-to-bot").show();
    } else {
        $("#btn-delete-file-from-drive").hide();
        $("#btn-add-files-to-bot").hide();
    }
}

function show_intent_selection_button() {
    is_checked = false;
    easychat_drive_file_checkboxes = document.getElementsByClassName("checkbox-easychat-drive-file");
    for (var i = 0; i < easychat_drive_file_checkboxes.length; i++) {
        id = easychat_drive_file_checkboxes[i].id;
        if (document.getElementById(id).checked) {
            is_checked = true;
            break;
        }
    }

    if (is_checked && ($("#selected-Bot-for-insert-file").val()) != "None") {
        $("#intent-select").show();

        bot_id = $("#selected-Bot-for-insert-file").val();
        var json_string = JSON.stringify({
            bot_id: bot_id
        })
        json_string = EncryptVariable(json_string);

        $.ajax({
            url: "/chat/get-intent-list-drive/",
            type: "POST",
            data: {
                json_string: json_string,
                // "user_id": user_id
            },
            success: function (response) {
                response = custom_decrypt(response)
                response = JSON.parse(response);
                intent_list = response["intent_objs"];
                var intent_html = `<option value="None">Choose intent from following list</option>`;
                for (i = 0; i < intent_list.length; i++) {

                    intent_html += `<option value="` + intent_list[i]["pk"] + `">` + intent_list[i]["name"] + ` </option>`;
                }

                document.getElementById("selected-intent-for-insert-file").innerHTML = intent_html;
                document.getElementById("jstree-drive-data").innerHTML = "";
                $("#selected-intent-for-insert-file").select2({
                    dropdownParent: $("#modal-add-to-bot"),
                    width: "100%",
                });

            },
            error: function (jqXHR, exception) { },
        });

    } else {
        $("#btn-add-files-to-intent").hide();
    }
}

function delete_selected_files_from_drive() {

    file_id_list = [];
    easychat_drive_file_checkboxes = document.getElementsByClassName("checkbox-easychat-drive-file");
    for (var i = 0; i < easychat_drive_file_checkboxes.length; i++) {
        id = easychat_drive_file_checkboxes[i].id;
        if (document.getElementById(id).checked) {
            count_id = id.split("-")[4];
            file_id_list.push(count_id);
        }
    }

    if (file_id_list.length == 0) {
        return;
    }

    json_string = JSON.stringify({
        "file_id_list": file_id_list
    });
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/delete-files-drive/",
        type: "POST",
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Files removed from drive successfully."
                }, 2000);
                setTimeout(function () {
                    window.location.reload();
                }, 1000);
            } else {
                M.toast({
                    "html": "Unable to delete files from the drive."
                }, 2000);
            }
        },
        error: function (jqXHR, exception) { },
    });
}


function search_files_into_drive() {
    var query_value = $("#easychat_drive_search").val();
    easychat_drive_images_name = document.getElementsByClassName("file-name-collection");

    for (var i = 0; i < easychat_drive_images_name.length; i++) {
        id = easychat_drive_images_name[i].id;
        image_count_id = id.split("-")[2];
        document.getElementById("easychat-drive-file-card-container-" + image_count_id).style.display = "block";
    }

    for (var i = 0; i < easychat_drive_images_name.length; i++) {
        id = easychat_drive_images_name[i].id;
        image_count_id = id.split("-")[2];
        media_name = document.getElementById("file-name-" + image_count_id).innerHTML;
        if (media_name.toUpperCase().indexOf(query_value.toUpperCase()) != -1) {
            document.getElementById("easychat-drive-file-card-container-" + image_count_id).style.display = "block";
        } else {
            document.getElementById("easychat-drive-file-card-container-" + image_count_id).style.display = "none";
        }
    }
}

var selected_drive_image_intent_pk = null;
var selected_drive_image_tree_pk = null;
var selected_drive_image_parent_pk = null;

function set_selected_drive_image_for_insert(tree_pk, parent_pk, intent_pk) {
    selected_drive_image_intent_pk = intent_pk;
    selected_drive_image_tree_pk = tree_pk;
    selected_drive_image_parent_pk = parent_pk;
}

function reset_select_to_default(select_element_id) {
    $("#" + select_element_id + " option").prop("selected", function () {
        return this.defaultSelected;
    });
}

function insert_selected_files_into_intent() {

    if (selected_drive_image_tree_pk == null || selected_drive_image_parent_pk == null || selected_drive_image_intent_pk == null) {
        M.toast({
            "html": "Kindly select valid intent or child intent for media file insertion!"
        }, 2000);
        return;
    }

    file_id_list = [];
    easychat_drive_file_checkboxes = document.getElementsByClassName("checkbox-easychat-drive-file");
    for (var i = 0; i < easychat_drive_file_checkboxes.length; i++) {
        id = easychat_drive_file_checkboxes[i].id;
        if (document.getElementById(id).checked) {
            count_id = id.split("-")[4];
            file_id_list.push(count_id);
        }
    }

    if (file_id_list.length == 0) {
        return;
    }

    json_string = JSON.stringify({
        "intent_id": selected_drive_image_intent_pk,
        "tree_id": selected_drive_image_tree_pk,
        "parent_id": selected_drive_image_parent_pk,
        "file_id_list": file_id_list
    });
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/insert-files-intent/",
        type: "POST",
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Files added successfully!"
                }, 2000);
            } else {
                M.toast({
                    "html": "Unable to insert images into selected intent!"
                }, 2000);
            }
            $("#modal-add-to-bot").modal("close");
            reset_select_to_default("selected-Bot-for-insert-file");
            $("#intent-select").hide();
        },
        error: function (jqXHR, exception) {
            console.log(jqXHR, exception);
            $("#modal-add-to-intent").modal("close");
        }
    });

    selected_drive_image_intent_pk = null;
    selected_drive_image_tree_pk = null;
    selected_drive_image_parent_pk = null;
}


function renderRecursiveTreeStructureIntoDrive(subtree, intent_pk, parent_pk) {
    var tree_name = subtree["tree_name"]
    tree_name = tree_name.replace(/<\/?("[^"]*"|'[^']*'|[^>])*(>|$)/g, "");
    var tree_pk = subtree["tree_pk"]
    var key = intent_pk + "_" + parent_pk + "_" + tree_pk

    html = `
    <ul>
      <li>
      <span id="` + key + `">
        <a href="javascript:void(0)" class="black-text" onclick="set_selected_drive_image_for_insert('` + tree_pk + `', '` + parent_pk + `', '` + intent_pk + `')">
        <span id="` + key + `_tree_name_container" value="` + tree_name + `">
          &nbsp;&nbsp;
          ` + tree_name + `
        </span>
        </a>
      </span>`;

    if (!isDictEmpty(subtree["subtree"])) {
        for (var key in subtree["subtree"]) {
            html += renderRecursiveTreeStructureIntoDrive(subtree["subtree"][key], intent_pk, tree_pk);
        }
    }

    html += `</li></ul>`;

    return html;
}

function renderTreeStructureIntoDrive(response, intent_pk) {
    tree_html = renderRecursiveTreeStructureIntoDrive(response["1"], intent_pk, -1);

    $("#easychat-drive-modal-render-tree-structure-container").empty();
    document.getElementById("easychat-drive-modal-render-tree-structure-container").innerHTML = '<div id="jstree-drive-data"></div>';

    $("#jstree-drive-data").empty();
    $("#jstree-drive-data").html(tree_html);
    $('#jstree-drive-data').jstree({
        "core": {
            "themes": {
                "icons": false
            }
        }
    });
    // $("#jstree-drive-data").on("activate_node.jstree", function(e,data){
    //    var href = data.node.text.match(/href="([^"]*)/)[1];
    //    href = href.replace(/amp;/gi, '');
    //    window.location.href = href;
    // });
    $("#jstree-drive-data").jstree("open_all");
}


function show_intent_tree_structure() {
    selected_intent_pk = $("#selected-intent-for-insert-file").val();

    if (selected_intent_pk == "None") {
        M.toast({
            "html": "Please select valid intent."
        }, 2000);
        return;
    }

    response = fetchIntentTreeStructureByIntentID(selected_intent_pk);
    renderTreeStructureIntoDrive(response, selected_intent_pk);
}

// if(window.location.pathname.indexOf("/chat/message-history")!=-1){
//   $(document).ready(function(){
//       $('#message-history-info-table').DataTable({
//           "bPaginate": false
//       });
//   });
// }

// if(window.location.pathname.indexOf("/chat/mis-dashboard")!=-1){
//   $(document).ready(function(){
//       $('#mis-dashboard-info-table').DataTable({
//           "bPaginate": false
//       });
//   });
// }

if (window.location.pathname.indexOf("/chat/easychat-drive") != -1) {
    $(document).ready(function () {
        $('#easychat-drive-file-table').DataTable({
            "bPaginate": false,
            "ordering": false,
        });
    });
}

function validateEmail(emailField) {
    const reg = /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/
    if (reg.test(emailField.value) == false) {
        return false;
    }
    return true;
}

function validateEmailAddr(emailAddress) {
    const reg = /^([A-Za-z0-9_\-\.])+\@([A-Za-z0-9_\-\.])+\.([A-Za-z]{2,4})$/
    if (reg.test(emailAddress) == false) {
        return false;
    }
    return true;
}

$(document).on("click", "#get_data_collect_link", function (e) {
    data_bot_id = $("#select-data-entry-bot").val();
    if (data_bot_id != "None") {
        $("#data-entry-link-input").val(location.origin + "/bot-data-collect/?id=" + data_bot_id)
        $('.modal').modal();
        $("#data-entry-link-modal").modal('open')
    } else {
        alert("Please Select Bot ")
    }
});
$(document).on("click", "#data-collect-entry-delete-selected", function (e) {
    $(".delete_data_collect_entry").attr("id", "none")
    $('.modal').modal();
    $("#delete_data_collect_entry-modal").modal('open')
});

$(document).on("click", ".delete_data_collect_entry", function (e) {
    if ($(this).attr("id") == "none") {
        elements = $(".modify-data-collect-entry-checkbox:checked")
        entry_selected = ""
        for (var i = 0; i < elements.length; i++) {
            entry_selected = entry_selected + "," + elements[i].id.replace("modify-data-collect-entry-checkbox-", "")
        }
        if (entry_selected != "") {
            delete_data_entry_by_id(entry_selected)
        }
    } else {
        entry_selected = $(this).attr("id").replace("delete_entry_pk_", "");
        delete_data_entry_by_id(entry_selected)
    }

});

function delete_data_entry_by_id(entry_id) {

    var json_string = JSON.stringify({
        date_entry_pk: entry_id
    })
    json_string = EncryptVariable(json_string);

    var response = $.ajax({
        url: '/delete-data-collect/',
        type: "POST",
        async: false,
        data: {
            json_string: json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                alert("Entry Deleted!", 2000);
                window.location.reload();
            } else {
                alert("Error", 2000);;
            }
        }
    }).responseJSON;

    return response;
}

$(document).on("click", "#download_excel_data_collect", function (e) {
    data_bot_id = $("#select-data-entry-bot").val();
    var json_string = JSON.stringify({
        bot_id: data_bot_id
    })
    json_string = EncryptVariable(json_string);

    var response = $.ajax({
        url: '/download-excel-data-collect/',
        type: "POST",
        async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                console.log(response)
                var file_url = response["file_url"];
                window.open(file_url)
            } else { }
        }
    }).responseJSON;

});


$(document).on("click", ".delete_data_entry", function (e) {
    data_entry_id = ($(this).attr('id')).replace("entry_", "");
    $(".delete_data_collect_entry").attr("id", "delete_entry_pk_" + data_entry_id)
    $('.modal').modal();

    $("#delete_data_collect_entry-modal").modal('open')
});


$(document).on("click", ".add-data-entry-to-intent", function (e) {
    data_entry_id = ($(this).attr('id')).replace("add-data-entry-to-intent-pk-", "");
    entry_qstn = $("#entry_id_pk_" + data_entry_id).html()
    $("#selected_entry_qstn").html(entry_qstn)
    $('.modal').modal();
    $("#add_to_intent_data_collect_entry-modal").modal('open')
});

$(document).on("click", ".add-training-qstn-to-intent-data-entry", function (e) {
    selected_intent = $("#select-add-to-intent").val();

    if (selected_intent == null || selected_intent == undefined || selected_intent == "") {
        M.toast({
            "html": "Please select Intent."
        }, 2000);
        return;
    }

    selected = $("#selected_entry_qstn").html().replace(RegExp("<br>", 'g'), ",")

    window.open("/chat/edit-intent/?val=" + selected + "&intent_pk=" + selected_intent, '_blank')

});

$("#modify-data-collect-entry-select-all-checkbox").change(function (e) {
    var status = document.getElementById("modify-data-collect-entry-select-all-checkbox").checked;
    var inputs = document.getElementsByTagName("input");
    for (var i = 0; i < inputs.length; i++) {
        if (inputs[i].id.indexOf('modify-data-collect-entry-checkbox-') == 0) {
            data_id = inputs[i].id;
            document.getElementById(data_id).checked = status;
        }
    }
});

$("#modify-data-collect-entry-select-all-checkbox,.modify-data-collect-entry-checkbox").change(function (e) {
    if ($(".modify-data-collect-entry-checkbox:checked").length > 1) {
        $("#data-collect-entry-delete-selected").show();
        $("#data-collect-entry-add-to-intent-selected").show();
        $(".entry-options").hide();
    } else {
        $("#data-collect-entry-delete-selected").hide();
        $("#data-collect-entry-add-to-intent-selected").hide();
        $(".entry-options").show();
    }
});


$(document).on("click", "#data-collect-entry-add-to-intent-selected", function (e) {
    elements = $(".modify-data-collect-entry-checkbox:checked")
    entry_qstn = ""
    for (var i = 0; i < elements.length; i++) {
        entry_qstn = entry_qstn + $("#entry_id_pk_" + elements[i].id.replace("modify-data-collect-entry-checkbox-", "")).html()
        if (i != elements.length - 1) {
            entry_qstn = entry_qstn + "<br>"
        }
    }
    $("#selected_entry_qstn").html(entry_qstn)
    $('.modal').modal();
    $("#add_to_intent_data_collect_entry-modal").modal('open')
});

$('.add-input-to-form').click(function () {
    div_cnt = $(".data-entry-form-div").length + 1
    html_string = `<div class="row data-entry-form-div" id="data-entry-form-div-` + div_cnt + `" style="border: 1px solid black;padding: 1em 0;position: relative;">`
    html_string += `<span class="close-div" id="delete-div-` + div_cnt + `"><i class="material-icons">delete</i></span>`
    html_string += `<div class="input-field col s4" style="margin: 0">`
    html_string += `  <input id="data-entry-input-name-` + div_cnt + `" type="text">`
    html_string += ` <label for="data-entry-input-name-` + div_cnt + `">Input Name</label>
      </div>
      <div class="input-field col s3" style="margin: 0; margin-top: 1rem">`
    html_string += `<select class="select-data-entry-input-type" id="select-data-entry-input-type-` + div_cnt + `">`
    html_string += `<option value="None">---Choose Input Type---</option>`
    html_string += `<option value="data-entry-form-input-text">Text Field</option>`
    html_string += `<option value="data-entry-form-input-number">Number Field</option>
        <option value="data-entry-form-input-dropdown">DropDown</option>
      </select>
      </div>
      <div class="input-field col s2" style="margin: 0">
      <label>`
    html_string += `<input type="checkbox" id="data-entry-input-necessary-` + div_cnt + `"/>`
    html_string += `<span>Mandatory field</span>
      </label>
      </div>
      <div class="input-field col s12" id = "data-entry-dropdown-options-div-` + div_cnt + `"style="display:none">
      <input id="data-entry-dropdown-options-` + div_cnt + `" type="text">
      <label for="data-entry-dropdown-options-` + div_cnt + `">Dropdown options (Saparated by comma(,))</label>
      </div>`
    html_string += `</div>`
    $('.data-entry-form-modal-content').append(html_string)
    $('select').select2({
        width: "100%"
    });
    M.updateTextFields();

})

$(document).on("click", ".close-div", function (e) {
    div_id = ($(this).attr("id")).split("-")[2]
    $("#data-entry-form-div-" + div_id).remove()
});

$(document).on("change", ".select-data-entry-input-type", function (e) {
    div_id = ($(this).attr("id")).split("-")[5]
    if ($(this).val() == "data-entry-form-input-dropdown") {
        $("#data-entry-dropdown-options-div-" + div_id).show()
    } else {
        $("#data-entry-dropdown-options-div-" + div_id).hide()
    }
});


$(document).on("click", "#data-entry-form-data-save", function (e) {
    data_entry_form_info_list = []
    for (var i = 0; i < $('.data-entry-form-div').length; i++) {
        token_id = $('.data-entry-form-div')[i].id.split("-")[4]
        input_name = $.trim($("#data-entry-input-name-" + token_id).val())
        input_type = $.trim($("#select-data-entry-input-type-" + token_id).val())
        input_is_necessary = $("#data-entry-input-necessary-" + token_id).is(':checked')
        dropdown_options = $.trim($("#data-entry-dropdown-options-" + token_id).val())
        if (input_name == "" && input_type == "None") {
            continue
        }
        if (input_name != "" && input_type != "None") {
            if (input_type == "data-entry-form-input-dropdown") {
                if (dropdown_options == "") {
                    alert("Please Provide Dropdown Options")
                    return
                }
                dropdown_options = dropdown_options.split(",")
            } else {
                dropdown_options = []
            }
            data_entry_form_info_list.push({
                "input_name": input_name,
                "input_type": input_type,
                "input_is_necessary": input_is_necessary,
                "dropdown_options": dropdown_options
            })
        } else {
            alert("Please Provide Input Name/ Input Type")
            return
        }
    }
    bot_pk = $("#select-data-entry-bot").val();
    json_string = JSON.stringify({
        bot_pk: bot_pk,
        form_ui_data: data_entry_form_info_list,
    });
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: '/save-data-collect-form-ui-data/',
        type: "POST",
        data: {
            json_string: json_string
        },
        dataType: "json",
        async: false,
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response['status'] == 200) {
                M.toast({
                    'html': "Form saved successfully!"
                }, 2000);
                window.location.reload();
            } else {
                M.toast({
                    'html': "Unable to save the Form!"
                }, 2000);
            }
        }
    });
});

function getCsrfToken() {
    var CSRF_TOKEN = $('input[name="csrfmiddlewaretoken"]').val();
    return CSRF_TOKEN;
}

function showToast(message, duration) {
    M.toast({
        "html": message,
        classes: 'rounded'
    }, duration);
}


function delete_query_filter_option() {
    div = document.getElementById("query-div");
    div.parentNode.removeChild(div);
    document.getElementById("select-message-answer-filter").value = ""
    $('#select-message-answer-filter').trigger('change');
}

function delete_feedback_filter_option() {
    div = document.getElementById("feedback-div");
    div.parentNode.removeChild(div);
    document.getElementById("select-message-feedback-filter").value = ""
    $('#select-message-feedback-filter').trigger('change');
}

function delete_channels_filter_option() {
    div = document.getElementById("channels-div");
    div.parentNode.removeChild(div);
    document.getElementById("select-message-channels-filter").value = ""
    $('#select-message-channels-filter').trigger('change');
}

function delete_sentiment_filter_option() {
    div = document.getElementById("sentiment-div");
    div.parentNode.removeChild(div);
    document.getElementById("select-message-sentiment-filter").value = ""
    $('#select-message-sentiment-filter').trigger('change');
}

function delete_timestamp_filter_option() {
    div = document.getElementById("timestamp-div");
    div.parentNode.removeChild(div);
    document.getElementById("select-message-timestamp-filter").value = ""
}

function delete_location_city_filter_option() {
    div = document.getElementById("location-city-div");
    div.parentNode.removeChild(div);
    document.getElementById("select-message-location-city-filter").value = ""
    $('#select-message-location-city-filter').trigger('change');
}

function delete_location_state_filter_option() {
    div = document.getElementById("location-state-div");
    div.parentNode.removeChild(div);
    document.getElementById("select-message-location-state-filter").value = ""
    $('#select-message-location-state-filter').trigger('change');
}

function delete_location_pincode_filter_option() {
    div = document.getElementById("location-pincode-div");
    div.parentNode.removeChild(div);
    document.getElementById("select-message-location-pincode-filter").value = ""
    $('#select-message-location-pincode-filter').trigger('change');
}

function add_filter_option() {
    var value = document.getElementById("check-filter-select").value;
    var location_option = document.getElementById("select-message-location-filter").value;
    if (value == "") {
        showToast("Kindly select a valid filter", 2000);
        return;
    }
    if (value == "1") {
        query_value = document.getElementById("select-message-answer-filter").value;
        if (query_value == "1") {
            query_value = "All Queries"
        } else if (query_value == "2") {
            query_value = "Unanswered Queries"
        } else if (query_value == "3") {
            query_value = "Answered Queries"
        }
        var flag = false;
        try {
            val = document.getElementById("add-query-key").value
            flag = false
        } catch {
            flag = true
        }
        if (flag == true) {
            if (value != "" && query_value != "") {
                html = '<div class="row" id="query-div" style="margin-top: 1.5em;"><div class="col s4">'
                html += '<input id="add-query-key" value="Filter by queries" disabled>'
                html += '</div>'
                html += '<div class="col s4">'
                html += '<input id="add-query-value" value="' + query_value + '" disabled>'
                html += '</div><a class="red-text text-darken-3" onclick="delete_query_filter_option()"><i class="material-icons">delete</i></a></div>'
                div_html = document.getElementById("add-filter-buttons")
                div_html.insertAdjacentHTML('beforeend', html);
            } else {
                showToast("Kindly select a valid filter", 2000);
                return;
            }
        } else {
            showToast("This filter is already present.", 2000);
            return;
        }
    } else if (value == "2") {
        feedback_value = document.getElementById("select-message-feedback-filter").value;
        if (feedback_value == "") {
            showToast("Kindly select a valid filter", 2000);
            return;
        }
        if (feedback_value == "1") {
            feedback_value = "No Feedback"
        } else if (feedback_value == "2") {
            feedback_value = "Positive Feedback"
        } else if (feedback_value == "3") {
            feedback_value = "Negative Feedback"
        }
        var flag = false;
        try {
            val = document.getElementById("add-feedback-key").value
            flag = false
        } catch {
            flag = true
        }
        if (flag == true) {
            if (value != "" && feedback_value != "") {
                html = '<div class="row" id="feedback-div" style="margin-top: 1.5em;"><div class="col s4">'
                html += '<input id="add-feedback-key" value="Filter by feedback" disabled>'
                html += '</div>'
                html += '<div class="col s4">'
                html += '<input id="add-feedback-value" value= " ' + feedback_value + ' " disabled>'
                html += '</div><a class="red-text text-darken-3" onclick="delete_feedback_filter_option()"><i class="material-icons">delete</i></a></div>'
                div_html = document.getElementById("add-filter-buttons")
                div_html.insertAdjacentHTML('beforeend', html);
            } else {
                showToast("Kindly select a valid filter.", 2000);
                return;
            }
        } else {
            showToast("This filter is already present.", 2000);
            return;
        }
    } else if (value == "3") {
        channel_value = document.getElementById("select-message-channels-filter").value;
        if (channel_value == "") {
            showToast("Kindly select a valid filter", 2000);
            return;
        }
        if (channel_value == "1") {
            channel_value = "Web"
        } else if (channel_value == "2") {
            channel_value = "WhatsApp"
        } else if (channel_value == "3") {
            channel_value = "GoogleHome"
        } else if (channel_value == "4") {
            channel_value = "Alexa"
        } else if (channel_value == "5") {
            channel_value = "Android"
        } 
        var flag = false;
        try {
            val = document.getElementById("add-channels-key").value
            flag = false
        } catch {
            flag = true
        }
        if (flag == true) {
            if (value != "" && channel_value != "") {
                html = '<div class="row" id="channels-div" style="margin-top: 1.5em;"><div class="col s4">'
                html += '<input id="add-channels-key" value="Filter by Channel" disabled>'
                html += '</div>'
                html += '<div class="col s4">'
                html += '<input id="add-channels-value" value= " ' + channel_value + ' " disabled>'
                html += '</div><a class="red-text text-darken-3" onclick="delete_channels_filter_option()"><i class="material-icons">delete</i></a></div>'
                div_html = document.getElementById("add-filter-buttons")
                div_html.insertAdjacentHTML('beforeend', html);
            } else {
                showToast("Kindly select a valid filter.", 2000);
                return;
            }
        } else {
            showToast("This filter is already present.", 2000);
            return;
        }
    } else if (value == "4") {
        sentiment_value = document.getElementById("select-message-sentiment-filter").value;
        if (sentiment_value == "") {
            showToast("Kindly select a valid filter", 2000);
            return;
        }
        var flag = false;
        try {
            val = document.getElementById("add-sentiment-key").value
            flag = false
        } catch {
            flag = true
        }
        if (flag == true) {
            if (value != "" && sentiment_value != "") {
                html = '<div class="row" id="sentiment-div" style="margin-top: 1.5em;"><div class="col s4">'
                html += '<input id="add-sentiment-key" value="Filter by Sentiment" disabled>'
                html += '</div>'
                html += '<div class="col s4">'
                html += '<input id="add-sentiment-value" value= " ' + sentiment_value + ' " disabled>'
                html += '</div><a class="red-text text-darken-3" onclick="delete_sentiment_filter_option()"><i class="material-icons">delete</i></a></div>'
                div_html = document.getElementById("add-filter-buttons")
                div_html.insertAdjacentHTML('beforeend', html);
            } else {
                showToast("Kindly select a valid filter.", 2000);
                return;
            }
        } else {
            showToast("This filter is already present.", 2000);
            return;
        }
    } else if (value == "5") {
        timestamp_date_value = document.getElementById("timestamp-date").value;
        if (timestamp_date_value == "") {
            showToast("Kindly enter a valid date.", 2000);
            return;
        }
        timestamp_start_time = document.getElementById("timestamp-start-time").value;
        if (timestamp_start_time == "") {
            showToast("Kindly enter a valid time.", 2000);
            return;
        }
        timestamp_end_time = document.getElementById("timestamp-end-time").value;
        if (timestamp_end_time == "") {
            showToast("Kindly enter a valid time.", 2000);
            return;
        }

        if (timestamp_start_time > timestamp_end_time) {
            showToast("Start time should be less than end time.", 2000);
            return;
        }
        var flag = false;
        try {
            val = document.getElementById("add-timestamp-key").value
            flag = false
        } catch {
            flag = true
        }
        if (flag == true) {
            if (value != "" && timestamp_date_value != "" && timestamp_start_time != "" && timestamp_end_time != "") {
                html = '<div class="row" id="timestamp-div" style="margin-top: 1.5em;"><div class="col s4">'
                html += '<input id="add-timestamp-key" value="Filter by Timestamp" disabled>'
                html += '</div>'
                html += '<div class="col s4">'
                timestamp_date_value = change_date_format(timestamp_date_value)
                html += '<input id="add-timestamp-value" value= " ' + timestamp_date_value + ' " disabled>'
                html += '<input id="add-timestamp-value" value= " ' + timestamp_start_time + ' " disabled>'
                html += '<input id="add-timestamp-value" value= " ' + timestamp_end_time + ' " disabled>'
                html += '</div><a class="red-text text-darken-3" onclick="delete_timestamp_filter_option()"><i class="material-icons">delete</i></a></div>'
                div_html = document.getElementById("add-filter-buttons")
                div_html.insertAdjacentHTML('beforeend', html);
            } else {
                showToast("Kindly select a valid filter.", 2000);
                return;
            }
        } else {
            showToast("This filter is already present.", 2000);
            return;
        }
    } else if (value == "6" && location_option == "") {
        showToast("Kindly select a valid filter", 2000);
        return;
    } else if (value == "6" && location_option == "1") {
        location_city_value = document.getElementById("select-message-location-city-filter").value;
        if (location_city_value == "") {
            showToast("Kindly select a valid filter", 2000);
            return;
        }
        var flag = false;
        try {
            val = document.getElementById("add-location-city-key").value
            flag = false
        } catch {
            flag = true
        }
        if (flag == true) {
            if (value != "" && location_city_value != "") {
                html = '<div class="row" id="location-city-div" style="margin-top: 1.5em;"><div class="col s4">'
                html += '<input id="add-location-city-key" value="Filter by City" disabled>'
                html += '</div>'
                html += '<div class="col s4">'
                html += '<input id="add-location-city-value" value= " ' + location_city_value + ' " disabled>'
                html += '</div><a class="red-text text-darken-3" onclick="delete_location_city_filter_option()"><i class="material-icons">delete</i></a></div>'
                div_html = document.getElementById("add-filter-buttons")
                div_html.insertAdjacentHTML('beforeend', html);
            } else {
                showToast("Kindly select a valid filter.", 2000);
                return;
            }
        } else {
            showToast("This filter is already present.", 2000);
            return;
        }
    } else if (value == "6" && location_option == "2") {
        location_state_value = document.getElementById("select-message-location-state-filter").value;
        if (location_state_value == "") {
            showToast("Kindly select a valid filter", 2000);
            return;
        }
        var flag = false;
        try {
            val = document.getElementById("add-location-state-key").value
            flag = false
        } catch {
            flag = true
        }
        if (flag == true) {
            if (value != "" && location_state_value != "") {
                html = '<div class="row" id="location-state-div" style="margin-top: 1.5em;"><div class="col s4">'
                html += '<input id="add-location-state-key" value="Filter by State" disabled>'
                html += '</div>'
                html += '<div class="col s4">'
                html += '<input id="add-location-state-value" value= " ' + location_state_value + ' " disabled>'
                html += '</div><a class="red-text text-darken-3" onclick="delete_location_state_filter_option()"><i class="material-icons">delete</i></a></div>'
                div_html = document.getElementById("add-filter-buttons")
                div_html.insertAdjacentHTML('beforeend', html);
            } else {
                showToast("Kindly select a valid filter.", 2000);
                return;
            }
        } else {
            showToast("This filter is already present.", 2000);
            return;
        }
    } else if (value == "6" && location_option == "3") {
        location_pincode_value = document.getElementById("select-message-location-pincode-filter").value;
        if (location_pincode_value == "") {
            showToast("Kindly select a valid filter", 2000);
            return;
        }
        var flag = false;
        try {
            val = document.getElementById("add-location-pincode-key").value
            flag = false
        } catch {
            flag = true
        }
        if (flag == true) {
            if (value != "" && location_pincode_value != "") {
                html = '<div class="row" id="location-pincode-div" style="margin-top: 1.5em;"><div class="col s4">'
                html += '<input id="add-location-pincode-key" value="Filter by Pincode" disabled>'
                html += '</div>'
                html += '<div class="col s4">'
                html += '<input id="add-location-pincode-value" value= " ' + location_pincode_value + ' " disabled>'
                html += '</div><a class="red-text text-darken-3" onclick="delete_location_pincode_filter_option()"><i class="material-icons">delete</i></a></div>'
                div_html = document.getElementById("add-filter-buttons")
                div_html.insertAdjacentHTML('beforeend', html);
            } else {
                showToast("Kindly select a valid filter.", 2000);
                return;
            }
        } else {
            showToast("This filter is already present.", 2000);
            return;
        }
    }
}

function change_date_format(date) {
    var dateParts = date.split("-");
    date = dateParts[2] + "-" + dateParts[1] + "-" + dateParts[0];
    return date.trim();
}

function check_filter() {
    var value = document.getElementById("check-filter-select").value;
    if (value == "1") {
        document.getElementById("div-message-answer").style.display = "block"
        document.getElementById("div-message-feedback").style.display = "none"
        document.getElementById("div-message-channels").style.display = "none"
        document.getElementById("div-message-sentiment").style.display = "none"
        document.getElementById("div-message-timestamp").style.display = "none"
        document.getElementById("div-message-location").style.display = "none"
        show_location_data()
    } else if (value == "2") {
        document.getElementById("div-message-feedback").style.display = "block"
        document.getElementById("div-message-answer").style.display = "none"
        document.getElementById("div-message-sentiment").style.display = "none"
        document.getElementById("div-message-channels").style.display = "none"
        document.getElementById("div-message-timestamp").style.display = "none"
        document.getElementById("div-message-location").style.display = "none"
        show_location_data()
    } else if (value == "3") {
        document.getElementById("div-message-channels").style.display = "block"
        document.getElementById("div-message-sentiment").style.display = "none"
        document.getElementById("div-message-feedback").style.display = "none"
        document.getElementById("div-message-answer").style.display = "none"
        document.getElementById("div-message-timestamp").style.display = "none"
        document.getElementById("div-message-location").style.display = "none"
        show_location_data()
    } else if (value == "4") {
        document.getElementById("div-message-sentiment").style.display = "block"
        document.getElementById("div-message-channels").style.display = "none"
        document.getElementById("div-message-feedback").style.display = "none"
        document.getElementById("div-message-answer").style.display = "none"
        document.getElementById("div-message-timestamp").style.display = "none"
        document.getElementById("div-message-location").style.display = "none"
        show_location_data()
    } else if (value == "5") {
        document.getElementById("div-message-timestamp").style.display = "block"
        document.getElementById("div-message-sentiment").style.display = "none"
        document.getElementById("div-message-channels").style.display = "none"
        document.getElementById("div-message-feedback").style.display = "none"
        document.getElementById("div-message-answer").style.display = "none"
        document.getElementById("div-message-location").style.display = "none"
        show_location_data()
    } else if (value == "6") {
        document.getElementById("div-message-location").style.display = "block"
        document.getElementById("div-message-sentiment").style.display = "none"
        document.getElementById("div-message-channels").style.display = "none"
        document.getElementById("div-message-feedback").style.display = "none"
        document.getElementById("div-message-answer").style.display = "none"
        document.getElementById("div-message-timestamp").style.display = "none"
        show_location_data()
    } else {
        document.getElementById("div-message-channels").style.display = "none"
        document.getElementById("div-message-feedback").style.display = "none"
        document.getElementById("div-message-answer").style.display = "none"
        document.getElementById("div-message-sentiment").style.display = "none"
        document.getElementById("div-message-timestamp").style.display = "none"
        document.getElementById("div-message-location").style.display = "none"
        show_location_data()
    }
}

function show_location_data() {
    var location_option = document.getElementById("select-message-location-filter").value;
    var value = document.getElementById("check-filter-select").value;
    if (location_option == 1 && value == 6) {
        document.getElementById("div-message-location-city").style.display = "block"
        document.getElementById("div-message-location-state").style.display = "none"
        document.getElementById("div-message-location-pincode").style.display = "none"
    } else if (location_option == 2 && value == 6) {
        document.getElementById("div-message-location-city").style.display = "none"
        document.getElementById("div-message-location-state").style.display = "block"
        document.getElementById("div-message-location-pincode").style.display = "none"
    } else if (location_option == 3 && value == 6) {
        document.getElementById("div-message-location-city").style.display = "none"
        document.getElementById("div-message-location-state").style.display = "none"
        document.getElementById("div-message-location-pincode").style.display = "block"
    } else {
        document.getElementById("div-message-location-city").style.display = "none"
        document.getElementById("div-message-location-state").style.display = "none"
        document.getElementById("div-message-location-pincode").style.display = "none"
    }

}

function location_details_change() {
    var selected_element = document.getElementById("location-dropdown");
    var location_option = selected_element.value;
    if (location_option == "city") {
        $('.client-location-city').css('display', 'table-cell');
        $('.client-location-state').css('display', 'none');
        $('.client-location-pincode').css('display', 'none');
    } else if (location_option == "state") {
        $('.client-location-city').css('display', 'none');
        $('.client-location-state').css('display', 'table-cell');
        $('.client-location-pincode').css('display', 'none');
    } else if (location_option == "pincode") {
        $('.client-location-city').css('display', 'none');
        $('.client-location-state').css('display', 'none');
        $('.client-location-pincode').css('display', 'table-cell');
    }
}

function select_message_filter() {
    bot_id = document.getElementById("selected-bot-message-history").value;
    var answer_filter_value = ""
    answer_filter = document.getElementById("select-message-answer-filter").value;
    if (answer_filter == "1") {
        answer_filter_value = "&all"
    } else if (answer_filter == "2") {
        answer_filter_value = "&unanswered"
    } else if (answer_filter == "3") {
        answer_filter_value = "&answered"
    }
    var feedback_filter_value = ""
    feedback_filter = document.getElementById("select-message-feedback-filter").value;
    if (feedback_filter == "1") {
        feedback_filter_value = "&no_feedback"
    } else if (feedback_filter == "2") {
        feedback_filter_value = "&possitive_feedback"
    } else if (feedback_filter == "3") {
        feedback_filter_value = "&negative_feedback"
    }
    var channels_filter_value = ""
    channels_filter = document.getElementById("select-message-channels-filter").value;
    if (channels_filter == "1") {
        channels_filter_value = "&channel_name=Web"
    } else if (channels_filter == "2") {
        channels_filter_value = "&channel_name=WhatsApp"
    } else if (channels_filter == "3") {
        channels_filter_value = "&channel_name=GoogleHome"
    } else if (channels_filter == "4") {
        channels_filter_value = "&channel_name=Alexa"
    } else if (channels_filter == "5") {
        channels_filter_value = "&channel_name=Android"
    }
    var sentiment_filter_value = ""
    sentiment_filter = document.getElementById("select-message-sentiment-filter").value;
    if (sentiment_filter != "") {
        sentiment_filter_value = "&sentiment=" + sentiment_filter
    }
    var timestamp_filter_value = ""
    timestamp_date = document.getElementById("timestamp-date").value;
    timestamp_start_time = document.getElementById("timestamp-start-time").value;
    timestamp_end_time = document.getElementById("timestamp-end-time").value;
    if (timestamp_date != "" && timestamp_start_time != "" && timestamp_end_time != "") {
        timestamp_filter_value = "&timestamp_date=" + timestamp_date + "&timestamp_start_time=" + timestamp_start_time + "&timestamp_end_time=" + timestamp_end_time;
    }

    var location_city_filter_value = ""
    location_city_filter = document.getElementById("select-message-location-city-filter").value;
    if (location_city_filter != "") {
        location_city_filter_value = "&location_city=" + location_city_filter
    }

    var location_state_filter_value = ""
    location_state_filter = document.getElementById("select-message-location-state-filter").value;
    if (location_state_filter != "") {
        location_state_filter_value = "&location_state=" + location_state_filter
    }

    var location_pincode_filter_value = ""
    location_pincode_filter = document.getElementById("select-message-location-pincode-filter").value;
    if (location_pincode_filter != "") {
        location_pincode_filter_value = "&location_pincode=" + location_pincode_filter
    }

    if (answer_filter_value == "" && feedback_filter_value == "" && channels_filter_value == "" && sentiment_filter == "" && timestamp_filter_value == "" && location_city_filter_value == "" && location_state_filter_value == "" && location_pincode_filter_value == "") {
        showToast("Kindly select a valid filter", 2000);
        return;
    }

    value = channels_filter_value + answer_filter_value + feedback_filter_value + sentiment_filter_value + timestamp_filter_value + location_city_filter_value + location_state_filter_value + location_pincode_filter_value;
    window.location = window.location.origin + window.location.pathname + "?bot_id=" + bot_id + value;
}

$(".easychat_processor_collapsible").click(function(){
        $(this).toggleClass("active");
        $(this).next(".easychat_processor_content").slideToggle();
        $(this).parent().toggleClass("active-list")
});

function start_crawling() {

    var url = document.getElementById("crawl-url").value.trim()
    if (url == "") {
        showToast("Kindly enter a URL to start crawling", 2000);
        return;
    }
    if (isValidURL(url) == false) {
        showToast("Kindly enter a valid URL.", 2000);
        return;
    }

    bot_id = window.location.href.split("/")[6]

    var json_string = JSON.stringify({
        url: url,
        bot_id: bot_id,
    })
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/search/start-crawling/",
        type: "POST",
        headers: {
            "X-CSRFToken": getCsrfToken()
        },
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                showToast("Crawling Started Successfully.", 2000);
                window.location.reload();
            } else if (response["status"] == 305) {
                showToast("Please Save it before crawling.", 2000);
            } else {
                console.log(response);
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
}

function save_e_search() {
    bot_id = window.location.href.split("/")[6]
    var json_string = JSON.stringify({
        bot_id: bot_id
    })
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/search/enable-e-search/",
        type: "POST",
        headers: {
            "X-CSRFToken": getCsrfToken()
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status_code"] == 200) {
                showToast("E Search Enable Successfully.", 2000);
            } else {
                console.log(response);
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
}

function save_g_search() {
    bot_id = window.location.href.split("/")[6]
    search_cx = document.getElementById("search-cx").value;
    if (search_cx == "") {
        showToast("Kindly enter the CX ID.", 2000);
        return;
    }
    var json_string = JSON.stringify({
        "bot_id": bot_id,
        "search_cx": search_cx
    })
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/search/enable-g-search/",
        type: "POST",
        headers: {
            "X-CSRFToken": getCsrfToken()
        },
        data: {
            data: json_string
        },
        success: function (response) {
            console.log(response)
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status_code"] == 200) {
                showToast("G Search Enable Successfully.", 2000);
                window.location.reload();
            } else {
                console.log(response);
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
}

function refreshCrawledLinks() {
    window.location.reload();
}


//////////////////////////////////////////////

// Carousel

//////////////////////////////////////////////

banner_redirection_count = 0

function checkImageURL(url) {
    url = url.toLowerCase()
    return (url.match(/\.(jpeg|jpg|gif|png)$/) != null);
}

function add_banner_details() {


    img_url = $("#add_banner_url_data").val().trim()

    if (img_url == "") {
        M.toast({
            "html": "Please provide valid image url"
        }, 2000);
        return;
    }

    if (!checkImageURL(img_url)) {
        M.toast({
            "html": "Please provide valid image url"
        }, 2000);
        return;
    }

    if (isValidURL(img_url) == false) {
        M.toast({
            "html": "Please provide valid image url"
        }, 2000);
        return;
    }

    rd_url = $("#add_redirection_url_data").val();
    var pattern = /^((http|https|ftp):\/\/)/;
    if (!pattern.test(rd_url)) {
        M.toast({
            "html": "Please enter valid redirect url."
        }, 2000);
        return;
    }

    if (rd_url.trim() == "") {
        M.toast({
            "html": "Please enter valid redirect url."
        }, 2000);
        return;
    }

    AddBannerRedirectionUrl(img_url, rd_url);
}

function get_image_data(image_path) {
    var received_data = null;
    var json_string = JSON.stringify({
        "image_path": image_path,
    })
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/get-image-data/",
        type: "POST",
        headers: {
            "X-CSRFToken": getCsrfToken()
        },
        data: {
            json_string: json_string
        },
        async: false,
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                data = {
                    x: response["x"],
                    y: response["y"],
                    width: response["width"],
                    height: response["height"],
                };
                received_data = data;
            } else {
                received_data = null;
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            received_data = null;
        }
    });
    return received_data;
}

function set_image_data(x, y, width, height, image_path) {
    var json_string = JSON.stringify({
        "x": x,
        "y": y,
        "width": width,
        "height": height,
        "image_path": image_path
    });
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/set-image-data/",
        type: "POST",
        headers: {
            "X-CSRFToken": getCsrfToken()
        },
        data: {
            json_string: json_string
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
}

function open_modal_image_crop(image_source) {

    var modal_id = "#image-crop-modal";
    var image_id = "#image-crop-modal-img-id";
    var extention = image_source.substring(image_source.lastIndexOf('.'), image_source.length) || image_source;

    if (extention == image_source) {
        M.toast({
            "html": "Image source is not valid"
        }, 2000)
        return;
    }

    original_image_source = image_source.substring(0, image_source.lastIndexOf('.')) + "_original" + extention;
    $.ajax({
        url: original_image_source,
        error: function (data) {
            save_duplicate_image(image_source, original_image_source);
        }
    });

    image_data = get_image_data(image_source)

    setTimeout(function () {
        $(image_id).attr("src", original_image_source)

        var $image = $(document.getElementById("image-crop-modal-img-id"));

        $(modal_id).modal("open");

        setTimeout(function () {
            $image.cropper({
                viewMode: 1,
                aspectRatio: 8 / 5,
                minCropBoxWidth: 100,
                minCropBoxHeight: 100,
                data: image_data
            })
                .on('zoom', function (e) {
                    e.preventDefault();
                });
        }, 50);

    }, 300);
}

function edit_image(id) {
    event.preventDefault();
    var image_source = document.getElementById(id).querySelector("img").src;
    destroy_cropper();
    open_modal_image_crop(image_source);
}

function edit_rdurl(id, rd_url, str_id1) {

    welcome_banner_edit_element = document.getElementById("redurl_" + str_id1)

    $('#edit-welcome-banner-redirecturl-modal').modal('open');
    document.getElementById("welcome-banner-redirect-url").value = document.getElementById("redurl_" + str_id1).value;

}


function save_image() {
    var image_id = "image-crop-modal-img-id"
    event.preventDefault();
    var $image = $(document.getElementById(image_id));

    var cropData = $image.cropper("getData");
    var x = cropData["x"];
    var y = cropData["y"];
    var height = cropData["height"];
    var width = cropData["width"];
    var image_path = document.getElementById(image_id).src;
    image_crop(x, y, height, width, image_path);
}

function destroy_cropper() {
    event.preventDefault();
    var image_id = "image-crop-modal-img-id"
    var $image = $(document.getElementById(image_id));
    $image.cropper("destroy");
}

function image_crop(x, y, height, width, image_path) {
    var n = image_path.lastIndexOf("_original");
    var target_path = image_path.slice(0, n) + image_path.slice(n).replace("_original", "");
    var json_string = JSON.stringify({
        "x": x,
        "y": y,
        "width": width,
        "height": height,
        "image_path": image_path,
        "target_path": target_path,
    })
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/image-crop/",
        type: "POST",
        headers: {
            "X-CSRFToken": getCsrfToken()
        },
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                set_image_data(x, y, width, height, target_path);
                $("#save-web-channel").click();
            } else {
                M.toast({
                    "html": "Not able to crop image."
                }, 2000)
                window.location.reload();
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
}

function AddBannerRedirectionUrl(img_url, rd_url, cmp_img_url) {

    var id = "image_url_" + banner_redirection_count.toString();
    var str_id = "str_image_url_" + banner_redirection_count.toString();
    var str_id1 = "str_rd_url_" + banner_redirection_count.toString();
    var img_name = img_url.split("/")
    img_name = img_name[img_name.length - 1]

    if (cmp_img_url) {
        image_compressed_path = cmp_img_url;
    }


    if (image_compressed_path.toString().trim() == "") {
        image_compressed_path = img_url
    }


    var html = `
    		<div class="welcome-banner-image-tile" id="` + id + `">
    				<div style="display:none;">
			        <input id="imageurl_` + str_id + `" type="text" data-length="100" value="` + img_url + `" style="width: 80%" required>
			        <input id="imageurl_compressed_` + str_id + `" type="text" data-length="100" value="` + image_compressed_path + `" style="width: 80%" required>
			        <label for="` + str_id + `"></label>
			        </div>
			        <div style="display:none;">
			        <input id="redurl_` + str_id1 + `" type="text" data-length="100" value="` + rd_url + `" style="width: 80%" required disabled>
			        <label for="` + str_id1 + `"></label>
			        </div>
                    <div class="image-div">
                        <img id="img1" src="` + img_url + `">
                    </div>
                    <div class="image-name-div">
                        ` + img_name + `
                    </div>
                    <button class="eye-icon tooltip" onclick="image_modal_open('` + img_url + `','` + rd_url + `')"><img src= "/static/EasyChatApp/img/eye-icon.svg">
                        <span class="tooltiptext" style="margin-left: -66px;">View Banner</span>
                    </button>
                    <button type="button" class="edit-icon tooltip" data-target="edit-welcome-banner-redirecturl-modal" onclick="edit_rdurl( '` + id + `','` + rd_url + `','` + str_id1 + `' )"  ><img src="/static/EasyChatApp/img/edit-icon.svg">
                       <span class="tooltiptext"  style="margin-left: -50px;">Edit URL</span>
                      </button>
                    <button class="cross-icon delete-button-image-redirection-url tooltip" id="` + id + `" ><img src="/static/EasyChatApp/img/cross-icon.svg">
                        <span class="tooltiptext"  style="margin-left: -82px;">Remove Banner</span>
                    </button>
        	</div>

    `
    image_compressed_path = ""
    $(html).appendTo($("#welcome-banner-list"));
    $("#add_banner_url_data").val("")
    $("#add_redirection_url_data").val("")
    banner_redirection_count += 1;
    preview_banner_button = document.getElementById("preview-banner")
    preview_banner_button.style.opacity = "1";
    preview_banner_button.disabled = false;
    preview_banner_button.style.cursor = "pointer";


}



function save_duplicate_image(origional, duplicate) {
    origional = origional.replace(window.location.protocol + "//" + window.location.host + "/", "");
    duplicate = duplicate.replace(window.location.protocol + "//" + window.location.host + "/", "");

    var csrf_token = $('input[name="csrfmiddlewaretoken"]').val();
    $.ajax({
        url: "/chat/duplicate-image/",
        type: "POST",
        headers: {
            'X-CSRFToken': csrf_token
        },
        data: {
            image_source: origional,
            duplicate_image_source: duplicate
        },
        async: false,
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
}

var upload_file_limit_size = 5120000;
var image_compressed_path = "";

//Quick Menu Image Upload
$(document).on("click", "#upload_quick_menu_image", function (e) {
    e.preventDefault();

    if (document.getElementById("input_upload_quick_menu_image2").value == "") {
        M.toast({
            "html": "Please select a file"
        }, 2000);

        setTimeout(function () {
            $('#modal-upload-quick-menu-image').modal('open');
        }, 200);
        return false;
    }

    var input_upload_image = ($("#input_upload_quick_menu_image"))[0].files[0]

    if (input_upload_image == null || input_upload_image == undefined) {
        M.toast({
            "html": "Please select a file"
        }, 2000);

        setTimeout(function () {
            $('#modal-upload-quick-menu-image').modal('open');
        }, 200);
        return false;
    }
    if (input_upload_image.name.match(/\.(jpeg|jpg|gif|png)$/) == null) {
        M.toast({
            "html": "Please upload valid image"
        }, 2000);
        setTimeout(function () {
            $('#modal-upload-quick-menu-image').modal('open');
        }, 200);
        return false;
    }
    if (input_upload_image.size > upload_file_limit_size) {
        M.toast({
            "html": "Size limit exceed(should be less than 5 MB)."
        }, 2000);

        setTimeout(function () {
            $('#modal-upload-quick-menu-image').modal('open');
        }, 200);

        return false;
    }

    if (check_malicious_file(input_upload_image.name) == true) {

        setTimeout(function () {
            $('#modal-upload-quick-menu-image').modal('open');
        }, 200);
        return false;
    }

    var reader = new FileReader();
    reader.readAsDataURL(input_upload_image);
    reader.onload = function () {

        base64_str = reader.result.split(",")[1];

        uploaded_file = [];
        uploaded_file.push({
            "filename": input_upload_image.name,
            "base64_file": base64_str,
        });

        upload_quick_menu_image();
    };

    reader.onerror = function (error) {
        console.log('Error: ', error);
    };
});

async function upload_quick_menu_image() {
    var response = await upload_image();

    if (response && response.status == 200) {
        src = window.location.protocol + "//" + window.location.host + response["src"];
        $("#icon-name-quick").click()
        $("#icon-name-quick").val(src);
        document.getElementById('input_upload_quick_menu_image2').value = "";
        current_quick_img_src = response["src"]
        $("#quick_menu_preview_image").attr("src", response["src"]);
    }
}

$(document).on("click", ".delete-button-image-redirection-url", function (e) {
    e.preventDefault();
    element = "#" + this.id;
    $(element).remove();

    welcome_banner_elements_count = document.getElementById('welcome-banner-list').childElementCount;
    if (welcome_banner_elements_count < 1) {
        preview_banner_button = document.getElementById("preview-banner")
        preview_banner_button.style.opacity = "0.5";
        preview_banner_button.disabled = true;
        preview_banner_button.style.cursor = "not-allowed";

    }


});


function load_edit_static_content(element) {

    var editor = ace.edit("editor-code");
    var filename = document.getElementById("static-filename").value;
    csrf_token = get_csrf_token();

    json_string = JSON.stringify({
        filename: filename
    });
    json_string = EncryptVariable(json_string);

    element.innerHTML = "loading..."
    $.ajax({
        url: "/chat/load-static-file/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                editor.setValue(response["code"]);
                $("#save-script-btn").removeAttr("disabled", "disabled");
            } else {
                M.toast({
                    "html": response["message"]
                }, 2000);
            }
            element.innerHTML = "Load Script"
        },
        error: function (jqXHR, exception) {
            console.log(jqXHR, exception);
            element.innerHTML = "Load Script"
        }
    });
}

function append_form_widget_data(form_name, form_data_misdashboard, pk_of_mis) {
    let html = '<div class = "easychat-form-container" style="width: 360px;float: right"><h5>' + form_name + '</h5>';
    dict_length = Object.keys(form_data_misdashboard).length
    iterator = 0
    for (key in form_data_misdashboard) {
        iterator = iterator + 1
        html += '<p class= "revert-existing easychat-form-label" style="width:100%; word-break: break-word; float:unset;display:block !important;border-radius:unset !important;color:#4d4d4d !important; background:#FBFBFB !important;color: #4d4d4d !important;margin-left: 10px !important;font-size: 14px !important;">' + key + '</p>'

        let value = form_data_misdashboard[key];
        let input_type = value[0];
        let input_val = value[1];

        if (Array.isArray(input_val)) {
            for (let i = 0; i < input_val.length; ++i) {
                html += '<p class="revert-existing easychat-form-value" style="width:100%; word-break: break-word; float:unset;display:block !important;border-radius:unset !important;color:#2d2d2d !important;background:#FBFBFB !important;color: #2d2d2d !important;font-size: 13px !important;margin-left: 10px;!important;">' + sanitize_html(input_val[i]) + '</p>';
            }
        } else {
            if (input_type == 'file_attach') {
                let file_name = input_val.split('/');
                file_name = file_name[file_name.length - 1];
                html += '<p class="revert-existing easychat-form-value" style="width:100%; word-break: break-word; float:unset;display:block !important;border-radius:unset !important;color:#2d2d2d !important;background:#FBFBFB !important;color: #2d2d2d !important;font-size: 13px !important;margin-left: 10px;!important;"><a href=' + input_val + '>' + sanitize_html(file_name) + '</a></p>';
            } else {
                html += '<p class="revert-existing easychat-form-value" style="width:100%; word-break: break-word; float:unset;display:block !important;border-radius:unset !important;color:#2d2d2d !important;background:#FBFBFB !important;color: #2d2d2d !important;font-size: 13px !important;margin-left: 10px;!important;">' + sanitize_html(input_val) + '</p>';
            }
        }
        if (iterator != dict_length) {
            html += '<hr style = "border: 1px solid #e6e6e6">';
        }
    }
    html += "<a href='/chat/download-form-data-excel/?pk_of_mis=" + pk_of_mis + "' style='float:right'>Download Excel</a>"
    html += '</div>';
    return html
}

function save_edit_static_content(element) {

    var editor = ace.edit("editor-code");
    var filename = document.getElementById("static-filename").value;
    var code = editor.getValue();

    //utf_message = EasyChatCryptoJS.enc.Utf8.parse(code);
    //code = EasyChatCryptoJS.enc.Base64.stringify(utf_message);

    csrf_token = get_csrf_token();
    json_string = JSON.stringify({
        filename: filename,
        code: code
    });
    json_string = EncryptVariable(json_string);

    element.innerHTML = "saving..."
    $.ajax({
        url: "/chat/save-static-file/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Script Saved Successfully."
                }, 2000);
            } else {
                M.toast({
                    "html": response["message"]
                }, 2000);
            }
            element.innerHTML = "Save Script"
        },
        error: function (jqXHR, exception) {
            console.log(jqXHR, exception);
            element.innerHTML = "Save Script"
        }
    });
}

if (window.location.pathname.indexOf("/chat/user-filtered/") != -1) {
    let search_user_id = document.getElementById("search-user-input");
    if(search_user_id) {
        search_user_id.addEventListener("keydown", function (e) {
            if (e.keyCode === 13) {
                get_search_result();
            }
        });
    }
    search_user_id = search_user_id ? search_user_id : document.getElementById("search-user-input-static")
    if(search_user_id) {
        search_user_id.addEventListener("keyup", function (e) {
            if (search_user_id.value == ""){
                document.getElementsByClassName("message-history-clear-input-div")[0].style.display = "none";
            } else {
                document.getElementsByClassName("message-history-clear-input-div")[0].style.display = "block";
            }
        });
    }
}

function get_search_result() {
    var text = document.getElementById("search-user-input").value;

    if (text.trim() == "") {

        M.toast({
            "html": "User ID cannot be empty."
        }, 2000);
        return;
    }
    document.getElementById("chat-pagination").style.display = "none";
    document.getElementById("loader-user-id").style.display = "flex";
    $('#user-contacts').css('height', 'calc(100vh - 250px)')

    var bot_id = get_url_vars()["bot_id"]
    csrf_token = get_csrf_token();
    json_string = JSON.stringify({
        "user_id": text,
        "bot_id": bot_id
    });
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/get-mis-user/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            document.getElementById("loader-user-id").style.display = "none";
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status_code"] == 200) {
                html = ''
                for(var index = 0; index < response["results"].length; index++) {
                    // html += "<li class=\"contact\"><div class=\"wrap\" onclick=\"get_user_messages('" + response["results"][index] + "')\">"
                    html += '<li class="easychat-user-chat-contacts-list-item" onclick=get_user_messages("' + response["results"][index][0] + '")>'
                    html += '<div class="user-chat-contacts-list-item-img">'+
                                   '<svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">'+
                                    '<g filter="url(#filter0_dd_232_13545)">'+
                                    '<rect x="4.00024" y="2" width="32" height="32" rx="16" fill="#F6F6F6"/>'+
                                    '<rect x="4.50024" y="2.5" width="31" height="31" rx="15.5" stroke="#EBEBEB"/>'+
                                    '</g>'+
                                    '<g clip-path="url(#clip0_232_13545)">'+
                                    '<circle cx="20.0788" cy="14.6304" r="3.12377" stroke="#2D2D2D" stroke-width="1.42442"/>'+
                                    '<path d="M15.4971 24.6039C15.375 23.209 15.7168 20.3355 18.0603 20.0007H22.0882C23.0646 20.0007 24.9443 20.9214 24.6514 24.6039" stroke="#2D2D2D" stroke-width="1.42442" stroke-linecap="round"/>'+
                                    '</g>'+
                                    '<defs>'+
                                    '<filter id="filter0_dd_232_13545" x="0.000244141" y="0" width="40" height="40" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">'+
                                    '<feFlood flood-opacity="0" result="BackgroundImageFix"/>'+
                                    '<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>'+
                                    '<feOffset dy="2"/>'+
                                    '<feGaussianBlur stdDeviation="2"/>'+
                                    '<feColorMatrix type="matrix" values="0 0 0 0 0.196487 0 0 0 0 0.196487 0 0 0 0 0.279476 0 0 0 0.06 0"/>'+
                                    '<feBlend mode="multiply" in2="BackgroundImageFix" result="effect1_dropShadow_232_13545"/>'+
                                    '<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>'+
                                    '<feOffset/>'+
                                    '<feGaussianBlur stdDeviation="1"/>'+
                                    '<feColorMatrix type="matrix" values="0 0 0 0 0.196487 0 0 0 0 0.196487 0 0 0 0 0.279476 0 0 0 0.06 0"/>'+
                                    '<feBlend mode="multiply" in2="effect1_dropShadow_232_13545" result="effect2_dropShadow_232_13545"/>'+
                                    '<feBlend mode="normal" in="SourceGraphic" in2="effect2_dropShadow_232_13545" result="shape"/>'+
                                    '</filter>'+
                                    '<clipPath id="clip0_232_13545">'+
                                    '<rect width="15.8889" height="15.8889" fill="white" transform="translate(12 10)"/>'+
                                    '</clipPath>'+
                                    '</defs>'+
                                    '</svg>'+
                                    '</div>'
                    // html += '<img src="/static/EasyChatApp/img/botIcon.svg" alt="" />'
                    html += '<div class="user-chat-contacts-id-wrapper">'+
                                '<div class="user-chat-contacts-id-text">'+
                                    response["results"][index][0] + '' +
                                    '</div>'+
                                    '<div class="user-chat-contacts-response-text">'+
                                    response["results"][index][1] + '' +
                                '</div>'+
                            '</div></li>'
                    // html += '<div class="meta">'
                    // html += '<p class="preview">' + response["results"][index].slice(0, 15) + '...</p>'
                    // html += '</div></div></li><hr>'
                }
                document.getElementById("user-contacts").innerHTML = html
                document.getElementById("chat-pagination").style.display = "none";
                $(".easychat-user-chat-contacts-list-item").click(function () {
                    $(".easychat-user-chat-contacts-list-item").removeClass("easychat-user-active-chat");
                    $(this).addClass("easychat-user-active-chat");
                });
            } else if (response["status_code"] == 404) {
                document.getElementById("chat-pagination").style.display = "flex";
                M.toast({
                    "html": "No user found with this User ID."
                }, 2000);
            } else {
                document.getElementById("chat-pagination").style.display = "flex";
                M.toast({
                    "html": "Some error occured"
                }, 2000);
            }
        },
        error: function (jqXHR, exception) {
            console.log(jqXHR, exception);
        }
    });
}

if (window.location.pathname.indexOf("/chat/user-filtered/") != -1) {
    let user_id = get_url_vars()["user_id"];
    let session_id = get_url_vars()["session_id"]
    let static_page = get_url_vars()["static_page"]
    if (user_id != "" && user_id != null && user_id != undefined) {
        if (static_page == 'true') {
            get_user_messages_static(user_id, session_id);
        } else {
            get_user_messages(user_id, session_id);
        }
    }
}

function is_image(attached_file_src) {
    var file_ext = attached_file_src.split(".");
    file_ext = attached_file_src.split(".")[file_ext.length - 1];
    file_ext = file_ext.toUpperCase();

    if (
        ["PNG", "JPG", "JPEG", "SVG", "BMP", "GIF", "TIFF", "EXIF", "JFIF"].indexOf(file_ext) != -1
    ) {
        return true;
    }

    return false;
}

function is_video(attached_file_src) {
    var file_ext = attached_file_src.split(".");
    file_ext = attached_file_src.split(".")[file_ext.length - 1];
    file_ext = file_ext.toUpperCase();
    if (
        [
            "WEBM",
            "MPG",
            "MP2",
            "MPEG",
            "MPE",
            "MPV",
            "OGG",
            "MP4",
            "M4P",
            "M4V",
            "AVI",
            "WMV",
            "MOV",
            "QT",
            "FLV",
            "SWF",
            "AVCHD",
        ].indexOf(file_ext) != -1
    ) {
        return true;
    }

    return false;
}

function close_preview_image() {
    $('#preview-big-image-modal').modal("close");
    document.getElementById("preview-big-image").src = "";
}
var download_button_html = '<div class="chat-history-attachment-download-btn"><svg width="15" height="15" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11.875 11.25H3.125C2.77982 11.25 2.5 11.5298 2.5 11.875C2.5 12.2202 2.77982 12.5 3.125 12.5H11.875C12.2202 12.5 12.5 12.2202 12.5 11.875C12.5 11.5298 12.2202 11.25 11.875 11.25Z" fill="#757575"></path><path d="M2.5 10.625V11.875C2.5 12.2202 2.77982 12.5 3.125 12.5C3.47018 12.5 3.75 12.2202 3.75 11.875V10.625C3.75 10.2798 3.47018 10 3.125 10C2.77982 10 2.5 10.2798 2.5 10.625Z" fill="#757575"></path><path d="M11.25 10.625V11.875C11.25 12.2202 11.5298 12.5 11.875 12.5C12.2202 12.5 12.5 12.2202 12.5 11.875V10.625C12.5 10.2798 12.2202 10 11.875 10C11.5298 10 11.25 10.2798 11.25 10.625Z" fill="#757575"></path> \
                               <path d="M7.50003 9.375C7.37046 9.37599 7.24378 9.33667 7.13753 9.2625L4.63753 7.5C4.50279 7.40442 4.41137 7.25937 4.38326 7.09658C4.35515 6.93379 4.39264 6.76649 4.48753 6.63125C4.5349 6.56366 4.59518 6.50611 4.66491 6.46194C4.73463 6.41777 4.81242 6.38785 4.89377 6.37391C4.97512 6.35996 5.05843 6.36227 5.13889 6.38069C5.21934 6.39911 5.29535 6.43329 5.36253 6.48125L7.50003 7.975L9.62503 6.375C9.75764 6.27555 9.92432 6.23284 10.0884 6.25628C10.2525 6.27973 10.4006 6.36739 10.5 6.5C10.5995 6.63261 10.6422 6.7993 10.6187 6.96339C10.5953 7.12749 10.5076 7.27555 10.375 7.375L7.87503 9.25C7.76685 9.33114 7.63526 9.375 7.50003 9.375Z" fill="#757575"></path>   \
                             <path d="M7.5 8.125C7.33424 8.125 7.17527 8.05915 7.05806 7.94194C6.94085 7.82473 6.875 7.66576 6.875 7.5V2.5C6.875 2.33424 6.94085 2.17527 7.05806 2.05806C7.17527 1.94085 7.33424 1.875 7.5 1.875C7.66576 1.875 7.82473 1.94085 7.94194 2.05806C8.05915 2.17527 8.125 2.33424 8.125 2.5V7.5C8.125 7.66576 8.05915 7.82473 7.94194 7.94194C7.82473 8.05915 7.66576 8.125 7.5 8.125Z" fill="#757575"></path></svg></div>'

function preview_big_image(elem) {
    document.getElementById("preview-big-image").src = ""
    image_src = elem.src
    $('#preview-big-image-modal').modal("open");
    document.getElementById("preview-big-image").src = image_src;
}

function get_image_path_html(file_name, attached_file_path) {
    return "<div class='easychat-user-message-image-container'><img onclick='preview_big_image(this)' src='" + attached_file_path + "'><a class='chat-history-attachment-widget' href='" + attached_file_path + "' target='_blank' download><div class='easychat-customer-attchment-file-name-div' style='color:gray;padding-left:10px;'>" + file_name + "</div>" + download_button_html + "</a></div>"
}

function get_vedio_path_html(file_name, attached_file_path) {
    return '<div class="easychat-user-message-video-container" ><video style="width:100%;height: 100%;" controls><source src="' + attached_file_path + '" type="video/mp4"></video><a class="chat-history-attachment-widget" href="' + attached_file_path + '" target="_blank"><div class="easychat-customer-attchment-file-name-div" style="color:gray;padding-left:10px;">' + file_name + '</div>' + download_button_html + '</a></div>'
}

function get_doc_path_html(file_name, attached_file_path) {
    return '<div class="easychat-user-message-image-container"><img src="/static/LiveChatApp/img/document.png"></img><a class="chat-history-attachment-widget" href="' + attached_file_path + '" target="_blank"><div class="easychat-customer-attchment-file-name-div" style="color:gray;padding-left:10px;">' + file_name + '</div>' + download_button_html + '</a></div>'
}

function get_html_for_message_hitory_attachment(file_name, attached_file_src) {
    let html = ""
    if (is_image(file_name)) {
        html += get_image_path_html(file_name, attached_file_src)
    } else if (is_video(file_name)) {
        html += get_vedio_path_html(file_name, attached_file_src)
    } else {
        html += get_doc_path_html(file_name, attached_file_src)
    }
    return html
}

function get_recomendation_object_from_string(recomendation, is_last) {
    try {
        if (!is_last) {
            recomendation = recomendation + " }"
        }
        recomendation = recomendation.replace(/'/g, '"')
        recomendation_obj = JSON.parse(recomendation)
        return recomendation_obj
    } catch (err) {
        console.log(err)
        return {
            "name": ""
        }
    }

}

///////////////////  API Integration in Console ////////////////////////

function go_full_screen_mode() {
    if (editor.container.mozRequestFullScreen) {
        editor.container.mozRequestFullScreen();
    } else {
        editor.container.webkitRequestFullscreen();
    }
}

function get_configure_api_mailer_data_email_list(){
    let email_list = []
    let email_els = $(".api-mailer-configure-email-id-data")
    for(let i =0 ; i<email_els.length;i++){
        email_list.push(email_els[i].innerText);
    }
    return email_list
}

function handleSaveEmail(elem) {
    easychat_bot_id = get_url_vars()["bot_pk"].split("#")
    bot_pk = easychat_bot_id[0]

    mail_sender_time_interval = $("#mail_sender_time_interval_input_editor").val()
    let isnum = /^\d+$/.test(mail_sender_time_interval.trim());
    if (!isnum) {
        M.toast({
            "html": "Invalid time input."
        }, 2000);
        return;
    }

    if (mail_sender_time_interval == undefined || mail_sender_time_interval == "" || mail_sender_time_interval < 0) {

        alert("Kindly enter a valid time interval")
        return
    }

    email_addr_list = get_configure_api_mailer_data_email_list()
    mail_sent_to_list_editor = email_addr_list
    if (!email_addr_list.length) {
        alert("Kindly enter an Email ID to proceed")
        return
    }
    for (var i = 0; i < email_addr_list.length; i++) {
        if (!validateEmailAddr(email_addr_list[i])) {
            alert("Please provide valid Email ID")
            return
        }
    }
    csrf_token = get_csrf_token()

    json_string = JSON.stringify({
        "bot_id": bot_pk,
        "mail_sender_time_interval": mail_sender_time_interval,
        "mail_sent_to_list": email_addr_list,
        "from_processor": "true"
    });
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/save-api-fail-email-config/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Email Configuration saved."
                })

                if (!response["email_configured"]) {
                    $("#modal-api-fail-email-config").modal('open');
                } else {
                    $("#modal-api-fail-email-config").modal('close');
                }

                elem.classList.add("modal-close");
                var html=`In case of an API Failure, an email will be sent out to `

                for(var c =0 ; c < mail_sent_to_list_editor.length; c++)
                {
                    if(mail_sent_to_list_editor.length <= 3)
                    {
                        if(c == mail_sent_to_list_editor.length -1)
                        {
                            html = html + mail_sent_to_list_editor[c] + ". "
                        }
                        else {
                            html = html + mail_sent_to_list_editor[c] +", "
                        }
                    } else
                    {

                        if(c == 2)
                        {
                            var count = mail_sent_to_list_editor.length - 3;
                            html = html + mail_sent_to_list_editor[c] + ", +" + count + ". "
                            break;

                        }
                        else {
                            html = html + mail_sent_to_list_editor[c] +", "
                        }
                    } 
                }

                document.getElementById("email-config-message").innerHTML = html + `<a class="modal-trigger" href="#modal-api-fail-email-config">Configure Now</a>`;

                document.getElementById("api-mailer-btn").setAttribute('style', 'opacity:0.9;border: 1px solid #10B981;background: #ECFDF5 !important;pointer-events:none;');
                document.getElementById("api-mailer-btn").innerHTML=`<svg width="16" height="17" viewBox="0 0 16 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 0.5C12.4183 0.5 16 4.08172 16 8.5C16 12.9183 12.4183 16.5 8 16.5C3.58172 16.5 0 12.9183 0 8.5C0 4.08172 3.58172 0.5 8 0.5ZM8 1.5C4.13401 1.5 1 4.63401 1 8.5C1 12.366 4.13401 15.5 8 15.5C11.866 15.5 15 12.366 15 8.5C15 4.63401 11.866 1.5 8 1.5ZM11.3584 6.14645C11.532 6.32001 11.5513 6.58944 11.4163 6.78431L11.3584 6.85355L7.35355 10.8584C7.17999
                11.032 6.91056 11.0513 6.71569 10.9163L6.64645 10.8584L4.64645 8.85842C4.45118 8.66316 4.45118 8.34658 4.64645 8.15131C4.82001 7.97775 5.08944 7.95846 5.28431 8.09346L5.35355 8.15131L7 9.798L10.6513 6.14645C10.8466 5.95118 11.1632 5.95118 11.3584 6.14645Z" fill="#059669"/>
                </svg>      
                <p>API Mailer</p>`;
                document.getElementById("api-mailer-btn").setAttribute("disabled","");

                document.getElementById("save-processor-btn").setAttribute('data-tooltip', 'API Mailer Configured');
                if(document.getElementById("processor-name").value != ""){
                    $("#save-processor-btn").css("opacity", 1)
		            $("#save-processor-btn").css("cursor", "pointer")
                }
                window.api_fail_email_configured_editor = "True"
            } else if (response["status"] == 300) {
                M.toast({
                    "html": response["msg"]
                })
            } else {
                M.toast({
                    "html": "Not Able To Save Api Mailer Configurations. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        }
    });

}






$(document).on("click", "#go-intent-processor", function (e) {

    active_url = window.location.href.replace("#", "");

    active_url = active_url.replace("!", "");

    // intent_pk = active_url.substring(active_url.indexOf("intent_pk=") + "intent_pk=".length, );
    // intent_pk = intent_pk.split("&")[0]
    intent_pk = get_url_vars()["intent_pk"];

    if (intent_pk == undefined || intent_pk == null) {
        M.toast({
            "html": "You can edit the post/pipe/api tree after creating intent only."
        }, 2000);
        return;
    }

    tree_pk = SELECTED_TREE_PK;

    processor = document.getElementById("select-intent-processor").value;

    if (processor == "package-manager") {
        window.open("/chat/package-installer/", "_blank");
        return;
    }

    if (processor == "") {

        M.toast({
            "html": "Please select one processor."
        }, 2000);
        return;
    }

    if (processor == "data") {

        window.open('/chat/data-model-entries/?bot_pk=' + SELECTED_BOT_PK, '_blank');
        return;
    }

    if (processor == "log") {

        window.open('/chat/log-analytics/?bot_pk=' + SELECTED_BOT_PK, '_blank');
        return;
    }

    if (processor == "whatsapp-history") {
        window.open('/chat/whatsapp-history/', '_blank');
        return;
    }
    if (processor == "whatsapp-simulator") {
        window.open('/chat/whatsapp-simulator/', '_blank');
        return;
    }
    if (processor == "whatsapp-webhook-extra") {
        window.open('/chat/whatsapp-webhook-function-console/?bot_pk=' + SELECTED_BOT_PK, '_blank');
        return;
    }

    if (processor == "common-utils") {
        window.open('/chat/common-utils/?bot_pk=' + SELECTED_BOT_PK, '_blank');
        return;
    }

    if (processor == "api-integration-v1") {
        window.open('/chat/api-integration/?intent_pk=' + intent_pk + '&tree_pk=' + tree_pk + '&type=rest', '_blank');
        return;
    }

    if (processor == "api-integration-v2") {
        window.location = "/automated-api/build/?tree_id=" + tree_pk + "&previous_location=" + encodeURIComponent(window.location.pathname + window.location.search);
        return;
    }

    if (processor == "api-list-collection") {
        window.open('/chat/api-list-collection/?bot_pk=' + SELECTED_BOT_PK, '_blank');
        return;
    }

    if (processor == "chatbot-custom-js") {
        window.open('/chat/chatbot-custom-js/?bot_pk=' + SELECTED_BOT_PK, '_blank');
        return;
    }

    if (processor == "chatbot-custom-css") {
        window.open('/chat/chatbot-custom-css/?bot_pk=' + SELECTED_BOT_PK, '_blank');
        return;
    }

    if (processor == "export") {
        $("#modal-export-intent-instruction").modal('open')
        return;
    }

    if (processor == "external-trigger-intent") {
        $("#easychat_extent_trigger_intent_modal").modal('open')
        return;
    }

    window.open('/chat/edit-processor/?intent_pk=' + intent_pk + '&tree_pk=' + tree_pk + '&processor=' + processor + '&bot_pk=' + SELECTED_BOT_PK, '_blank');

});

function export_intent_json() {
    window.location = '/chat/bot/export-intent/' + intent_pk
    return;
}

function save_whatsapp_webhooks_function(bot_id) {
    var editor = ace.edit("editor-extra-code-whatsapp");
    var code = editor.getValue();

    if (check_for_system_commands(code)) {
        M.toast({
            "html": "Code contains system-commands. Please remove them and save again."
        }, 2000);
        document.getElementById("easychat-processor-status").value = "\n\nError(s):";
        show_processor_errors();
        return;
    };
    csrf_token = get_csrf_token();
    var json_string = JSON.stringify({
        code: code,
        bot_id: bot_id,
    })
    json_string = EncryptVariable(json_string);
    json_string = encodeURIComponent(json_string);
    var xhttp = new XMLHttpRequest();
    var params = 'json_string=' + json_string
    xhttp.open("POST", "/chat/save-whatsapp-webhook-function-code/", true);
    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            response = JSON.parse(this.responseText);
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Changes saved successfully."
                }, 2000);
                setTimeout(function (e) {
                    window.location.reload();
                }, 2000);
            } else if (response["status"] == 300) {
                M.toast({
                    "html": response["message"]
                })
            } else if (response["status"] == 400) {

                M.toast({
                    "html": response["message"]
                })
            } else {
                M.toast({
                    "html": "An Error occured cannot save the function."
                })
            }
        }
    }
    xhttp.send(params);
}

function check_for_system_commands(code) {
    var Range = ace.require('ace/range').Range;
    var code_lines = code.split('\n')
    var contains_system_commands = false;

    for (var i = 0; i < code_lines.length; ++i) {
        var line = code_lines[i];
        for (cmd of system_commands) {
            var err_index = line.indexOf(cmd);
            if (err_index != -1) {
                contains_system_commands = true;

                if (!highlighted_lines[i]) {
                    var id = editor.session.addMarker(new Range(i, 0, i, 1), "my-marker", "fullLine");
                    highlighted_lines[i] = id;
                    processor_errors[i] = "Line " + (i + 1) + " : " + err_index + " Contains " + cmd + " command which is a system command.";
                }

                document.getElementById('system-command-error').style.display = 'block';
                break;
            } else {
                editor.session.removeMarker(highlighted_lines[i]);
                highlighted_lines[i] = undefined;
                processor_errors[i] = "";
            }
        }
    }

    return contains_system_commands;
}

function show_processor_errors() {
    processor_output_text_area = document.getElementById("easychat-processor-status");

    for (key in processor_errors) {
        if (processor_errors[key] != "") {
            processor_output_text_area.value += '\n\n' + processor_errors[key];
        }
    }

    processor_output_text_area.style.display = 'block';
}

var processor = "";
var tree_pk = 0;
var name = "";

function save_processor_content(processor, tree_pk, name, is_autosave = false) {


    if(window.api_fail_email_configured_editor + "" != "True"){
        // for debugging
        console.log("api mailer needs to be configured first")
        return;
    }
    
    if (document.getElementById("processor-name").value.toString().trim() == "") {
        M.toast({
            "html": "Processor name can't be empty."
        }, 2000);
        return;
    }

    if (document.getElementById("api-mailer-btn") != null) {

        if (!document.getElementById("api-mailer-btn").style.opacity == "0.7") {
            return;
        }
    }

    var editor = ace.edit("editor-code");
    var code = editor.getValue();

    if (check_for_system_commands(code)) {
        M.toast({
            "html": "Code contains system-commands. Please remove them and save again."
        }, 2000);
        document.getElementById("easychat-processor-status").value = "\n\nError(s):";
        show_processor_errors();
        return;
    };

    document.getElementById("easychat-processor-status").style.display = 'none';
    document.getElementById('system-command-error').style.display = 'none';

    var is_new = false;
    var selected_lang = $("#select-processor-language").val()
    if (name == "asdhs524fdbghdagfht52eg2fc") {
        is_new = true
    }
    name = document.getElementById("processor-name").value

    var api_collection = $('#api_collection li input[type=text]')

    api_collection_list = []

    api_collection.each(function () {
        api_collection_list.push($(this).attr('value'));
    });

    csrf_token = get_csrf_token();

    let field_id = '';
    if (processor == 'field') {
        field_id = get_url_vars()["field_id"];
    }

    var json_string = JSON.stringify({
        code: code,
        processor: processor,
        tree_pk: tree_pk,
        name: name,
        is_new: is_new,
        selected_lang: selected_lang,
        api_collection: api_collection_list,
        original_processor_name: original_processor_name,
        field_id: field_id,
    })

    json_string = EncryptVariable(json_string);
    json_string = encodeURIComponent(json_string);

    var xhttp = new XMLHttpRequest();
    var params = 'json_string=' + json_string
    xhttp.open("POST", "/chat/save-processor-content/", true);
    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhttp.onreadystatechange = function () {

        if (this.readyState == 4 && this.status == 200) {
            response = JSON.parse(this.responseText);
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                if (is_autosave == false) {

                    M.toast({
                        "html": "Changes saved successfully."
                    }, 2000);
                    console.log("Changes saved successfully!");
                    setTimeout(function (e) {
                        window.location.reload();
                    }, 2000);
                } else {
                    clearTimeout(autosave_session_timer)
                    document.getElementById("easychat-autosave-span").style.display = "inline-block";
                    setTimeout(function (e) {
                        document.getElementById("easychat-autosave-span").style.display = "none";
                    }, 2000)
                }
            } else if (response["status"] == 300) {

                M.toast({
                    "html": response["message"]
                })
                console.log(response["message"])
            } else if (response['status'] == 400) {
                if (check_for_system_commands(code)) {
                    M.toast({
                        "html": "Code contains system-commands. Please remove them and save again."
                    }, 2000);
                    document.getElementById("easychat-processor-status").value = "\n\nError(s):";
                    show_processor_errors();
                }
            }
        }
    }
    xhttp.send(params);



}

function delete_processor_content(processor, tree_pk, name) {
    csrf_token = get_csrf_token();
    let field_id = '';
    if (processor == 'field') {
        field_id = get_url_vars()['field_id'];
    }
    var json_string = JSON.stringify({
        processor: processor,
        tree_pk: tree_pk,
        name: name,
        field_id: field_id,
    })
    json_string = EncryptVariable(json_string);
    json_string = encodeURIComponent(json_string);

    var xhttp = new XMLHttpRequest();
    var params = 'json_string=' + json_string
    xhttp.open("POST", "/chat/delete-processor-content/", true);
    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            response = JSON.parse(this.responseText);
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                setTimeout(function (e) {
                    window.location.reload();
                }, 2000);
            }
        }
    }
    xhttp.send(params);
}

// ####################### Processor  ################
var processor = ""

function run_processor(processor) {

    processor = processor;
    var dynamic_variables = document.getElementsByClassName("easychat_dynamic_variable")

    for (var i = 0; i < dynamic_variables.length; i++) {

        if (dynamic_variables[i].value == "") {

            display_dynamic_variable_modal();
            return;
        }
    }
    run_processor_easychat(processor)
    return;
}

function run_processor_easychat(processor) {

    var dynamic_variables_list = {};
    var dynamic_variables = document.getElementsByClassName("easychat_dynamic_variable")

    for (var i = 0; i < dynamic_variables.length; i++) {

        dynamic_variables_list[dynamic_variables[i].name] = dynamic_variables[i].value;
    }
    document.getElementById("easychat-processor-status").style.display = "block"
    document.getElementById("easychat-processor-status").value = "Running ..."

    parameter = ""
    if (processor == "post" || processor == "pipe" || processor == "get_otp" || processor == "verify_otp" || processor == "field") {

        parameter = document.getElementById("easychat-processor-input").value
    }
    selected_lang = $("#select-processor-language").val();

    if (!selected_lang) {
        selected_lang = '1';
    }

    var editor = ace.edit("editor-code");
    var code = editor.getValue();

    if (check_for_system_commands(code)) {
        M.toast({
            "html": "Code contains system-commands. Please remove them and save again."
        }, 2000);
        document.getElementById("easychat-processor-status").value = "\n\nError(s):";
        show_processor_errors();
        return;
    }

    csrf_token = get_csrf_token();
    var json_string = JSON.stringify({
        code: code,
        parameter: parameter,
        processor: processor,
        selected_lang: selected_lang,
        dynamic_variables_list: dynamic_variables_list,
    })
    json_string = EncryptVariable(json_string);
    json_string = encodeURIComponent(json_string);

    var xhttp = new XMLHttpRequest();
    var params = 'json_string=' + json_string
    xhttp.open("POST", "/chat/easychat-processor-run/", true);
    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            response = JSON.parse(this.responseText);
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {

                document.getElementById("easychat-processor-status").style.display = "block";
                processor_output_text_area = document.getElementById("easychat-processor-status")
                processor_output_text_area.value = "  Output:\n\n"
                processor_output_text_area.value += "Excecution time: " + response["elapsed_time"] + "\n\n"
                for (item in response["message"]) {
                    if (typeof response["message"][item] == 'object') {
                        processor_output_text_area.value += "  " + item + ": {\n"
                        for (items in response["message"][item]) {
                            processor_output_text_area.value += "    " + items + ": " + response["message"][item][items] + "\n";
                        }
                        processor_output_text_area.value += "     }\n\n"
                    } else {
                        processor_output_text_area.value += "  " + item + ": " + response["message"][item] + "\n\n";
                    }
                }
                scroll_to_bottom()
                // console.log(response["message"]);
            } else if (response["status"] == 300) {

                document.getElementById("easychat-processor-status").style.display = "block";
                processor_output_text_area = document.getElementById("easychat-processor-status");
                processor_output_text_area.value = "Output:\n\n";
                processor_output_text_area.value += "Excecution time: " + response["elapsed_time"] + "\n\n";
                processor_output_text_area.value += "Error(s):\n\n";
                processor_output_text_area.value += response["message"];
                scroll_to_bottom();
            } else if (response["status"] == 302) {

                document.getElementById("easychat-processor-status").style.display = "block";
                processor_output_text_area = document.getElementById("easychat-processor-status");
                processor_output_text_area.value = "Output:\n\n";
                processor_output_text_area.value += "Time Limit Exceded Error(s):\n\n";
                processor_output_text_area.value += response["status_message"];
                scroll_to_bottom();
            } else if (response["status"] == 400) {

                if (check_for_system_commands(response["code"])) {

                    M.toast({
                        "html": "Code contains system-commands. Please remove them and save again."
                    }, 2000);
                    show_processor_errors();
                }
            }
        }
    }
    xhttp.send(params);
}

function scroll_to_bottom() {

    var objDiv = document.getElementById("easychat-processor-container");
    objDiv.scrollTop = objDiv.scrollHeight;
}


function display_dynamic_variable_modal() {

    var dynamic_variables = document.getElementsByClassName("easychat_dynamic_variable")

    var html = '';
    for (var i = 0; i < dynamic_variables.length; i++) {

        html += `<div class="col s6 easychat-processor-dynamic-variable-wrapper">
            <div class="easychat-processor-dynamic-variable-header">` + dynamic_variables[i].name + `<span class="red-text">*</span></div>
            <input class="easychat_dynamic_variable_modal input" name="` + dynamic_variables[i].name + `" value="` + dynamic_variables[i].value + `" placeholder="Enter value here">
          </div>`
    }

    document.getElementById("easychat-dynamic-variables-content").innerHTML = html;
    $("#easychat-dynamic-variables").modal("open");
    // $("#easychat-dynamic-variables").show();
}

function update_dynamic_variables() {

    var dynamic_variables_modal = document.getElementsByClassName("easychat_dynamic_variable_modal")
    var dynamic_variables = document.getElementsByClassName("easychat_dynamic_variable")

    for (var i = 0; i < dynamic_variables_modal.length; i++) {

        if (dynamic_variables_modal[i].value == "") {

            M.toast({
                "html": "Please fill all fields"
            }, 200);
            return;
        }
        dynamic_variables[i].value = dynamic_variables_modal[i].value;
    }
    // run_processor_easychat(processor);
}

function get_url_vars() {
    var vars = {};
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
        vars[key] = value;
    });
    return vars;
}

$(document).on("change", "#multiple-select-intent-type-filter-intent-list, #select-category-filter-intent-list", function (e) {
    value = document.getElementById("multiple-select-intent-type-filter-intent-list").value;
    category = document.getElementById("select-category-filter-intent-list").value;
    if (value != undefined) {

        bot_pk = get_url_vars()["bot_pk"];
        // selected_bot_pk = document.getElementById("multiple-select-intent-filter-bot-list").value;
        selected_bot_pk = bot_pk;

        if (bot_pk == undefined) {
            if (selected_bot_pk == undefined) {
                return;
            } else {
                bot_pk = selected_bot_pk;
            }
        }
        let selected_language = get_url_vars()['selected_language']
        if (selected_language == "" || selected_language == undefined || selected_language == null) {
            selected_language = "en";
        }

        var location = "/chat/intent/?bot_pk=" + bot_pk + "&selected_language=" + selected_language + "&intent_type=" + value;

        if (category != undefined) {
            location += "&category=" + category;
        }

        window.location = location
    }
});

function generate_table() {
    table_list_element = document.getElementById('table_list_of_list');
    if (table_list_element == null || table_list_element == undefined) {
        return;
    }
    table_matrix = document.getElementById('table_list_of_list').innerHTML;
    table_matrix = JSON.parse(table_matrix)["items"];
    if (table_matrix != "None" && table_matrix != "") {
        rows = table_matrix.length;
        columns = table_matrix[0].length;
        tableSpace = document.getElementById('table-generation-space');
        tableSpace.innerHTML = "";
        if (columns <= 4) {
            var theader = '<table style="table-layout: fixed;">\n';
            var tbody = '';

            for (var i = 0; i < rows; i++) {
                // create each row
                tbody += '<tr>';

                for (var j = 0; j < columns; j++) {
                    // create cell
                    tbody += '<td contenteditable="true"id=' + '"cell-id-' + i.toString() + j.toString() + '"' + '>';
                    tbody += un_entity(table_matrix[i][j]);
                    tbody += '</td>'
                }

                // closing row table
                tbody += '</tr>\n';

            }
            var tfooter = '</table>';

            tableSpace.innerHTML = (theader + tbody + tfooter);
        }
    }
};

function tree_generate_table() {
    table_list_element = document.getElementById('tree_table_list_of_list');
    if (table_list_element == null || table_list_element == undefined) {
        return;
    }
    table_matrix = table_list_element.innerHTML;
    table_matrix = JSON.parse(table_matrix)["items"];
    if (table_matrix != "None" && table_matrix != "") {
        rows = table_matrix.length;
        columns = table_matrix[0].length;
        tableSpace = document.getElementById('tree-table-generation-space');
        tableSpace.innerHTML = "";
        if (columns <= 4) {
            var theader = '<table style="table-layout: fixed;">\n';
            var tbody = '';

            for (var i = 0; i < rows; i++) {
                // create each row
                tbody += '<tr>';

                for (var j = 0; j < columns; j++) {
                    // create cell
                    tbody += '<td contenteditable="true"id=' + '"cell-id-' + i.toString() + j.toString() + '"' + '>';
                    tbody += un_entity(table_matrix[i][j]);
                    tbody += '</td>'
                }

                // closing row table
                tbody += '</tr>\n';

            }
            var tfooter = '</table>';

            tableSpace.innerHTML = (theader + tbody + tfooter);
        }
    }
};


function isFloatValue(value) {
    if (!isNaN(value) && value.toString().indexOf('.') != -1) {
        return true;
    } else {
        return false;
    }
}

$(document).on("click", "#create-table-from-given", function (e) {
    tableSpace = document.getElementById('table-generation-space');
    rows = document.getElementById('number-of-rows-table').value;
    columns = document.getElementById('number-of-columns-table').value;
    if (rows == "") {
        M.toast({
            "html": "No of rows cannot be empty."
        }, 2000);
        return;
    }

    if (columns == "") {
        M.toast({
            "html": "No of columns cannot be empty."
        }, 2000);
        return;
    }

    if (rows <= 0) {
        M.toast({
            "html": "No of rows should be greater than 0."
        }, 2000);
        return;
    }

    if (columns <= 0) {
        M.toast({
            "html": "No of columns should be greater than 0."
        }, 2000);
        return;
    }

    if (isFloatValue(rows)) {
        M.toast({
            "html": "No of rows cannot be float."
        }, 2000);
        return;
    }

    if (isFloatValue(columns)) {
        M.toast({
            "html": "No of columns cannot be float."
        }, 2000);
        return;
    }


    if (columns <= 4) {
        var conformation_to_table_overwrite = true;

        if (tableSpace.innerHTML != "" && tableSpace.innerHTML.indexOf('</table>') > -1) {
            var conformation_to_table_overwrite = confirm("Your previous table will be overwritten!");
        }

        if (conformation_to_table_overwrite == true) {
            tableSpace.innerHTML = "";
            var theader = '<table style="table-layout: fixed;">\n';
            var tbody = '';

            for (var i = 0; i < rows; i++) {
                // create each row
                tbody += '<tr>';

                for (var j = 0; j < columns; j++) {
                    // create cell
                    tbody += '<td contenteditable="true" id=' + '"cell-id-' + i.toString() + j.toString() + '"' + 'placeholder=' + '"' + i.toString() + j.toString() + '"' + '>';
                    tbody += '</td>';
                }

                // closing row table
                tbody += '</tr>\n';

            }
            var tfooter = '</table>';

            tableSpace.innerHTML = (theader + tbody + tfooter);
        }
    } else {
        alert("Number of columns should not exceed four");
        return;
    };
});

$(document).on("click", "#delete-table-from-given", function (e) {
    document.getElementById("create-table-from-given").disabled = false;
    rows = document.getElementById('number-of-rows-table');
    columns = document.getElementById('number-of-columns-table');
    rows.value = 0;
    columns.value = 0;
    document.getElementById("table-generation-space").innerHTML = "";
    // document.getElementById("save-intent").click();
});

$(document).on("click", "#tree-create-table-from-given", function (e) {
    tableSpace = document.getElementById('tree-table-generation-space');
    rows = document.getElementById('tree-number-of-rows-table').value;
    columns = document.getElementById('tree-number-of-columns-table').value;

    if (rows == "") {
        M.toast({
            "html": "No of rows cannot be empty."
        }, 2000);
        return;
    }

    if (columns == "") {
        M.toast({
            "html": "No of columns cannot be empty."
        }, 2000);
        return;
    }

    if (rows <= 0) {
        M.toast({
            "html": "No of rows should be greater than 0."
        }, 2000);
        return;
    }

    if (columns <= 0) {
        M.toast({
            "html": "No of columns should be greater than 0."
        }, 2000);
        return;
    }

    if (isFloatValue(rows)) {
        M.toast({
            "html": "No of rows cannot be float."
        }, 2000);
        return;
    }

    if (isFloatValue(columns)) {
        M.toast({
            "html": "No of columns cannot be float."
        }, 2000);
        return;
    }

    if (columns <= 4) {

        var conformation_to_table_overwrite = true;

        if (tableSpace.innerHTML != "" && tableSpace.innerHTML.indexOf('</table>') > -1) {
            var conformation_to_table_overwrite = confirm("Your previous table will be overwritten!");
        }

        if (conformation_to_table_overwrite == true) {
            tableSpace.innerHTML = "";
            var theader = '<table style="table-layout: fixed;">\n';
            var tbody = '';

            for (var i = 0; i < rows; i++) {
                // create each row
                tbody += '<tr>';

                for (var j = 0; j < columns; j++) {
                    // create cell
                    tbody += '<td contenteditable="true" id=' + '"cell-id-' + i.toString() + j.toString() + '"' + 'placeholder=' + '"' + i.toString() + j.toString() + '"' + '>';
                    tbody += '</td>';
                }

                // closing row table
                tbody += '</tr>\n';

            }
            var tfooter = '</table>';

            tableSpace.innerHTML = (theader + tbody + tfooter);
        }
    } else {
        alert("Number of columns should not exceed four");
        return;
    };
});

$(document).on("click", "#tree-delete-table-from-given", function (e) {
    document.getElementById("tree-create-table-from-given").disabled = false;

    rows = document.getElementById('tree-number-of-rows-table');
    columns = document.getElementById('tree-number-of-columns-table');
    rows.value = 0;
    columns.value = 0;
    document.getElementById("tree-table-generation-space").innerHTML = ""
    // document.getElementById("save-tree").click();
});

// **********************************   Termination Keyword   ****************

function check_for_chips() {
    var termination_keyword_list = M.Chips.getInstance($('#flow_termination_keywords')).chipsData;
    if (termination_keyword_list.length) {
        $('#flow_termination_bot_response').trumbowyg('enable');
    } else {
        $('#flow_termination_bot_response').trumbowyg('html', '');
        $('#flow_termination_bot_response').trumbowyg('disable');

    }
}
if (window.location.pathname.indexOf("/chat/channels/web") != -1) {

    $("#welcome-banner-list").sortable({
        containment: 'parent',
    })

    add_language_extend_button_event_listner()
}

if (window.location.pathname.indexOf("/chat/bot/edit") != -1) {

    $(document).ready(function () {
        try {

            if (IS_PDF_SEARCH_ACCESS_ALLOWED != "True") {
                document.getElementById("easychat-checkbox-pdfsearch-enable").disabled = true;
            }
            if (IS_LEAD_GENRATION_ACCESS_ALLOWED != "True") {
                document.getElementById("checkbox-bot-lead-generation-enabled").disabled = true;
            }

        } catch (err) {
            console.log(err)
        }
    });

}


if (window.location.pathname.indexOf("/chat/bot/edit") != -1) {

    $('#bot_settings_tab').on('click', function () {
        if (!build_bot_timer) {
            track_build_bot_progress();
            build_bot_timer = setInterval(track_build_bot_progress, 5000);
        }
    })

    try {
        selected_channels_list_nps = $('#multi-select-channels').val();
        const WhatsAppValue = selected_channels_list_nps.some(element => {
            return element.toLowerCase() === "WhatsApp".toLowerCase();
        });
        const ViberValue = selected_channels_list_nps.some(element => {
            return element.toLowerCase() === "Viber".toLowerCase();
        });
        const WebValue = selected_channels_list_nps.some(element => {
            return element.toLowerCase() === "Web".toLowerCase();
        });
        if (WhatsAppValue) {
            document.getElementById("whatsapp-nps-timer").style.display = 'table-row';
        } else {
            document.getElementById("whatsapp-nps-timer").style.display = 'none';
        }

        if (ViberValue) {
            document.getElementById("viber-nps-timer").style.display = 'table-row';
        } else {
            document.getElementById("viber-nps-timer").style.display = 'none';
        }

        if (WebValue) {
            document.getElementById("csat-configuration").style.display = 'table-row';
        } else {
            document.getElementById("csat-configuration").style.display = 'none';
        }

        $('#multi-select-channels').on('change', function () {
            var selected_channels = $('#multi-select-channels').val();
            const WebValue = selected_channels.some(element => {
                return element.toLowerCase() === "Web".toLowerCase();
            });
            if (WebValue) {
                document.getElementById("csat-configuration").style.display = 'table-row';
            } else {
                document.getElementById("csat-configuration").style.display = 'none';
            }
        })

    } catch { }
    $('#easychat_order_of_responses').sortable({
        scroll: true,
        scrollSensitivity: 10,
        containment: 'parent',
    })

    //Sortable.mount(new AutoScroll());

    var stop_words, added_words = [],
        deleted_words = [];
    var selected_bot_pk = window.location.href.split("/")[6]
    $("#flow_termination_keywords").chips({
        onChipAdd: check_for_chips,
        onChipDelete: check_for_chips,
    });
    let selected_language = get_url_vars()['selected_language']
    if (selected_language.length > 2) {
        selected_language = selected_language.substring(0, 2)
    }
    if (selected_language == undefined || selected_language == null) {
        selected_language = "en"
    }

    csrf_token = get_csrf_token();
    json_string = JSON.stringify({
        selected_bot_pk: selected_bot_pk,
        selected_language: selected_language,
    });

    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/bot/get-general-details/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {

                keywords = response["flow_termination_keywords"]
                data = []
                for (var i = 0; i < keywords.length; i++) {

                    data.push({
                        "tag": keywords[i]
                    });
                }
                setTimeout(function () {

                    $("#flow_termination_bot_response").trumbowyg({
                        tagsToKeep: [],
                        defaultLinkTarget: '_blank',
                        allowTagsFromPaste: {
                            allowedTags: ['h4', 'p', 'br']
                        },
                        minimalLinks: true,
                        btns: [
                            // ['viewHTML'],
                            ['strong', 'em'],
                            ['link'],
                            ['unorderedList', 'orderedList'],
                            ['underline'],
                            ['emoji'],
                        ],
                    }).on('tbwinit', function () {
                        $('#flow_termination_bot_response').trumbowyg('html', response["flow_termination_bot_response"]);
                    });

                    $("#flow_termination_confirmation_display_message").trumbowyg({
                        tagsToKeep: [],
                        defaultLinkTarget: '_blank',
                        allowTagsFromPaste: {
                            allowedTags: ['h4', 'p', 'br']
                        },
                        minimalLinks: true,
                        btns: [
                            // ['viewHTML'],
                            ['strong', 'em'],
                            ['link'],
                            ['unorderedList', 'orderedList'],
                            ['underline'],
                            ['emoji'],
                        ],
                    }).on('tbwinit', function () {
                        $('#flow_termination_confirmation_display_message').trumbowyg('html', response["flow_termination_confirmation_display_message"]);
                    });


                    if (keywords.length) {
                        // $('.chips').chips();
                        is_flow_termination_bot_response_required = true
                        $("#flow_termination_keywords").chips({
                            data: data,
                            onChipAdd: check_for_chips,
                            onChipDelete: check_for_chips,
                        });
                        $('#flow_termination_confirmation_display_message').trumbowyg('enable');


                    } else {
                        $('#flow_termination_confirmation_display_message').trumbowyg('html', '');
                        $('#flow_termination_confirmation_display_message').trumbowyg('disable');

                    }

                    $(".emoji-response").trumbowyg({
                        tagsToKeep: [],
                        defaultLinkTarget: '_blank',
                        allowTagsFromPaste: {
                            allowedTags: ['h4', 'p', 'br']
                        },
                        minimalLinks: true,
                        btns: [
                            // ['viewHTML'],
                            ['strong', 'em'],
                            ['link'],
                            ['unorderedList', 'orderedList'],
                            ['underline'],
                            ['emoji'],
                        ],
                    }).on('tbwinit', function () {
                        $('#angry-emoji-response').trumbowyg('html', response["emoji_angry_response_text"]);
                        $('#happy-emoji-response').trumbowyg('html', response["emoji_happy_response_text"]);
                        $('#neutral-emoji-response').trumbowyg('html', response["emoji_neutral_response_text"]);
                        $('#sad-emoji-response').trumbowyg('html', response["emoji_sad_response_text"]);
                    });
                    var add_intent_livechat_object = JSON.parse(response["add_livechat_intent"])
                    enable_emoji_livechat_checkbox(window.is_livechat_enabled, add_intent_livechat_object)

                }, 1500)




                try {
                    stop_words = response['stop_words'];
                    configure_stop_words()



                    default_order_of_response = response['default_order_of_response'];
                    configure_default_order_of_response();
                } catch (err) {
                    console.log(err)
                }
            }
        },
        error: function (jqXHR, exception) {
            console.log(jqXHR, exception);
        }
    });
    try {

        try {
            var easy_search_value = document.getElementById("search-filter").value;
        } catch { }
        if (easy_search_value == "1") {
            document.getElementById("e-search-functionality").style.display = "block"
            document.getElementById("g-search-functionality").style.display = "none"
        } else if (easy_search_value == "2") {
            document.getElementById("g-search-functionality").style.display = "block"
            document.getElementById("e-search-functionality").style.display = "none"
        }
        // }catch{}


        add_tms_categories();
        // //////////////

        // ///////////
        var feedback_config_elem = document.getElementById('checkbox-csat-feedback');
        toggle_csat_feedback_checkbox(feedback_config_elem)

        document.getElementById("add_drop_down_tms_cat")
            .addEventListener("keyup", function (event) {
                event.preventDefault();
                if (event.keyCode === 13) {
                    value = document.getElementById("add_drop_down_tms_cat").value;
                    value = value.trim()
                    regex = /^[a-zA-Z0-9_ ]+$/
                    var tms_cat_drop_down_list = get_tms_cat_drop_down_list()
                    if (tms_cat_drop_down_list.includes(value.toLowerCase())) {
                        showToast("Category with the same name already exists.", 2000)
                    } else if (!regex.test(value)) {
                        showToast("Category Name should contain only Alphabets and Numbers.Special Characters are not allowed", 2000)
                    } else if (value.length > tms_cat_limit) {
                        showToast("Category Name should be less than " + tms_cat_limit + " Characters", 2000)
                    } else {
                        add_tms_drop_down_cat_collection(value);
                    }
                    document.getElementById("add_drop_down_tms_cat").value = "";
                }
            });
    } catch { }
    let url_selected_language = get_url_vars()['selected_language']
    $(document).ready(function () {
        create_language_custom_dropdowns_for_bot_configuration();
        if (NEED_TO_SHOW_AUTO_FIX_MODAL == "True") {
            setTimeout(function () {
                $('#edit-response-language-settings-modal').modal('open');
            }, 300)
        }

        try {
            auto_grow_textarea(document.getElementById("bot-response-delay-msg"))
        } catch { }
        try {
            auto_grow_textarea(document.getElementById("bot-inactivity-msg"))
        } catch { }


    });
    add_language_selction_event_for_bot_configuration()
    add_language_dropdown_search_event()

    language_dropdown_close_onclicking_outside_event()
    language_search_dropdown_event()
    open_close_language_dropdown_event_configurations()
    $(document).on("click", "#ignore-non-primary-bot-configuration", function (e) {
        ignore_bot_configuration_changes_in_non_primary_languages(selected_bot_pk);
    });
    $(document).on("click", "#auto-fix-non-primary-bot-configuration", function (e) {
        auto_fix_bot_configuration_changes_in_non_primary_languages(selected_bot_pk);
    });
}


function enable_emoji_livechat_checkbox(is_enabled_livechat, add_intent_livechat_object) {

    if (add_intent_livechat_object["angry"] == "True") {
        document.getElementById("angry-emoji-response-livechat").checked = true
    }

    if (add_intent_livechat_object["happy"] == "True") {
        document.getElementById("happy-emoji-response-livechat").checked = true
    }

    if (add_intent_livechat_object["neutral"] == "True") {
        document.getElementById("neutral-emoji-response-livechat").checked = true
    }

    if (add_intent_livechat_object["sad"] == "True") {
        document.getElementById("sad-emoji-response-livechat").checked = true
    }


}

function check_for_duplicates_in_tms_cat(toast_text = "") {
    let cat_list = get_tms_cat_drop_down_list()
    let map = {};
    let result = false;
    regex = /^[a-zA-Z0-9_ ]+$/
    if (cat_list.length == 0) {
        showToast("At least one choice in TMS Dropdown Category is required.", 2000)
        return true
    }
    for (let i = 0; i < cat_list.length; i++) {
        cat_list[i] = cat_list[i].trim().toLowerCase()
        if (!regex.test(cat_list[i])) {
            showToast("Category Name should contain only Alphabets and Numbers.Special Characters are not allowed", 2000)
            return true
        }
        if (map[cat_list[i]]) {
            result = true;
            break;
        }
        map[cat_list[i]] = true;
    }
    if (result) {
        if (toast_text == "") {
            toast_text = "Category with the same name already exists."
        }
        showToast(toast_text, 2000)
        return true
    } else {
        $('#modal-add-tms-category').modal('close');
    }
    return false
}

function add_tms_categories() {
    let values = window.tms_cat_drop_down_choices_value.split("_")
    if (values != []) {
        for (var i = 0; i < values.length; i++) {
            value = values[i];
            add_tms_drop_down_cat_collection(value)
        }
    }
}

$(document).on("change", "#checkbox-bot-form-assist-enabled", function (e) {
    checkbox_form_assist_enbaled = document.getElementById("checkbox-bot-form-assist-enabled").checked;
    if (checkbox_form_assist_enbaled == false) {
        document.getElementById("is-form-assist-auto-popup-allowed").checked = false;
        $("#is-bot-auto-popup-allowed").removeAttr("disabled", "disabled");
    }
});

function configure_default_order_of_response() {
    if (default_order_of_response.length == 0) {
        default_order_of_response = ['text', 'image', 'table', 'video', 'link_cards', 'intent_level_feedback', 'quick_recommendations', 'drop_down', 'date_picker', 'checkbox', 'radio_button', 'range_slider', 'form', 'time_picker', 'calendar_picker', 'file_attach', 'video_record', 'phone_number'];
    }

    let order_div = document.getElementById('easychat_order_of_responses');
    let drag_img = '<span class="easychat-drag-response"><img src="/static/EasyChatApp/img/dragger.svg"></span>';
    let response_item;

    order_div.innerHTML = ''
    for (res of default_order_of_response) {
        response_item = '<div class="easychat-intent-response-item">' + res + drag_img + '</div>';
        $(order_div).append(response_item);
    }
}

function save_default_response() {
    $('#modal-configure-default-response').modal('close');
}

function cancel_default_response() {
    configure_default_order_of_response();
    $('#modal-configure-default-response').modal('close');
}

function configure_stop_words() {
    $('#stop_words_div').chips({
        onChipDelete: function (e, data) {
            delete_stop_words(e, data)
        },
        onChipAdd: function (e, data) {
            add_stop_words(e, data)
        }
    });

    var alphabets = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
    var html = '';
    for (alphabet of alphabets) {
        html += '<option value = ' + alphabet + '>' + alphabet + '</option>';
    }

    document.getElementById('filter-stop-words').innerHTML = html;
    if (typeof stop_words == 'string') {
        stop_words = stop_words.replace('[', '');
        stop_words = stop_words.replace(']', '');
        stop_words = stop_words.split(',');
    }

    var elem = $('#stop_words_div');
    var instance = M.Chips.getInstance(elem)
    for (let i = 0; i < stop_words.length; ++i) {
        stop_word = stop_words[i].trim();

        if (stop_word.charAt(0) == '"') {
            stop_word = stop_word.replace(/"/g, "");

        } else {
            stop_word = stop_word.replace(/'/g, "");
        }

        stop_words[i] = stop_word;

        if (stop_word.charAt(0) == 'a' || stop_word.charAt(0) == 'A') {
            instance.addChip({
                tag: stop_word
            });
        }
    }
}

function stop_words_filter(elem) {
    if (elem == undefined) {
        elem = document.getElementById('filter-stop-words');
    }
    var selected_alphabet = elem.value;

    var elem = $('#stop_words_div');
    elem.chips({
        data: [],
        onChipDelete: function (e, data) {
            delete_stop_words(e, data)
        },
        onChipAdd: function (e, data) {
            add_stop_words(e, data)
        }
    });
    var instance = M.Chips.getInstance(elem)
    for (stop_word of stop_words) {
        if (stop_word.charAt(0) == selected_alphabet.toLowerCase() || stop_word.charAt(0) == selected_alphabet) {
            instance.addChip({
                tag: stop_word
            });
        }
    }
}

function delete_stop_words(e, data) {
    var deleted_word = data.childNodes[0].textContent;

    if (stop_words.includes(deleted_word) == true) {
        deleted_words.push(deleted_word);
    }
}

function add_stop_words(e, data) {
    var added_word = data.childNodes[0].textContent;
    var selected_alphabet = document.getElementById('filter-stop-words').value;
    var need_to_delete = false;
    var alphabets = /^[A-Za-z/']+$/;

    if (!added_word.match(alphabets)) {
        M.toast({
            "html": "Invalid input!"
        },
            2000)

        need_to_delete = true;

    } else if (added_word[0].toLowerCase() != selected_alphabet.toLowerCase()) {
        M.toast({
            "html": "Invalid input. Please enter stop words starting with " + selected_alphabet + " only"
        },
            2000)

        need_to_delete = true;
    } else if (stop_words.includes(added_word) == false && stop_words.join('|').toLowerCase().split('|').includes(added_word.toLowerCase())) {
        need_to_delete = true;
    } else if (added_words.join('|').toLowerCase().split('|').includes(added_word.toLowerCase())) {
        need_to_delete = true;
    }

    if (need_to_delete) {
        var added_el = e[0].M_Chips.chipsData
        var ind = added_el[added_el.length - 1]
        var elem = $('#stop_words_div');
        var instance = M.Chips.getInstance(elem);
        instance.deleteChip(added_el.length - 1);
    }

    if (!need_to_delete && stop_words.includes(added_word) == false) {
        added_words.push(added_word);
    }
}

function go_back_stop_words_modal() {
    document.getElementById('stop-words-modal-content-before').style.display = 'block';
    document.getElementById('stop-words-modal-content-after').style.display = 'none';
    document.getElementById('stop-words-modal-cancel').style.display = 'inline-block';
    document.getElementById('save-all-intents-modal-cancel').style.display = 'none';
    document.getElementById('stop-words-modal-save').style.display = 'inline-block';
    document.getElementById('stop-words-modal-save-all-intents').style.display = 'none';
    document.getElementById('stop-words-modal-go-back').style.display = 'none';
}

function go_to_next_stop_words_modal() {
    document.getElementById('stop-words-modal-content-before').style.display = 'none';
    document.getElementById('stop-words-modal-content-after').style.display = 'block';
    document.getElementById('stop-words-modal-cancel').style.display = 'none';
    document.getElementById('save-all-intents-modal-cancel').style.display = 'inline-block'
    document.getElementById('stop-words-modal-save').style.display = 'none';
    document.getElementById('stop-words-modal-save-all-intents').style.display = 'inline-block';
    document.getElementById('stop-words-modal-go-back').style.display = 'inline-block';
}

function resave_all_intents() {
    document.getElementById('stop-words-modal-content-saving').style.display = 'block';
    document.getElementById('stop-words-modal-content-after').style.display = 'none';
    document.getElementById('stop-words-modal-save').style.display = 'none';
    document.getElementById('stop-words-modal-cancel').style.display = 'none';
    document.getElementById('stop-words-modal-save-all-intents').style.display = 'none';
    document.getElementById('stop-words-modal-go-back').style.display = 'none';
    document.getElementById('save-all-intents-modal-cancel').style.display = 'none';

    let bot_id = window.location.pathname.split("/")[4];
    json_string = JSON.stringify({
        "bot_id": bot_id,
    });
    json_string = EncryptVariable(json_string)

    $.ajax({
        url: "/chat/resave-all-intents/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response);
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "All intents have been resaved!"
                }, 2000);

                $('#modal-configure-stop-words').modal('close');
                go_back_stop_words_modal();

                setTimeout(function () {
                    window.location.reload();
                }, 3000);
            } else {
                M.toast({
                    "html": "Some error occured"
                }, 2000);
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log(xhr);
            console.log(textstatus);
            console.log(errorthrown);
        }
    });

}

function save_stop_words() {
    var words_to_add = [];
    for (stop_word of stop_words) {
        if (deleted_words.includes(stop_word) == false) {
            words_to_add.push(stop_word);
        }
    }

    for (added_word of added_words) {
        if (deleted_words.includes(added_word) == false) {
            words_to_add.push(added_word);
        }
    }

    bot_id = window.location.pathname.split("/")[4];

    json_string = JSON.stringify({
        "bot_id": bot_id,
        "bot_stop_keywords": words_to_add,
    });
    json_string = EncryptVariable(json_string)

    $.ajax({
        url: "/chat/save-stop-words/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                go_to_next_stop_words_modal();
            } else {
                M.toast({
                    "html": "Unable to save stop words"
                }, 2000);
            }
        },
        error: function (xhr, textstatus, errorthrown) { }
    });
}

function cancel_save_all_intents_modal() {
    go_back_stop_words_modal();
    $('#modal-configure-stop-words').modal('close');

    setTimeout(function () {
        window.location.reload();
    }, 3000);
}

function cancel_stop_words_modal() {
    deleted_words = [];
    added_words = [];
    go_back_stop_words_modal();
    $('#modal-configure-stop-words').modal('close');
}

function disable_small_talk(bot_id) {
    csrf_token = get_csrf_token();
    json_string = JSON.stringify({
        "bot_id": bot_id
    });
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/disable-small-talk/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Small Talk has been disabled successfully."
                }, 2000);
                setTimeout(function () {
                    window.location.reload();
                }, 2000);
            } else {
                M.toast({
                    "html": response["message"]
                }, 2000);
            }
        },
        error: function (jqXHR, exception) {
            console.log(jqXHR, exception);
        }
    });
}

function enable_small_talk(bot_id) {
    csrf_token = get_csrf_token();
    json_string = JSON.stringify({
        "bot_id": bot_id
    });
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/enable-small-talk/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Small Talk has been enabled successfully."
                }, 2000);
                setTimeout(function () {
                    window.location.reload();
                }, 2000);
            } else {
                M.toast({
                    "html": response["message"]
                }, 2000);
            }
        },
        error: function (jqXHR, exception) {
            console.log(jqXHR, exception);
        }
    });
}

function create_flow_excel() {

    intent_id = get_url_vars()["intent_pk"]

    var my_excel_file = ($("#my_excel_file"))[0].files[0];

    if (my_excel_file == undefined || my_excel_file == null) {
        M.toast({
            "html": "Please provide excel sheet in required format."
        }, 2000);
        return;
    }

    if (check_malicious_file(my_excel_file.name) == true) {
        return;
    }

    var formData = new FormData();
    formData.append("my_excel_file", my_excel_file);
    formData.append("intent_id", intent_id);
    $.ajax({
        url: "/chat/create-flow-excel/",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
            console.log(response)
            if (response['status'] == 200) {
                M.toast({
                    'html': response["message"]
                }, 2000);
                setTimeout(function () {
                    window.location = '/chat/edit-intent/?intent_pk=' + intent_id;
                }, 3000);
            } else if (response['status'] == 101) {
                M.toast({
                    'html': response["message"]
                }, 2000);
            } else if (response['status'] == 300) {
                M.toast({
                    'html': response["message"]
                }, 2000);
            } else {
                try {
                    M.toast({
                        'html': response["status_message"]
                    }, 2000);
                } catch (e) {
                    console.log(e)
                    // M.toast({'html':"Please check excel file format"}, 2000);
                }
                //M.toast({'html':"Please check excel file format"}, 2000);
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
}

function show_select(bot_id) {
    selected_misdashboard_list = document.getElementsByClassName("selected-misdashboard");
    // console.log(selected_misdashboard_list);
    chosen_bot_id = ""
    for (var i = 0; i < selected_misdashboard_list.length; i++) {
        id = selected_misdashboard_list[i].id;
        flag = false;
        // if (document.getElementById(id).checked == true) {
        //     message_history_id = id.split('-')[4];
        //     console.log(message_history_id);
        //     bot_id = document.getElementById("message-history-bot-id-"+message_history_id).getAttribute('value');
        //     console.log(bot_id);
        //     if(chosen_bot_id == "")
        //     {
        //       chosen_bot_id = bot_id;
        //     }
        //     else if(chosen_bot_id != bot_id && mess)
        //     {
        //       flag == true;
        //       alert("The messages should belong to same bot!");
        //     }
        // }

        chosen_bot_id = bot_id;
        if (flag == false) {
            $(".modal-message-history-action").modal();
            $("#modal-message-history-action").modal('open');
            document.getElementById("match-intent-btn").disabled = true;
            $.ajax({
                url: '/fetch-intents-of-bot-selected/',
                type: "POST",
                headers: {
                    "X-CSRFToken": get_csrf_token()
                },
                data: {
                    'bot_pk': chosen_bot_id,
                },
                success: function (response) {
                    if (response["status"] == 200) {

                        intents = response["intents"];
                        intent_list = '';
                        intent_list += "<option value= 'select_intent' selected> Select Intent </option>";
                        for (var i = 0; i < intents.length; i++) {
                            intent_list += "<option value=" + intents[i]['pk'] + ">" + intents[i]["name"] + "</option>";
                        }
                        document.getElementById("select-show-bot-intent").innerHTML = intent_list;
                        $("#select-show-bot-intent").select2({
                            dropdownParent: $("body"),
                            width: "100%",
                        });
                    }
                },
                error: function (xhr, textstatus, errorthrown) {
                    console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
                }
            });

        }
    }
    document.getElementById("show-bot-intent").style.display = "block";
}

function show_select_message_history(bot_id) {
    selected_misdashboard_list = document.getElementsByClassName("selected-misdashboard");
    // console.log(selected_misdashboard_list);
    chosen_bot_id = ""
    flag = false;


    chosen_bot_id = bot_id;
    if (flag == false) {
        $(".modal-message-history-action").modal();
        $("#modal-message-history-action").modal('open');
        document.getElementById("match-intent-btn").disabled = true;
        $.ajax({
            url: '/fetch-intents-of-bot-selected/',
            type: "POST",
            headers: {
                "X-CSRFToken": get_csrf_token()
            },
            data: {
                'bot_pk': chosen_bot_id,
            },
            success: function (response) {
                if (response["status"] == 200) {

                    intents = response["intents"];
                    intent_list = '';
                    intent_list += "<option value= 'select_intent' selected> Select Intent </option>";
                    for (var i = 0; i < intents.length; i++) {
                        intent_list += "<option value=" + intents[i]['pk'] + ">" + intents[i]["name"] + "</option>";
                    }
                    document.getElementById("select-show-bot-intent").innerHTML = intent_list;
                    $("#select-show-bot-intent").select2({
                        dropdownParent: $("body"),
                        width: "100%",
                    });

                }
            },
            error: function (xhr, textstatus, errorthrown) {
                console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
            }
        });

    }

    document.getElementById("show-bot-intent").style.display = "block";
}

function disable_submit_btn() {

    select_option_value = document.getElementById("select-show-bot-intent").value;

    if (select_option_value == 'select_intent') {

        $('#match-intent-btn').attr('disabled', 'disabled');
    } else {

        $('#match-intent-btn').removeAttr('disabled')

    }

}

function map_message_to_intent() {
    chosen_intent_pk = document.getElementById("select-show-bot-intent").value;
    chosen_intent_name = document.getElementById("select-show-bot-intent").textContent;
    if(chosen_intent_pk == "select_intent") {
        M.toast({
            "html": "Please select a valid intent!"
        });
        return;
    }
    message_history_ids = [];
    for (var i = 0; i < selected_misdashboard_list.length; i++) {
        id = selected_misdashboard_list[i].id;
        flag = false;
        if (document.getElementById(id).checked == true) {
            message_history_id = id.split('-')[4];
            message_history_ids.push(parseInt(message_history_id))
        }
    }
    $.ajax({
        url: '/match-message-with-intent/',
        type: "POST",
        headers: {
            "X-CSRFToken": get_csrf_token()
        },
        data: {
            'message_history_ids': message_history_ids,
            'intent_pk': chosen_intent_pk,
        },
        success: function (response) {
            console.log(response)
            if (response["status"] == 200) {
                $("#modal-message-history-action").modal('close');
                $("#modal-message-history-action-warning").modal('open');


            } else if (response["status"] == 300) {
                $("#modal-message-history-action").modal('close');
                $("#modal-message-history-action-error").modal('open');
                unmatched_message_list = response["message_not_matched"]
                message_list = ''
                for (var i = 0; i < unmatched_message_list.length; i++) {
                    message_list += '<li style="list-style-type:disc;margin-left:10%">';
                    message_list += unmatched_message_list[i];
                    message_list += '</li>';
                }
                document.getElementById("unmatched-message-list").innerHTML = message_list;
                $('[data-toggle="tooltip"]').tooltip();
                $('.tooltipped').tooltip();
            } else {
                $("#modal-message-history-action").modal('close');
                M.toast({
                    "html": "Internal Server Error. Try again later!"
                });
            }
            action_taken_dict = response['action_taken'];
            for (var i = 0; i < message_history_ids.length; i++) {
                id = message_history_ids[i];
                action_taken_string = ''
                action_taken_string += '<li>';
                action_taken_string += action_taken_dict[id]['match']['message'];
                action_taken_string += '</li>';

                document.getElementById('message-history-action-taken-' + id).innerHTML = action_taken_string;
                $('.tooltipped').tooltip();
            }

        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
}

function close_message_error_modal() {
    $("#modal-message-history-action-error").modal("close");
}

function close_message_warning_modal() {
    $("#modal-message-history-action-warning").modal("close");
}

//////////////////////// Variations Beta //////////////////////////////
$(document).on('click', '#suggest-variations-btn', function () {
    var selected_bot_pk = $("#multiple-select-bot-choice-pk-list").val()
    var intent_name = $("#intent_name").val()
    var json_string = JSON.stringify({
        intent_name: intent_name,
        bot_id: selected_bot_pk,
        page_no: 1
    });
    document.getElementById("suggest-variations-btn").innerHTML = "Generating...."
    setTimeout(function () {
        json_string = EncryptVariable(json_string);
        $.ajax({
            url: '/chat/get-variations/',
            type: "POST",
            data: {
                json_string: json_string
            },
            dataType: "json",
            async: false,
            success: function (response) {
                response = custom_decrypt(response)
                response = JSON.parse(response);
                document.getElementById("suggest-variations-btn").innerHTML = '<i class="inline-icon material-icons">add</i> Suggest Variations <sup><b> BETA</b></sup>'
                if (response['status'] == 200) {
                    variations = response["variation_list"]
                    more_var = response["more_var"]
                    $("#show-more-variations").hide()
                    if (more_var) {
                        temp_string = "add_more_variation('" + bot_id + "','" + intent_name + "',1)"
                        document.getElementById("show-more-variations").setAttribute("onclick", temp_string)
                        $("#show-more-variations").show()
                    }
                    let training_sentences = $('#intent-training-collection li input[type=text]')

                    let training_sentences_list = []

                    training_sentences.each(function () {
                        training_sentences_list.push($(this).attr('value'));
                    });
                    variations = variations.reduce((result, sentence)=>{
                        if (training_sentences_list.includes(sentence.trim()) == false) {
                            result.push(sentence)
                        }
                        return result
                    }, [])
                    if (variations.length > 0) {
                        for (var i = 0; i < variations.length; i++) {
                            addIntentTrainingDataIntoCollection(variations[i]);
                        }
                        M.toast({
                            'html': "Variations added successfully!",
                            'displayLength': 3000
                        }, 2000);
                    } else {
                        M.toast({
                            'html': "No Variations generated!",
                            'displayLength': 3000
                        }, 2000);
                    }
                } else {
                    M.toast({
                        'html': "Error while generating Variations!",
                        'displayLength': 3000
                    }, 2000);
                }
            }
        });
    }, 1000)
});

function add_more_variation(bot_pk, intent_name, page_no) {
    // var selected_bot_pk = $("#multiple-select-bot-choice-pk-list").val()
    // var intent_name = $("#intent_name").val()
    var json_string = JSON.stringify({
        intent_name: intent_name,
        bot_id: bot_pk,
        page_no: page_no
    });
    document.getElementById("show-more-variations").innerHTML = "Showing..."
    setTimeout(function () {
        json_string = EncryptVariable(json_string);
        $.ajax({
            url: '/chat/get-variations/',
            type: "POST",
            data: {
                json_string: json_string
            },
            dataType: "json",
            async: false,
            success: function (response) {
                response = custom_decrypt(response)
                response = JSON.parse(response);
                document.getElementById("suggest-variations-btn").innerHTML = '<i class="inline-icon material-icons">add</i> Suggest Variations <sup><b> BETA</b></sup>'
                if (response['status'] == 200) {
                    variations = response["variation_list"]
                    more_var = response["more_var"]
                    document.getElementById("show-more-variations").innerHTML = "Show More"
                    $("#show-more-variations").hide()
                    if (more_var) {
                        temp_string = "add_more_variation('" + bot_id + "','" + intent_name + "'," + (page_no + 1) + ")"
                        document.getElementById("show-more-variations").setAttribute("onclick", temp_string)
                        $("#show-more-variations").show()
                    }
                    let training_sentences = $('#intent-training-collection li input[type=text]')

                    let training_sentences_list = []

                    training_sentences.each(function () {
                        training_sentences_list.push($(this).attr('value'));
                    });
                    variations = variations.reduce((result, sentence)=>{
                        if (training_sentences_list.includes(sentence.trim()) == false) {
                            result.push(sentence)
                        }
                        return result
                    }, [])
                    if (variations.length > 0) {
                        for (var i = 0; i < variations.length; i++) {
                            addIntentTrainingDataIntoCollection(variations[i]);
                        }
                        M.toast({
                            'html': "Variations added successfully!",
                            'displayLength': 3000
                        }, 2000);
                    } else {
                        M.toast({
                            'html': "No Variations generated!",
                            'displayLength': 3000
                        }, 2000);
                    }
                } else {
                    document.getElementById("show-more-variations").innerHTML = "Show More"
                    M.toast({
                        'html': "Error while generating Variations!",
                        'displayLength': 3000
                    }, 2000);
                }
            }
        });
    }, 1000)
};

function submit_request_for_package_installation(element) {
    csrf_token = get_csrf_token();
    bot_id = document.getElementById("selected-bot-for-package").value;
    if (bot_id == "None") {
        showToast("Please select valid bot");
        return;
    }

    package = document.getElementById("new-package-name").value;
    if (package.trim() == "") {
        showToast("Please enter valid package name");
        return;
    }

    description = document.getElementById("new-package-description").value;
    if (description.trim() == "") {
        showToast("Please provide reason for package installation");
        return;
    }

    json_string = JSON.stringify({
        "bot_id": bot_id,
        "package": package,
        "description": description
    });

    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/submit-package-install-request/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response);
            response = JSON.parse(response);
            if (response.status == 200) {
                M.toast({
                    "html": "Request for package installation has been submitted!"
                }, 2000);
                setTimeout(function () {
                    window.location.reload();
                }, 2000);
            } else {
                M.toast({
                    "html": "Unable to submit your request"
                }, 2000);
            }
        },
        error: function (jqXHR, exception) {
            console.log(jqXHR, exception);
        }
    });
}

function take_package_installation_action(element, action, package_manager_id) {

    csrf_token = get_csrf_token();

    json_string = JSON.stringify({
        "package_manager_id": package_manager_id,
        "action": action
    });

    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/take-action-package-install/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response);
            response = JSON.parse(response);
            if (response.status == 200) {
                M.toast({
                    "html": "Review has been submitted!"
                }, 2000);
                setTimeout(function () {
                    window.location.reload();
                }, 2000);
            } else {
                M.toast({
                    "html": "Unable to submit your review"
                }, 2000);
            }
        },
        error: function (jqXHR, exception) {
            console.log(jqXHR, exception);
        }
    });
}

if (window.location.href.indexOf("/chat/package-installer") != -1) {
    $(document).ready(function () {
        $('#table-package-installation').DataTable({
            dom: 'Bfrtip',
            "pageLength": 200,
            "paging": true,
            "ordering": false,
        });
    });
}

function submit_filter_data_model(bot_pk) {
    var selected_user = $("#data-model-userid-filter").val()
    var selected_variable = $("#data-model-variable-filter").val()
    if(selected_user == ""){
        selected_user = "All"
    }
    if(selected_variable == ""){
        selected_variable = "All"
    }
    window.location = '/chat/data-model-entries/?bot_pk=' + bot_pk + '&selected_user=' + selected_user + '&selected_variable=' + selected_variable
}

function delete_filter_chosen(ele) {
    if ($(ele).parent().parent().attr("filter_parameter").indexOf("date_to") != -1) {
        $(ele).parent().parent().prev().remove();
    }
    ele.parentNode.parentNode.remove();
}

function show_import_intent_modal() {
    $("#modal-import-intent-json").modal('open');
}

function fetch_metadata() {
    var sso_metadata = String($("#sso_metadata_content").val())
    csrf_token = get_csrf_token()

    json_string = JSON.stringify({
        "sso_metadata": sso_metadata,
    });
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/sso-data-functionality/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "SSO metadata saved!"
                }, 2000)

            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        }
    });
}

function download_metadata_file() {
    window.location = "/chat/sso-data-functionality/"
}



///////////////// API analytics  //////////////////////
var filter_type = "last_month"


function submit_api_analytics_filter(bot_pk) {
    try {
        filter_type = document.getElementById("modal-api-analytics").value
    } catch {
        filter_type = document.getElementById("modal-api-statistics").value
    }
    var api_name = $("#select-api-name").val()
    var api_status = $("#select-api-status").val()
    var start_date = $("#api-analytics-default-start-date").val()
    var end_date = $("#api-analytics-default-end-date").val()
    var user_id = $("#select-api-user-id").val()
    var start_datetime = new Date(start_date);
    var end_datetime = new Date(end_date);
    if (start_datetime > end_datetime) {

        alert("\"Start Date\" should be less than \"End Date\"")
        return;
    }
    if (filter_type == "custom_timestamp") {
        var date = $("#api-analytics-timestamp-date").val()
        var start_time = $("#api-analytics-timestamp-start-time").val()
        var end_time = $("#api-analytics-timestamp-end-time").val()
        if (start_time > end_time) {
            alert("\"Start Date\" should be less than \"End Date\"")
            return;
        }
        if (user_id != "") {
            window.location.href = "?filter_type=" + filter_type + "&bot_pk=" + bot_pk + "&selected_api_status=" + api_status + "&selected_api_name=" + api_name + "&start_date=" + date + "&start_time=" + start_time + "&end_time=" + end_time + "&user_id=" + user_id;
        } else {
            window.location.href = "?filter_type=" + filter_type + "&bot_pk=" + bot_pk + "&selected_api_status=" + api_status + "&selected_api_name=" + api_name + "&start_date=" + date + "&start_time=" + start_time + "&end_time=" + end_time;
        }
    } else {
        if (user_id != "") {
            window.location.href = "?filter_type=" + filter_type + "&bot_pk=" + bot_pk + "&selected_api_status=" + api_status + "&selected_api_name=" + api_name + "&start_date=" + start_date + "&end_date=" + end_date + "&user_id=" + user_id;
        } else {
            window.location.href = "?filter_type=" + filter_type + "&bot_pk=" + bot_pk + "&selected_api_status=" + api_status + "&selected_api_name=" + api_name + "&start_date=" + start_date + "&end_date=" + end_date;
        }
    }
}

$(document).on("change", "#modal-api-statistics", function (e) {

    filter_type = document.getElementById("modal-api-statistics").value
    document.getElementById("modal-api-statistics-custom-date").style.display = "none"

    if (filter_type == "last_month") {

        document.getElementById("api-statistics-start-date").value = document.getElementById("api-statistics-start-date").getAttribute("value_last_month")
    } else if (filter_type == "last_week") {

        document.getElementById("api-statistics-start-date").value = document.getElementById("api-statistics-start-date").getAttribute("value_last_week")
    } else if (filter_type == "since_go_live") {

        document.getElementById("api-statistics-start-date").value = document.getElementById("api-statistics-start-date").getAttribute("value_golive")
    } else if (filter_type == "custom_date") {

        document.getElementById("modal-api-statistics-custom-date").style.display = "block"
        document.getElementById("api-statistics-start-date").value = document.getElementById("api-statistics-start-date").getAttribute("value")
    }
});

$(document).on("change", "#modal-api-analytics", function (e) {

    filter_type = document.getElementById("modal-api-analytics").value
    document.getElementById("modal-api-analytics-custom-date").style.display = "none"
    document.getElementById("modal-api-analytics-custom-timestamp-date").style.display = "none"
    document.getElementById("modal-api-analytics-custom-timestamp-time").style.display = "none"

    if (filter_type == "last_month") {

        document.getElementById("api-analytics-default-start-date").value = document.getElementById("api-analytics-default-start-date").getAttribute("value_last_month")
        document.getElementById("modal-api-analytics-custom-timestamp-date").style.display = "none"
        document.getElementById("modal-api-analytics-custom-timestamp-time").style.display = "none"
    } else if (filter_type == "last_week") {

        document.getElementById("api-analytics-default-start-date").value = document.getElementById("api-analytics-default-start-date").getAttribute("value_last_week")
        document.getElementById("modal-api-analytics-custom-timestamp-date").style.display = "none"
        document.getElementById("modal-api-analytics-custom-timestamp-time").style.display = "none"
    } else if (filter_type == "since_go_live") {

        document.getElementById("api-analytics-default-start-date").value = document.getElementById("api-analytics-default-start-date").getAttribute("value_golive")
        document.getElementById("modal-api-analytics-custom-timestamp-date").style.display = "none"
        document.getElementById("modal-api-analytics-custom-timestamp-time").style.display = "none"
    } else if (filter_type == "custom_date") {

        document.getElementById("modal-api-analytics-custom-date").style.display = "block"
        document.getElementById("api-analytics-default-start-date").value = document.getElementById("api-analytics-default-start-date").getAttribute("value")
        document.getElementById("modal-api-analytics-custom-timestamp-date").style.display = "none"
        document.getElementById("modal-api-analytics-custom-timestamp-time").style.display = "none"
    } else if (filter_type == "custom_timestamp") {

        document.getElementById("modal-api-analytics-custom-timestamp-date").style.display = "block"
        document.getElementById("modal-api-analytics-custom-timestamp-time").style.display = "block"
        document.getElementById("api-analytics-timestamp-date").value = document.getElementById("api-analytics-timestamp-date").getAttribute("value")
    }
});

function submit_api_statistics_filter() {

    var api_name = $("#select-api-name-statistics").val()
    var start_date = $("#api-statistics-start-date").val()
    var end_date = $("#api-statistics-end-date").val()
    var start_datetime = new Date(start_date);
    var end_datetime = new Date(end_date);
    if (start_date > end_date) {

        alert("\"Start Date\" should be less than \"End Date\"")
        return;
    }

    window.location.href = "?filter_type=" + filter_type + "&bot_pk=" + SELECTED_BOT_PK + "&selected_api_name=" + api_name + "&start_date=" + start_date + "&end_date=" + end_date
}

$(document).on("change", "#logs-to-statistics-switch", function () {

    var status = document.getElementById("logs-to-statistics-switch").checked

    if (status) {

        window.location = "/chat/easychat-api-statistics/?bot_pk=" + SELECTED_BOT_PK
    } else {

        window.location = "/chat/easychat-api-analytics/?bot_pk=" + SELECTED_BOT_PK
    }
});


////////////////// Logtailer  ///////////////////////////////////////


function download_easychat_logs() {

    window.location = "/chat/download-easychat-logs/"
}

function save_analytics_monitoring_config(e, bot_pk) {

    // active_hours_start = Math.round($("#active_hours_start").val())
    // active_hours_end = Math.round($("#active_hours_end").val())

    active_hours_start = $("#active_hours_start").val()
    active_hours_end = $("#active_hours_end").val()

    if (active_hours_start == undefined || active_hours_start == "") {

        alert("Kindly enter a valid starting active hour")
        return
    }
    if (active_hours_end == undefined || active_hours_end == "") {

        alert("Kindly enter a valid Ending active hour")
        return
    }

    if (active_hours_start > active_hours_end) {
        alert("Kindly select a valid start and end time")
        return;
    }

    email_addr_list = []
    var email_addr_chip_elmts = M.Chips.getInstance($('#analytics-monitoring-email-address')).chipsData;
    for (var i = 0; i < email_addr_chip_elmts.length; i++) {

        email_addr_list.push(email_addr_chip_elmts[i]["tag"]);
    }
    if (!email_addr_list.length) {

        alert("Kindly enter an Email ID to proceed")
        return
    }
    for (var i = 0; i < email_addr_list.length; i++) {
        if (!validateEmailAddr(email_addr_list[i])) {
            alert("Please provide valid Email ID")
            return
        }
    }

    analytics_monitoring_msg_limit = $("#analytics-monitoring-message-limit").val()
    if (analytics_monitoring_msg_limit == undefined || analytics_monitoring_msg_limit == "" || analytics_monitoring_msg_limit <= 0) {

        alert("Kindly enter a valid expected no of messages")
        return
    }
    analytics_monitoring_consecutive_hrs = $("#analytics-monitoring-consecutive-hrs").val()
    if (analytics_monitoring_consecutive_hrs == undefined || analytics_monitoring_consecutive_hrs == "" || analytics_monitoring_consecutive_hrs <= 0) {

        alert("Kindly enter a valid no of consecutive hours")
        return
    }
    csrf_token = get_csrf_token()

    json_string = JSON.stringify({
        "bot_id": bot_pk,
        "consecutive_hours": analytics_monitoring_consecutive_hrs,
        "message_limit": analytics_monitoring_msg_limit,
        "email_addr_list": email_addr_list,
        "start_hour": active_hours_start,
        "end_hour": active_hours_end,
    });
    e.innerHTML = "Saving..."
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/save-analytics-monitorig-setting/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            e.innerHTML = "Save"
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Analytics Monitoring Configuration saved."
                })
                $("#save-bot-general-settings-btn").click()
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        }
    });

}

//////////////////  API Fail Email Configuration /////////////////////

function save_api_fail_email_configuration(e, bot_pk) {
    mail_sender_time_interval = $("#mail_sender_time_interval_input").val()
    let isnum = /^\d+$/.test(mail_sender_time_interval.trim());
    if (!isnum) {
        M.toast({
            "html": "Invalid time input."
        }, 2000);
        return;
    }

    if (mail_sender_time_interval == undefined || mail_sender_time_interval == "" || mail_sender_time_interval < 0) {

        alert("Kindly enter a valid time interval")
        return
    }

    email_addr_list = []
    var email_addr_chip_elmts = M.Chips.getInstance($('#api-fail-email-config-email-address')).chipsData;
    for (var i = 0; i < email_addr_chip_elmts.length; i++) {

        email_addr_list.push(email_addr_chip_elmts[i]["tag"]);
    }
    if (!email_addr_list.length) {

        alert("Kindly enter an Email ID to proceed")
        return
    }
    for (var i = 0; i < email_addr_list.length; i++) {
        if (!validateEmailAddr(email_addr_list[i])) {
            alert("Please provide valid Email ID")
            return
        }
    }
    csrf_token = get_csrf_token()

    json_string = JSON.stringify({
        "bot_id": bot_pk,
        "mail_sender_time_interval": mail_sender_time_interval,
        "mail_sent_to_list": email_addr_list,
    });
    e.innerHTML = "Saving..."
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/save-api-fail-email-config/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            e.innerHTML = "Save"
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Email Configuration saved."
                })
                if (response["email_configured"]) {
                    $("#test-api-fail-email-config").show();
                } else {
                    $("#test-api-fail-email-config").hide();
                }
            } else if (response["status"] == 300) {
                M.toast({
                    "html": response["msg"]
                })
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        }
    });

}

$(document).on("change", "#checkbox-is-api-fail-email-notifiication-enabled", function () {

    var status = document.getElementById("checkbox-is-api-fail-email-notifiication-enabled").checked
    if (status) {

        $("#edit-api-fail-email-config").show()
        if (API_FAIL_EMAIL_CONFIGURED == "true" || API_FAIL_EMAIL_CONFIGURED == "True") {

            $("#test-api-fail-email-config").show()
        }
    } else {

        $("#edit-api-fail-email-config").hide()
        if (API_FAIL_EMAIL_CONFIGURED == "true" || API_FAIL_EMAIL_CONFIGURED == "True") {

            $("#test-api-fail-email-config").hide()
        }
    }
});

function send_api_fail_test_email(bot_pk) {

    csrf_token = get_csrf_token()

    json_string = JSON.stringify({
        "bot_id": bot_pk,
    });

    json_string = EncryptVariable(json_string);
    $("#test-api-fail-email-config").val("Sending test mail...")
    $.ajax({
        url: "/chat/send-api-fail-test-email/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            $("#test-api-fail-email-config").val("Test API Failure Mail")
            $("#modal-api-fail-email-config").modal('close');
            if (response["status"] == 200) {
                M.toast({
                    "html": "Test mail sent!"
                })
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        }
    });
}


//////////////////  Endpoint Failure Email Configuration /////////////////////

function save_whatsapp_email_configuration(e, bot_channel_pk) {

    mail_sender_time_interval = $("#mail_sender_time_interval_input_whatsapp").val()

    email_addr_list = []
    var email_addr_chip_elmts = M.Chips.getInstance($('#whatsapp-email-config-email-address')).chipsData;
    for (var i = 0; i < email_addr_chip_elmts.length; i++) {

        email_addr_list.push(email_addr_chip_elmts[i]["tag"]);
    }
    for (var i = 0; i < email_addr_list.length; i++) {
        if (!validateEmailAddr(email_addr_list[i])) {
            alert("Please provide valid email id")
            return
        }
    }
    e.innerHTML = "Saving..."
    csrf_token = get_csrf_token()

    json_string = JSON.stringify({
        "bot_channel_pk": bot_channel_pk,
        "mail_sender_time_interval": mail_sender_time_interval,
        "mail_sent_to_list": email_addr_list,
    });

    json_string = EncryptVariable(json_string);

    $.ajax({
        url: "/chat/save-whatsapp-email-config/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            e.innerHTML = "Save"
            if (response["status"] == 200) {
                M.toast({
                    "html": "Email Configuration saved."
                })
                if (response["email_configured"]) {

                    $("#test-whatsapp-email-config").show();
                } else {

                    $("#test-whatsapp-email-config").hide();
                }
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        }
    });

}

$(document).on("change", "#checkbox-is-whatsapp-email-notifiication-enabled", function () {

    var status = document.getElementById("checkbox-is-whatsapp-email-notifiication-enabled").checked
    if (status) {

        $("#edit-whatsapp-email-config").show()
        if (API_FAIL_EMAIL_CONFIGURED == "true" || API_FAIL_EMAIL_CONFIGURED == "True") {

            $("#test-whatsapp-email-config").show()
        }
    } else {

        $("#edit-whatsapp-email-config").hide()
        if (API_FAIL_EMAIL_CONFIGURED == "true" || API_FAIL_EMAIL_CONFIGURED == "True") {

            $("#test-whatsapp-email-config").hide()
        }
    }
});

function send_whatsapp_test_email(bot_channel_pk) {

    csrf_token = get_csrf_token()

    json_string = JSON.stringify({
        "bot_channel_pk": bot_channel_pk,
    });

    json_string = EncryptVariable(json_string);
    $("#test-whatsapp-email-config").val("Sending test mail...")
    $.ajax({
        url: "/chat/send-whatsapp-test-email/",
        type: "POST",
        headers: {
            "X-CSRFToken": csrf_token
        },
        data: {
            data: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            $("#test-whatsapp-email-config").val("Send Test Mail");
            $("#modal-whatsapp-email-config").modal('close');
            if (response["status"] == 200) {
                M.toast({
                    "html": "Test mail sent!"
                })
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        }
    });
}


function copyToClipboardfromPreTag(id, request_type) {
    var copyText = document.getElementById(id).textContent;
    if (navigator.clipboard) {
        navigator.clipboard.writeText(copyText)
    } else {
        var textArea = document.createElement('textarea');
        textArea.textContent = copyText;
        document.body.append(textArea);
        textArea.select();
        document.execCommand("copy");
        textArea.remove()
    }
    M.toast({
        "html": request_type + " packet has been copied"
    }, 2000);
}

function DownloadAsJSON(api_pk, type) {

    window.location = '/chat/download-api-analytics-data/?api_pk=' + api_pk + '&type=' + type
}

function show_screenshot(img_source) {
    console.log(img_source);
    $("#modal-general-feedback-view-screenshot").modal("open");
    screenshot_html = '<center><img class="responsive-img" src="' + img_source + '"></center>';
    document.getElementById("general-feedback-screenshot").innerHTML = screenshot_html;
}

/////////////// FILTER LOGS BY DATE START //////////////////////////
$(document).on("click", "#filter-by-date", function (e) {
    date_start = $("#date_start").val();
    time_start = $("#time_start").val();
    date_end = $("#date_end").val();
    time_end = $("#time_end").val();
    json_string = JSON.stringify({
        date_start: date_start,
        time_start: time_start,
        date_end: date_end,
        time_end: time_end
    });
    csrf_token = get_csrf_token();
    json_string = EncryptVariable(json_string);

    if (time_start == '' || time_end == '') {
        $("#filter-by-date").attr("href", "#")
        $("#filter-by-date").removeAttr("download")
        M.toast({
            "html": "Please enter valid start/end time."
        })
        return;
    }

    date_start_final = date_start.concat(" ")
    date_start_final = date_start_final.concat(time_start)

    date_end_final = date_end.concat(" ")
    date_end_final = date_end_final.concat(time_end)

    var D1 = new Date(Date.parse(date_start_final))
    var D2 = new Date(Date.parse(date_end_final))

    if (D1 < D2) {
        var response = $.ajax({
            url: '/chat/download-easychat-logs/',
            type: 'POST',
            headers: {
                'X-CSRFToken': csrf_token,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            async: false,
            data: {
                json_string: json_string
            },
            success: function () {
                $("#filter-by-date").attr("href", "/files/private/app.log")
                $("#filter-by-date").attr("download")
            },
            error: function (error) {
                console.log(error)
            }
        })
    } else {
        $("#filter-by-date").attr("href", "#")
        $("#filter-by-date").removeAttr("download")
        M.toast({
            "html": "Kindly select a end date greater than the start date"
        })
    }
});

/////////////// FILTER LOGS BY DATE END //////////////////////////

/////////////////// COMMON UTILS FILE START ///////////////////////
function last_edit(bot_id) {
    var editor = ace.edit("editor_common_utils");
    var code = editor.getValue();
    csrf_token = get_csrf_token();
    window.open('/chat/common-utils/?bot_pk=' + bot_id + '&checklastedit=' + 'true', '_blank')
}

function save_common_utils(bot_id) {
    var editor = ace.edit("editor_common_utils");
    var code = editor.getValue();

    if (check_for_system_commands(code)) {
        M.toast({
            "html": "Code contains system-commands. Please remove them and save again."
        }, 2000);
        document.getElementById("easychat-processor-status").value = "\n\nError(s):";
        show_processor_errors();
        return;
    };
    csrf_token = get_csrf_token();

    var json_string = JSON.stringify({
        code: code,
        bot_pk: bot_id,
        to_save: "True"
    })
    json_string = EncryptVariable(json_string);
    var response = $.ajax({
        url: '/chat/common-utils/?bot_pk=' + bot_id,
        type: 'POST',
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: json_string
        },
        success: function () {

            M.toast({
                "html": "Your function has been saved"
            })
            setTimeout(function () {
                window.location.reload();
            }, 2000);
        },
        error: function (error) {
            console.log(error)
        }
    })
}

/////////////// COMMON UTILS FILE END //////////////////


function save_chatbot_custom_js(bot_id) {
    var editor = ace.edit("editor_custom_js");
    var code = editor.getValue();
    csrf_token = get_csrf_token();

    var json_string = JSON.stringify({
        code: code,
        bot_id: bot_id,
        to_save: "True"
    })
    json_string = EncryptVariable(json_string);
    var response = $.ajax({
        url: '/chat/save-custom-chatbot-js/?bot_pk=' + bot_id,
        type: 'POST',
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: json_string
        },
        success: function () {
            M.toast({
                "html": "Your function has been saved"
            })
            setTimeout(function () {
                window.location.reload();
            }, 2000);
        },
        error: function (error) {
            console.log(error)
        }
    })
}


function save_chatbot_custom_css(bot_id) {
    var editor = ace.edit("editor_custom_css");
    var code = editor.getValue();
    csrf_token = get_csrf_token();

    var json_string = JSON.stringify({
        code: code,
        bot_id: bot_id,
        to_save: "True"
    })
    json_string = EncryptVariable(json_string);
    var response = $.ajax({
        url: '/chat/save-custom-chatbot-css/',
        type: 'POST',
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            json_string: json_string
        },
        success: function () {
            M.toast({
                "html": "Changes has been saved"
            })
            setTimeout(function () {
                window.location.reload();
            }, 2000);
        },
        error: function (error) {
            console.log(error)
        }
    })
}


////////////// NO CODE API INTEGRATION START ///////////////

var request_packet = ""
var response_packet = ""
var url = ""
var header = ""
var url_access_token = ""
var header_access_token = ""
var username_basic_authorization = ""
var password_basic_authorization = ""
var intent = ""

function access_token(intent_pk, tree_pk, parent_tree_pk, type_of_request) {
    url_access_token = ace.edit('url_access_token').getValue()
    header_access_token = ace.edit('header_access_token').getValue()
    var access_token_html = document.getElementById("access_token_html")
    access_token_html.style.display = "none"
    var api_integration_one = document.getElementById("api_integration_part_one")
    api_integration_one.style.display = "block"
    intent = intent_pk
}

function api_integration(tree_pk, parent_tree_pk, type_of_request) {
    url = ace.edit('url').getValue();
    header = ace.edit('header').getValue();
    username_basic_authorization = document.getElementById("username-basic-authorization").value
    password_basic_authorization = document.getElementById("password-basic-authorization").value

    if (type_of_request == "rest") {
        request_packet = ace.edit("request").getValue()
        response_packet = ace.edit("response").getValue()
        error_response_packet = ace.edit("error_response").getValue()
    } else {
        request_packet = String(ace.edit("request").getValue())
        request_packet = request_packet.replace(/(\r\n|\n|\r)/gm, "")
        request_packet = request_packet
        response_packet = String(ace.edit("response").getValue())
        response_packet = response_packet.replace(/(\r\n|\n|\r)/gm, "")
        error_response_packet = String(ace.edit("error_response").getValue())
        error_response_packet = error_response_packet.replace(/(\r\n|\n|\r)/gm, "")

    }
    var json_string = JSON.stringify({
        "tree_pk": tree_pk,
        "parent_tree_pk": parent_tree_pk,
        "type_of_request": type_of_request,
        "request_packet": request_packet,
        "response_packet": response_packet,
        "error_response_packet": error_response_packet
    })
    csrf_token = get_csrf_token();
    json_string = EncryptVariable(json_string);
    var response = $.ajax({
        url: '/chat/request-response-trees/',
        type: 'POST',
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            data: json_string
        },
        success: function (response) {
            if (response['status_code'] == 200) {
                var api_integration_one = document.getElementById("api_integration_part_one")
                api_integration_one.style.display = "none"
                ace.edit("request_packet_two").setValue(response['request_packet'])
                ace.edit("request_packet_two").clearSelection()
                ace.edit("response_packet_two").setValue(response['response_packet'])
                ace.edit("response_packet_two").clearSelection()
                ace.edit("error_response_packet_two").setValue(response['error_response_packet'])
                ace.edit("error_response_packet_two").clearSelection()

                document.getElementById("request_tree_html").innerHTML = response['request_tree_html']
                document.getElementById("response_tree_html").innerHTML = response['response_tree_html']
                document.getElementById("html_error_response").innerHTML = response['html_error_response']
                var toggler = document.getElementsByClassName("caret");
                var toggler_incrementer;

                for (toggler_incrementer = 0; toggler_incrementer < toggler.length; toggler_incrementer++) {
                    toggler[toggler_incrementer].addEventListener("click", function (e) {
                        e.preventDefault();
                        this.parentElement.querySelector(".nested").classList.toggle("active");
                        this.classList.toggle("caret-down");
                    });
                }
                var api_integration_two = document.getElementById("api_integration_part_two")
                api_integration_two.style.display = "block"
            } else if (response['status_code'] == 500) {
                M.toast({
                    "html": "Kindly check the formats of the packets."
                })
            }
        },
        error: function (error) {
            console.log(error)
        }
    })
}

function request_values(tree_pk, parent_tree_pk, type_of_request) {

    var request_dict = {}
    $("select").each(function () {
        if ($(this).val() != null) {
            ID = this.id.replace('jpd', '')
            request_dict[ID] = $(this).val()
        }
    })
    var response_dict = {}
    var error_response_dict = {}
    $("input").each(function () {
        if ($(this).val() != null) {
            if (this.id != "bot-response-variable" || this.id != "bot-response-value" || this.id != "bot-error-response-value") {
                if (this.id.includes("error_response_key") == true) {
                    error_response_dict[this.id.replace("error_response_key", "")] = $(this).val()
                } else {
                    response_dict[this.id] = $(this).val()
                }
            }
        }
    })
    var bot_response_variable = document.getElementById("bot-response-variable").value
    var bot_response_value = document.getElementById("bot-response-value").value
    var bot_error_response_value = document.getElementById("bot-error-response-value").value

    var json_string = JSON.stringify({
        "url_access_token": url_access_token,
        "header_access_token": header_access_token,
        "request_packet": request_packet,
        "response_packet": response_packet,
        "error_response_packet": error_response_packet,
        "url": url,
        "header": header,
        "request_dict": request_dict,
        "response_dict": response_dict,
        "error_response_dict": error_response_dict,
        "tree_pk": tree_pk,
        "parent_tree_pk": parent_tree_pk,
        "type_of_request": type_of_request,
        "username_basic_authorization": username_basic_authorization,
        "password_basic_authorization": password_basic_authorization,
        "bot_response_variable": bot_response_variable,
        "bot_response_value": bot_response_value,
        "bot_error_response_value": bot_error_response_value
    })
    csrf_token = get_csrf_token();
    json_string = EncryptVariable(json_string);
    var response = $.ajax({
        url: '/chat/save-api-code/',
        type: 'POST',
        headers: {
            'X-CSRFToken': csrf_token,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        async: false,
        data: {
            data: json_string
        },
        success: function (response) {
            if (response['status_code'] == 200) {
                M.toast({
                    "html": "Your API code has been generated."
                })
                setTimeout(function () {
                    window.location = '/chat/edit-intent/?intent_pk=' + intent;
                }, 2000);

            } else if (response['status_code'] == 500) {
                M.toast({
                    "html": "Internal server error. Please report this error."
                })
            }
        },
        error: function (error) {
            console.log(error)
        }
    })
}

//////////////// NO CODE API INTEGRATION END ///////////////////////

/* WHATSAPP SIMULATOR START */

function get_current_time(date) {
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var ampm = hours >= 12 ? 'pm' : 'am';
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    minutes = minutes < 10 ? '0' + minutes : minutes;
    var strTime = hours + ':' + minutes + ' ' + ampm;
    return strTime;
}

function run_whatsapp_simulator() {
    end_point = document.getElementById("whatsapp-bot-end-point").value;
    if (end_point == "") {
        showToast("Please enter the WhatsApp Webhook URL");
        return;
    }
    mobile_number = document.getElementById("whatsapp_mobile_number").value;
    if (mobile_number == "") {
        showToast("Please enter a mobile number.")
        return;
    }
    var editor = ace.edit("editor-code-request-packet");
    var code = editor.getValue();
    if (code == "") {
        showToast('Please write the request packet.');
        return;
    }

    if (document.getElementById("whatsapp-simulator").style.display == "block") {
        showToast("Simulator is already running.")
    } else {
        document.getElementById("whatsapp-simulator").style.display = "block";
    }
}

if (window.location.href.indexOf("/chat/whatsapp-simulator/") != -1) {
    var form = document.querySelector('.conversation-compose');
    var conversation = document.querySelector('.conversation-container');
    form.addEventListener('submit', send_whatsapp_message);
}

function get_whatsapp_response(message, mobile_number, end_point) {
    document.getElementById("whatsapp_status").innerHTML = "typing..."
    var editor = ace.edit("editor-code-request-packet");
    var request_packet = editor.getValue();

    json_string = JSON.stringify({
        "message": message,
        "mobile_number": mobile_number,
        "end_point": end_point,
        "request_packet": request_packet
    })
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/get-whatsapp-simulator-response/",
        type: "POST",
        data: {
            data: json_string
        },
        success: function (response) {
            document.getElementById("whatsapp_status").innerHTML = "online"
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                var msg = response["response_message"];
                var mesg_list = msg.split("$$$")
                for (var i = 0; i < mesg_list.length; i++) {

                    var received_message = recieved_message_ui(mesg_list[i]);
                    conversation.appendChild(received_message)
                    conversation.scrollTop = conversation.scrollHeight;
                }
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
                console.log("Internal Server Error")
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        }
    });
}

function send_whatsapp_message(e) {
    var input = e.target.input;
    if (input.value) {
        mobile_number = document.getElementById("whatsapp_mobile_number").value;
        end_point = document.getElementById("whatsapp-bot-end-point").value;
        get_whatsapp_response(input.value, mobile_number, end_point)

        var message = sent_message_ui(input.value);

        conversation.appendChild(message);

        animate_message(message);
    }

    input.value = '';
    conversation.scrollTop = conversation.scrollHeight;
    e.preventDefault();
}

function sent_message_ui(text) {
    var element = document.createElement('div');
    element.classList.add('message', 'sent');
    var today = new Date();
    current_time = get_current_time(today)
    element.innerHTML = text +
        '<span class="metadata">' +
        '<span class="time">' + current_time + '</span>' +
        '<span class="tick tick-animation">' +
        '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="15" id="msg-dblcheck" x="2047" y="2061"><path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.88a.32.32 0 0 1-.484.032l-.358-.325a.32.32 0 0 0-.484.032l-.378.48a.418.418 0 0 0 .036.54l1.32 1.267a.32.32 0 0 0 .484-.034l6.272-8.048a.366.366 0 0 0-.064-.512zm-4.1 0l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.88a.32.32 0 0 1-.484.032L1.892 7.77a.366.366 0 0 0-.516.005l-.423.433a.364.364 0 0 0 .006.514l3.255 3.185a.32.32 0 0 0 .484-.033l6.272-8.048a.365.365 0 0 0-.063-.51z" fill="#92a58c"/></svg>' +
        '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="15" id="msg-dblcheck-ack" x="2063" y="2076"><path d="M15.01 3.316l-.478-.372a.365.365 0 0 0-.51.063L8.666 9.88a.32.32 0 0 1-.484.032l-.358-.325a.32.32 0 0 0-.484.032l-.378.48a.418.418 0 0 0 .036.54l1.32 1.267a.32.32 0 0 0 .484-.034l6.272-8.048a.366.366 0 0 0-.064-.512zm-4.1 0l-.478-.372a.365.365 0 0 0-.51.063L4.566 9.88a.32.32 0 0 1-.484.032L1.892 7.77a.366.366 0 0 0-.516.005l-.423.433a.364.364 0 0 0 .006.514l3.255 3.185a.32.32 0 0 0 .484-.033l6.272-8.048a.365.365 0 0 0-.063-.51z" fill="#4fc3f7"/></svg>' +
        '</span>' +
        '</span>';
    return element;
}

function recieved_message_ui(text) {
    var element = document.createElement('div');
    var today = new Date();
    current_time = get_current_time(today)

    element.classList.add('message', 'received');
    element.innerHTML = text + '<span class="metadata">' +
        '<span class="time">' + current_time + '</span>';

    return element;

}

function animate_message(message) {
    setTimeout(function () {
        var tick = message.querySelector('.tick');
        tick.classList.remove('tick-animation');
    }, 500);
}

/* WHATSAPP SIMULATOR END */

if (window.location.href.indexOf("/chat/nlp-benchmark/") != -1) {
    setInterval(function () {
        renderNLPBenchmarkingResult();
    }, 10000);
}

function start_nlp_benchmarking() {
    // var selected_bot_pk = $("#multiple-select-bot-choice-pk-list").val();

    // var selected_bot_pk_list = [selected_bot_pk];
    selected_bot_id = get_url_vars()["bot_pk"];
    $("#start-nlp-benchmarking-btn").attr("disabled", "disabled");


    var my_file = ($("#my_file"))[0].files[0];

    if (my_file == undefined || my_file == null) {
        M.toast({
            "html": "Please upload excel sheet in required format."
        }, 2000);
        return;
    }

    if (check_malicious_file(my_file.name) == true) {
        return;
    }

    var formData = new FormData();
    formData.append("my_file", my_file);
    formData.append("selected_bot_id", selected_bot_id);

    $('#preloader_nlp_benchmarking_div').show();
    M.toast({
        'html': "Starting NLP Benchmarking."
    }, 2000);
    $.ajax({
        url: "/chat/start-nlp-benchmarking/",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
            // $('.indeterminate').hide();
            response = custom_decrypt(response)
            response = JSON.parse(response);

            if (response['status'] == 200) {
                renderNLPBenchmarkingResult();

            } else if (response['status'] == 101) {
                M.toast({
                    'html': response['message']
                }, 2000)
                $('#preloader_nlp_benchmarking_div').hide();
            } else {
                M.toast({
                    'html': "Internal Server Error!"
                }, 2000);
                $('#preloader_nlp_benchmarking_div').hide();
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });

}

function renderNLPBenchmarkingResult() {
    selected_bot_id = get_url_vars()["bot_pk"];
    $.ajax({
        url: "/chat/get-nlp-benchmarking-result/",
        type: "GET",
        data: {
            "selected_bot_id": selected_bot_id
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            var html_table = `<div class="center-align" style="padding:1em;">No results available. Please run NLP Benchmark Process first.</div>`
            if (response["status"] == 200) {
                user_query_list = response["user_query_list"];
                ideal_intent_name_list = response["ideal_intent_name_list"];
                identified_intent_name_list = response["identified_intent_name_list"];
                host = window.location.host;
                correct_queries_length = response['correct_queries_length']
                total_queries_length = response['total_queries_length']
                percentage = response['result_accuracy']
                $("#result-paragraph").css("display", "block");
                $("#benchmark-percent").html(percentage)
                $("#benchmarking-final-result").html(correct_queries_length + '/' + total_queries_length)

                var html_table = `<div class="col s6" Last Run: <b>` + response['result_timestamp'] + `</b></div> <div class="col s6"> <a href="` + "/" + response['result_file_path'] + `" class="right"><u>Download Excel File</u></a></div>` + `<br></p>`;
                html_table += `
                <table id="nlp-benchmarking-info-table" class="striped highlight white">
                  <thead>
                    <tr>
                      <th>User Query</th>
                      <th>Expected Intent in the Bot</th>
                      <th>Identified Intent by the bot</th>
                    </tr>
                  </thead>
                  <tbody>`;

                for (var i = 0; i < user_query_list.length; i++) {
                    html_table += `<tr>
                  <td>` + user_query_list[i] + `</td>
                  <td>` + ideal_intent_name_list[i] + `</td>
                  <td>` + identified_intent_name_list[i] + `</td>
                </tr>`;
                }

                html_table += `</tbody>
            </table><br>*Table contains results of last NLP Benchmark Process`;


                main_html = html_table;
                $("#div-nlp-benchmarking-table").html(main_html);

                var not_found_intent_list = [];
                not_found_intent_list = response['not_found_intent_list'];
                if (not_found_intent_list.length > 0) {
                    html_error_list = "Below intents were not found in the Bot and hence are not considered in calculating accuracy of the NLP Algorithm:"
                    html_error_list += "<ul>"
                    for (var i = 0; i < not_found_intent_list.length; i++) {
                        html_error_list += "<li>" + not_found_intent_list[i] + "</li>";
                    }
                    html_error_list += "<ul>";
                    $("#div-nlp-benchmarking-error").html(html_error_list);
                }
                $('#preloader_nlp_benchmarking_div').hide();
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
}

function add_api_url(sentence) {
    if (sentence.trim() == "") {
        return;
    }
    var str_id = sentence.toString().replace(/[^A-Z0-9]/ig, "");

    var html = `<li class="collection-item" id="` + str_id + `">
      <div class="row">
        <input id="` + str_id + `" type="text" value="` + sentence + `" style="width: 80%">
        <div class="secondary-content">
        <a href="" class="delete-button-api-url" id="` + str_id + `">
          <i class="inline-icon material-icons red-text text-darken-3">delete</i>
        </a>
        </div>
      </div>
    </li>`;
    $(html).appendTo($("#api_collection"));
}

function check_malicious_file(file_name) {

    // if (file_name.split('.').length != 2) {
    //     M.toast({
    //         "html": "Please do not use .(dot) except for extension"
    //     }, 2000);
    //     return true;
    // }

    var allowed_files_list = [
        "png", "jpg", "jpeg", "svg", "bmp", "gif", "tiff", "exif", "jfif", "webm", "mpg",
        "mp2", "mpeg", "mpe", "mpv", "ogg", "mp4", "m4p", "m4v", "avi", "wmv", "mov", "qt",
        "flv", "swf", "avchd", "mp3", "aac", "pdf", "xls", "xlsx", "json", "xlsm", "xlt", "xltm", "zip", "rar", "ppt", "pptx", "docx", "docs", "txt"
    ];

    var file_extension = file_name.substring(file_name.lastIndexOf(".") + 1, file_name.length);
    file_extension = file_extension.toLowerCase();

    if (allowed_files_list.includes(file_extension) == false) {
        M.toast({
            "html": "." + file_extension + " files are not allowed"
        }, 2000);
        return true;
    }
    return false;
}

function add_web_landing_url_initial_messages() {

    initial_intent_present = document.getElementById("show-initial-intent").checked;
    is_welcome_message_present = document.getElementById("show-welcome-message").checked;
    initial_image_present = document.getElementById("show-welcome-image").checked;
    initial_videos_present = document.getElementById("show-welcome-video").checked;
    is_welcome_banner_present = document.getElementById("show-welcome-banner").checked;
    bot_id = get_url_vars()['id']
    json_string = JSON.stringify({
        initial_intent_present: initial_intent_present,
        is_welcome_message_present: is_welcome_message_present,
        initial_image_present: initial_image_present,
        initial_videos_present: initial_videos_present,
        is_welcome_banner_present: is_welcome_banner_present,
        bot_id: bot_id,
    });
    json_string = EncryptVariable(json_string);
    $.ajax({
        url: "/chat/channels/save-web-landing-initial-messages/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    "html": "Saved successfully"
                })
            } else {
                M.toast({
                    "html": "Internal Server Error. Please report this error"
                })
            }
        },
        error: function (error) {
            console.log("Report this error: ", error);
        },
    });
}

// ###############################################   Telegram ###############################################


if (window.location.pathname.indexOf("/chat/channels/telegram") != -1) {
    var location_href = window.location.href;
    var location_href = location_href.replace("#", "");
    var location_href = location_href.replace("!", "");
    var bot_id = get_url_vars()['id'];

    var json_string = JSON.stringify({
        bot_id: bot_id
    })
    json_string = EncryptVariable(json_string);
    document.getElementById("easychat_telegram_channel_preloader").style.display = "block";
    $.ajax({
        url: "/chat/channels/telegram/edit/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            document.getElementById("easychat_telegram_channel_preloader").style.display = "none";
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {

                images = response["initial_message"]["images"];
                videos = response["initial_message"]["videos"];

                if (images != undefined && images != null && images.length > 0) {
                    document.getElementById("uploaded-bot-welcome-image").src = images[0];
                    document.getElementById("uploaded-bot-welcome-image").style.display = "inline-block";
                    $("#remove-bot-welcome-image").show();
                }

                if (videos != undefined && videos != null && videos.length > 0) {
                    document.getElementById("upload-bot-welcome-video-url").value = videos[0];
                }

            } else {
                M.toast({
                    "html": "Oops! Looks like there is some issue. Try again in sometime."
                }, 2000);
            }
        },
        error: function (error) {
            document.getElementById("easychat_telegram_channel_preloader").style.display = "none";
        }
    });

    add_channel_language_selction_event("telegram")
    add_language_dropdown_search_event()
    language_dropdown_close_onclicking_outside_event()
    language_search_dropdown_event()
    open_close_language_dropdown_event()
    $(document).ready(function () {
        create_language_custom_dropdowns();
    });
    $(document).on("click", "#ignore-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "Telegram"
        ignore_changes_in_non_primary_languages(bot_id, channel_name)
    });
    $(document).on("click", "#auto-fix-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "Telegram"
        auto_fix_changes_in_non_primary_languages(bot_id, channel_name)
    });

    $(document).on("click", "#save-telegram-channel", function (e) {
        var location_href = window.location.href;
        var location_href = location_href.replace("#", "");
        var location_href = location_href.replace("!", "");
        var bot_id = get_url_vars()['id'];

        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var is_language_auto_detection_enabled = document.getElementById("is_language_auto_detection_enabled").checked
        var is_enable_choose_language_flow_enabled_for_welcome_response = document.getElementById("is_enable_choose_language_flow_enabled_for_welcome_response").checked

        selected_supported_languages = get_selected_languages_list()

        if ("en" in selected_supported_languages == false) {
            selected_supported_languages.push("en");
        }

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }

        initial_message_list = $("#multiple-select-telegram-initial-message-list").val();

        failure_recommendation_list = $("#multiple-select-telegram-failure-message-list").val();

        image_id = document.getElementById("uploaded-bot-welcome-image");
        image_url = image_id.getAttribute("src");
        video_url = document.getElementById("upload-bot-welcome-video-url").value.trim();

        if (isValidURL(video_url) == false && video_url != "") {
            M.toast({
                "html": "Please enter valid video url"
            }, 2000);
            return;
        }

        json_string = JSON.stringify({
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            authentication_message: authentication_message,
            initial_message_list: initial_message_list,
            image_url: image_url,
            video_url: video_url,
            failure_recommendation_list: failure_recommendation_list,
            selected_supported_languages: selected_supported_languages,
            is_enable_choose_language_flow_enabled_for_welcome_response: is_enable_choose_language_flow_enabled_for_welcome_response,
            is_language_auto_detection_enabled: is_language_auto_detection_enabled,
        });
        json_string = EncryptVariable(json_string)
        document.getElementById("easychat_telegram_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/channels/telegram/save/",
            type: "POST",
            data: {
                json_string: json_string
            },
            success: function (response) {
                document.getElementById("easychat_telegram_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    }, 2000)
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else if (response["status"] == 402) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                    setTimeout(function() {
                        window.location.href = "/chat/home"
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Unable to update the channel details. Please report this error"
                    }, 2000)
                }
            },
            error: function (error) {
                document.getElementById("easychat_telegram_channel_preloader").style.display = "none";
            }
        });
    });

    $("#language-box-options-container .option .item-checkbox").change(function () {

        enable_disable_auto_language_detection_toogle();
        enable_disable_welcome_message_language_change_toogle(true)

    });

    $(document).on("click", "#save-telegram-channel-for-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let selected_language = get_url_vars()['selected_lang']

        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }
        channel_name = "Telegram"

        json_string = {
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            channel_name: channel_name,
            selected_language: selected_language,
            authentication_message: authentication_message,
            save_auto_pop_up_text: false,
        }
        json_string = JSON.stringify(json_string);
        json_string = EncryptVariable(json_string);
        document.getElementById("easychat_telegram_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/save-channel-language-tuned-objects/",
            type: "POST",
            data: {
                json_string: json_string
            },
            success: function (response) {
                document.getElementById("easychat_telegram_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                document.getElementById("easychat_web_channel_preloader").style.display = "none";
                console.log("Report this error: ", error);
            },
        });
    });

}



if (window.location.pathname.indexOf("/chat/channels/et-source") != -1) {

    var location_href = window.location.href;
    var location_href = location_href.replace("#", "");
    var location_href = location_href.replace("!", "");
    var bot_id = get_url_vars()['id'];

    var json_string = JSON.stringify({
        bot_id: bot_id
    })

    json_string = EncryptVariable(json_string);
    document.getElementById("easychat_etsource_channel_preloader").style.display = "block";

    $.ajax({
        url: "/chat/channels/etsource/edit/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            document.getElementById("easychat_etsource_channel_preloader").style.display = "none";
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {

                images = response["initial_message"]["images"];
                videos = response["initial_message"]["videos"];

                if (images != undefined && images != null && images.length > 0) {
                    document.getElementById("uploaded-bot-welcome-image").src = images[0];
                    document.getElementById("uploaded-bot-welcome-image").style.display = "inline-block";
                    $("#remove-bot-welcome-image").show();
                }

                if (videos != undefined && videos != null && videos.length > 0) {
                    document.getElementById("upload-bot-welcome-video-url").value = videos[0];
                }

            } else {
                M.toast({
                    "html": "Oops! Looks like there is some issue. Try again in sometime."
                }, 2000);
            }
        },
        error: function (error) {
            document.getElementById("easychat_etsource_channel_preloader").style.display = "none";
        }
    });

    add_channel_language_selction_event("et-source")
    add_language_dropdown_search_event()
    language_dropdown_close_onclicking_outside_event()
    language_search_dropdown_event()
    open_close_language_dropdown_event()
    $(document).ready(function () {
        create_language_custom_dropdowns();
    });
    $(document).on("click", "#ignore-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "ET-Source"
        ignore_changes_in_non_primary_languages(bot_id, channel_name)
    });
    $(document).on("click", "#auto-fix-changes-in-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let channel_name = "ET-Source"
        auto_fix_changes_in_non_primary_languages(bot_id, channel_name)
    });

    $(document).on("click", "#save-etsource-channel", function (e) {
        var location_href = window.location.href;
        var location_href = location_href.replace("#", "");
        var location_href = location_href.replace("!", "");
        var bot_id = get_url_vars()['id'];

        var welcome_message = $("#welcome-message").trumbowyg('html')
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')
        var is_language_auto_detection_enabled = document.getElementById("is_language_auto_detection_enabled").checked
        var is_enable_choose_language_flow_enabled_for_welcome_response = document.getElementById("is_enable_choose_language_flow_enabled_for_welcome_response").checked

        selected_supported_languages = get_selected_languages_list()

        if ("en" in selected_supported_languages == false) {
            selected_supported_languages.push("en");
        }

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }

        initial_message_list = $("#multiple-select-etsource-initial-message-list").val();

        failure_recommendation_list = $("#multiple-select-etsource-failure-message-list").val();

        image_id = document.getElementById("uploaded-bot-welcome-image");
        image_url = image_id.getAttribute("src");
        video_url = document.getElementById("upload-bot-welcome-video-url").value.trim();

        if (isValidURL(video_url) == false && video_url != "") {
            M.toast({
                "html": "Please enter valid video url"
            }, 2000);
            return;
        }

        json_string = JSON.stringify({
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            authentication_message: authentication_message,
            initial_message_list: initial_message_list,
            image_url: image_url,
            video_url: video_url,
            failure_recommendation_list: failure_recommendation_list,
            selected_supported_languages: selected_supported_languages,
            is_enable_choose_language_flow_enabled_for_welcome_response: is_enable_choose_language_flow_enabled_for_welcome_response,
            is_language_auto_detection_enabled: is_language_auto_detection_enabled,
        });
        json_string = EncryptVariable(json_string)
        document.getElementById("easychat_etsource_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/channels/etsource/save/",
            type: "POST",
            data: {
                json_string: json_string
            },
            success: function (response) {
                document.getElementById("easychat_etsource_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    }, 2000)
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else if (response["status"] == 402) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                    setTimeout(function() {
                        window.location.href = "/chat/home"
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Unable to update the channel details. Please report this error"
                    }, 2000)
                }
            },
            error: function (error) {
                document.getElementById("easychat_etsource_channel_preloader").style.display = "none";
            }
        });
    });

    $("#language-box-options-container .option .item-checkbox").change(function () {

        enable_disable_auto_language_detection_toogle();
        enable_disable_welcome_message_language_change_toogle()

    });

    $(document).on("click", "#save-etsource-channel-for-non-primary-language", function (e) {
        let bot_id = (get_url_vars()["id"])
        let selected_language = get_url_vars()['selected_lang']

        var welcome_message = $("#welcome-message").trumbowyg('html');
        var failure_message = $("#failure-message").trumbowyg('html')
        var authentication_message = $("#authentication-message").trumbowyg('html')

        var validation_message = check_channel_messages_validation(welcome_message, failure_message, authentication_message);
        if (validation_message != "No Error") {
            M.toast({
                "html": validation_message
            }, 2000);
            return;
        }
        channel_name = "ET-Source"

        json_string = {
            bot_id: bot_id,
            welcome_message: welcome_message,
            failure_message: failure_message,
            channel_name: channel_name,
            selected_language: selected_language,
            authentication_message: authentication_message,
            save_auto_pop_up_text: false,
        }
        json_string = JSON.stringify(json_string);
        json_string = EncryptVariable(json_string);
        document.getElementById("easychat_etsource_channel_preloader").style.display = "block";
        $.ajax({
            url: "/chat/save-channel-language-tuned-objects/",
            type: "POST",
            data: {
                json_string: json_string
            },
            success: function (response) {
                document.getElementById("easychat_etsource_channel_preloader").style.display = "none";
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    M.toast({
                        "html": "Channel details updated successfully."
                    })
                    window.location = window.location.href;
                } else if (response["status"] == 400) {
                    M.toast({
                        "html": response["message"]
                    }, 2000)
                } else {
                    M.toast({
                        "html": "Internal Server Error. Please report this error"
                    })
                }
            },
            error: function (error) {
                document.getElementById("easychat_web_channel_preloader").style.display = "none";
                console.log("Report this error: ", error);
            },
        });
    });

}




function set_telegram_webhook(element) {

    element.innerHTML = "Adding...";
    var location_href = window.location.href;
    var location_href = location_href.replace("#", "");
    var location_href = location_href.replace("!", "");
    var bot_id = location_href.split("?")[1].split("=")[1];
    var telegram_api_token = document.getElementById("telegram-api-token").value;

    json_string = JSON.stringify({
        bot_id: bot_id,
        telegram_api_token: telegram_api_token
    });
    json_string = EncryptVariable(json_string)
    $.ajax({
        url: "/chat/telegram/set-webhook/",
        type: "POST",
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {

                element.innerHTML = "Add API Token";
                element.classList.remove("green");
                element.classList.add("grey");
                element.removeAttribute("onclick");
                document.getElementById("telegram-api-token").value = response["telegram_api_token"];
                document.getElementById("telegram-api-token").setAttribute("readonly", true);
                document.getElementById("token-guideline").innerHTML = "API token already added."
                M.toast({
                    "html": "API token added successfully."
                }, 2000)
            } else {
                M.toast({
                    "html": "Unable to set Webhook. Please report this error"
                }, 2000)
            }
        },
        error: function (error) {
            M.toast({
                "html": "Please report this error " + error
            }, 2000)
        }
    });
}

var intent_name_pk_dict = {}

function easychat_add_script(filename) {
    var head = document.getElementsByTagName('head')[0];
    var script = document.createElement('script');
    script.src = filename;
    script.type = 'text/javascript';
    document.head.appendChild(script)
}


function get_suggestion_list(bot_id, category_id, intent_type, channel_name) {
    var json_string = JSON.stringify({
        bot_id: bot_id,
        category_id: category_id,
        intent_type: intent_type,
        channel_name: channel_name
    });
    json_string = EncryptVariable(json_string);
    json_string = encodeURIComponent(json_string);

    var xhttp = new XMLHttpRequest();
    var params = 'json_string=' + json_string
    xhttp.open("POST", "/chat/get-intents/", true);
    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            response = JSON.parse(this.responseText);
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                intents_list = response["intents_list"]
                intent_name_pk_dict = response["intent_name_pk_dict"]

                var intents = document.getElementById('Intents');
                try {
                    while (intents.lastChild) {
                        intents.removeChild(intents.lastChild);
                    }


                    //$("#Intents").empty();
                    var option = document.createElement('option');
                    option.text = "Select one of the intent and click go";
                    option.value = "";
                    intents.appendChild(option);
                    for (var i = 0; i < intents_list.length; i++) {
                        var option = document.createElement('option');
                        option.text = intents_list[i];
                        option.value = intents_list[i];
                        intents.appendChild(option);
                        //$("#Intents").append('<option  value="' +  intents_list[i] + '"></option>');
                    }
                } catch (err) {
                    console.log(err)
                }
            } else {
                console.log("error")
            }
        }
    }
    xhttp.send(params);
}

function go_to_intent(bot_pk) {
    intent_name = document.getElementById("Intents").value

    if (intent_name in intent_name_pk_dict) {
        intent_pk = intent_name_pk_dict[String(intent_name)]

    } else {
        M.toast({
            "html": "Please select a valid intent."
        }, 2000);
        return;
    }

    window.open("/chat/edit-intent/?intent_pk=" + intent_pk, '_blank');
}

if (window.location.pathname == "/chat/intent/") {

    let url_selected_language = get_url_vars()['selected_language']

    try {
        if (url_selected_language !== SELECTED_LANGUAGE) {
            window.location = set_url_parameter("selected_language", SELECTED_LANGUAGE)
        }
    } catch (err) {
        console.log(err)
    }
    var params = get_url_vars();

    var category_id = params["category_id"];
    if (category_id == null || category_id == undefined) {
        category_id = "";
    }

    var intent_type = params["intent_type"];
    if (intent_type == null || intent_type == undefined) {
        intent_type = "";
    }

    var channel_name = params["channel_name"]
    if (channel_name == null || channel_name == undefined) {
        channel_name = "";
    }

    get_suggestion_list(selected_bot_obj_pk, category_id, intent_type, channel_name)
    $(document).ready(function () {
        create_language_custom_dropdowns_for_intent();

    });
    add_language_dropdown_search_event()
    add_language_selction_event_for_intent()
    language_dropdown_close_onclicking_outside_event()
    language_search_dropdown_event()
    open_close_language_dropdown_event()


}
if (window.location.href.match(window.location.origin + "/chat/bot/edit/")) {
    $(".iconsFlex").children('a').addClass("active");
}

function show_available_soon_toast() {
    M.toast({
        "html": "Will be available shortly."
    }, 2000);
}

//////////////////////////// Masking PII Data ///////////////////////////////////

var is_otp_verified = false;
var token = "";
$('#checkbox-masking-enabled').on('change', function () {
    send_otp_code(false)
});
$('#easychat-mask-pii-time').on('change', function () {
    send_otp_code(true)
});

function resend_otp() {
    var masking_time_elem = document.getElementById('easychat-mask-pii-time');
    var changed_time = false;
    if (masking_time_elem) {
        var masking_time_entered = parseInt(masking_time_elem.value);

        if (masking_time_entered != parseInt(MASKING_TIME)) {
            changed_time = true;
        }
    }

    send_otp_code(changed_time);
}

async function send_otp_code(changed_time) {
    var masking_enabled = document.getElementById('checkbox-masking-enabled').checked;
    var masking_time_elem = document.getElementById('easychat-mask-pii-time');

    if (!changed_time) {
        if (masking_enabled) {
            showToast('Click on Save button to mask the Customer data due to privacy concerns', 3000);
            return;
        }
    } else {
        var masking_time_entered = parseInt(masking_time_elem.value);

        if (masking_time_entered < 1 || masking_time_entered > 20) {
            showToast('Minimum value-1 min and Maximum value-20mins', 2000);
            masking_time_elem.value = MASKING_TIME;
            return;
        }
    }

    var bot_id = window.location.pathname.split("/")[4];
    $('#easychat-masking-pi-modal').modal({
        'onCloseEnd': function () {
            check_otp_verified()
        },
    });

    $('#easychat-masking-pi-modal').modal('open');
    empty_otp_fields();
    setTimeout(function () {
        document.getElementsByClassName('otp-form')[0].focus();
    }, 500)

    document.getElementById('easychat-resend-otp').style.pointerEvents = 'none';
    document.getElementById('easychat-resend-otp').style.cursor = 'default';

    await toggle_data_mask(bot_id, masking_enabled, masking_time_elem.value);

    document.getElementById('easychat-resend-otp').style.pointerEvents = 'auto';
    document.getElementById('easychat-resend-otp').style.cursor = 'pointer';
}

function toggle_data_mask(bot_id, masking_enabled, masking_time) {
    return new Promise(function (resolve, reject) {

        let json_string = JSON.stringify({
            bot_id: bot_id,
            masking_enabled: masking_enabled,
            masking_time: masking_time,
        });

        json_string = EncryptVariable(json_string);
        json_string = encodeURIComponent(json_string);

        const xhttp = new XMLHttpRequest();
        const params = 'json_string=' + json_string

        xhttp.open("POST", DATA_MASK_TOGGLE_API, true);
        xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                let response = JSON.parse(this.responseText);
                response = custom_decrypt(response)
                response = JSON.parse(response);

                if (response["status_code"] != "200") {
                    showToast(response["status_message"], 2000);
                }
                resolve();
            }
        }

        xhttp.send(params);
    })
}

function check_otp(elem) {
    var entered_otp_inputs = document.getElementsByClassName('otp-form');

    var entered_otp = "";
    for (otp_input of entered_otp_inputs) {
        entered_otp += otp_input.value;
    }

    if (entered_otp == "" || entered_otp.length < 6) {
        showToast('Please enter otp before submitting.', 2000);
        return;
    }

    var bot_id = window.location.pathname.split("/")[4];
    elem.innerHTML = 'Verifying..';

    match_otp_from_server(entered_otp, bot_id, elem);
}

function match_otp_from_server(entered_otp, bot_id, elem) {
    return new Promise(function (resolve, reject) {

        var json_string = JSON.stringify({
            entered_otp: entered_otp,
            bot_id: bot_id,
        });

        json_string = EncryptVariable(json_string);
        json_string = encodeURIComponent(json_string);

        const xhttp = new XMLHttpRequest();
        const params = 'json_string=' + json_string

        xhttp.open("POST", CHECK_DATA_TOGGLE_OTP_API, true);
        xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                let response = JSON.parse(this.responseText);
                response = custom_decrypt(response)
                response = JSON.parse(response);

                if (response.status_code == 200) {
                    if (response.message == "Matched") {
                        token = response.token
                        elem.innerHTML = 'Verified';
                        is_otp_verified = true;

                        var masking_enabled = document.getElementById('checkbox-masking-enabled').checked;

                        if (masking_enabled) {
                            showToast('Click on Save button to save the changed PII time', 3000)
                        } else {
                            showToast('Click on Save button to save the customer data in original format without being masked', 3000);
                        }

                        $('#easychat-masking-pi-modal').modal('close');
                    } else {
                        elem.innerHTML = 'Submit';
                        showToast('Please enter correct OTP', 2000);
                    }
                    empty_otp_fields();
                } else {
                    showToast('Error in matching otp. Please try again later', 2000);
                    resolve(false);
                }

            }
        }

        xhttp.send(params);
    })
}

function empty_otp_fields() {
    var otp_elems = document.getElementsByClassName('otp-form');

    for (otp_elem of otp_elems) {
        otp_elem.value = '';
    }
}

function check_otp_verified() {
    if (!is_otp_verified) {
        var elem = document.getElementById('checkbox-masking-enabled');
        elem.checked = true;

        var elem = document.getElementById('easychat-mask-pii-time');
        elem.value = MASKING_TIME;
    }
}

$('.otp-form').on('keypress', function (e) {
    keys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9']
    return keys.indexOf(event.key) > -1
});

$('.otp-form').on('keyup', function (e) {
    keys = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9']
    if (keys.indexOf(this.value) != -1) {
        $(this).next().focus();
    }
    var pressed_key = event.keyCode || event.charCode;
    if (pressed_key == 8 || pressed_key == 46) {
        $(this).prev().focus();
    }
});

function get_masked_message(message) {
    var regex = /[a-fA-F0-9]{64}/g;

    message = message.replace(regex, function (hashed_msg) {
        return (
            hashed_msg.substring(0, 5) +
            "***" +
            hashed_msg.substring(hashed_msg.length - 2, hashed_msg.length)
        );
    });

    return message;
}


//////////////////////////// Masking PII Data Ends //////////////////////////////////////////////////////////////////////

////////////////////////// Demoter Feedback Form Start ///////////////////////////////


function feedback_options_hide_show(total_feedback) {
    var maximum_value = parseInt(total_feedback);
    var input_value = document.getElementById("rating_csat_value").value
    if (input_value === "") {
        document.getElementById('wrong_value_feedback').innerText = `This field cannot be left empty, it can contain Min - 1 and Max - ${maximum_value} values`;
        document.getElementById('wrong_value_feedback').style.color = '#4D4D4D';

    } else if (input_value <= maximum_value && input_value >= 1) {

        for (var i = 1; i <= input_value; i++) {
            document.getElementById('feedback_option_' + i).style.display = "block";
        }

        for (var j = maximum_value; j > input_value; j--) {
            document.getElementById('feedback_option_' + j).style.display = "none";
        }
        document.getElementById('wrong_value_feedback').innerText = `Min - 1 and Max - ${maximum_value} values`;
        document.getElementById('wrong_value_feedback').style.color = '#4D4D4D';
    } else {
        document.getElementById('wrong_value_feedback').innerText = `Min - 1 and Max - ${maximum_value} values Only`;
        document.getElementById('wrong_value_feedback').style.color = 'red';
    }
}

function check_input_feedback(bot_pk, max_feedback_allowed) {
    var input_value = $("#rating_csat_value").val();

    let isnum = /^\d+$/.test(input_value.trim());
    if (!isnum) {
        M.toast({
            "html": "Enter the number of feedback(s) required"
        }, 2000);
        return;
    }

    if (input_value.trim() == "" || parseInt(input_value.trim()) < 1) {
        M.toast({
            "html": "Number of feedback must be greater than or equal to 1"
        }, 2000);
        return;
    }
    if (input_value == '') {
        document.getElementById('wrong_value_feedback').innerText = "Fill all the input fields";
        document.getElementById('wrong_value_feedback').style.color = 'red';
    } else if (input_value <= 0 && input_value < max_feedback_allowed) {
        return;
    } else {
        feedback_options_inputs = []

        max_feedback_allowed = parseInt(max_feedback_allowed)
        for (var item = 1; item <= max_feedback_allowed; item++) {
            if (document.getElementById("feedback_option_" + item).style.display == "block") {
                if (document.getElementById("feedback_option__input_" + item).value.trim() == "") {
                    document.getElementById('wrong_value_feedback').innerText = "Fill all input field";
                    document.getElementById('wrong_value_feedback').style.color = 'red';
                    return;
                }
                if (!check_duplicates_for_value(document.getElementById("feedback_option__input_" + item).value.trim(), feedback_options_inputs))
                    feedback_options_inputs.push(document.getElementById("feedback_option__input_" + item).value.trim())
                else {
                    M.toast({
                        "html": "Duplicate values found"
                    });
                    feedback_options_inputs = []
                    return;
                }
            }
        }
        collect_phone_number = document.getElementById("collect_phone_number").checked
        collect_email_id = document.getElementById("collect_email_id").checked
        mark_all_fields_mandatory = document.getElementById("mark_all_fields_mandatory").checked
        document.getElementById('wrong_value_feedback').innerText = `Min - 1 and Max - ${max_feedback_allowed} values`;
        document.getElementById('wrong_value_feedback').style.color = '#4D4D4D';

        var json_string = JSON.stringify({
            input_value: input_value,
            feedback_options_inputs: JSON.stringify(feedback_options_inputs),
            collect_phone_number: collect_phone_number,
            collect_email_id: collect_email_id,
            mark_all_fields_mandatory: mark_all_fields_mandatory,
            bot_id: parseInt(bot_pk)
        });
        json_string = EncryptVariable(json_string);
        json_string = encodeURIComponent(json_string);

        var xhttp = new XMLHttpRequest();
        var params = 'json_string=' + json_string
        xhttp.open("POST", "/chat/save-csat-form/", true);
        xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhttp.setRequestHeader('X-CSRFToken', get_csrf_token());
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                response = JSON.parse(this.responseText);
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    showToast("CSAT Feedback successfully saved.", 2000);
                    $('#configure_csat_modal').modal('close');
                } else {
                    showToast("Check if all the inputs are valid.", 2000);
                    $('#configure_csat_modal').modal('close');
                }
            }
        }
        xhttp.send(params);
    }
}

function toggle_csat_feedback_checkbox(el) {
    var checked = el.checked;

    if (checked) {
        document.getElementById('configure-csat-modal-opener').style.display = 'inline-block';
    } else {
        document.getElementById('configure-csat-modal-opener').style.display = 'none';
    }
}
/////////////////////////// Demoter Feedback Form End ////////////////////////////////

function set_character_count(el) {
    const count = el.value.length;
    const id = el.id + '-char-count';

    document.getElementById(id).innerHTML = count;
}

function check_file_size(el) {
    var file = el.files[0];
    var size_warn_el = document.getElementById('file-size-warning');

    if (file.size > 1000000) {
        size_warn_el.innerHTML = "*Your file size is " + parseInt(file.size / 1000000) + " mb. For optimal performance please upload file having size < 1mb";
        size_warn_el.parentElement.style.display = 'block';
    } else {
        size_warn_el.innerHTML = "";
    }
}

/* Build Bot Starts */

var some_processes_failed = false;
var is_build_bot_running = false;

function build_bot(el) {
    if (el.id == 'build-bot-toast-btn' || el.id == 'build-bot-cancel-btn') {
        document.getElementById('easychat-build-bot-toast-div').style.display = 'none';
        document.getElementById("easychat-content-wrapper").style.maxHeight = '90vh';
        var side_nav = document.getElementById('main-console-sidenav');
        if (side_nav) {
            side_nav.style.marginTop = '4%';
        }
    }

    if (el.id == 'build-bot-cancel-btn') {
        cancel_build_bot();
        $(".easychat-user-chat-contacts-list-wrapper").removeClass("user-history-change-div-height");
        $(".easychat-user-chat-history-message-container").removeClass("user-history-change-div-height");
        return;
    }

    $('#easychat-build-bot-modal').modal('open');

    if (is_build_bot_running) return;

    is_build_bot_running = true;

    reset_build_bot_modal();
    initiate_build_bot();
}

function reset_build_bot_modal() {
    document.getElementById('build-bot-points').style.display = 'block';
    document.getElementById('bot-built-failed').style.display = 'none';

    $('#build-bot-process-loader-one').removeClass('success');
    $('#build-bot-process-loader-two').removeClass('success');
    $('#build-bot-process-loader-three').removeClass('success');
    $('#build-bot-process-loader-four').removeClass('success');
    $('#build-bot-process-loader-five').removeClass('success');

    $('#build-bot-process-loader-one').addClass('processing');

}

function initiate_build_bot() {
    $('#build-bot-process-loader-one').addClass('processing');

    var selected_bot_pk = get_bot_id();

    var json_string = JSON.stringify({
        'bot_id': selected_bot_pk,
    });
    json_string = EncryptVariable(json_string);
    json_string = encodeURIComponent(json_string);

    var xhttp = new XMLHttpRequest();
    var params = 'json_string=' + json_string;
    xhttp.open("POST", "/chat/build-bot/", true);
    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            response = JSON.parse(this.responseText);
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {

                build_bot_timer = setInterval(track_build_bot_progress, 5000);
            } else {

                some_processes_failed = true;
                document.getElementById('build-bot-points').style.display = 'none';
                document.getElementById('bot-built-failed').style.display = 'block';
            }

        }
    }
    xhttp.send(params);
}

function track_build_bot_progress() {
    bot_id = get_bot_id();

    var json_string = JSON.stringify({
        bot_id: bot_id,
        event_type: 'build_bot'
    })

    json_string = EncryptVariable(json_string)
    $.ajax({
        url: "/chat/bot/track-event-progress/",
        type: "POST",
        headers: {
            'X-CSRFToken': get_csrf_token()
        },
        data: {
            data: json_string,
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            console.log(response);
            if (response.status == 200) {
                var event_progress = response.event_progress;
                var is_completed = response.is_completed;
                var is_toast_displayed = response.is_toast_displayed;
                var is_failed = response.is_failed;

                if (is_failed && !is_toast_displayed) {
                    failed_message = 'Build Bot Failed'

                    some_processes_failed = true;
                    is_build_bot_running = false;
                    showToast(failed_message, 2000);
                    document.getElementById('build-bot-points').style.display = 'none';
                    document.getElementById('bot-built-failed').style.display = 'block';
                } else if (is_completed && !is_toast_displayed) {

                    is_build_bot_running = false
                    showToast('Build Bot Completed Successfully');
                    show_build_bot_status(100)
                } else {

                    if (!is_completed && !is_failed) {
                        is_build_bot_running = true;
                        show_build_bot_status(event_progress);
                    }
                }
            } else {
                is_build_bot_running = false;
                if (build_bot_timer) {
                    clearInterval(build_bot_timer);
                }
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);
        }
    });
}

function show_build_bot_status(event_progress) {
    if (event_progress >= 20) {
        $('#build-bot-process-loader-one').removeClass('processing');
        $('#build-bot-process-loader-one').addClass('success');

        $('#build-bot-process-loader-two').addClass('processing');
    }

    if (event_progress >= 40) {
        $('#build-bot-process-loader-two').removeClass('processing');
        $('#build-bot-process-loader-two').addClass('success');

        $('#build-bot-process-loader-three').addClass('processing');
    }

    if (event_progress >= 60) {
        $('#build-bot-process-loader-three').removeClass('processing');
        $('#build-bot-process-loader-three').addClass('success');

        $('#build-bot-process-loader-four').addClass('processing');
    }

    if (event_progress >= 80) {
        $('#build-bot-process-loader-four').removeClass('processing');
        $('#build-bot-process-loader-four').addClass('success');

        $('#build-bot-process-loader-five').addClass('processing');
    }

    if (event_progress == 100) {
        $('#build-bot-process-loader-five').removeClass('processing');
        $('#build-bot-process-loader-five').addClass('success');
    }
}

function cancel_build_bot() {
    return new Promise(function (resolve, reject) {
        $('#build-bot-process-loader-five').addClass('processing');

        var selected_bot_pk = get_bot_id();

        var json_string = JSON.stringify({
            'bot_id': selected_bot_pk,
        });
        json_string = EncryptVariable(json_string);
        json_string = encodeURIComponent(json_string);

        var xhttp = new XMLHttpRequest();
        var params = 'json_string=' + json_string;
        xhttp.open("POST", "/chat/update-need-to-build-bot/", true);
        xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                response = JSON.parse(this.responseText);
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response["status"] == 200) {
                    // for debug
                    console.log('Build Bot Cancelled!');
                } else {
                    console.log("Failed to Cancel Build Bot!");
                }
            }
        }
        xhttp.send(params);
    })
}

function get_bot_id() {
    var selected_bot_pk = window.location.href.split("/")[6];

    if (!selected_bot_pk) {
        selected_bot_pk = get_url_vars()["bot_pk"];
    }

    if (!selected_bot_pk) {
        selected_bot_pk = get_url_vars()["bot_id"];
    }

    if (!selected_bot_pk) {
        selected_bot_pk = $("#multiple-select-bot-choice-pk-list").val();
    }

    return selected_bot_pk;
}

/* Build Bot Ends */


// Lanague fine tuning start

function set_url_parameter(parameter, parameter_value) {
    var final_query_param = "?";
    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
        final_query_param += key + "=" + (key == parameter ? parameter_value : value) + "&"
    });
    return window.location.origin + window.location.pathname + final_query_param;
}

// function check_and_update_language(selected_language, bot_pk) {

//     $("#modal-language-change-loader").modal('open')
//     var json_string = JSON.stringify({
//         selected_language: selected_language,
//         bot_pk: bot_pk
//     })
//     json_string = EncryptVariable(json_string);
//     json_string = encodeURIComponent(json_string);

//     var xhttp = new XMLHttpRequest();
//     var params = 'json_string=' + json_string
//     xhttp.open("POST", "/chat/update-selected-language/", false);
//     xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
//     xhttp.onreadystatechange = function() {
//         if (this.readyState == 4 && this.status == 200) {
//             response = JSON.parse(this.responseText);
//             response = custom_decrypt(response)
//             response = JSON.parse(response);
//             if (response["status"] == 200) {
//                 window.location = set_url_parameter("selected_language", selected_language)
//             } else {

//                 M.toast({
//                     "html": "Unable to get requested data. Please try after sometime."
//                 }, 1000);
//                 $("#modal-language-change-loader").modal('close')
//             }
//         }
//     }
//     xhttp.send(params);
// }

// function check_and_update_language_intent(selected_language, intent_pk) {

//     $("#modal-language-change-loader").modal('open')

//     var json_string = JSON.stringify({
//         selected_language: selected_language,
//         intent_pk: intent_pk
//     })
//     json_string = EncryptVariable(json_string);
//     json_string = encodeURIComponent(json_string);

//     var xhttp = new XMLHttpRequest();
//     var params = 'json_string=' + json_string
//     xhttp.open("POST", "/chat/update-selected-language-intent/", false);
//     xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
//     xhttp.onreadystatechange = function() {
//         if (this.readyState == 4 && this.status == 200) {
//             response = JSON.parse(this.responseText);
//             response = custom_decrypt(response)
//             response = JSON.parse(response);
//             if (response["status"] == 200) {

//                 window.location = window.location.origin + "/chat/edit-intent-multilingual/?intent_pk=" + intent_pk + "&selected_language=" + selected_language;
//             } else {

//                 M.toast({
//                     "html": "Unable to get requested data. Please try after sometime."
//                 }, 1000);
//                 $("#modal-language-change-loader").modal('close')
//             }
//         }
//     }
//     xhttp.send(params);
// }


function save_multilingual_intent() {

    var url_parameters = get_url_vars()
    if (url_parameters["selected_language"] != undefined) {

        selected_language = url_parameters["selected_language"]
    }
    intent_name = $('#intent_name').val().trim();

    if (intent_name == "") {
        M.toast({
            "html": "Intent name cannot be empty."
        }, 2000);
        return;
    }

    selected_bot_pk_list = [$("#multiple-select-bot-choice-pk-list").val()];

    if (selected_bot_pk_list.length == 0) {
        M.toast({
            "html": "Select atleast one bot in which intent will be supported"
        }, 2000);
        return;
    }

    intent_bot_response_text_text = $("#intent_bot_response_text_text").trumbowyg('html')
    intent_bot_response_text_speech = $("#intent_bot_response_text_speech").trumbowyg('html')
    intent_bot_response_reprompt = $("#intent_bot_response_reprompt").trumbowyg('html')
    intent_bot_response_text_text = intent_bot_response_text_text.replace(new RegExp('\r?<br />', 'g'), '<br>');
    intent_bot_response_ssml = $("#intent_bot_response_ssml").val();

    if (validate_ck_editor_response(intent_bot_response_text_text) != "" && validate_ck_editor_response(intent_bot_response_text_speech) == "") {
        intent_bot_response_text_speech = intent_bot_response_text_text
    }

    if (validate_ck_editor_response(intent_bot_response_text_text) == "") {
        M.toast({
            "html": "At least one text/speech response required."
        }, 2000);
        return;
    }

    var intent_response_list = [{
        "text_response": intent_bot_response_text_text,
        "speech_response": intent_bot_response_text_speech,
        "hinglish_response": "",
        "reprompt_response": intent_bot_response_reprompt,
        "ssml_response": ssml_response,
    }];
    card_list = []
    var spans = document.getElementsByTagName("span");
    for (var i = 0; i < spans.length; i++) {
        if (spans[i].id.indexOf("title_intent_card_") == 0) {
            data_id = spans[i].id;
            token_id = data_id.split("_")[3];
            check_img = document.getElementById("img_url_intent_card_" + token_id);
            card_img_url = '';
            if (check_img) {
                card_img_url = $("#img_url_intent_card_" + token_id).attr("src");
            }
            card_title = document.getElementById("title_intent_card_" + token_id).innerText;
            card_content = $("#content_intent_card_" + token_id).html();
            card_url = $("#link_intent_card_" + token_id).attr("href");
            card_list.push({
                "title": card_title,
                "content": card_content,
                "link": store_this_data_locally(card_url),
                "img_url": store_this_data_locally(card_img_url)
            });
        }
    }

    rows = document.getElementById('hidden-numbers-rows').innerHTML;
    if (document.getElementById('number-of-rows-table').value != "") {
        rows = document.getElementById('number-of-rows-table').value
    }
    table_input_list_of_list = ""
    if (rows != 0) {
        table_input_list_of_list = check_table_filled()
        if (table_input_list_of_list == false) {
            alert("Table cannot have empty cells");
            return;
        }
    }

    function check_table_filled() {
        rows = document.getElementById('hidden-numbers-rows').innerHTML;
        columns = document.getElementById('hidden-numbers-columns').innerHTML;
        if (document.getElementById('number-of-rows-table').value != "") {
            rows = document.getElementById('number-of-rows-table').value
        }
        if (document.getElementById('number-of-columns-table').value != "") {
            columns = document.getElementById('number-of-columns-table').value
        }
        table_input_list_of_list = []
        for (i = 0; i < rows; i++) {
            row_list = []
            for (j = 0; j < columns; j++) {
                cell_value = document.getElementById('cell-id-' + i.toString() + j.toString()).innerHTML;
                if (cell_value != "") {
                    if (un_entity(cell_value).trim() == "<br>" || un_entity(cell_value).trim() == "")
                        return false
                    else
                        row_list.push(un_entity(cell_value));
                } else {
                    return false
                };

            };
            table_input_list_of_list.push(row_list)
        };
        return table_input_list_of_list
    };

    document.getElementById("save-multilingual-intent").innerHTML = '<i class="inline-icon material-icons">save</i> Saving...'
    json_string = JSON.stringify({
        intent_pk: intent_pk,
        intent_name: intent_name,
        response_sentence_list: intent_response_list,
        selected_language: selected_language,
        card_list: card_list,
        table_input_list_of_list: table_input_list_of_list,
    });
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: '/chat/save-multilingual-intent/',
        type: "POST",
        data: {
            json_string: json_string
        },
        dataType: "json",
        async: false,
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            document.getElementById("save-multilingual-intent").innerHTML = '<i class="inline-icon material-icons">save</i> Save'
            if (response['status'] == 200) {

                M.toast({
                    'html': "Intent saved successfully!"
                }, 1000);
                window.location = set_url_parameter("selected_language", "en")
            } else {
                M.toast({
                    'html': "Unable to save the Intent. Please try after some time."
                }, 2000);
            }
        }
    });
}

$(document).on("click", "#save-multilingual-intent", function (e) {
    save_multilingual_intent();
});

if (window.location.pathname == '/chat/edit-tree-multilingual/') {
    if (window.location.href.indexOf("tree_pk=") != -1) {

        var url_parameters = get_url_vars();
        tree_pk = url_parameters["tree_pk"];
        intent_pk = url_parameters["intent_pk"];

        global_select_tree_id = tree_pk;
        global_select_intent_id = intent_pk;
        renderTreeStructureByIntentID(intent_pk);
        renderTreeInformation(tree_pk);
        // renderRequiredModalsIntoHTML(intent_pk);

        $(document).ready(function () {
            tree_generate_table();
        });
    }
}

$(document).on("click", "#save-multilingual-tree", function (e) {

    var url_parameters = get_url_vars();
    tree_pk = url_parameters["tree_pk"];
    intent_pk = url_parameters["intent_pk"];
    parent_pk = url_parameters["parent_pk"];
    selected_language = url_parameters["selected_language"];

    global_select_tree_id = tree_pk;
    global_select_intent_id = intent_pk;
    global_select_parent_id = parent_pk;

    tree_name = $("#tree_name").val();
    tree_name = stripHTML(tree_name);
    tree_name = tree_name.trim();

    tree_bot_response_text_text = $("#tree_bot_response_text_text").trumbowyg('html')
    tree_bot_response_text_speech = $("#tree_bot_response_text_speech").trumbowyg('html')
    tree_bot_response_reprompt = $("#tree_bot_response_reprompt").trumbowyg('html')
    tree_bot_response_ssml = $('#tree_bot_response_ssml').val().trim()

    tree_bot_response_text_text = tree_bot_response_text_text.replace(new RegExp('\r?<br />', 'g'), '<br>');

    if (validate_ck_editor_response(tree_bot_response_text_text) != "" && validate_ck_editor_response(tree_bot_response_text_speech) == "") {
        tree_bot_response_text_speech = tree_bot_response_text_text
    }

    if (validate_ck_editor_response(tree_bot_response_text_text) == "") {
        M.toast({
            "html": "At least one text response required."
        }, 2000);
        return;
    }

    tree_response_list = [{
        "text_response": tree_bot_response_text_text,
        "speech_response": tree_bot_response_text_speech,
        "hinglish_response": "",
        "reprompt_response": tree_bot_response_reprompt,
        "ssml_response": tree_bot_response_ssml,
    }]

    card_list = []
    var spans = document.getElementsByTagName("span");
    for (var i = 0; i < spans.length; i++) {
        if (spans[i].id.indexOf("title_tree_card_") == 0) {
            data_id = spans[i].id;
            token_id = data_id.split("_")[3];
            check_img = $("img_url_tree_card_" + token_id);
            card_img_url = '';
            if (check_img) {
                card_img_url = $("#img_url_tree_card_" + token_id).attr("src");
            }
            card_title = document.getElementById("title_tree_card_" + token_id).innerText;
            card_content = $("#content_tree_card_" + token_id).html();
            card_url = $("#link_tree_card_" + token_id).attr("href");
            card_list.push({
                "title": card_title,
                "content": card_content,
                "link": card_url,
                "img_url": card_img_url
            });
        }
    }

    rows = document.getElementById('tree-hidden-numbers-rows').innerHTML;
    if (document.getElementById('tree-number-of-rows-table').value != "") {
        rows = document.getElementById('tree-number-of-rows-table').value
    }

    table_input_list_of_list = ""
    if (rows != 0) {
        table_input_list_of_list = check_table_filled()
        if (table_input_list_of_list == false) {
            alert("Table cannot have empty cells");
            return;
        }
    }

    function check_table_filled() {
        rows = document.getElementById('tree-hidden-numbers-rows').innerHTML;
        columns = document.getElementById('tree-hidden-numbers-columns').innerHTML;
        if (document.getElementById('tree-number-of-rows-table').value != "") {
            rows = document.getElementById('tree-number-of-rows-table').value
        }
        if (document.getElementById('tree-number-of-columns-table').value != "") {
            columns = document.getElementById('tree-number-of-columns-table').value
        }
        table_input_list_of_list = []
        for (i = 0; i < rows; i++) {
            row_list = []
            for (j = 0; j < columns; j++) {
                cell_value = document.getElementById('cell-id-' + i.toString() + j.toString()).innerHTML;
                if (cell_value != "") {
                    if (un_entity(cell_value).trim() == "<br>" || un_entity(cell_value).trim() == "")
                        return false
                    else
                        row_list.push(un_entity(cell_value));
                } else {
                    return false
                };

            };
            table_input_list_of_list.push(row_list)
        };
        return table_input_list_of_list
    };

    json_string = JSON.stringify({
        intent_pk: intent_pk,
        tree_pk: tree_pk,
        tree_name: tree_name,
        response_sentence_list: tree_response_list,
        selected_language: selected_language,
        card_list: card_list,
        table_input_list_of_list: table_input_list_of_list,
    });

    json_string = EncryptVariable(json_string);

    var response = $.ajax({
        url: '/chat/save-multilingual-tree/',
        type: 'POST',
        async: false,
        data: {
            json_string: json_string
        },
        success: function (response) {

            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                M.toast({
                    'html': 'Tree saved successfully!'
                }, 2000);
                setTimeout(function (e) {
                    window.location = set_url_parameter("selected_language", "en")
                }, 2000);
            } else {
                M.toast({
                    'html': 'Unable to save current tree. Please try after some time.'
                }, 2000);
            }
        },
        error: function (error) {
            M.toast({
                'html': 'Unable to connect to server. Please try again later'
            }, 2000);
        }
    }).responseJSON;
});

// Lanague fine tunning end

// User chat history filter

function compare_dates(start_date, end_date) {
    // YYYY-MM-DD format
    if (start_date.slice(0, 4) < end_date.slice(0, 4)) {
        return true;
    } else if (start_date.slice(0, 4) == end_date.slice(0, 4)) {
        if (start_date.slice(5, 7) < end_date.slice(5, 7)) {
            return true;
        } else if (start_date.slice(5, 7) == end_date.slice(5, 7)) {
            if (start_date.slice(8, 10) <= end_date.slice(8, 10)) {
                return true;
            }
        }
    }
    return false;
}

function get_selected_channels(filter_type) {
    var channels_elems = document.querySelectorAll('.' + filter_type + '-channel-checkbox');
    var selected_channels = '';

    channels_elems.forEach(function (channel) {
        if (channel.checked) {
            if (selected_channels != "") {
                selected_channels += "+";
            }
            selected_channels += channel.id;
        }
    })

    return selected_channels;
}

function apply_user_chat_history_filter() {
    var date_range_type = "";
    var start_date = "";
    var end_date = "";
    var channels = "";
    var bot_id = get_url_vars()["bot_id"];
    var redirection_url = "/chat/user-filtered/?bot_id=" + bot_id;

    if (document.getElementById("date_range_1").checked) {
        date_range_type = "1";
    } else if (document.getElementById("date_range_2").checked) {
        date_range_type = "2";
    } else if (document.getElementById("date_range_3").checked) {
        date_range_type = "3";
    } else if (document.getElementById("date_range_4").checked) {
        date_range_type = "4";
    } else if (document.getElementById("date_range_5").checked) {
        date_range_type = "5";
        var today = new Date();
        var today = String(today.getMonth() + 1).padStart(2, '0') + '/' + String(today.getDate()).padStart(2, '0') + '/' + today.getFullYear();
        var from_date = document.getElementById("datepicker-1-0").value;
        var end_date = document.getElementById("datepicker-1-1").value;
        var from_time = document.getElementById("time-picker-btn-1-0").value;
        var end_time = document.getElementById("time-picker-btn-1-1").value;
        //From date cannot be greater than todays date
        if (!compare_message_history_dates(from_date, today)) {
            showToast("From date cannot be greater than today's date.");
            return;
        }

        //To date cannot be greater than todays date
        if (!compare_message_history_dates(end_date, today)) {
            showToast("To date cannot be greater than today's date");
            return;
        }

        //From datetime cannot be greater than to datetime
        if (!compare_message_history_datetime(from_date, end_date, from_time, end_time)) {
            showToast("From timestamp cannot be greater than to timestamp.");
            return;
        }

        from_date = from_date + "_" + from_time.split(" ").join("");
        end_date = end_date + "_" + end_time.split(" ").join("");

    }

    redirection_url += "&filter_type=" + date_range_type;
    if (date_range_type == 5) {
        redirection_url += "&start_date=" + from_date;
        redirection_url += "&end_date=" + end_date;
    }

    var selected_channels = get_selected_channels('user-chat-history');
    if (selected_channels != "") {
        redirection_url += "&channels=" + selected_channels;
    }

    window.location = redirection_url;
}
// User chat history filter end

// User chat history next page code
function select_page(page) {
    var params = get_url_vars();
    params["page"] = page;
    var redirection_url = "?";
    for (param in params) {
        if (redirection_url != "?") {
            redirection_url += "&";
        }
        redirection_url += param + "=" + params[param];
    }
    window.location = redirection_url;
}
// User chat history next page code end

function clear_user_filtered_data() {
    location.reload()
}

function select_single_channel_for_filter(element) {

    channel_selected = element.id;
}


function apply_intent_filter() {
    var intent_type_selected = "";
    var category_selected = "0";

    if (document.getElementById("intent_type_one").checked) {
        intent_type_selected = "is_form_assist_intent";
    } else if (document.getElementById("intent_type_two").checked) {
        intent_type_selected = "is_attachment_required";
    } else if (document.getElementById("intent_type_three").checked) {
        intent_type_selected = "is_small_talk";
    }

    category_selected = $("#easychat-filter-intent-category-select-div ul .easychat-lang-selected")[0].getAttribute("data-value");

    var params = get_url_vars();

    delete params["page"];
    if (intent_type_selected != "") {

        params["intent_type"] = intent_type_selected;
    } else if (intent_type_selected == "") {

        delete params["intent_type"];
    }
    if (channel_selected != "") {

        params["channel_name"] = channel_selected;
    } else if (channel_selected == "") {

        delete params["channel_name"];
    }
    if (category_selected != "0") {

        params["category_id"] = category_selected;
    } else if (category_selected == "0") {

        delete params["category_id"];
    }
    var redirection_url = "?";
    for (param in params) {
        if (redirection_url != "?") {
            redirection_url += "&";
        }
        redirection_url += param + "=" + params[param];
    }

    window.location = redirection_url;
}

function clear_intent_filter(filter) {
    var params = get_url_vars();
    delete params["page"];
    delete params[filter];
    var redirection_url = "?";
    for (param in params) {
        if (redirection_url != "?") {
            redirection_url += "&";
        }
        redirection_url += param + "=" + params[param];
    }
    window.location = redirection_url;
}

function check_bot_logo_file_size(el) {
    var file = el.files[0];
    var size_warn_el = document.getElementById('bot-logo-file-size-warning');

    if (file.size > 200000) {
        size_warn_el.innerHTML = "*Your file size is greater than 200 KB. For best performance, please upload a logo having size < 200 KB.";
        document.getElementById('upload-bot-logo').disabled = true;
    } else {
        size_warn_el.innerHTML = "";
        document.getElementById('upload-bot-logo').disabled = false;
    }
}

function open_upload_bot_logo_modal() {
    document.getElementById('bot-logo-file-size-warning').innerHTML = "";
    document.getElementById('upload-bot-logo').disabled = false;
    document.getElementById('input_upload_bot_logo2').value = "";
    document.getElementById('input_upload_bot_logo').value = "";
    $('#modal-upload-bot-logo').modal('open');
}

$(document).ready(function () {
    $('#enable_form_assist').change(function () {
        if (document.getElementById("enable_form_assist").checked) {
            document.getElementById("form_assist_type_wrapper").style.display = "block";
            if (document.getElementById("form_assist_intent_bubble_cb").checked) {
                document.getElementById('form_assist_intent_bubble_wrapper').style.display = 'inline-table';
                document.getElementById('form_assist_auto_popup_wrapper').style.display = 'none';
            }
            else {
                document.getElementById('form_assist_auto_popup_wrapper').style.display = 'inline-table';
                document.getElementById('form_assist_intent_bubble_wrapper').style.display = 'none';
            }
            if(document.getElementById('form_assist_enable_custom_intents').checked==true){
                $("#enable_custom_intents_web_form_list").show();
                $("#enable_custom_intents_web_form").show();
            }
            else{
                $("#enable_custom_intents_web_form_list").hide();
                $("#enable_custom_intents_web_form").hide();
            }
            uncheck_and_disable_auto_popup_settings();
            document.getElementById("enable_voice_form_assist_wrapper").style.display = "table";

        } else {
            document.getElementById("form_assist_type_wrapper").style.display = "none";
            reset_auto_popup_settings();
            document.getElementById("enable_voice_form_assist_wrapper").style.display = "none";
        }

    });
});

function show_form_assist_type_options(elem) {
    if (elem.value == "assist_popup") {
        document.getElementById('form_assist_intent_bubble_wrapper').style.display = 'none';
        document.getElementById('form_assist_auto_popup_wrapper').style.display = 'inline-table';
    } else {
        document.getElementById('form_assist_intent_bubble_wrapper').style.display = 'inline-table';
        document.getElementById('form_assist_auto_popup_wrapper').style.display = 'none';
    }
}

function show_form_assist_popup_options(select) {
    if (select.value == 2) {
        document.getElementById('form-assist_bot_popup_intents').style.display = "table-row";
        document.getElementById('form_assist_custom_intents').style.display = "table-row";
        if(document.getElementById('form_assist_enable_custom_intents').checked==true){
            $("#enable_custom_intents_web_form_list").show();
            $("#enable_custom_intents_web_form").show();
        }
        else{
            $("#enable_custom_intents_web_form_list").hide();
            $("#enable_custom_intents_web_form").hide();
        }

    } else {
        document.getElementById('form-assist_bot_popup_intents').style.display = "none";
        document.getElementById('form_assist_custom_intents').style.display = "none";
        $("#enable_custom_intents_web_form_list").hide();
        $("#enable_custom_intents_web_form").hide();

    }
}

function uncheck_and_disable_auto_popup_settings() {
    document.getElementById("bot-popup-time").style.display = "none";
    document.getElementById("bot-popup-options").style.display = "none";
    document.getElementById("bot-popup-intents").style.display = "none";
    $("#enable_custom_intents_web_auto_popup").hide();
    $("#enable_custom_intents_web_auto_popup_list").hide();
    document.getElementById('bot-popup-custom-intent').style.display = "none";
    document.getElementById("bot-popup-text").style.display = "none";
    document.getElementById('bot-popup-inactivity').style.display = "none";
    document.getElementById("is-bot-auto-popup-allowed-desktop").checked = false;
    document.getElementById("is-bot-auto-popup-allowed-mobile").checked = false;
    document.getElementById("is-bot-auto-popup-allowed-desktop").disabled = true;
    document.getElementById("is-bot-auto-popup-allowed-mobile").disabled = true;
}

function reset_auto_popup_settings() {
    document.getElementById("is-bot-auto-popup-allowed-desktop").disabled = false;
    document.getElementById("is-bot-auto-popup-allowed-mobile").disabled = false;
    document.getElementById("is-bot-auto-popup-allowed-desktop").checked = true;
    document.getElementById("is-bot-auto-popup-allowed-mobile").checked = true;
    document.getElementById('bot-popup-inactivity').style.display = "table-row";
    document.getElementById("bot-popup-time").style.display = "table-row";
    document.getElementById("bot-popup-time").value = 5;
    document.getElementById("bot-popup-options").style.display = "table-row";
    $('#bot-popup-options-values').val('2').trigger('change');
    document.getElementById("bot-popup-text").style.display = "table-row";
    document.getElementById("bot-popup-text").value = "Welcome. How may I help you today";
}

// Scripts to handle autosuggest livechat for complex queries 
$('#easychat-checkbox-livechat-enable').click(function () {
    if ($(this).is(':checked')) {
        $('#autosuggest-livechat-complex-queries-row').show()
    }
    else {
        $('#autosuggest-livechat-complex-queries-row').hide()
        $('#autosuggest-livechat-word-limit-row').hide()
        $('#autosuggest-livechat-complex-queries').prop('checked', false);
    }
})
$('#autosuggest-livechat-complex-queries').click(function () {
    if ($(this).is(':checked')) {
        $('#autosuggest-livechat-word-limit-row').show()
    }
    else {
        $('#autosuggest-livechat-word-limit-row').hide()
    }
})

// Data Model Encrypt/Decrypt Values
function decrypt_data_model_values() {

    var data_model_table = document.getElementById("data-model-table");
    var encrypted_values = data_model_table.querySelectorAll('.data-model-values');

    current_data_model_encrypted_values = [];
    encrypted_values.forEach(function (encrypted_value) {
        current_data_model_encrypted_values.push(encrypted_value.innerText);
    });

    var json_string = JSON.stringify({
        "data_model_values": current_data_model_encrypted_values,
    });
    json_string = EncryptVariable(json_string);
    json_string = encodeURIComponent(json_string);

    var xhttp = new XMLHttpRequest();
    var params = 'json_string=' + json_string
    xhttp.open("POST", "/chat/decrypt-data-model-values/", true);
    xhttp.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            response = JSON.parse(this.responseText);
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response["status"] == 200) {
                decrypted_values = response["decrypted_values"];

                update_encrypt_decrypt_icon();

                for (let i = 0; i < decrypted_values.length; i++) {
                    encrypted_values[i].innerText = decrypted_values[i];
                }
            }
        }
    }
    xhttp.send(params);

}

function update_encrypt_decrypt_icon() {

    var data_value_header = document.getElementById("data-model-value-header");

    data_value_header.innerHTML = `Value <button type="button" class="easychat-data-modal-masking-show-icon" id="easychat_data_modal_masking_show_icon" onclick="encrypt_data_model_values()">\
                                        <svg width="14" height="14" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <g clip-path="url(#clip0_1_6005)">
                                        <path d="M0.981445 9.5C0.981445 9.5 3.98145 3.5 9.23145 3.5C14.4814 3.5 17.4814 9.5 17.4814 9.5C17.4814 9.5 14.4814 15.5 9.23145 15.5C3.98145 15.5 0.981445 9.5 0.981445 9.5Z" stroke="#4D4D4D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M9.23145 11.75C10.4741 11.75 11.4814 10.7426 11.4814 9.5C11.4814 8.25736 10.4741 7.25 9.23145 7.25C7.9888 7.25 6.98145 8.25736 6.98145 9.5C6.98145 10.7426 7.9888 11.75 9.23145 11.75Z" stroke="#4D4D4D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </g>
                                        <defs>
                                        <clipPath id="clip0_1_6005">
                                        <rect width="18" height="18" fill="white" transform="translate(0.231445 0.5)"/>
                                        </clipPath>
                                        </defs>
                                        </svg>
                                   </button>`;

}

function encrypt_data_model_values() {

    var data_model_table = document.getElementById("data-model-table");
    var decrypted_values = data_model_table.querySelectorAll('.data-model-values');

    for (let i = 0; i < decrypted_values.length; i++) {
        decrypted_values[i].innerText = current_data_model_encrypted_values[i];
    }

    var data_value_header = document.getElementById("data-model-value-header");

    data_value_header.innerHTML = `Value <button type="button" class="easychat-data-modal-masking-hide-icon" id="easychat_data_modal_masking_hide_icon" onclick="decrypt_data_model_values()">\
                                    <svg width="14" height="14" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <g clip-path="url(#clip0_1_6011)">
                                        <path d="M7.65645 3.68002C8.17269 3.55918 8.70124 3.49877 9.23145 3.50002C14.4814 3.50002 17.4814 9.50002 17.4814 9.50002C17.0262 10.3517 16.4832 11.1536 15.8614 11.8925M10.8214 11.09C10.6155 11.3111 10.3671 11.4884 10.0911 11.6114C9.81506 11.7343 9.51712 11.8005 9.21501 11.8058C8.9129 11.8111 8.61282 11.7555 8.33265 11.6424C8.05249 11.5292 7.79799 11.3608 7.58433 11.1471C7.37067 10.9335 7.20224 10.679 7.08908 10.3988C6.97591 10.1186 6.92034 9.81856 6.92567 9.51645C6.931 9.21434 6.99713 8.9164 7.1201 8.6404C7.24308 8.36441 7.42039 8.11601 7.64145 7.91002M13.6864 13.955C12.4044 14.9323 10.8433 15.4737 9.23145 15.5C3.98145 15.5 0.981445 9.50002 0.981445 9.50002C1.91436 7.76144 3.2083 6.24247 4.77645 5.04502L13.6864 13.955Z" stroke="#4D4D4D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M0.981445 1.25L17.4814 17.75" stroke="#4D4D4D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                        </g>
                                        <defs>
                                        <clipPath id="clip0_1_6011">
                                        <rect width="18" height="18" fill="white" transform="translate(0.231445 0.5)"/>
                                        </clipPath>
                                        </defs>
                                    </svg>
                                   </button>`;

}

// Form Assist Page Javascript Start

$('.easychat_form_assist_select_intent_dropdown').select2().on('select2:open', function (e) {
    $('.select2-search__field').attr('placeholder', 'Search Intent');
});
$(".modal-trigger").click(function () {
    $("#form_assist_add_new_tag_modal").removeAttr("tabindex");
});

$(".form-assist-add-tag-input").on('change keydown paste input', function () {

    var empty = false;

    $('.form-assist-add-tag-input').each(function () {
        if ($(this).val() == '' || $(this).val() == null) {
            empty = true;
        }
    });

    if (empty) {
        document.getElementById('form-assist-tag-save-btn').style.pointerEvents = "none";
        document.getElementById('form-assist-tag-save-btn').style.opacity = "0.5";
    } else {
        document.getElementById('form-assist-tag-save-btn').style.pointerEvents = "auto";
        document.getElementById('form-assist-tag-save-btn').style.opacity = "1";
    }
});

function open_form_assist_edit_tag_modal(form_assist_id) {
    $("#edit-new-tag-modal-" + form_assist_id).removeAttr("tabindex");
    $("#edit-new-tag-modal-" + form_assist_id).modal('open');
}

$(".form-assist-edit-tag-input").on('change keydown paste input', function (e) {

    var form_assist_id = this.getAttribute('form_assist');
    var form_assist_tag_id = document.getElementById("form-assist-tag-id-" + form_assist_id).value;
    var form_assist_intent = $("#form-assist-intent-" + form_assist_id).val();
    var form_assist_popup_timer = document.getElementById("form-assist-popup-timer-" + form_assist_id).value;

    var empty = true;
    if (form_assist_tag_id && form_assist_intent && form_assist_popup_timer)
        empty = false;

    if (empty) {
        document.getElementById('form-assist-edit-tag-save-btn-' + form_assist_id).style.pointerEvents = "none";
        document.getElementById('form-assist-edit-tag-save-btn-' + form_assist_id).style.opacity = "0.5";
    } else {
        document.getElementById('form-assist-edit-tag-save-btn-' + form_assist_id).style.pointerEvents = "auto";
        document.getElementById('form-assist-edit-tag-save-btn-' + form_assist_id).style.opacity = "1";
    }

});

// Form Assist Page Javascript End

function upload_rcs_credentials_file() {

    var input_uploaded_files = ($("#drag-drop-input-box-rcs"))[0].files;
    bot_id = (get_url_vars()["id"])
    if (input_uploaded_files.length == 0) {
        M.toast({
            "html": "Please select a file to upload."
        }, 2000);
        return;
    }


    var formData = new FormData();
    formData.append("file", input_uploaded_files[0]);
    formData.append("bot_id", bot_id)

    $.ajax({
        url: "/chat/upload-rcs-credential-file/",
        type: "POST",
        data: formData,
        processData: false,
        contentType: false,
        success: function (response) {
            // $("#easychat-drive-files-preloader").hide();
            if (response["status"] == 200) {
                $("#modal-upload-rcs-credential-file").modal('close');
                M.toast({
                    "html": "File Uploaded Successfully!"
                }, 2000);
                document.getElementById('rcs_api_credential_file_path').value = response["filename"]
            } else if (response["status"] == 300) {
                M.toast({
                    "html": "Unable to upload files. File format not supported. Please do not use .(dot) in filename except for extension."
                }, 2000);
                $(".drag-drop-message-rcs").show();
                $("#file-selected-filename-rcs").html("");
                $("#drag-drop-input-box-rcs").val("");
                document.getElementById("drag_drop_message").style.display = "flex";
                msg_ele = document.getElementById("drag_drop_message_1");
                if (msg_ele) {
                    msg_ele.style.display = "none"
                }
                document.getElementById("error-message-rcs-json").style.display = "none";
                document.getElementById("error-message-rcs-json_1").style.display = "block";
            } else {
                M.toast({
                    "html": "Unable to upload the files!"
                }, 2000);
                $(".drag-drop-message-rcs").show();
                $("#file-selected-filename-rcs").html("");
                $("#drag-drop-input-box-rcs").val("");
                document.getElementById("drag_drop_message").style.display = "flex";
                msg_ele = document.getElementById("drag_drop_message_1");
                if (msg_ele) {
                    msg_ele.style.display = "none"
                }
            }
        },
        error: function (xhr, textstatus, errorthrown) {
            M.toast({
                "html": "Unable to upload the files! Please check your internet"
            }, 2000);
            console.log("Please report this error: " + errorthrown + xhr.status + xhr.responseText);

        }
    });

}

// Dynamic Form Widget JS Start

function sync_preview() {
    $(document).ready(function () {

        $('.easychat-form-widget-dropdown-wrapper').select2({
            dropdownParent: $('#modal-create-form')
        });

    });
    let form_name = $('#form_name').val();

    if (form_name == "") {
        showToast("Form name cannot be empty.", 2000);
        return;
    }

    $('#sync_preview_modal').html('');

    const data = get_built_form_info(true);

    if (!data) return;

    const sync_required = data.need_to_save;


    if (!sync_required) return;

    const form = data.form;

    state.form = { ...form };

    const field_ids = form.field_order;

    let form_name_div = `<div class="preview-form-name-div">${form_name}</div>`;
    $('#sync_preview_modal').append(form_name_div);

    field_ids.forEach(field_id => {
        const field = form[field_id];
        var current_id = field_id.split('-')[1]
        const html = get_field_html_based_input_type(field, current_id);

        $('#sync_preview_modal').append(html);

        initialize_phone_number_selector_console("telephone-preview-" + current_id, field.country_code, current_id)
        $('.easychat-form-widget-dropdown-wrapper').select2().on('select2:open', function (e) {
            $('.select2-search__field').attr('placeholder', 'Search here');
        });
    })
}

function get_field_html_based_input_type(field, id) {
    if (field.type == 'text_field') {
        return get_text_field_html(field, id);
    }
    else if (field.type == 'radio') {
        return get_radio_button_html(field, id);
    }
    else if (field.type == 'checkbox') {
        return get_checkbox_html(field, id);
    }
    else if (field.type == 'date_picker' || field.type == 'time_picker') {
        return get_date_field_html(field, id);
    }
    else if (field.type == 'file_attach') {
        return get_file_attach_field_html(field, id);
    }
    else if (field.type == 'dropdown_list') {
        return get_dropdown_html(field, id);
    }
    else if (field.type == 'range') {
        return get_range_html(field, id);
    }
    else if (field.type == 'phone_number') {
        return get_phone_number_field_html(field, id);
    }

}

function get_text_field_html(field, id) {

    let html = `
    <div class="form-preview-input-type-wrapper">
    <label>${field.label_name}`;

    if (!field.optional) {
        html += `
        <span style="color: red;">*</span>
        `
    }

    html += `</label>
    <div class="form-preview-input-type-text-content">
            <input type="text" id="field-${id}"placeholder="${field.placeholder}" readonly>
    </div>`;

    return html;
}

function get_radio_button_html(field, id) {
    let html = `
    <div class="form-preview-input-type-wrapper">
    <label>${field.label_name}`;

    if (!field.optional) {
        html += `
        <span style="color: red;">*</span></label>
        `
    }
    html += `<div class="form-preview-input-type-radio-content">`
    if (field.options.length == 0 && api_integrated_fields.includes(id)) {
        html += `<p>This is a dynamic field and options will be fetched dynamically from API</p>`
    }
    Array.from(field.options).forEach(option => {
        html += `
        <div class="form-preview-input-type-radio-item">
            <div class="widget-indigator-icon" style="height: 20px;">
                <svg width="24" height="25" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M5 12C5 8.136 8.136 5 12 5C15.864 5 19 8.136 19 12C19 15.864 15.864 19 12 19C8.136 19 5 15.864 5 12ZM6.39959 12C6.39959 15.094 8.90559 17.6 11.9996 17.6C15.0936 17.6 17.5996 15.094 17.5996 12C17.5996 8.90597 15.0936 6.39997 11.9996 6.39997C8.90559 6.39997 6.39959 8.90597 6.39959 12Z" fill="#C4C4C4"></path>
                    </svg>
            </div>
            <div class="form-preview-radio-item-value">${option}</div>
        </div>`
    })

    html += `</div>`;

    return html;
}

function get_checkbox_html(field, id) {
    let html = `
    <div class="form-preview-input-type-wrapper">
    <label>${field.label_name}`;

    if (!field.optional) {
        html += `
        <span style="color: red;">*</span></label>
        `
    }
    html += `<div class="form-preview-input-type-checkbox-content">`
    if (field.options.length == 0 && api_integrated_fields.includes(id)) {
        html += `<p>This is a dynamic field and options will be fetched dynamically from API</p>`
    }
    Array.from(field.options).forEach(option => {
        html += `
        <div class="form-preview-input-type-checkbox-item">
            <div class="widget-indigator-icon" style="height: 20px;">
                <svg width="19" height="19" viewBox="0 0 19 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill-rule="evenodd" clip-rule="evenodd" d="M4.25 2.75H14.75C15.575 2.75 16.25 3.425 16.25 4.25V14.75C16.25 15.575 15.575 16.25 14.75 16.25H4.25C3.425 16.25 2.75 15.575 2.75 14.75V4.25C2.75 3.425 3.425 2.75 4.25 2.75ZM5 14.75H14C14.4125 14.75 14.75 14.4125 14.75 14V5C14.75 4.5875 14.4125 4.25 14 4.25H5C4.5875 4.25 4.25 4.5875 4.25 5V14C4.25 14.4125 4.5875 14.75 5 14.75Z" fill="#C4C4C4"></path>
                </svg>
            </div>
            <div class="form-preview-checkbox-item-value">${option}</div>
        </div>`
    })

    html += `</div>`;

    return html;
}

function get_date_field_html(field, id) {
    let html = `
    <div class="form-preview-input-type-wrapper">
    <label>${field.label_name}`;

    if (!field.optional) {
        html += `
        <span style="color: red;">*</span>
        `
    }
    if (field.calendar_type == 'Custom Type') {
        html += `<div class="form-preview-input-type-date-picker-content ">
                    <svg width="245" height="202" viewBox="0 0 245 202" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g filter="url(#filter0_d_1_15)">
                        <rect x="14" y="14" width="217" height="174" rx="12" fill="white"/>
                        </g>
                        <path d="M102.9 78.5H104.034V74.118H108.192V73.096H104.034V69.736H108.486V68.7H102.9V78.5ZM110.444 78.5H111.55V74.748C111.55 73.362 112.292 72.326 113.622 72.326H114.224V71.22H113.608C112.544 71.22 111.83 71.962 111.62 72.578H111.536V71.22H110.444V78.5ZM119.01 78.682C121.194 78.682 122.818 77.044 122.818 74.86C122.818 72.676 121.222 71.038 119.024 71.038C116.854 71.038 115.216 72.662 115.216 74.86C115.216 77.072 116.826 78.682 119.01 78.682ZM119.01 77.674C117.456 77.674 116.35 76.498 116.35 74.86C116.35 73.264 117.442 72.046 119.01 72.046C120.578 72.046 121.684 73.25 121.684 74.86C121.684 76.484 120.578 77.674 119.01 77.674ZM124.772 78.5H125.878V74.118C125.878 72.886 126.746 72.074 127.768 72.074C128.79 72.074 129.574 72.774 129.574 73.936V78.5H130.68V74.16C130.68 72.802 131.576 72.074 132.598 72.074C133.676 72.074 134.362 72.774 134.362 74.146V78.5H135.468V73.782C135.468 72.186 134.418 71.038 132.794 71.038C131.772 71.038 130.974 71.43 130.484 72.368H130.386C129.98 71.57 129.182 71.038 128.09 71.038C127.012 71.038 126.312 71.598 125.962 72.27H125.878V71.22H124.772V78.5ZM141.906 78.5H144.818C147.926 78.5 149.732 76.638 149.732 73.6C149.732 70.744 147.926 68.7 144.818 68.7H141.906V78.5ZM143.04 77.492V69.722H144.818C147.17 69.722 148.57 71.234 148.57 73.6C148.57 76.064 147.142 77.492 144.818 77.492H143.04ZM154.758 78.682C156.34 78.682 157.096 77.618 157.278 77.352H157.362V78.5H158.426V71.22H157.32V72.396H157.236C157.012 72.018 156.2 71.038 154.674 71.038C152.616 71.038 151.132 72.634 151.132 74.874C151.132 77.1 152.616 78.682 154.758 78.682ZM154.828 77.688C153.302 77.688 152.266 76.582 152.266 74.874C152.266 73.222 153.302 72.046 154.8 72.046C156.242 72.046 157.362 73.082 157.362 74.874C157.362 76.4 156.41 77.688 154.828 77.688ZM163.653 78.5H164.731V77.534H163.723C162.883 77.534 162.589 77.072 162.589 76.288V72.158H164.829V71.22H162.589V69.106H161.553V70.856C161.553 71.094 161.399 71.22 161.203 71.22H160.111V72.158H161.483V76.302C161.483 77.772 162.309 78.5 163.653 78.5ZM169.865 78.682C171.573 78.682 172.847 77.716 173.253 76.358H172.105C171.769 77.212 170.845 77.674 169.879 77.674C168.381 77.674 167.443 76.708 167.387 75.252H173.323V74.762C173.323 72.662 172.007 71.038 169.795 71.038C167.807 71.038 166.225 72.536 166.225 74.86C166.225 77.044 167.639 78.682 169.865 78.682ZM167.415 74.272C167.527 72.928 168.577 72.046 169.795 72.046C171.027 72.046 172.049 72.816 172.147 74.272H167.415Z" fill="#0254D7"/>
                        <rect x="79" y="60.5" width="118" height="26" rx="3.5" stroke="#0254D7"/>
                        <path d="M48.536 48V38.2H54.5V39.166H49.712V42.61H53.786V43.562H49.712V48H48.536ZM55.9445 48V41.056H57.0085L57.1065 42.386C57.3212 41.9287 57.6478 41.5647 58.0865 41.294C58.5252 41.0233 59.0665 40.888 59.7105 40.888V42.12H59.3885C58.9778 42.12 58.5998 42.1947 58.2545 42.344C57.9092 42.484 57.6338 42.7267 57.4285 43.072C57.2232 43.4173 57.1205 43.8933 57.1205 44.5V48H55.9445ZM63.9347 48.168C63.2814 48.168 62.6934 48.0187 62.1707 47.72C61.648 47.4213 61.2327 47.0013 60.9247 46.46C60.626 45.9093 60.4767 45.2653 60.4767 44.528C60.4767 43.7907 60.6307 43.1513 60.9387 42.61C61.2467 42.0593 61.662 41.6347 62.1847 41.336C62.7167 41.0373 63.3094 40.888 63.9627 40.888C64.616 40.888 65.204 41.0373 65.7267 41.336C66.2494 41.6347 66.66 42.0593 66.9587 42.61C67.2667 43.1513 67.4207 43.7907 67.4207 44.528C67.4207 45.2653 67.2667 45.9093 66.9587 46.46C66.6507 47.0013 66.2307 47.4213 65.6987 47.72C65.176 48.0187 64.588 48.168 63.9347 48.168ZM63.9347 47.16C64.336 47.16 64.7094 47.062 65.0547 46.866C65.4 46.67 65.68 46.376 65.8947 45.984C66.1094 45.592 66.2167 45.1067 66.2167 44.528C66.2167 43.9493 66.1094 43.464 65.8947 43.072C65.6894 42.68 65.414 42.386 65.0687 42.19C64.7234 41.994 64.3547 41.896 63.9627 41.896C63.5614 41.896 63.188 41.994 62.8427 42.19C62.4974 42.386 62.2174 42.68 62.0027 43.072C61.788 43.464 61.6807 43.9493 61.6807 44.528C61.6807 45.1067 61.788 45.592 62.0027 45.984C62.2174 46.376 62.4927 46.67 62.8287 46.866C63.174 47.062 63.5427 47.16 63.9347 47.16ZM69.0558 48V41.056H70.1198L70.2038 42.064C70.4278 41.6907 70.7265 41.4013 71.0998 41.196C71.4732 40.9907 71.8932 40.888 72.3598 40.888C72.9105 40.888 73.3818 41 73.7738 41.224C74.1752 41.448 74.4832 41.7887 74.6978 42.246C74.9405 41.826 75.2718 41.4947 75.6918 41.252C76.1212 41.0093 76.5832 40.888 77.0778 40.888C77.9085 40.888 78.5712 41.14 79.0658 41.644C79.5605 42.1387 79.8078 42.904 79.8078 43.94V48H78.6458V44.066C78.6458 43.3473 78.5012 42.806 78.2118 42.442C77.9225 42.078 77.5072 41.896 76.9658 41.896C76.4058 41.896 75.9392 42.1153 75.5658 42.554C75.2018 42.9833 75.0198 43.5993 75.0198 44.402V48H73.8438V44.066C73.8438 43.3473 73.6992 42.806 73.4098 42.442C73.1205 42.078 72.7052 41.896 72.1638 41.896C71.6132 41.896 71.1512 42.1153 70.7778 42.554C70.4138 42.9833 70.2318 43.5993 70.2318 44.402V48H69.0558Z" fill="#7B7A7B"/>
                        <line x1="29" y1="104.5" x2="216" y2="104.5" stroke="#EBEBEB"/>
                        <path d="M55.332 137V128.166H52.406V127.2H59.434V128.166H56.508V137H55.332ZM62.7062 137.168C62.0528 137.168 61.4648 137.019 60.9422 136.72C60.4195 136.421 60.0042 136.001 59.6962 135.46C59.3975 134.909 59.2482 134.265 59.2482 133.528C59.2482 132.791 59.4022 132.151 59.7102 131.61C60.0182 131.059 60.4335 130.635 60.9562 130.336C61.4882 130.037 62.0808 129.888 62.7342 129.888C63.3875 129.888 63.9755 130.037 64.4982 130.336C65.0208 130.635 65.4315 131.059 65.7302 131.61C66.0382 132.151 66.1922 132.791 66.1922 133.528C66.1922 134.265 66.0382 134.909 65.7302 135.46C65.4222 136.001 65.0022 136.421 64.4702 136.72C63.9475 137.019 63.3595 137.168 62.7062 137.168ZM62.7062 136.16C63.1075 136.16 63.4808 136.062 63.8262 135.866C64.1715 135.67 64.4515 135.376 64.6662 134.984C64.8808 134.592 64.9882 134.107 64.9882 133.528C64.9882 132.949 64.8808 132.464 64.6662 132.072C64.4608 131.68 64.1855 131.386 63.8402 131.19C63.4948 130.994 63.1262 130.896 62.7342 130.896C62.3328 130.896 61.9595 130.994 61.6142 131.19C61.2688 131.386 60.9888 131.68 60.7742 132.072C60.5595 132.464 60.4522 132.949 60.4522 133.528C60.4522 134.107 60.5595 134.592 60.7742 134.984C60.9888 135.376 61.2642 135.67 61.6002 135.866C61.9455 136.062 62.3142 136.16 62.7062 136.16Z" fill="#7B7A7B"/>
                        <path d="M109.916 159.5H111.05V150.736H114.046V149.7H106.92V150.736H109.916V159.5ZM117.707 159.682C119.891 159.682 121.515 158.044 121.515 155.86C121.515 153.676 119.919 152.038 117.721 152.038C115.551 152.038 113.913 153.662 113.913 155.86C113.913 158.072 115.523 159.682 117.707 159.682ZM117.707 158.674C116.153 158.674 115.047 157.498 115.047 155.86C115.047 154.264 116.139 153.046 117.707 153.046C119.275 153.046 120.381 154.25 120.381 155.86C120.381 157.484 119.275 158.674 117.707 158.674ZM127.533 159.5H130.445C133.553 159.5 135.359 157.638 135.359 154.6C135.359 151.744 133.553 149.7 130.445 149.7H127.533V159.5ZM128.667 158.492V150.722H130.445C132.797 150.722 134.197 152.234 134.197 154.6C134.197 157.064 132.769 158.492 130.445 158.492H128.667ZM140.385 159.682C141.967 159.682 142.723 158.618 142.905 158.352H142.989V159.5H144.053V152.22H142.947V153.396H142.863C142.639 153.018 141.827 152.038 140.301 152.038C138.243 152.038 136.759 153.634 136.759 155.874C136.759 158.1 138.243 159.682 140.385 159.682ZM140.455 158.688C138.929 158.688 137.893 157.582 137.893 155.874C137.893 154.222 138.929 153.046 140.427 153.046C141.869 153.046 142.989 154.082 142.989 155.874C142.989 157.4 142.037 158.688 140.455 158.688ZM149.28 159.5H150.358V158.534H149.35C148.51 158.534 148.216 158.072 148.216 157.288V153.158H150.456V152.22H148.216V150.106H147.18V151.856C147.18 152.094 147.026 152.22 146.83 152.22H145.738V153.158H147.11V157.302C147.11 158.772 147.936 159.5 149.28 159.5ZM155.492 159.682C157.2 159.682 158.474 158.716 158.88 157.358H157.732C157.396 158.212 156.472 158.674 155.506 158.674C154.008 158.674 153.07 157.708 153.014 156.252H158.95V155.762C158.95 153.662 157.634 152.038 155.422 152.038C153.434 152.038 151.852 153.536 151.852 155.86C151.852 158.044 153.266 159.682 155.492 159.682ZM153.042 155.272C153.154 153.928 154.204 153.046 155.422 153.046C156.654 153.046 157.676 153.816 157.774 155.272H153.042Z" fill="#0254D7"/>
                        <rect x="74.5" y="141.5" width="118" height="26" rx="3.5" stroke="#0254D7"/>
                        <defs>
                        <filter id="filter0_d_1_15" x="0" y="0" width="245" height="202" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                        <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                        <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                        <feOffset/>
                        <feGaussianBlur stdDeviation="7"/>
                        <feComposite in2="hardAlpha" operator="out"/>
                        <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.05 0"/>
                        <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_1_15"/>
                        <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_1_15" result="shape"/>
                        </filter>
                        </defs>
                    </svg>
                </div>`
    } else {
        html += `<div class="form-preview-input-type-date-picker-content ">
                    <svg width="245" height="91" viewBox="0 0 245 91" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g filter="url(#filter0_d_1_7)">
                        <rect x="14" y="14" width="217" height="63" rx="12" fill="white"/>
                        </g>
                        <path d="M90.28 50.5H91.47L92.352 48.176H97.084L97.966 50.5H99.156L95.39 40.7H94.06L90.28 50.5ZM92.744 47.14L94.676 42.016H94.76L96.692 47.14H92.744ZM103.623 50.682C105.205 50.682 105.961 49.618 106.143 49.352H106.227V50.5H107.291V40H106.185V44.396H106.101C105.877 44.018 105.065 43.038 103.539 43.038C101.481 43.038 99.9969 44.634 99.9969 46.874C99.9969 49.1 101.481 50.682 103.623 50.682ZM103.693 49.688C102.167 49.688 101.131 48.582 101.131 46.874C101.131 45.222 102.167 44.046 103.665 44.046C105.107 44.046 106.227 45.082 106.227 46.874C106.227 48.4 105.275 49.688 103.693 49.688ZM112.742 50.682C114.324 50.682 115.08 49.618 115.262 49.352H115.346V50.5H116.41V40H115.304V44.396H115.22C114.996 44.018 114.184 43.038 112.658 43.038C110.6 43.038 109.116 44.634 109.116 46.874C109.116 49.1 110.6 50.682 112.742 50.682ZM112.812 49.688C111.286 49.688 110.25 48.582 110.25 46.874C110.25 45.222 111.286 44.046 112.784 44.046C114.226 44.046 115.346 45.082 115.346 46.874C115.346 48.4 114.394 49.688 112.812 49.688ZM122.859 50.5H125.771C128.879 50.5 130.685 48.638 130.685 45.6C130.685 42.744 128.879 40.7 125.771 40.7H122.859V50.5ZM123.993 49.492V41.722H125.771C128.123 41.722 129.523 43.234 129.523 45.6C129.523 48.064 128.095 49.492 125.771 49.492H123.993ZM135.711 50.682C137.293 50.682 138.049 49.618 138.231 49.352H138.315V50.5H139.379V43.22H138.273V44.396H138.189C137.965 44.018 137.153 43.038 135.627 43.038C133.569 43.038 132.085 44.634 132.085 46.874C132.085 49.1 133.569 50.682 135.711 50.682ZM135.781 49.688C134.255 49.688 133.219 48.582 133.219 46.874C133.219 45.222 134.255 44.046 135.753 44.046C137.195 44.046 138.315 45.082 138.315 46.874C138.315 48.4 137.363 49.688 135.781 49.688ZM144.606 50.5H145.684V49.534H144.676C143.836 49.534 143.542 49.072 143.542 48.288V44.158H145.782V43.22H143.542V41.106H142.506V42.856C142.506 43.094 142.352 43.22 142.156 43.22H141.064V44.158H142.436V48.302C142.436 49.772 143.262 50.5 144.606 50.5ZM150.819 50.682C152.527 50.682 153.801 49.716 154.207 48.358H153.059C152.723 49.212 151.799 49.674 150.833 49.674C149.335 49.674 148.397 48.708 148.341 47.252H154.277V46.762C154.277 44.662 152.961 43.038 150.749 43.038C148.761 43.038 147.179 44.536 147.179 46.86C147.179 49.044 148.593 50.682 150.819 50.682ZM148.369 46.272C148.481 44.928 149.531 44.046 150.749 44.046C151.981 44.046 153.003 44.816 153.101 46.272H148.369Z" fill="#0254D7"/>
                        <rect x="63.5" y="32.5" width="118" height="26" rx="3.5" stroke="#0254D7"/>
                        <defs>
                        <filter id="filter0_d_1_7" x="0" y="0" width="245" height="91" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
                        <feFlood flood-opacity="0" result="BackgroundImageFix"/>
                        <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
                        <feOffset/>
                        <feGaussianBlur stdDeviation="7"/>
                        <feComposite in2="hardAlpha" operator="out"/>
                        <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.05 0"/>
                        <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_1_7"/>
                        <feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_1_7" result="shape"/>
                        </filter>
                        </defs>
                    </svg>
                </div>`
    }

    html += `</div>`;

    return html;
}

function get_file_attach_field_html(field, id) {
    let html = `
    <div class="form-preview-input-type-wrapper">
    <label>${field.label_name}`;

    if (!field.optional) {
        html += `
        <span style="color: red;">*</span>
        `
    }

    html += `<div class="form-preview-input-type-file-attach-content ">
                <svg width="202" height="163" viewBox="0 0 202 163" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                    <rect x="0.5" y="0.5" width="201" height="161.102" rx="1.21463" fill="#F8F8F8"/>
                    <rect x="76.7617" y="27.3301" width="48.478" height="48.478" fill="url(#pattern0)"/>
                    <path d="M44.0983 95.752H45.9082C47.8398 95.752 48.9623 94.5947 48.9623 92.7065C48.9623 90.9315 47.8398 89.6611 45.9082 89.6611H44.0983V95.752ZM44.8031 95.1255V90.2963H45.9082C47.3699 90.2963 48.2401 91.236 48.2401 92.7065C48.2401 94.2379 47.3525 95.1255 45.9082 95.1255H44.8031ZM50.1803 95.752H50.8677V93.42C50.8677 92.5586 51.3288 91.9147 52.1555 91.9147H52.5296V91.2273H52.1468C51.4855 91.2273 51.0417 91.6885 50.9112 92.0714H50.859V91.2273H50.1803V95.752ZM55.3998 95.8651C56.383 95.8651 56.8529 95.2038 56.966 95.0385H57.0182V95.752H57.6795V91.2273H56.9921V91.9582H56.9399C56.8007 91.7233 56.296 91.1142 55.3476 91.1142C54.0685 91.1142 53.1462 92.1062 53.1462 93.4983C53.1462 94.8818 54.0685 95.8651 55.3998 95.8651ZM55.4433 95.2473C54.4949 95.2473 53.851 94.5599 53.851 93.4983C53.851 92.4716 54.4949 91.7407 55.4259 91.7407C56.3221 91.7407 57.0182 92.3846 57.0182 93.4983C57.0182 94.4468 56.4265 95.2473 55.4433 95.2473ZM61.1457 97.8663C62.5031 97.8663 63.3471 97.0832 63.3471 95.752V91.2273H62.6598V91.9582H62.6075C62.4683 91.7233 61.9637 91.1142 61.0152 91.1142C59.7362 91.1142 58.8138 92.1062 58.8138 93.4983C58.8138 94.8818 59.7362 95.8651 61.0674 95.8651C62.0507 95.8651 62.5205 95.2038 62.6337 95.0385H62.6859V95.752C62.6859 96.6743 62.2073 97.266 61.1457 97.266C60.4758 97.266 59.9537 96.9875 59.8319 96.4567H59.1793C59.3272 97.266 60.0407 97.8663 61.1457 97.8663ZM61.1109 95.2473C60.1625 95.2473 59.5186 94.5599 59.5186 93.4983C59.5186 92.4716 60.1625 91.7407 61.0935 91.7407C61.9898 91.7407 62.6859 92.3846 62.6859 93.4983C62.6859 94.4468 62.0942 95.2473 61.1109 95.2473ZM69.1738 95.8651C70.157 95.8651 70.6269 95.2038 70.74 95.0385H70.7922V95.752H71.4535V91.2273H70.7661V91.9582H70.7139C70.5747 91.7233 70.07 91.1142 69.1216 91.1142C67.8425 91.1142 66.9202 92.1062 66.9202 93.4983C66.9202 94.8818 67.8425 95.8651 69.1738 95.8651ZM69.2173 95.2473C68.2689 95.2473 67.625 94.5599 67.625 93.4983C67.625 92.4716 68.2689 91.7407 69.1999 91.7407C70.0961 91.7407 70.7922 92.3846 70.7922 93.4983C70.7922 94.4468 70.2005 95.2473 69.2173 95.2473ZM72.9359 95.752H73.6233V93.0546C73.6233 92.3063 74.1802 91.7581 74.8937 91.7581C75.5289 91.7581 76.0596 92.228 76.0596 92.9502V95.752H76.747V92.9067C76.747 91.906 76.1118 91.1142 75.059 91.1142C74.3542 91.1142 73.8669 91.4797 73.6755 91.8886H73.6233V91.2273H72.9359V95.752ZM80.1353 95.8651C81.1185 95.8651 81.5884 95.2038 81.7015 95.0385H81.7537V95.752H82.415V89.2261H81.7276V91.9582H81.6754C81.5361 91.7233 81.0315 91.1142 80.083 91.1142C78.804 91.1142 77.8816 92.1062 77.8816 93.4983C77.8816 94.8818 78.804 95.8651 80.1353 95.8651ZM80.1788 95.2473C79.2303 95.2473 78.5864 94.5599 78.5864 93.4983C78.5864 92.4716 79.2303 91.7407 80.1614 91.7407C81.0576 91.7407 81.7537 92.3846 81.7537 93.4983C81.7537 94.4468 81.162 95.2473 80.1788 95.2473ZM86.4231 95.752H88.5636C89.5903 95.752 90.443 95.1168 90.443 94.0204C90.443 93.159 89.8687 92.7239 89.4598 92.5847V92.5325C89.9471 92.2715 90.2342 91.819 90.2342 91.2186C90.2342 90.3311 89.5468 89.6611 88.3895 89.6611H86.4231V95.752ZM87.1192 92.2976V90.2876H88.3895C89.0421 90.2876 89.512 90.6705 89.512 91.2708C89.512 91.8886 89.0508 92.2976 88.3634 92.2976H87.1192ZM87.1192 95.1342V92.8893H88.3634C89.0682 92.8893 89.7121 93.2025 89.7121 94.003C89.7121 94.7861 89.164 95.1342 88.4418 95.1342H87.1192ZM91.6638 95.752H92.3512V93.42C92.3512 92.5586 92.8124 91.9147 93.639 91.9147H94.0132V91.2273H93.6303C92.969 91.2273 92.5253 91.6885 92.3947 92.0714H92.3425V91.2273H91.6638V95.752ZM96.9877 95.8651C98.3451 95.8651 99.3545 94.847 99.3545 93.4896C99.3545 92.1323 98.3625 91.1142 96.9964 91.1142C95.6478 91.1142 94.6297 92.1236 94.6297 93.4896C94.6297 94.8644 95.6304 95.8651 96.9877 95.8651ZM96.9877 95.2386C96.0219 95.2386 95.3345 94.5077 95.3345 93.4896C95.3345 92.4977 96.0132 91.7407 96.9877 91.7407C97.9623 91.7407 98.6497 92.489 98.6497 93.4896C98.6497 94.499 97.9623 95.2386 96.9877 95.2386ZM101.329 95.752H102.217L103.382 92.0801H103.435L104.592 95.752H105.479L106.898 91.2273H106.149L105.044 94.9688H104.992L103.8 91.2273H103.017L101.816 94.9688H101.764L100.668 91.2273H99.9194L101.329 95.752ZM109.314 95.8651C110.367 95.8651 111.071 95.2908 111.071 94.4381C111.071 92.5673 108.357 93.5245 108.357 92.3759C108.357 91.9843 108.722 91.7059 109.288 91.7059C109.888 91.7059 110.21 91.993 110.271 92.4194H110.932C110.863 91.6015 110.166 91.1142 109.331 91.1142C108.383 91.1142 107.695 91.6102 107.695 92.3759C107.695 94.1683 110.401 93.2025 110.401 94.4729C110.401 94.934 110.027 95.2647 109.349 95.2647C108.687 95.2647 108.304 94.9775 108.226 94.4381H107.556C107.634 95.2821 108.243 95.8651 109.314 95.8651ZM114.337 95.8651C115.398 95.8651 116.19 95.2647 116.443 94.4207H115.729C115.52 94.9514 114.946 95.2386 114.346 95.2386C113.415 95.2386 112.832 94.6382 112.797 93.7333H116.486V93.4287C116.486 92.1236 115.668 91.1142 114.293 91.1142C113.058 91.1142 112.075 92.0453 112.075 93.4896C112.075 94.847 112.953 95.8651 114.337 95.8651ZM112.814 93.1242C112.884 92.2889 113.536 91.7407 114.293 91.7407C115.059 91.7407 115.694 92.2193 115.755 93.1242H112.814ZM120.068 97.7532H120.538C121.278 97.7532 121.635 97.4052 121.869 96.7874L124.027 91.2273H123.253L121.843 95.0559H121.791L120.39 91.2273H119.625L121.46 95.9956L121.252 96.5438C121.104 96.9353 120.851 97.1267 120.408 97.1267H120.068V97.7532ZM126.915 95.8651C128.272 95.8651 129.282 94.847 129.282 93.4896C129.282 92.1323 128.29 91.1142 126.924 91.1142C125.575 91.1142 124.557 92.1236 124.557 93.4896C124.557 94.8644 125.558 95.8651 126.915 95.8651ZM126.915 95.2386C125.949 95.2386 125.262 94.5077 125.262 93.4896C125.262 92.4977 125.941 91.7407 126.915 91.7407C127.89 91.7407 128.577 92.489 128.577 93.4896C128.577 94.499 127.89 95.2386 126.915 95.2386ZM132.097 95.8651C132.802 95.8651 133.289 95.4996 133.481 95.0907H133.533V95.752H134.22V91.2273H133.533V93.9421C133.533 94.6904 132.976 95.2386 132.263 95.2386C131.627 95.2386 131.097 94.7687 131.097 94.0465V91.2273H130.409V94.0726C130.409 95.0733 131.044 95.8651 132.097 95.8651ZM135.697 95.752H136.384V93.42C136.384 92.5586 136.845 91.9147 137.672 91.9147H138.046V91.2273H137.663C137.002 91.2273 136.558 91.6885 136.427 92.0714H136.375V91.2273H135.697V95.752ZM141.95 95.752H142.637V91.8103H143.96V91.2273H142.637V90.6966C142.637 90.2093 142.881 89.8265 143.49 89.8265H143.925V89.2261H143.499C142.585 89.2261 141.95 89.7742 141.95 90.6879V91.2273H141.097V91.8103H141.95V95.752ZM145.494 90.4094C145.79 90.4094 145.998 90.1919 145.998 89.9048C145.998 89.6263 145.79 89.4088 145.494 89.4088C145.207 89.4088 144.998 89.6263 144.998 89.9048C144.998 90.1919 145.207 90.4094 145.494 90.4094ZM145.137 95.752H145.824V91.2273H145.137V95.752ZM148.2 95.752H148.531V95.1429H148.322C148.104 95.1429 147.991 95.0124 147.991 94.7861V89.2261H147.304V94.7861C147.304 95.4039 147.634 95.752 148.2 95.752ZM151.58 95.8651C152.642 95.8651 153.434 95.2647 153.686 94.4207H152.972C152.764 94.9514 152.189 95.2386 151.589 95.2386C150.658 95.2386 150.075 94.6382 150.04 93.7333H153.729V93.4287C153.729 92.1236 152.912 91.1142 151.537 91.1142C150.301 91.1142 149.318 92.0453 149.318 93.4896C149.318 94.847 150.197 95.8651 151.58 95.8651ZM150.058 93.1242C150.127 92.2889 150.78 91.7407 151.537 91.7407C152.302 91.7407 152.938 92.2193 152.999 93.1242H150.058ZM156.448 95.8651C157.501 95.8651 158.206 95.2908 158.206 94.4381C158.206 92.5673 155.491 93.5245 155.491 92.3759C155.491 91.9843 155.856 91.7059 156.422 91.7059C157.022 91.7059 157.344 91.993 157.405 92.4194H158.066C157.997 91.6015 157.301 91.1142 156.465 91.1142C155.517 91.1142 154.83 91.6102 154.83 92.3759C154.83 94.1683 157.536 93.2025 157.536 94.4729C157.536 94.934 157.161 95.2647 156.483 95.2647C155.821 95.2647 155.439 94.9775 155.36 94.4381H154.69C154.769 95.2821 155.378 95.8651 156.448 95.8651Z" fill="black"/>
                    <path d="M74.4187 115.427H75.1061V112.694H75.1583C75.2975 112.929 75.8022 113.538 76.7506 113.538C78.0297 113.538 78.952 112.546 78.952 111.154C78.952 109.771 78.0297 108.788 76.6984 108.788C75.7152 108.788 75.2453 109.449 75.1322 109.614H75.08V108.901H74.4187V115.427ZM76.6723 112.912C75.7761 112.912 75.08 112.268 75.08 111.154C75.08 110.206 75.6717 109.405 76.6549 109.405C77.6033 109.405 78.2472 110.093 78.2472 111.154C78.2472 112.181 77.6033 112.912 76.6723 112.912ZM82.0769 113.538C83.0601 113.538 83.53 112.877 83.6431 112.712H83.6953V113.425H84.3566V106.899H83.6692V109.632H83.617C83.4778 109.397 82.9731 108.788 82.0247 108.788C80.7456 108.788 79.8233 109.779 79.8233 111.172C79.8233 112.555 80.7456 113.538 82.0769 113.538ZM82.1204 112.921C81.172 112.921 80.5281 112.233 80.5281 111.172C80.5281 110.145 81.172 109.414 82.103 109.414C82.9992 109.414 83.6953 110.058 83.6953 111.172C83.6953 112.12 83.1036 112.921 82.1204 112.921ZM86.1696 113.425H86.857V109.484H88.1796V108.901H86.857V108.37C86.857 107.883 87.1007 107.5 87.7097 107.5H88.1448V106.899H87.7184C86.8048 106.899 86.1696 107.448 86.1696 108.361V108.901H85.3169V109.484H86.1696V113.425ZM88.7102 114.565H89.2149L89.6152 112.616H88.8582L88.7102 114.565ZM94.2781 108.083C94.5739 108.083 94.7828 107.865 94.7828 107.578C94.7828 107.3 94.5739 107.082 94.2781 107.082C93.991 107.082 93.7821 107.3 93.7821 107.578C93.7821 107.865 93.991 108.083 94.2781 108.083ZM92.7554 115.427H93.0773C93.991 115.427 94.6262 114.878 94.6262 113.965V108.901H93.9388V113.956C93.9388 114.443 93.6255 114.8 93.086 114.8H92.7554V115.427ZM96.2651 115.427H96.9525V112.694H97.0047C97.1439 112.929 97.6486 113.538 98.597 113.538C99.8761 113.538 100.798 112.546 100.798 111.154C100.798 109.771 99.8761 108.788 98.5448 108.788C97.5616 108.788 97.0917 109.449 96.9786 109.614H96.9264V108.901H96.2651V115.427ZM98.5187 112.912C97.6225 112.912 96.9264 112.268 96.9264 111.154C96.9264 110.206 97.5181 109.405 98.5013 109.405C99.4497 109.405 100.094 110.093 100.094 111.154C100.094 112.181 99.4497 112.912 98.5187 112.912ZM104.002 115.54C105.359 115.54 106.203 114.757 106.203 113.425V108.901H105.516V109.632H105.463C105.324 109.397 104.82 108.788 103.871 108.788C102.592 108.788 101.67 109.779 101.67 111.172C101.67 112.555 102.592 113.538 103.923 113.538C104.907 113.538 105.376 112.877 105.49 112.712H105.542V113.425C105.542 114.348 105.063 114.939 104.002 114.939C103.332 114.939 102.81 114.661 102.688 114.13H102.035C102.183 114.939 102.897 115.54 104.002 115.54ZM103.967 112.921C103.018 112.921 102.374 112.233 102.374 111.172C102.374 110.145 103.018 109.414 103.949 109.414C104.846 109.414 105.542 110.058 105.542 111.172C105.542 112.12 104.95 112.921 103.967 112.921ZM107.651 114.565H108.155L108.556 112.616H107.799L107.651 114.565ZM112.435 115.427H113.123V112.694H113.175C113.314 112.929 113.819 113.538 114.767 113.538C116.046 113.538 116.969 112.546 116.969 111.154C116.969 109.771 116.046 108.788 114.715 108.788C113.732 108.788 113.262 109.449 113.149 109.614H113.097V108.901H112.435V115.427ZM114.689 112.912C113.793 112.912 113.097 112.268 113.097 111.154C113.097 110.206 113.688 109.405 114.672 109.405C115.62 109.405 116.264 110.093 116.264 111.154C116.264 112.181 115.62 112.912 114.689 112.912ZM118.188 113.425H118.875V110.728C118.875 109.98 119.432 109.431 120.146 109.431C120.781 109.431 121.312 109.901 121.312 110.624V113.425H121.999V110.58C121.999 109.579 121.364 108.788 120.311 108.788C119.606 108.788 119.119 109.153 118.928 109.562H118.875V108.901H118.188V113.425ZM125.466 115.54C126.823 115.54 127.667 114.757 127.667 113.425V108.901H126.98V109.632H126.927C126.788 109.397 126.284 108.788 125.335 108.788C124.056 108.788 123.134 109.779 123.134 111.172C123.134 112.555 124.056 113.538 125.387 113.538C126.371 113.538 126.84 112.877 126.954 112.712H127.006V113.425C127.006 114.348 126.527 114.939 125.466 114.939C124.796 114.939 124.274 114.661 124.152 114.13H123.499C123.647 114.939 124.361 115.54 125.466 115.54ZM125.431 112.921C124.482 112.921 123.839 112.233 123.839 111.172C123.839 110.145 124.482 109.414 125.413 109.414C126.31 109.414 127.006 110.058 127.006 111.172C127.006 112.12 126.414 112.921 125.431 112.921Z" fill="#A8A8A8"/>
                    <path d="M44.281 131.099H44.9597V126.557H45.0119L47.0393 131.099H47.8398L49.6931 126.557H49.7453V131.099H50.424V125.008H49.6496L47.4656 130.324H47.4134L45.0554 125.008H44.281V131.099ZM53.985 131.212C54.9682 131.212 55.4381 130.55 55.5512 130.385H55.6034V131.099H56.2647V126.574H55.5773V127.305H55.5251C55.3859 127.07 54.8812 126.461 53.9328 126.461C52.6537 126.461 51.7314 127.453 51.7314 128.845C51.7314 130.229 52.6537 131.212 53.985 131.212ZM54.0285 130.594C53.0801 130.594 52.4362 129.907 52.4362 128.845C52.4362 127.818 53.0801 127.087 54.0111 127.087C54.9073 127.087 55.6034 127.731 55.6034 128.845C55.6034 129.793 55.0117 130.594 54.0285 130.594ZM57.1815 131.099H57.982L59.2263 129.263H59.3046L60.5663 131.099H61.3755L59.7397 128.775L61.2537 126.574H60.4445L59.3046 128.279H59.2524L58.1125 126.574H57.3033L58.8173 128.741L57.1815 131.099ZM62.787 131.212C63.0568 131.212 63.2743 130.994 63.2743 130.724C63.2743 130.455 63.0568 130.237 62.787 130.237C62.5173 130.237 62.2911 130.455 62.2911 130.724C62.2911 130.994 62.5173 131.212 62.787 131.212ZM67.5267 131.099H68.2141V127.157H69.5366V126.574H68.2141V126.043C68.2141 125.556 68.4577 125.173 69.0668 125.173H69.5018V124.573H69.0755C68.1619 124.573 67.5267 125.121 67.5267 126.035V126.574H66.674V127.157H67.5267V131.099ZM71.0706 125.756C71.3665 125.756 71.5753 125.539 71.5753 125.251C71.5753 124.973 71.3665 124.755 71.0706 124.755C70.7835 124.755 70.5747 124.973 70.5747 125.251C70.5747 125.539 70.7835 125.756 71.0706 125.756ZM70.7139 131.099H71.4013V126.574H70.7139V131.099ZM73.7769 131.099H74.1075V130.49H73.8987C73.6812 130.49 73.5681 130.359 73.5681 130.133V124.573H72.8807V130.133C72.8807 130.751 73.2113 131.099 73.7769 131.099ZM77.1572 131.212C78.2187 131.212 79.0105 130.611 79.2629 129.767H78.5494C78.3405 130.298 77.7663 130.585 77.1659 130.585C76.2348 130.585 75.6519 129.985 75.6171 129.08H79.3064V128.775C79.3064 127.47 78.4885 126.461 77.1137 126.461C75.8781 126.461 74.8949 127.392 74.8949 128.836C74.8949 130.194 75.7737 131.212 77.1572 131.212ZM75.6345 128.471C75.7041 127.636 76.3567 127.087 77.1137 127.087C77.8794 127.087 78.5146 127.566 78.5755 128.471H75.6345ZM84.4635 131.212C85.5164 131.212 86.2212 130.637 86.2212 129.785C86.2212 127.914 83.5064 128.871 83.5064 127.723C83.5064 127.331 83.8718 127.053 84.4374 127.053C85.0378 127.053 85.3597 127.34 85.4206 127.766H86.0819C86.0123 126.948 85.3162 126.461 84.4809 126.461C83.5325 126.461 82.8451 126.957 82.8451 127.723C82.8451 129.515 85.5512 128.549 85.5512 129.82C85.5512 130.281 85.177 130.611 84.4983 130.611C83.837 130.611 83.4542 130.324 83.3759 129.785H82.7059C82.7842 130.629 83.3933 131.212 84.4635 131.212ZM87.9292 125.756C88.225 125.756 88.4338 125.539 88.4338 125.251C88.4338 124.973 88.225 124.755 87.9292 124.755C87.642 124.755 87.4332 124.973 87.4332 125.251C87.4332 125.539 87.642 125.756 87.9292 125.756ZM87.5724 131.099H88.2598V126.574H87.5724V131.099ZM89.4782 131.099H92.9238V130.516H90.3135V130.463L92.8803 127.157V126.574H89.5565V127.157H92.045V127.209L89.4782 130.516V131.099ZM96.055 131.212C97.1166 131.212 97.9084 130.611 98.1607 129.767H97.4472C97.2384 130.298 96.6641 130.585 96.0637 130.585C95.1327 130.585 94.5497 129.985 94.5149 129.08H98.2042V128.775C98.2042 127.47 97.3863 126.461 96.0115 126.461C94.776 126.461 93.7927 127.392 93.7927 128.836C93.7927 130.194 94.6716 131.212 96.055 131.212ZM94.5323 128.471C94.6019 127.636 95.2545 127.087 96.0115 127.087C96.7772 127.087 97.4124 127.566 97.4733 128.471H94.5323ZM103.77 131.212C104.754 131.212 105.223 130.55 105.337 130.385H105.389V131.099H106.05V126.574H105.363V127.305H105.31C105.171 127.07 104.667 126.461 103.718 126.461C102.439 126.461 101.517 127.453 101.517 128.845C101.517 130.229 102.439 131.212 103.77 131.212ZM103.814 130.594C102.865 130.594 102.222 129.907 102.222 128.845C102.222 127.818 102.865 127.087 103.796 127.087C104.693 127.087 105.389 127.731 105.389 128.845C105.389 129.793 104.797 130.594 103.814 130.594ZM108.429 131.099H108.759V130.49H108.55C108.333 130.49 108.22 130.359 108.22 130.133V124.573H107.532V130.133C107.532 130.751 107.863 131.099 108.429 131.099ZM110.833 131.099H111.164V130.49H110.955C110.738 130.49 110.625 130.359 110.625 130.133V124.573H109.937V130.133C109.937 130.751 110.268 131.099 110.833 131.099ZM114.309 131.212C115.667 131.212 116.676 130.194 116.676 128.836C116.676 127.479 115.684 126.461 114.318 126.461C112.969 126.461 111.951 127.47 111.951 128.836C111.951 130.211 112.952 131.212 114.309 131.212ZM114.309 130.585C113.344 130.585 112.656 129.854 112.656 128.836C112.656 127.844 113.335 127.087 114.309 127.087C115.284 127.087 115.971 127.836 115.971 128.836C115.971 129.846 115.284 130.585 114.309 130.585ZM118.651 131.099H119.538L120.704 127.427H120.756L121.914 131.099H122.801L124.219 126.574H123.471L122.366 130.316H122.314L121.122 126.574H120.339L119.138 130.316H119.086L117.989 126.574H117.241L118.651 131.099ZM127.011 131.212C128.072 131.212 128.864 130.611 129.116 129.767H128.403C128.194 130.298 127.62 130.585 127.019 130.585C126.088 130.585 125.505 129.985 125.47 129.08H129.16V128.775C129.16 127.47 128.342 126.461 126.967 126.461C125.731 126.461 124.748 127.392 124.748 128.836C124.748 130.194 125.627 131.212 127.011 131.212ZM125.488 128.471C125.557 127.636 126.21 127.087 126.967 127.087C127.733 127.087 128.368 127.566 128.429 128.471H125.488ZM132.287 131.212C133.27 131.212 133.74 130.55 133.853 130.385H133.906V131.099H134.567V124.573H133.879V127.305H133.827C133.688 127.07 133.183 126.461 132.235 126.461C130.956 126.461 130.033 127.453 130.033 128.845C130.033 130.229 130.956 131.212 132.287 131.212ZM132.331 130.594C131.382 130.594 130.738 129.907 130.738 128.845C130.738 127.818 131.382 127.087 132.313 127.087C133.209 127.087 133.906 127.731 133.906 128.845C133.906 129.793 133.314 130.594 132.331 130.594ZM136.458 127.844C136.728 127.844 136.945 127.618 136.945 127.348C136.945 127.079 136.728 126.861 136.458 126.861C136.188 126.861 135.962 127.079 135.962 127.348C135.962 127.618 136.188 127.844 136.458 127.844ZM136.458 131.212C136.728 131.212 136.945 130.994 136.945 130.724C136.945 130.455 136.728 130.237 136.458 130.237C136.188 130.237 135.962 130.455 135.962 130.724C135.962 130.994 136.188 131.212 136.458 131.212ZM142.712 131.212C143.834 131.212 144.722 130.333 144.722 129.176C144.722 128.114 143.895 127.201 142.738 127.201C141.981 127.201 141.607 127.609 141.607 127.609H141.555L141.685 125.652H144.339V125.008H141.067L140.858 128.445H141.502C141.607 128.271 141.937 127.844 142.616 127.844C143.451 127.844 144.008 128.393 144.008 129.176C144.008 129.994 143.417 130.559 142.686 130.559C142.016 130.559 141.511 130.185 141.398 129.515H140.737C140.815 130.542 141.659 131.212 142.712 131.212ZM146.248 131.099H146.927V126.557H146.979L149.006 131.099H149.807L151.66 126.557H151.712V131.099H152.391V125.008H151.617L149.433 130.324H149.38L147.022 125.008H146.248V131.099ZM154.133 131.099H156.274C157.301 131.099 158.153 130.463 158.153 129.367C158.153 128.506 157.579 128.071 157.17 127.931V127.879C157.657 127.618 157.944 127.166 157.944 126.565C157.944 125.678 157.257 125.008 156.1 125.008H154.133V131.099ZM154.829 127.644V125.634H156.1C156.752 125.634 157.222 126.017 157.222 126.618C157.222 127.235 156.761 127.644 156.074 127.644H154.829ZM154.829 130.481V128.236H156.074C156.779 128.236 157.422 128.549 157.422 129.35C157.422 130.133 156.874 130.481 156.152 130.481H154.829Z" fill="#EE1A26"/>
                    <rect x="0.5" y="0.5" width="201" height="161.102" rx="2.21463" stroke="#0254D7" stroke-dasharray="8 8"/>
                    <defs>
                    <pattern id="pattern0" patternContentUnits="objectBoundingBox" width="1" height="1">
                    <use xlink:href="#image0_301_2574" transform="scale(0.00195312)">
                    </pattern>
                    <image id="image0_301_2574" width="512" height="512" xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAYAAAD0eNT6AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAOxAAADsQBlSsOGwAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAACAASURBVHic7d1rkFxnfefx39Onu6fnKll32VZsXWxJlrls4uDFgC3J9tpJ1oQFQgi7IUC2sikW2M0LMMtShMAmRZZsKLLspWIo2HJIsWQrgMOaYCyNjcFeiEmBQdaMJFsGgdHV1mVGM9N9+jz74misizWjnpnT5znPeb6fqi4blzX9p7vdz3fO1QiltP+wXWVN+xVJYjcaYzZK9lpJKyX1n3ksdjshyiqxkqyUSLJWShIpPvNoJ1IrkVrt9O8vpmJsksjERpqSNUcT2UkjHZP0nGSOGdljidWhSsUcUDv5sWztmW1bzMEc/y8CpWBcD4Bs7N1rezTYvrNS0e2ydpuMrnM9EzCbdiJNxWcfzViy8/9xk5KekbTLGP3QJuZHkY2fOLS55+k3GdPOaGSgVAgAz+0/2PynSVR5qxL7mzJa4noeYL4SK0220sfp1sxbCObotJG+Z6XHJPNoqxo9dscGcziTnwx4jgDwkLXW7D/avsvKfkBWN7qeB8iclSZiabwpnZ5a0JaBFzNmnxINS/q6aUQ7tq01x7P88YAvCADPPH0kfq219j9JeonrWYA8JFY63ZTGptJdBRmLJX1H0tcTJV+5bVPPE5k/A1BQBIAnRo/aK6pJ/AlJv+F6FsCVqVg6MSlNNLv1DPYZydxnjP5m67XVbxtjMt34ABQJAVBw1lrz9JHWeyTzJ5L6XM8DFMFULJ2YkCZaXXwSY/ZJ9t4oqn72lg3mQBefCXCCACiwp56zixTH94jf+oGLaral50+nBw52USLpG1bmM1NRdN+vXmOmuvpsQE4IgILaf7j58sToy7LmKtezAEU31pSOn87szIHZHJXRX1bb1U/dfJ35edefDegiAqCA9h5pba1YfVnSItezAL5IrHR8QhqbzPisgYtrGukrSuyfb7uu/v+6/3RA9giAgtl3KP4Xxti/ltRwPQvgo6lYOjqWXnkwD0YatlZ/tH1z7eF8nhHIBgFQIE8diX9N1n5ZUtX1LIDPrJWOjqenD+bo2zL6w+0baztyfVZgngiAgth/sHljUjE7lF6nH0AGTk1Jz4/nskvgXDsTqw/etrn2WL5PC8wNAVAATx+Z3GiT6FEu5Qtkr9WWDp/Kb5fAGdZa+79la++/9Trz41yfGegQAeDY/v22kfTHj0l6uetZgLJqJ9LhsfSGQzlrSvqf7Vr1Q7evNydyf3ZgFhXXA4Su3d/+r2LxB7oqqkgrB6VGLfenrkt6T9SKR4ZH4zfn/uzALNgC4NDTh+M3Wtm/cT0HEApHBwe+wEhfk43fuW1z7zNuJgDOIgAcGTliB2s23i3pCtezACGxSg8MPOXuen7jMvrQ0Wurn3yTMW1nUyB47AJwpGbjj4jFH8idkbSkXxqoOxuhX1b/Zdlo/OjDT05e42wKBI8tAA7s/fnUlkpU+b443x9wx6YHBnb1hkKXdtrIfmDbpvonnU6BIBEADjx1qPl5GfMW13MAobNWOnjKydkB5zFWX1Kl+nvbNpqjbidBSAiAnO05NLkuMtGo+O0fKIS2lQ6elGL3e+N/ahL7G9xbAHnhGICcVVW9Wyz+QGFERloxIFXc/zp0pa2YR4ZHWne7HgRhcP+RD8jBg7Z/vBIflDTgehYA5xubko6Nu55imv3r1lTt9+54mSnMRCgftgDkaMy03yAWf6CQBnqkfndnBlzAvKXWE3/74X12jetJUF4EQI5Mxf626xkAzGxJv1SLXE/xgpe14/g7wyPNG1wPgnIiAHJy4IRdIqttrucAMLOKkZYNqEg7R1dbmeEdu+O7XA+C8iEActKcbG+VVJzfLQBcVD2ShnpcT3GeAWPsl4ZHm//W9SAoFwIgJ9bw2z/gi0W9UrViXY9xrsha86kdI62PuR4E5UEA5MQYSwAAnqgY6bK+4uwHmGaku3eOtP7UWlu84eAdAiAHu6yty2qj6zkAdK6vLvXmf/vgTrzvodH2f/+wtXx/Y0H4AOWg/lxzg7j4D+CdJX0q0gGBL7Cyv3/zaPseIgALwYcnB5U42uR6BgBzV42k/mJuBZBk3/GaPe3PEAGYLz44OTCy61zPAGB+FvUWciOAJMlY+zYiAPPFhyYHidFi1zMAmJ9alB4PUFREAOaLD0wODJf/Bbw21Ot6gtkRAZgPPiy5MIOuJwAwf/WosGcEvMBY+7abR9ufJgLQKT4oebBJwX9/AHApgw3XE3TCvp0tAegUHxIA6EBvNb1AUNGxOwCd4gMCAJ0wRbpd8OyIAHSCDwcAdKjfi90AKSIAl8IHAwA61BOlpwX6ggjAbPhQAMAcFPmaABfD2QGYCR8IAJiDhpd39eDsALwYHwYAmIOeWnEvDTwbdgfgQnwQAGAOjNII8BERgHPxIQCAOfJzN0CKCMA0H7dk5W541C6zNt5orNlgK0m/sWbQGi2ytrOAWj2ku3qquq7bcwLIx1QsHTzpeoqFscZ87pFro9/9sDGJ61ngBgFwgfv32p4eG9+otrYbo62Srpe0dCE/c1m/1N+TyXgACsBa6cDx9K8+IwLCRgBIevxxWzvR375Txr7VSL8mKdNr9xMAQPk8e0JqtV1PsXBEQLiCDoAHRuzlNcV/YKXfkbS8W89DAADlc3RcGp9yPUVWzGe/uTH610RAWIIMgIdHJta2Vbtbsm+T1PWlmQAAyuf4hHRiwvUU2WFLQHiCCoBHD9jeibH4bmP0fuWw8E8jAIDyGZ9KtwKUCREQlmBOAxneHf/zyfHWk8boD5Xj4g+gnCKP7gnQKS4bHJbSv8n377U9O0dan7TG3ieZqx2PA6AkqqXdfsplg0NR6jd4eNfkhkY7flTSexTY7g4A3VUp8TcKFwsKQ2nf3AdHm79so+gxSb/oehYA5VOpqNS/VhAB5VfKN3Z4T+u2ijU7JC1zPQuA8irlF+g5iIByK92bunN3/Hqb6H5Jg65nAQDfEQHlVao3dHh3a6uM/bwkT+/VBcAnpsS7AM5FBJRTad7MB0emXmqNviSp4XoWAGEIZP2XxCmCZVSKN/Lvd9klFZn7JC12PQsAlBenCJaJ92+itdbUo/izkrnK9SwAUHbsDigP79/A4dH4vZJe63oOAAgFEVAOXr95Dz85eY2kj7ieAwBCQwT4z+s3rl2J/kJc1x8AnCAC/ObtmzY8Gr9Z0p2u5wCAkBEB/vLyDfuitZGVPup6DgAApwj6yss3a/lo+7dk7QbXcwAAptm3EwF+8e6NstYaK3u36zkAABciAnzi3Zv00Gh8h6TrXc8BALgYIsAX3r1B1ti3up4BADAbIsAHXr059++1Q7Lm113PAQC4FCKg6Lx6Y3rj1usl9bmeAwDQCSKgyLx6UxLpDtczAADmgggoKm/eEGutMcZsdT0HAGCuiIAi8ubNGH6yeZ2kVa7nAADMBxFQNN68EaZqXul6BgDAQhABReLNm5DIbHI9AwBgoYiAovDpDdjoegAAQBaIgCLw5sU3Vte6ngEAkBUiwDWfXngOAASAUiECXPLiRbfWGkn9rucAAGSNCHDFixf8gSfUJylyPQcAoBuIABe8eLGjigZczwAA6CYiIG9evNBJjd/+AaD8iIA88SIDAAqECMgLLzAAoGCIgDzw4gIACogI6DZeWABAQREB3cSLCgAoMCKgW3hBAQAFRwR0Ay8mAMADREDWeCEBAJ4gArLEiwgA8AgRkBVeQACAZ4iALPDiAQA8ZN9+82j7HiJg/njhAGCejHE9QejsO9gSMH+8aAAwT3yBFgG7A+aLFwwA5oktAEVBBMwHLxYAzFOFb9AC4ZiAueKFAoB5qvINWjAcEzAXvEgAME/1yPUEeLF0S4C1lh00l0AAAMA8VQmAgrLvGB5tf8r1FEVHAADAPNUiSfyeWVD2nTtHWn/qeooiIwAAYJ4qRurhW7TI3rdjpPVB10MUFR9dAFiARt31BJiNkT66Y3fz3a7nKCICAAAWoFFzPQEuxRjziZ0j8Wtdz1E0BAAALEAjkiK+SYsukuwXdu5p3uh6kCLhYwsAC2GkPnYD+KBXifnSjiftVa4HKQoCAAAWaIAA8MVqVeK/G95lB1wPUgQEAAAsUL2aPlB8RnpJUmnd43qOIiAAACADixquJ0CnjDFv3jHS/Peu53CNAACADPTVz1wYCF4wMh/fsad1s+s5XCIAACAji3tdT4A5qJpEX3jwh3al60FcIQAAICN9da4L4JnVlVr8v0K9cRABAAAZWtLH7QE8c8fO0dbvux7CBQIAADJUi6QhdgV4xcj82c6RyY2u58gbAQAAGVvckHo4LdAnfVL0V48/boPagUMAAEDWjLR8IL1bILxxw8n++L2uh8gTAQAAXRBVpGUD4oAAnxh9cHjX5AbXY+SFAACALumtScs4KNAnvTaK7gnlrAACAAC6qL9HWtznegrMwdaHRtpvdT1EHggAAOiyoYZ0GRHgDWvsnz3yhL3M9RzdRgAAQA6GGtJSjgnwxbK4Hn/I9RDdRgAAQE4G6tKKAanCN2/hWemdD+6evNb1HN3ExxAActRbk1YPcp0AD9QrJvq46yG6iQAAgJxVI2nl4JlbCLNLoMheu2Oktd31EN1CAACAA8akZwesHmJrQJEZ6T+X9bRAAgAAHKpH0qohaWm/VOUbuYh+aXhP+1dcD9ENfNwAoAAGeqTLF6dXD6xFrqfBeaz9SBm3AhAAAFAQRlJ/XVq9SFo5lF5EyJRu2fHSLw3vbf+q6yGyRgAAQMEYSY2qtKxfuvLMVoGBBlsGnEps6a4LQAAAQIFVTLpVYGmfdPmiNAiWD6RXFhzoSUOhHqXHD1Qq4qyC7nnFjj2tm10PkSWOPQUAj0QVqa/ueor5sZKsldqJlJz5a9yW4iR9NNvpPyusRH8g6Zuux8gKAQAAyIVRekxDZZZdGYmVpuJzHq00HIrASK/dsXdy/a3XNJ5yPUsW2AUAACiMikmvlri4N71Y0pol6V8HG+nWD+fjJdV/53qIrLh/OQEAmIGR1KhJS/qkKxZLKwbTeypUXB3rYO3bvzViBx09e6YIAACAF4zSrQNLB86eHdHIf0f2QMu0fjP3Z+0CAgAA4B1z5uyIlUPplRR78zww0pp35PhsXUMAAAC81lNNb7O8elG6e6Dbewes9MoH905d1+Wn6ToCAABQCvUo3T2welF63EA3maTi/VYAAgAAUCq1M7dbXtbfvTMHjNW//KK1Xl+bkQAAAJRSf0969cShhrqxX2DV8pH4NZn/1BwRAACA0qqY9LLJqwelasa/r1uZN2b7E/NFAAAASq9elS4/c4fFzBj7Bp93AxAAAIAgGJMeF7BsILMLCa1aujd+VSY/yQECAAAQlOnrB1QzWAFNW69b+E9xgwAAAASnHqUXEKov/EqCd2QwjhMEAAAgSFFFWjWYXl543oyu+8Yu+wuZDZUjAgAAECxjpOUDUt8CLiVcjVq3ZzdRfggAAEDQjEkPDBxozO/PJzJ3ZjtRPvK/jxJQIhMt6ecnpWNj0qkpabIlWddDoZCqlfQ69Yv70gPQlvalCw+KwSi95bBNpPHmnP/sNmutMcZ49Z8/AQDMkbXSgePS6CHp0Kn0fwOdOCxJx9K/76tL65dJm1Z2/7r16IxReppgYtO4n4OlD+1pbpQ00pXBuoQAAObg0Cnpu89IxydcTwLfnW5KP3xWevKgtGW1dP3lUsQWAffOHBNw8JTUjDv/Y9aam+RZAHAMANABa6V//In0wG4Wf2SrnUhP/Ez6vz+STvDZKgRjpBVzvHSwVeWV3ZuoOwgA4BLiRNq5R9p10PUkKLMTE9L9T0rPnnA9CaR0a8yKOVwx0Fh7U3cnyh4BAMwiSaSH9/KljHzEbWl4b3pgKdyrRemNhDpitPn+vXaoqwNljAAAZvHYfhZ/5CtJpG/uk8amXE8CSRroSc/e6ICpx/GWLo+TKQIAmMHTx9IHkLdmLD3yFGeYFMWS/nRrwKVUZF/S/WmyQwAAFzEVS4//2PUUCNnRMWnPEddTQDp7oSBd6niASuX6PObJCgEAXMTug2kEAC498bP0IFS4V4+kRT2z/zvGWgIA8FnbSqOHXU8BpFeW3H/U9RSYtqg3vYHQTKzEMQCAz376/NwuAAJ001MEQGEYc8mzAlZ8a8QO5jTOghEAwAV+etz1BMBZR8fZHVUk/fXZbx/cbDe9uTUwAQBc4PAp1xMAZ1nLZ7JoLuub5XjAWnR1jqMsCAEAnKM9jzuBAd12ctL1BDhXLZL6Zjgg0Njk6lyHWQACADjHRItzr1E8RGnxLGrMsBXAmqvznWT+CADgHJxyhSJqtV1PgAvVIqn3IlcItNauyH+a+SEAAKDguEtwMS3qvdg/NUvznmO+CADgHFX+i0ABzeW2tMhPPZIaF54RUBEBAPior56e6wsUycAlrkAHdwYveG+sJQAAL1UMX7YonqGG6wkwk95a+r0xzYgAALy10pvreCEExkgrBlxPgZkY86JTAr15twgA4AJXLnY9AXDWikGpXnU9BWYzcP7ZAHVrrRc7EgkA4AJXLJJ6+MJFQazzZoNyuHqq5x9A/LV9usgJgsVDAAAXqFSkzStdTwGk+5fXLnM9BTrRd/6S78WRRAQAcBGbVs1+ww8gDy+/Uoq82JiMc08HXGa0yN0knSMAgIuoRdIvX+V6CoRs5aC0nt/+vdFTPXsKca3hx5kABAAwg6uWSNd4c1FPlElPVXr1eq5J4ZOKkXrOXLDJGD8u3kgAALO48SrpCs4KQI6qFWn7tS/apwwP9Hi225AAAGZhjLT1mnRrANBt9ap060ZpmTdnkuNcDc/OHvJsXCB/FSO9Zr20uFd64lluF4zuWNov3byBK1H6rKfm142bCACgA8ZIL70ivUjQd5+Rjoy7nghlUYukl14ubV7FPn/fGfl14yYCAJiDJf3SnVukZ09Iew5LPz3OFgHMz1AjPcr/2hVc6a9MagQAUG6XL0ofzVg6dEo6Oi6dnJCm2lKr7Xo6FE3FpLeOHeiRFvdJqwZnupc8fEcAAIGoV6U1l6UPAIg8OrTeo1EBACg2n7YAEAAAAGTEp0s3EwAAAGSkQgAAABCeyEg1Ky/ODSIAAADIipGm2mq6HqMTBAAAABnqqRAAAAAEpxERAAAABKdWU+x6hk4QAAAABIgAAAAgQAQAAAABIgAAAAgQAQAAQIAIAAAAAkQAAAAQIAIAAIAAEQAAAASIAAAAIEAEAAAAASIAAAAIEAEAAECACAAAAAJEAAAAEKCq6wEA+C9JpGOnpaNj0qlJaTKWmrEUVaR6JA00pMW90opBqbfmeloAEgEAYAEOnpT2HZUOPC/F7c7+zNIBae0SacNyqRZ1dz4AMyMAAMzZwZPS9w5Iz43P/c8eG0sfP/iZtGmVdP1qqcrOSCB3BACAjrXa0neekfYfy+Zn/fBn0tNHpZvWSquGFv4zAXSO7gbQkeMT0ld/lM3if67xKenB0TQGAOSHLQAALunImLRzT3pgXzdYK33/Z9J4S7rxKsmY7jwPgLPYAgBgVkfG0t/Qu7X4n2vvYelbT6dBAKC7CAAAM5pe/Ds9wj8LzxwjAoA8EAAALsrF4j+NCAC6jwAA8CIuF/9pRADQXQQAgPMUYfGfRgQA3UMAAHhBkRb/aUQA0B0EAABJxVz8pxEBQPYIAACFXvynEQFAtggAIHA+LP7TiAAgOwQAEDCfFv9pRACQDQIACJSPi/80IgBYOAIACJDPi/80IgBYGAIACEwZFv9pRAAwfwQAEJAyLf7TiABgfggAIBBlXPynEQHA3BEAQADKvPhPIwKAuSEAgJILYfGfRgQAnSMAgBILafGfRgQAnSEAgJIKcfGfRgQAl0YAACUU8uI/jQgAZkcAACXD4n8WEQDMjAAASoTF/8WIAODiCACgJFj8Z0YEAC9GAAAlwOJ/aUQAcD4CAPAci3/niADgLAIA8BiL/9wRAUCKAAA8xeI/f0QAQAAAXmLxXzgiAKEjAADPsPhnhwhAyAgAwCMs/tkjAhAqAgDwBIt/9xABCBEBAHiAxb/7iACEhgAACo7FPz9EAEJCAAAFxuKfPyIAoSAAgIJi8XeHCEAICACggFj83SMCUHYEAFAwLP7FQQSgzAgAoEBY/IuHCEBZEQBAQbD4FxcRgDIiAIACYPEvPiIAZUMAAI6x+PuDCECZEACAQyz+/iECUBYEAOAIi7+/iACUAQEAOMDi7z8iAL4jAICcsfiXBxEAnxEAQI5Y/MuHCICvCAAgJyz+5UUEwEcEAJADFv/yIwLgGwIA6DIW/3AQAfAJAQB0EYt/eIgA+IIAALqExT9cRAB8QAAAXcDiDyIARUcAABlj8cc0IgBFRgAAGWLxx4WIABQVAQBk5PiEtIPFHxfxzDHp8Z+4ngI4HwEAZKBtpYf2Si0Wf8xg5JD0k+ddTwGcRQAAGdhzSDo16XoKFN33fsKuABQHAQBkYO8R1xPAB2NT0sFTrqcAUgQAsEBTsXRiwvUU8MWhk64nAFIEALBA41OuJ4BP+LygKAgAAMiTcT0AkCIAgAUa6HE9AXzSz+cFBUEAAAtUr0qLel1PAV+sGHA9AZAiAIAMrF/megL4oK9HWj3kegogRQAAGdi4Quqru54CRfdPrpAMxwCgIAgAIAPVSHr1OqnCf1GYwdVLpXVsKUKB8HUFZGTlkHTLhjQGgHNdvVR61VrXUwDnIwCADF25WLrreukXLmNTL9IzRF61Xnr1erYOoXiqrgcAymagR7rlGul0M73s66lJqZ109zmfPy09e6K7z1EGPVVpw/LuP09fTVo6IC3rJwRRXAQA0CV9dWnd0nyea98RAqATjZr0i2tcTwEUAxulAAAIEAEAAECACAAAAAJEAAAAECACAACAABEAAAAEiAAAACBABAAAAAEiAAAACBABAABAgAgAAAACRAAAABAgAgAAgAARAAAABIgAAAAgQAQAAAABIgAAAAgQAQAAQIAIAAAAAkQAAAAQIAIAAIAAEQAAAASIAAAAIEAEAAAAASIAAAAIEAEAAECACAAAAAJEAAAAECACAACAABEAAAAEiAAAACBABAAAAAEiAAAACBABAABAgAgAAAACRAAAABAgAgAAgAARAAAABIgAAAAgQAQAAAABIgAAAAgQAQAAQIAIAAAAAkQAAAAQIAIAAIAAEQAAAASIAAAAIEAEAAAAASIAAAAIEAEAAECACAAAAAJEAAAAECACAACAABEAAAAEiAAAACBABAAAAAEiAAAACBABAABAgAgAAAACRAAAABAgAgAAgAARAAAABIgAAAAgQAQAAAABIgAAAAgQAQAAQIAIAAAAAkQAAAAQIAIAAIAAEQAAAASIAAAAIEAEAAAAASIAAAAIEAEAAECACAAAAAJEAAAAECACAACAABEAAAAEiAAAACBABAAAAAEiAAAACBABAABAgAgAAAACRAAAABAgAgAAgAARAAAABIgAAAAgQAQAAAABIgAAAAgQAQAAQIAIAAAAAkQAAAAQIAIAAIAAEQAAAASIAAAAIEAEAAAAASIAAAAIEAEAAECACAAAAAJEAAAAECACAACAABEAAAAEiAAAACBABAAAAAEiAAAACBABAABAgAgAAAACRAAAJVAxrifwA68TcBYBAJRAo+Z6Aj80qq4nAIqDAABKYKjhegI/DPW6ngAoDgIAKIGBHmkxi9slrbnM9QRAcRAAQElsWe16gmJb0ietGnQ9BVAcBABQEmuXSiuHXE9RTBUj3bhWMhwECLyAAABKwhhp6wZ2BVzIGOmmtdKyfteTAMVCAAAlUq9Kv3JdujUA0kDd6vaN0tplricBioeTYoCSqUbSq9dLm1dK+45Kz56QxpuSta4ny0dPNd3ff9USaf1yw7n/wAwIAKCklg6kD0myklqx03FyEUVSxIIPdIQAAAJglO4eAIBpHAMAAECACAAAAAJEAAAAECACAACAABEAAAAEiAAAACBABAAAAAEiAAAACBABAABAgAgAAAACRAAAABAgAgAAgAARAAAABIgAAAAgQAQAAAABIgAAAAgQAQAAQIAIAAAAAkQAAAAQIAIAAIAAEQAAAASIAAAAIEAEAAAAASIA8mBcDwAAyEucqO16hk4QADlIrOsJAAB5qTV10vUMnSAAckAAAEAw4jVrzITrITpBAOTAEgAAEIox1wN0igDIQZsAAIBQHHQ9QKcIgBy0vDgcBACwYEYjrkfoFAGQg5gAAIAwWI26HqFTBEAO2gkHAgJAGCwBgPNNxa4nAAB0mzHJo65n6BQBkJPJlusJAADdZKVn1y1vsAUA55tkCwAAlJuxO1yPMBcEQE5acXosAACgnIwqX3c9w1wQADmxksabrqcAAHTJ+KSNvuJ6iLkgAHJEAABAOVlj/3bLCuPNVQAlAiBXzZiLAgFAGVUSc6/rGeaKAMjZyUnXEwAAMmW0a+2KqlcHAEoEQO7GmlLMwYAAUBrWmo8aY7z7ZicA8malU2wFAICSMPvWL4/+j+sp5oMAcODUJPcHAIAysFbvNcZ4+Y1OADhgJT132vUUAICFsNLXN6ysftn1HPNFADgy0eK0QADw2JQx7fe4HmIhCACHnj/N1QEBwEvGvn/98sYe12MsBAHgUDuRjo6nuwQAAN746rpltU+6HmKhCADHJlvSyQnXUwAAOmMPNJvVtxljvP/djQAogBMTHA8AAB44Yazu2nylOeZ6kCwQAAVgJR0bTw8MBAAU0qSR7lq3sv4D14NkhQAoCGulo2PSVOx6EgDAeaya1prfWrei9ojrUbJEABRIYqXDp9LjAgAAhTBujXmdz+f7z4QAKJjESofHpNMcEwAAThnpWGJ1+4YV1a+5nqUbCIACslY6MnbmaoHeH2cKAF56PLbtV1yzsvaY60G6hQAosFOT0qFTXCwIAHJkjfQXk8urr7p2ZeNp18N0U9X1AJjdZCw9e0Ja0if197ieBgBKba+xete6lbUHXA+SB7YAeCCx6RUDD56Uml7ecwoABUSl6AAABSJJREFUCm1CVn9UGa++NJTFX2ILgFemYunnJ6WBmjTUK9Ui1xMBgNcmjMynkyj6+Ial5oDrYfJGAPjGSmPN9MqBvXVpqCH18C4CwFwckvQ5Y6ufWLfSHHI9jCssHZ6ySk8VPN2UqpX0+ID+OlsFAGAGY7L2PpnK53+yPHpgmzHBX3aNACiBOEnvJ3BiQqpG6RaB3ppUj6RaRZJxPSEA5O6IjJ6w0sNKtPPAiup3WPTPRwCUTNxOH+NTZ/6BSSOgFkmVSnrUpzFShSgAUFDVSE/21fR3nfy7Vmob6aSsPWFUGTM22Vftre1Zs8g81+05fUcAlJ2VWu30AQBeMPYH2zfW3+96jLLjNEAAAAJEAAAAECACAACAABEAAAAEiAAAACBABAAAAAEiAAAACBABAABAgLwIgEYi63oGAADKxIsAaPdqwvUMAICc2Mpp1yOEwIsA0DMacz0CACAfRvaU6xlC4EUAbNtmYkmTrucAAHSftTrpeoYQeBEAZxx3PQAAIAcVnXA9Qgh8CoCnXA8AAMiBNftcjxACjwLAjLqeAACQh5jv+xx4FACWDwQAlF88NNbztOshQuBPAFj9wPUIAICue/KGG0zL9RAh8CYAxserj0hqup4DANA9RtrpeoZQeBMAd91gTkv6rus5AADdk1hDAOTEmwCQJFnKEABKLE7q0TddDxEKvwIgSb7oegQAQHcY6Ru3rzdcAyAnXgXA9i09uyR93/UcAIDsJdbc63qGkHgVAJIkIz4gAFA+Y3Ezus/1ECHxLgCqleq9krhTFACUirn3jpeZcddThMS7ALj5GnNE0qddzwEAyEwrUuvjrocIjXcBIEkmqn5cXBMAAErC/NUtm3r3u54iNF4GwLZrzE8l8xnXcwAAFqyZ2PhjrocIkZcBIEnNdvRBSUdczwEAmD9j9ee3bW7scT1HiLwNgDu3mOeMsR9wPQcAYL7sASXVP3Y9Rai8DQBJ2npt7TNGesT1HACA+ai8a9sWM+Z6ilB5HQDGGKuo+hZJR13PAgDonDHmU9s3VTnv3yGvA0A6c0CgMb8jybqeBQDQkSd6+qL3uR4idN4HgCRt31i930p/4noOAMAlHbFR+/U3rTETrgcJnXE9QFastWZ4tH2PZH/X9SwAgIs6nVjddtvm2mOuB0FJtgBI6fEARzdG/0ZGf+t6FgDAi7SM9AYW/+IoTQBI0puMaTf6qv9KEgeWAEBxTEjmjds21f7e9SA4q1QBIEk3rTETRzdWXy9j/tL1LAAAHU+M7uCI/+IpzTEAF7LWmof2xB+yVh9SCUMHAArPmH2K26/bvqVnl+tR8GKlDYBpD460tlWkz0ta7XoWAAiFsfqSGtV3bFtrjrueBRdX+gCQpG8+aVfHlfhzkv6Z61kAoOTGrOz7bt1U/x+uB8HsggiAaTt2x3cZk/w3yaxxPQsAlI01+qra1Xfdep35setZcGlBBYAk3b/XDjXa8X+U9E5JA67nAYAS+Edr9R9u3Vx7wPUg6FxwATDtwd12qVH8bmP0bklLXM8DAB561Frzse2boq8aY7gcu2eCDYBp3xqxgy3beoM15rclbRVnDADAbI7ImC8kSu69bWP9H1wPg/kLPgDO9fA+uyZutX69IrPdGt0itgwAgLXSjyTtlDFfX3QqevCGG0zL9VBYOAJgBh+2trJtX+tl7aTyEslulNVGSVdL5jLJDio9fqDX7ZQAkInnJY1LGpN0SNbsMbKjNjIjrUr0D3dsMIcdz4cu+P/SjihghBhptgAAAABJRU5ErkJggg=="/>
                    </defs>
                </svg>
            </div>
        </div>`;

    return html;
}

function get_range_html(field, id) {
    let html = `
    <div class="form-preview-input-type-wrapper">
    <label>${field.label_name}`;

    if (!field.optional) {
        html += `
        <span style="color: red;">*</span>
        `
    }

    if (field.slider_type.includes('Single')) {

        html += `<div class="form-preview-input-type-single-range-content form-preview-range-slider">

                    <div class="easychat-bot-range-slider-div-heading">Select Value</div>
                    <div class="easychat-bot-range-slider-area">
                        <svg width="350" height="10" viewBox="0 0 350 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="0.481934" y="4.22925" width="350.513" height="1.97476" rx="0.987379" fill="#6A6DCD" fill-opacity="0.3"/>
                            <rect x="0.481934" y="4.22925" width="53.9767" height="1.97476" rx="0.987379" fill="#2755CB"/>
                            <circle cx="50.0155" cy="5.21664" r="4.44321" fill="#2755CB"/>
                            </svg>
                        <div class="easychat-bot-slider-output-input-single">
                            <div>100</div>
                        </div>
                    </div>
                    <div class="easychat-bot-range-min-max-value-wrapper">
                        <div class="easychat-bot-range-min-value-div">
                            <div class="easychat-bot-range-min-inner-value" id="easychat-bot-range-min-selected-value-input-5">10</div>
                            <p>Selected value</p>
                        </div>
                    </div>
                </div>
            </div>`

    } else {
        html += `<div class="form-preview-input-type-dual-range-content form-preview-range-slider">
                    <div class="easychat-bot-range-slider-div-heading">Select Value</div>
                    <div class="easychat-bot-range-slider-area">
                        <svg style="margin-left: 40px;" width="350" height="10" viewBox="0 0 350 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="0.496582" y="4.26538" width="350.691" height="1.97685" rx="0.988426" fill="#6A6DCD" fill-opacity="0.3"/>
                            <rect x="0.495117" y="4.26538" width="99.1721" height="1.97685" rx="0.988426" fill="#2755CB"/>
                            <circle cx="4.94303" cy="5.25383" r="4.44792" fill="#2755CB"/>
                            <circle cx="95.2189" cy="5.25383" r="4.44792" fill="#2755CB"/>
                            </svg>
                        <div class="easychat-bot-slider-output-input">
                            <div>${field.min_value}</div>
                            <div>${field.max_value}</div>
                        </div>
                    </div>
                    <div class="easychat-bot-range-min-max-value-wrapper">
                        <div class="easychat-bot-range-min-value-div">
                            <div class="easychat-bot-range-min-inner-value" id="easychat-bot-range-min-selected-value-input-5">${field.min_value}</div>
                            <p>Min</p>
                        </div> <svg width="9" height="2" viewBox="0 0 9 2" fill="none" xmlns="http://www.w3.org/2000/svg">                        <path d="M0 0.905273H9" stroke="#8F8F8F"></path>                        </svg>
                        <div class="easychat-bot-range-max-value-div">
                            <div class="easychat-bot-range-max-inner-value" id="easychat-bot-range-max-selected-value-input-5">${field.max_value}</div>
                            <p>Max</p>
                        </div>
                    </div>
                </div>
            </div>`
    }

    return html;
}

function get_dropdown_html(field, id) {

    let html = `<div class="form-preview-input-type-wrapper">
                    <label>${field.label_name}`;

    if (!field.optional) {
        html += `
        <span style="color: red;">*</span>
        `
    }

    html += `</label>
            <div class="form-preview-input-type-dropdown-content">
                <select class="form-preview-input-type-dropdown" style="display: block !important;" disabled>
                    <option value="" selected disabled>Choose from the following</option>
                </select>
            </div>
        </div>`;

    return html;
}

function get_phone_number_field_html(field, id) {

    let html = `
    <div class="form-preview-input-type-wrapper">
    <label>${field.label_name}`;

    if (!field.optional) {
        html += `
        <span style="color: red;">*</span>
        `
    }

    html += `<div class="form-widget-preview-content-area preview-container-h100">
        <div class="easychat-country-dropdown-preview-wrapper" id="telephone-preview-wrapper-` + id + `">
            <input style="border: none !important; pointer-events: none !important;" readonly type="tel" placeholder="` + field.placeholder + `" id="telephone-preview-` + id + `" class="phone-number-input">
        </div>


</div>`
          

return html

}

function get_built_form_info(is_toast_required) {
    let form = {};

    form.field_order = [];
    const fields = document.getElementsByClassName('create-form-field');

    if (is_toast_required && fields.length == 0) {
        showToast('Form Cannot be empty', 2000);
        return;
    }

    let need_to_save = Array.from(fields).length != 0;
    Array.from(fields).forEach(field => {
        form[field.id] = {};
        field_id_num = (field.id).split('-')[1];

        let label_name = document.getElementById('input_name_' + field_id_num + '_1').value.trim();
        label_name = stripHTML(label_name);
        label_name = strip_unwanted_characters(label_name);

        if (is_toast_required && label_name == '') {
            showToast('Label name cannot be empty', 2000);
            need_to_save = false;
            return;
        }

        if (check_if_label_name_exists(field_id_num)) {
            need_to_save = false;
            return;
        }

        form[field.id].label_name = label_name;

        let input_type = document.getElementById('input_type_' + field_id_num).value;

        form[field.id].type = input_type;

        form[field.id].optional = document.getElementById('optional-toggle-field-' + field_id_num).checked;

        const field_info = get_field_info_based_input_type(input_type, field_id_num, form);

        if (!api_integrated_fields.includes(field_id_num) && input_type == "radio" && field_info.options.length == 0) {
            M.toast({
                "html": "Please enter at least one and valid radio option"
            }, 2000);
            return;
        }

        if (!api_integrated_fields.includes(field_id_num) && input_type == "checkbox" && field_info.options.length == 0) {
            M.toast({
                "html": "Please enter at least one and valid checkbox option"
            }, 2000);
            return;
        }

        if (is_toast_required && 'is_valid' in field_info && field_info.is_valid == false) {
            showToast(field_info.error, 2000);
            need_to_save = false;
            return;
        }

        form[field.id] = { ...form[field.id], ...field_info };
        form.field_order.push(field.id);
    })
    return {
        form: form,
        need_to_save: need_to_save,
    };
}

function get_field_info_based_input_type(input_type, id, form) {
    if (input_type == 'text_field') {
        return {
            placeholder: document.getElementById('input_selected_type_' + id + '_3').value
        };
    }
    else if (input_type == 'radio') {
        return {
            options: form_get_radio_button_list(id)
        }
    }
    else if (input_type == 'checkbox') {
        return {
            options: form_get_check_box_list(id)
        }
    }
    else if (input_type == 'dropdown_list') {
        return {
            options: form_get_dropdown_list(id)
        }
    }
    else if (input_type == 'range') {
        return {
            slider_type: document.getElementById('range_selector_' + id).value,
            min_value: document.getElementById('form-range-slider-min-range-' + id).value,
            max_value: document.getElementById('form-range-slider-max-range-' + id).value
        }
    }
    else if (input_type == 'file_attach') {
        return {
            is_valid: true
        }
    }
    else if (input_type == 'time_picker' || input_type == 'date_picker') {
        return {
            calendar_type: document.getElementById('calendar_selector_type_' + id).value
        }
    }
    else if (input_type == 'phone_number') {
        return {
            country_code: $("#phone_number_selector_type_" + id).intlTelInput("getSelectedCountryData").iso2,
            placeholder: document.getElementById('input_selected_type_' + id + '_3').value
        }
    }
}

function get_dependent_field_div(id, is_dependent_field_required) {
    let first_element = document.querySelector('.label-name')
    let div_style = ''

    if (!first_element) return ''
    if (!is_dependent_field_required) {
        div_style = "style='display: none'";
    }
    return `
        <div class="form-widget-dependent-value-wrapper" id="dependent_field_wrapper_${id}" ${div_style}>
            <div class="optional-btn dependent-field-toggle-btn" style="font-weight: 300; font-size: 14px"> <span>Dependent Field<span class="tooltipped" data-position="top" data-tooltip=" This is used to set dependencies based on values of mapped fields. Make sure to click on ‘Update API Status’ when API is configured."><svg width="17" height="17" viewBox="0 0 17 17" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M14.9001 8.2501C14.9001 9.94748 14.2258 11.5753 13.0256 12.7756C11.8253 13.9758 10.1975 14.6501 8.5001 14.6501C6.80271 14.6501 5.17485 13.9758 3.97461 12.7756C2.77438 11.5753 2.1001 9.94748 2.1001 8.2501C2.1001 6.55271 2.77438 4.92485 3.97461 3.72461C5.17485 2.52438 6.80271 1.8501 8.5001 1.8501C10.1975 1.8501 11.8253 2.52438 13.0256 3.72461C14.2258 4.92485 14.9001 6.55271 14.9001 8.2501ZM8.5001 5.8501C8.35954 5.84996 8.22142 5.88686 8.09966 5.95708C7.97789 6.0273 7.87678 6.12837 7.8065 6.2501C7.75575 6.3444 7.68659 6.42755 7.60311 6.49463C7.51963 6.5617 7.42353 6.61133 7.32051 6.64058C7.21749 6.66982 7.10965 6.67809 7.00338 6.66489C6.89711 6.65168 6.79457 6.61727 6.70185 6.56371C6.60912 6.51014 6.52809 6.4385 6.46356 6.35303C6.39904 6.26757 6.35233 6.17002 6.3262 6.06616C6.30007 5.96231 6.29506 5.85427 6.31147 5.74845C6.32787 5.64262 6.36536 5.54117 6.4217 5.4501C6.68587 4.99259 7.09362 4.63503 7.58172 4.43287C8.06981 4.23071 8.61097 4.19525 9.12127 4.33198C9.63157 4.46872 10.0825 4.77001 10.4041 5.18914C10.7257 5.60826 10.9001 6.12179 10.9001 6.6501C10.9002 7.14659 10.7465 7.63092 10.4599 8.03638C10.1734 8.44184 9.76816 8.74849 9.3001 8.9141V9.0501C9.3001 9.26227 9.21581 9.46575 9.06578 9.61578C8.91575 9.76581 8.71227 9.8501 8.5001 9.8501C8.28792 9.8501 8.08444 9.76581 7.93441 9.61578C7.78438 9.46575 7.7001 9.26227 7.7001 9.0501V8.2501C7.7001 8.03792 7.78438 7.83444 7.93441 7.68441C8.08444 7.53438 8.28792 7.4501 8.5001 7.4501C8.71227 7.4501 8.91575 7.36581 9.06578 7.21578C9.21581 7.06575 9.3001 6.86227 9.3001 6.6501C9.3001 6.43792 9.21581 6.23444 9.06578 6.08441C8.91575 5.93438 8.71227 5.8501 8.5001 5.8501ZM8.5001 12.2501C8.71227 12.2501 8.91575 12.1658 9.06578 12.0158C9.21581 11.8658 9.3001 11.6623 9.3001 11.4501C9.3001 11.2379 9.21581 11.0344 9.06578 10.8844C8.91575 10.7344 8.71227 10.6501 8.5001 10.6501C8.28792 10.6501 8.08444 10.7344 7.93441 10.8844C7.78438 11.0344 7.7001 11.2379 7.7001 11.4501C7.7001 11.6623 7.78438 11.8658 7.93441 12.0158C8.08444 12.1658 8.28792 12.2501 8.5001 12.2501Z" fill="#7B7A7B"/>
                </svg>
                </span></span>
                <input type="checkbox" id="dependent-field-${id}"><label style="margin-left: 5px; height: 13px;" for="dependent-field-${id}">Toggle</label>
            </div>
            <div class="col s12 easychat-dependent-dropdown" id="dependent_dropdown_div_${id}" style="display: none;padding: 0px !important; margin-top: 16px; ">
                    <select class="easychat-form-widget-dropdown-wrapper dependent-dropdown" id="dependent_field_dropdown_${id}" style="display: none;"> 
                        <option value="Select Dependency">Select Dependency</option>
                    </select>
            </div>
        </div>`
}

function check_if_label_name_exists(id) {
    $('#label_name_error_msg_' + id).hide()
    $('#label_name_' + id + '_1').css('color', '#9e9e9e');
    let label_name = $('#input_name_' + id + '_1').val();
    if (label_name == '') {
        return false;
    }
    let fields = document.querySelectorAll(".label-name");
    for (let i = 0; i < fields.length; i++) {
        if (fields[i].value == label_name && id != fields[i].id.split('_')[2]) {
            $('#label_name_' + id + '_1').css('color', 'red');
            $('#label_name_error_msg_' + id).html('Label name “' + label_name + '” already exists. Please try another.')
            $('#label_name_error_msg_' + id).show()
            return true;
        }
    }
    return false;
}

function add_input_type_field(id) {
    let input_type = document.getElementById('input_type_' + id).value;

    document.getElementById('validator_dropdown_' + id).style.display = 'none';
    document.getElementById('file_attach_' + id).style.display = 'none';
    document.getElementById('range_type_' + id).style.display = 'none';
    document.getElementById('calendar_type_' + id).style.display = 'none';
    document.getElementById('phone_number_type_' + id).style.display = 'none';
    document.getElementById('input_selected_type_' + id + '_3').style.display = 'none';
    document.getElementById('form-widget-range-slider-min-max-container' + id).style.display = 'none'
    document.getElementById("sortable-radio-widget-edit-div-" + id).style.display = 'none'
    document.getElementById("sortable-dropdown-widget-edit-div-" + id).style.display = 'none'
    document.getElementById("sortable-checkbox-widget-edit-div-" + id).style.display = 'none'
    document.getElementById("api_integration_link_" + id).style.display = 'block'
    document.getElementById('input_selected_type_' + id + '_3').style.visibility = "unset";
    if (document.getElementById('dependent_field_wrapper_' + id)) {
        document.getElementById('dependent_field_wrapper_' + id).style.display = 'flex'
    }

    if (input_type == 'text_field') {
        document.getElementById('validator_dropdown_' + id).style.display = 'block';
        document.getElementById('input_selected_type_' + id + '_3').style.display = 'inline-block';
        document.getElementById('input_selected_type_' + id + '_3').value = "";
        document.getElementById('input_selected_type_' + id + '_3').placeholder = "Placeholder text"
    } else if (input_type == 'range') {
        document.getElementById('range_type_' + id).style.display = 'block';
        document.getElementById('form-widget-range-slider-min-max-container' + id).style.display = 'block'
    } else if (input_type == 'file_attach') {
        document.getElementById('file_attach_' + id).style.display = 'block';
        document.getElementById("api_integration_link_" + id).style.display = 'none'
        document.getElementById('input_selected_type_' + id + '_3').style.display = "inline-block";
        document.getElementById('input_selected_type_' + id + '_3').style.visibility = "hidden";
        reset_api_integration(id)
        if (document.getElementById('dependent_field_wrapper_' + id)) {
            document.getElementById('dependent-field-' + id).checked = false;
            document.getElementById('dependent_field_wrapper_' + id).style.display = 'none'
            document.getElementById('dependent_dropdown_div_' + id).style.display = 'none'
        }
    } else if (input_type == 'dropdown_list') {
        document.getElementById("sortable-dropdown-widget-edit-div-" + id).style.display = "block"
        document.getElementById("sortable-dropdown-widget-edit-div-" + id).innerHTML = '';
        document.getElementById('input_selected_type_' + id + '_3').style.display = "inline-block"
        document.getElementById('input_selected_type_' + id + '_3').value = "";
        document.getElementById('input_selected_type_' + id + '_3').placeholder = "Enter any value or text and hit \"Enter\""
    } else if (input_type == 'checkbox') {
        document.getElementById("sortable-checkbox-widget-edit-div-" + id).style.display = "block"
        document.getElementById("sortable-checkbox-widget-edit-div-" + id).innerHTML = '';
        document.getElementById('input_selected_type_' + id + '_3').style.display = "inline-block"
        document.getElementById('input_selected_type_' + id + '_3').value = "";
        document.getElementById('input_selected_type_' + id + '_3').placeholder = "Enter any value or text and hit \"Enter\""
    } else if (input_type == 'radio') {
        document.getElementById("sortable-radio-widget-edit-div-" + id).style.display = "block"
        document.getElementById("sortable-radio-widget-edit-div-" + id).innerHTML = '';
        document.getElementById('input_selected_type_' + id + '_3').style.display = "inline-block"
        document.getElementById('input_selected_type_' + id + '_3').value = "";
        document.getElementById('input_selected_type_' + id + '_3').placeholder = "Enter any value or text and hit \"Enter\""
    } else if (input_type == 'date_picker' || input_type == 'time_picker') {
        document.getElementById('input_selected_type_' + id + '_3').style.display = "inline-block";
        document.getElementById('input_selected_type_' + id + '_3').style.visibility = "hidden";
        document.getElementById('calendar_type_' + id).style.display = "block"
        document.getElementById("api_integration_link_" + id).style.display = 'none'
        reset_api_integration(id)
        if (document.getElementById('dependent_field_wrapper_' + id)) {
            document.getElementById('dependent-field-' + id).checked = false;
            document.getElementById('dependent_field_wrapper_' + id).style.display = 'none'
            document.getElementById('dependent_dropdown_div_' + id).style.display = 'none'
        }
    } else if (input_type == "phone_number") {
        document.getElementById('phone_number_type_' + id).style.display = 'block';
        document.getElementById('input_selected_type_' + id + '_3').style.display = 'inline-block';
        document.getElementById('input_selected_type_' + id + '_3').value = "";
        document.getElementById('input_selected_type_' + id + '_3').placeholder = "Placeholder text"


    }
}

function update_form_widget_api_integration_status(sync_required = false) {
    return new Promise((resolve, reject) => {
        let fields = document.querySelectorAll(".label-name");
        const field_ids = []
        for (let i = 0; i < fields.length; i++) {
            let label_id = fields[i].id.split('_')[2]
            field_ids.push(label_id)
        }

        let json_string = JSON.stringify({
            field_ids: field_ids,
        })

        json_string = EncryptVariable(json_string);

        $.ajax({
            url: '/chat/form-widget-api-integration-status/',
            type: 'POST',
            data: {
                json_string: json_string
            },
            success: function (response) {
                response = custom_decrypt(response)
                response = JSON.parse(response);
                if (response['status'] == 200) {
                    api_integrated_fields = response['api_integrated_fields']
                    if (sync_required) {
                        sync_preview();
                    }
                    field_ids.forEach(field_id => {
                        if (api_integrated_fields.includes(field_id)) {
                            $('#api_integration_status_' + field_id).show();
                            $('#api_integration_link_' + field_id).html('Edit Integration');
                            $('#sortable-dropdown-widget-edit-div-' + field_id).html('');
                            let html = `API Integration - <span style="color:green">Active</span>`;
                            $('#saved_api_status_' + field_id).html(html)
                        } else {
                            $('#api_integration_status_' + field_id).hide();
                            $('#api_integration_link_' + field_id).html('Integrate API');
                            let html = `API Integration - <span style="color:red">Inactive</span>`;
                            $('#saved_api_status_' + field_id).html(html)
                        }
                    })
                    if (api_integrated_fields.length > 0) {
                        $('#api_integration_active_icon').show()
                    } else {
                        $('#api_integration_active_icon').hide()
                    }
                    resolve();
                } else {
                    M.toast({
                        'html': 'Unable to connect to server. Please try again later.'
                    }, 2000);
                }
            },
            error: function (error) {
                M.toast({
                    'html': 'Unable to connect to server. Please try again later.'
                }, 2000);
            }
        });
    });
}

function minimize_form_field_div(elem) {
    let id = elem.id.split('_')[2];
    $('#opened_form_div_' + id).hide()
    $('#saved_data_div_' + id).css('display', 'flex');
    $('#saved_full_name_' + id).html($('#input_name_' + id + '_1').val())
    $('#saved_input_type_' + id).html('Input Type - ' + reverse_input_name_mapping($('#input_type_' + id).val()))
    if ($('#input_type_' + id).val() == 'text_field') {
        $('#saved_validator_' + id).show()
        $('#saved_validator_' + id).html(reverse_validator_mapping($('#validator_' + id).val()))
    } else {
        $('#saved_validator_' + id).hide()
    }
    if ($('#api_integration_link_' + id).html() == 'Edit Integration') {
        let html = `API Integration - <span style="color:green">Active</span>`;
        $('#saved_api_status_' + id).html(html)
    } else {
        let html = `API Integration - <span style="color:red">Inactive</span>`;
        $('#saved_api_status_' + id).html(html)
    }
    if ($('#dependent-field-' + id).is(":checked") && $('#dependent_field_dropdown_' + id).val() != 'Select Dependency') {
        $('#saved_dependency_' + id).show();
        let dependency_id = $('#dependent_field_dropdown_' + id).val()
        $('#saved_dependency_name_' + id).html($('#input_name_' + dependency_id + '_1').val())
    } else {
        $('#saved_dependency_' + id).hide();
    }
}

function maximize_form_field_div(elem) {
    let id = elem.id.split('_')[2];
    $('#opened_form_div_' + id).show()
    $('#saved_data_div_' + id).hide();
}

function reset_api_integration(id, reset_all = false, reset_indivitual_field = false) {

    let field_id = id;

    if (reset_all) {
        let fields = document.querySelectorAll(".label-name");
        const field_ids = []
        for (let i = 0; i < fields.length; i++) {
            let label_id = fields[i].id.split('_')[2]
            field_ids.push(label_id)
        }
        field_id = field_ids.join('$$$')
    } else if (reset_indivitual_field) {
        $('#validator_' + field_id).val('choose_validator').trigger('change');
        $('#input_type_' + field_id).val('text_field').trigger('change');
        $('#dependent-field-' + field_id).prop('checked', false).trigger('change');
        $('#optional-toggle-field-' + field_id).prop('checked', false).trigger('change');
        $('#range_selector_' + field_id).val('Single Range Selector').trigger('change')
        $('#file_attach_type_' + field_id).val('image(ex. .jpeg, .png, .jpg)').trigger('change')
        $('#calendar_selector_type_' + field_id).val('Single Type').trigger('change')
        $('#phone_number_selector_type_' + field_id).intlTelInput("setCountry", "in").trigger('change')
        $('#input_name_' + field_id + '_1').val('');
        $('#input_type_' + field_id).trigger('select2:close');
        $('#form-range-slider-min-range-' + field_id).val('');
        $('#form-range-slider-max-range-' + field_id).val('');
        $('#input_selected_type_' + field_id + '_3').val('')
    }

    let json_string = JSON.stringify({
        field_id: field_id,
    })
    json_string = EncryptVariable(json_string);

    $.ajax({
        url: '/chat/reset-api-integration/',
        type: 'POST',
        data: {
            json_string: json_string
        },
        success: function (response) {
            response = custom_decrypt(response)
            response = JSON.parse(response);
            if (response['status'] == 200) {
                update_form_widget_api_integration_status();
            }
        }
    })
}

// Dynamic Form Widget JS End

function sanitize_html(unsafe) {
    return unsafe.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#039;');
}

function reverse_sanitize_html(safe) {
    return safe.replaceAll('&amp', '&;').replaceAll('&lt;', '<').replaceAll('&gt;', '>').replaceAll('&quot;', '"').replaceAll("&#039;", "'");
}

function generate_random_string(length) {
    let result = '';
    let characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let characters_length = characters.length;
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters_length));
    }
    return result;
}

function html_tags_remover(text) {

    return text.replace(/<\/?[^>]+(>|$)/g, "").trim();
}


//For WhatsApp Catalogue Sections Selection

$("#select-sections-container").sortable({
    containment: "parent",
    appendTo: 'body',
    containment: 'window',
    scroll: false,
    helper: 'clone'
});
$('#select-sections-container span').hover(function () {
    $(this).css({
        "background-color": "#0254d7",
        "color": "#fff",
        "padding": "4px 12px",
        "width": "max-content",
        "font-size": "12px!important",
        "border-radius": "4px"
    })
});

$('#select-sections-container span').mouseleave(function () {
    $(this).css({
        "background-color": "#0254d7",
        "color": "#fff",
        "padding": "4px 12px",
        "width": "max-content",
        "font-size": "12px!important",
        "border-radius": "4px"
    })
});
// dropdown js
$("#select_section_input_div").click(function (event) {
    if (event.target.id != "select_section_input_div") return;
    $("#select_section_search_bar").keyup();
    if ($('#select_section_options_container').css('display') == 'none') {
        $("#select_section_options_container").show();
        $("#select_section_dropdown_icon").addClass("select-dropdown-active")
    }
    else if ($('#select_section_options_container').css('display') == 'block') {
        $("#select_section_options_container").scrollTop(0);
        $("#select_section_options_container").hide();
        $("#select_section_dropdown_icon").removeClass("select-dropdown-active")
    }
});

$(document).on('click', function (event) {
    if ($(event.target).closest('#select_section_input_div, #select_section_options_container').length === 0) {
        $("#select_section_options_container").scrollTop(0);
        $("#select_section_options_container").hide();
        $("#select_section_dropdown_icon").removeClass("select-dropdown-active");
    }
    event.stopPropagation();
});

function add_section_product_search() {
    let input, filter, search_value, i, text_value;
    input = document.getElementById("select_section_search_bar");
    filter = input.value.toUpperCase();
    search_value = document.querySelectorAll('.select-section-item-select .select-section-item-text');
    let count = 0
    for (i = 0; i < search_value.length; i++) {

        text_value = search_value[i].textContent || search_value[i].innerText;
        if (text_value.toUpperCase().indexOf(filter) > -1) {
            search_value[i].parentElement.parentElement.style.display = "";

            count++;

        } else {
            search_value[i].parentElement.parentElement.style.display = "none";
        }
    }
    if (count == 0) {
        document.getElementById('select_section_no_data_found').style.display = "flex";
    } else {
        document.getElementById('select_section_no_data_found').style.display = "none";
    }
};

function add_catalogue_sections_data_and_listeners(intent_data, is_tree=false) {
    if ("catalogue_sections" in intent_data) {
        let catalogue_sections = JSON.parse(intent_data.catalogue_sections)
        let dropdown_option_html = "";
        for (const section_id in catalogue_sections) {
            dropdown_option_html += `<li class="select-section-item select-section-item-select" style="">
                                    <label>
                                    <input type="checkbox" section-id="${section_id}" value="${catalogue_sections[section_id]}" id="section_${section_id}" style="position:relative;opacity:1;width: unset !important;margin-top: 0 !important;height: 1.4rem !important;pointer-events: auto;cursor: pointer;">
                                    <div class="select-section-item-text">${catalogue_sections[section_id]}</div>
                                    </label>
                                </li>`
        }
        $("#select_section_options_container").append(dropdown_option_html)
    }
    $("#select_section_options_container input").on("change", function (event) {
        if (this.checked) {
            $("#select-sections-container").append(get_selected_catalogue_section_chip_html(this.id, this.value));
            add_event_listeners_for_sections_chips();
        } else {
            let section_id = this.id.split("_")
            section_id = section_id[section_id.length - 1]
            $("#chip_" + section_id).remove();
        }
    });
    let modes_param = {}
    if(is_tree) {
        modes_param = JSON.parse(intent_data["modes_param"])
    } else {
        modes_param = intent_data["intent_response"]["modes_param"]
    }
    
    if ("selected_catalogue_sections" in modes_param) {
        for (section_id of modes_param.selected_catalogue_sections) {
            $("#select_section_options_container input[section-id=" + section_id + "]").prop("checked", true).change();
        }
    }
    if ($("#add_catalogue_checkbox").prop("checked")) {
        $("#add_catalogue_checkbox").change();
    }
}

function remove_section_chip(section_id) {
    $("#select_section_options_container input[section-id='" + section_id + "']").prop("checked", false).change();
}

function get_selected_catalogue_section_chip_html(section_id, section_title) {
    section_id = section_id.split("_")
    section_id = section_id[section_id.length - 1]
    let chip_html = `<span id="chip_${section_id}" class="ui-sortable-handle"><b><svg style="margin-top: 3px;"
                        width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M8 8.5C8.55228 8.5 9 8.94772 9 9.5C9 10.0523 8.55228 10.5 8 10.5C7.44772 10.5 7 10.0523 7 9.5C7 8.94772 7.44772 8.5 8 8.5ZM4 8.5C4.55228 8.5 5 8.94772 5 9.5C5 10.0523 4.55228 10.5 4 10.5C3.44772 10.5 3 10.0523 3 9.5C3 8.94772 3.44772 8.5 4 8.5ZM8 5C8.55228 5 9 5.44772 9 6C9 6.55228 8.55228 7 8 7C7.44772 7 7 6.55228 7 6C7 5.44772 7.44772 5 8 5ZM4 5C4.55228 5 5 5.44772 5 6C5 6.55228 4.55228 7 4 7C3.44772 7 3 6.55228 3 6C3 5.44772 3.44772 5 4 5ZM8 1.5C8.55228 1.5 9 1.94772 9 2.5C9 3.05228 8.55228 3.5 8 3.5C7.44772 3.5 7 3.05228 7 2.5C7 1.94772 7.44772 1.5 8 1.5ZM4 1.5C4.55228 1.5 5 1.94772 5 2.5C5 3.05228 4.55228 3.5 4 3.5C3.44772 3.5 3 3.05228 3 2.5C3 1.94772 3.44772 1.5 4 1.5Z"
                            fill="white"></path>
                    </svg></b>${section_title}<a class="remove-chip-btn" onclick="remove_section_chip('${section_id}')"> <svg
                        width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.3938 2.25L9.60619 9.75" stroke="white" stroke-width="1.30211" stroke-linecap="round"
                            stroke-linejoin="round"></path>
                        <path d="M9.6062 2.25L2.39381 9.75" stroke="white" stroke-width="1.30211" stroke-linecap="round"
                            stroke-linejoin="round"></path>
                    </svg></a>
                    </span>`
    return chip_html
}

function add_event_listeners_for_sections_chips() {
    $('#select-sections-container span').hover(function () {
        $(this).css({
            "background-color": "#0254d7",
            "color": "#fff",
            "padding": "4px 12px",
            "width": "max-content",
            "font-size": "12px!important",
            "border-radius": "4px"
        })
    });
    
    $('#select-sections-container span').mouseleave(function () {
        $(this).css({
            "background-color": "#0254d7",
            "color": "#fff",
            "padding": "4px 12px",
            "width": "max-content",
            "font-size": "12px!important",
            "border-radius": "4px"
        })
    });
}
